/*! For license information please see 1368.js.LICENSE.txt */
(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[1368,4587],{"./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WidgetLifecycle.js":(e,t)=>{"use strict";var n;t.Z=void 0,t.Z=n,function(e){e.CapabilitiesRequest="capabilities_request",e.PreLoadRequest="preload_request",e.IdentityRequest="identity_request"}(n||(t.Z=n={}))},"./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WrapperLifecycle.js":(e,t)=>{"use strict";var n;t.m=void 0,t.m=n,function(e){e.Wrapper="wrapper"}(n||(t.m=n={}))},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/lock-off.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n("./node_modules/react/index.js"),r=n("./node_modules/react/jsx-runtime.js");function o(e,t){return(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,r.jsx)("path",{d:"M6 22q-.825 0-1.412-.587A1.93 1.93 0 0 1 4 20V10q0-.825.588-1.412a2 2 0 0 1 .702-.463L1.333 4.167a1 1 0 0 1 1.414-1.414L7 7.006v-.012l13 13v.012l1.247 1.247a1 1 0 1 1-1.414 1.414l-.896-.896A1.94 1.94 0 0 1 18 22zm14-4.834V10q0-.825-.587-1.412A1.93 1.93 0 0 0 18 8h-1V6q0-2.075-1.463-3.537Q14.075 1 12 1T8.463 2.463a4.9 4.9 0 0 0-1.22 1.946L9 6.166V6q0-1.25.875-2.125A2.9 2.9 0 0 1 12 3q1.25 0 2.125.875T15 6v2h-4.166z"})})}o.displayName="LockOffIcon";const s=(0,i.forwardRef)(o)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/minus.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n("./node_modules/react/index.js"),r=n("./node_modules/react/jsx-runtime.js");function o(e,t){return(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,r.jsx)("path",{d:"M6 13a.97.97 0 0 1-.713-.287A.97.97 0 0 1 5 12q0-.424.287-.713A.97.97 0 0 1 6 11h12q.424 0 .712.287.288.288.288.713 0 .424-.288.713A.97.97 0 0 1 18 13z"})})}o.displayName="MinusIcon";const s=(0,i.forwardRef)(o)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/plus.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n("./node_modules/react/index.js"),r=n("./node_modules/react/jsx-runtime.js");function o(e,t){return(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,r.jsx)("path",{d:"M11 13H6a.97.97 0 0 1-.713-.287A.97.97 0 0 1 5 12q0-.424.287-.713A.97.97 0 0 1 6 11h5V6q0-.424.287-.713A.97.97 0 0 1 12 5q.424 0 .713.287Q13 5.576 13 6v5h5q.424 0 .712.287.288.288.288.713 0 .424-.288.713A.97.97 0 0 1 18 13h-5v5q0 .424-.287.712A.97.97 0 0 1 12 19a.97.97 0 0 1-.713-.288A.97.97 0 0 1 11 18z"})})}o.displayName="PlusIcon";const s=(0,i.forwardRef)(o)},"./node_modules/@vector-im/compound-design-tokens/assets/web/icons/qr-code.js":(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var i=n("./node_modules/react/index.js"),r=n("./node_modules/react/jsx-runtime.js");function o(e,t){return(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,r.jsx)("path",{fillRule:"evenodd",d:"M3 4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1zm2 5V5h4v4zm-2 5a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1zm2 5v-4h4v4zm9-16a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1zm1 2v4h4V5z",clipRule:"evenodd"}),(0,r.jsx)("path",{d:"M15 16v-3h-2v3z"}),(0,r.jsx)("path",{d:"M17 16h-2v2h-2v3h2v-3h2v2h4v-2h-2v-5h-2z"})]})}o.displayName="QrCodeIcon";const s=(0,i.forwardRef)(o)},"./node_modules/base64-arraybuffer/dist/base64-arraybuffer.es5.js":(e,t,n)=>{"use strict";n.r(t),n.d(t,{decode:()=>a,encode:()=>s});for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="undefined"==typeof Uint8Array?[]:new Uint8Array(256),o=0;o<64;o++)r[i.charCodeAt(o)]=o;var s=function(e){var t,n=new Uint8Array(e),r=n.length,o="";for(t=0;t<r;t+=3)o+=i[n[t]>>2],o+=i[(3&n[t])<<4|n[t+1]>>4],o+=i[(15&n[t+1])<<2|n[t+2]>>6],o+=i[63&n[t+2]];return r%3==2?o=o.substring(0,o.length-1)+"=":r%3==1&&(o=o.substring(0,o.length-2)+"=="),o},a=function(e){var t,n,i,o,s,a=.75*e.length,l=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var d=new ArrayBuffer(a),u=new Uint8Array(d);for(t=0;t<l;t+=4)n=r[e.charCodeAt(t)],i=r[e.charCodeAt(t+1)],o=r[e.charCodeAt(t+2)],s=r[e.charCodeAt(t+3)],u[c++]=n<<2|i>>4,u[c++]=(15&i)<<4|o>>2,u[c++]=(3&o)<<6|63&s;return d}},"./node_modules/bloom-filters/dist/base-filter.js":function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var r=i(n("./node_modules/seedrandom/index.js")),o=i(n("./node_modules/bloom-filters/dist/hashing/hashing.js")),s=n("./node_modules/bloom-filters/dist/utils.js"),a=function(){function e(){this._seed=(0,s.getDefaultSeed)(),this._rng=(0,r.default)("".concat(this._seed)),this._hashing=new o.default}return Object.defineProperty(e.prototype,"seed",{get:function(){return this._seed},set:function(e){this._seed=e,this._rng=(0,r.default)("".concat(this._seed))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"random",{get:function(){return this._rng},enumerable:!1,configurable:!0}),e.prototype.nextInt32=function(){return this._rng.int32()},e.prototype.saveAsJSON=function(){throw new Error("not-implemented")},e.fromJSON=function(e){throw new Error("not-implemented")},e}();t.default=a},"./node_modules/bloom-filters/dist/bloom/bit-set.js":(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n("./node_modules/base64-arraybuffer/dist/base64-arraybuffer.es5.js"),r=function(){function e(e){var t=8-e%8;this.size=e+([0,8].includes(t)?0:t),this.array=new Uint8Array(Math.ceil(this.size/8))}return e.prototype.has=function(e){var t=Math.floor(e/8),n=1<<e%8;return 0!==(this.array[t]&n)},e.prototype.add=function(e){var t=Math.floor(e/8),n=1<<e%8;this.array[t]=this.array[t]|n},e.prototype.max=function(){for(var t=this.array.length-1;t>=0;t--){var n=this.array[t];if(n)return e.highBit(n)+8*t}return 0},e.prototype.bitCount=function(){for(var t=0,n=0;n<this.array.length;n++)t+=e.countBits(this.array[n]);return t},e.prototype.equals=function(e){if(e.size!==this.size)return!1;for(var t=0;t<this.array.length;t++)if(this.array[t]!==e.array[t])return!1;return!0},e.prototype.export=function(){return{size:this.size,content:(0,i.encode)(this.array)}},e.import=function(t){if("number"!=typeof t.size)throw Error("BitSet missing size");if("string"!=typeof t.content)throw Error("BitSet: missing content");var n=new e(t.size),r=(0,i.decode)(t.content);return n.array=new Uint8Array(r),n},e.highBit=function(e){for(var t=7,n=1<<t;t>=0&&(n&e)!==n;)n>>>=1,t--;return t},e.countBits=function(e){for(var t=1&e;0!==e;)t+=1&(e>>>=1);return t},e}();t.default=r},"./node_modules/bloom-filters/dist/bloom/partitioned-bloom-filter.js":function(e,t,n){"use strict";var i,r=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__decorate||function(e,t,n,i){var r,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,n,s):r(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},a=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=l(n("./node_modules/bloom-filters/dist/base-filter.js")),d=n("./node_modules/bloom-filters/dist/exportable.js"),u=n("./node_modules/bloom-filters/dist/utils.js"),m=l(n("./node_modules/bloom-filters/dist/bloom/bit-set.js"));var h=function(e){function t(t,n,i,r){var o=e.call(this)||this;return o._size=t,o._nbHashes=n,o._loadFactor=i,o._m=Math.ceil(o._size/o._nbHashes),o._filter=(0,u.allocateArray)(o._nbHashes,function(){return new m.default(o._m)}),o._capacity=void 0!==r?r:function(e,t,n){return Math.ceil(e*(Math.log(t)*Math.log(1-t))/(-n*Math.log(t)))}(o._size,i,n),o}var n;return r(t,e),n=t,t.create=function(e,t,i){void 0===i&&(i=.5);var r=function(e,t,n){return Math.ceil(e*-Math.log(t)/(Math.log(n)*Math.log(1-n)))}(e,t,i),o=function(e,t){return Math.ceil(Math.log(e)/Math.log(t))}(t,i);return new n(r,o,i,e)},t.from=function(e,t,i){void 0===i&&(i=.5);var r=Array.from(e),o=n.create(r.length,t,i);return r.forEach(function(e){return o.add(e)}),o},Object.defineProperty(t.prototype,"capacity",{get:function(){return this._capacity},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loadFactor",{get:function(){return this._loadFactor},enumerable:!1,configurable:!0}),t.prototype.add=function(e){for(var t=this._hashing.getIndexes(e,this._m,this._nbHashes,this.seed),n=0;n<this._nbHashes;n++)this._filter[n].add(t[n])},t.prototype.has=function(e){for(var t=this._hashing.getIndexes(e,this._m,this._nbHashes,this.seed),n=0;n<this._nbHashes;n++)if(!this._filter[n].has(t[n]))return!1;return!0},t.prototype.rate=function(){var e=this._currentload();return Math.pow(e,this._nbHashes)},t.prototype.equals=function(e){return this._size===e._size&&this._nbHashes===e._nbHashes&&this._loadFactor===e._loadFactor&&this._filter.every(function(t,n){return e._filter[n].equals(t)})},t.prototype._currentload=function(){return this._filter.map(function(e){return e.bitCount()}).reduce(function(e,t){return e+t},0)/this._size},o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_size",void 0),o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_nbHashes",void 0),o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_loadFactor",void 0),o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_m",void 0),o([(0,d.Field)(function(e){return e.map(function(e){return e.export()})},function(e){return e.map(function(e){if(Array.isArray(e)){var t=new m.default(e.length);return e.forEach(function(e,n){0!==e&&t.add(n)}),t}return m.default.import(e)})}),s("design:type",Array)],t.prototype,"_filter",void 0),o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_capacity",void 0),t=n=o([(0,d.AutoExportable)("PartitionedBloomFilter",["_seed"]),a(0,(0,d.Parameter)("_size")),a(1,(0,d.Parameter)("_nbHashes")),a(2,(0,d.Parameter)("_loadFactor")),a(3,(0,d.Parameter)("_capacity")),s("design:paramtypes",[Number,Number,Number,Number])],t)}(c.default);t.default=h},"./node_modules/bloom-filters/dist/bloom/scalable-bloom-filter.js":function(e,t,n){"use strict";var i,r=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__decorate||function(e,t,n,i){var r,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,n,s):r(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},a=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=l(n("./node_modules/bloom-filters/dist/base-filter.js")),d=n("./node_modules/bloom-filters/dist/exportable.js"),u=l(n("./node_modules/bloom-filters/dist/bloom/partitioned-bloom-filter.js")),m=l(n("./node_modules/seedrandom/index.js")),h=function(e){function t(t,n,i){void 0===t&&(t=8),void 0===n&&(n=.01),void 0===i&&(i=.5);var r=e.call(this)||this;return r._filters=[],r._initial_size=t,r._error_rate=n,r._ratio=i,r._filters.push(u.default.create(r._initial_size,r._error_rate,r._ratio)),r._filters[r._filters.length-1].seed=r.seed,r}var n;return r(t,e),n=t,Object.defineProperty(t.prototype,"seed",{get:function(){return this._seed},set:function(e){var t=this;this._seed=e,this._rng=(0,m.default)("".concat(this._seed)),this._filters.forEach(function(e){e.seed=t.seed})},enumerable:!1,configurable:!0}),t.prototype.add=function(e){var t=this._filters[this._filters.length-1];if(t._currentload()>t._loadFactor){var i=this._initial_size*Math.pow(n._s,this._filters.length+1)*Math.LN2,r=this._error_rate*Math.pow(this._ratio,this._filters.length);this._filters.push(u.default.create(i,r,this._ratio)),this._filters[this._filters.length-1].seed=this.seed}this._filters[this._filters.length-1].add(e)},t.prototype.has=function(e){return this._filters.some(function(t){return t.has(e)})},t.prototype.capacity=function(){return this._filters.map(function(e){return e._capacity}).reduce(function(e,t){return e+t},0)},t.prototype.rate=function(){return this._filters[this._filters.length-1].rate()},t.prototype.equals=function(e){return this.seed===e.seed&&this._ratio===e._ratio&&this.capacity()===e.capacity()&&this._filters.every(function(t,n){return e._filters[n].equals(t)})},t.create=function(e,t,i){return void 0===i&&(i=.5),new n(e,t,i)},t._s=2,o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_initial_size",void 0),o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_error_rate",void 0),o([(0,d.Field)(),s("design:type",Number)],t.prototype,"_ratio",void 0),o([(0,d.Field)(function(e){return e.map(function(e){return e.saveAsJSON()})},function(e){return e.map(function(e){return u.default.fromJSON(e)})}),s("design:type",Array)],t.prototype,"_filters",void 0),t=n=o([(0,d.AutoExportable)("ScalableBloomFilter",["_seed"]),a(0,(0,d.Parameter)("_initial_size")),a(1,(0,d.Parameter)("_error_rate")),a(2,(0,d.Parameter)("_ratio")),s("design:paramtypes",[Object,Object,Object])],t)}(c.default);t.default=h},"./node_modules/bloom-filters/dist/exportable.js":function(e,t,n){"use strict";var i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,r,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s},r=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var i,r=0,o=t.length;r<o;r++)!i&&r in t||(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||Array.prototype.slice.call(t))};function o(e){return null==e?e:Array.isArray(e)?e.map(o):"object"==typeof e?"saveAsJSON"in e?e.saveAsJSON():Object.assign({},e):e}Object.defineProperty(t,"__esModule",{value:!0}),t.AutoExportable=t.Parameter=t.Field=t.Exportable=t.cloneObject=t.cloneField=void 0,n("./node_modules/reflect-metadata/Reflect.js"),t.cloneField=o,t.cloneObject=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return function(n){var i={type:e};return t.forEach(function(e){i[e]=o(n[e])}),i}},t.Exportable=function(e){return function(t){return t.prototype.saveAsJSON=function(){return e.export(this)},t.fromJSON=function(t){return e.import(t)},t}};var s=Symbol("bloom-filters:exportable:class-name"),a=Symbol("bloom-filters:exportable:fields"),l=Symbol("bloom-filters:exportable:constructor-parameters");t.Field=function(e,t){return void 0===e&&(e=o),void 0===t&&(t=function(e){return e}),function(n,i){var r=[];Reflect.hasMetadata(a,n)&&(r=Reflect.getMetadata(a,n)),r.push({name:i,exporter:e,importer:t}),Reflect.defineMetadata(a,r,n)}},t.Parameter=function(e){return function(t,n,i){var r=new Map;Reflect.hasMetadata(l,t)&&(r=Reflect.getMetadata(l,t)),r.set(e,i),Reflect.defineMetadata(l,r,t)}},t.AutoExportable=function(e,t){return void 0===t&&(t=[]),function(n){if(Reflect.defineMetadata(s,e,n.prototype),!Reflect.hasMetadata(a,n.prototype)||0===t.length)throw new SyntaxError("No exported fields declared when @AutoExportable is called");Reflect.hasMetadata(l,n)||Reflect.defineMetadata(l,new Map,n),n.prototype.saveAsJSON=function(){var e=this,i={type:Reflect.getMetadata(s,n.prototype)};return Reflect.getMetadata(a,n.prototype).forEach(function(t){i[t.name]=t.exporter(e[t.name])}),t.forEach(function(t){i[t]=o(e[t])}),i},n.fromJSON=function(e){var o=Reflect.getMetadata(s,n.prototype),c=Reflect.getMetadata(l,n),d=Reflect.getMetadata(a,n.prototype);if(e.type!==o)throw new Error("Cannot create an object ".concat(o,' from a JSON export with type "').concat(e.type,'"'));var u=[],m=[];t.map(function(e){return{name:e,importer:function(e){return e}}}).concat(d).forEach(function(t){if(!(t.name in e))throw new Error('Invalid import: required field "'.concat(t,'" not found in JSON export "').concat(e,'"'));c.has(t.name)?u[c.get(t.name)]=t.importer(e[t.name]):m.push({name:t.name,value:t.importer(e[t.name])})});var h=new(n.bind.apply(n,r([void 0],i(u),!1)));return m.forEach(function(e){h[e.name]=e.value}),h}}}},"./node_modules/bloom-filters/dist/hashing/hashing.js":function(e,t,n){"use strict";var i=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,r,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s},r=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var i,r=0,o=t.length;r<o;r++)!i&&r in t||(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||Array.prototype.slice.call(t))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var s=o(n("./node_modules/xxhashjs/lib/index.js")),a=n("./node_modules/bloom-filters/dist/utils.js"),l=function(){function e(){}return e.prototype.doubleHashing=function(e,t,n,i){return Math.abs((t+e*n+Math.floor((Math.pow(e,3)-e)/6))%i)},e.prototype.getDistinctIndexes=function(e,t,n,o){void 0===o&&(o=(0,a.getDefaultSeed)());for(var s=0,l=new Set,c=this.hashTwice(e,o);l.size<n;){var d=c.first%t;l.has(d)||l.add(d),c.first=(c.first+c.second)%t,c.second=(c.second+s)%t,++s>t&&(o++,c=this.hashTwice(e,o))}return r([],i(l.values()),!1)},e.prototype.getIndexes=function(e,t,n,i){void 0===i&&(i=(0,a.getDefaultSeed)());for(var r=[],o=this.hashTwice(e,i),s=0;s<n;s++)r.push(this.doubleHashing(s,o.first,o.second,t));return r},e.prototype.serialize=function(e,t){return t||(t=(0,a.getDefaultSeed)()),Number(s.default.h64(e,t).toNumber())},e.prototype.hashTwice=function(e,t){return void 0===t&&(t=(0,a.getDefaultSeed)()),{first:this.serialize(e,t+1),second:this.serialize(e,t+2)}},e.prototype.hashTwiceAsString=function(e,t){var n=this.hashTwice(e,t),i=n.first,r=n.second;return{first:(0,a.numberToHex)(i),second:(0,a.numberToHex)(r)}},e.prototype.hashTwiceIntAndString=function(e,t){void 0===t&&(t=(0,a.getDefaultSeed)());var n=this.hashIntAndString(e,t+1),i=this.hashIntAndString(e,t+2);return{int:{first:n.int,second:i.int},string:{first:n.string,second:i.string}}},e.prototype.hashAsInt=function(e,t){return void 0===t&&(t=(0,a.getDefaultSeed)()),this.serialize(e,t)},e.prototype.hashIntAndString=function(e,t){var n=this.hashAsInt(e,t);return{int:n,string:(0,a.numberToHex)(n)}},e}();t.default=l},"./node_modules/bloom-filters/dist/utils.js":function(e,t,n){"use strict";var i=n("./node_modules/buffer/index.js").Buffer,r=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultSeed=t.isEmptyBuffer=t.xorBuffer=t.randomInt=t.numberToHex=t.allocateArray=t.BufferError=void 0,t.BufferError="The buffer class must be available, if you are a browser user use the buffer package (https://www.npmjs.com/package/buffer)",t.allocateArray=function(e,t){for(var n=new Array(e),i="function"==typeof t?t:function(){return t},r=0;r<e;r++)n[r]=i();return n},t.numberToHex=function(e){var t=Number(e).toString(16);return t.length%4!=0&&(t="0".repeat(4-t.length%4)+t),t},t.randomInt=function(e,t,n){void 0===n&&(n=Math.random),e=Math.ceil(e),t=Math.floor(t);var i=n();return Math.floor(i*(t-e+1))+e},t.xorBuffer=function(e,t){for(var n=Math.max(e.length,t.length),r=i.allocUnsafe(n).fill(0),o=0;o<n;++o)o<e.length&&o<t.length?r[n-o-1]=e[e.length-o-1]^t[t.length-o-1]:o<e.length&&o>=t.length?r[n-o-1]^=e[e.length-o-1]:o<t.length&&o>=e.length&&(r[n-o-1]^=t[t.length-o-1]);for(var s=0,a=r.values(),l=a.next();!l.done&&0===l.value;)s++,l=a.next();return r.slice(s)},t.isEmptyBuffer=function(e){var t,n;if(null===e||!e)return!0;try{for(var i=r(e),o=i.next();!o.done;o=i.next()){if(0!==o.value)return!1}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return!0},t.getDefaultSeed=function(){return 78187493520}},"./node_modules/cuint/index.js":(e,t,n)=>{t.UINT32=n("./node_modules/cuint/lib/uint32.js"),t.UINT64=n("./node_modules/cuint/lib/uint64.js")},"./node_modules/cuint/lib/uint32.js":function(e,t){var n;!function(){i(Math.pow(36,5)),i(Math.pow(16,7)),i(Math.pow(10,9)),i(Math.pow(2,30)),i(36),i(16),i(10),i(2);function i(e,t){return this instanceof i?(this._low=0,this._high=0,this.remainder=null,void 0===t?o.call(this,e):"string"==typeof e?s.call(this,e,t):void r.call(this,e,t)):new i(e,t)}function r(e,t){return this._low=0|e,this._high=0|t,this}function o(e){return this._low=65535&e,this._high=e>>>16,this}function s(e,t){var n=parseInt(e,t||10);return this._low=65535&n,this._high=n>>>16,this}i.prototype.fromBits=r,i.prototype.fromNumber=o,i.prototype.fromString=s,i.prototype.toNumber=function(){return 65536*this._high+this._low},i.prototype.toString=function(e){return this.toNumber().toString(e||10)},i.prototype.add=function(e){var t=this._low+e._low,n=t>>>16;return n+=this._high+e._high,this._low=65535&t,this._high=65535&n,this},i.prototype.subtract=function(e){return this.add(e.clone().negate())},i.prototype.multiply=function(e){var t,n,i=this._high,r=this._low,o=e._high,s=e._low;return t=(n=r*s)>>>16,t+=i*s,t&=65535,t+=r*o,this._low=65535&n,this._high=65535&t,this},i.prototype.div=function(e){if(0==e._low&&0==e._high)throw Error("division by zero");if(0==e._high&&1==e._low)return this.remainder=new i(0),this;if(e.gt(this))return this.remainder=this.clone(),this._low=0,this._high=0,this;if(this.eq(e))return this.remainder=new i(0),this._low=1,this._high=0,this;for(var t=e.clone(),n=-1;!this.lt(t);)t.shiftLeft(1,!0),n++;for(this.remainder=this.clone(),this._low=0,this._high=0;n>=0;n--)t.shiftRight(1),this.remainder.lt(t)||(this.remainder.subtract(t),n>=16?this._high|=1<<n-16:this._low|=1<<n);return this},i.prototype.negate=function(){var e=1+(65535&~this._low);return this._low=65535&e,this._high=~this._high+(e>>>16)&65535,this},i.prototype.equals=i.prototype.eq=function(e){return this._low==e._low&&this._high==e._high},i.prototype.greaterThan=i.prototype.gt=function(e){return this._high>e._high||!(this._high<e._high)&&this._low>e._low},i.prototype.lessThan=i.prototype.lt=function(e){return this._high<e._high||!(this._high>e._high)&&this._low<e._low},i.prototype.or=function(e){return this._low|=e._low,this._high|=e._high,this},i.prototype.and=function(e){return this._low&=e._low,this._high&=e._high,this},i.prototype.not=function(){return this._low=65535&~this._low,this._high=65535&~this._high,this},i.prototype.xor=function(e){return this._low^=e._low,this._high^=e._high,this},i.prototype.shiftRight=i.prototype.shiftr=function(e){return e>16?(this._low=this._high>>e-16,this._high=0):16==e?(this._low=this._high,this._high=0):(this._low=this._low>>e|this._high<<16-e&65535,this._high>>=e),this},i.prototype.shiftLeft=i.prototype.shiftl=function(e,t){return e>16?(this._high=this._low<<e-16,this._low=0,t||(this._high&=65535)):16==e?(this._high=this._low,this._low=0):(this._high=this._high<<e|this._low>>16-e,this._low=this._low<<e&65535,t||(this._high&=65535)),this},i.prototype.rotateLeft=i.prototype.rotl=function(e){var t=this._high<<16|this._low;return t=t<<e|t>>>32-e,this._low=65535&t,this._high=t>>>16,this},i.prototype.rotateRight=i.prototype.rotr=function(e){var t=this._high<<16|this._low;return t=t>>>e|t<<32-e,this._low=65535&t,this._high=t>>>16,this},i.prototype.clone=function(){return new i(this._low,this._high)},void 0===(n=function(){return i}.apply(t,[]))||(e.exports=n)}()},"./node_modules/cuint/lib/uint64.js":function(e,t){var n;!function(){var i={16:o(Math.pow(16,5)),10:o(Math.pow(10,5)),2:o(Math.pow(2,5))},r={16:o(16),10:o(10),2:o(2)};function o(e,t,n,i){return this instanceof o?(this.remainder=null,"string"==typeof e?l.call(this,e,t):void 0===t?a.call(this,e):void s.apply(this,arguments)):new o(e,t,n,i)}function s(e,t,n,i){return void 0===n?(this._a00=65535&e,this._a16=e>>>16,this._a32=65535&t,this._a48=t>>>16,this):(this._a00=0|e,this._a16=0|t,this._a32=0|n,this._a48=0|i,this)}function a(e){return this._a00=65535&e,this._a16=e>>>16,this._a32=0,this._a48=0,this}function l(e,t){t=t||10,this._a00=0,this._a16=0,this._a32=0,this._a48=0;for(var n=i[t]||new o(Math.pow(t,5)),r=0,s=e.length;r<s;r+=5){var a=Math.min(5,s-r),l=parseInt(e.slice(r,r+a),t);this.multiply(a<5?new o(Math.pow(t,a)):n).add(new o(l))}return this}o.prototype.fromBits=s,o.prototype.fromNumber=a,o.prototype.fromString=l,o.prototype.toNumber=function(){return 65536*this._a16+this._a00},o.prototype.toString=function(e){var t=r[e=e||10]||new o(e);if(!this.gt(t))return this.toNumber().toString(e);for(var n=this.clone(),i=new Array(64),s=63;s>=0&&(n.div(t),i[s]=n.remainder.toNumber().toString(e),n.gt(t));s--);return i[s-1]=n.toNumber().toString(e),i.join("")},o.prototype.add=function(e){var t=this._a00+e._a00,n=t>>>16,i=(n+=this._a16+e._a16)>>>16,r=(i+=this._a32+e._a32)>>>16;return r+=this._a48+e._a48,this._a00=65535&t,this._a16=65535&n,this._a32=65535&i,this._a48=65535&r,this},o.prototype.subtract=function(e){return this.add(e.clone().negate())},o.prototype.multiply=function(e){var t=this._a00,n=this._a16,i=this._a32,r=this._a48,o=e._a00,s=e._a16,a=e._a32,l=t*o,c=l>>>16,d=(c+=t*s)>>>16;c&=65535,d+=(c+=n*o)>>>16;var u=(d+=t*a)>>>16;return d&=65535,u+=(d+=n*s)>>>16,d&=65535,u+=(d+=i*o)>>>16,u+=t*e._a48,u&=65535,u+=n*a,u&=65535,u+=i*s,u&=65535,u+=r*o,this._a00=65535&l,this._a16=65535&c,this._a32=65535&d,this._a48=65535&u,this},o.prototype.div=function(e){if(0==e._a16&&0==e._a32&&0==e._a48){if(0==e._a00)throw Error("division by zero");if(1==e._a00)return this.remainder=new o(0),this}if(e.gt(this))return this.remainder=this.clone(),this._a00=0,this._a16=0,this._a32=0,this._a48=0,this;if(this.eq(e))return this.remainder=new o(0),this._a00=1,this._a16=0,this._a32=0,this._a48=0,this;for(var t=e.clone(),n=-1;!this.lt(t);)t.shiftLeft(1,!0),n++;for(this.remainder=this.clone(),this._a00=0,this._a16=0,this._a32=0,this._a48=0;n>=0;n--)t.shiftRight(1),this.remainder.lt(t)||(this.remainder.subtract(t),n>=48?this._a48|=1<<n-48:n>=32?this._a32|=1<<n-32:n>=16?this._a16|=1<<n-16:this._a00|=1<<n);return this},o.prototype.negate=function(){var e=1+(65535&~this._a00);return this._a00=65535&e,e=(65535&~this._a16)+(e>>>16),this._a16=65535&e,e=(65535&~this._a32)+(e>>>16),this._a32=65535&e,this._a48=~this._a48+(e>>>16)&65535,this},o.prototype.equals=o.prototype.eq=function(e){return this._a48==e._a48&&this._a00==e._a00&&this._a32==e._a32&&this._a16==e._a16},o.prototype.greaterThan=o.prototype.gt=function(e){return this._a48>e._a48||!(this._a48<e._a48)&&(this._a32>e._a32||!(this._a32<e._a32)&&(this._a16>e._a16||!(this._a16<e._a16)&&this._a00>e._a00))},o.prototype.lessThan=o.prototype.lt=function(e){return this._a48<e._a48||!(this._a48>e._a48)&&(this._a32<e._a32||!(this._a32>e._a32)&&(this._a16<e._a16||!(this._a16>e._a16)&&this._a00<e._a00))},o.prototype.or=function(e){return this._a00|=e._a00,this._a16|=e._a16,this._a32|=e._a32,this._a48|=e._a48,this},o.prototype.and=function(e){return this._a00&=e._a00,this._a16&=e._a16,this._a32&=e._a32,this._a48&=e._a48,this},o.prototype.xor=function(e){return this._a00^=e._a00,this._a16^=e._a16,this._a32^=e._a32,this._a48^=e._a48,this},o.prototype.not=function(){return this._a00=65535&~this._a00,this._a16=65535&~this._a16,this._a32=65535&~this._a32,this._a48=65535&~this._a48,this},o.prototype.shiftRight=o.prototype.shiftr=function(e){return(e%=64)>=48?(this._a00=this._a48>>e-48,this._a16=0,this._a32=0,this._a48=0):e>=32?(e-=32,this._a00=65535&(this._a32>>e|this._a48<<16-e),this._a16=this._a48>>e&65535,this._a32=0,this._a48=0):e>=16?(e-=16,this._a00=65535&(this._a16>>e|this._a32<<16-e),this._a16=65535&(this._a32>>e|this._a48<<16-e),this._a32=this._a48>>e&65535,this._a48=0):(this._a00=65535&(this._a00>>e|this._a16<<16-e),this._a16=65535&(this._a16>>e|this._a32<<16-e),this._a32=65535&(this._a32>>e|this._a48<<16-e),this._a48=this._a48>>e&65535),this},o.prototype.shiftLeft=o.prototype.shiftl=function(e,t){return(e%=64)>=48?(this._a48=this._a00<<e-48,this._a32=0,this._a16=0,this._a00=0):e>=32?(e-=32,this._a48=this._a16<<e|this._a00>>16-e,this._a32=this._a00<<e&65535,this._a16=0,this._a00=0):e>=16?(e-=16,this._a48=this._a32<<e|this._a16>>16-e,this._a32=65535&(this._a16<<e|this._a00>>16-e),this._a16=this._a00<<e&65535,this._a00=0):(this._a48=this._a48<<e|this._a32>>16-e,this._a32=65535&(this._a32<<e|this._a16>>16-e),this._a16=65535&(this._a16<<e|this._a00>>16-e),this._a00=this._a00<<e&65535),t||(this._a48&=65535),this},o.prototype.rotateLeft=o.prototype.rotl=function(e){if(0==(e%=64))return this;if(e>=32){var t=this._a00;if(this._a00=this._a32,this._a32=t,t=this._a48,this._a48=this._a16,this._a16=t,32==e)return this;e-=32}var n=this._a48<<16|this._a32,i=this._a16<<16|this._a00,r=n<<e|i>>>32-e,o=i<<e|n>>>32-e;return this._a00=65535&o,this._a16=o>>>16,this._a32=65535&r,this._a48=r>>>16,this},o.prototype.rotateRight=o.prototype.rotr=function(e){if(0==(e%=64))return this;if(e>=32){var t=this._a00;if(this._a00=this._a32,this._a32=t,t=this._a48,this._a48=this._a16,this._a16=t,32==e)return this;e-=32}var n=this._a48<<16|this._a32,i=this._a16<<16|this._a00,r=n>>>e|i<<32-e,o=i>>>e|n<<32-e;return this._a00=65535&o,this._a16=o>>>16,this._a32=65535&r,this._a48=r>>>16,this},o.prototype.clone=function(){return new o(this._a00,this._a16,this._a32,this._a48)},void 0===(n=function(){return o}.apply(t,[]))||(e.exports=n)}()},"./node_modules/file-saver/dist/FileSaver.min.js":function(e,t,n){var i,r,o;r=[],void 0===(o="function"==typeof(i=function(){"use strict";function t(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}function i(e,t,n){var i=new XMLHttpRequest;i.open("GET",e),i.responseType="blob",i.onload=function(){l(i.response,t,n)},i.onerror=function(){console.error("could not download file")},i.send()}function r(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function o(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(n){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var s="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof n.g&&n.g.global===n.g?n.g:void 0,a=s.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),l=s.saveAs||("object"!=typeof window||window!==s?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(e,t,n){var a=s.URL||s.webkitURL,l=document.createElement("a");t=t||e.name||"download",l.download=t,l.rel="noopener","string"==typeof e?(l.href=e,l.origin===location.origin?o(l):r(l.href)?i(e,t,n):o(l,l.target="_blank")):(l.href=a.createObjectURL(e),setTimeout(function(){a.revokeObjectURL(l.href)},4e4),setTimeout(function(){o(l)},0))}:"msSaveOrOpenBlob"in navigator?function(e,n,s){if(n=n||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(t(e,s),n);else if(r(e))i(e,n,s);else{var a=document.createElement("a");a.href=e,a.target="_blank",setTimeout(function(){o(a)})}}:function(e,t,n,r){if((r=r||open("","_blank"))&&(r.document.title=r.document.body.innerText="downloading..."),"string"==typeof e)return i(e,t,n);var o="application/octet-stream"===e.type,l=/constructor/i.test(s.HTMLElement)||s.safari,c=/CriOS\/[\d]+/.test(navigator.userAgent);if((c||o&&l||a)&&"undefined"!=typeof FileReader){var d=new FileReader;d.onloadend=function(){var e=d.result;e=c?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),r?r.location.href=e:location=e,r=null},d.readAsDataURL(e)}else{var u=s.URL||s.webkitURL,m=u.createObjectURL(e);r?r.location=m:location.href=m,r=null,setTimeout(function(){u.revokeObjectURL(m)},4e4)}});s.saveAs=l.saveAs=l,e.exports=l})?i.apply(t,r):i)||(e.exports=o)},"./node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js":(e,t,n)=>{"use strict";var i=n("./node_modules/react-is/index.js"),r={childContextTypes:!0,contextType:!0,contextTypes:!0,defaultProps:!0,displayName:!0,getDefaultProps:!0,getDerivedStateFromError:!0,getDerivedStateFromProps:!0,mixins:!0,propTypes:!0,type:!0},o={name:!0,length:!0,prototype:!0,caller:!0,callee:!0,arguments:!0,arity:!0},s={$$typeof:!0,compare:!0,defaultProps:!0,displayName:!0,propTypes:!0,type:!0},a={};function l(e){return i.isMemo(e)?s:a[e.$$typeof]||r}a[i.ForwardRef]={$$typeof:!0,render:!0,defaultProps:!0,displayName:!0,propTypes:!0},a[i.Memo]=s;var c=Object.defineProperty,d=Object.getOwnPropertyNames,u=Object.getOwnPropertySymbols,m=Object.getOwnPropertyDescriptor,h=Object.getPrototypeOf,p=Object.prototype;e.exports=function e(t,n,i){if("string"!=typeof n){if(p){var r=h(n);r&&r!==p&&e(t,r,i)}var s=d(n);u&&(s=s.concat(u(n)));for(var a=l(t),g=l(n),v=0;v<s.length;++v){var f=s[v];if(!(o[f]||i&&i[f]||g&&g[f]||a&&a[f])){var _=m(n,f);try{c(t,f,_)}catch(e){}}}}return t}},"./node_modules/react-dom/cjs/react-dom-server-legacy.browser.production.js":(e,t,n)=>{"use strict";var i=n("./node_modules/react/index.js"),r=n("./node_modules/react-dom/index.js");function o(e){var t="https://react.dev/errors/"+e;if(1<arguments.length){t+="?args[]="+encodeURIComponent(arguments[1]);for(var n=2;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n])}return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=Symbol.for("react.transitional.element"),a=Symbol.for("react.portal"),l=Symbol.for("react.fragment"),c=Symbol.for("react.strict_mode"),d=Symbol.for("react.profiler"),u=Symbol.for("react.provider"),m=Symbol.for("react.consumer"),h=Symbol.for("react.context"),p=Symbol.for("react.forward_ref"),g=Symbol.for("react.suspense"),v=Symbol.for("react.suspense_list"),f=Symbol.for("react.memo"),_=Symbol.for("react.lazy"),y=Symbol.for("react.scope"),b=Symbol.for("react.activity"),E=Symbol.for("react.legacy_hidden"),w=Symbol.for("react.memo_cache_sentinel"),S=Symbol.for("react.view_transition"),x=Symbol.iterator,A=Array.isArray;function C(e,t){var n=3&e.length,i=e.length-n,r=t;for(t=0;t<i;){var o=255&e.charCodeAt(t)|(255&e.charCodeAt(++t))<<8|(255&e.charCodeAt(++t))<<16|(255&e.charCodeAt(++t))<<24;++t,r=27492+(65535&(r=5*(65535&(r=(r^=o=461845907*(65535&(o=(o=3432918353*(65535&o)+((3432918353*(o>>>16)&65535)<<16)&4294967295)<<15|o>>>17))+((461845907*(o>>>16)&65535)<<16)&4294967295)<<13|r>>>19))+((5*(r>>>16)&65535)<<16)&4294967295))+(((r>>>16)+58964&65535)<<16)}switch(o=0,n){case 3:o^=(255&e.charCodeAt(t+2))<<16;case 2:o^=(255&e.charCodeAt(t+1))<<8;case 1:r^=461845907*(65535&(o=(o=3432918353*(65535&(o^=255&e.charCodeAt(t)))+((3432918353*(o>>>16)&65535)<<16)&4294967295)<<15|o>>>17))+((461845907*(o>>>16)&65535)<<16)&4294967295}return r^=e.length,r=2246822507*(65535&(r^=r>>>16))+((2246822507*(r>>>16)&65535)<<16)&4294967295,((r=3266489909*(65535&(r^=r>>>13))+((3266489909*(r>>>16)&65535)<<16)&4294967295)^r>>>16)>>>0}var k=Object.assign,R=Object.prototype.hasOwnProperty,I=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),T={},P={};function N(e){return!!R.call(P,e)||!R.call(T,e)&&(I.test(e)?P[e]=!0:(T[e]=!0,!1))}var D=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" ")),M=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),O=/["'&<>]/;function F(e){if("boolean"==typeof e||"number"==typeof e||"bigint"==typeof e)return""+e;e=""+e;var t=O.exec(e);if(t){var n,i="",r=0;for(n=t.index;n<e.length;n++){switch(e.charCodeAt(n)){case 34:t="&quot;";break;case 38:t="&amp;";break;case 39:t="&#x27;";break;case 60:t="&lt;";break;case 62:t="&gt;";break;default:continue}r!==n&&(i+=e.slice(r,n)),r=n+1,i+=t}e=r!==n?i+e.slice(r,n):i}return e}var L=/([A-Z])/g,U=/^ms-/,B=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function V(e){return B.test(""+e)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":e}var j=i.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,z=r.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,H={pending:!1,data:null,method:null,action:null},W=z.d;z.d={f:W.f,r:W.r,D:function(e){var t=un||null;if(t){var n=t.resumableState,i=t.renderState;if("string"==typeof e&&e){var r,o;if(!n.dnsResources.hasOwnProperty(e))n.dnsResources[e]=null,(o=(n=i.headers)&&0<n.remainingCapacity)&&(r="<"+(""+e).replace(Ke,qe)+">; rel=dns-prefetch",o=0<=(n.remainingCapacity-=r.length+2)),o?(i.resets.dns[e]=null,n.preconnects&&(n.preconnects+=", "),n.preconnects+=r):(ce(r=[],{href:e,rel:"dns-prefetch"}),i.preconnects.add(r));Yn(t)}}else W.D(e)},C:function(e,t){var n=un||null;if(n){var i=n.resumableState,r=n.renderState;if("string"==typeof e&&e){var o="use-credentials"===t?"credentials":"string"==typeof t?"anonymous":"default";if(!i.connectResources[o].hasOwnProperty(e)){var s,a;if(i.connectResources[o][e]=null,a=(i=r.headers)&&0<i.remainingCapacity){if(a="<"+(""+e).replace(Ke,qe)+">; rel=preconnect","string"==typeof t)a+='; crossorigin="'+(""+t).replace($e,Je)+'"';s=a,a=0<=(i.remainingCapacity-=s.length+2)}a?(r.resets.connect[o][e]=null,i.preconnects&&(i.preconnects+=", "),i.preconnects+=s):(ce(o=[],{rel:"preconnect",href:e,crossOrigin:t}),r.preconnects.add(o))}Yn(n)}}else W.C(e,t)},L:function(e,t,n){var i=un||null;if(i){var r=i.resumableState,o=i.renderState;if(t&&e){switch(t){case"image":if(n)var s=n.imageSrcSet,a=n.imageSizes,l=n.fetchPriority;var c,d=s?s+"\n"+(a||""):e;if(r.imageResources.hasOwnProperty(d))return;r.imageResources[d]=G,(r=o.headers)&&0<r.remainingCapacity&&"string"!=typeof s&&"high"===l&&(c=Ge(e,t,n),0<=(r.remainingCapacity-=c.length+2))?(o.resets.image[d]=G,r.highImagePreloads&&(r.highImagePreloads+=", "),r.highImagePreloads+=c):(ce(r=[],k({rel:"preload",href:s?void 0:e,as:t},n)),"high"===l?o.highImagePreloads.add(r):(o.bulkPreloads.add(r),o.preloads.images.set(d,r)));break;case"style":if(r.styleResources.hasOwnProperty(e))return;ce(s=[],k({rel:"preload",href:e,as:t},n)),r.styleResources[e]=!n||"string"!=typeof n.crossOrigin&&"string"!=typeof n.integrity?G:[n.crossOrigin,n.integrity],o.preloads.stylesheets.set(e,s),o.bulkPreloads.add(s);break;case"script":if(r.scriptResources.hasOwnProperty(e))return;s=[],o.preloads.scripts.set(e,s),o.bulkPreloads.add(s),ce(s,k({rel:"preload",href:e,as:t},n)),r.scriptResources[e]=!n||"string"!=typeof n.crossOrigin&&"string"!=typeof n.integrity?G:[n.crossOrigin,n.integrity];break;default:if(r.unknownResources.hasOwnProperty(t)){if((s=r.unknownResources[t]).hasOwnProperty(e))return}else s={},r.unknownResources[t]=s;if(s[e]=G,(r=o.headers)&&0<r.remainingCapacity&&"font"===t&&(d=Ge(e,t,n),0<=(r.remainingCapacity-=d.length+2)))o.resets.font[e]=G,r.fontPreloads&&(r.fontPreloads+=", "),r.fontPreloads+=d;else if("font"===(ce(r=[],e=k({rel:"preload",href:e,as:t},n)),t))o.fontPreloads.add(r);else o.bulkPreloads.add(r)}Yn(i)}}else W.L(e,t,n)},m:function(e,t){var n=un||null;if(n){var i=n.resumableState,r=n.renderState;if(e){var o=t&&"string"==typeof t.as?t.as:"script";if("script"===o){if(i.moduleScriptResources.hasOwnProperty(e))return;o=[],i.moduleScriptResources[e]=!t||"string"!=typeof t.crossOrigin&&"string"!=typeof t.integrity?G:[t.crossOrigin,t.integrity],r.preloads.moduleScripts.set(e,o)}else{if(i.moduleUnknownResources.hasOwnProperty(o)){var s=i.unknownResources[o];if(s.hasOwnProperty(e))return}else s={},i.moduleUnknownResources[o]=s;o=[],s[e]=G}ce(o,k({rel:"modulepreload",href:e},t)),r.bulkPreloads.add(o),Yn(n)}}else W.m(e,t)},X:function(e,t){var n=un||null;if(n){var i=n.resumableState,r=n.renderState;if(e){var o=i.scriptResources.hasOwnProperty(e)?i.scriptResources[e]:void 0;null!==o&&(i.scriptResources[e]=null,t=k({src:e,async:!0},t),o&&(2===o.length&&We(t,o),e=r.preloads.scripts.get(e))&&(e.length=0),e=[],r.scripts.add(e),pe(e,t),Yn(n))}}else W.X(e,t)},S:function(e,t,n){var i=un||null;if(i){var r=i.resumableState,o=i.renderState;if(e){t=t||"default";var s=o.styles.get(t),a=r.styleResources.hasOwnProperty(e)?r.styleResources[e]:void 0;null!==a&&(r.styleResources[e]=null,s||(s={precedence:F(t),rules:[],hrefs:[],sheets:new Map},o.styles.set(t,s)),t={state:0,props:k({rel:"stylesheet",href:e,"data-precedence":t},n)},a&&(2===a.length&&We(t.props,a),(o=o.preloads.stylesheets.get(e))&&0<o.length?o.length=0:t.state=1),s.sheets.set(e,t),Yn(i))}}else W.S(e,t,n)},M:function(e,t){var n=un||null;if(n){var i=n.resumableState,r=n.renderState;if(e){var o=i.moduleScriptResources.hasOwnProperty(e)?i.moduleScriptResources[e]:void 0;null!==o&&(i.moduleScriptResources[e]=null,t=k({src:e,type:"module",async:!0},t),o&&(2===o.length&&We(t,o),e=r.preloads.moduleScripts.get(e))&&(e.length=0),e=[],r.scripts.add(e),pe(e,t),Yn(n))}}else W.M(e,t)}};var G=[],K=/(<\/|<)(s)(cript)/gi;function q(e,t,n,i){return t+("s"===n?"\\u0073":"\\u0053")+i}function $(){return{htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0}}function J(e,t,n){return{insertionMode:e,selectedValue:t,tagScope:n}}function Y(e,t,n){switch(t){case"noscript":return J(2,null,1|e.tagScope);case"select":return J(2,null!=n.value?n.value:n.defaultValue,e.tagScope);case"svg":return J(4,null,e.tagScope);case"picture":return J(2,null,2|e.tagScope);case"math":return J(5,null,e.tagScope);case"foreignObject":return J(2,null,e.tagScope);case"table":return J(6,null,e.tagScope);case"thead":case"tbody":case"tfoot":return J(7,null,e.tagScope);case"colgroup":return J(9,null,e.tagScope);case"tr":return J(8,null,e.tagScope);case"head":if(2>e.insertionMode)return J(3,null,e.tagScope);break;case"html":if(0===e.insertionMode)return J(1,null,e.tagScope)}return 6<=e.insertionMode||2>e.insertionMode?J(2,null,e.tagScope):e}var X=new Map;function Q(e,t){if("object"!=typeof t)throw Error(o(62));var n,i=!0;for(n in t)if(R.call(t,n)){var r=t[n];if(null!=r&&"boolean"!=typeof r&&""!==r){if(0===n.indexOf("--")){var s=F(n);r=F((""+r).trim())}else void 0===(s=X.get(n))&&(s=F(n.replace(L,"-$1").toLowerCase().replace(U,"-ms-")),X.set(n,s)),r="number"==typeof r?0===r||D.has(n)?""+r:r+"px":F((""+r).trim());i?(i=!1,e.push(' style="',s,":",r)):e.push(";",s,":",r)}}i||e.push('"')}function Z(e,t,n){n&&"function"!=typeof n&&"symbol"!=typeof n&&e.push(" ",t,'=""')}function ee(e,t,n){"function"!=typeof n&&"symbol"!=typeof n&&"boolean"!=typeof n&&e.push(" ",t,'="',F(n),'"')}var te=F("javascript:throw new Error('React form unexpectedly submitted.')");function ne(e,t){this.push('<input type="hidden"'),ie(e),ee(this,"name",t),ee(this,"value",e),this.push("/>")}function ie(e){if("string"!=typeof e)throw Error(o(480))}function re(e,t){if("function"==typeof t.$$FORM_ACTION){var n=e.nextFormID++;e=e.idPrefix+n;try{var i=t.$$FORM_ACTION(e);if(i){var r=i.data;null!=r&&r.forEach(ie)}return i}catch(e){if("object"==typeof e&&null!==e&&"function"==typeof e.then)throw e}}return null}function oe(e,t,n,i,r,o,s,a){var l=null;if("function"==typeof i){var c=re(t,i);null!==c?(a=c.name,i=c.action||"",r=c.encType,o=c.method,s=c.target,l=c.data):(e.push(" ","formAction",'="',te,'"'),s=o=r=i=a=null,le(t,n))}return null!=a&&se(e,"name",a),null!=i&&se(e,"formAction",i),null!=r&&se(e,"formEncType",r),null!=o&&se(e,"formMethod",o),null!=s&&se(e,"formTarget",s),l}function se(e,t,n){switch(t){case"className":ee(e,"class",n);break;case"tabIndex":ee(e,"tabindex",n);break;case"dir":case"role":case"viewBox":case"width":case"height":ee(e,t,n);break;case"style":Q(e,n);break;case"src":case"href":if(""===n)break;case"action":case"formAction":if(null==n||"function"==typeof n||"symbol"==typeof n||"boolean"==typeof n)break;n=V(""+n),e.push(" ",t,'="',F(n),'"');break;case"defaultValue":case"defaultChecked":case"innerHTML":case"suppressContentEditableWarning":case"suppressHydrationWarning":case"ref":break;case"autoFocus":case"multiple":case"muted":Z(e,t.toLowerCase(),n);break;case"xlinkHref":if("function"==typeof n||"symbol"==typeof n||"boolean"==typeof n)break;n=V(""+n),e.push(" ","xlink:href",'="',F(n),'"');break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":"function"!=typeof n&&"symbol"!=typeof n&&e.push(" ",t,'="',F(n),'"');break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":n&&"function"!=typeof n&&"symbol"!=typeof n&&e.push(" ",t,'=""');break;case"capture":case"download":!0===n?e.push(" ",t,'=""'):!1!==n&&"function"!=typeof n&&"symbol"!=typeof n&&e.push(" ",t,'="',F(n),'"');break;case"cols":case"rows":case"size":case"span":"function"!=typeof n&&"symbol"!=typeof n&&!isNaN(n)&&1<=n&&e.push(" ",t,'="',F(n),'"');break;case"rowSpan":case"start":"function"==typeof n||"symbol"==typeof n||isNaN(n)||e.push(" ",t,'="',F(n),'"');break;case"xlinkActuate":ee(e,"xlink:actuate",n);break;case"xlinkArcrole":ee(e,"xlink:arcrole",n);break;case"xlinkRole":ee(e,"xlink:role",n);break;case"xlinkShow":ee(e,"xlink:show",n);break;case"xlinkTitle":ee(e,"xlink:title",n);break;case"xlinkType":ee(e,"xlink:type",n);break;case"xmlBase":ee(e,"xml:base",n);break;case"xmlLang":ee(e,"xml:lang",n);break;case"xmlSpace":ee(e,"xml:space",n);break;default:if((!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&N(t=M.get(t)||t)){switch(typeof n){case"function":case"symbol":return;case"boolean":var i=t.toLowerCase().slice(0,5);if("data-"!==i&&"aria-"!==i)return}e.push(" ",t,'="',F(n),'"')}}}function ae(e,t,n){if(null!=t){if(null!=n)throw Error(o(60));if("object"!=typeof t||!("__html"in t))throw Error(o(61));null!=(t=t.__html)&&e.push(""+t)}}function le(e,t){!(16&e.instructions)&&(e.instructions|=16,t.bootstrapChunks.unshift(t.startInlineScript,'addEventListener("submit",function(a){if(!a.defaultPrevented){var c=a.target,d=a.submitter,e=c.action,b=d;if(d){var f=d.getAttribute("formAction");null!=f&&(e=f,b=null)}"javascript:throw new Error(\'React form unexpectedly submitted.\')"===e&&(a.preventDefault(),b?(a=document.createElement("input"),a.name=b.name,a.value=b.value,b.parentNode.insertBefore(a,b),b=new FormData(c),a.parentNode.removeChild(a)):b=new FormData(c),a=c.ownerDocument||c,(a.$$reactFormReplay=a.$$reactFormReplay||[]).push(c,d,b))}});',"<\/script>"))}function ce(e,t){for(var n in e.push(ye("link")),t)if(R.call(t,n)){var i=t[n];if(null!=i)switch(n){case"children":case"dangerouslySetInnerHTML":throw Error(o(399,"link"));default:se(e,n,i)}}return e.push("/>"),null}var de=/(<\/|<)(s)(tyle)/gi;function ue(e,t,n,i){return t+("s"===n?"\\73 ":"\\53 ")+i}function me(e,t,n){for(var i in e.push(ye(n)),t)if(R.call(t,i)){var r=t[i];if(null!=r)switch(i){case"children":case"dangerouslySetInnerHTML":throw Error(o(399,n));default:se(e,i,r)}}return e.push("/>"),null}function he(e,t){e.push(ye("title"));var n,i=null,r=null;for(n in t)if(R.call(t,n)){var o=t[n];if(null!=o)switch(n){case"children":i=o;break;case"dangerouslySetInnerHTML":r=o;break;default:se(e,n,o)}}return e.push(">"),"function"!=typeof(t=Array.isArray(i)?2>i.length?i[0]:null:i)&&"symbol"!=typeof t&&null!=t&&e.push(F(""+t)),ae(e,r,i),e.push(we("title")),null}function pe(e,t){e.push(ye("script"));var n,i=null,r=null;for(n in t)if(R.call(t,n)){var o=t[n];if(null!=o)switch(n){case"children":i=o;break;case"dangerouslySetInnerHTML":r=o;break;default:se(e,n,o)}}return e.push(">"),ae(e,r,i),"string"==typeof i&&e.push((""+i).replace(K,q)),e.push(we("script")),null}function ge(e,t,n){e.push(ye(n));var i,r=n=null;for(i in t)if(R.call(t,i)){var o=t[i];if(null!=o)switch(i){case"children":n=o;break;case"dangerouslySetInnerHTML":r=o;break;default:se(e,i,o)}}return e.push(">"),ae(e,r,n),n}function ve(e,t,n){e.push(ye(n));var i,r=n=null;for(i in t)if(R.call(t,i)){var o=t[i];if(null!=o)switch(i){case"children":n=o;break;case"dangerouslySetInnerHTML":r=o;break;default:se(e,i,o)}}return e.push(">"),ae(e,r,n),"string"==typeof n?(e.push(F(n)),null):n}var fe=/^[a-zA-Z][a-zA-Z:_\.\-\d]*$/,_e=new Map;function ye(e){var t=_e.get(e);if(void 0===t){if(!fe.test(e))throw Error(o(65,e));t="<"+e,_e.set(e,t)}return t}function be(e,t,n,r,s,a,l,c,d,u){switch(t){case"div":case"span":case"svg":case"path":case"g":case"p":case"li":case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":break;case"a":e.push(ye("a"));var m,h=null,p=null;for(m in n)if(R.call(n,m)){var g=n[m];if(null!=g)switch(m){case"children":h=g;break;case"dangerouslySetInnerHTML":p=g;break;case"href":""===g?ee(e,"href",""):se(e,m,g);break;default:se(e,m,g)}}if(e.push(">"),ae(e,p,h),"string"==typeof h){e.push(F(h));var v=null}else v=h;return v;case"select":e.push(ye("select"));var f,_=null,y=null;for(f in n)if(R.call(n,f)){var b=n[f];if(null!=b)switch(f){case"children":_=b;break;case"dangerouslySetInnerHTML":y=b;break;case"defaultValue":case"value":break;default:se(e,f,b)}}return e.push(">"),ae(e,y,_),_;case"option":var E=c.selectedValue;e.push(ye("option"));var w,S=null,x=null,C=null,I=null;for(w in n)if(R.call(n,w)){var T=n[w];if(null!=T)switch(w){case"children":S=T;break;case"selected":C=T;break;case"dangerouslySetInnerHTML":I=T;break;case"value":x=T;default:se(e,w,T)}}if(null!=E){var P=null!==x?""+x:function(e){var t="";return i.Children.forEach(e,function(e){null!=e&&(t+=e)}),t}(S);if(A(E)){for(var D=0;D<E.length;D++)if(""+E[D]===P){e.push(' selected=""');break}}else""+E===P&&e.push(' selected=""')}else C&&e.push(' selected=""');return e.push(">"),ae(e,I,S),S;case"textarea":e.push(ye("textarea"));var M,O=null,L=null,U=null;for(M in n)if(R.call(n,M)){var B=n[M];if(null!=B)switch(M){case"children":U=B;break;case"value":O=B;break;case"defaultValue":L=B;break;case"dangerouslySetInnerHTML":throw Error(o(91));default:se(e,M,B)}}if(null===O&&null!==L&&(O=L),e.push(">"),null!=U){if(null!=O)throw Error(o(92));if(A(U)){if(1<U.length)throw Error(o(93));O=""+U[0]}O=""+U}return"string"==typeof O&&"\n"===O[0]&&e.push("\n"),null!==O&&e.push(F(""+O)),null;case"input":e.push(ye("input"));var j,z=null,H=null,W=null,K=null,q=null,$=null,J=null,Y=null,X=null;for(j in n)if(R.call(n,j)){var ie=n[j];if(null!=ie)switch(j){case"children":case"dangerouslySetInnerHTML":throw Error(o(399,"input"));case"name":z=ie;break;case"formAction":H=ie;break;case"formEncType":W=ie;break;case"formMethod":K=ie;break;case"formTarget":q=ie;break;case"defaultChecked":X=ie;break;case"defaultValue":J=ie;break;case"checked":Y=ie;break;case"value":$=ie;break;default:se(e,j,ie)}}var fe=oe(e,r,s,H,W,K,q,z);return null!==Y?Z(e,"checked",Y):null!==X&&Z(e,"checked",X),null!==$?se(e,"value",$):null!==J&&se(e,"value",J),e.push("/>"),null!=fe&&fe.forEach(ne,e),null;case"button":e.push(ye("button"));var _e,be=null,Ee=null,Se=null,xe=null,Ae=null,Ce=null,ke=null;for(_e in n)if(R.call(n,_e)){var Re=n[_e];if(null!=Re)switch(_e){case"children":be=Re;break;case"dangerouslySetInnerHTML":Ee=Re;break;case"name":Se=Re;break;case"formAction":xe=Re;break;case"formEncType":Ae=Re;break;case"formMethod":Ce=Re;break;case"formTarget":ke=Re;break;default:se(e,_e,Re)}}var Ie=oe(e,r,s,xe,Ae,Ce,ke,Se);if(e.push(">"),null!=Ie&&Ie.forEach(ne,e),ae(e,Ee,be),"string"==typeof be){e.push(F(be));var Te=null}else Te=be;return Te;case"form":e.push(ye("form"));var Pe,Ne=null,De=null,Me=null,Oe=null,Fe=null,Le=null;for(Pe in n)if(R.call(n,Pe)){var Ue=n[Pe];if(null!=Ue)switch(Pe){case"children":Ne=Ue;break;case"dangerouslySetInnerHTML":De=Ue;break;case"action":Me=Ue;break;case"encType":Oe=Ue;break;case"method":Fe=Ue;break;case"target":Le=Ue;break;default:se(e,Pe,Ue)}}var Be=null,Ve=null;if("function"==typeof Me){var je=re(r,Me);null!==je?(Me=je.action||"",Oe=je.encType,Fe=je.method,Le=je.target,Be=je.data,Ve=je.name):(e.push(" ","action",'="',te,'"'),Le=Fe=Oe=Me=null,le(r,s))}if(null!=Me&&se(e,"action",Me),null!=Oe&&se(e,"encType",Oe),null!=Fe&&se(e,"method",Fe),null!=Le&&se(e,"target",Le),e.push(">"),null!==Ve&&(e.push('<input type="hidden"'),ee(e,"name",Ve),e.push("/>"),null!=Be&&Be.forEach(ne,e)),ae(e,De,Ne),"string"==typeof Ne){e.push(F(Ne));var ze=null}else ze=Ne;return ze;case"menuitem":for(var He in e.push(ye("menuitem")),n)if(R.call(n,He)){var Ke=n[He];if(null!=Ke)switch(He){case"children":case"dangerouslySetInnerHTML":throw Error(o(400));default:se(e,He,Ke)}}return e.push(">"),null;case"object":e.push(ye("object"));var qe,$e=null,Je=null;for(qe in n)if(R.call(n,qe)){var Ye=n[qe];if(null!=Ye)switch(qe){case"children":$e=Ye;break;case"dangerouslySetInnerHTML":Je=Ye;break;case"data":var Xe=V(""+Ye);if(""===Xe)break;e.push(" ","data",'="',F(Xe),'"');break;default:se(e,qe,Ye)}}if(e.push(">"),ae(e,Je,$e),"string"==typeof $e){e.push(F($e));var Qe=null}else Qe=$e;return Qe;case"title":if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp)var Ze=he(e,n);else u?Ze=null:(he(s.hoistableChunks,n),Ze=void 0);return Ze;case"link":var et=n.rel,tt=n.href,nt=n.precedence;if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp||"string"!=typeof et||"string"!=typeof tt||""===tt){ce(e,n);var it=null}else if("stylesheet"===n.rel)if("string"!=typeof nt||null!=n.disabled||n.onLoad||n.onError)it=ce(e,n);else{var rt=s.styles.get(nt),ot=r.styleResources.hasOwnProperty(tt)?r.styleResources[tt]:void 0;if(null!==ot){r.styleResources[tt]=null,rt||(rt={precedence:F(nt),rules:[],hrefs:[],sheets:new Map},s.styles.set(nt,rt));var st={state:0,props:k({},n,{"data-precedence":n.precedence,precedence:null})};if(ot){2===ot.length&&We(st.props,ot);var at=s.preloads.stylesheets.get(tt);at&&0<at.length?at.length=0:st.state=1}rt.sheets.set(tt,st),l&&l.stylesheets.add(st)}else if(rt){var lt=rt.sheets.get(tt);lt&&l&&l.stylesheets.add(lt)}d&&e.push("\x3c!-- --\x3e"),it=null}else n.onLoad||n.onError?it=ce(e,n):(d&&e.push("\x3c!-- --\x3e"),it=u?null:ce(s.hoistableChunks,n));return it;case"script":var ct=n.async;if("string"!=typeof n.src||!n.src||!ct||"function"==typeof ct||"symbol"==typeof ct||n.onLoad||n.onError||4===c.insertionMode||1&c.tagScope||null!=n.itemProp)var dt=pe(e,n);else{var ut=n.src;if("module"===n.type)var mt=r.moduleScriptResources,ht=s.preloads.moduleScripts;else mt=r.scriptResources,ht=s.preloads.scripts;var pt=mt.hasOwnProperty(ut)?mt[ut]:void 0;if(null!==pt){mt[ut]=null;var gt=n;if(pt){2===pt.length&&We(gt=k({},n),pt);var vt=ht.get(ut);vt&&(vt.length=0)}var ft=[];s.scripts.add(ft),pe(ft,gt)}d&&e.push("\x3c!-- --\x3e"),dt=null}return dt;case"style":var _t=n.precedence,yt=n.href;if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp||"string"!=typeof _t||"string"!=typeof yt||""===yt){e.push(ye("style"));var bt,Et=null,wt=null;for(bt in n)if(R.call(n,bt)){var St=n[bt];if(null!=St)switch(bt){case"children":Et=St;break;case"dangerouslySetInnerHTML":wt=St;break;default:se(e,bt,St)}}e.push(">");var xt=Array.isArray(Et)?2>Et.length?Et[0]:null:Et;"function"!=typeof xt&&"symbol"!=typeof xt&&null!=xt&&e.push((""+xt).replace(de,ue)),ae(e,wt,Et),e.push(we("style"));var At=null}else{var Ct=s.styles.get(_t);if(null!==(r.styleResources.hasOwnProperty(yt)?r.styleResources[yt]:void 0)){r.styleResources[yt]=null,Ct?Ct.hrefs.push(F(yt)):(Ct={precedence:F(_t),rules:[],hrefs:[F(yt)],sheets:new Map},s.styles.set(_t,Ct));var kt,Rt=Ct.rules,It=null,Tt=null;for(kt in n)if(R.call(n,kt)){var Pt=n[kt];if(null!=Pt)switch(kt){case"children":It=Pt;break;case"dangerouslySetInnerHTML":Tt=Pt}}var Nt=Array.isArray(It)?2>It.length?It[0]:null:It;"function"!=typeof Nt&&"symbol"!=typeof Nt&&null!=Nt&&Rt.push((""+Nt).replace(de,ue)),ae(Rt,Tt,It)}Ct&&l&&l.styles.add(Ct),d&&e.push("\x3c!-- --\x3e"),At=void 0}return At;case"meta":if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp)var Dt=me(e,n,"meta");else d&&e.push("\x3c!-- --\x3e"),Dt=u?null:"string"==typeof n.charSet?me(s.charsetChunks,n,"meta"):"viewport"===n.name?me(s.viewportChunks,n,"meta"):me(s.hoistableChunks,n,"meta");return Dt;case"listing":case"pre":e.push(ye(t));var Mt,Ot=null,Ft=null;for(Mt in n)if(R.call(n,Mt)){var Lt=n[Mt];if(null!=Lt)switch(Mt){case"children":Ot=Lt;break;case"dangerouslySetInnerHTML":Ft=Lt;break;default:se(e,Mt,Lt)}}if(e.push(">"),null!=Ft){if(null!=Ot)throw Error(o(60));if("object"!=typeof Ft||!("__html"in Ft))throw Error(o(61));var Ut=Ft.__html;null!=Ut&&("string"==typeof Ut&&0<Ut.length&&"\n"===Ut[0]?e.push("\n",Ut):e.push(""+Ut))}return"string"==typeof Ot&&"\n"===Ot[0]&&e.push("\n"),Ot;case"img":var Bt=n.src,Vt=n.srcSet;if(!("lazy"===n.loading||!Bt&&!Vt||"string"!=typeof Bt&&null!=Bt||"string"!=typeof Vt&&null!=Vt)&&"low"!==n.fetchPriority&&!1==!!(3&c.tagScope)&&("string"!=typeof Bt||":"!==Bt[4]||"d"!==Bt[0]&&"D"!==Bt[0]||"a"!==Bt[1]&&"A"!==Bt[1]||"t"!==Bt[2]&&"T"!==Bt[2]||"a"!==Bt[3]&&"A"!==Bt[3])&&("string"!=typeof Vt||":"!==Vt[4]||"d"!==Vt[0]&&"D"!==Vt[0]||"a"!==Vt[1]&&"A"!==Vt[1]||"t"!==Vt[2]&&"T"!==Vt[2]||"a"!==Vt[3]&&"A"!==Vt[3])){var jt="string"==typeof n.sizes?n.sizes:void 0,zt=Vt?Vt+"\n"+(jt||""):Bt,Ht=s.preloads.images,Wt=Ht.get(zt);if(Wt)("high"===n.fetchPriority||10>s.highImagePreloads.size)&&(Ht.delete(zt),s.highImagePreloads.add(Wt));else if(!r.imageResources.hasOwnProperty(zt)){r.imageResources[zt]=G;var Gt,Kt=n.crossOrigin,qt="string"==typeof Kt?"use-credentials"===Kt?Kt:"":void 0,$t=s.headers;$t&&0<$t.remainingCapacity&&"string"!=typeof n.srcSet&&("high"===n.fetchPriority||500>$t.highImagePreloads.length)&&(Gt=Ge(Bt,"image",{imageSrcSet:n.srcSet,imageSizes:n.sizes,crossOrigin:qt,integrity:n.integrity,nonce:n.nonce,type:n.type,fetchPriority:n.fetchPriority,referrerPolicy:n.refererPolicy}),0<=($t.remainingCapacity-=Gt.length+2))?(s.resets.image[zt]=G,$t.highImagePreloads&&($t.highImagePreloads+=", "),$t.highImagePreloads+=Gt):(ce(Wt=[],{rel:"preload",as:"image",href:Vt?void 0:Bt,imageSrcSet:Vt,imageSizes:jt,crossOrigin:qt,integrity:n.integrity,type:n.type,fetchPriority:n.fetchPriority,referrerPolicy:n.referrerPolicy}),"high"===n.fetchPriority||10>s.highImagePreloads.size?s.highImagePreloads.add(Wt):(s.bulkPreloads.add(Wt),Ht.set(zt,Wt)))}}return me(e,n,"img");case"base":case"area":case"br":case"col":case"embed":case"hr":case"keygen":case"param":case"source":case"track":case"wbr":return me(e,n,t);case"head":if(2>c.insertionMode){var Jt=a||s.preamble;if(Jt.headChunks)throw Error(o(545,"`<head>`"));Jt.headChunks=[];var Yt=ge(Jt.headChunks,n,"head")}else Yt=ve(e,n,"head");return Yt;case"body":if(2>c.insertionMode){var Xt=a||s.preamble;if(Xt.bodyChunks)throw Error(o(545,"`<body>`"));Xt.bodyChunks=[];var Qt=ge(Xt.bodyChunks,n,"body")}else Qt=ve(e,n,"body");return Qt;case"html":if(0===c.insertionMode){var Zt=a||s.preamble;if(Zt.htmlChunks)throw Error(o(545,"`<html>`"));Zt.htmlChunks=[""];var en=ge(Zt.htmlChunks,n,"html")}else en=ve(e,n,"html");return en;default:if(-1!==t.indexOf("-")){e.push(ye(t));var tn,nn=null,rn=null;for(tn in n)if(R.call(n,tn)){var on=n[tn];if(null!=on){var sn=tn;switch(tn){case"children":nn=on;break;case"dangerouslySetInnerHTML":rn=on;break;case"style":Q(e,on);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"ref":break;case"className":sn="class";default:if(N(tn)&&"function"!=typeof on&&"symbol"!=typeof on&&!1!==on){if(!0===on)on="";else if("object"==typeof on)continue;e.push(" ",sn,'="',F(on),'"')}}}}return e.push(">"),ae(e,rn,nn),nn}}return ve(e,n,t)}var Ee=new Map;function we(e){var t=Ee.get(e);return void 0===t&&(t="</"+e+">",Ee.set(e,t)),t}function Se(e,t){null===(e=e.preamble).htmlChunks&&t.htmlChunks&&(e.htmlChunks=t.htmlChunks,t.contribution|=1),null===e.headChunks&&t.headChunks&&(e.headChunks=t.headChunks,t.contribution|=4),null===e.bodyChunks&&t.bodyChunks&&(e.bodyChunks=t.bodyChunks,t.contribution|=2)}function xe(e,t){t=t.bootstrapChunks;for(var n=0;n<t.length-1;n++)e.push(t[n]);return!(n<t.length)||(n=t[n],t.length=0,e.push(n))}function Ae(e,t,n){if(e.push('\x3c!--$?--\x3e<template id="'),null===n)throw Error(o(395));return e.push(t.boundaryPrefix),t=n.toString(16),e.push(t),e.push('"></template>')}function Ce(e,t){0!==(t=t.contribution)&&(e.push("\x3c!--"),e.push(""+t),e.push("--\x3e"))}var ke=/[<\u2028\u2029]/g;function Re(e){return JSON.stringify(e).replace(ke,function(e){switch(e){case"<":return"\\u003c";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw Error("escapeJSStringsForInstructionScripts encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}})}var Ie=/[&><\u2028\u2029]/g;function Te(e){return JSON.stringify(e).replace(Ie,function(e){switch(e){case"&":return"\\u0026";case">":return"\\u003e";case"<":return"\\u003c";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw Error("escapeJSObjectForInstructionScripts encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}})}var Pe=!1,Ne=!0;function De(e){var t=e.rules,n=e.hrefs,i=0;if(n.length){for(this.push('<style media="not all" data-precedence="'),this.push(e.precedence),this.push('" data-href="');i<n.length-1;i++)this.push(n[i]),this.push(" ");for(this.push(n[i]),this.push('">'),i=0;i<t.length;i++)this.push(t[i]);Ne=this.push("</style>"),Pe=!0,t.length=0,n.length=0}}function Me(e){return 2!==e.state&&(Pe=!0)}function Oe(e,t,n){return Pe=!1,Ne=!0,t.styles.forEach(De,e),t.stylesheets.forEach(Me),Pe&&(n.stylesToHoist=!0),Ne}function Fe(e){for(var t=0;t<e.length;t++)this.push(e[t]);e.length=0}var Le=[];function Ue(e){ce(Le,e.props);for(var t=0;t<Le.length;t++)this.push(Le[t]);Le.length=0,e.state=2}function Be(e){var t=0<e.sheets.size;e.sheets.forEach(Ue,this),e.sheets.clear();var n=e.rules,i=e.hrefs;if(!t||i.length){if(this.push('<style data-precedence="'),this.push(e.precedence),e=0,i.length){for(this.push('" data-href="');e<i.length-1;e++)this.push(i[e]),this.push(" ");this.push(i[e])}for(this.push('">'),e=0;e<n.length;e++)this.push(n[e]);this.push("</style>"),n.length=0,i.length=0}}function Ve(e){if(0===e.state){e.state=1;var t=e.props;for(ce(Le,{rel:"preload",as:"style",href:e.props.href,crossOrigin:t.crossOrigin,fetchPriority:t.fetchPriority,integrity:t.integrity,media:t.media,hrefLang:t.hrefLang,referrerPolicy:t.referrerPolicy}),e=0;e<Le.length;e++)this.push(Le[e]);Le.length=0}}function je(e){e.sheets.forEach(Ve,this),e.sheets.clear()}function ze(e,t,n){var i=t.toLowerCase();switch(typeof n){case"function":case"symbol":return}switch(t){case"innerHTML":case"dangerouslySetInnerHTML":case"suppressContentEditableWarning":case"suppressHydrationWarning":case"style":case"ref":return;case"className":i="class",t=""+n;break;case"hidden":if(!1===n)return;t="";break;case"src":case"href":t=""+(n=V(n));break;default:if(2<t.length&&("o"===t[0]||"O"===t[0])&&("n"===t[1]||"N"===t[1])||!N(t))return;t=""+n}e.push(","),i=Te(i),e.push(i),e.push(","),i=Te(t),e.push(i)}function He(){return{styles:new Set,stylesheets:new Set}}function We(e,t){null==e.crossOrigin&&(e.crossOrigin=t[0]),null==e.integrity&&(e.integrity=t[1])}function Ge(e,t,n){for(var i in t="<"+(e=(""+e).replace(Ke,qe))+'>; rel=preload; as="'+(t=(""+t).replace($e,Je))+'"',n)R.call(n,i)&&("string"==typeof(e=n[i])&&(t+="; "+i.toLowerCase()+'="'+(""+e).replace($e,Je)+'"'));return t}var Ke=/[<>\r\n]/g;function qe(e){switch(e){case"<":return"%3C";case">":return"%3E";case"\n":return"%0A";case"\r":return"%0D";default:throw Error("escapeLinkHrefForHeaderContextReplacer encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}}var $e=/["';,\r\n]/g;function Je(e){switch(e){case'"':return"%22";case"'":return"%27";case";":return"%3B";case",":return"%2C";case"\n":return"%0A";case"\r":return"%0D";default:throw Error("escapeStringForLinkHeaderQuotedParamValueContextReplacer encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}}function Ye(e){this.styles.add(e)}function Xe(e){this.stylesheets.add(e)}function Qe(e,t,n,i){return n.generateStaticMarkup?(e.push(F(t)),!1):(""===t?e=i:(i&&e.push("\x3c!-- --\x3e"),e.push(F(t)),e=!0),e)}function Ze(e,t,n,i){t.generateStaticMarkup||n&&i&&e.push("\x3c!-- --\x3e")}var et=Function.prototype.bind,tt=Symbol.for("react.client.reference");function nt(e){if(null==e)return null;if("function"==typeof e)return e.$$typeof===tt?null:e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case l:return"Fragment";case d:return"Profiler";case c:return"StrictMode";case g:return"Suspense";case v:return"SuspenseList";case b:return"Activity"}if("object"==typeof e)switch(e.$$typeof){case a:return"Portal";case h:return(e.displayName||"Context")+".Provider";case m:return(e._context.displayName||"Context")+".Consumer";case p:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case f:return null!==(t=e.displayName||null)?t:nt(e.type)||"Memo";case _:t=e._payload,e=e._init;try{return nt(e(t))}catch(e){}}return null}var it={},rt=null;function ot(e,t){if(e!==t){e.context._currentValue2=e.parentValue,e=e.parent;var n=t.parent;if(null===e){if(null!==n)throw Error(o(401))}else{if(null===n)throw Error(o(401));ot(e,n)}t.context._currentValue2=t.value}}function st(e){e.context._currentValue2=e.parentValue,null!==(e=e.parent)&&st(e)}function at(e){var t=e.parent;null!==t&&at(t),e.context._currentValue2=e.value}function lt(e,t){if(e.context._currentValue2=e.parentValue,null===(e=e.parent))throw Error(o(402));e.depth===t.depth?ot(e,t):lt(e,t)}function ct(e,t){var n=t.parent;if(null===n)throw Error(o(402));e.depth===n.depth?ot(e,n):ct(e,n),t.context._currentValue2=t.value}function dt(e){var t=rt;t!==e&&(null===t?at(e):null===e?st(t):t.depth===e.depth?ot(t,e):t.depth>e.depth?lt(t,e):ct(t,e),rt=e)}var ut={enqueueSetState:function(e,t){null!==(e=e._reactInternals).queue&&e.queue.push(t)},enqueueReplaceState:function(e,t){(e=e._reactInternals).replace=!0,e.queue=[t]},enqueueForceUpdate:function(){}},mt={id:1,overflow:""};function ht(e,t,n){var i=e.id;e=e.overflow;var r=32-pt(i)-1;i&=~(1<<r),n+=1;var o=32-pt(t)+r;if(30<o){var s=r-r%5;return o=(i&(1<<s)-1).toString(32),i>>=s,r-=s,{id:1<<32-pt(t)+r|n<<r|i,overflow:o+e}}return{id:1<<o|n<<r|i,overflow:e}}var pt=Math.clz32?Math.clz32:function(e){return 0===(e>>>=0)?32:31-(gt(e)/vt|0)|0},gt=Math.log,vt=Math.LN2;var ft=Error(o(460));function _t(){}var yt=null;function bt(){if(null===yt)throw Error(o(459));var e=yt;return yt=null,e}var Et="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},wt=null,St=null,xt=null,At=null,Ct=null,kt=null,Rt=!1,It=!1,Tt=0,Pt=0,Nt=-1,Dt=0,Mt=null,Ot=null,Ft=0;function Lt(){if(null===wt)throw Error(o(321));return wt}function Ut(){if(0<Ft)throw Error(o(312));return{memoizedState:null,queue:null,next:null}}function Bt(){return null===kt?null===Ct?(Rt=!1,Ct=kt=Ut()):(Rt=!0,kt=Ct):null===kt.next?(Rt=!1,kt=kt.next=Ut()):(Rt=!0,kt=kt.next),kt}function Vt(){var e=Mt;return Mt=null,e}function jt(){At=xt=St=wt=null,It=!1,Ct=null,Ft=0,kt=Ot=null}function zt(e,t){return"function"==typeof t?t(e):t}function Ht(e,t,n){if(wt=Lt(),kt=Bt(),Rt){var i=kt.queue;if(t=i.dispatch,null!==Ot&&void 0!==(n=Ot.get(i))){Ot.delete(i),i=kt.memoizedState;do{i=e(i,n.action),n=n.next}while(null!==n);return kt.memoizedState=i,[i,t]}return[kt.memoizedState,t]}return e=e===zt?"function"==typeof t?t():t:void 0!==n?n(t):t,kt.memoizedState=e,e=(e=kt.queue={last:null,dispatch:null}).dispatch=Gt.bind(null,wt,e),[kt.memoizedState,e]}function Wt(e,t){if(wt=Lt(),t=void 0===t?null:t,null!==(kt=Bt())){var n=kt.memoizedState;if(null!==n&&null!==t){var i=n[1];e:if(null===i)i=!1;else{for(var r=0;r<i.length&&r<t.length;r++)if(!Et(t[r],i[r])){i=!1;break e}i=!0}if(i)return n[0]}}return e=e(),kt.memoizedState=[e,t],e}function Gt(e,t,n){if(25<=Ft)throw Error(o(301));if(e===wt)if(It=!0,e={action:n,next:null},null===Ot&&(Ot=new Map),void 0===(n=Ot.get(t)))Ot.set(t,e);else{for(t=n;null!==t.next;)t=t.next;t.next=e}}function Kt(){throw Error(o(394))}function qt(){throw Error(o(479))}function $t(e,t,n){Lt();var i=Pt++,r=xt;if("function"==typeof e.$$FORM_ACTION){var o=null,s=At;r=r.formState;var a=e.$$IS_SIGNATURE_EQUAL;if(null!==r&&"function"==typeof a){var l=r[1];a.call(e,r[2],r[3])&&(l===(o=void 0!==n?"p"+n:"k"+C(JSON.stringify([s,null,i]),0))&&(Nt=i,t=r[0]))}var c=e.bind(null,t);return e=function(e){c(e)},"function"==typeof c.$$FORM_ACTION&&(e.$$FORM_ACTION=function(e){e=c.$$FORM_ACTION(e),void 0!==n&&(n+="",e.action=n);var t=e.data;return t&&(null===o&&(o=void 0!==n?"p"+n:"k"+C(JSON.stringify([s,null,i]),0)),t.append("$ACTION_KEY",o)),e}),[t,e,!1]}var d=e.bind(null,t);return[t,function(e){d(e)},!1]}function Jt(e){var t=Dt;return Dt+=1,null===Mt&&(Mt=[]),function(e,t,n){switch(void 0===(n=e[n])?e.push(t):n!==t&&(t.then(_t,_t),t=n),t.status){case"fulfilled":return t.value;case"rejected":throw t.reason;default:switch("string"==typeof t.status?t.then(_t,_t):((e=t).status="pending",e.then(function(e){if("pending"===t.status){var n=t;n.status="fulfilled",n.value=e}},function(e){if("pending"===t.status){var n=t;n.status="rejected",n.reason=e}})),t.status){case"fulfilled":return t.value;case"rejected":throw t.reason}throw yt=t,ft}}(Mt,e,t)}function Yt(){throw Error(o(393))}function Xt(){}var Qt,Zt,en={readContext:function(e){return e._currentValue2},use:function(e){if(null!==e&&"object"==typeof e){if("function"==typeof e.then)return Jt(e);if(e.$$typeof===h)return e._currentValue2}throw Error(o(438,String(e)))},useContext:function(e){return Lt(),e._currentValue2},useMemo:Wt,useReducer:Ht,useRef:function(e){wt=Lt();var t=(kt=Bt()).memoizedState;return null===t?(e={current:e},kt.memoizedState=e):t},useState:function(e){return Ht(zt,e)},useInsertionEffect:Xt,useLayoutEffect:Xt,useCallback:function(e,t){return Wt(function(){return e},t)},useImperativeHandle:Xt,useEffect:Xt,useDebugValue:Xt,useDeferredValue:function(e,t){return Lt(),void 0!==t?t:e},useTransition:function(){return Lt(),[!1,Kt]},useId:function(){var e=St.treeContext,t=e.overflow;e=((e=e.id)&~(1<<32-pt(e)-1)).toString(32)+t;var n=tn;if(null===n)throw Error(o(404));return t=Tt++,e=""+n.idPrefix+"R"+e,0<t&&(e+="H"+t.toString(32)),e+""},useSyncExternalStore:function(e,t,n){if(void 0===n)throw Error(o(407));return n()},useOptimistic:function(e){return Lt(),[e,qt]},useActionState:$t,useFormState:$t,useHostTransitionStatus:function(){return Lt(),H},useMemoCache:function(e){for(var t=Array(e),n=0;n<e;n++)t[n]=w;return t},useCacheRefresh:function(){return Yt}},tn=null,nn={getCacheForType:function(){throw Error(o(248))}};function rn(e){if(void 0===Qt)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);Qt=t&&t[1]||"",Zt=-1<e.stack.indexOf("\n    at")?" (<anonymous>)":-1<e.stack.indexOf("@")?"@unknown:0:0":""}return"\n"+Qt+e+Zt}var on=!1;function sn(e,t){if(!e||on)return"";on=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var i={DetermineComponentFrameRoot:function(){try{if(t){var n=function(){throw Error()};if(Object.defineProperty(n.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(n,[])}catch(e){var i=e}Reflect.construct(e,[],n)}else{try{n.call()}catch(e){i=e}e.call(n.prototype)}}else{try{throw Error()}catch(e){i=e}(n=e())&&"function"==typeof n.catch&&n.catch(function(){})}}catch(e){if(e&&i&&"string"==typeof e.stack)return[e.stack,i.stack]}return[null,null]}};i.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var r=Object.getOwnPropertyDescriptor(i.DetermineComponentFrameRoot,"name");r&&r.configurable&&Object.defineProperty(i.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var o=i.DetermineComponentFrameRoot(),s=o[0],a=o[1];if(s&&a){var l=s.split("\n"),c=a.split("\n");for(r=i=0;i<l.length&&!l[i].includes("DetermineComponentFrameRoot");)i++;for(;r<c.length&&!c[r].includes("DetermineComponentFrameRoot");)r++;if(i===l.length||r===c.length)for(i=l.length-1,r=c.length-1;1<=i&&0<=r&&l[i]!==c[r];)r--;for(;1<=i&&0<=r;i--,r--)if(l[i]!==c[r]){if(1!==i||1!==r)do{if(i--,0>--r||l[i]!==c[r]){var d="\n"+l[i].replace(" at new "," at ");return e.displayName&&d.includes("<anonymous>")&&(d=d.replace("<anonymous>",e.displayName)),d}}while(1<=i&&0<=r);break}}}finally{on=!1,Error.prepareStackTrace=n}return(n=e?e.displayName||e.name:"")?rn(n):""}function an(e){if("string"==typeof e)return rn(e);if("function"==typeof e)return e.prototype&&e.prototype.isReactComponent?sn(e,!0):sn(e,!1);if("object"==typeof e&&null!==e){switch(e.$$typeof){case p:return sn(e.render,!1);case f:return sn(e.type,!1);case _:var t=e,n=t._payload;t=t._init;try{e=t(n)}catch(e){return rn("Lazy")}return an(e)}if("string"==typeof e.name)return n=e.env,rn(e.name+(n?" ["+n+"]":""))}switch(e){case v:return rn("SuspenseList");case g:return rn("Suspense")}return""}function ln(e){if("object"==typeof e&&null!==e&&"string"==typeof e.environmentName){var t=e.environmentName;"string"==typeof(e=[e].slice(0))[0]?e.splice(0,1,"[%s] "+e[0]," "+t+" "):e.splice(0,0,"[%s] "," "+t+" "),e.unshift(console),(t=et.apply(console.error,e))()}else console.error(e);return null}function cn(){}function dn(e,t,n,i,r,o,s,a,l,c,d){var u=new Set;this.destination=null,this.flushScheduled=!1,this.resumableState=e,this.renderState=t,this.rootFormatContext=n,this.progressiveChunkSize=void 0===i?12800:i,this.status=10,this.fatalError=null,this.pendingRootTasks=this.allPendingTasks=this.nextSegmentId=0,this.completedPreambleSegments=this.completedRootSegment=null,this.abortableTasks=u,this.pingedTasks=[],this.clientRenderedBoundaries=[],this.completedBoundaries=[],this.partialBoundaries=[],this.trackedPostpones=null,this.onError=void 0===r?ln:r,this.onPostpone=void 0===c?cn:c,this.onAllReady=void 0===o?cn:o,this.onShellReady=void 0===s?cn:s,this.onShellError=void 0===a?cn:a,this.onFatalError=void 0===l?cn:l,this.formState=void 0===d?null:d}var un=null;function mn(e,t){e.pingedTasks.push(t),1===e.pingedTasks.length&&(e.flushScheduled=null!==e.destination,Vn(e))}function hn(e,t,n,i){return{status:0,rootSegmentID:-1,parentFlushed:!1,pendingTasks:0,completedSegments:[],byteSize:0,fallbackAbortableTasks:t,errorDigest:null,contentState:He(),fallbackState:He(),contentPreamble:n,fallbackPreamble:i,trackedContentKeyPath:null,trackedFallbackNode:null}}function pn(e,t,n,i,r,o,s,a,l,c,d,u,m,h,p){e.allPendingTasks++,null===r?e.pendingRootTasks++:r.pendingTasks++;var g={replay:null,node:n,childIndex:i,ping:function(){return mn(e,g)},blockedBoundary:r,blockedSegment:o,blockedPreamble:s,hoistableState:a,abortSet:l,keyPath:c,formatContext:d,context:u,treeContext:m,componentStack:h,thenableState:t,isFallback:p};return l.add(g),g}function gn(e,t,n,i,r,o,s,a,l,c,d,u,m,h){e.allPendingTasks++,null===o?e.pendingRootTasks++:o.pendingTasks++,n.pendingTasks++;var p={replay:n,node:i,childIndex:r,ping:function(){return mn(e,p)},blockedBoundary:o,blockedSegment:null,blockedPreamble:null,hoistableState:s,abortSet:a,keyPath:l,formatContext:c,context:d,treeContext:u,componentStack:m,thenableState:t,isFallback:h};return a.add(p),p}function vn(e,t,n,i,r,o){return{status:0,parentFlushed:!1,id:-1,index:t,chunks:[],children:[],preambleChildren:[],parentFormatContext:i,boundary:n,lastPushedText:r,textEmbedded:o}}function fn(e){var t=e.node;if("object"==typeof t&&null!==t&&t.$$typeof===s)e.componentStack={parent:e.componentStack,type:t.type}}function _n(e){var t={};return e&&Object.defineProperty(t,"componentStack",{configurable:!0,enumerable:!0,get:function(){try{var n="",i=e;do{n+=an(i.type),i=i.parent}while(i);var r=n}catch(e){r="\nError generating stack: "+e.message+"\n"+e.stack}return Object.defineProperty(t,"componentStack",{value:r}),r}}),t}function yn(e,t,n){if(null==(t=(e=e.onError)(t,n))||"string"==typeof t)return t}function bn(e,t){var n=e.onShellError,i=e.onFatalError;n(t),i(t),null!==e.destination?(e.status=14,e.destination.destroy(t)):(e.status=13,e.fatalError=t)}function En(e,t,n,i,r,o){var s=t.thenableState;for(t.thenableState=null,wt={},St=t,xt=e,At=n,Pt=Tt=0,Nt=-1,Dt=0,Mt=s,e=i(r,o);It;)It=!1,Pt=Tt=0,Nt=-1,Dt=0,Ft+=1,kt=null,e=i(r,o);return jt(),e}function wn(e,t,n,i,r,o,s){var a=!1;if(0!==o&&null!==e.formState){var l=t.blockedSegment;if(null!==l){a=!0,l=l.chunks;for(var c=0;c<o;c++)c===s?l.push("\x3c!--F!--\x3e"):l.push("\x3c!--F--\x3e")}}o=t.keyPath,t.keyPath=n,r?(n=t.treeContext,t.treeContext=ht(n,1,0),Pn(e,t,i,-1),t.treeContext=n):a?Pn(e,t,i,-1):An(e,t,i,-1),t.keyPath=o}function Sn(e,t,n,i,r,s){if("function"==typeof i)if(i.prototype&&i.prototype.isReactComponent){var a=r;if("ref"in r)for(var w in a={},r)"ref"!==w&&(a[w]=r[w]);var x=i.defaultProps;if(x)for(var A in a===r&&(a=k({},a,r)),x)void 0===a[A]&&(a[A]=x[A]);r=a,a=it,"object"==typeof(x=i.contextType)&&null!==x&&(a=x._currentValue2);var C=void 0!==(a=new i(r,a)).state?a.state:null;if(a.updater=ut,a.props=r,a.state=C,x={queue:[],replace:!1},a._reactInternals=x,s=i.contextType,a.context="object"==typeof s&&null!==s?s._currentValue2:it,"function"==typeof(s=i.getDerivedStateFromProps)&&(C=null==(s=s(r,C))?C:k({},C,s),a.state=C),"function"!=typeof i.getDerivedStateFromProps&&"function"!=typeof a.getSnapshotBeforeUpdate&&("function"==typeof a.UNSAFE_componentWillMount||"function"==typeof a.componentWillMount))if(i=a.state,"function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount(),i!==a.state&&ut.enqueueReplaceState(a,a.state,null),null!==x.queue&&0<x.queue.length)if(i=x.queue,s=x.replace,x.queue=null,x.replace=!1,s&&1===i.length)a.state=i[0];else{for(x=s?i[0]:a.state,C=!0,s=s?1:0;s<i.length;s++)null!=(A="function"==typeof(A=i[s])?A.call(a,x,r,void 0):A)&&(C?(C=!1,x=k({},x,A)):k(x,A));a.state=x}else x.queue=null;if(i=a.render(),12===e.status)throw null;r=t.keyPath,t.keyPath=n,An(e,t,i,-1),t.keyPath=r}else{if(i=En(e,t,n,i,r,void 0),12===e.status)throw null;wn(e,t,n,i,0!==Tt,Pt,Nt)}else{if("string"!=typeof i){switch(i){case E:case c:case d:case l:return i=t.keyPath,t.keyPath=n,An(e,t,r.children,-1),void(t.keyPath=i);case b:return void("hidden"!==r.mode&&(i=t.keyPath,t.keyPath=n,An(e,t,r.children,-1),t.keyPath=i));case v:return i=t.keyPath,t.keyPath=n,An(e,t,r.children,-1),void(t.keyPath=i);case S:case y:throw Error(o(343));case g:e:if(null!==t.replay){i=t.keyPath,t.keyPath=n,n=r.children;try{Pn(e,t,n,-1)}finally{t.keyPath=i}}else{i=t.keyPath;var R=t.blockedBoundary;s=t.blockedPreamble;var I=t.hoistableState;A=t.blockedSegment,w=r.fallback,r=r.children;var T=new Set,P=2>t.formatContext.insertionMode?hn(0,T,{htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0},{htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0}):hn(0,T,null,null);null!==e.trackedPostpones&&(P.trackedContentKeyPath=n);var N=vn(0,A.chunks.length,P,t.formatContext,!1,!1);A.children.push(N),A.lastPushedText=!1;var D=vn(0,0,null,t.formatContext,!1,!1);if(D.parentFlushed=!0,null!==e.trackedPostpones){x=[(a=[n[0],"Suspense Fallback",n[2]])[1],a[2],[],null],e.trackedPostpones.workingMap.set(a,x),P.trackedFallbackNode=x,t.blockedSegment=N,t.blockedPreamble=P.fallbackPreamble,t.keyPath=a,N.status=6;try{Pn(e,t,w,-1),Ze(N.chunks,e.renderState,N.lastPushedText,N.textEmbedded),N.status=1}catch(t){throw N.status=12===e.status?3:4,t}finally{t.blockedSegment=A,t.blockedPreamble=s,t.keyPath=i}fn(t=pn(e,null,r,-1,P,D,P.contentPreamble,P.contentState,t.abortSet,n,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)),e.pingedTasks.push(t)}else{t.blockedBoundary=P,t.blockedPreamble=P.contentPreamble,t.hoistableState=P.contentState,t.blockedSegment=D,t.keyPath=n,D.status=6;try{if(Pn(e,t,r,-1),Ze(D.chunks,e.renderState,D.lastPushedText,D.textEmbedded),D.status=1,Un(P,D),0===P.pendingTasks&&0===P.status){P.status=1,0===e.pendingRootTasks&&t.blockedPreamble&&Hn(e);break e}}catch(n){P.status=4,12===e.status?(D.status=3,a=e.fatalError):(D.status=4,a=n),C=yn(e,a,x=_n(t.componentStack)),P.errorDigest=C,Rn(e,P)}finally{t.blockedBoundary=R,t.blockedPreamble=s,t.hoistableState=I,t.blockedSegment=A,t.keyPath=i}fn(t=pn(e,null,w,-1,R,N,P.fallbackPreamble,P.fallbackState,T,[n[0],"Suspense Fallback",n[2]],t.formatContext,t.context,t.treeContext,t.componentStack,!0)),e.pingedTasks.push(t)}}return}if("object"==typeof i&&null!==i)switch(i.$$typeof){case p:if("ref"in r)for(P in a={},r)"ref"!==P&&(a[P]=r[P]);else a=r;return void wn(e,t,n,i=En(e,t,n,i.render,a,s),0!==Tt,Pt,Nt);case f:return void Sn(e,t,n,i.type,r,s);case u:case h:if(x=r.children,a=t.keyPath,r=r.value,C=i._currentValue2,i._currentValue2=r,rt=i={parent:s=rt,depth:null===s?0:s.depth+1,context:i,parentValue:C,value:r},t.context=i,t.keyPath=n,An(e,t,x,-1),null===(e=rt))throw Error(o(403));return e.context._currentValue2=e.parentValue,e=rt=e.parent,t.context=e,void(t.keyPath=a);case m:return i=(r=r.children)(i._context._currentValue2),r=t.keyPath,t.keyPath=n,An(e,t,i,-1),void(t.keyPath=r);case _:if(i=(a=i._init)(i._payload),12===e.status)throw null;return void Sn(e,t,n,i,r,s)}throw Error(o(130,null==i?i:typeof i,""))}if(null===(a=t.blockedSegment))a=r.children,x=t.formatContext,C=t.keyPath,t.formatContext=Y(x,i,r),t.keyPath=n,Pn(e,t,a,-1),t.formatContext=x,t.keyPath=C;else{s=be(a.chunks,i,r,e.resumableState,e.renderState,t.blockedPreamble,t.hoistableState,t.formatContext,a.lastPushedText,t.isFallback),a.lastPushedText=!1,x=t.formatContext,C=t.keyPath,t.keyPath=n,3===(t.formatContext=Y(x,i,r)).insertionMode?(n=vn(0,0,null,t.formatContext,!1,!1),a.preambleChildren.push(n),fn(n=pn(e,null,s,-1,t.blockedBoundary,n,t.blockedPreamble,t.hoistableState,e.abortableTasks,t.keyPath,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)),e.pingedTasks.push(n)):Pn(e,t,s,-1),t.formatContext=x,t.keyPath=C;e:{switch(t=a.chunks,e=e.resumableState,i){case"title":case"style":case"script":case"area":case"base":case"br":case"col":case"embed":case"hr":case"img":case"input":case"keygen":case"link":case"meta":case"param":case"source":case"track":case"wbr":break e;case"body":if(1>=x.insertionMode){e.hasBody=!0;break e}break;case"html":if(0===x.insertionMode){e.hasHtml=!0;break e}break;case"head":if(1>=x.insertionMode)break e}t.push(we(i))}a.lastPushedText=!1}}}function xn(e,t,n,i,r){var o=t.replay,s=t.blockedBoundary,a=vn(0,0,null,t.formatContext,!1,!1);a.id=n,a.parentFlushed=!0;try{t.replay=null,t.blockedSegment=a,Pn(e,t,i,r),a.status=1,null===s?e.completedRootSegment=a:(Un(s,a),s.parentFlushed&&e.partialBoundaries.push(s))}finally{t.replay=o,t.blockedSegment=null}}function An(e,t,n,i){null!==t.replay&&"number"==typeof t.replay.slots?xn(e,t,t.replay.slots,n,i):(t.node=n,t.childIndex=i,n=t.componentStack,fn(t),Cn(e,t),t.componentStack=n)}function Cn(e,t){var n=t.node,i=t.childIndex;if(null!==n){if("object"==typeof n){switch(n.$$typeof){case s:var r=n.type,l=n.key,c=n.props,d=void 0!==(n=c.ref)?n:null,u=nt(r),m=null==l?-1===i?0:i:l;if(l=[t.keyPath,u,m],null!==t.replay)e:{var p=t.replay;for(i=p.nodes,n=0;n<i.length;n++){var v=i[n];if(m===v[1]){if(4===v.length){if(null!==u&&u!==v[0])throw Error(o(490,v[0],u));var f=v[2];u=v[3],m=t.node,t.replay={nodes:f,slots:u,pendingTasks:1};try{if(Sn(e,t,l,r,c,d),1===t.replay.pendingTasks&&0<t.replay.nodes.length)throw Error(o(488));t.replay.pendingTasks--}catch(n){if("object"==typeof n&&null!==n&&(n===ft||"function"==typeof n.then))throw t.node===m&&(t.replay=p),n;t.replay.pendingTasks--,c=_n(t.componentStack),Dn(e,l=t.blockedBoundary,f,u,r=n,c=yn(e,r,c))}t.replay=p}else{if(r!==g)throw Error(o(490,"Suspense",nt(r)||"Unknown"));t:{p=void 0,r=v[5],d=v[2],u=v[3],m=null===v[4]?[]:v[4][2],v=null===v[4]?null:v[4][3];var y=t.keyPath,b=t.replay,E=t.blockedBoundary,w=t.hoistableState,S=c.children,C=c.fallback,k=new Set;(c=2>t.formatContext.insertionMode?hn(0,k,$(),$()):hn(0,k,null,null)).parentFlushed=!0,c.rootSegmentID=r,t.blockedBoundary=c,t.hoistableState=c.contentState,t.keyPath=l,t.replay={nodes:d,slots:u,pendingTasks:1};try{if(Pn(e,t,S,-1),1===t.replay.pendingTasks&&0<t.replay.nodes.length)throw Error(o(488));if(t.replay.pendingTasks--,0===c.pendingTasks&&0===c.status){c.status=1,e.completedBoundaries.push(c);break t}}catch(n){c.status=4,p=yn(e,n,f=_n(t.componentStack)),c.errorDigest=p,t.replay.pendingTasks--,e.clientRenderedBoundaries.push(c)}finally{t.blockedBoundary=E,t.hoistableState=w,t.replay=b,t.keyPath=y}fn(t=gn(e,null,{nodes:m,slots:v,pendingTasks:0},C,-1,E,c.fallbackState,k,[l[0],"Suspense Fallback",l[2]],t.formatContext,t.context,t.treeContext,t.componentStack,!0)),e.pingedTasks.push(t)}}i.splice(n,1);break e}}}else Sn(e,t,l,r,c,d);return;case a:throw Error(o(257));case _:if(n=(f=n._init)(n._payload),12===e.status)throw null;return void An(e,t,n,i)}if(A(n))return void kn(e,t,n,i);if(null===n||"object"!=typeof n?f=null:f="function"==typeof(f=x&&n[x]||n["@@iterator"])?f:null,f&&(f=f.call(n))){if(!(n=f.next()).done){c=[];do{c.push(n.value),n=f.next()}while(!n.done);kn(e,t,c,i)}return}if("function"==typeof n.then)return t.thenableState=null,An(e,t,Jt(n),i);if(n.$$typeof===h)return An(e,t,n._currentValue2,i);throw i=Object.prototype.toString.call(n),Error(o(31,"[object Object]"===i?"object with keys {"+Object.keys(n).join(", ")+"}":i))}"string"==typeof n?null!==(i=t.blockedSegment)&&(i.lastPushedText=Qe(i.chunks,n,e.renderState,i.lastPushedText)):"number"!=typeof n&&"bigint"!=typeof n||null!==(i=t.blockedSegment)&&(i.lastPushedText=Qe(i.chunks,""+n,e.renderState,i.lastPushedText))}}function kn(e,t,n,i){var r=t.keyPath;if(-1===i||(t.keyPath=[t.keyPath,"Fragment",i],null===t.replay)){if(s=t.treeContext,a=n.length,null!==t.replay&&(null!==(l=t.replay.slots)&&"object"==typeof l)){for(i=0;i<a;i++)c=n[i],t.treeContext=ht(s,a,i),"number"==typeof(d=l[i])?(xn(e,t,d,c,i),delete l[i]):Pn(e,t,c,i);return t.treeContext=s,void(t.keyPath=r)}for(l=0;l<a;l++)i=n[l],t.treeContext=ht(s,a,l),Pn(e,t,i,l);t.treeContext=s,t.keyPath=r}else{for(var s=t.replay,a=s.nodes,l=0;l<a.length;l++){var c=a[l];if(c[1]===i){i=c[2],c=c[3],t.replay={nodes:i,slots:c,pendingTasks:1};try{if(kn(e,t,n,-1),1===t.replay.pendingTasks&&0<t.replay.nodes.length)throw Error(o(488));t.replay.pendingTasks--}catch(r){if("object"==typeof r&&null!==r&&(r===ft||"function"==typeof r.then))throw r;t.replay.pendingTasks--,n=_n(t.componentStack);var d=t.blockedBoundary;Dn(e,d,i,c,r,n=yn(e,r,n))}t.replay=s,a.splice(l,1);break}}t.keyPath=r}}function Rn(e,t){null!==(e=e.trackedPostpones)&&(null!==(t=t.trackedContentKeyPath)&&(void 0!==(t=e.workingMap.get(t))&&(t.length=4,t[2]=[],t[3]=null)))}function In(e,t,n){return gn(e,n,t.replay,t.node,t.childIndex,t.blockedBoundary,t.hoistableState,t.abortSet,t.keyPath,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)}function Tn(e,t,n){var i=t.blockedSegment,r=vn(0,i.chunks.length,null,t.formatContext,i.lastPushedText,!0);return i.children.push(r),i.lastPushedText=!1,pn(e,n,t.node,t.childIndex,t.blockedBoundary,r,t.blockedPreamble,t.hoistableState,t.abortSet,t.keyPath,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)}function Pn(e,t,n,i){var r=t.formatContext,o=t.context,s=t.keyPath,a=t.treeContext,l=t.componentStack,c=t.blockedSegment;if(null===c)try{return An(e,t,n,i)}catch(c){if(jt(),"object"==typeof(n=c===ft?bt():c)&&null!==n){if("function"==typeof n.then)return e=In(e,t,i=Vt()).ping,n.then(e,e),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void dt(o);if("Maximum call stack size exceeded"===n.message)return n=In(e,t,n=Vt()),e.pingedTasks.push(n),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void dt(o)}}else{var d=c.children.length,u=c.chunks.length;try{return An(e,t,n,i)}catch(m){if(jt(),c.children.length=d,c.chunks.length=u,"object"==typeof(n=m===ft?bt():m)&&null!==n){if("function"==typeof n.then)return e=Tn(e,t,i=Vt()).ping,n.then(e,e),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void dt(o);if("Maximum call stack size exceeded"===n.message)return n=Tn(e,t,n=Vt()),e.pingedTasks.push(n),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void dt(o)}}}throw t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,dt(o),n}function Nn(e){var t=e.blockedBoundary;null!==(e=e.blockedSegment)&&(e.status=3,Bn(this,t,e))}function Dn(e,t,n,i,r,s){for(var a=0;a<n.length;a++){var l=n[a];if(4===l.length)Dn(e,t,l[2],l[3],r,s);else{l=l[5];var c=e,d=s,u=hn(0,new Set,null,null);u.parentFlushed=!0,u.rootSegmentID=l,u.status=4,u.errorDigest=d,u.parentFlushed&&c.clientRenderedBoundaries.push(u)}}if(n.length=0,null!==i){if(null===t)throw Error(o(487));if(4!==t.status&&(t.status=4,t.errorDigest=s,t.parentFlushed&&e.clientRenderedBoundaries.push(t)),"object"==typeof i)for(var m in i)delete i[m]}}function Mn(e,t,n){var i=e.blockedBoundary,r=e.blockedSegment;if(null!==r){if(6===r.status)return;r.status=3}if(r=_n(e.componentStack),null===i){if(13!==t.status&&14!==t.status){if(null===(i=e.replay))return yn(t,n,r),void bn(t,n);i.pendingTasks--,0===i.pendingTasks&&0<i.nodes.length&&(e=yn(t,n,r),Dn(t,null,i.nodes,i.slots,n,e)),t.pendingRootTasks--,0===t.pendingRootTasks&&Fn(t)}}else i.pendingTasks--,4!==i.status&&(i.status=4,e=yn(t,n,r),i.status=4,i.errorDigest=e,Rn(t,i),i.parentFlushed&&t.clientRenderedBoundaries.push(i)),i.fallbackAbortableTasks.forEach(function(e){return Mn(e,t,n)}),i.fallbackAbortableTasks.clear();t.allPendingTasks--,0===t.allPendingTasks&&Ln(t)}function On(e,t){try{var n=e.renderState,i=n.onHeaders;if(i){var r=n.headers;if(r){n.headers=null;var o=r.preconnects;if(r.fontPreloads&&(o&&(o+=", "),o+=r.fontPreloads),r.highImagePreloads&&(o&&(o+=", "),o+=r.highImagePreloads),!t){var s=n.styles.values(),a=s.next();e:for(;0<r.remainingCapacity&&!a.done;a=s.next())for(var l=a.value.sheets.values(),c=l.next();0<r.remainingCapacity&&!c.done;c=l.next()){var d=c.value,u=d.props,m=u.href,h=d.props,p=Ge(h.href,"style",{crossOrigin:h.crossOrigin,integrity:h.integrity,nonce:h.nonce,type:h.type,fetchPriority:h.fetchPriority,referrerPolicy:h.referrerPolicy,media:h.media});if(!(0<=(r.remainingCapacity-=p.length+2)))break e;n.resets.style[m]=G,o&&(o+=", "),o+=p,n.resets.style[m]="string"==typeof u.crossOrigin||"string"==typeof u.integrity?[u.crossOrigin,u.integrity]:G}}i(o?{Link:o}:{})}}}catch(t){yn(e,t,{})}}function Fn(e){null===e.trackedPostpones&&On(e,!0),null===e.trackedPostpones&&Hn(e),e.onShellError=cn,(e=e.onShellReady)()}function Ln(e){On(e,null===e.trackedPostpones||(null===e.completedRootSegment||5!==e.completedRootSegment.status)),Hn(e),(e=e.onAllReady)()}function Un(e,t){if(0===t.chunks.length&&1===t.children.length&&null===t.children[0].boundary&&-1===t.children[0].id){var n=t.children[0];n.id=t.id,n.parentFlushed=!0,1===n.status&&Un(e,n)}else e.completedSegments.push(t)}function Bn(e,t,n){if(null===t){if(null!==n&&n.parentFlushed){if(null!==e.completedRootSegment)throw Error(o(389));e.completedRootSegment=n}e.pendingRootTasks--,0===e.pendingRootTasks&&Fn(e)}else t.pendingTasks--,4!==t.status&&(0===t.pendingTasks?(0===t.status&&(t.status=1),null!==n&&n.parentFlushed&&1===n.status&&Un(t,n),t.parentFlushed&&e.completedBoundaries.push(t),1===t.status&&(t.fallbackAbortableTasks.forEach(Nn,e),t.fallbackAbortableTasks.clear(),0===e.pendingRootTasks&&null===e.trackedPostpones&&null!==t.contentPreamble&&Hn(e))):null!==n&&n.parentFlushed&&1===n.status&&(Un(t,n),1===t.completedSegments.length&&t.parentFlushed&&e.partialBoundaries.push(t)));e.allPendingTasks--,0===e.allPendingTasks&&Ln(e)}function Vn(e){if(14!==e.status&&13!==e.status){var t=rt,n=j.H;j.H=en;var i=j.A;j.A=nn;var r=un;un=e;var s=tn;tn=e.resumableState;try{var a,l=e.pingedTasks;for(a=0;a<l.length;a++){var c=l[a],d=e,u=c.blockedSegment;if(null===u){var m=d;if(0!==c.replay.pendingTasks){dt(c.context);try{if("number"==typeof c.replay.slots?xn(m,c,c.replay.slots,c.node,c.childIndex):Cn(m,c),1===c.replay.pendingTasks&&0<c.replay.nodes.length)throw Error(o(488));c.replay.pendingTasks--,c.abortSet.delete(c),Bn(m,c.blockedBoundary,null)}catch(e){jt();var h=e===ft?bt():e;if("object"==typeof h&&null!==h&&"function"==typeof h.then){var p=c.ping;h.then(p,p),c.thenableState=Vt()}else{c.replay.pendingTasks--,c.abortSet.delete(c);var g=_n(c.componentStack);d=void 0;var v=m,f=c.blockedBoundary,_=12===m.status?m.fatalError:h;Dn(v,f,c.replay.nodes,c.replay.slots,_,d=yn(v,_,g)),m.pendingRootTasks--,0===m.pendingRootTasks&&Fn(m),m.allPendingTasks--,0===m.allPendingTasks&&Ln(m)}}}}else if(m=void 0,0===(v=u).status){v.status=6,dt(c.context);var y=v.children.length,b=v.chunks.length;try{Cn(d,c),Ze(v.chunks,d.renderState,v.lastPushedText,v.textEmbedded),c.abortSet.delete(c),v.status=1,Bn(d,c.blockedBoundary,v)}catch(e){jt(),v.children.length=y,v.chunks.length=b;var E=e===ft?bt():12===d.status?d.fatalError:e;if("object"==typeof E&&null!==E&&"function"==typeof E.then){v.status=0,c.thenableState=Vt();var w=c.ping;E.then(w,w)}else{var S=_n(c.componentStack);c.abortSet.delete(c),v.status=4;var x=c.blockedBoundary;m=yn(d,E,S),null===x?bn(d,E):(x.pendingTasks--,4!==x.status&&(x.status=4,x.errorDigest=m,Rn(d,x),x.parentFlushed&&d.clientRenderedBoundaries.push(x),0===d.pendingRootTasks&&null===d.trackedPostpones&&null!==x.contentPreamble&&Hn(d))),d.allPendingTasks--,0===d.allPendingTasks&&Ln(d)}}}}l.splice(0,a),null!==e.destination&&Jn(e,e.destination)}catch(t){yn(e,t,{}),bn(e,t)}finally{tn=s,j.H=n,j.A=i,n===en&&dt(t),un=r}}}function jn(e,t,n){t.preambleChildren.length&&n.push(t.preambleChildren);for(var i=!1,r=0;r<t.children.length;r++)i=zn(e,t.children[r],n)||i;return i}function zn(e,t,n){var i=t.boundary;if(null===i)return jn(e,t,n);var r=i.contentPreamble,s=i.fallbackPreamble;if(null===r||null===s)return!1;switch(i.status){case 1:if(Se(e.renderState,r),!(t=i.completedSegments[0]))throw Error(o(391));return jn(e,t,n);case 5:if(null!==e.trackedPostpones)return!0;case 4:if(1===t.status)return Se(e.renderState,s),jn(e,t,n);default:return!0}}function Hn(e){if(e.completedRootSegment&&null===e.completedPreambleSegments){var t=[],n=zn(e,e.completedRootSegment,t),i=e.renderState.preamble;(!1===n||i.headChunks&&i.bodyChunks)&&(e.completedPreambleSegments=t)}}function Wn(e,t,n,i){switch(n.parentFlushed=!0,n.status){case 0:n.id=e.nextSegmentId++;case 5:return i=n.id,n.lastPushedText=!1,n.textEmbedded=!1,e=e.renderState,t.push('<template id="'),t.push(e.placeholderPrefix),e=i.toString(16),t.push(e),t.push('"></template>');case 1:n.status=2;var r=!0,s=n.chunks,a=0;n=n.children;for(var l=0;l<n.length;l++){for(r=n[l];a<r.index;a++)t.push(s[a]);r=Gn(e,t,r,i)}for(;a<s.length-1;a++)t.push(s[a]);return a<s.length&&(r=t.push(s[a])),r;default:throw Error(o(390))}}function Gn(e,t,n,i){var r=n.boundary;if(null===r)return Wn(e,t,n,i);if(r.parentFlushed=!0,4===r.status){if(!e.renderState.generateStaticMarkup){var s=r.errorDigest;t.push("\x3c!--$!--\x3e"),t.push("<template"),s&&(t.push(' data-dgst="'),s=F(s),t.push(s),t.push('"')),t.push("></template>")}return Wn(e,t,n,i),e.renderState.generateStaticMarkup?t=!0:((e=r.fallbackPreamble)&&Ce(t,e),t=t.push("\x3c!--/$--\x3e")),t}if(1!==r.status)return 0===r.status&&(r.rootSegmentID=e.nextSegmentId++),0<r.completedSegments.length&&e.partialBoundaries.push(r),Ae(t,e.renderState,r.rootSegmentID),i&&((r=r.fallbackState).styles.forEach(Ye,i),r.stylesheets.forEach(Xe,i)),Wn(e,t,n,i),t.push("\x3c!--/$--\x3e");if(r.byteSize>e.progressiveChunkSize)return r.rootSegmentID=e.nextSegmentId++,e.completedBoundaries.push(r),Ae(t,e.renderState,r.rootSegmentID),Wn(e,t,n,i),t.push("\x3c!--/$--\x3e");if(i&&((n=r.contentState).styles.forEach(Ye,i),n.stylesheets.forEach(Xe,i)),e.renderState.generateStaticMarkup||t.push("\x3c!--$--\x3e"),1!==(n=r.completedSegments).length)throw Error(o(391));return Gn(e,t,n[0],i),e.renderState.generateStaticMarkup?t=!0:((e=r.contentPreamble)&&Ce(t,e),t=t.push("\x3c!--/$--\x3e")),t}function Kn(e,t,n,i){return function(e,t,n,i){switch(n.insertionMode){case 0:case 1:case 3:case 2:return e.push('<div hidden id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 4:return e.push('<svg aria-hidden="true" style="display:none" id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 5:return e.push('<math aria-hidden="true" style="display:none" id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 6:return e.push('<table hidden id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 7:return e.push('<table hidden><tbody id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 8:return e.push('<table hidden><tr id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');case 9:return e.push('<table hidden><colgroup id="'),e.push(t.segmentPrefix),t=i.toString(16),e.push(t),e.push('">');default:throw Error(o(397))}}(t,e.renderState,n.parentFormatContext,n.id),Gn(e,t,n,i),function(e,t){switch(t.insertionMode){case 0:case 1:case 3:case 2:return e.push("</div>");case 4:return e.push("</svg>");case 5:return e.push("</math>");case 6:return e.push("</table>");case 7:return e.push("</tbody></table>");case 8:return e.push("</tr></table>");case 9:return e.push("</colgroup></table>");default:throw Error(o(397))}}(t,n.parentFormatContext)}function qn(e,t,n){for(var i=n.completedSegments,r=0;r<i.length;r++)$n(e,t,n,i[r]);i.length=0,Oe(t,n.contentState,e.renderState),i=e.resumableState,e=e.renderState,r=n.rootSegmentID,n=n.contentState;var s=e.stylesToHoist;return e.stylesToHoist=!1,t.push(e.startInlineScript),s?2&i.instructions?8&i.instructions?t.push('$RR("'):(i.instructions|=8,t.push('$RM=new Map;\n$RR=function(t,u,y){function v(n){this._p=null;n()}for(var w=$RC,p=$RM,q=new Map,r=document,g,b,h=r.querySelectorAll("link[data-precedence],style[data-precedence]"),x=[],k=0;b=h[k++];)"not all"===b.getAttribute("media")?x.push(b):("LINK"===b.tagName&&p.set(b.getAttribute("href"),b),q.set(b.dataset.precedence,g=b));b=0;h=[];var l,a;for(k=!0;;){if(k){var e=y[b++];if(!e){k=!1;b=0;continue}var c=!1,m=0;var d=e[m++];if(a=p.get(d)){var f=a._p;c=!0}else{a=r.createElement("link");a.href=\nd;a.rel="stylesheet";for(a.dataset.precedence=l=e[m++];f=e[m++];)a.setAttribute(f,e[m++]);f=a._p=new Promise(function(n,z){a.onload=v.bind(a,n);a.onerror=v.bind(a,z)});p.set(d,a)}d=a.getAttribute("media");!f||d&&!matchMedia(d).matches||h.push(f);if(c)continue}else{a=x[b++];if(!a)break;l=a.getAttribute("data-precedence");a.removeAttribute("media")}c=q.get(l)||g;c===g&&(g=a);q.set(l,a);c?c.parentNode.insertBefore(a,c.nextSibling):(c=r.head,c.insertBefore(a,c.firstChild))}Promise.all(h).then(w.bind(null,\nt,u,""),w.bind(null,t,u,"Resource failed to load"))};$RR("')):(i.instructions|=10,t.push('$RC=function(b,c,e){c=document.getElementById(c);c.parentNode.removeChild(c);var a=document.getElementById(b);if(a){b=a.previousSibling;if(e)b.data="$!",a.setAttribute("data-dgst",e);else{e=b.parentNode;a=b.nextSibling;var f=0;do{if(a&&8===a.nodeType){var d=a.data;if("/$"===d)if(0===f)break;else f--;else"$"!==d&&"$?"!==d&&"$!"!==d||f++}d=a.nextSibling;e.removeChild(a);a=d}while(a);for(;c.firstChild;)e.insertBefore(c.firstChild,a);b.data="$"}b._reactRetry&&b._reactRetry()}};$RM=new Map;\n$RR=function(t,u,y){function v(n){this._p=null;n()}for(var w=$RC,p=$RM,q=new Map,r=document,g,b,h=r.querySelectorAll("link[data-precedence],style[data-precedence]"),x=[],k=0;b=h[k++];)"not all"===b.getAttribute("media")?x.push(b):("LINK"===b.tagName&&p.set(b.getAttribute("href"),b),q.set(b.dataset.precedence,g=b));b=0;h=[];var l,a;for(k=!0;;){if(k){var e=y[b++];if(!e){k=!1;b=0;continue}var c=!1,m=0;var d=e[m++];if(a=p.get(d)){var f=a._p;c=!0}else{a=r.createElement("link");a.href=\nd;a.rel="stylesheet";for(a.dataset.precedence=l=e[m++];f=e[m++];)a.setAttribute(f,e[m++]);f=a._p=new Promise(function(n,z){a.onload=v.bind(a,n);a.onerror=v.bind(a,z)});p.set(d,a)}d=a.getAttribute("media");!f||d&&!matchMedia(d).matches||h.push(f);if(c)continue}else{a=x[b++];if(!a)break;l=a.getAttribute("data-precedence");a.removeAttribute("media")}c=q.get(l)||g;c===g&&(g=a);q.set(l,a);c?c.parentNode.insertBefore(a,c.nextSibling):(c=r.head,c.insertBefore(a,c.firstChild))}Promise.all(h).then(w.bind(null,\nt,u,""),w.bind(null,t,u,"Resource failed to load"))};$RR("')):2&i.instructions?t.push('$RC("'):(i.instructions|=2,t.push('$RC=function(b,c,e){c=document.getElementById(c);c.parentNode.removeChild(c);var a=document.getElementById(b);if(a){b=a.previousSibling;if(e)b.data="$!",a.setAttribute("data-dgst",e);else{e=b.parentNode;a=b.nextSibling;var f=0;do{if(a&&8===a.nodeType){var d=a.data;if("/$"===d)if(0===f)break;else f--;else"$"!==d&&"$?"!==d&&"$!"!==d||f++}d=a.nextSibling;e.removeChild(a);a=d}while(a);for(;c.firstChild;)e.insertBefore(c.firstChild,a);b.data="$"}b._reactRetry&&b._reactRetry()}};$RC("')),i=r.toString(16),t.push(e.boundaryPrefix),t.push(i),t.push('","'),t.push(e.segmentPrefix),t.push(i),s?(t.push('",'),function(e,t){e.push("[");var n="[";t.stylesheets.forEach(function(t){if(2!==t.state)if(3===t.state)e.push(n),t=Te(""+t.props.href),e.push(t),e.push("]"),n=",[";else{e.push(n);var i=t.props["data-precedence"],r=t.props,s=V(""+t.props.href);for(var a in s=Te(s),e.push(s),i=""+i,e.push(","),i=Te(i),e.push(i),r)if(R.call(r,a)&&null!=(i=r[a]))switch(a){case"href":case"rel":case"precedence":case"data-precedence":break;case"children":case"dangerouslySetInnerHTML":throw Error(o(399,"link"));default:ze(e,a,i)}e.push("]"),n=",[",t.state=3}}),e.push("]")}(t,n)):t.push('"'),n=t.push(")<\/script>"),xe(t,e)&&n}function $n(e,t,n,i){if(2===i.status)return!0;var r=n.contentState,s=i.id;if(-1===s){if(-1===(i.id=n.rootSegmentID))throw Error(o(392));return Kn(e,t,i,r)}return s===n.rootSegmentID?Kn(e,t,i,r):(Kn(e,t,i,r),n=e.resumableState,e=e.renderState,t.push(e.startInlineScript),1&n.instructions?t.push('$RS("'):(n.instructions|=1,t.push('$RS=function(a,b){a=document.getElementById(a);b=document.getElementById(b);for(a.parentNode.removeChild(a);a.firstChild;)b.parentNode.insertBefore(a.firstChild,b);b.parentNode.removeChild(b)};$RS("')),t.push(e.segmentPrefix),s=s.toString(16),t.push(s),t.push('","'),t.push(e.placeholderPrefix),t.push(s),t=t.push('")<\/script>'))}function Jn(e,t){try{if(!(0<e.pendingRootTasks)){var n,i=e.completedRootSegment;if(null!==i){if(5===i.status)return;var r=e.completedPreambleSegments;if(null===r)return;var o,s=e.renderState,a=s.preamble,l=a.htmlChunks,c=a.headChunks;if(l){for(o=0;o<l.length;o++)t.push(l[o]);if(c)for(o=0;o<c.length;o++)t.push(c[o]);else{var d=ye("head");t.push(d),t.push(">")}}else if(c)for(o=0;o<c.length;o++)t.push(c[o]);var u=s.charsetChunks;for(o=0;o<u.length;o++)t.push(u[o]);u.length=0,s.preconnects.forEach(Fe,t),s.preconnects.clear();var m=s.viewportChunks;for(o=0;o<m.length;o++)t.push(m[o]);m.length=0,s.fontPreloads.forEach(Fe,t),s.fontPreloads.clear(),s.highImagePreloads.forEach(Fe,t),s.highImagePreloads.clear(),s.styles.forEach(Be,t);var h=s.importMapChunks;for(o=0;o<h.length;o++)t.push(h[o]);h.length=0,s.bootstrapScripts.forEach(Fe,t),s.scripts.forEach(Fe,t),s.scripts.clear(),s.bulkPreloads.forEach(Fe,t),s.bulkPreloads.clear();var p=s.hoistableChunks;for(o=0;o<p.length;o++)t.push(p[o]);for(s=p.length=0;s<r.length;s++){var g=r[s];for(a=0;a<g.length;a++)Gn(e,t,g[a],null)}var v=e.renderState.preamble,f=v.headChunks;if(v.htmlChunks||f){var _=we("head");t.push(_)}var y=v.bodyChunks;if(y)for(r=0;r<y.length;r++)t.push(y[r]);Gn(e,t,i,null),e.completedRootSegment=null,xe(t,e.renderState)}var b=e.renderState;i=0;var E=b.viewportChunks;for(i=0;i<E.length;i++)t.push(E[i]);E.length=0,b.preconnects.forEach(Fe,t),b.preconnects.clear(),b.fontPreloads.forEach(Fe,t),b.fontPreloads.clear(),b.highImagePreloads.forEach(Fe,t),b.highImagePreloads.clear(),b.styles.forEach(je,t),b.scripts.forEach(Fe,t),b.scripts.clear(),b.bulkPreloads.forEach(Fe,t),b.bulkPreloads.clear();var w=b.hoistableChunks;for(i=0;i<w.length;i++)t.push(w[i]);w.length=0;var S=e.clientRenderedBoundaries;for(n=0;n<S.length;n++){var x=S[n];b=t;var A=e.resumableState,C=e.renderState,k=x.rootSegmentID,R=x.errorDigest;b.push(C.startInlineScript),4&A.instructions?b.push('$RX("'):(A.instructions|=4,b.push('$RX=function(b,c,d,e,f){var a=document.getElementById(b);a&&(b=a.previousSibling,b.data="$!",a=a.dataset,c&&(a.dgst=c),d&&(a.msg=d),e&&(a.stck=e),f&&(a.cstck=f),b._reactRetry&&b._reactRetry())};;$RX("')),b.push(C.boundaryPrefix);var I=k.toString(16);if(b.push(I),b.push('"'),R){b.push(",");var T=Re(R||"");b.push(T)}var P=b.push(")<\/script>");if(!P)return e.destination=null,n++,void S.splice(0,n)}S.splice(0,n);var N=e.completedBoundaries;for(n=0;n<N.length;n++)if(!qn(e,t,N[n]))return e.destination=null,n++,void N.splice(0,n);N.splice(0,n);var D=e.partialBoundaries;for(n=0;n<D.length;n++){var M=D[n];e:{S=e,x=t;var O=M.completedSegments;for(P=0;P<O.length;P++)if(!$n(S,x,M,O[P])){P++,O.splice(0,P);var F=!1;break e}O.splice(0,P),F=Oe(x,M.contentState,S.renderState)}if(!F)return e.destination=null,n++,void D.splice(0,n)}D.splice(0,n);var L=e.completedBoundaries;for(n=0;n<L.length;n++)if(!qn(e,t,L[n]))return e.destination=null,n++,void L.splice(0,n);L.splice(0,n)}}finally{0===e.allPendingTasks&&0===e.pingedTasks.length&&0===e.clientRenderedBoundaries.length&&0===e.completedBoundaries.length&&(e.flushScheduled=!1,(n=e.resumableState).hasBody&&(D=we("body"),t.push(D)),n.hasHtml&&(n=we("html"),t.push(n)),e.status=14,t.push(null),e.destination=null)}}function Yn(e){if(!1===e.flushScheduled&&0===e.pingedTasks.length&&null!==e.destination){e.flushScheduled=!0;var t=e.destination;t?Jn(e,t):e.flushScheduled=!1}}function Xn(e,t){if(13===e.status)e.status=14,t.destroy(e.fatalError);else if(14!==e.status&&null===e.destination){e.destination=t;try{Jn(e,t)}catch(t){yn(e,t,{}),bn(e,t)}}}function Qn(e,t){11!==e.status&&10!==e.status||(e.status=12);try{var n=e.abortableTasks;if(0<n.size){var i=void 0===t?Error(o(432)):"object"==typeof t&&null!==t&&"function"==typeof t.then?Error(o(530)):t;e.fatalError=i,n.forEach(function(t){return Mn(t,e,i)}),n.clear()}null!==e.destination&&Jn(e,e.destination)}catch(t){yn(e,t,{}),bn(e,t)}}function Zn(){}function ei(e,t,n,i){var r,s,a,l,c=!1,d=null,u="",m=!1;if(e=function(e,t,n,i,r,o,s,a,l,c,d,u){return(n=vn(t=new dn(t,n,i,r,o,s,a,l,c,d,u),0,null,i,!1,!1)).parentFlushed=!0,fn(e=pn(t,null,e,-1,null,n,null,null,t.abortableTasks,null,i,null,mt,null,!1)),t.pingedTasks.push(e),t}(e,t={idPrefix:void 0===(r=t?t.identifierPrefix:void 0)?"":r,nextFormID:0,streamingFormat:0,bootstrapScriptContent:s,bootstrapScripts:a,bootstrapModules:l,instructions:0,hasBody:!1,hasHtml:!1,unknownResources:{},dnsResources:{},connectResources:{default:{},anonymous:{},credentials:{}},imageResources:{},styleResources:{},scriptResources:{},moduleUnknownResources:{},moduleScriptResources:{}},function(e,t){var n=e.idPrefix,i=[],r=e.bootstrapScriptContent,o=e.bootstrapScripts,s=e.bootstrapModules;void 0!==r&&i.push("<script>",(""+r).replace(K,q),"<\/script>"),r=n+"P:";var a=n+"S:";n+="B:";var l={htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0},c=new Set,d=new Set,u=new Set,m=new Map,h=new Set,p=new Set,g=new Set,v={images:new Map,stylesheets:new Map,scripts:new Map,moduleScripts:new Map};if(void 0!==o)for(var f=0;f<o.length;f++){var _,y=o[f],b=void 0,E=void 0,w={rel:"preload",as:"script",fetchPriority:"low",nonce:void 0};"string"==typeof y?w.href=_=y:(w.href=_=y.src,w.integrity=E="string"==typeof y.integrity?y.integrity:void 0,w.crossOrigin=b="string"==typeof y||null==y.crossOrigin?void 0:"use-credentials"===y.crossOrigin?"use-credentials":"");var S=_;(y=e).scriptResources[S]=null,y.moduleScriptResources[S]=null,ce(y=[],w),h.add(y),i.push('<script src="',F(_)),"string"==typeof E&&i.push('" integrity="',F(E)),"string"==typeof b&&i.push('" crossorigin="',F(b)),i.push('" async=""><\/script>')}if(void 0!==s)for(o=0;o<s.length;o++)b=_=void 0,E={rel:"modulepreload",fetchPriority:"low",nonce:void 0},"string"==typeof(w=s[o])?E.href=f=w:(E.href=f=w.src,E.integrity=b="string"==typeof w.integrity?w.integrity:void 0,E.crossOrigin=_="string"==typeof w||null==w.crossOrigin?void 0:"use-credentials"===w.crossOrigin?"use-credentials":""),y=f,(w=e).scriptResources[y]=null,w.moduleScriptResources[y]=null,ce(w=[],E),h.add(w),i.push('<script type="module" src="',F(f)),"string"==typeof b&&i.push('" integrity="',F(b)),"string"==typeof _&&i.push('" crossorigin="',F(_)),i.push('" async=""><\/script>');return{placeholderPrefix:r,segmentPrefix:a,boundaryPrefix:n,startInlineScript:"<script>",preamble:l,externalRuntimeScript:null,bootstrapChunks:i,importMapChunks:[],onHeaders:void 0,headers:null,resets:{font:{},dns:{},connect:{default:{},anonymous:{},credentials:{}},image:{},style:{}},charsetChunks:[],viewportChunks:[],hoistableChunks:[],preconnects:c,fontPreloads:d,highImagePreloads:u,styles:m,bootstrapScripts:h,scripts:p,bulkPreloads:g,preloads:v,stylesToHoist:!1,generateStaticMarkup:t}}(t,n),J(0,null,0),1/0,Zn,void 0,function(){m=!0},void 0,void 0,void 0),e.flushScheduled=null!==e.destination,Vn(e),10===e.status&&(e.status=11),null===e.trackedPostpones&&On(e,0===e.pendingRootTasks),Qn(e,i),Xn(e,{push:function(e){return null!==e&&(u+=e),!0},destroy:function(e){c=!0,d=e}}),c&&d!==i)throw d;if(!m)throw Error(o(426));return u}t.renderToStaticMarkup=function(e,t){return ei(e,t,!0,'The server used "renderToStaticMarkup" which does not support Suspense. If you intended to have the server wait for the suspended component please switch to "renderToReadableStream" which supports Suspense on the server')},t.renderToString=function(e,t){return ei(e,t,!1,'The server used "renderToString" which does not support Suspense. If you intended for this Suspense boundary to render the fallback content on the server consider throwing an Error somewhere within the Suspense boundary. If you intended to have the server wait for the suspended component please switch to "renderToReadableStream" which supports Suspense on the server')},t.version="19.1.1"},"./node_modules/react-dom/cjs/react-dom-server.browser.production.js":(e,t,n)=>{"use strict";var i=n("./node_modules/react/index.js"),r=n("./node_modules/react-dom/index.js");function o(e){var t="https://react.dev/errors/"+e;if(1<arguments.length){t+="?args[]="+encodeURIComponent(arguments[1]);for(var n=2;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n])}return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=Symbol.for("react.transitional.element"),a=Symbol.for("react.portal"),l=Symbol.for("react.fragment"),c=Symbol.for("react.strict_mode"),d=Symbol.for("react.profiler"),u=Symbol.for("react.provider"),m=Symbol.for("react.consumer"),h=Symbol.for("react.context"),p=Symbol.for("react.forward_ref"),g=Symbol.for("react.suspense"),v=Symbol.for("react.suspense_list"),f=Symbol.for("react.memo"),_=Symbol.for("react.lazy"),y=Symbol.for("react.scope"),b=Symbol.for("react.activity"),E=Symbol.for("react.legacy_hidden"),w=Symbol.for("react.memo_cache_sentinel"),S=Symbol.for("react.view_transition"),x=Symbol.iterator,A=Array.isArray;function C(e,t){var n=3&e.length,i=e.length-n,r=t;for(t=0;t<i;){var o=255&e.charCodeAt(t)|(255&e.charCodeAt(++t))<<8|(255&e.charCodeAt(++t))<<16|(255&e.charCodeAt(++t))<<24;++t,r=27492+(65535&(r=5*(65535&(r=(r^=o=461845907*(65535&(o=(o=3432918353*(65535&o)+((3432918353*(o>>>16)&65535)<<16)&4294967295)<<15|o>>>17))+((461845907*(o>>>16)&65535)<<16)&4294967295)<<13|r>>>19))+((5*(r>>>16)&65535)<<16)&4294967295))+(((r>>>16)+58964&65535)<<16)}switch(o=0,n){case 3:o^=(255&e.charCodeAt(t+2))<<16;case 2:o^=(255&e.charCodeAt(t+1))<<8;case 1:r^=461845907*(65535&(o=(o=3432918353*(65535&(o^=255&e.charCodeAt(t)))+((3432918353*(o>>>16)&65535)<<16)&4294967295)<<15|o>>>17))+((461845907*(o>>>16)&65535)<<16)&4294967295}return r^=e.length,r=2246822507*(65535&(r^=r>>>16))+((2246822507*(r>>>16)&65535)<<16)&4294967295,((r=3266489909*(65535&(r^=r>>>13))+((3266489909*(r>>>16)&65535)<<16)&4294967295)^r>>>16)>>>0}var k=new MessageChannel,R=[];function I(e){R.push(e),k.port2.postMessage(null)}function T(e){setTimeout(function(){throw e})}k.port1.onmessage=function(){var e=R.shift();e&&e()};var P=Promise,N="function"==typeof queueMicrotask?queueMicrotask:function(e){P.resolve(null).then(e).catch(T)},D=null,M=0;function O(e,t){if(0!==t.byteLength)if(2048<t.byteLength)0<M&&(e.enqueue(new Uint8Array(D.buffer,0,M)),D=new Uint8Array(2048),M=0),e.enqueue(t);else{var n=D.length-M;n<t.byteLength&&(0===n?e.enqueue(D):(D.set(t.subarray(0,n),M),e.enqueue(D),t=t.subarray(n)),D=new Uint8Array(2048),M=0),D.set(t,M),M+=t.byteLength}}function F(e,t){return O(e,t),!0}function L(e){D&&0<M&&(e.enqueue(new Uint8Array(D.buffer,0,M)),D=null,M=0)}var U=new TextEncoder;function B(e){return U.encode(e)}function V(e){return U.encode(e)}function j(e,t){"function"==typeof e.error?e.error(t):e.close()}var z=Object.assign,H=Object.prototype.hasOwnProperty,W=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),G={},K={};function q(e){return!!H.call(K,e)||!H.call(G,e)&&(W.test(e)?K[e]=!0:(G[e]=!0,!1))}var $=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" ")),J=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),Y=/["'&<>]/;function X(e){if("boolean"==typeof e||"number"==typeof e||"bigint"==typeof e)return""+e;e=""+e;var t=Y.exec(e);if(t){var n,i="",r=0;for(n=t.index;n<e.length;n++){switch(e.charCodeAt(n)){case 34:t="&quot;";break;case 38:t="&amp;";break;case 39:t="&#x27;";break;case 60:t="&lt;";break;case 62:t="&gt;";break;default:continue}r!==n&&(i+=e.slice(r,n)),r=n+1,i+=t}e=r!==n?i+e.slice(r,n):i}return e}var Q=/([A-Z])/g,Z=/^ms-/,ee=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function te(e){return ee.test(""+e)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":e}var ne=i.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,ie=r.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,re={pending:!1,data:null,method:null,action:null},oe=ie.d;ie.d={f:oe.f,r:oe.r,D:function(e){var t=hr||null;if(t){var n=t.resumableState,i=t.renderState;if("string"==typeof e&&e){var r,o;if(!n.dnsResources.hasOwnProperty(e))n.dnsResources[e]=null,(o=(n=i.headers)&&0<n.remainingCapacity)&&(r="<"+(""+e).replace(Yn,Xn)+">; rel=dns-prefetch",o=0<=(n.remainingCapacity-=r.length+2)),o?(i.resets.dns[e]=null,n.preconnects&&(n.preconnects+=", "),n.preconnects+=r):(Ze(r=[],{href:e,rel:"dns-prefetch"}),i.preconnects.add(r));Zr(t)}}else oe.D(e)},C:function(e,t){var n=hr||null;if(n){var i=n.resumableState,r=n.renderState;if("string"==typeof e&&e){var o="use-credentials"===t?"credentials":"string"==typeof t?"anonymous":"default";if(!i.connectResources[o].hasOwnProperty(e)){var s,a;if(i.connectResources[o][e]=null,a=(i=r.headers)&&0<i.remainingCapacity){if(a="<"+(""+e).replace(Yn,Xn)+">; rel=preconnect","string"==typeof t)a+='; crossorigin="'+(""+t).replace(Qn,Zn)+'"';s=a,a=0<=(i.remainingCapacity-=s.length+2)}a?(r.resets.connect[o][e]=null,i.preconnects&&(i.preconnects+=", "),i.preconnects+=s):(Ze(o=[],{rel:"preconnect",href:e,crossOrigin:t}),r.preconnects.add(o))}Zr(n)}}else oe.C(e,t)},L:function(e,t,n){var i=hr||null;if(i){var r=i.resumableState,o=i.renderState;if(t&&e){switch(t){case"image":if(n)var s=n.imageSrcSet,a=n.imageSizes,l=n.fetchPriority;var c,d=s?s+"\n"+(a||""):e;if(r.imageResources.hasOwnProperty(d))return;r.imageResources[d]=se,(r=o.headers)&&0<r.remainingCapacity&&"string"!=typeof s&&"high"===l&&(c=Jn(e,t,n),0<=(r.remainingCapacity-=c.length+2))?(o.resets.image[d]=se,r.highImagePreloads&&(r.highImagePreloads+=", "),r.highImagePreloads+=c):(Ze(r=[],z({rel:"preload",href:s?void 0:e,as:t},n)),"high"===l?o.highImagePreloads.add(r):(o.bulkPreloads.add(r),o.preloads.images.set(d,r)));break;case"style":if(r.styleResources.hasOwnProperty(e))return;Ze(s=[],z({rel:"preload",href:e,as:t},n)),r.styleResources[e]=!n||"string"!=typeof n.crossOrigin&&"string"!=typeof n.integrity?se:[n.crossOrigin,n.integrity],o.preloads.stylesheets.set(e,s),o.bulkPreloads.add(s);break;case"script":if(r.scriptResources.hasOwnProperty(e))return;s=[],o.preloads.scripts.set(e,s),o.bulkPreloads.add(s),Ze(s,z({rel:"preload",href:e,as:t},n)),r.scriptResources[e]=!n||"string"!=typeof n.crossOrigin&&"string"!=typeof n.integrity?se:[n.crossOrigin,n.integrity];break;default:if(r.unknownResources.hasOwnProperty(t)){if((s=r.unknownResources[t]).hasOwnProperty(e))return}else s={},r.unknownResources[t]=s;if(s[e]=se,(r=o.headers)&&0<r.remainingCapacity&&"font"===t&&(d=Jn(e,t,n),0<=(r.remainingCapacity-=d.length+2)))o.resets.font[e]=se,r.fontPreloads&&(r.fontPreloads+=", "),r.fontPreloads+=d;else if("font"===(Ze(r=[],e=z({rel:"preload",href:e,as:t},n)),t))o.fontPreloads.add(r);else o.bulkPreloads.add(r)}Zr(i)}}else oe.L(e,t,n)},m:function(e,t){var n=hr||null;if(n){var i=n.resumableState,r=n.renderState;if(e){var o=t&&"string"==typeof t.as?t.as:"script";if("script"===o){if(i.moduleScriptResources.hasOwnProperty(e))return;o=[],i.moduleScriptResources[e]=!t||"string"!=typeof t.crossOrigin&&"string"!=typeof t.integrity?se:[t.crossOrigin,t.integrity],r.preloads.moduleScripts.set(e,o)}else{if(i.moduleUnknownResources.hasOwnProperty(o)){var s=i.unknownResources[o];if(s.hasOwnProperty(e))return}else s={},i.moduleUnknownResources[o]=s;o=[],s[e]=se}Ze(o,z({rel:"modulepreload",href:e},t)),r.bulkPreloads.add(o),Zr(n)}}else oe.m(e,t)},X:function(e,t){var n=hr||null;if(n){var i=n.resumableState,r=n.renderState;if(e){var o=i.scriptResources.hasOwnProperty(e)?i.scriptResources[e]:void 0;null!==o&&(i.scriptResources[e]=null,t=z({src:e,async:!0},t),o&&(2===o.length&&$n(t,o),e=r.preloads.scripts.get(e))&&(e.length=0),e=[],r.scripts.add(e),rt(e,t),Zr(n))}}else oe.X(e,t)},S:function(e,t,n){var i=hr||null;if(i){var r=i.resumableState,o=i.renderState;if(e){t=t||"default";var s=o.styles.get(t),a=r.styleResources.hasOwnProperty(e)?r.styleResources[e]:void 0;null!==a&&(r.styleResources[e]=null,s||(s={precedence:B(X(t)),rules:[],hrefs:[],sheets:new Map},o.styles.set(t,s)),t={state:0,props:z({rel:"stylesheet",href:e,"data-precedence":t},n)},a&&(2===a.length&&$n(t.props,a),(o=o.preloads.stylesheets.get(e))&&0<o.length?o.length=0:t.state=1),s.sheets.set(e,t),Zr(i))}}else oe.S(e,t,n)},M:function(e,t){var n=hr||null;if(n){var i=n.resumableState,r=n.renderState;if(e){var o=i.moduleScriptResources.hasOwnProperty(e)?i.moduleScriptResources[e]:void 0;null!==o&&(i.moduleScriptResources[e]=null,t=z({src:e,type:"module",async:!0},t),o&&(2===o.length&&$n(t,o),e=r.preloads.moduleScripts.get(e))&&(e.length=0),e=[],r.scripts.add(e),rt(e,t),Zr(n))}}else oe.M(e,t)}};var se=[];V('"></template>');var ae=V("<script>"),le=V("<\/script>"),ce=V('<script src="'),de=V('<script type="module" src="'),ue=V('" nonce="'),me=V('" integrity="'),he=V('" crossorigin="'),pe=V('" async=""><\/script>'),ge=/(<\/|<)(s)(cript)/gi;function ve(e,t,n,i){return t+("s"===n?"\\u0073":"\\u0053")+i}var fe=V('<script type="importmap">'),_e=V("<\/script>");function ye(e,t,n,i,r,o){var s=void 0===t?ae:V('<script nonce="'+X(t)+'">'),a=e.idPrefix;n=[];var l=e.bootstrapScriptContent,c=e.bootstrapScripts,d=e.bootstrapModules;if(void 0!==l&&n.push(s,B((""+l).replace(ge,ve)),le),l=[],void 0!==i&&(l.push(fe),l.push(B((""+JSON.stringify(i)).replace(ge,ve))),l.push(_e)),i=r?{preconnects:"",fontPreloads:"",highImagePreloads:"",remainingCapacity:2+("number"==typeof o?o:2e3)}:null,r={placeholderPrefix:V(a+"P:"),segmentPrefix:V(a+"S:"),boundaryPrefix:V(a+"B:"),startInlineScript:s,preamble:{htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0},externalRuntimeScript:null,bootstrapChunks:n,importMapChunks:l,onHeaders:r,headers:i,resets:{font:{},dns:{},connect:{default:{},anonymous:{},credentials:{}},image:{},style:{}},charsetChunks:[],viewportChunks:[],hoistableChunks:[],preconnects:new Set,fontPreloads:new Set,highImagePreloads:new Set,styles:new Map,bootstrapScripts:new Set,scripts:new Set,bulkPreloads:new Set,preloads:{images:new Map,stylesheets:new Map,scripts:new Map,moduleScripts:new Map},nonce:t,hoistableState:null,stylesToHoist:!1},void 0!==c)for(i=0;i<c.length;i++){var u=c[i];a=s=void 0,l={rel:"preload",as:"script",fetchPriority:"low",nonce:t},"string"==typeof u?l.href=o=u:(l.href=o=u.src,l.integrity=a="string"==typeof u.integrity?u.integrity:void 0,l.crossOrigin=s="string"==typeof u||null==u.crossOrigin?void 0:"use-credentials"===u.crossOrigin?"use-credentials":"");var m=o;(u=e).scriptResources[m]=null,u.moduleScriptResources[m]=null,Ze(u=[],l),r.bootstrapScripts.add(u),n.push(ce,B(X(o))),t&&n.push(ue,B(X(t))),"string"==typeof a&&n.push(me,B(X(a))),"string"==typeof s&&n.push(he,B(X(s))),n.push(pe)}if(void 0!==d)for(c=0;c<d.length;c++)s=o=void 0,a={rel:"modulepreload",fetchPriority:"low",nonce:t},"string"==typeof(l=d[c])?a.href=i=l:(a.href=i=l.src,a.integrity=s="string"==typeof l.integrity?l.integrity:void 0,a.crossOrigin=o="string"==typeof l||null==l.crossOrigin?void 0:"use-credentials"===l.crossOrigin?"use-credentials":""),u=i,(l=e).scriptResources[u]=null,l.moduleScriptResources[u]=null,Ze(l=[],a),r.bootstrapScripts.add(l),n.push(de,B(X(i))),t&&n.push(ue,B(X(t))),"string"==typeof s&&n.push(me,B(X(s))),"string"==typeof o&&n.push(he,B(X(o))),n.push(pe);return r}function be(e,t,n,i,r){return{idPrefix:void 0===e?"":e,nextFormID:0,streamingFormat:0,bootstrapScriptContent:n,bootstrapScripts:i,bootstrapModules:r,instructions:0,hasBody:!1,hasHtml:!1,unknownResources:{},dnsResources:{},connectResources:{default:{},anonymous:{},credentials:{}},imageResources:{},styleResources:{},scriptResources:{},moduleUnknownResources:{},moduleScriptResources:{}}}function Ee(){return{htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0}}function we(e,t,n){return{insertionMode:e,selectedValue:t,tagScope:n}}function Se(e){return we("http://www.w3.org/2000/svg"===e?4:"http://www.w3.org/1998/Math/MathML"===e?5:0,null,0)}function xe(e,t,n){switch(t){case"noscript":return we(2,null,1|e.tagScope);case"select":return we(2,null!=n.value?n.value:n.defaultValue,e.tagScope);case"svg":return we(4,null,e.tagScope);case"picture":return we(2,null,2|e.tagScope);case"math":return we(5,null,e.tagScope);case"foreignObject":return we(2,null,e.tagScope);case"table":return we(6,null,e.tagScope);case"thead":case"tbody":case"tfoot":return we(7,null,e.tagScope);case"colgroup":return we(9,null,e.tagScope);case"tr":return we(8,null,e.tagScope);case"head":if(2>e.insertionMode)return we(3,null,e.tagScope);break;case"html":if(0===e.insertionMode)return we(1,null,e.tagScope)}return 6<=e.insertionMode||2>e.insertionMode?we(2,null,e.tagScope):e}var Ae=V("\x3c!-- --\x3e");function Ce(e,t,n,i){return""===t?i:(i&&e.push(Ae),e.push(B(X(t))),!0)}var ke=new Map,Re=V(' style="'),Ie=V(":"),Te=V(";");function Pe(e,t){if("object"!=typeof t)throw Error(o(62));var n,i=!0;for(n in t)if(H.call(t,n)){var r=t[n];if(null!=r&&"boolean"!=typeof r&&""!==r){if(0===n.indexOf("--")){var s=B(X(n));r=B(X((""+r).trim()))}else void 0===(s=ke.get(n))&&(s=V(X(n.replace(Q,"-$1").toLowerCase().replace(Z,"-ms-"))),ke.set(n,s)),r="number"==typeof r?0===r||$.has(n)?B(""+r):B(r+"px"):B(X((""+r).trim()));i?(i=!1,e.push(Re,s,Ie,r)):e.push(Te,s,Ie,r)}}i||e.push(Me)}var Ne=V(" "),De=V('="'),Me=V('"'),Oe=V('=""');function Fe(e,t,n){n&&"function"!=typeof n&&"symbol"!=typeof n&&e.push(Ne,B(t),Oe)}function Le(e,t,n){"function"!=typeof n&&"symbol"!=typeof n&&"boolean"!=typeof n&&e.push(Ne,B(t),De,B(X(n)),Me)}var Ue=V(X("javascript:throw new Error('React form unexpectedly submitted.')")),Be=V('<input type="hidden"');function Ve(e,t){this.push(Be),je(e),Le(this,"name",t),Le(this,"value",e),this.push(Ke)}function je(e){if("string"!=typeof e)throw Error(o(480))}function ze(e,t){if("function"==typeof t.$$FORM_ACTION){var n=e.nextFormID++;e=e.idPrefix+n;try{var i=t.$$FORM_ACTION(e);if(i){var r=i.data;null!=r&&r.forEach(je)}return i}catch(e){if("object"==typeof e&&null!==e&&"function"==typeof e.then)throw e}}return null}function He(e,t,n,i,r,o,s,a){var l=null;if("function"==typeof i){var c=ze(t,i);null!==c?(a=c.name,i=c.action||"",r=c.encType,o=c.method,s=c.target,l=c.data):(e.push(Ne,B("formAction"),De,Ue,Me),s=o=r=i=a=null,Ye(t,n))}return null!=a&&We(e,"name",a),null!=i&&We(e,"formAction",i),null!=r&&We(e,"formEncType",r),null!=o&&We(e,"formMethod",o),null!=s&&We(e,"formTarget",s),l}function We(e,t,n){switch(t){case"className":Le(e,"class",n);break;case"tabIndex":Le(e,"tabindex",n);break;case"dir":case"role":case"viewBox":case"width":case"height":Le(e,t,n);break;case"style":Pe(e,n);break;case"src":case"href":if(""===n)break;case"action":case"formAction":if(null==n||"function"==typeof n||"symbol"==typeof n||"boolean"==typeof n)break;n=te(""+n),e.push(Ne,B(t),De,B(X(n)),Me);break;case"defaultValue":case"defaultChecked":case"innerHTML":case"suppressContentEditableWarning":case"suppressHydrationWarning":case"ref":break;case"autoFocus":case"multiple":case"muted":Fe(e,t.toLowerCase(),n);break;case"xlinkHref":if("function"==typeof n||"symbol"==typeof n||"boolean"==typeof n)break;n=te(""+n),e.push(Ne,B("xlink:href"),De,B(X(n)),Me);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":"function"!=typeof n&&"symbol"!=typeof n&&e.push(Ne,B(t),De,B(X(n)),Me);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":n&&"function"!=typeof n&&"symbol"!=typeof n&&e.push(Ne,B(t),Oe);break;case"capture":case"download":!0===n?e.push(Ne,B(t),Oe):!1!==n&&"function"!=typeof n&&"symbol"!=typeof n&&e.push(Ne,B(t),De,B(X(n)),Me);break;case"cols":case"rows":case"size":case"span":"function"!=typeof n&&"symbol"!=typeof n&&!isNaN(n)&&1<=n&&e.push(Ne,B(t),De,B(X(n)),Me);break;case"rowSpan":case"start":"function"==typeof n||"symbol"==typeof n||isNaN(n)||e.push(Ne,B(t),De,B(X(n)),Me);break;case"xlinkActuate":Le(e,"xlink:actuate",n);break;case"xlinkArcrole":Le(e,"xlink:arcrole",n);break;case"xlinkRole":Le(e,"xlink:role",n);break;case"xlinkShow":Le(e,"xlink:show",n);break;case"xlinkTitle":Le(e,"xlink:title",n);break;case"xlinkType":Le(e,"xlink:type",n);break;case"xmlBase":Le(e,"xml:base",n);break;case"xmlLang":Le(e,"xml:lang",n);break;case"xmlSpace":Le(e,"xml:space",n);break;default:if((!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&q(t=J.get(t)||t)){switch(typeof n){case"function":case"symbol":return;case"boolean":var i=t.toLowerCase().slice(0,5);if("data-"!==i&&"aria-"!==i)return}e.push(Ne,B(t),De,B(X(n)),Me)}}}var Ge=V(">"),Ke=V("/>");function qe(e,t,n){if(null!=t){if(null!=n)throw Error(o(60));if("object"!=typeof t||!("__html"in t))throw Error(o(61));null!=(t=t.__html)&&e.push(B(""+t))}}var $e=V(' selected=""'),Je=V('addEventListener("submit",function(a){if(!a.defaultPrevented){var c=a.target,d=a.submitter,e=c.action,b=d;if(d){var f=d.getAttribute("formAction");null!=f&&(e=f,b=null)}"javascript:throw new Error(\'React form unexpectedly submitted.\')"===e&&(a.preventDefault(),b?(a=document.createElement("input"),a.name=b.name,a.value=b.value,b.parentNode.insertBefore(a,b),b=new FormData(c),a.parentNode.removeChild(a)):b=new FormData(c),a=c.ownerDocument||c,(a.$$reactFormReplay=a.$$reactFormReplay||[]).push(c,d,b))}});');function Ye(e,t){!(16&e.instructions)&&(e.instructions|=16,t.bootstrapChunks.unshift(t.startInlineScript,Je,le))}var Xe=V("\x3c!--F!--\x3e"),Qe=V("\x3c!--F--\x3e");function Ze(e,t){for(var n in e.push(dt("link")),t)if(H.call(t,n)){var i=t[n];if(null!=i)switch(n){case"children":case"dangerouslySetInnerHTML":throw Error(o(399,"link"));default:We(e,n,i)}}return e.push(Ke),null}var et=/(<\/|<)(s)(tyle)/gi;function tt(e,t,n,i){return t+("s"===n?"\\73 ":"\\53 ")+i}function nt(e,t,n){for(var i in e.push(dt(n)),t)if(H.call(t,i)){var r=t[i];if(null!=r)switch(i){case"children":case"dangerouslySetInnerHTML":throw Error(o(399,n));default:We(e,i,r)}}return e.push(Ke),null}function it(e,t){e.push(dt("title"));var n,i=null,r=null;for(n in t)if(H.call(t,n)){var o=t[n];if(null!=o)switch(n){case"children":i=o;break;case"dangerouslySetInnerHTML":r=o;break;default:We(e,n,o)}}return e.push(Ge),"function"!=typeof(t=Array.isArray(i)?2>i.length?i[0]:null:i)&&"symbol"!=typeof t&&null!=t&&e.push(B(X(""+t))),qe(e,r,i),e.push(pt("title")),null}function rt(e,t){e.push(dt("script"));var n,i=null,r=null;for(n in t)if(H.call(t,n)){var o=t[n];if(null!=o)switch(n){case"children":i=o;break;case"dangerouslySetInnerHTML":r=o;break;default:We(e,n,o)}}return e.push(Ge),qe(e,r,i),"string"==typeof i&&e.push(B((""+i).replace(ge,ve))),e.push(pt("script")),null}function ot(e,t,n){e.push(dt(n));var i,r=n=null;for(i in t)if(H.call(t,i)){var o=t[i];if(null!=o)switch(i){case"children":n=o;break;case"dangerouslySetInnerHTML":r=o;break;default:We(e,i,o)}}return e.push(Ge),qe(e,r,n),n}function st(e,t,n){e.push(dt(n));var i,r=n=null;for(i in t)if(H.call(t,i)){var o=t[i];if(null!=o)switch(i){case"children":n=o;break;case"dangerouslySetInnerHTML":r=o;break;default:We(e,i,o)}}return e.push(Ge),qe(e,r,n),"string"==typeof n?(e.push(B(X(n))),null):n}var at=V("\n"),lt=/^[a-zA-Z][a-zA-Z:_\.\-\d]*$/,ct=new Map;function dt(e){var t=ct.get(e);if(void 0===t){if(!lt.test(e))throw Error(o(65,e));t=V("<"+e),ct.set(e,t)}return t}var ut=V("<!DOCTYPE html>");function mt(e,t,n,r,s,a,l,c,d,u){switch(t){case"div":case"span":case"svg":case"path":case"g":case"p":case"li":case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":break;case"a":e.push(dt("a"));var m,h=null,p=null;for(m in n)if(H.call(n,m)){var g=n[m];if(null!=g)switch(m){case"children":h=g;break;case"dangerouslySetInnerHTML":p=g;break;case"href":""===g?Le(e,"href",""):We(e,m,g);break;default:We(e,m,g)}}if(e.push(Ge),qe(e,p,h),"string"==typeof h){e.push(B(X(h)));var v=null}else v=h;return v;case"select":e.push(dt("select"));var f,_=null,y=null;for(f in n)if(H.call(n,f)){var b=n[f];if(null!=b)switch(f){case"children":_=b;break;case"dangerouslySetInnerHTML":y=b;break;case"defaultValue":case"value":break;default:We(e,f,b)}}return e.push(Ge),qe(e,y,_),_;case"option":var E=c.selectedValue;e.push(dt("option"));var w,S=null,x=null,C=null,k=null;for(w in n)if(H.call(n,w)){var R=n[w];if(null!=R)switch(w){case"children":S=R;break;case"selected":C=R;break;case"dangerouslySetInnerHTML":k=R;break;case"value":x=R;default:We(e,w,R)}}if(null!=E){var I=null!==x?""+x:function(e){var t="";return i.Children.forEach(e,function(e){null!=e&&(t+=e)}),t}(S);if(A(E)){for(var T=0;T<E.length;T++)if(""+E[T]===I){e.push($e);break}}else""+E===I&&e.push($e)}else C&&e.push($e);return e.push(Ge),qe(e,k,S),S;case"textarea":e.push(dt("textarea"));var P,N=null,D=null,M=null;for(P in n)if(H.call(n,P)){var O=n[P];if(null!=O)switch(P){case"children":M=O;break;case"value":N=O;break;case"defaultValue":D=O;break;case"dangerouslySetInnerHTML":throw Error(o(91));default:We(e,P,O)}}if(null===N&&null!==D&&(N=D),e.push(Ge),null!=M){if(null!=N)throw Error(o(92));if(A(M)){if(1<M.length)throw Error(o(93));N=""+M[0]}N=""+M}return"string"==typeof N&&"\n"===N[0]&&e.push(at),null!==N&&e.push(B(X(""+N))),null;case"input":e.push(dt("input"));var F,L=null,U=null,V=null,j=null,W=null,G=null,K=null,$=null,J=null;for(F in n)if(H.call(n,F)){var Y=n[F];if(null!=Y)switch(F){case"children":case"dangerouslySetInnerHTML":throw Error(o(399,"input"));case"name":L=Y;break;case"formAction":U=Y;break;case"formEncType":V=Y;break;case"formMethod":j=Y;break;case"formTarget":W=Y;break;case"defaultChecked":J=Y;break;case"defaultValue":K=Y;break;case"checked":$=Y;break;case"value":G=Y;break;default:We(e,F,Y)}}var Q=He(e,r,s,U,V,j,W,L);return null!==$?Fe(e,"checked",$):null!==J&&Fe(e,"checked",J),null!==G?We(e,"value",G):null!==K&&We(e,"value",K),e.push(Ke),null!=Q&&Q.forEach(Ve,e),null;case"button":e.push(dt("button"));var Z,ee=null,ne=null,ie=null,re=null,oe=null,ae=null,le=null;for(Z in n)if(H.call(n,Z)){var ce=n[Z];if(null!=ce)switch(Z){case"children":ee=ce;break;case"dangerouslySetInnerHTML":ne=ce;break;case"name":ie=ce;break;case"formAction":re=ce;break;case"formEncType":oe=ce;break;case"formMethod":ae=ce;break;case"formTarget":le=ce;break;default:We(e,Z,ce)}}var de=He(e,r,s,re,oe,ae,le,ie);if(e.push(Ge),null!=de&&de.forEach(Ve,e),qe(e,ne,ee),"string"==typeof ee){e.push(B(X(ee)));var ue=null}else ue=ee;return ue;case"form":e.push(dt("form"));var me,he=null,pe=null,ge=null,ve=null,fe=null,_e=null;for(me in n)if(H.call(n,me)){var ye=n[me];if(null!=ye)switch(me){case"children":he=ye;break;case"dangerouslySetInnerHTML":pe=ye;break;case"action":ge=ye;break;case"encType":ve=ye;break;case"method":fe=ye;break;case"target":_e=ye;break;default:We(e,me,ye)}}var be=null,Ee=null;if("function"==typeof ge){var we=ze(r,ge);null!==we?(ge=we.action||"",ve=we.encType,fe=we.method,_e=we.target,be=we.data,Ee=we.name):(e.push(Ne,B("action"),De,Ue,Me),_e=fe=ve=ge=null,Ye(r,s))}if(null!=ge&&We(e,"action",ge),null!=ve&&We(e,"encType",ve),null!=fe&&We(e,"method",fe),null!=_e&&We(e,"target",_e),e.push(Ge),null!==Ee&&(e.push(Be),Le(e,"name",Ee),e.push(Ke),null!=be&&be.forEach(Ve,e)),qe(e,pe,he),"string"==typeof he){e.push(B(X(he)));var Se=null}else Se=he;return Se;case"menuitem":for(var xe in e.push(dt("menuitem")),n)if(H.call(n,xe)){var Ce=n[xe];if(null!=Ce)switch(xe){case"children":case"dangerouslySetInnerHTML":throw Error(o(400));default:We(e,xe,Ce)}}return e.push(Ge),null;case"object":e.push(dt("object"));var ke,Re=null,Ie=null;for(ke in n)if(H.call(n,ke)){var Te=n[ke];if(null!=Te)switch(ke){case"children":Re=Te;break;case"dangerouslySetInnerHTML":Ie=Te;break;case"data":var Oe=te(""+Te);if(""===Oe)break;e.push(Ne,B("data"),De,B(X(Oe)),Me);break;default:We(e,ke,Te)}}if(e.push(Ge),qe(e,Ie,Re),"string"==typeof Re){e.push(B(X(Re)));var je=null}else je=Re;return je;case"title":if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp)var Je=it(e,n);else u?Je=null:(it(s.hoistableChunks,n),Je=void 0);return Je;case"link":var Xe=n.rel,Qe=n.href,lt=n.precedence;if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp||"string"!=typeof Xe||"string"!=typeof Qe||""===Qe){Ze(e,n);var ct=null}else if("stylesheet"===n.rel)if("string"!=typeof lt||null!=n.disabled||n.onLoad||n.onError)ct=Ze(e,n);else{var mt=s.styles.get(lt),ht=r.styleResources.hasOwnProperty(Qe)?r.styleResources[Qe]:void 0;if(null!==ht){r.styleResources[Qe]=null,mt||(mt={precedence:B(X(lt)),rules:[],hrefs:[],sheets:new Map},s.styles.set(lt,mt));var gt={state:0,props:z({},n,{"data-precedence":n.precedence,precedence:null})};if(ht){2===ht.length&&$n(gt.props,ht);var vt=s.preloads.stylesheets.get(Qe);vt&&0<vt.length?vt.length=0:gt.state=1}mt.sheets.set(Qe,gt),l&&l.stylesheets.add(gt)}else if(mt){var ft=mt.sheets.get(Qe);ft&&l&&l.stylesheets.add(ft)}d&&e.push(Ae),ct=null}else n.onLoad||n.onError?ct=Ze(e,n):(d&&e.push(Ae),ct=u?null:Ze(s.hoistableChunks,n));return ct;case"script":var _t=n.async;if("string"!=typeof n.src||!n.src||!_t||"function"==typeof _t||"symbol"==typeof _t||n.onLoad||n.onError||4===c.insertionMode||1&c.tagScope||null!=n.itemProp)var yt=rt(e,n);else{var bt=n.src;if("module"===n.type)var Et=r.moduleScriptResources,wt=s.preloads.moduleScripts;else Et=r.scriptResources,wt=s.preloads.scripts;var St=Et.hasOwnProperty(bt)?Et[bt]:void 0;if(null!==St){Et[bt]=null;var xt=n;if(St){2===St.length&&$n(xt=z({},n),St);var At=wt.get(bt);At&&(At.length=0)}var Ct=[];s.scripts.add(Ct),rt(Ct,xt)}d&&e.push(Ae),yt=null}return yt;case"style":var kt=n.precedence,Rt=n.href;if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp||"string"!=typeof kt||"string"!=typeof Rt||""===Rt){e.push(dt("style"));var It,Tt=null,Pt=null;for(It in n)if(H.call(n,It)){var Nt=n[It];if(null!=Nt)switch(It){case"children":Tt=Nt;break;case"dangerouslySetInnerHTML":Pt=Nt;break;default:We(e,It,Nt)}}e.push(Ge);var Dt=Array.isArray(Tt)?2>Tt.length?Tt[0]:null:Tt;"function"!=typeof Dt&&"symbol"!=typeof Dt&&null!=Dt&&e.push(B((""+Dt).replace(et,tt))),qe(e,Pt,Tt),e.push(pt("style"));var Mt=null}else{var Ot=s.styles.get(kt);if(null!==(r.styleResources.hasOwnProperty(Rt)?r.styleResources[Rt]:void 0)){r.styleResources[Rt]=null,Ot?Ot.hrefs.push(B(X(Rt))):(Ot={precedence:B(X(kt)),rules:[],hrefs:[B(X(Rt))],sheets:new Map},s.styles.set(kt,Ot));var Ft,Lt=Ot.rules,Ut=null,Bt=null;for(Ft in n)if(H.call(n,Ft)){var Vt=n[Ft];if(null!=Vt)switch(Ft){case"children":Ut=Vt;break;case"dangerouslySetInnerHTML":Bt=Vt}}var jt=Array.isArray(Ut)?2>Ut.length?Ut[0]:null:Ut;"function"!=typeof jt&&"symbol"!=typeof jt&&null!=jt&&Lt.push(B((""+jt).replace(et,tt))),qe(Lt,Bt,Ut)}Ot&&l&&l.styles.add(Ot),d&&e.push(Ae),Mt=void 0}return Mt;case"meta":if(4===c.insertionMode||1&c.tagScope||null!=n.itemProp)var zt=nt(e,n,"meta");else d&&e.push(Ae),zt=u?null:"string"==typeof n.charSet?nt(s.charsetChunks,n,"meta"):"viewport"===n.name?nt(s.viewportChunks,n,"meta"):nt(s.hoistableChunks,n,"meta");return zt;case"listing":case"pre":e.push(dt(t));var Ht,Wt=null,Gt=null;for(Ht in n)if(H.call(n,Ht)){var Kt=n[Ht];if(null!=Kt)switch(Ht){case"children":Wt=Kt;break;case"dangerouslySetInnerHTML":Gt=Kt;break;default:We(e,Ht,Kt)}}if(e.push(Ge),null!=Gt){if(null!=Wt)throw Error(o(60));if("object"!=typeof Gt||!("__html"in Gt))throw Error(o(61));var qt=Gt.__html;null!=qt&&("string"==typeof qt&&0<qt.length&&"\n"===qt[0]?e.push(at,B(qt)):e.push(B(""+qt)))}return"string"==typeof Wt&&"\n"===Wt[0]&&e.push(at),Wt;case"img":var $t=n.src,Jt=n.srcSet;if(!("lazy"===n.loading||!$t&&!Jt||"string"!=typeof $t&&null!=$t||"string"!=typeof Jt&&null!=Jt)&&"low"!==n.fetchPriority&&!1==!!(3&c.tagScope)&&("string"!=typeof $t||":"!==$t[4]||"d"!==$t[0]&&"D"!==$t[0]||"a"!==$t[1]&&"A"!==$t[1]||"t"!==$t[2]&&"T"!==$t[2]||"a"!==$t[3]&&"A"!==$t[3])&&("string"!=typeof Jt||":"!==Jt[4]||"d"!==Jt[0]&&"D"!==Jt[0]||"a"!==Jt[1]&&"A"!==Jt[1]||"t"!==Jt[2]&&"T"!==Jt[2]||"a"!==Jt[3]&&"A"!==Jt[3])){var Yt="string"==typeof n.sizes?n.sizes:void 0,Xt=Jt?Jt+"\n"+(Yt||""):$t,Qt=s.preloads.images,Zt=Qt.get(Xt);if(Zt)("high"===n.fetchPriority||10>s.highImagePreloads.size)&&(Qt.delete(Xt),s.highImagePreloads.add(Zt));else if(!r.imageResources.hasOwnProperty(Xt)){r.imageResources[Xt]=se;var en,tn=n.crossOrigin,nn="string"==typeof tn?"use-credentials"===tn?tn:"":void 0,rn=s.headers;rn&&0<rn.remainingCapacity&&"string"!=typeof n.srcSet&&("high"===n.fetchPriority||500>rn.highImagePreloads.length)&&(en=Jn($t,"image",{imageSrcSet:n.srcSet,imageSizes:n.sizes,crossOrigin:nn,integrity:n.integrity,nonce:n.nonce,type:n.type,fetchPriority:n.fetchPriority,referrerPolicy:n.refererPolicy}),0<=(rn.remainingCapacity-=en.length+2))?(s.resets.image[Xt]=se,rn.highImagePreloads&&(rn.highImagePreloads+=", "),rn.highImagePreloads+=en):(Ze(Zt=[],{rel:"preload",as:"image",href:Jt?void 0:$t,imageSrcSet:Jt,imageSizes:Yt,crossOrigin:nn,integrity:n.integrity,type:n.type,fetchPriority:n.fetchPriority,referrerPolicy:n.referrerPolicy}),"high"===n.fetchPriority||10>s.highImagePreloads.size?s.highImagePreloads.add(Zt):(s.bulkPreloads.add(Zt),Qt.set(Xt,Zt)))}}return nt(e,n,"img");case"base":case"area":case"br":case"col":case"embed":case"hr":case"keygen":case"param":case"source":case"track":case"wbr":return nt(e,n,t);case"head":if(2>c.insertionMode){var on=a||s.preamble;if(on.headChunks)throw Error(o(545,"`<head>`"));on.headChunks=[];var sn=ot(on.headChunks,n,"head")}else sn=st(e,n,"head");return sn;case"body":if(2>c.insertionMode){var an=a||s.preamble;if(an.bodyChunks)throw Error(o(545,"`<body>`"));an.bodyChunks=[];var ln=ot(an.bodyChunks,n,"body")}else ln=st(e,n,"body");return ln;case"html":if(0===c.insertionMode){var cn=a||s.preamble;if(cn.htmlChunks)throw Error(o(545,"`<html>`"));cn.htmlChunks=[ut];var dn=ot(cn.htmlChunks,n,"html")}else dn=st(e,n,"html");return dn;default:if(-1!==t.indexOf("-")){e.push(dt(t));var un,mn=null,hn=null;for(un in n)if(H.call(n,un)){var pn=n[un];if(null!=pn){var gn=un;switch(un){case"children":mn=pn;break;case"dangerouslySetInnerHTML":hn=pn;break;case"style":Pe(e,pn);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"ref":break;case"className":gn="class";default:if(q(un)&&"function"!=typeof pn&&"symbol"!=typeof pn&&!1!==pn){if(!0===pn)pn="";else if("object"==typeof pn)continue;e.push(Ne,B(gn),De,B(X(pn)),Me)}}}}return e.push(Ge),qe(e,hn,mn),mn}}return st(e,n,t)}var ht=new Map;function pt(e){var t=ht.get(e);return void 0===t&&(t=V("</"+e+">"),ht.set(e,t)),t}function gt(e,t){null===(e=e.preamble).htmlChunks&&t.htmlChunks&&(e.htmlChunks=t.htmlChunks,t.contribution|=1),null===e.headChunks&&t.headChunks&&(e.headChunks=t.headChunks,t.contribution|=4),null===e.bodyChunks&&t.bodyChunks&&(e.bodyChunks=t.bodyChunks,t.contribution|=2)}function vt(e,t){t=t.bootstrapChunks;for(var n=0;n<t.length-1;n++)O(e,t[n]);return!(n<t.length)||(n=t[n],t.length=0,F(e,n))}var ft=V('<template id="'),_t=V('"></template>'),yt=V("\x3c!--$--\x3e"),bt=V('\x3c!--$?--\x3e<template id="'),Et=V('"></template>'),wt=V("\x3c!--$!--\x3e"),St=V("\x3c!--/$--\x3e"),xt=V("<template"),At=V('"'),Ct=V(' data-dgst="');V(' data-msg="'),V(' data-stck="'),V(' data-cstck="');var kt=V("></template>");function Rt(e,t,n){if(O(e,bt),null===n)throw Error(o(395));return O(e,t.boundaryPrefix),O(e,B(n.toString(16))),F(e,Et)}var It=V("\x3c!--"),Tt=V("--\x3e");function Pt(e,t){0!==(t=t.contribution)&&(O(e,It),O(e,B(""+t)),O(e,Tt))}var Nt=V('<div hidden id="'),Dt=V('">'),Mt=V("</div>"),Ot=V('<svg aria-hidden="true" style="display:none" id="'),Ft=V('">'),Lt=V("</svg>"),Ut=V('<math aria-hidden="true" style="display:none" id="'),Bt=V('">'),Vt=V("</math>"),jt=V('<table hidden id="'),zt=V('">'),Ht=V("</table>"),Wt=V('<table hidden><tbody id="'),Gt=V('">'),Kt=V("</tbody></table>"),qt=V('<table hidden><tr id="'),$t=V('">'),Jt=V("</tr></table>"),Yt=V('<table hidden><colgroup id="'),Xt=V('">'),Qt=V("</colgroup></table>");var Zt=V('$RS=function(a,b){a=document.getElementById(a);b=document.getElementById(b);for(a.parentNode.removeChild(a);a.firstChild;)b.parentNode.insertBefore(a.firstChild,b);b.parentNode.removeChild(b)};$RS("'),en=V('$RS("'),tn=V('","'),nn=V('")<\/script>');V('<template data-rsi="" data-sid="'),V('" data-pid="');var rn=V('$RC=function(b,c,e){c=document.getElementById(c);c.parentNode.removeChild(c);var a=document.getElementById(b);if(a){b=a.previousSibling;if(e)b.data="$!",a.setAttribute("data-dgst",e);else{e=b.parentNode;a=b.nextSibling;var f=0;do{if(a&&8===a.nodeType){var d=a.data;if("/$"===d)if(0===f)break;else f--;else"$"!==d&&"$?"!==d&&"$!"!==d||f++}d=a.nextSibling;e.removeChild(a);a=d}while(a);for(;c.firstChild;)e.insertBefore(c.firstChild,a);b.data="$"}b._reactRetry&&b._reactRetry()}};$RC("'),on=V('$RC("'),sn=V('$RC=function(b,c,e){c=document.getElementById(c);c.parentNode.removeChild(c);var a=document.getElementById(b);if(a){b=a.previousSibling;if(e)b.data="$!",a.setAttribute("data-dgst",e);else{e=b.parentNode;a=b.nextSibling;var f=0;do{if(a&&8===a.nodeType){var d=a.data;if("/$"===d)if(0===f)break;else f--;else"$"!==d&&"$?"!==d&&"$!"!==d||f++}d=a.nextSibling;e.removeChild(a);a=d}while(a);for(;c.firstChild;)e.insertBefore(c.firstChild,a);b.data="$"}b._reactRetry&&b._reactRetry()}};$RM=new Map;\n$RR=function(t,u,y){function v(n){this._p=null;n()}for(var w=$RC,p=$RM,q=new Map,r=document,g,b,h=r.querySelectorAll("link[data-precedence],style[data-precedence]"),x=[],k=0;b=h[k++];)"not all"===b.getAttribute("media")?x.push(b):("LINK"===b.tagName&&p.set(b.getAttribute("href"),b),q.set(b.dataset.precedence,g=b));b=0;h=[];var l,a;for(k=!0;;){if(k){var e=y[b++];if(!e){k=!1;b=0;continue}var c=!1,m=0;var d=e[m++];if(a=p.get(d)){var f=a._p;c=!0}else{a=r.createElement("link");a.href=\nd;a.rel="stylesheet";for(a.dataset.precedence=l=e[m++];f=e[m++];)a.setAttribute(f,e[m++]);f=a._p=new Promise(function(n,z){a.onload=v.bind(a,n);a.onerror=v.bind(a,z)});p.set(d,a)}d=a.getAttribute("media");!f||d&&!matchMedia(d).matches||h.push(f);if(c)continue}else{a=x[b++];if(!a)break;l=a.getAttribute("data-precedence");a.removeAttribute("media")}c=q.get(l)||g;c===g&&(g=a);q.set(l,a);c?c.parentNode.insertBefore(a,c.nextSibling):(c=r.head,c.insertBefore(a,c.firstChild))}Promise.all(h).then(w.bind(null,\nt,u,""),w.bind(null,t,u,"Resource failed to load"))};$RR("'),an=V('$RM=new Map;\n$RR=function(t,u,y){function v(n){this._p=null;n()}for(var w=$RC,p=$RM,q=new Map,r=document,g,b,h=r.querySelectorAll("link[data-precedence],style[data-precedence]"),x=[],k=0;b=h[k++];)"not all"===b.getAttribute("media")?x.push(b):("LINK"===b.tagName&&p.set(b.getAttribute("href"),b),q.set(b.dataset.precedence,g=b));b=0;h=[];var l,a;for(k=!0;;){if(k){var e=y[b++];if(!e){k=!1;b=0;continue}var c=!1,m=0;var d=e[m++];if(a=p.get(d)){var f=a._p;c=!0}else{a=r.createElement("link");a.href=\nd;a.rel="stylesheet";for(a.dataset.precedence=l=e[m++];f=e[m++];)a.setAttribute(f,e[m++]);f=a._p=new Promise(function(n,z){a.onload=v.bind(a,n);a.onerror=v.bind(a,z)});p.set(d,a)}d=a.getAttribute("media");!f||d&&!matchMedia(d).matches||h.push(f);if(c)continue}else{a=x[b++];if(!a)break;l=a.getAttribute("data-precedence");a.removeAttribute("media")}c=q.get(l)||g;c===g&&(g=a);q.set(l,a);c?c.parentNode.insertBefore(a,c.nextSibling):(c=r.head,c.insertBefore(a,c.firstChild))}Promise.all(h).then(w.bind(null,\nt,u,""),w.bind(null,t,u,"Resource failed to load"))};$RR("'),ln=V('$RR("'),cn=V('","'),dn=V('",'),un=V('"'),mn=V(")<\/script>");V('<template data-rci="" data-bid="'),V('<template data-rri="" data-bid="'),V('" data-sid="'),V('" data-sty="');var hn=V('$RX=function(b,c,d,e,f){var a=document.getElementById(b);a&&(b=a.previousSibling,b.data="$!",a=a.dataset,c&&(a.dgst=c),d&&(a.msg=d),e&&(a.stck=e),f&&(a.cstck=f),b._reactRetry&&b._reactRetry())};;$RX("'),pn=V('$RX("'),gn=V('"'),vn=V(","),fn=V(")<\/script>");V('<template data-rxi="" data-bid="'),V('" data-dgst="'),V('" data-msg="'),V('" data-stck="'),V('" data-cstck="');var _n=/[<\u2028\u2029]/g;function yn(e){return JSON.stringify(e).replace(_n,function(e){switch(e){case"<":return"\\u003c";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw Error("escapeJSStringsForInstructionScripts encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}})}var bn=/[&><\u2028\u2029]/g;function En(e){return JSON.stringify(e).replace(bn,function(e){switch(e){case"&":return"\\u0026";case">":return"\\u003e";case"<":return"\\u003c";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:throw Error("escapeJSObjectForInstructionScripts encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}})}var wn=V('<style media="not all" data-precedence="'),Sn=V('" data-href="'),xn=V('">'),An=V("</style>"),Cn=!1,kn=!0;function Rn(e){var t=e.rules,n=e.hrefs,i=0;if(n.length){for(O(this,wn),O(this,e.precedence),O(this,Sn);i<n.length-1;i++)O(this,n[i]),O(this,Fn);for(O(this,n[i]),O(this,xn),i=0;i<t.length;i++)O(this,t[i]);kn=F(this,An),Cn=!0,t.length=0,n.length=0}}function In(e){return 2!==e.state&&(Cn=!0)}function Tn(e,t,n){return Cn=!1,kn=!0,t.styles.forEach(Rn,e),t.stylesheets.forEach(In),Cn&&(n.stylesToHoist=!0),kn}function Pn(e){for(var t=0;t<e.length;t++)O(this,e[t]);e.length=0}var Nn=[];function Dn(e){Ze(Nn,e.props);for(var t=0;t<Nn.length;t++)O(this,Nn[t]);Nn.length=0,e.state=2}var Mn=V('<style data-precedence="'),On=V('" data-href="'),Fn=V(" "),Ln=V('">'),Un=V("</style>");function Bn(e){var t=0<e.sheets.size;e.sheets.forEach(Dn,this),e.sheets.clear();var n=e.rules,i=e.hrefs;if(!t||i.length){if(O(this,Mn),O(this,e.precedence),e=0,i.length){for(O(this,On);e<i.length-1;e++)O(this,i[e]),O(this,Fn);O(this,i[e])}for(O(this,Ln),e=0;e<n.length;e++)O(this,n[e]);O(this,Un),n.length=0,i.length=0}}function Vn(e){if(0===e.state){e.state=1;var t=e.props;for(Ze(Nn,{rel:"preload",as:"style",href:e.props.href,crossOrigin:t.crossOrigin,fetchPriority:t.fetchPriority,integrity:t.integrity,media:t.media,hrefLang:t.hrefLang,referrerPolicy:t.referrerPolicy}),e=0;e<Nn.length;e++)O(this,Nn[e]);Nn.length=0}}function jn(e){e.sheets.forEach(Vn,this),e.sheets.clear()}var zn=V("["),Hn=V(",["),Wn=V(","),Gn=V("]");function Kn(e,t,n){var i=t.toLowerCase();switch(typeof n){case"function":case"symbol":return}switch(t){case"innerHTML":case"dangerouslySetInnerHTML":case"suppressContentEditableWarning":case"suppressHydrationWarning":case"style":case"ref":return;case"className":i="class",t=""+n;break;case"hidden":if(!1===n)return;t="";break;case"src":case"href":t=""+(n=te(n));break;default:if(2<t.length&&("o"===t[0]||"O"===t[0])&&("n"===t[1]||"N"===t[1])||!q(t))return;t=""+n}O(e,Wn),O(e,B(En(i))),O(e,Wn),O(e,B(En(t)))}function qn(){return{styles:new Set,stylesheets:new Set}}function $n(e,t){null==e.crossOrigin&&(e.crossOrigin=t[0]),null==e.integrity&&(e.integrity=t[1])}function Jn(e,t,n){for(var i in t="<"+(e=(""+e).replace(Yn,Xn))+'>; rel=preload; as="'+(t=(""+t).replace(Qn,Zn))+'"',n)H.call(n,i)&&("string"==typeof(e=n[i])&&(t+="; "+i.toLowerCase()+'="'+(""+e).replace(Qn,Zn)+'"'));return t}var Yn=/[<>\r\n]/g;function Xn(e){switch(e){case"<":return"%3C";case">":return"%3E";case"\n":return"%0A";case"\r":return"%0D";default:throw Error("escapeLinkHrefForHeaderContextReplacer encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}}var Qn=/["';,\r\n]/g;function Zn(e){switch(e){case'"':return"%22";case"'":return"%27";case";":return"%3B";case",":return"%2C";case"\n":return"%0A";case"\r":return"%0D";default:throw Error("escapeStringForLinkHeaderQuotedParamValueContextReplacer encountered a match it does not know how to replace. this means the match regex and the replacement characters are no longer in sync. This is a bug in React")}}function ei(e){this.styles.add(e)}function ti(e){this.stylesheets.add(e)}var ni=Function.prototype.bind,ii=Symbol.for("react.client.reference");function ri(e){if(null==e)return null;if("function"==typeof e)return e.$$typeof===ii?null:e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case l:return"Fragment";case d:return"Profiler";case c:return"StrictMode";case g:return"Suspense";case v:return"SuspenseList";case b:return"Activity"}if("object"==typeof e)switch(e.$$typeof){case a:return"Portal";case h:return(e.displayName||"Context")+".Provider";case m:return(e._context.displayName||"Context")+".Consumer";case p:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case f:return null!==(t=e.displayName||null)?t:ri(e.type)||"Memo";case _:t=e._payload,e=e._init;try{return ri(e(t))}catch(e){}}return null}var oi={},si=null;function ai(e,t){if(e!==t){e.context._currentValue=e.parentValue,e=e.parent;var n=t.parent;if(null===e){if(null!==n)throw Error(o(401))}else{if(null===n)throw Error(o(401));ai(e,n)}t.context._currentValue=t.value}}function li(e){e.context._currentValue=e.parentValue,null!==(e=e.parent)&&li(e)}function ci(e){var t=e.parent;null!==t&&ci(t),e.context._currentValue=e.value}function di(e,t){if(e.context._currentValue=e.parentValue,null===(e=e.parent))throw Error(o(402));e.depth===t.depth?ai(e,t):di(e,t)}function ui(e,t){var n=t.parent;if(null===n)throw Error(o(402));e.depth===n.depth?ai(e,n):ui(e,n),t.context._currentValue=t.value}function mi(e){var t=si;t!==e&&(null===t?ci(e):null===e?li(t):t.depth===e.depth?ai(t,e):t.depth>e.depth?di(t,e):ui(t,e),si=e)}var hi={enqueueSetState:function(e,t){null!==(e=e._reactInternals).queue&&e.queue.push(t)},enqueueReplaceState:function(e,t){(e=e._reactInternals).replace=!0,e.queue=[t]},enqueueForceUpdate:function(){}},pi={id:1,overflow:""};function gi(e,t,n){var i=e.id;e=e.overflow;var r=32-vi(i)-1;i&=~(1<<r),n+=1;var o=32-vi(t)+r;if(30<o){var s=r-r%5;return o=(i&(1<<s)-1).toString(32),i>>=s,r-=s,{id:1<<32-vi(t)+r|n<<r|i,overflow:o+e}}return{id:1<<o|n<<r|i,overflow:e}}var vi=Math.clz32?Math.clz32:function(e){return 0===(e>>>=0)?32:31-(fi(e)/_i|0)|0},fi=Math.log,_i=Math.LN2;var yi=Error(o(460));function bi(){}var Ei=null;function wi(){if(null===Ei)throw Error(o(459));var e=Ei;return Ei=null,e}var Si="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},xi=null,Ai=null,Ci=null,ki=null,Ri=null,Ii=null,Ti=!1,Pi=!1,Ni=0,Di=0,Mi=-1,Oi=0,Fi=null,Li=null,Ui=0;function Bi(){if(null===xi)throw Error(o(321));return xi}function Vi(){if(0<Ui)throw Error(o(312));return{memoizedState:null,queue:null,next:null}}function ji(){return null===Ii?null===Ri?(Ti=!1,Ri=Ii=Vi()):(Ti=!0,Ii=Ri):null===Ii.next?(Ti=!1,Ii=Ii.next=Vi()):(Ti=!0,Ii=Ii.next),Ii}function zi(){var e=Fi;return Fi=null,e}function Hi(){ki=Ci=Ai=xi=null,Pi=!1,Ri=null,Ui=0,Ii=Li=null}function Wi(e,t){return"function"==typeof t?t(e):t}function Gi(e,t,n){if(xi=Bi(),Ii=ji(),Ti){var i=Ii.queue;if(t=i.dispatch,null!==Li&&void 0!==(n=Li.get(i))){Li.delete(i),i=Ii.memoizedState;do{i=e(i,n.action),n=n.next}while(null!==n);return Ii.memoizedState=i,[i,t]}return[Ii.memoizedState,t]}return e=e===Wi?"function"==typeof t?t():t:void 0!==n?n(t):t,Ii.memoizedState=e,e=(e=Ii.queue={last:null,dispatch:null}).dispatch=qi.bind(null,xi,e),[Ii.memoizedState,e]}function Ki(e,t){if(xi=Bi(),t=void 0===t?null:t,null!==(Ii=ji())){var n=Ii.memoizedState;if(null!==n&&null!==t){var i=n[1];e:if(null===i)i=!1;else{for(var r=0;r<i.length&&r<t.length;r++)if(!Si(t[r],i[r])){i=!1;break e}i=!0}if(i)return n[0]}}return e=e(),Ii.memoizedState=[e,t],e}function qi(e,t,n){if(25<=Ui)throw Error(o(301));if(e===xi)if(Pi=!0,e={action:n,next:null},null===Li&&(Li=new Map),void 0===(n=Li.get(t)))Li.set(t,e);else{for(t=n;null!==t.next;)t=t.next;t.next=e}}function $i(){throw Error(o(394))}function Ji(){throw Error(o(479))}function Yi(e,t,n){Bi();var i=Di++,r=Ci;if("function"==typeof e.$$FORM_ACTION){var o=null,s=ki;r=r.formState;var a=e.$$IS_SIGNATURE_EQUAL;if(null!==r&&"function"==typeof a){var l=r[1];a.call(e,r[2],r[3])&&(l===(o=void 0!==n?"p"+n:"k"+C(JSON.stringify([s,null,i]),0))&&(Mi=i,t=r[0]))}var c=e.bind(null,t);return e=function(e){c(e)},"function"==typeof c.$$FORM_ACTION&&(e.$$FORM_ACTION=function(e){e=c.$$FORM_ACTION(e),void 0!==n&&(n+="",e.action=n);var t=e.data;return t&&(null===o&&(o=void 0!==n?"p"+n:"k"+C(JSON.stringify([s,null,i]),0)),t.append("$ACTION_KEY",o)),e}),[t,e,!1]}var d=e.bind(null,t);return[t,function(e){d(e)},!1]}function Xi(e){var t=Oi;return Oi+=1,null===Fi&&(Fi=[]),function(e,t,n){switch(void 0===(n=e[n])?e.push(t):n!==t&&(t.then(bi,bi),t=n),t.status){case"fulfilled":return t.value;case"rejected":throw t.reason;default:switch("string"==typeof t.status?t.then(bi,bi):((e=t).status="pending",e.then(function(e){if("pending"===t.status){var n=t;n.status="fulfilled",n.value=e}},function(e){if("pending"===t.status){var n=t;n.status="rejected",n.reason=e}})),t.status){case"fulfilled":return t.value;case"rejected":throw t.reason}throw Ei=t,yi}}(Fi,e,t)}function Qi(){throw Error(o(393))}function Zi(){}var er,tr,nr={readContext:function(e){return e._currentValue},use:function(e){if(null!==e&&"object"==typeof e){if("function"==typeof e.then)return Xi(e);if(e.$$typeof===h)return e._currentValue}throw Error(o(438,String(e)))},useContext:function(e){return Bi(),e._currentValue},useMemo:Ki,useReducer:Gi,useRef:function(e){xi=Bi();var t=(Ii=ji()).memoizedState;return null===t?(e={current:e},Ii.memoizedState=e):t},useState:function(e){return Gi(Wi,e)},useInsertionEffect:Zi,useLayoutEffect:Zi,useCallback:function(e,t){return Ki(function(){return e},t)},useImperativeHandle:Zi,useEffect:Zi,useDebugValue:Zi,useDeferredValue:function(e,t){return Bi(),void 0!==t?t:e},useTransition:function(){return Bi(),[!1,$i]},useId:function(){var e=Ai.treeContext,t=e.overflow;e=((e=e.id)&~(1<<32-vi(e)-1)).toString(32)+t;var n=ir;if(null===n)throw Error(o(404));return t=Ni++,e=""+n.idPrefix+"R"+e,0<t&&(e+="H"+t.toString(32)),e+""},useSyncExternalStore:function(e,t,n){if(void 0===n)throw Error(o(407));return n()},useOptimistic:function(e){return Bi(),[e,Ji]},useActionState:Yi,useFormState:Yi,useHostTransitionStatus:function(){return Bi(),re},useMemoCache:function(e){for(var t=Array(e),n=0;n<e;n++)t[n]=w;return t},useCacheRefresh:function(){return Qi}},ir=null,rr={getCacheForType:function(){throw Error(o(248))}};function or(e){if(void 0===er)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);er=t&&t[1]||"",tr=-1<e.stack.indexOf("\n    at")?" (<anonymous>)":-1<e.stack.indexOf("@")?"@unknown:0:0":""}return"\n"+er+e+tr}var sr=!1;function ar(e,t){if(!e||sr)return"";sr=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var i={DetermineComponentFrameRoot:function(){try{if(t){var n=function(){throw Error()};if(Object.defineProperty(n.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(n,[])}catch(e){var i=e}Reflect.construct(e,[],n)}else{try{n.call()}catch(e){i=e}e.call(n.prototype)}}else{try{throw Error()}catch(e){i=e}(n=e())&&"function"==typeof n.catch&&n.catch(function(){})}}catch(e){if(e&&i&&"string"==typeof e.stack)return[e.stack,i.stack]}return[null,null]}};i.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var r=Object.getOwnPropertyDescriptor(i.DetermineComponentFrameRoot,"name");r&&r.configurable&&Object.defineProperty(i.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var o=i.DetermineComponentFrameRoot(),s=o[0],a=o[1];if(s&&a){var l=s.split("\n"),c=a.split("\n");for(r=i=0;i<l.length&&!l[i].includes("DetermineComponentFrameRoot");)i++;for(;r<c.length&&!c[r].includes("DetermineComponentFrameRoot");)r++;if(i===l.length||r===c.length)for(i=l.length-1,r=c.length-1;1<=i&&0<=r&&l[i]!==c[r];)r--;for(;1<=i&&0<=r;i--,r--)if(l[i]!==c[r]){if(1!==i||1!==r)do{if(i--,0>--r||l[i]!==c[r]){var d="\n"+l[i].replace(" at new "," at ");return e.displayName&&d.includes("<anonymous>")&&(d=d.replace("<anonymous>",e.displayName)),d}}while(1<=i&&0<=r);break}}}finally{sr=!1,Error.prepareStackTrace=n}return(n=e?e.displayName||e.name:"")?or(n):""}function lr(e){if("string"==typeof e)return or(e);if("function"==typeof e)return e.prototype&&e.prototype.isReactComponent?ar(e,!0):ar(e,!1);if("object"==typeof e&&null!==e){switch(e.$$typeof){case p:return ar(e.render,!1);case f:return ar(e.type,!1);case _:var t=e,n=t._payload;t=t._init;try{e=t(n)}catch(e){return or("Lazy")}return lr(e)}if("string"==typeof e.name)return n=e.env,or(e.name+(n?" ["+n+"]":""))}switch(e){case v:return or("SuspenseList");case g:return or("Suspense")}return""}function cr(e){if("object"==typeof e&&null!==e&&"string"==typeof e.environmentName){var t=e.environmentName;"string"==typeof(e=[e].slice(0))[0]?e.splice(0,1,"%c%s%c "+e[0],"background: #e6e6e6;background: light-dark(rgba(0,0,0,0.1), rgba(255,255,255,0.25));color: #000000;color: light-dark(#000000, #ffffff);border-radius: 2px"," "+t+" ",""):e.splice(0,0,"%c%s%c ","background: #e6e6e6;background: light-dark(rgba(0,0,0,0.1), rgba(255,255,255,0.25));color: #000000;color: light-dark(#000000, #ffffff);border-radius: 2px"," "+t+" ",""),e.unshift(console),(t=ni.apply(console.error,e))()}else console.error(e);return null}function dr(){}function ur(e,t,n,i,r,o,s,a,l,c,d){var u=new Set;this.destination=null,this.flushScheduled=!1,this.resumableState=e,this.renderState=t,this.rootFormatContext=n,this.progressiveChunkSize=void 0===i?12800:i,this.status=10,this.fatalError=null,this.pendingRootTasks=this.allPendingTasks=this.nextSegmentId=0,this.completedPreambleSegments=this.completedRootSegment=null,this.abortableTasks=u,this.pingedTasks=[],this.clientRenderedBoundaries=[],this.completedBoundaries=[],this.partialBoundaries=[],this.trackedPostpones=null,this.onError=void 0===r?cr:r,this.onPostpone=void 0===c?dr:c,this.onAllReady=void 0===o?dr:o,this.onShellReady=void 0===s?dr:s,this.onShellError=void 0===a?dr:a,this.onFatalError=void 0===l?dr:l,this.formState=void 0===d?null:d}function mr(e,t,n,i,r,o,s,a,l,c,d,u){return(n=_r(t=new ur(t,n,i,r,o,s,a,l,c,d,u),0,null,i,!1,!1)).parentFlushed=!0,yr(e=vr(t,null,e,-1,null,n,null,null,t.abortableTasks,null,i,null,pi,null,!1)),t.pingedTasks.push(e),t}var hr=null;function pr(e,t){e.pingedTasks.push(t),1===e.pingedTasks.length&&(e.flushScheduled=null!==e.destination,null!==e.trackedPostpones||10===e.status?N(function(){return zr(e)}):I(function(){return zr(e)}))}function gr(e,t,n,i){return{status:0,rootSegmentID:-1,parentFlushed:!1,pendingTasks:0,completedSegments:[],byteSize:0,fallbackAbortableTasks:t,errorDigest:null,contentState:qn(),fallbackState:qn(),contentPreamble:n,fallbackPreamble:i,trackedContentKeyPath:null,trackedFallbackNode:null}}function vr(e,t,n,i,r,o,s,a,l,c,d,u,m,h,p){e.allPendingTasks++,null===r?e.pendingRootTasks++:r.pendingTasks++;var g={replay:null,node:n,childIndex:i,ping:function(){return pr(e,g)},blockedBoundary:r,blockedSegment:o,blockedPreamble:s,hoistableState:a,abortSet:l,keyPath:c,formatContext:d,context:u,treeContext:m,componentStack:h,thenableState:t,isFallback:p};return l.add(g),g}function fr(e,t,n,i,r,o,s,a,l,c,d,u,m,h){e.allPendingTasks++,null===o?e.pendingRootTasks++:o.pendingTasks++,n.pendingTasks++;var p={replay:n,node:i,childIndex:r,ping:function(){return pr(e,p)},blockedBoundary:o,blockedSegment:null,blockedPreamble:null,hoistableState:s,abortSet:a,keyPath:l,formatContext:c,context:d,treeContext:u,componentStack:m,thenableState:t,isFallback:h};return a.add(p),p}function _r(e,t,n,i,r,o){return{status:0,parentFlushed:!1,id:-1,index:t,chunks:[],children:[],preambleChildren:[],parentFormatContext:i,boundary:n,lastPushedText:r,textEmbedded:o}}function yr(e){var t=e.node;if("object"==typeof t&&null!==t&&t.$$typeof===s)e.componentStack={parent:e.componentStack,type:t.type}}function br(e){var t={};return e&&Object.defineProperty(t,"componentStack",{configurable:!0,enumerable:!0,get:function(){try{var n="",i=e;do{n+=lr(i.type),i=i.parent}while(i);var r=n}catch(e){r="\nError generating stack: "+e.message+"\n"+e.stack}return Object.defineProperty(t,"componentStack",{value:r}),r}}),t}function Er(e,t,n){if(null==(t=(e=e.onError)(t,n))||"string"==typeof t)return t}function wr(e,t){var n=e.onShellError,i=e.onFatalError;n(t),i(t),null!==e.destination?(e.status=14,j(e.destination,t)):(e.status=13,e.fatalError=t)}function Sr(e,t,n,i,r,o){var s=t.thenableState;for(t.thenableState=null,xi={},Ai=t,Ci=e,ki=n,Di=Ni=0,Mi=-1,Oi=0,Fi=s,e=i(r,o);Pi;)Pi=!1,Di=Ni=0,Mi=-1,Oi=0,Ui+=1,Ii=null,e=i(r,o);return Hi(),e}function xr(e,t,n,i,r,o,s){var a=!1;if(0!==o&&null!==e.formState){var l=t.blockedSegment;if(null!==l){a=!0,l=l.chunks;for(var c=0;c<o;c++)c===s?l.push(Xe):l.push(Qe)}}o=t.keyPath,t.keyPath=n,r?(n=t.treeContext,t.treeContext=gi(n,1,0),Dr(e,t,i,-1),t.treeContext=n):a?Dr(e,t,i,-1):kr(e,t,i,-1),t.keyPath=o}function Ar(e,t,n,i,r,s){if("function"==typeof i)if(i.prototype&&i.prototype.isReactComponent){var a=r;if("ref"in r)for(var w in a={},r)"ref"!==w&&(a[w]=r[w]);var x=i.defaultProps;if(x)for(var A in a===r&&(a=z({},a,r)),x)void 0===a[A]&&(a[A]=x[A]);r=a,a=oi,"object"==typeof(x=i.contextType)&&null!==x&&(a=x._currentValue);var C=void 0!==(a=new i(r,a)).state?a.state:null;if(a.updater=hi,a.props=r,a.state=C,x={queue:[],replace:!1},a._reactInternals=x,s=i.contextType,a.context="object"==typeof s&&null!==s?s._currentValue:oi,"function"==typeof(s=i.getDerivedStateFromProps)&&(C=null==(s=s(r,C))?C:z({},C,s),a.state=C),"function"!=typeof i.getDerivedStateFromProps&&"function"!=typeof a.getSnapshotBeforeUpdate&&("function"==typeof a.UNSAFE_componentWillMount||"function"==typeof a.componentWillMount))if(i=a.state,"function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount(),i!==a.state&&hi.enqueueReplaceState(a,a.state,null),null!==x.queue&&0<x.queue.length)if(i=x.queue,s=x.replace,x.queue=null,x.replace=!1,s&&1===i.length)a.state=i[0];else{for(x=s?i[0]:a.state,C=!0,s=s?1:0;s<i.length;s++)null!=(A="function"==typeof(A=i[s])?A.call(a,x,r,void 0):A)&&(C?(C=!1,x=z({},x,A)):z(x,A));a.state=x}else x.queue=null;if(i=a.render(),12===e.status)throw null;r=t.keyPath,t.keyPath=n,kr(e,t,i,-1),t.keyPath=r}else{if(i=Sr(e,t,n,i,r,void 0),12===e.status)throw null;xr(e,t,n,i,0!==Ni,Di,Mi)}else{if("string"!=typeof i){switch(i){case E:case c:case d:case l:return i=t.keyPath,t.keyPath=n,kr(e,t,r.children,-1),void(t.keyPath=i);case b:return void("hidden"!==r.mode&&(i=t.keyPath,t.keyPath=n,kr(e,t,r.children,-1),t.keyPath=i));case v:return i=t.keyPath,t.keyPath=n,kr(e,t,r.children,-1),void(t.keyPath=i);case S:case y:throw Error(o(343));case g:e:if(null!==t.replay){i=t.keyPath,t.keyPath=n,n=r.children;try{Dr(e,t,n,-1)}finally{t.keyPath=i}}else{i=t.keyPath;var k=t.blockedBoundary;s=t.blockedPreamble;var R=t.hoistableState;A=t.blockedSegment,w=r.fallback,r=r.children;var I=new Set,T=2>t.formatContext.insertionMode?gr(0,I,{htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0},{htmlChunks:null,headChunks:null,bodyChunks:null,contribution:0}):gr(0,I,null,null);null!==e.trackedPostpones&&(T.trackedContentKeyPath=n);var P=_r(0,A.chunks.length,T,t.formatContext,!1,!1);A.children.push(P),A.lastPushedText=!1;var N=_r(0,0,null,t.formatContext,!1,!1);if(N.parentFlushed=!0,null!==e.trackedPostpones){x=[(a=[n[0],"Suspense Fallback",n[2]])[1],a[2],[],null],e.trackedPostpones.workingMap.set(a,x),T.trackedFallbackNode=x,t.blockedSegment=P,t.blockedPreamble=T.fallbackPreamble,t.keyPath=a,P.status=6;try{Dr(e,t,w,-1),P.lastPushedText&&P.textEmbedded&&P.chunks.push(Ae),P.status=1}catch(t){throw P.status=12===e.status?3:4,t}finally{t.blockedSegment=A,t.blockedPreamble=s,t.keyPath=i}yr(t=vr(e,null,r,-1,T,N,T.contentPreamble,T.contentState,t.abortSet,n,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)),e.pingedTasks.push(t)}else{t.blockedBoundary=T,t.blockedPreamble=T.contentPreamble,t.hoistableState=T.contentState,t.blockedSegment=N,t.keyPath=n,N.status=6;try{if(Dr(e,t,r,-1),N.lastPushedText&&N.textEmbedded&&N.chunks.push(Ae),N.status=1,Vr(T,N),0===T.pendingTasks&&0===T.status){T.status=1,0===e.pendingRootTasks&&t.blockedPreamble&&Gr(e);break e}}catch(n){T.status=4,12===e.status?(N.status=3,a=e.fatalError):(N.status=4,a=n),C=Er(e,a,x=br(t.componentStack)),T.errorDigest=C,Tr(e,T)}finally{t.blockedBoundary=k,t.blockedPreamble=s,t.hoistableState=R,t.blockedSegment=A,t.keyPath=i}yr(t=vr(e,null,w,-1,k,P,T.fallbackPreamble,T.fallbackState,I,[n[0],"Suspense Fallback",n[2]],t.formatContext,t.context,t.treeContext,t.componentStack,!0)),e.pingedTasks.push(t)}}return}if("object"==typeof i&&null!==i)switch(i.$$typeof){case p:if("ref"in r)for(T in a={},r)"ref"!==T&&(a[T]=r[T]);else a=r;return void xr(e,t,n,i=Sr(e,t,n,i.render,a,s),0!==Ni,Di,Mi);case f:return void Ar(e,t,n,i.type,r,s);case u:case h:if(x=r.children,a=t.keyPath,r=r.value,C=i._currentValue,i._currentValue=r,si=i={parent:s=si,depth:null===s?0:s.depth+1,context:i,parentValue:C,value:r},t.context=i,t.keyPath=n,kr(e,t,x,-1),null===(e=si))throw Error(o(403));return e.context._currentValue=e.parentValue,e=si=e.parent,t.context=e,void(t.keyPath=a);case m:return i=(r=r.children)(i._context._currentValue),r=t.keyPath,t.keyPath=n,kr(e,t,i,-1),void(t.keyPath=r);case _:if(i=(a=i._init)(i._payload),12===e.status)throw null;return void Ar(e,t,n,i,r,s)}throw Error(o(130,null==i?i:typeof i,""))}if(null===(a=t.blockedSegment))a=r.children,x=t.formatContext,C=t.keyPath,t.formatContext=xe(x,i,r),t.keyPath=n,Dr(e,t,a,-1),t.formatContext=x,t.keyPath=C;else{s=mt(a.chunks,i,r,e.resumableState,e.renderState,t.blockedPreamble,t.hoistableState,t.formatContext,a.lastPushedText,t.isFallback),a.lastPushedText=!1,x=t.formatContext,C=t.keyPath,t.keyPath=n,3===(t.formatContext=xe(x,i,r)).insertionMode?(n=_r(0,0,null,t.formatContext,!1,!1),a.preambleChildren.push(n),yr(n=vr(e,null,s,-1,t.blockedBoundary,n,t.blockedPreamble,t.hoistableState,e.abortableTasks,t.keyPath,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)),e.pingedTasks.push(n)):Dr(e,t,s,-1),t.formatContext=x,t.keyPath=C;e:{switch(t=a.chunks,e=e.resumableState,i){case"title":case"style":case"script":case"area":case"base":case"br":case"col":case"embed":case"hr":case"img":case"input":case"keygen":case"link":case"meta":case"param":case"source":case"track":case"wbr":break e;case"body":if(1>=x.insertionMode){e.hasBody=!0;break e}break;case"html":if(0===x.insertionMode){e.hasHtml=!0;break e}break;case"head":if(1>=x.insertionMode)break e}t.push(pt(i))}a.lastPushedText=!1}}}function Cr(e,t,n,i,r){var o=t.replay,s=t.blockedBoundary,a=_r(0,0,null,t.formatContext,!1,!1);a.id=n,a.parentFlushed=!0;try{t.replay=null,t.blockedSegment=a,Dr(e,t,i,r),a.status=1,null===s?e.completedRootSegment=a:(Vr(s,a),s.parentFlushed&&e.partialBoundaries.push(s))}finally{t.replay=o,t.blockedSegment=null}}function kr(e,t,n,i){null!==t.replay&&"number"==typeof t.replay.slots?Cr(e,t,t.replay.slots,n,i):(t.node=n,t.childIndex=i,n=t.componentStack,yr(t),Rr(e,t),t.componentStack=n)}function Rr(e,t){var n=t.node,i=t.childIndex;if(null!==n){if("object"==typeof n){switch(n.$$typeof){case s:var r=n.type,l=n.key,c=n.props,d=void 0!==(n=c.ref)?n:null,u=ri(r),m=null==l?-1===i?0:i:l;if(l=[t.keyPath,u,m],null!==t.replay)e:{var p=t.replay;for(i=p.nodes,n=0;n<i.length;n++){var v=i[n];if(m===v[1]){if(4===v.length){if(null!==u&&u!==v[0])throw Error(o(490,v[0],u));var f=v[2];u=v[3],m=t.node,t.replay={nodes:f,slots:u,pendingTasks:1};try{if(Ar(e,t,l,r,c,d),1===t.replay.pendingTasks&&0<t.replay.nodes.length)throw Error(o(488));t.replay.pendingTasks--}catch(n){if("object"==typeof n&&null!==n&&(n===yi||"function"==typeof n.then))throw t.node===m&&(t.replay=p),n;t.replay.pendingTasks--,c=br(t.componentStack),Or(e,l=t.blockedBoundary,f,u,r=n,c=Er(e,r,c))}t.replay=p}else{if(r!==g)throw Error(o(490,"Suspense",ri(r)||"Unknown"));t:{p=void 0,r=v[5],d=v[2],u=v[3],m=null===v[4]?[]:v[4][2],v=null===v[4]?null:v[4][3];var y=t.keyPath,b=t.replay,E=t.blockedBoundary,w=t.hoistableState,S=c.children,C=c.fallback,k=new Set;(c=2>t.formatContext.insertionMode?gr(0,k,Ee(),Ee()):gr(0,k,null,null)).parentFlushed=!0,c.rootSegmentID=r,t.blockedBoundary=c,t.hoistableState=c.contentState,t.keyPath=l,t.replay={nodes:d,slots:u,pendingTasks:1};try{if(Dr(e,t,S,-1),1===t.replay.pendingTasks&&0<t.replay.nodes.length)throw Error(o(488));if(t.replay.pendingTasks--,0===c.pendingTasks&&0===c.status){c.status=1,e.completedBoundaries.push(c);break t}}catch(n){c.status=4,p=Er(e,n,f=br(t.componentStack)),c.errorDigest=p,t.replay.pendingTasks--,e.clientRenderedBoundaries.push(c)}finally{t.blockedBoundary=E,t.hoistableState=w,t.replay=b,t.keyPath=y}yr(t=fr(e,null,{nodes:m,slots:v,pendingTasks:0},C,-1,E,c.fallbackState,k,[l[0],"Suspense Fallback",l[2]],t.formatContext,t.context,t.treeContext,t.componentStack,!0)),e.pingedTasks.push(t)}}i.splice(n,1);break e}}}else Ar(e,t,l,r,c,d);return;case a:throw Error(o(257));case _:if(n=(f=n._init)(n._payload),12===e.status)throw null;return void kr(e,t,n,i)}if(A(n))return void Ir(e,t,n,i);if(null===n||"object"!=typeof n?f=null:f="function"==typeof(f=x&&n[x]||n["@@iterator"])?f:null,f&&(f=f.call(n))){if(!(n=f.next()).done){c=[];do{c.push(n.value),n=f.next()}while(!n.done);Ir(e,t,c,i)}return}if("function"==typeof n.then)return t.thenableState=null,kr(e,t,Xi(n),i);if(n.$$typeof===h)return kr(e,t,n._currentValue,i);throw i=Object.prototype.toString.call(n),Error(o(31,"[object Object]"===i?"object with keys {"+Object.keys(n).join(", ")+"}":i))}"string"==typeof n?null!==(i=t.blockedSegment)&&(i.lastPushedText=Ce(i.chunks,n,e.renderState,i.lastPushedText)):"number"!=typeof n&&"bigint"!=typeof n||null!==(i=t.blockedSegment)&&(i.lastPushedText=Ce(i.chunks,""+n,e.renderState,i.lastPushedText))}}function Ir(e,t,n,i){var r=t.keyPath;if(-1===i||(t.keyPath=[t.keyPath,"Fragment",i],null===t.replay)){if(s=t.treeContext,a=n.length,null!==t.replay&&(null!==(l=t.replay.slots)&&"object"==typeof l)){for(i=0;i<a;i++)c=n[i],t.treeContext=gi(s,a,i),"number"==typeof(d=l[i])?(Cr(e,t,d,c,i),delete l[i]):Dr(e,t,c,i);return t.treeContext=s,void(t.keyPath=r)}for(l=0;l<a;l++)i=n[l],t.treeContext=gi(s,a,l),Dr(e,t,i,l);t.treeContext=s,t.keyPath=r}else{for(var s=t.replay,a=s.nodes,l=0;l<a.length;l++){var c=a[l];if(c[1]===i){i=c[2],c=c[3],t.replay={nodes:i,slots:c,pendingTasks:1};try{if(Ir(e,t,n,-1),1===t.replay.pendingTasks&&0<t.replay.nodes.length)throw Error(o(488));t.replay.pendingTasks--}catch(r){if("object"==typeof r&&null!==r&&(r===yi||"function"==typeof r.then))throw r;t.replay.pendingTasks--,n=br(t.componentStack);var d=t.blockedBoundary;Or(e,d,i,c,r,n=Er(e,r,n))}t.replay=s,a.splice(l,1);break}}t.keyPath=r}}function Tr(e,t){null!==(e=e.trackedPostpones)&&(null!==(t=t.trackedContentKeyPath)&&(void 0!==(t=e.workingMap.get(t))&&(t.length=4,t[2]=[],t[3]=null)))}function Pr(e,t,n){return fr(e,n,t.replay,t.node,t.childIndex,t.blockedBoundary,t.hoistableState,t.abortSet,t.keyPath,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)}function Nr(e,t,n){var i=t.blockedSegment,r=_r(0,i.chunks.length,null,t.formatContext,i.lastPushedText,!0);return i.children.push(r),i.lastPushedText=!1,vr(e,n,t.node,t.childIndex,t.blockedBoundary,r,t.blockedPreamble,t.hoistableState,t.abortSet,t.keyPath,t.formatContext,t.context,t.treeContext,t.componentStack,t.isFallback)}function Dr(e,t,n,i){var r=t.formatContext,o=t.context,s=t.keyPath,a=t.treeContext,l=t.componentStack,c=t.blockedSegment;if(null===c)try{return kr(e,t,n,i)}catch(c){if(Hi(),"object"==typeof(n=c===yi?wi():c)&&null!==n){if("function"==typeof n.then)return e=Pr(e,t,i=zi()).ping,n.then(e,e),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void mi(o);if("Maximum call stack size exceeded"===n.message)return n=Pr(e,t,n=zi()),e.pingedTasks.push(n),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void mi(o)}}else{var d=c.children.length,u=c.chunks.length;try{return kr(e,t,n,i)}catch(m){if(Hi(),c.children.length=d,c.chunks.length=u,"object"==typeof(n=m===yi?wi():m)&&null!==n){if("function"==typeof n.then)return e=Nr(e,t,i=zi()).ping,n.then(e,e),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void mi(o);if("Maximum call stack size exceeded"===n.message)return n=Nr(e,t,n=zi()),e.pingedTasks.push(n),t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,t.componentStack=l,void mi(o)}}}throw t.formatContext=r,t.context=o,t.keyPath=s,t.treeContext=a,mi(o),n}function Mr(e){var t=e.blockedBoundary;null!==(e=e.blockedSegment)&&(e.status=3,jr(this,t,e))}function Or(e,t,n,i,r,s){for(var a=0;a<n.length;a++){var l=n[a];if(4===l.length)Or(e,t,l[2],l[3],r,s);else{l=l[5];var c=e,d=s,u=gr(0,new Set,null,null);u.parentFlushed=!0,u.rootSegmentID=l,u.status=4,u.errorDigest=d,u.parentFlushed&&c.clientRenderedBoundaries.push(u)}}if(n.length=0,null!==i){if(null===t)throw Error(o(487));if(4!==t.status&&(t.status=4,t.errorDigest=s,t.parentFlushed&&e.clientRenderedBoundaries.push(t)),"object"==typeof i)for(var m in i)delete i[m]}}function Fr(e,t,n){var i=e.blockedBoundary,r=e.blockedSegment;if(null!==r){if(6===r.status)return;r.status=3}if(r=br(e.componentStack),null===i){if(13!==t.status&&14!==t.status){if(null===(i=e.replay))return Er(t,n,r),void wr(t,n);i.pendingTasks--,0===i.pendingTasks&&0<i.nodes.length&&(e=Er(t,n,r),Or(t,null,i.nodes,i.slots,n,e)),t.pendingRootTasks--,0===t.pendingRootTasks&&Ur(t)}}else i.pendingTasks--,4!==i.status&&(i.status=4,e=Er(t,n,r),i.status=4,i.errorDigest=e,Tr(t,i),i.parentFlushed&&t.clientRenderedBoundaries.push(i)),i.fallbackAbortableTasks.forEach(function(e){return Fr(e,t,n)}),i.fallbackAbortableTasks.clear();t.allPendingTasks--,0===t.allPendingTasks&&Br(t)}function Lr(e,t){try{var n=e.renderState,i=n.onHeaders;if(i){var r=n.headers;if(r){n.headers=null;var o=r.preconnects;if(r.fontPreloads&&(o&&(o+=", "),o+=r.fontPreloads),r.highImagePreloads&&(o&&(o+=", "),o+=r.highImagePreloads),!t){var s=n.styles.values(),a=s.next();e:for(;0<r.remainingCapacity&&!a.done;a=s.next())for(var l=a.value.sheets.values(),c=l.next();0<r.remainingCapacity&&!c.done;c=l.next()){var d=c.value,u=d.props,m=u.href,h=d.props,p=Jn(h.href,"style",{crossOrigin:h.crossOrigin,integrity:h.integrity,nonce:h.nonce,type:h.type,fetchPriority:h.fetchPriority,referrerPolicy:h.referrerPolicy,media:h.media});if(!(0<=(r.remainingCapacity-=p.length+2)))break e;n.resets.style[m]=se,o&&(o+=", "),o+=p,n.resets.style[m]="string"==typeof u.crossOrigin||"string"==typeof u.integrity?[u.crossOrigin,u.integrity]:se}}i(o?{Link:o}:{})}}}catch(t){Er(e,t,{})}}function Ur(e){null===e.trackedPostpones&&Lr(e,!0),null===e.trackedPostpones&&Gr(e),e.onShellError=dr,(e=e.onShellReady)()}function Br(e){Lr(e,null===e.trackedPostpones||(null===e.completedRootSegment||5!==e.completedRootSegment.status)),Gr(e),(e=e.onAllReady)()}function Vr(e,t){if(0===t.chunks.length&&1===t.children.length&&null===t.children[0].boundary&&-1===t.children[0].id){var n=t.children[0];n.id=t.id,n.parentFlushed=!0,1===n.status&&Vr(e,n)}else e.completedSegments.push(t)}function jr(e,t,n){if(null===t){if(null!==n&&n.parentFlushed){if(null!==e.completedRootSegment)throw Error(o(389));e.completedRootSegment=n}e.pendingRootTasks--,0===e.pendingRootTasks&&Ur(e)}else t.pendingTasks--,4!==t.status&&(0===t.pendingTasks?(0===t.status&&(t.status=1),null!==n&&n.parentFlushed&&1===n.status&&Vr(t,n),t.parentFlushed&&e.completedBoundaries.push(t),1===t.status&&(t.fallbackAbortableTasks.forEach(Mr,e),t.fallbackAbortableTasks.clear(),0===e.pendingRootTasks&&null===e.trackedPostpones&&null!==t.contentPreamble&&Gr(e))):null!==n&&n.parentFlushed&&1===n.status&&(Vr(t,n),1===t.completedSegments.length&&t.parentFlushed&&e.partialBoundaries.push(t)));e.allPendingTasks--,0===e.allPendingTasks&&Br(e)}function zr(e){if(14!==e.status&&13!==e.status){var t=si,n=ne.H;ne.H=nr;var i=ne.A;ne.A=rr;var r=hr;hr=e;var s=ir;ir=e.resumableState;try{var a,l=e.pingedTasks;for(a=0;a<l.length;a++){var c=l[a],d=e,u=c.blockedSegment;if(null===u){var m=d;if(0!==c.replay.pendingTasks){mi(c.context);try{if("number"==typeof c.replay.slots?Cr(m,c,c.replay.slots,c.node,c.childIndex):Rr(m,c),1===c.replay.pendingTasks&&0<c.replay.nodes.length)throw Error(o(488));c.replay.pendingTasks--,c.abortSet.delete(c),jr(m,c.blockedBoundary,null)}catch(e){Hi();var h=e===yi?wi():e;if("object"==typeof h&&null!==h&&"function"==typeof h.then){var p=c.ping;h.then(p,p),c.thenableState=zi()}else{c.replay.pendingTasks--,c.abortSet.delete(c);var g=br(c.componentStack);d=void 0;var v=m,f=c.blockedBoundary,_=12===m.status?m.fatalError:h;Or(v,f,c.replay.nodes,c.replay.slots,_,d=Er(v,_,g)),m.pendingRootTasks--,0===m.pendingRootTasks&&Ur(m),m.allPendingTasks--,0===m.allPendingTasks&&Br(m)}}}}else if(m=void 0,0===(v=u).status){v.status=6,mi(c.context);var y=v.children.length,b=v.chunks.length;try{Rr(d,c),v.lastPushedText&&v.textEmbedded&&v.chunks.push(Ae),c.abortSet.delete(c),v.status=1,jr(d,c.blockedBoundary,v)}catch(e){Hi(),v.children.length=y,v.chunks.length=b;var E=e===yi?wi():12===d.status?d.fatalError:e;if("object"==typeof E&&null!==E&&"function"==typeof E.then){v.status=0,c.thenableState=zi();var w=c.ping;E.then(w,w)}else{var S=br(c.componentStack);c.abortSet.delete(c),v.status=4;var x=c.blockedBoundary;m=Er(d,E,S),null===x?wr(d,E):(x.pendingTasks--,4!==x.status&&(x.status=4,x.errorDigest=m,Tr(d,x),x.parentFlushed&&d.clientRenderedBoundaries.push(x),0===d.pendingRootTasks&&null===d.trackedPostpones&&null!==x.contentPreamble&&Gr(d))),d.allPendingTasks--,0===d.allPendingTasks&&Br(d)}}}}l.splice(0,a),null!==e.destination&&Xr(e,e.destination)}catch(t){Er(e,t,{}),wr(e,t)}finally{ir=s,ne.H=n,ne.A=i,n===nr&&mi(t),hr=r}}}function Hr(e,t,n){t.preambleChildren.length&&n.push(t.preambleChildren);for(var i=!1,r=0;r<t.children.length;r++)i=Wr(e,t.children[r],n)||i;return i}function Wr(e,t,n){var i=t.boundary;if(null===i)return Hr(e,t,n);var r=i.contentPreamble,s=i.fallbackPreamble;if(null===r||null===s)return!1;switch(i.status){case 1:if(gt(e.renderState,r),!(t=i.completedSegments[0]))throw Error(o(391));return Hr(e,t,n);case 5:if(null!==e.trackedPostpones)return!0;case 4:if(1===t.status)return gt(e.renderState,s),Hr(e,t,n);default:return!0}}function Gr(e){if(e.completedRootSegment&&null===e.completedPreambleSegments){var t=[],n=Wr(e,e.completedRootSegment,t),i=e.renderState.preamble;(!1===n||i.headChunks&&i.bodyChunks)&&(e.completedPreambleSegments=t)}}function Kr(e,t,n,i){switch(n.parentFlushed=!0,n.status){case 0:n.id=e.nextSegmentId++;case 5:return i=n.id,n.lastPushedText=!1,n.textEmbedded=!1,e=e.renderState,O(t,ft),O(t,e.placeholderPrefix),O(t,e=B(i.toString(16))),F(t,_t);case 1:n.status=2;var r=!0,s=n.chunks,a=0;n=n.children;for(var l=0;l<n.length;l++){for(r=n[l];a<r.index;a++)O(t,s[a]);r=qr(e,t,r,i)}for(;a<s.length-1;a++)O(t,s[a]);return a<s.length&&(r=F(t,s[a])),r;default:throw Error(o(390))}}function qr(e,t,n,i){var r=n.boundary;if(null===r)return Kr(e,t,n,i);if(r.parentFlushed=!0,4===r.status){var s=r.errorDigest;return F(t,wt),O(t,xt),s&&(O(t,Ct),O(t,B(X(s))),O(t,At)),F(t,kt),Kr(e,t,n,i),(e=r.fallbackPreamble)&&Pt(t,e),F(t,St)}if(1!==r.status)return 0===r.status&&(r.rootSegmentID=e.nextSegmentId++),0<r.completedSegments.length&&e.partialBoundaries.push(r),Rt(t,e.renderState,r.rootSegmentID),i&&((r=r.fallbackState).styles.forEach(ei,i),r.stylesheets.forEach(ti,i)),Kr(e,t,n,i),F(t,St);if(r.byteSize>e.progressiveChunkSize)return r.rootSegmentID=e.nextSegmentId++,e.completedBoundaries.push(r),Rt(t,e.renderState,r.rootSegmentID),Kr(e,t,n,i),F(t,St);if(i&&((n=r.contentState).styles.forEach(ei,i),n.stylesheets.forEach(ti,i)),F(t,yt),1!==(n=r.completedSegments).length)throw Error(o(391));return qr(e,t,n[0],i),(e=r.contentPreamble)&&Pt(t,e),F(t,St)}function $r(e,t,n,i){return function(e,t,n,i){switch(n.insertionMode){case 0:case 1:case 3:case 2:return O(e,Nt),O(e,t.segmentPrefix),O(e,B(i.toString(16))),F(e,Dt);case 4:return O(e,Ot),O(e,t.segmentPrefix),O(e,B(i.toString(16))),F(e,Ft);case 5:return O(e,Ut),O(e,t.segmentPrefix),O(e,B(i.toString(16))),F(e,Bt);case 6:return O(e,jt),O(e,t.segmentPrefix),O(e,B(i.toString(16))),F(e,zt);case 7:return O(e,Wt),O(e,t.segmentPrefix),O(e,B(i.toString(16))),F(e,Gt);case 8:return O(e,qt),O(e,t.segmentPrefix),O(e,B(i.toString(16))),F(e,$t);case 9:return O(e,Yt),O(e,t.segmentPrefix),O(e,B(i.toString(16))),F(e,Xt);default:throw Error(o(397))}}(t,e.renderState,n.parentFormatContext,n.id),qr(e,t,n,i),function(e,t){switch(t.insertionMode){case 0:case 1:case 3:case 2:return F(e,Mt);case 4:return F(e,Lt);case 5:return F(e,Vt);case 6:return F(e,Ht);case 7:return F(e,Kt);case 8:return F(e,Jt);case 9:return F(e,Qt);default:throw Error(o(397))}}(t,n.parentFormatContext)}function Jr(e,t,n){for(var i=n.completedSegments,r=0;r<i.length;r++)Yr(e,t,n,i[r]);i.length=0,Tn(t,n.contentState,e.renderState),i=e.resumableState,e=e.renderState,r=n.rootSegmentID,n=n.contentState;var s=e.stylesToHoist;return e.stylesToHoist=!1,O(t,e.startInlineScript),s?2&i.instructions?8&i.instructions?O(t,ln):(i.instructions|=8,O(t,an)):(i.instructions|=10,O(t,sn)):2&i.instructions?O(t,on):(i.instructions|=2,O(t,rn)),i=B(r.toString(16)),O(t,e.boundaryPrefix),O(t,i),O(t,cn),O(t,e.segmentPrefix),O(t,i),s?(O(t,dn),function(e,t){O(e,zn);var n=zn;t.stylesheets.forEach(function(t){if(2!==t.state)if(3===t.state)O(e,n),O(e,B(En(""+t.props.href))),O(e,Gn),n=Hn;else{O(e,n);var i=t.props["data-precedence"],r=t.props,s=te(""+t.props.href);for(var a in O(e,B(En(s))),i=""+i,O(e,Wn),O(e,B(En(i))),r)if(H.call(r,a)&&null!=(i=r[a]))switch(a){case"href":case"rel":case"precedence":case"data-precedence":break;case"children":case"dangerouslySetInnerHTML":throw Error(o(399,"link"));default:Kn(e,a,i)}O(e,Gn),n=Hn,t.state=3}}),O(e,Gn)}(t,n)):O(t,un),n=F(t,mn),vt(t,e)&&n}function Yr(e,t,n,i){if(2===i.status)return!0;var r=n.contentState,s=i.id;if(-1===s){if(-1===(i.id=n.rootSegmentID))throw Error(o(392));return $r(e,t,i,r)}return s===n.rootSegmentID?$r(e,t,i,r):($r(e,t,i,r),n=e.resumableState,O(t,(e=e.renderState).startInlineScript),1&n.instructions?O(t,en):(n.instructions|=1,O(t,Zt)),O(t,e.segmentPrefix),O(t,s=B(s.toString(16))),O(t,tn),O(t,e.placeholderPrefix),O(t,s),t=F(t,nn))}function Xr(e,t){D=new Uint8Array(2048),M=0;try{if(!(0<e.pendingRootTasks)){var n,i=e.completedRootSegment;if(null!==i){if(5===i.status)return;var r=e.completedPreambleSegments;if(null===r)return;var o,s=e.renderState,a=s.preamble,l=a.htmlChunks,c=a.headChunks;if(l){for(o=0;o<l.length;o++)O(t,l[o]);if(c)for(o=0;o<c.length;o++)O(t,c[o]);else O(t,dt("head")),O(t,Ge)}else if(c)for(o=0;o<c.length;o++)O(t,c[o]);var d=s.charsetChunks;for(o=0;o<d.length;o++)O(t,d[o]);d.length=0,s.preconnects.forEach(Pn,t),s.preconnects.clear();var u=s.viewportChunks;for(o=0;o<u.length;o++)O(t,u[o]);u.length=0,s.fontPreloads.forEach(Pn,t),s.fontPreloads.clear(),s.highImagePreloads.forEach(Pn,t),s.highImagePreloads.clear(),s.styles.forEach(Bn,t);var m=s.importMapChunks;for(o=0;o<m.length;o++)O(t,m[o]);m.length=0,s.bootstrapScripts.forEach(Pn,t),s.scripts.forEach(Pn,t),s.scripts.clear(),s.bulkPreloads.forEach(Pn,t),s.bulkPreloads.clear();var h=s.hoistableChunks;for(o=0;o<h.length;o++)O(t,h[o]);for(s=h.length=0;s<r.length;s++){var p=r[s];for(a=0;a<p.length;a++)qr(e,t,p[a],null)}var g=e.renderState.preamble,v=g.headChunks;(g.htmlChunks||v)&&O(t,pt("head"));var f=g.bodyChunks;if(f)for(r=0;r<f.length;r++)O(t,f[r]);qr(e,t,i,null),e.completedRootSegment=null,vt(t,e.renderState)}var _=e.renderState;i=0;var y=_.viewportChunks;for(i=0;i<y.length;i++)O(t,y[i]);y.length=0,_.preconnects.forEach(Pn,t),_.preconnects.clear(),_.fontPreloads.forEach(Pn,t),_.fontPreloads.clear(),_.highImagePreloads.forEach(Pn,t),_.highImagePreloads.clear(),_.styles.forEach(jn,t),_.scripts.forEach(Pn,t),_.scripts.clear(),_.bulkPreloads.forEach(Pn,t),_.bulkPreloads.clear();var b=_.hoistableChunks;for(i=0;i<b.length;i++)O(t,b[i]);b.length=0;var E=e.clientRenderedBoundaries;for(n=0;n<E.length;n++){var w=E[n];_=t;var S=e.resumableState,x=e.renderState,A=w.rootSegmentID,C=w.errorDigest;O(_,x.startInlineScript),4&S.instructions?O(_,pn):(S.instructions|=4,O(_,hn)),O(_,x.boundaryPrefix),O(_,B(A.toString(16))),O(_,gn),C&&(O(_,vn),O(_,B(yn(C||""))));var k=F(_,fn);if(!k)return e.destination=null,n++,void E.splice(0,n)}E.splice(0,n);var R=e.completedBoundaries;for(n=0;n<R.length;n++)if(!Jr(e,t,R[n]))return e.destination=null,n++,void R.splice(0,n);R.splice(0,n),L(t),D=new Uint8Array(2048),M=0;var I=e.partialBoundaries;for(n=0;n<I.length;n++){var T=I[n];e:{E=e,w=t;var P=T.completedSegments;for(k=0;k<P.length;k++)if(!Yr(E,w,T,P[k])){k++,P.splice(0,k);var N=!1;break e}P.splice(0,k),N=Tn(w,T.contentState,E.renderState)}if(!N)return e.destination=null,n++,void I.splice(0,n)}I.splice(0,n);var U=e.completedBoundaries;for(n=0;n<U.length;n++)if(!Jr(e,t,U[n]))return e.destination=null,n++,void U.splice(0,n);U.splice(0,n)}}finally{0===e.allPendingTasks&&0===e.pingedTasks.length&&0===e.clientRenderedBoundaries.length&&0===e.completedBoundaries.length?(e.flushScheduled=!1,(n=e.resumableState).hasBody&&O(t,pt("body")),n.hasHtml&&O(t,pt("html")),L(t),e.status=14,t.close(),e.destination=null):L(t)}}function Qr(e){e.flushScheduled=null!==e.destination,N(function(){return zr(e)}),I(function(){10===e.status&&(e.status=11),null===e.trackedPostpones&&Lr(e,0===e.pendingRootTasks)})}function Zr(e){!1===e.flushScheduled&&0===e.pingedTasks.length&&null!==e.destination&&(e.flushScheduled=!0,I(function(){var t=e.destination;t?Xr(e,t):e.flushScheduled=!1}))}function eo(e,t){if(13===e.status)e.status=14,j(t,e.fatalError);else if(14!==e.status&&null===e.destination){e.destination=t;try{Xr(e,t)}catch(t){Er(e,t,{}),wr(e,t)}}}function to(e,t){11!==e.status&&10!==e.status||(e.status=12);try{var n=e.abortableTasks;if(0<n.size){var i=void 0===t?Error(o(432)):"object"==typeof t&&null!==t&&"function"==typeof t.then?Error(o(530)):t;e.fatalError=i,n.forEach(function(t){return Fr(t,e,i)}),n.clear()}null!==e.destination&&Xr(e,e.destination)}catch(t){Er(e,t,{}),wr(e,t)}}function no(){var e=i.version;if("19.1.1"!==e)throw Error(o(527,e,"19.1.1"))}no(),no(),t.prerender=function(e,t){return new Promise(function(n,i){var r,o=t?t.onHeaders:void 0;o&&(r=function(e){o(new Headers(e))});var s=be(t?t.identifierPrefix:void 0,t&&t.unstable_externalRuntimeSrc,t?t.bootstrapScriptContent:void 0,t?t.bootstrapScripts:void 0,t?t.bootstrapModules:void 0),a=function(e,t,n,i,r,o,s,a,l,c,d){return(e=mr(e,t,n,i,r,o,s,a,l,c,d,void 0)).trackedPostpones={workingMap:new Map,rootNodes:[],rootSlots:null},e}(e,s,ye(s,void 0,t?t.unstable_externalRuntimeSrc:void 0,t?t.importMap:void 0,r,t?t.maxHeadersLength:void 0),Se(t?t.namespaceURI:void 0),t?t.progressiveChunkSize:void 0,t?t.onError:void 0,function(){var e={prelude:new ReadableStream({type:"bytes",pull:function(e){eo(a,e)},cancel:function(e){a.destination=null,to(a,e)}},{highWaterMark:0})};n(e)},void 0,void 0,i,t?t.onPostpone:void 0);if(t&&t.signal){var l=t.signal;if(l.aborted)to(a,l.reason);else{var c=function(){to(a,l.reason),l.removeEventListener("abort",c)};l.addEventListener("abort",c)}}Qr(a)})},t.renderToReadableStream=function(e,t){return new Promise(function(n,i){var r,o,s,a=new Promise(function(e,t){o=e,r=t}),l=t?t.onHeaders:void 0;l&&(s=function(e){l(new Headers(e))});var c=be(t?t.identifierPrefix:void 0,t&&t.unstable_externalRuntimeSrc,t?t.bootstrapScriptContent:void 0,t?t.bootstrapScripts:void 0,t?t.bootstrapModules:void 0),d=mr(e,c,ye(c,t?t.nonce:void 0,t?t.unstable_externalRuntimeSrc:void 0,t?t.importMap:void 0,s,t?t.maxHeadersLength:void 0),Se(t?t.namespaceURI:void 0),t?t.progressiveChunkSize:void 0,t?t.onError:void 0,o,function(){var e=new ReadableStream({type:"bytes",pull:function(e){eo(d,e)},cancel:function(e){d.destination=null,to(d,e)}},{highWaterMark:0});e.allReady=a,n(e)},function(e){a.catch(function(){}),i(e)},r,t?t.onPostpone:void 0,t?t.formState:void 0);if(t&&t.signal){var u=t.signal;if(u.aborted)to(d,u.reason);else{var m=function(){to(d,u.reason),u.removeEventListener("abort",m)};u.addEventListener("abort",m)}}Qr(d)})},t.version="19.1.1"},"./node_modules/react-dom/server.browser.js":(e,t,n)=>{"use strict";var i,r;i=n("./node_modules/react-dom/cjs/react-dom-server-legacy.browser.production.js"),r=n("./node_modules/react-dom/cjs/react-dom-server.browser.production.js"),i.version,i.renderToString,t.qV=i.renderToStaticMarkup,r.renderToReadableStream,r.resume&&r.resume},"./node_modules/react-is/cjs/react-is.production.min.js":(e,t)=>{"use strict";var n="function"==typeof Symbol&&Symbol.for,i=n?Symbol.for("react.element"):60103,r=n?Symbol.for("react.portal"):60106,o=n?Symbol.for("react.fragment"):60107,s=n?Symbol.for("react.strict_mode"):60108,a=n?Symbol.for("react.profiler"):60114,l=n?Symbol.for("react.provider"):60109,c=n?Symbol.for("react.context"):60110,d=n?Symbol.for("react.async_mode"):60111,u=n?Symbol.for("react.concurrent_mode"):60111,m=n?Symbol.for("react.forward_ref"):60112,h=n?Symbol.for("react.suspense"):60113,p=n?Symbol.for("react.suspense_list"):60120,g=n?Symbol.for("react.memo"):60115,v=n?Symbol.for("react.lazy"):60116,f=n?Symbol.for("react.block"):60121,_=n?Symbol.for("react.fundamental"):60117,y=n?Symbol.for("react.responder"):60118,b=n?Symbol.for("react.scope"):60119;function E(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case i:switch(e=e.type){case d:case u:case o:case a:case s:case h:return e;default:switch(e=e&&e.$$typeof){case c:case m:case v:case g:case l:return e;default:return t}}case r:return t}}}function w(e){return E(e)===u}t.AsyncMode=d,t.ConcurrentMode=u,t.ContextConsumer=c,t.ContextProvider=l,t.Element=i,t.ForwardRef=m,t.Fragment=o,t.Lazy=v,t.Memo=g,t.Portal=r,t.Profiler=a,t.StrictMode=s,t.Suspense=h,t.isAsyncMode=function(e){return w(e)||E(e)===d},t.isConcurrentMode=w,t.isContextConsumer=function(e){return E(e)===c},t.isContextProvider=function(e){return E(e)===l},t.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===i},t.isForwardRef=function(e){return E(e)===m},t.isFragment=function(e){return E(e)===o},t.isLazy=function(e){return E(e)===v},t.isMemo=function(e){return E(e)===g},t.isPortal=function(e){return E(e)===r},t.isProfiler=function(e){return E(e)===a},t.isStrictMode=function(e){return E(e)===s},t.isSuspense=function(e){return E(e)===h},t.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===o||e===u||e===a||e===s||e===h||e===p||"object"==typeof e&&null!==e&&(e.$$typeof===v||e.$$typeof===g||e.$$typeof===l||e.$$typeof===c||e.$$typeof===m||e.$$typeof===_||e.$$typeof===y||e.$$typeof===b||e.$$typeof===f)},t.typeOf=E},"./node_modules/react-is/index.js":(e,t,n)=>{"use strict";e.exports=n("./node_modules/react-is/cjs/react-is.production.min.js")},"./node_modules/react-redux/node_modules/react-is/cjs/react-is.production.min.js":(e,t)=>{"use strict";var n=60103,i=60106,r=60107,o=60108,s=60114,a=60109,l=60110,c=60112,d=60113,u=60120,m=60115,h=60116,p=60121,g=60122,v=60117,f=60129,_=60131;if("function"==typeof Symbol&&Symbol.for){var y=Symbol.for;n=y("react.element"),i=y("react.portal"),r=y("react.fragment"),o=y("react.strict_mode"),s=y("react.profiler"),a=y("react.provider"),l=y("react.context"),c=y("react.forward_ref"),d=y("react.suspense"),u=y("react.suspense_list"),m=y("react.memo"),h=y("react.lazy"),p=y("react.block"),g=y("react.server.block"),v=y("react.fundamental"),f=y("react.debug_trace_mode"),_=y("react.legacy_hidden")}function b(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case n:switch(e=e.type){case r:case s:case o:case d:case u:return e;default:switch(e=e&&e.$$typeof){case l:case c:case h:case m:case a:return e;default:return t}}case i:return t}}}t.isContextConsumer=function(e){return b(e)===l}},"./node_modules/react-redux/node_modules/react-is/index.js":(e,t,n)=>{"use strict";e.exports=n("./node_modules/react-redux/node_modules/react-is/cjs/react-is.production.min.js")},"./node_modules/reflect-metadata/Reflect.js":(e,t,n)=>{var i,r=n("./node_modules/process/browser.js");!function(e){!function(){var t="object"==typeof n.g?n.g:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),i=o(e);function o(e,t){return function(n,i){"function"!=typeof e[n]&&Object.defineProperty(e,n,{configurable:!0,writable:!0,value:i}),t&&t(n,i)}}void 0===t.Reflect?t.Reflect=e:i=o(t.Reflect,i),function(e){var t=Object.prototype.hasOwnProperty,n="function"==typeof Symbol,i=n&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",o=n&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",s="function"==typeof Object.create,a={__proto__:[]}instanceof Array,l=!s&&!a,c={create:s?function(){return re(Object.create(null))}:a?function(){return re({__proto__:null})}:function(){return re({})},has:l?function(e,n){return t.call(e,n)}:function(e,t){return t in e},get:l?function(e,n){return t.call(e,n)?e[n]:void 0}:function(e,t){return e[t]}},d=Object.getPrototypeOf(Function),u="object"==typeof r&&r.env&&"true"===r.env.REFLECT_METADATA_USE_MAP_POLYFILL,m=u||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?te():Map,h=u||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?ne():Set,p=new(u||"function"!=typeof WeakMap?ie():WeakMap);function g(e,t,n,i){if(F(n)){if(!G(e))throw new TypeError;if(!q(t))throw new TypeError;return A(e,t)}if(!G(e))throw new TypeError;if(!B(t))throw new TypeError;if(!B(i)&&!F(i)&&!L(i))throw new TypeError;return L(i)&&(i=void 0),C(e,t,n=W(n),i)}function v(e,t){function n(n,i){if(!B(n))throw new TypeError;if(!F(i)&&!$(i))throw new TypeError;N(e,t,n,i)}return n}function f(e,t,n,i){if(!B(n))throw new TypeError;return F(i)||(i=W(i)),N(e,t,n,i)}function _(e,t,n){if(!B(t))throw new TypeError;return F(n)||(n=W(n)),R(e,t,n)}function y(e,t,n){if(!B(t))throw new TypeError;return F(n)||(n=W(n)),I(e,t,n)}function b(e,t,n){if(!B(t))throw new TypeError;return F(n)||(n=W(n)),T(e,t,n)}function E(e,t,n){if(!B(t))throw new TypeError;return F(n)||(n=W(n)),P(e,t,n)}function w(e,t){if(!B(e))throw new TypeError;return F(t)||(t=W(t)),D(e,t)}function S(e,t){if(!B(e))throw new TypeError;return F(t)||(t=W(t)),M(e,t)}function x(e,t,n){if(!B(t))throw new TypeError;F(n)||(n=W(n));var i=k(t,n,!1);if(F(i))return!1;if(!i.delete(e))return!1;if(i.size>0)return!0;var r=p.get(t);return r.delete(n),r.size>0||p.delete(t),!0}function A(e,t){for(var n=e.length-1;n>=0;--n){var i=(0,e[n])(t);if(!F(i)&&!L(i)){if(!q(i))throw new TypeError;t=i}}return t}function C(e,t,n,i){for(var r=e.length-1;r>=0;--r){var o=(0,e[r])(t,n,i);if(!F(o)&&!L(o)){if(!B(o))throw new TypeError;i=o}}return i}function k(e,t,n){var i=p.get(e);if(F(i)){if(!n)return;i=new m,p.set(e,i)}var r=i.get(t);if(F(r)){if(!n)return;r=new m,i.set(t,r)}return r}function R(e,t,n){if(I(e,t,n))return!0;var i=ee(t);return!L(i)&&R(e,i,n)}function I(e,t,n){var i=k(t,n,!1);return!F(i)&&z(i.has(e))}function T(e,t,n){if(I(e,t,n))return P(e,t,n);var i=ee(t);return L(i)?void 0:T(e,i,n)}function P(e,t,n){var i=k(t,n,!1);if(!F(i))return i.get(e)}function N(e,t,n,i){k(n,i,!0).set(e,t)}function D(e,t){var n=M(e,t),i=ee(e);if(null===i)return n;var r=D(i,t);if(r.length<=0)return n;if(n.length<=0)return r;for(var o=new h,s=[],a=0,l=n;a<l.length;a++){var c=l[a];o.has(c)||(o.add(c),s.push(c))}for(var d=0,u=r;d<u.length;d++){c=u[d];o.has(c)||(o.add(c),s.push(c))}return s}function M(e,t){var n=[],i=k(e,t,!1);if(F(i))return n;for(var r=Y(i.keys()),o=0;;){var s=Q(r);if(!s)return n.length=o,n;var a=X(s);try{n[o]=a}catch(e){try{Z(r)}finally{throw e}}o++}}function O(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function F(e){return void 0===e}function L(e){return null===e}function U(e){return"symbol"==typeof e}function B(e){return"object"==typeof e?null!==e:"function"==typeof e}function V(e,t){switch(O(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var n=3===t?"string":5===t?"number":"default",r=J(e,i);if(void 0!==r){var o=r.call(e,n);if(B(o))throw new TypeError;return o}return j(e,"default"===n?"number":n)}function j(e,t){if("string"===t){var n=e.toString;if(K(n))if(!B(r=n.call(e)))return r;if(K(i=e.valueOf))if(!B(r=i.call(e)))return r}else{var i;if(K(i=e.valueOf))if(!B(r=i.call(e)))return r;var r,o=e.toString;if(K(o))if(!B(r=o.call(e)))return r}throw new TypeError}function z(e){return!!e}function H(e){return""+e}function W(e){var t=V(e,3);return U(t)?t:H(t)}function G(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function K(e){return"function"==typeof e}function q(e){return"function"==typeof e}function $(e){switch(O(e)){case 3:case 4:return!0;default:return!1}}function J(e,t){var n=e[t];if(null!=n){if(!K(n))throw new TypeError;return n}}function Y(e){var t=J(e,o);if(!K(t))throw new TypeError;var n=t.call(e);if(!B(n))throw new TypeError;return n}function X(e){return e.value}function Q(e){var t=e.next();return!t.done&&t}function Z(e){var t=e.return;t&&t.call(e)}function ee(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===d)return t;if(t!==d)return t;var n=e.prototype,i=n&&Object.getPrototypeOf(n);if(null==i||i===Object.prototype)return t;var r=i.constructor;return"function"!=typeof r||r===e?t:r}function te(){var e={},t=[],n=function(){function e(e,t,n){this._index=0,this._keys=e,this._values=t,this._selector=n}return e.prototype["@@iterator"]=function(){return this},e.prototype[o]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var n=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:n,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var n=this._find(e,!0);return this._values[n]=t,this},t.prototype.delete=function(t){var n=this._find(t,!1);if(n>=0){for(var i=this._keys.length,r=n+1;r<i;r++)this._keys[r-1]=this._keys[r],this._values[r-1]=this._values[r];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new n(this._keys,this._values,i)},t.prototype.values=function(){return new n(this._keys,this._values,r)},t.prototype.entries=function(){return new n(this._keys,this._values,s)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[o]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function i(e,t){return e}function r(e,t){return t}function s(e,t){return[e,t]}}function ne(){return function(){function e(){this._map=new m}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[o]=function(){return this.keys()},e}()}function ie(){var e=16,n=c.create(),i=r();return function(){function e(){this._key=r()}return e.prototype.has=function(e){var t=o(e,!1);return void 0!==t&&c.has(t,this._key)},e.prototype.get=function(e){var t=o(e,!1);return void 0!==t?c.get(t,this._key):void 0},e.prototype.set=function(e,t){return o(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=o(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=r()},e}();function r(){var e;do{e="@@WeakMap@@"+l()}while(c.has(n,e));return n[e]=!0,e}function o(e,n){if(!t.call(e,i)){if(!n)return;Object.defineProperty(e,i,{value:c.create()})}return e[i]}function s(e,t){for(var n=0;n<t;++n)e[n]=255*Math.random()|0;return e}function a(e){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):s(new Uint8Array(e),e):s(new Array(e),e)}function l(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var n="",i=0;i<e;++i){var r=t[i];4!==i&&6!==i&&8!==i||(n+="-"),r<16&&(n+="0"),n+=r.toString(16).toLowerCase()}return n}}function re(e){return e.__=void 0,delete e.__,e}e("decorate",g),e("metadata",v),e("defineMetadata",f),e("hasMetadata",_),e("hasOwnMetadata",y),e("getMetadata",b),e("getOwnMetadata",E),e("getMetadataKeys",w),e("getOwnMetadataKeys",S),e("deleteMetadata",x)}(i)}()}(i||(i={}))},"./node_modules/sanitize-filename/index.js":(e,t,n)=>{"use strict";var i=n("./node_modules/truncate-utf8-bytes/browser.js"),r=/[\/\?<>\\:\*\|"]/g,o=/[\x00-\x1f\x80-\x9f]/g,s=/^\.+$/,a=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,l=/[\. ]+$/;function c(e,t){if("string"!=typeof e)throw new Error("Input must be string");var n=e.replace(r,t).replace(o,t).replace(s,t).replace(a,t).replace(l,t);return i(n,255)}e.exports=function(e,t){var n=t&&t.replacement||"",i=c(e,n);return""===n?i:c(i,"")}},"./node_modules/seedrandom/index.js":(e,t,n)=>{var i=n("./node_modules/seedrandom/lib/alea.js"),r=n("./node_modules/seedrandom/lib/xor128.js"),o=n("./node_modules/seedrandom/lib/xorwow.js"),s=n("./node_modules/seedrandom/lib/xorshift7.js"),a=n("./node_modules/seedrandom/lib/xor4096.js"),l=n("./node_modules/seedrandom/lib/tychei.js"),c=n("./node_modules/seedrandom/seedrandom.js");c.alea=i,c.xor128=r,c.xorwow=o,c.xorshift7=s,c.xor4096=a,c.tychei=l,e.exports=c},"./node_modules/seedrandom/lib/alea.js":function(e,t,n){var i;!function(e,r){function o(e){var t=this,n=function(){var e=4022871197,t=function(t){t=String(t);for(var n=0;n<t.length;n++){var i=.02519603282416938*(e+=t.charCodeAt(n));i-=e=i>>>0,e=(i*=e)>>>0,e+=4294967296*(i-=e)}return 2.3283064365386963e-10*(e>>>0)};return t}();t.next=function(){var e=2091639*t.s0+2.3283064365386963e-10*t.c;return t.s0=t.s1,t.s1=t.s2,t.s2=e-(t.c=0|e)},t.c=1,t.s0=n(" "),t.s1=n(" "),t.s2=n(" "),t.s0-=n(e),t.s0<0&&(t.s0+=1),t.s1-=n(e),t.s1<0&&(t.s1+=1),t.s2-=n(e),t.s2<0&&(t.s2+=1),n=null}function s(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function a(e,t){var n=new o(e),i=t&&t.state,r=n.next;return r.int32=function(){return 4294967296*n.next()|0},r.double=function(){return r()+11102230246251565e-32*(2097152*r()|0)},r.quick=r,i&&("object"==typeof i&&s(i,n),r.state=function(){return s(n,{})}),r}r&&r.exports?r.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,r))||(r.exports=i):this.alea=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/tychei.js":function(e,t,n){var i;!function(e,r){function o(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,i=t.d,r=t.a;return e=e<<25^e>>>7^n,n=n-i|0,i=i<<24^i>>>8^r,r=r-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-i|0,t.d=i<<16^n>>>16^r,t.a=r-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var i=0;i<n.length+20;i++)t.b^=0|n.charCodeAt(i),t.next()}function s(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function a(e,t){var n=new o(e),i=t&&t.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},r.int32=n.next,r.quick=r,i&&("object"==typeof i&&s(i,n),r.state=function(){return s(n,{})}),r}r&&r.exports?r.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,r))||(r.exports=i):this.tychei=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xor128.js":function(e,t,n){var i;!function(e,r){function o(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var i=0;i<n.length+64;i++)t.x^=0|n.charCodeAt(i),t.next()}function s(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function a(e,t){var n=new o(e),i=t&&t.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},r.int32=n.next,r.quick=r,i&&("object"==typeof i&&s(i,n),r.state=function(){return s(n,{})}),r}r&&r.exports?r.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,r))||(r.exports=i):this.xor128=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xor4096.js":function(e,t,n){var i;!function(e,r){function o(e){var t=this;t.next=function(){var e,n,i=t.w,r=t.X,o=t.i;return t.w=i=i+1640531527|0,n=r[o+34&127],e=r[o=o+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=r[o]=n^e,t.i=o,n+(i^i>>>16)|0},function(e,t){var n,i,r,o,s,a=[],l=128;for(t===(0|t)?(i=t,t=null):(t+="\0",i=0,l=Math.max(l,t.length)),r=0,o=-32;o<l;++o)t&&(i^=t.charCodeAt((o+32)%t.length)),0===o&&(s=i),i^=i<<10,i^=i>>>15,i^=i<<4,i^=i>>>13,o>=0&&(s=s+1640531527|0,r=0==(n=a[127&o]^=i+s)?r+1:0);for(r>=128&&(a[127&(t&&t.length||0)]=-1),r=127,o=512;o>0;--o)i=a[r+34&127],n=a[r=r+1&127],i^=i<<13,n^=n<<17,i^=i>>>15,n^=n>>>12,a[r]=i^n;e.w=s,e.X=a,e.i=r}(t,e)}function s(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function a(e,t){null==e&&(e=+new Date);var n=new o(e),i=t&&t.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},r.int32=n.next,r.quick=r,i&&(i.X&&s(i,n),r.state=function(){return s(n,{})}),r}r&&r.exports?r.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,r))||(r.exports=i):this.xor4096=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xorshift7.js":function(e,t,n){var i;!function(e,r){function o(e){var t=this;t.next=function(){var e,n,i=t.x,r=t.i;return e=i[r],n=(e^=e>>>7)^e<<24,n^=(e=i[r+1&7])^e>>>10,n^=(e=i[r+3&7])^e>>>3,n^=(e=i[r+4&7])^e<<7,e=i[r+7&7],n^=(e^=e<<13)^e<<9,i[r]=n,t.i=r+1&7,n},function(e,t){var n,i=[];if(t===(0|t))i[0]=t;else for(t=""+t,n=0;n<t.length;++n)i[7&n]=i[7&n]<<15^t.charCodeAt(n)+i[n+1&7]<<13;for(;i.length<8;)i.push(0);for(n=0;n<8&&0===i[n];++n);for(8==n?i[7]=-1:i[n],e.x=i,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function s(e,t){return t.x=e.x.slice(),t.i=e.i,t}function a(e,t){null==e&&(e=+new Date);var n=new o(e),i=t&&t.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},r.int32=n.next,r.quick=r,i&&(i.x&&s(i,n),r.state=function(){return s(n,{})}),r}r&&r.exports?r.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,r))||(r.exports=i):this.xorshift7=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/lib/xorwow.js":function(e,t,n){var i;!function(e,r){function o(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var i=0;i<n.length+64;i++)t.x^=0|n.charCodeAt(i),i==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function s(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function a(e,t){var n=new o(e),i=t&&t.state,r=function(){return(n.next()>>>0)/4294967296};return r.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},r.int32=n.next,r.quick=r,i&&("object"==typeof i&&s(i,n),r.state=function(){return s(n,{})}),r}r&&r.exports?r.exports=a:n.amdD&&n.amdO?void 0===(i=function(){return a}.call(t,n,t,r))||(r.exports=i):this.xorwow=a}(0,e=n.nmd(e),n.amdD)},"./node_modules/seedrandom/seedrandom.js":function(e,t,n){var i;!function(r,o,s){var a,l=256,c=s.pow(l,6),d=s.pow(2,52),u=2*d,m=255;function h(e,t,n){var i=[],m=f(v((t=1==t?{entropy:!0}:t||{}).entropy?[e,_(o)]:null==e?function(){try{var e;return a&&(e=a.randomBytes)?e=e(l):(e=new Uint8Array(l),(r.crypto||r.msCrypto).getRandomValues(e)),_(e)}catch(e){var t=r.navigator,n=t&&t.plugins;return[+new Date,r,n,r.screen,_(o)]}}():e,3),i),h=new p(i),y=function(){for(var e=h.g(6),t=c,n=0;e<d;)e=(e+n)*l,t*=l,n=h.g(1);for(;e>=u;)e/=2,t/=2,n>>>=1;return(e+n)/t};return y.int32=function(){return 0|h.g(4)},y.quick=function(){return h.g(4)/4294967296},y.double=y,f(_(h.S),o),(t.pass||n||function(e,t,n,i){return i&&(i.S&&g(i,h),e.state=function(){return g(h,{})}),n?(s.random=e,t):e})(y,m,"global"in t?t.global:this==s,t.state)}function p(e){var t,n=e.length,i=this,r=0,o=i.i=i.j=0,s=i.S=[];for(n||(e=[n++]);r<l;)s[r]=r++;for(r=0;r<l;r++)s[r]=s[o=m&o+e[r%n]+(t=s[r])],s[o]=t;(i.g=function(e){for(var t,n=0,r=i.i,o=i.j,s=i.S;e--;)t=s[r=m&r+1],n=n*l+s[m&(s[r]=s[o=m&o+t])+(s[o]=t)];return i.i=r,i.j=o,n})(l)}function g(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function v(e,t){var n,i=[],r=typeof e;if(t&&"object"==r)for(n in e)try{i.push(v(e[n],t-1))}catch(e){}return i.length?i:"string"==r?e:e+"\0"}function f(e,t){for(var n,i=e+"",r=0;r<i.length;)t[m&r]=m&(n^=19*t[m&r])+i.charCodeAt(r++);return _(t)}function _(e){return String.fromCharCode.apply(0,e)}if(f(s.random(),o),e.exports){e.exports=h;try{a=n("?d4c0")}catch(e){}}else void 0===(i=function(){return h}.call(t,n,t,e))||(e.exports=i)}("undefined"!=typeof self?self:this,[],Math)},"./node_modules/truncate-utf8-bytes/browser.js":(e,t,n)=>{"use strict";var i=n("./node_modules/truncate-utf8-bytes/lib/truncate.js"),r=n("./node_modules/utf8-byte-length/browser.js");e.exports=i.bind(null,r)},"./node_modules/truncate-utf8-bytes/lib/truncate.js":e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e,i,r){if("string"!=typeof i)throw new Error("Input must be string");for(var o,s,a=i.length,l=0,c=0;c<a;c+=1){if(o=i.charCodeAt(c),s=i[c],t(o)&&n(i.charCodeAt(c+1))&&(s+=i[c+=1]),(l+=e(s))===r)return i.slice(0,c+1);if(l>r)return i.slice(0,c-s.length+1)}return i}},"./node_modules/utf8-byte-length/browser.js":e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e){if("string"!=typeof e)throw new Error("Input must be string");for(var i=e.length,r=0,o=null,s=null,a=0;a<i;a++)n(o=e.charCodeAt(a))?null!=s&&t(s)?r+=1:r+=3:o<=127?r+=1:o>=128&&o<=2047?r+=2:o>=2048&&o<=65535&&(r+=3),s=o;return r}},"./node_modules/what-input/dist/what-input.js":function(e){var t;t=function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}return n.m=e,n.c=t,n.p="",n(0)}([function(e,t){"use strict";e.exports=function(){if("undefined"==typeof document||"undefined"==typeof window)return{ask:function(){return"initial"},element:function(){return null},ignoreKeys:function(){},specificKeys:function(){},registerOnChange:function(){},unRegisterOnChange:function(){}};var e=document.documentElement,t=null,n="initial",i=n,r=Date.now(),o=!1,s=["button","input","select","textarea"],a=[],l=[16,17,18,91,93],c=[],d={keydown:"keyboard",keyup:"keyboard",mousedown:"mouse",mousemove:"mouse",MSPointerDown:"pointer",MSPointerMove:"pointer",pointerdown:"pointer",pointermove:"pointer",touchstart:"touch",touchend:"touch"},u=!1,m={x:null,y:null},h={2:"touch",3:"touch",4:"mouse"},p=!1;try{var g=Object.defineProperty({},"passive",{get:function(){p=!0}});window.addEventListener("test",null,g)}catch(e){}var v=function(){var e=!p||{passive:!0,capture:!0};document.addEventListener("DOMContentLoaded",f,!0),window.PointerEvent?(window.addEventListener("pointerdown",_,!0),window.addEventListener("pointermove",b,!0)):window.MSPointerEvent?(window.addEventListener("MSPointerDown",_,!0),window.addEventListener("MSPointerMove",b,!0)):(window.addEventListener("mousedown",_,!0),window.addEventListener("mousemove",b,!0),"ontouchstart"in window&&(window.addEventListener("touchstart",_,e),window.addEventListener("touchend",_,!0))),window.addEventListener(C(),b,e),window.addEventListener("keydown",_,!0),window.addEventListener("keyup",_,!0),window.addEventListener("focusin",E,!0),window.addEventListener("focusout",w,!0)},f=function(){if(o=!("false"===e.getAttribute("data-whatpersist")||"false"===document.body.getAttribute("data-whatpersist")))try{window.sessionStorage.getItem("what-input")&&(n=window.sessionStorage.getItem("what-input")),window.sessionStorage.getItem("what-intent")&&(i=window.sessionStorage.getItem("what-intent"))}catch(e){}y("input"),y("intent")},_=function(e){var t=e.which,r=d[e.type];"pointer"===r&&(r=x(e));var o=!c.length&&-1===l.indexOf(t),a=c.length&&-1!==c.indexOf(t),u="keyboard"===r&&t&&(o||a)||"mouse"===r||"touch"===r;if(A(r)&&(u=!1),u&&n!==r&&(S("input",n=r),y("input")),u&&i!==r){var m=document.activeElement;m&&m.nodeName&&(-1===s.indexOf(m.nodeName.toLowerCase())||"button"===m.nodeName.toLowerCase()&&!I(m,"form"))&&(S("intent",i=r),y("intent"))}},y=function(t){e.setAttribute("data-what"+t,"input"===t?n:i),k(t)},b=function(e){var t=d[e.type];"pointer"===t&&(t=x(e)),R(e),(!u&&!A(t)||u&&"wheel"===e.type||"mousewheel"===e.type||"DOMMouseScroll"===e.type)&&i!==t&&(S("intent",i=t),y("intent"))},E=function(n){n.target.nodeName?(t=n.target.nodeName.toLowerCase(),e.setAttribute("data-whatelement",t),n.target.classList&&n.target.classList.length&&e.setAttribute("data-whatclasses",n.target.classList.toString().replace(" ",","))):w()},w=function(){t=null,e.removeAttribute("data-whatelement"),e.removeAttribute("data-whatclasses")},S=function(e,t){if(o)try{window.sessionStorage.setItem("what-"+e,t)}catch(e){}},x=function(e){return"number"==typeof e.pointerType?h[e.pointerType]:"pen"===e.pointerType?"touch":e.pointerType},A=function(e){var t=Date.now(),i="mouse"===e&&"touch"===n&&t-r<200;return r=t,i},C=function(){return"onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll"},k=function(e){for(var t=0,r=a.length;t<r;t++)a[t].type===e&&a[t].fn.call(void 0,"input"===e?n:i)},R=function(e){m.x!==e.screenX||m.y!==e.screenY?(u=!1,m.x=e.screenX,m.y=e.screenY):u=!0},I=function(e,t){var n=window.Element.prototype;if(n.matches||(n.matches=n.msMatchesSelector||n.webkitMatchesSelector),n.closest)return e.closest(t);do{if(e.matches(t))return e;e=e.parentElement||e.parentNode}while(null!==e&&1===e.nodeType);return null};return"addEventListener"in window&&Array.prototype.indexOf&&(d[C()]="mouse",v()),{ask:function(e){return"intent"===e?i:n},element:function(){return t},ignoreKeys:function(e){l=e},specificKeys:function(e){c=e},registerOnChange:function(e,t){a.push({fn:e,type:t||"input"})},unRegisterOnChange:function(e){var t=function(e){for(var t=0,n=a.length;t<n;t++)if(a[t].fn===e)return t}(e);(t||0===t)&&a.splice(t,1)},clearStorage:function(){window.sessionStorage.clear()}}}()}])},e.exports=t()},"./node_modules/xxhashjs/lib/index.js":(e,t,n)=>{e.exports={h32:n("./node_modules/xxhashjs/lib/xxhash.js"),h64:n("./node_modules/xxhashjs/lib/xxhash64.js")}},"./node_modules/xxhashjs/lib/xxhash.js":(e,t,n)=>{var i=n("./node_modules/buffer/index.js").Buffer,r=n("./node_modules/cuint/index.js").UINT32;r.prototype.xxh_update=function(e,t){var n,i,r=s._low,a=s._high;n=(i=e*r)>>>16,n+=t*r,n&=65535,n+=e*a;var l=this._low+(65535&i),c=l>>>16,d=(c+=this._high+(65535&n))<<16|65535&l;c=(d=d<<13|d>>>19)>>>16,n=(i=(l=65535&d)*(r=o._low))>>>16,n+=c*r,n&=65535,n+=l*(a=o._high),this._low=65535&i,this._high=65535&n};var o=r("2654435761"),s=r("2246822519"),a=r("3266489917"),l=r("668265263"),c=r("374761393");function d(){return 2==arguments.length?new d(arguments[1]).update(arguments[0]).digest():this instanceof d?void u.call(this,arguments[0]):new d(arguments[0])}function u(e){return this.seed=e instanceof r?e.clone():r(e),this.v1=this.seed.clone().add(o).add(s),this.v2=this.seed.clone().add(s),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(o),this.total_len=0,this.memsize=0,this.memory=null,this}d.prototype.init=u,d.prototype.update=function(e){var t,n="string"==typeof e;n&&(e=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=e.charCodeAt(n);r<128?t.push(r):r<2048?t.push(192|r>>6,128|63&r):r<55296||r>=57344?t.push(224|r>>12,128|r>>6&63,128|63&r):(n++,r=65536+((1023&r)<<10|1023&e.charCodeAt(n)),t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r))}return new Uint8Array(t)}(e),n=!1,t=!0),"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer&&(t=!0,e=new Uint8Array(e));var r=0,o=e.length,s=r+o;if(0==o)return this;if(this.total_len+=o,0==this.memsize&&(this.memory=n?"":t?new Uint8Array(16):new i(16)),this.memsize+o<16)return n?this.memory+=e:t?this.memory.set(e.subarray(0,o),this.memsize):e.copy(this.memory,this.memsize,0,o),this.memsize+=o,this;if(this.memsize>0){n?this.memory+=e.slice(0,16-this.memsize):t?this.memory.set(e.subarray(0,16-this.memsize),this.memsize):e.copy(this.memory,this.memsize,0,16-this.memsize);var a=0;n?(this.v1.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v2.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v3.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v4.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2))):(this.v1.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v2.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v3.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v4.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2])),r+=16-this.memsize,this.memsize=0,n&&(this.memory="")}if(r<=s-16){var l=s-16;do{n?(this.v1.xxh_update(e.charCodeAt(r+1)<<8|e.charCodeAt(r),e.charCodeAt(r+3)<<8|e.charCodeAt(r+2)),r+=4,this.v2.xxh_update(e.charCodeAt(r+1)<<8|e.charCodeAt(r),e.charCodeAt(r+3)<<8|e.charCodeAt(r+2)),r+=4,this.v3.xxh_update(e.charCodeAt(r+1)<<8|e.charCodeAt(r),e.charCodeAt(r+3)<<8|e.charCodeAt(r+2)),r+=4,this.v4.xxh_update(e.charCodeAt(r+1)<<8|e.charCodeAt(r),e.charCodeAt(r+3)<<8|e.charCodeAt(r+2))):(this.v1.xxh_update(e[r+1]<<8|e[r],e[r+3]<<8|e[r+2]),r+=4,this.v2.xxh_update(e[r+1]<<8|e[r],e[r+3]<<8|e[r+2]),r+=4,this.v3.xxh_update(e[r+1]<<8|e[r],e[r+3]<<8|e[r+2]),r+=4,this.v4.xxh_update(e[r+1]<<8|e[r],e[r+3]<<8|e[r+2])),r+=4}while(r<=l)}return r<s&&(n?this.memory+=e.slice(r):t?this.memory.set(e.subarray(r,s),this.memsize):e.copy(this.memory,this.memsize,r,s),this.memsize=s-r),this},d.prototype.digest=function(){var e,t,n=this.memory,i="string"==typeof n,d=0,u=this.memsize,m=new r;for((e=this.total_len>=16?this.v1.rotl(1).add(this.v2.rotl(7).add(this.v3.rotl(12).add(this.v4.rotl(18)))):this.seed.clone().add(c)).add(m.fromNumber(this.total_len));d<=u-4;)i?m.fromBits(n.charCodeAt(d+1)<<8|n.charCodeAt(d),n.charCodeAt(d+3)<<8|n.charCodeAt(d+2)):m.fromBits(n[d+1]<<8|n[d],n[d+3]<<8|n[d+2]),e.add(m.multiply(a)).rotl(17).multiply(l),d+=4;for(;d<u;)m.fromBits(i?n.charCodeAt(d++):n[d++],0),e.add(m.multiply(c)).rotl(11).multiply(o);return t=e.clone().shiftRight(15),e.xor(t).multiply(s),t=e.clone().shiftRight(13),e.xor(t).multiply(a),t=e.clone().shiftRight(16),e.xor(t),this.init(this.seed),e},e.exports=d},"./node_modules/xxhashjs/lib/xxhash64.js":(e,t,n)=>{var i=n("./node_modules/buffer/index.js").Buffer,r=n("./node_modules/cuint/index.js").UINT64,o=r("11400714785074694791"),s=r("14029467366897019727"),a=r("1609587929392839161"),l=r("9650029242287828579"),c=r("2870177450012600261");function d(){return 2==arguments.length?new d(arguments[1]).update(arguments[0]).digest():this instanceof d?void u.call(this,arguments[0]):new d(arguments[0])}function u(e){return this.seed=e instanceof r?e.clone():r(e),this.v1=this.seed.clone().add(o).add(s),this.v2=this.seed.clone().add(s),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(o),this.total_len=0,this.memsize=0,this.memory=null,this}d.prototype.init=u,d.prototype.update=function(e){var t,n="string"==typeof e;n&&(e=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=e.charCodeAt(n);r<128?t.push(r):r<2048?t.push(192|r>>6,128|63&r):r<55296||r>=57344?t.push(224|r>>12,128|r>>6&63,128|63&r):(n++,r=65536+((1023&r)<<10|1023&e.charCodeAt(n)),t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r))}return new Uint8Array(t)}(e),n=!1,t=!0),"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer&&(t=!0,e=new Uint8Array(e));var a=0,l=e.length,c=a+l;if(0==l)return this;if(this.total_len+=l,0==this.memsize&&(this.memory=n?"":t?new Uint8Array(32):new i(32)),this.memsize+l<32)return n?this.memory+=e:t?this.memory.set(e.subarray(0,l),this.memsize):e.copy(this.memory,this.memsize,0,l),this.memsize+=l,this;if(this.memsize>0){n?this.memory+=e.slice(0,32-this.memsize):t?this.memory.set(e.subarray(0,32-this.memsize),this.memsize):e.copy(this.memory,this.memsize,0,32-this.memsize);var d=0;if(n)m=r(this.memory.charCodeAt(d+1)<<8|this.memory.charCodeAt(d),this.memory.charCodeAt(d+3)<<8|this.memory.charCodeAt(d+2),this.memory.charCodeAt(d+5)<<8|this.memory.charCodeAt(d+4),this.memory.charCodeAt(d+7)<<8|this.memory.charCodeAt(d+6)),this.v1.add(m.multiply(s)).rotl(31).multiply(o),d+=8,m=r(this.memory.charCodeAt(d+1)<<8|this.memory.charCodeAt(d),this.memory.charCodeAt(d+3)<<8|this.memory.charCodeAt(d+2),this.memory.charCodeAt(d+5)<<8|this.memory.charCodeAt(d+4),this.memory.charCodeAt(d+7)<<8|this.memory.charCodeAt(d+6)),this.v2.add(m.multiply(s)).rotl(31).multiply(o),d+=8,m=r(this.memory.charCodeAt(d+1)<<8|this.memory.charCodeAt(d),this.memory.charCodeAt(d+3)<<8|this.memory.charCodeAt(d+2),this.memory.charCodeAt(d+5)<<8|this.memory.charCodeAt(d+4),this.memory.charCodeAt(d+7)<<8|this.memory.charCodeAt(d+6)),this.v3.add(m.multiply(s)).rotl(31).multiply(o),d+=8,m=r(this.memory.charCodeAt(d+1)<<8|this.memory.charCodeAt(d),this.memory.charCodeAt(d+3)<<8|this.memory.charCodeAt(d+2),this.memory.charCodeAt(d+5)<<8|this.memory.charCodeAt(d+4),this.memory.charCodeAt(d+7)<<8|this.memory.charCodeAt(d+6)),this.v4.add(m.multiply(s)).rotl(31).multiply(o);else m=r(this.memory[d+1]<<8|this.memory[d],this.memory[d+3]<<8|this.memory[d+2],this.memory[d+5]<<8|this.memory[d+4],this.memory[d+7]<<8|this.memory[d+6]),this.v1.add(m.multiply(s)).rotl(31).multiply(o),d+=8,m=r(this.memory[d+1]<<8|this.memory[d],this.memory[d+3]<<8|this.memory[d+2],this.memory[d+5]<<8|this.memory[d+4],this.memory[d+7]<<8|this.memory[d+6]),this.v2.add(m.multiply(s)).rotl(31).multiply(o),d+=8,m=r(this.memory[d+1]<<8|this.memory[d],this.memory[d+3]<<8|this.memory[d+2],this.memory[d+5]<<8|this.memory[d+4],this.memory[d+7]<<8|this.memory[d+6]),this.v3.add(m.multiply(s)).rotl(31).multiply(o),d+=8,m=r(this.memory[d+1]<<8|this.memory[d],this.memory[d+3]<<8|this.memory[d+2],this.memory[d+5]<<8|this.memory[d+4],this.memory[d+7]<<8|this.memory[d+6]),this.v4.add(m.multiply(s)).rotl(31).multiply(o);a+=32-this.memsize,this.memsize=0,n&&(this.memory="")}if(a<=c-32){var u=c-32;do{var m;if(n)m=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v1.add(m.multiply(s)).rotl(31).multiply(o),a+=8,m=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v2.add(m.multiply(s)).rotl(31).multiply(o),a+=8,m=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v3.add(m.multiply(s)).rotl(31).multiply(o),a+=8,m=r(e.charCodeAt(a+1)<<8|e.charCodeAt(a),e.charCodeAt(a+3)<<8|e.charCodeAt(a+2),e.charCodeAt(a+5)<<8|e.charCodeAt(a+4),e.charCodeAt(a+7)<<8|e.charCodeAt(a+6)),this.v4.add(m.multiply(s)).rotl(31).multiply(o);else m=r(e[a+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v1.add(m.multiply(s)).rotl(31).multiply(o),m=r(e[(a+=8)+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v2.add(m.multiply(s)).rotl(31).multiply(o),m=r(e[(a+=8)+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v3.add(m.multiply(s)).rotl(31).multiply(o),m=r(e[(a+=8)+1]<<8|e[a],e[a+3]<<8|e[a+2],e[a+5]<<8|e[a+4],e[a+7]<<8|e[a+6]),this.v4.add(m.multiply(s)).rotl(31).multiply(o);a+=8}while(a<=u)}return a<c&&(n?this.memory+=e.slice(a):t?this.memory.set(e.subarray(a,c),this.memsize):e.copy(this.memory,this.memsize,a,c),this.memsize=c-a),this},d.prototype.digest=function(){var e,t,n=this.memory,i="string"==typeof n,d=0,u=this.memsize,m=new r;for(this.total_len>=32?((e=this.v1.clone().rotl(1)).add(this.v2.clone().rotl(7)),e.add(this.v3.clone().rotl(12)),e.add(this.v4.clone().rotl(18)),e.xor(this.v1.multiply(s).rotl(31).multiply(o)),e.multiply(o).add(l),e.xor(this.v2.multiply(s).rotl(31).multiply(o)),e.multiply(o).add(l),e.xor(this.v3.multiply(s).rotl(31).multiply(o)),e.multiply(o).add(l),e.xor(this.v4.multiply(s).rotl(31).multiply(o)),e.multiply(o).add(l)):e=this.seed.clone().add(c),e.add(m.fromNumber(this.total_len));d<=u-8;)i?m.fromBits(n.charCodeAt(d+1)<<8|n.charCodeAt(d),n.charCodeAt(d+3)<<8|n.charCodeAt(d+2),n.charCodeAt(d+5)<<8|n.charCodeAt(d+4),n.charCodeAt(d+7)<<8|n.charCodeAt(d+6)):m.fromBits(n[d+1]<<8|n[d],n[d+3]<<8|n[d+2],n[d+5]<<8|n[d+4],n[d+7]<<8|n[d+6]),m.multiply(s).rotl(31).multiply(o),e.xor(m).rotl(27).multiply(o).add(l),d+=8;for(d+4<=u&&(i?m.fromBits(n.charCodeAt(d+1)<<8|n.charCodeAt(d),n.charCodeAt(d+3)<<8|n.charCodeAt(d+2),0,0):m.fromBits(n[d+1]<<8|n[d],n[d+3]<<8|n[d+2],0,0),e.xor(m.multiply(o)).rotl(23).multiply(s).add(a),d+=4);d<u;)m.fromBits(i?n.charCodeAt(d++):n[d++],0,0,0),e.xor(m.multiply(c)).rotl(11).multiply(o);return t=e.clone().shiftRight(33),e.xor(t).multiply(s),t=e.clone().shiftRight(29),e.xor(t).multiply(a),t=e.clone().shiftRight(32),e.xor(t),this.init(this.seed),e},e.exports=d},"./res/img/e2e/verified-deprecated.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/e2e/verified-deprecated.1e1b7dc.svg"},"./res/img/element-icons/brands/apple.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/apple.5dc43df.svg"},"./res/img/element-icons/brands/facebook.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/facebook.0aec637.svg"},"./res/img/element-icons/brands/github.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/github.a42eafd.svg"},"./res/img/element-icons/brands/gitlab.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/gitlab.b34f535.svg"},"./res/img/element-icons/brands/google.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/google.c844e49.svg"},"./res/img/element-icons/brands/twitter.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/brands/twitter.a7ccb7c.svg"},"./res/img/element-icons/room/default_app.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_app.303bcbf.svg"},"./res/img/element-icons/room/default_cal.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_cal.548061c.svg"},"./res/img/element-icons/room/default_clock.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_clock.41a2843.svg"},"./res/img/element-icons/room/default_doc.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_doc.36782cd.svg"},"./res/img/element-icons/room/default_video.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/element-icons/room/default_video.08328da.svg"},"./res/img/external-link.svg":(e,t,n)=>{"use strict";n.d(t,{I:()=>a});var i,r=n("./node_modules/react/index.js");function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(null,arguments)}var s=function(e,t){return r.createElement("svg",o({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 11 10",role:"presentation","aria-hidden":!0,ref:t},e),i||(i=r.createElement("path",{fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",d:"M8.5 5.5v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3M7 .5h3v3M4.5 6 10 .5"})))},a=(0,r.forwardRef)(s)},"./res/img/matrix.svg":(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n("./node_modules/react/index.js");const i="img/matrix.8396003.svg"},"./res/img/stickerpack-placeholder.png":e=>{e.exports="img/stickerpack-placeholder.877b5d0.png"},"./src/components/structures/ErrorMessage.tsx":(e,t,n)=>{"use strict";n.d(t,{K:()=>o});var i=n("./node_modules/react/index.js"),r=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/warning.js");const o=({message:e})=>{const t=e?i.createElement(r.A,{className:"mx_Icon mx_Icon_16"}):null;return i.createElement("div",{className:"mx_ErrorMessage"},t,e)}},"./src/components/views/auth/LoginWithQR-types.ts":(e,t,n)=>{"use strict";n.d(t,{HY:()=>o,Kt:()=>i,a0:()=>r});let i=function(e){return e.Show="show",e}({}),r=function(e){return e[e.Loading=0]="Loading",e[e.ShowingQR=1]="ShowingQR",e[e.OutOfBandConfirmation=2]="OutOfBandConfirmation",e[e.WaitingForDevice=3]="WaitingForDevice",e[e.Verifying=4]="Verifying",e[e.Error=5]="Error",e}({}),o=function(e){return e[e.Cancel=0]="Cancel",e[e.Decline=1]="Decline",e[e.Approve=2]="Approve",e[e.Back=3]="Back",e[e.ShowQr=4]="ShowQr",e}({})},"./src/components/views/auth/PassphraseConfirmField.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/react/index.js"),o=n("./src/components/views/elements/Field.tsx"),s=n("./src/components/views/elements/Validation.tsx"),a=n("./src/languageHandler.tsx");class l extends r.PureComponent{constructor(...e){super(...e),(0,i.A)(this,"validate",(0,s.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,a._t)(this.props.labelRequired)},{key:"match",test:({value:e})=>!e||e===this.props.password,invalid:()=>(0,a._t)(this.props.labelInvalid)}]})),(0,i.A)(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t})}render(){return r.createElement(o.A,{id:this.props.id,ref:this.props.fieldRef,type:"password",label:(0,a._t)(this.props.label),autoComplete:this.props.autoComplete,value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate,autoFocus:this.props.autoFocus,tooltipAlignment:this.props.tooltipAlignment})}}(0,i.A)(l,"defaultProps",{label:(0,a.AO)("auth|change_password_confirm_label"),labelRequired:(0,a.AO)("auth|change_password_confirm_label"),labelInvalid:(0,a.AO)("auth|change_password_confirm_invalid")});const c=l},"./src/components/views/auth/PassphraseField.tsx":(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/react/index.js"),o=n("./node_modules/classnames/index.js"),s=n.n(o),a=n("./src/SdkConfig.ts"),l=n("./src/components/views/elements/Validation.tsx"),c=n("./src/languageHandler.tsx"),d=n("./src/components/views/elements/Field.tsx"),u=n("./src/MatrixClientPeg.ts");class m extends r.PureComponent{constructor(...e){super(...e),(0,i.A)(this,"validate",(0,l.A)({description:function(e){const t=e?e.score:0;return r.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async({value:e})=>{if(!e)return null;const{scorePassword:t}=await Promise.all([n.e(6501),n.e(9393)]).then(n.bind(n,"./src/utils/PasswordScorer.ts"));return t(u.J.get(),e,this.props.userInputs)},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)(this.props.labelEnterPassword)},{key:"complexity",test:async function({value:e},t){if(!e||!t)return!1;const n=t.score>=this.props.minScore;return a.Ay.get("dangerously_allow_unsafe_and_insecure_passwords")||n},valid:function(e){return e&&e.score>=this.props.minScore?(0,c._t)(this.props.labelStrongPassword):(0,c._t)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||(0,c._t)("auth|password_field_keep_going_prompt")}}],memoize:!0})),(0,i.A)(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t})}render(){return r.createElement(d.A,{id:this.props.id,autoFocus:this.props.autoFocus,className:s()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:(0,c._t)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate,tooltipAlignment:this.props.tooltipAlignment})}}(0,i.A)(m,"defaultProps",{label:(0,c.AO)("common|password"),labelEnterPassword:(0,c.AO)("auth|password_field_label"),labelStrongPassword:(0,c.AO)("auth|password_field_strong_label"),labelAllowedButUnsafe:(0,c.AO)("auth|password_field_weak_label")});const h=m},"./src/components/views/rooms/CollapsibleButton.tsx":(e,t,n)=>{"use strict";n.d(t,{J:()=>m});var i=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),r=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),o=n("./node_modules/react/index.js"),s=n("./node_modules/classnames/index.js"),a=n.n(s),l=n("./src/components/views/elements/AccessibleButton.tsx"),c=n("./src/components/views/rooms/MessageComposerButtons.tsx"),d=n("./src/components/views/context_menus/IconizedContextMenu.tsx");const u=["title","children","className","iconClassName","inputRef"],m=e=>{let{title:t,children:n,className:s,iconClassName:m,inputRef:h}=e,p=(0,r.A)(e,u);return!!(0,o.useContext)(c.ZF)?o.createElement(d.R$,(0,i.A)({},p,{iconClassName:m,label:t,inputRef:h})):o.createElement(l.A,(0,i.A)({},p,{title:t,className:a()(s,m),ref:h}),n)}},"./src/components/views/rooms/EmojiButton.tsx":(e,t,n)=>{"use strict";n.d(t,{h:()=>m});var i=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),r=n("./node_modules/classnames/index.js"),o=n.n(r),s=n("./node_modules/react/index.js"),a=n("./src/languageHandler.tsx"),l=n("./src/components/structures/ContextMenu.tsx"),c=n("./src/components/views/emojipicker/EmojiPicker.tsx"),d=n("./src/components/views/rooms/CollapsibleButton.tsx"),u=n("./src/components/views/rooms/MessageComposerButtons.tsx");function m({addEmoji:e,menuPosition:t,className:n}){const r=(0,s.useContext)(u.ZF),[m,h,p,g]=(0,l.EF)();let v=null;if(m&&h.current){const n=null!=t?t:(0,l.qv)(h.current.getBoundingClientRect()),o=()=>{g(),null==r||r()};v=s.createElement(l.Ay,(0,i.A)({},n,{onFinished:o,managed:!1}),s.createElement(c.Ay,{onChoose:e,onFinished:o}))}const f=o()("mx_EmojiButton",n,{mx_EmojiButton_highlight:m});return s.createElement(s.Fragment,null,s.createElement(d.J,{className:f,iconClassName:"mx_EmojiButton_icon",onClick:p,title:(0,a._t)("common|emoji"),inputRef:h}),v)}},"./src/components/views/rooms/MessageComposerButtons.tsx":(e,t,n)=>{"use strict";n.d(t,{Ay:()=>B,ZF:()=>k});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),o=n("./node_modules/classnames/index.js"),s=n.n(o),a=n("./node_modules/matrix-js-sdk/src/matrix.ts"),l=n("./node_modules/react/index.js"),c=n("./src/languageHandler.tsx"),d=n("./src/components/views/rooms/CollapsibleButton.tsx"),u=n("./src/dispatcher/dispatcher.ts"),m=n("./src/components/views/dialogs/ErrorDialog.tsx"),h=n("./src/components/views/location/index.tsx"),p=n("./src/Modal.tsx"),g=n("./src/components/views/elements/PollCreateDialog.tsx"),v=n("./src/MatrixClientPeg.ts"),f=n("./src/ContentMessages.ts"),_=n("./src/contexts/MatrixClientContext.tsx"),y=n("./src/hooks/useDispatcher.ts"),b=n("./src/utils/BrowserWorkarounds.ts"),E=n("./src/components/views/context_menus/IconizedContextMenu.tsx"),w=n("./src/components/views/rooms/EmojiButton.tsx"),S=n("./src/utils/arrays.ts"),x=n("./src/hooks/useSettings.ts"),A=n("./src/components/views/elements/AccessibleButton.tsx"),C=n("./src/contexts/ScopedRoomContext.tsx");const k=(0,l.createContext)(null);function R(e){return l.createElement(w.h,{key:"emoji_button",addEmoji:e.addEmoji,menuPosition:e.menuPosition,className:"mx_MessageComposer_button"})}function I(){return l.createElement(N,{key:"controls_upload"})}const T=(0,l.createContext)(null),P=({roomId:e,relation:t,children:n})=>{const i=(0,l.useContext)(_.Ay),r=(0,C.ME)("timelineRenderingType"),o=(0,l.useRef)(null),s=()=>{var e;null!=i&&i.isGuest()?u.A.dispatch({action:"require_registration"}):null===(e=o.current)||void 0===e||e.click()};(0,y.F)(u.A,e=>{r.timelineRenderingType===e.context&&"upload_file"===e.action&&s()});return l.createElement(T.Provider,{value:s},n,l.createElement("input",{ref:o,type:"file",style:{display:"none"},multiple:!0,onClick:b.e,onChange:n=>{var o;0!==(null===(o=n.target.files)||void 0===o?void 0:o.length)&&(f.Ay.sharedInstance().sendContentListToRoom(Array.from(n.target.files),e,t,i,r.timelineRenderingType),n.target.value="")}}))},N=()=>{const e=(0,l.useContext)(k),t=(0,l.useContext)(T);return l.createElement(d.J,{className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_upload",onClick:()=>{null==t||t(),null==e||e()},title:(0,c._t)("common|attachment")})};function D(e){return e.showStickersButton?l.createElement(d.J,{id:"stickersButton",key:"controls_stickers",className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_stickers",onClick:()=>e.setStickerPickerOpen(!e.isStickerPickerOpen),title:e.isStickerPickerOpen?(0,c._t)("composer|close_sticker_picker"):(0,c._t)("common|sticker")}):null}function M(e,t){return t?null:l.createElement(d.J,{key:"voice_message_send",className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_voiceMessage",onClick:e.onRecordStartEndClick,title:(0,c._t)("composer|voice_message_button")})}function O(e,t){return l.createElement(F,{key:"polls",room:e,relation:t})}class F extends l.PureComponent{constructor(...e){super(...e),(0,i.A)(this,"onCreateClick",()=>{var e;null===(e=this.context)||void 0===e||e.call(this);if(this.props.room.currentState.maySendEvent(a.M_POLL_START.name,v.J.safeGet().getSafeUserId())){var t;const e=(null===(t=this.props.relation)||void 0===t?void 0:t.rel_type)===a.THREAD_RELATION_TYPE.name?this.props.relation.event_id:void 0;p.Ay.createDialog(g.A,{room:this.props.room,threadId:e},"mx_CompoundDialog",!1,!0)}else p.Ay.createDialog(m.A,{title:(0,c._t)("composer|poll_button_no_perms_title"),description:(0,c._t)("composer|poll_button_no_perms_description")})})}render(){var e;return(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===a.THREAD_RELATION_TYPE.name?null:l.createElement(d.J,{className:"mx_MessageComposer_button",iconClassName:"mx_MessageComposer_poll",onClick:this.onCreateClick,title:(0,c._t)("composer|poll_button")})}}function L(e,t,n){const i=t.getMember(n.getSafeUserId());return e.showLocationButton&&i?l.createElement(h.Uo,{key:"location",roomId:t.roomId,relation:e.relation,sender:i,menuPosition:e.menuPosition}):null}function U({isRichTextEnabled:e,onClick:t}){const n=e?(0,c._t)("composer|mode_plain"):(0,c._t)("composer|mode_rich_text");return l.createElement(d.J,{className:"mx_MessageComposer_button",iconClassName:s()({mx_MessageComposer_plain_text:!e,mx_MessageComposer_rich_text:e}),onClick:t,title:n})}(0,i.A)(F,"contextType",k);const B=e=>{const t=(0,l.useContext)(_.Ay),{room:n,narrow:i}=(0,C.ME)("room","narrow"),o=(0,x.ti)("feature_wysiwyg_composer");if(!t||!n||e.haveRecording)return null;let a,d;i?(a=[o?l.createElement(U,{key:"composerModeButton",isRichTextEnabled:e.isRichTextEnabled,onClick:e.onComposerModeClick}):R(e)],d=[I(),D(e),M(e,i),e.showPollsButton?O(n,e.relation):null,L(e,n,t)]):(a=[o?l.createElement(U,{key:"composerModeButton",isRichTextEnabled:e.isRichTextEnabled,onClick:e.onComposerModeClick}):R(e),I()],d=[D(e),M(e,i),e.showPollsButton?O(n,e.relation):null,L(e,n,t)]),a=(0,S.Bo)(a),d=(0,S.Bo)(d);const u=s()({mx_MessageComposer_button:!0,mx_MessageComposer_buttonMenu:!0,mx_MessageComposer_closeButtonMenu:e.isMenuOpen});return l.createElement(P,{roomId:n.roomId,relation:e.relation},a,d.length>0&&l.createElement(A.A,{className:u,onClick:e.toggleButtonMenu,title:(0,c._t)("quick_settings|sidebar_settings")}),e.isMenuOpen&&l.createElement(E.Ay,(0,r.A)({onFinished:e.toggleButtonMenu},e.menuPosition,{wrapperClassName:"mx_MessageComposer_Menu",compact:!0}),l.createElement(k.Provider,{value:e.toggleButtonMenu},l.createElement(E.tx,null,d))))}},"./src/components/views/settings/KeyboardShortcut.tsx":(e,t,n)=>{"use strict";n.d(t,{S:()=>l});var i=n("./node_modules/react/index.js"),r=n("./src/accessibility/KeyboardShortcuts.ts"),o=n("./src/Keyboard.ts"),s=n("./src/languageHandler.tsx");const a=({name:e,last:t})=>{const n=r.GA[e],o=r.hm[e];return i.createElement(i.Fragment,null,i.createElement("kbd",null," ",n||o&&(0,s._t)(o)||e," "),!t&&"+")},l=({value:e,className:t="mx_KeyboardShortcut"})=>{if(!e)return null;const n=[];return e.ctrlOrCmdKey?n.push(i.createElement(a,{key:"ctrlOrCmdKey",name:o.vL?o.Uz.META:o.Uz.CONTROL})):e.ctrlKey?n.push(i.createElement(a,{key:"ctrlKey",name:o.Uz.CONTROL})):e.metaKey&&n.push(i.createElement(a,{key:"metaKey",name:o.Uz.META})),e.altKey&&n.push(i.createElement(a,{key:"altKey",name:o.Uz.ALT})),e.shiftKey&&n.push(i.createElement(a,{key:"shiftKey",name:o.Uz.SHIFT})),i.createElement("div",{className:t},n,i.createElement(a,{name:e.key,last:!0}))}},"./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default":(e,t,n)=>{var i={"./":["./src/effects/index.ts",9],"./ICanvasEffect":["./src/effects/ICanvasEffect.ts",7,5215],"./ICanvasEffect.ts":["./src/effects/ICanvasEffect.ts",7,5215],"./confetti":["./src/effects/confetti/index.ts",9,2382],"./confetti/":["./src/effects/confetti/index.ts",9,2382],"./confetti/index":["./src/effects/confetti/index.ts",9,2382],"./confetti/index.ts":["./src/effects/confetti/index.ts",9,2382],"./effect":["./src/effects/effect.ts",9,3508],"./effect.ts":["./src/effects/effect.ts",9,3508],"./fireworks":["./src/effects/fireworks/index.ts",9,3636],"./fireworks/":["./src/effects/fireworks/index.ts",9,3636],"./fireworks/index":["./src/effects/fireworks/index.ts",9,3636],"./fireworks/index.ts":["./src/effects/fireworks/index.ts",9,3636],"./hearts":["./src/effects/hearts/index.ts",9,1095],"./hearts/":["./src/effects/hearts/index.ts",9,1095],"./hearts/index":["./src/effects/hearts/index.ts",9,1095],"./hearts/index.ts":["./src/effects/hearts/index.ts",9,1095],"./index":["./src/effects/index.ts",9],"./index.ts":["./src/effects/index.ts",9],"./rainfall":["./src/effects/rainfall/index.ts",9,3197],"./rainfall/":["./src/effects/rainfall/index.ts",9,3197],"./rainfall/index":["./src/effects/rainfall/index.ts",9,3197],"./rainfall/index.ts":["./src/effects/rainfall/index.ts",9,3197],"./snowfall":["./src/effects/snowfall/index.ts",9,2792],"./snowfall/":["./src/effects/snowfall/index.ts",9,2792],"./snowfall/index":["./src/effects/snowfall/index.ts",9,2792],"./snowfall/index.ts":["./src/effects/snowfall/index.ts",9,2792],"./spaceinvaders":["./src/effects/spaceinvaders/index.ts",9,4522],"./spaceinvaders/":["./src/effects/spaceinvaders/index.ts",9,4522],"./spaceinvaders/index":["./src/effects/spaceinvaders/index.ts",9,4522],"./spaceinvaders/index.ts":["./src/effects/spaceinvaders/index.ts",9,4522],"./utils":["./src/effects/utils.ts",9],"./utils.ts":["./src/effects/utils.ts",9]};function r(e){if(!n.o(i,e))return Promise.resolve().then(()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t});var t=i[e],r=t[0];return Promise.all(t.slice(2).map(n.e)).then(()=>n.t(r,16|t[1]))}r.keys=()=>Object.keys(i),r.id="./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default",e.exports=r},"./src/indexing/EventIndexPeg.ts":(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/matrix-js-sdk/src/logger.ts"),o=n("./src/PlatformPeg.ts"),s=n("./node_modules/events/events.js"),a=n("./node_modules/matrix-js-sdk/src/matrix.ts"),l=n("./node_modules/matrix-js-sdk/src/types.ts"),c=n("./node_modules/matrix-js-sdk/src/utils.ts"),d=n("./src/MatrixClientPeg.ts"),u=n("./src/settings/SettingsStore.ts"),m=n("./src/settings/SettingLevel.ts"),h=n("./src/utils/arrays.ts");class p extends s.EventEmitter{constructor(...e){super(...e),(0,i.A)(this,"crawlerCheckpoints",[]),(0,i.A)(this,"crawler",null),(0,i.A)(this,"currentCheckpoint",null),(0,i.A)(this,"onSync",async(e,t,n)=>{var i;const r=null===(i=o.A.get())||void 0===i?void 0:i.getEventIndexingManager();if(r){if("PREPARED"===t&&"SYNCING"===e){return await r.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"===t&&"SYNCING"===e&&await r.commitLiveEvents()}}),(0,i.A)(this,"onRoomTimeline",async(e,t,n,i,r)=>{if(!t)return;const o=d.J.safeGet();return o.isRoomEncrypted(e.getRoomId())?e.isRedaction()?this.redactEvent(e):void(!n&&r&&r.liveEvent&&!e.isRedacted()&&(await o.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))):void 0}),(0,i.A)(this,"onRoomStateEvent",async(e,t)=>{d.J.safeGet().isRoomEncrypted(t.roomId)&&(e.getType()!==a.EventType.RoomEncryption||await this.isRoomIndexed(t.roomId)||(r.vF.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))}),(0,i.A)(this,"redactEvent",async e=>{var t;const n=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();if(!n)return;const i=e.getAssociatedId();if(i)try{await n.deleteEvent(i)}catch(e){r.vF.log("EventIndex: Error deleting event from index",e)}}),(0,i.A)(this,"onTimelineReset",async e=>{e&&d.J.safeGet().isRoomEncrypted(e.roomId)&&(r.vF.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))})}async init(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(this.crawlerCheckpoints=await t.loadCheckpoints(),r.vF.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners())}registerListeners(){const e=d.J.safeGet();e.on(a.ClientEvent.Sync,this.onSync),e.on(a.RoomEvent.Timeline,this.onRoomTimeline),e.on(a.RoomEvent.TimelineReset,this.onTimelineReset),e.on(a.RoomStateEvent.Events,this.onRoomStateEvent)}removeListeners(){const e=d.J.get();null!==e&&(e.removeListener(a.ClientEvent.Sync,this.onSync),e.removeListener(a.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(a.RoomEvent.TimelineReset,this.onTimelineReset),e.removeListener(a.RoomStateEvent.Events,this.onRoomStateEvent))}async addInitialCheckpoints(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();if(!t)return;const n=d.J.safeGet(),i=n.getRooms(),s=await(0,h.j7)(i,async e=>{var t;return Boolean(await(null===(t=n.getCrypto())||void 0===t?void 0:t.isEncryptionEnabledInRoom(e.roomId)))});r.vF.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(s.map(async e=>{const n=e.getLiveTimeline().getPaginationToken(a.Direction.Backward),i={roomId:e.roomId,token:n,direction:a.Direction.Backward,fullCrawl:!0},o={roomId:e.roomId,token:n,direction:a.Direction.Forward};try{i.token&&(await t.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i)),o.token&&(await t.addCrawlerCheckpoint(o),this.crawlerCheckpoints.push(o))}catch(t){r.vF.log("EventIndex: Error adding initial checkpoints for room",e.roomId,i,o,t)}}))}isValidEvent(e){const t=[a.EventType.RoomMessage,a.EventType.RoomName,a.EventType.RoomTopic].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let n=!0,i=!0;if(e.getType()!==a.EventType.RoomMessage||e.isRedacted())e.getType()!==a.EventType.RoomTopic||e.isRedacted()?e.getType()!==a.EventType.RoomName||e.isRedacted()||e.getContent().name||(i=!1):e.getContent().topic||(i=!1);else{const t=e.getContent().msgtype;n=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(i=!1)}return t&&n&&i}eventToJson(e){const t=e.getEffectiveEvent();return e.isEncrypted()?(t.curve25519Key=e.getSenderKey(),t.ed25519Key=e.getClaimedEd25519Key(),t.algorithm=e.getWireContent().algorithm,t.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete t.curve25519Key,delete t.ed25519Key,delete t.algorithm,delete t.forwardingCurve25519KeyChain),t}async addLiveEventToIndex(e){var t,n,i;const r=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();if(!r||!this.isValidEvent(e))return;const s=this.eventToJson(e),a={displayname:null===(n=e.sender)||void 0===n?void 0:n.rawDisplayName,avatar_url:null===(i=e.sender)||void 0===i?void 0:i.getMxcAvatarUrl()};await r.addEventToIndex(s,a)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const n=t[e];await this.addLiveEventToIndex(n)}}async addRoomCheckpoint(e,t=!1){var n;const i=null===(n=o.A.get())||void 0===n?void 0:n.getEventIndexingManager();if(!i)return;const s=d.J.safeGet().getRoom(e);if(!s)return;const l=s.getLiveTimeline(),c=l.getPaginationToken(a.Direction.Backward);if(!c)return void await this.addEventsFromLiveTimeline(l);const u={roomId:s.roomId,token:c,fullCrawl:t,direction:a.Direction.Backward};r.vF.log("EventIndex: Adding checkpoint",u);try{await i.addCrawlerCheckpoint(u)}catch(e){r.vF.log("EventIndex: Error adding new checkpoint for room",s.roomId,u,e)}this.crawlerCheckpoints.push(u)}async crawlerFunc(){var e;let t=!1;const n=d.J.safeGet(),i=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();if(!i)return;this.crawler={cancel:()=>{t=!0}};let s=!1;for(;!t;){let e=u.A.getValueAt(m.p.DEVICE,"crawlerSleepTime");if(e=Math.max(e,100),s&&(e=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await(0,c.yy)(e),t)break;const o=this.crawlerCheckpoints.shift();if(void 0===o){s=!0;continue}this.currentCheckpoint=o,this.emitNewCheckpoint(),s=!1;const d=n.getEventMapper({preventReEmit:!0});let h;try{h=await n.createMessagesRequest(o.roomId,o.token,100,o.direction)}catch(e){if(e instanceof a.HTTPError&&403===e.httpStatus){r.vF.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",o);try{await i.removeCrawlerCheckpoint(o)}catch(e){r.vF.log("EventIndex: Error removing checkpoint",o,e)}continue}r.vF.log("EventIndex: Error crawling using checkpoint:",o,",",e),this.crawlerCheckpoints.push(o);continue}if(t){this.crawlerCheckpoints.push(o);break}if(0===h.chunk.length){r.vF.log("EventIndex: Done with the checkpoint",o);try{await i.removeCrawlerCheckpoint(o)}catch(e){r.vF.log("EventIndex: Error removing checkpoint",o,e)}continue}const p=h.chunk.map(d);let g=[];void 0!==h.state&&(g=h.state.map(d));const v={};g.forEach(e=>{e.getContent().membership===l.O.Join&&(v[e.getSender()]={displayname:e.getContent().displayname,avatar_url:e.getContent().avatar_url})});const f=p.filter(e=>e.isEncrypted()).map(e=>n.decryptEventIfNeeded(e,{emit:!1}));await Promise.all(f);const _=p.filter(this.isValidEvent),y=p.filter(e=>e.isRedaction()),b=_.map(e=>{const t=this.eventToJson(e);let n={};t.sender in v&&(n=v[t.sender]);return{event:t,profile:n}});let E=null;h.end&&(E={roomId:o.roomId,token:h.end,fullCrawl:o.fullCrawl,direction:o.direction});try{for(let e=0;e<y.length;e++){const t=y[e],n=t.getAssociatedId();n?await i.deleteEvent(n):r.vF.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await i.addHistoricEvents(b,E,o);if(!E){r.vF.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",o);continue}!0===e&&!0!==E.fullCrawl?(r.vF.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",o),await i.removeCrawlerCheckpoint(E)):(!0===e&&r.vF.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",o),this.crawlerCheckpoints.push(E))}catch(e){r.vF.log("EventIndex: Error during a crawl",e),this.crawlerCheckpoints.push(o)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await(null==t?void 0:t.closeEventIndex())}async search(e){var t;const n=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();return null==n?void 0:n.searchEventIndex(e)}async loadFileEvents(e,t=10,n,i=a.EventTimeline.BACKWARDS){var s;const c=d.J.safeGet(),u=null===(s=o.A.get())||void 0===s?void 0:s.getEventIndexingManager();if(!u)return[];const m={roomId:e.roomId,limit:t};let h;n&&(m.fromEvent=n,m.direction=i);try{h=await u.loadFileEvents(m)}catch(e){return r.vF.log("EventIndex: Error getting file events",e),[]}const p=c.getEventMapper();return h.map(t=>{const n=p(t.event),i=new a.RoomMember(e.roomId,n.getSender());i.name=t.profile.displayname+" ("+n.getSender()+")";const r=p({content:{membership:l.O.Join,avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:a.EventType.RoomMember,event_id:n.getId()+":eventIndex",room_id:n.getRoomId(),sender:n.getSender(),origin_server_ts:n.getTs(),state_key:n.getSender()});return i.events.member=r,n.sender=i,n})}async populateFileTimeline(e,t,n,i=10,o,s=a.EventTimeline.BACKWARDS){const l=await this.loadFileEvents(n,i,o,s);null===o&&(l.reverse(),s=s==a.EventTimeline.BACKWARDS?a.EventTimeline.FORWARDS:a.EventTimeline.BACKWARDS),l.forEach(n=>{e.eventIdToTimeline(n.getId())||e.addEventToTimeline(n,t,{toStartOfTimeline:s==a.EventTimeline.BACKWARDS,fromCache:!1,addToState:!1})});let c=!1,d="";return l.length>0&&(d=l[l.length-1].getId(),c=!0),r.vF.log("EventIndex: Populating file panel with",l.length,"events and setting the pagination token to",d),t.setPaginationToken(d,a.EventTimeline.BACKWARDS),c}paginateTimelineWindow(e,t,n,i){const r=t.getTimelineIndex(n);if(!r)return Promise.resolve(!1);if(r.pendingPaginate)return r.pendingPaginate;if(t.extend(n,i))return Promise.resolve(!0);const o=(async(e,t,n,i,r)=>{var o;const s=t.timeline,a=s.getTimelineSet(),l=null!==(o=s.getPaginationToken(i))&&void 0!==o?o:void 0,c=await this.populateFileTimeline(a,s,n,r,l,i);return t.pendingPaginate=void 0,e.extend(i,r),c})(t,r,e,n,i);return r.pendingPaginate=o,o}async getStats(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();return null==t?void 0:t.getStats()}async isRoomIndexed(e){var t;const n=null===(t=o.A.get())||void 0===t?void 0:t.getEventIndexingManager();return null==n?void 0:n.isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=d.J.safeGet();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach((e,n)=>{t.add(e.roomId)}),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const n=d.J.safeGet();return n.getRooms().filter(e=>n.isRoomEncrypted(e.roomId)).forEach((t,n)=>{e.add(t.roomId)}),{crawlingRooms:t,totalRooms:e}}}class g{constructor(){(0,i.A)(this,"index",null),(0,i.A)(this,"error",void 0),(0,i.A)(this,"_supportIsInstalled",!1)}async init(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();return t?(this._supportIsInstalled=await t.supportsEventIndexing(),this.supportIsInstalled()?u.A.getValueAt(m.p.DEVICE,"enableEventIndexing")?this.initEventIndex():(r.vF.log("EventIndex: Event indexing is disabled, not initializing"),!1):(r.vF.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(r.vF.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){var e;const t=new p,n=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager(),i=d.J.get();if(!n||!i)throw new Error("Unable to init event index");const s=i.getUserId(),a=i.getDeviceId();try{await n.initEventIndex(s,a);const e=await n.getUserVersion(),i=await n.isEventIndexEmpty();i?await n.setUserVersion(1):0!==e||i||(await n.closeEventIndex(),await this.deleteEventIndex(),await n.initEventIndex(s,a),await n.setUserVersion(1)),r.vF.log("EventIndex: Successfully initialized the event index"),await t.init()}catch(e){return r.vF.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=t,!0}platformHasSupport(){var e;return null!=(null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager())}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){var e;const t=null===(e=o.A.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(await this.unset(),r.vF.log("EventIndex: Deleting event index."),await t.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new g);const v=window.mxEventIndexPeg},"./src/utils/DAOContributionTracker.ts":(e,t,n)=>{"use strict";n.d(t,{A:()=>u,n:()=>d});var i=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=n("./node_modules/matrix-js-sdk/src/matrix.ts"),o=n("./src/MatrixClientPeg.ts"),s=n("./src/utils/DAOMnemonicWallet.ts"),a=n("./src/stores/spaces/SpaceStore.ts");function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach(function(t){(0,i.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class d{constructor(){(0,i.A)(this,"wallet",s.y.getInstance()),(0,i.A)(this,"recentContributions",new Map),(0,i.A)(this,"CONTRIBUTION_COOLDOWN",0),(0,i.A)(this,"isInitialized",!1),(0,i.A)(this,"processedVerifications",new Set)}static getInstance(){return d.instance||(d.instance=new d),d.instance}isDCARoom(e){const t=o.J.safeGet(),n=t.getRoom(e);if(console.log(" Checking if room is DCA:",{roomId:e,roomName:null==n?void 0:n.name,isRoom:!!n}),!n)return console.log(" Room not found"),!1;const i=n.currentState.getStateEvents(r.EventType.SpaceParent);console.log(" Checking parent spaces:",i.length);for(const e of i){const i=e.getStateKey();if(!i)continue;const r=t.getRoom(i);if(console.log(" Parent room:",{parentRoomId:i,parentName:null==r?void 0:r.name,isSpace:null==r?void 0:r.isSpaceRoom()}),null!=r&&r.isSpaceRoom()&&"DCA"===r.name)return console.log(" Found DCA room in DCA space:",n.name),!0}return console.log(" Not in DCA space"),!1}findLedgerRoom(e){const t=o.J.safeGet();if(!t.getRoom(e))return null;const n=a.Ay.instance.getChildren(e);for(const e of n){const n=t.getRoom(e.roomId);if(n&&!n.isSpaceRoom()&&"ledger"===n.name)return n}return null}getDAOInfo(e){const t=o.J.safeGet(),n=t.getRoom(e);if(!n)return null;const i=n.currentState.getStateEvents(r.EventType.SpaceParent);for(const e of i){const i=e.getStateKey();if(!i)continue;const o=t.getRoom(i);if(null==o||!o.isSpaceRoom()||"DCA"!==o.name)continue;const a=o.currentState.getStateEvents(r.EventType.SpaceParent);for(const e of a){var s;const i=e.getStateKey();if(!i)continue;const o=t.getRoom(i);if(null==o||!o.isSpaceRoom())continue;const a=(null===(s=n.currentState.getStateEvents(r.EventType.RoomTopic,""))||void 0===s||null===(s=s.getContent())||void 0===s?void 0:s.topic)||"";console.log(" DCA Room Topic:",a);const l=a.match(/Kudos Value:\s*(\d+)(?:\w*)/i),c=l?parseInt(l[1]):10;console.log(" Extracted kudos value from DCA room:",c);const d=this.findLedgerRoom(i);return console.log(" Ledger room found:",null==d?void 0:d.name),{daoId:i,daoName:o.name||"Unknown DAO",contributionValue:c,ledgerRoom:d}}}return null}isOnCooldown(e,t){const n=`${e}:${t}`,i=this.recentContributions.get(n)||0;return Date.now()-i<this.CONTRIBUTION_COOLDOWN}setCooldown(e,t){const n=`${e}:${t}`;this.recentContributions.set(n,Date.now())}async recordTransaction(e,t,n,i,s,a,l){console.log(" Starting recordTransaction..."),console.log(" Transaction parameters:",{ledgerRoomId:e.roomId,dcaRoomName:t,daoName:n,recipientWalletAddress:i,amount:s,verifierName:a,verifierUserId:l});try{const u=o.J.safeGet();let m=0;try{const t=this.getLatestBalanceFromLedger(e,i),n=new Promise((e,t)=>setTimeout(()=>t(new Error("Balance check timeout")),5e3));m=await Promise.race([t,n])}catch(e){console.warn(" Could not get current balance, using 0:",e),m=0}const h={type:`PoC: ${t}`,from:`${n} minting`,to:i,amount:s,balance:m+s,verifier:a,verifierUserId:l,timestamp:Date.now()},p=this.generateTransactionHash(i,s,h.timestamp),g=`${h.type}|${h.from}|${h.to}|${h.amount}|${h.timestamp}|${p}`;let v=null;const f=e.currentState.getStateEvents(r.EventType.SpaceParent);let _=null;for(const e of f){const t=e.getStateKey();if(t){const e=o.J.safeGet().getRoom(t);if(null!=e&&e.isSpaceRoom()&&"DCA"!==e.name){_=t;break}}}var d;if(_&&this.wallet.hasDAOWallet(_))v=this.wallet.signData(_,g),console.log(" Digital signature generated with DAO wallet:",(null===(d=v)||void 0===d?void 0:d.substring(0,16))+"...");else console.warn(" No DAO wallet available for digital signature, proceeding without signature"),v="unsigned_transaction";const y=c(c({},h),{},{txHash:p,signature:v,dataToSign:g});console.log(" Recording transaction to ledger:",y),console.log(" Sending message to ledger room:",{roomId:e.roomId,roomName:e.name,currentUserId:u.getSafeUserId()});const b=await u.sendEvent(e.roomId,r.EventType.RoomMessage,{msgtype:r.MsgType.Text,body:` TRANSACTION RECORD \n${JSON.stringify(y,null,2)}`,format:"org.matrix.custom.html",formatted_body:`\n                    <h3> TRANSACTION RECORD </h3>\n                    <table border="1" style="border-collapse: collapse; width: 100%;">\n                        <tr><td><b>Type</b></td><td>${y.type}</td></tr>\n                        <tr><td><b>From</b></td><td>${y.from}</td></tr>\n                        <tr><td><b>To</b></td><td>${y.to}</td></tr>\n                        <tr><td><b>Amount</b></td><td>${y.amount}B</td></tr>\n                        <tr><td><b>Balance</b></td><td>${y.balance}B</td></tr>\n                        <tr><td><b>Verifier</b></td><td>${y.verifier}</td></tr>\n                        <tr><td><b>Verifier ID</b></td><td><code>${y.verifierUserId}</code></td></tr>\n                        <tr><td><b>Timestamp</b></td><td>${new Date(y.timestamp).toISOString()}</td></tr>\n                        <tr><td><b>TX Hash</b></td><td><code>${y.txHash}</code></td></tr>\n                        <tr><td><b>Digital Signature</b></td><td><code>${y.signature?y.signature.substring(0,32)+"...":"N/A"}</code></td></tr>\n                        <tr><td><b>Signature Status</b></td><td>${y.signature?" Signed":" Unsigned"}</td></tr>\n                    </table>\n                `,transaction_data:y});console.log(" Transaction recorded to ledger successfully"),console.log(" Send result:",{eventId:null==b?void 0:b.event_id,successful:!(null==b||!b.event_id)})}catch(e){throw console.error(" Failed to record transaction to ledger:",e),e}}async getLatestBalanceFromLedger(e,t){try{console.log(` Getting latest balance for ${t} (quick check)`);const n=e.getLiveTimeline().getEvents();console.log(` Checking ${n.length} currently loaded events`);const i=[...n].reverse();for(const e of i)if(e.getType()===r.EventType.RoomMessage){const n=e.getContent().transaction_data;if(n&&n.to===t&&"number"==typeof n.balance)return console.log(` Found latest balance for ${t}: ${n.balance}B`),n.balance}return console.log(` No previous balance found in loaded events for ${t}, starting from 0`),0}catch(e){return console.error("Error reading balance from ledger:",e),0}}generateTransactionHash(e,t,n){const i=`${e}-${t}-${n}`;let r=0;for(let e=0;e<i.length;e++){r=(r<<5)-r+i.charCodeAt(e),r&=r}return Math.abs(r).toString(16).padStart(8,"0")}handleChatEvent(e){console.log("Chat event ignored - only Verification button awards contributions")}async handleVerificationEvent(e){try{var t;console.log(" VERIFICATION EVENT START:",{type:e.getType(),sender:e.getSender(),content:e.getContent(),roomId:e.getRoomId(),eventId:e.getId()});const s=e.getContent();if((null==s||null===(t=s["m.relates_to"])||void 0===t?void 0:t.rel_type)!==r.RelationType.Annotation)return void console.log(" Not an annotation reaction, skipping");if(!s.verification||!0!==s.verification)return void console.log(" Not a verification event, skipping contribution award");console.log(" VERIFICATION EVENT CONFIRMED, processing contribution award");const a=e.getRoomId();if(!a||!this.isDCARoom(a))return void console.log("Not a DCA room, skipping");const l=s["m.relates_to"],c=null==l?void 0:l.event_id;if(console.log(" Looking for original event:",{originalEventId:c,relatesTo:l}),!c)return void console.log(" No original event ID found, skipping");const d=o.J.safeGet(),u=d.getRoom(a);console.log(" Room info:",{roomId:a,roomExists:!!u,roomName:null==u?void 0:u.name});const m=null==u?void 0:u.findEventById(c);if(console.log(" Original event search result:",{originalEventId:c,eventFound:!!m,eventType:null==m?void 0:m.getType(),eventSender:null==m?void 0:m.getSender()}),!m){console.log(" Original event not found in room timeline"),console.log(" This might happen if the message is not loaded in the current timeline");try{console.log(" Attempting to fetch event from server..."),console.log(" Fetch parameters:",{roomId:a,originalEventId:c});const t=await d.fetchRoomEvent(a,c);if(t){var n,i;console.log(" Successfully fetched event from server:",{sender:t.sender,type:t.type,content:t.content,hasWalletAddress:!(null===(n=t.content)||void 0===n||!n.wallet_address),hasDaoId:!(null===(i=t.content)||void 0===i||!i.dao_id)});const o=new r.MatrixEvent(t);return console.log(" Processing with fetched event..."),void await this.processVerificationForEvent(o,e.getSender(),a)}console.log(" fetchRoomEvent returned null/undefined")}catch(e){console.error(" Failed to fetch event from server:",e),console.error(" Error details:",{name:e.name,message:e.message,code:e.code||"unknown"})}return void console.log(" Unable to find original event, skipping verification")}await this.processVerificationForEvent(m,e.getSender(),a)}catch(e){console.error(" Error handling react event:",e)}}async processVerificationForEvent(e,t,n){try{const i=`${e.getId()}-${t}`;if(this.processedVerifications.has(i))return void console.log(" Verification already processed, skipping duplicate:",i);this.processedVerifications.add(i);const r=e.getSender();console.log(" Rewarding contributor:",r),console.log(" Verifier:",t);const s=e.getContent(),a=s.wallet_address;if(!a)return console.log(" No wallet address found in original message, skipping"),void console.log(" Original message content:",{body:s.body,msgtype:s.msgtype,hasWalletAddress:!!s.wallet_address,hasDaoId:!!s.dao_id});console.log(" Contributor wallet address:",a);const l=this.getDAOInfo(n);if(!l)return void console.log(" No DAO info found, skipping");if(this.wallet.hasDAOWallet(l.daoId)||(console.warn(" Verifier does not have DAO wallet for:",l.daoName),console.warn(" Verification will proceed but transaction may not be signed properly")),this.isOnCooldown(r,l.daoId))return void console.log(" Contribution on cooldown for contributor",r);console.log(" Processing verification contribution for DAO:",l.daoName);const c=o.J.safeGet().getRoom(n),d=(null==c?void 0:c.name)||"Unknown Room";await this.awardContribution(r,a,l,"react",d,t)}catch(e){console.error(" Error processing verification for event:",e)}}async awardContribution(e,t,n,i,r,s){console.log(" Awarding contribution:",{contributorUserId:e,contributorWalletAddress:t,daoName:n.daoName,contributionValue:n.contributionValue,eventType:i,dcaRoomName:r,verifierUserId:s});try{var a,l;const d=t,u=o.J.safeGet().getUser(s),m=(null==u?void 0:u.displayName)||s;if(console.log(" Preparing ledger transaction..."),console.log(" Ledger room status:",{hasLedgerRoom:!!n.ledgerRoom,ledgerRoomId:null===(a=n.ledgerRoom)||void 0===a?void 0:a.roomId,ledgerRoomName:null===(l=n.ledgerRoom)||void 0===l?void 0:l.name}),n.ledgerRoom){console.log(" Recording transaction details:",{dcaRoomName:r,daoName:n.daoName,recipientWalletAddress:d,contributionValue:n.contributionValue,verifierName:m,verifierUserId:s});try{await this.recordTransaction(n.ledgerRoom,r,n.daoName,d,n.contributionValue,m,s),console.log(" Ledger transaction recorded successfully")}catch(e){var c;console.error(" Ledger recording failed, but continuing with wallet update:",e),console.error(" Ledger error details:",{name:e.name,message:e.message,stack:null===(c=e.stack)||void 0===c?void 0:c.split("\n")[0]})}}else console.log(" No ledger room found, proceeding without ledger record"),console.log(" DAO space structure check needed for:",n.daoId);try{console.log(" Updating contributor's wallet balance...");const r=this.wallet.getAllDAOWallets();if(r.find(e=>e.address===t&&e.daoId===n.daoId)){this.wallet.awardContribution(n.daoId,n.contributionValue)?(this.setCooldown(e,n.daoId),this.showContributionNotification(n.daoName,n.contributionValue,i),console.log(" Complete flow: Verification  Contributor wallet updated successfully")):console.log(" Failed to update contributor wallet")}else console.log(" Contributor's wallet not found in local wallets, but transaction recorded"),this.setCooldown(e,n.daoId)}catch(e){console.error(" Error updating contributor wallet:",e)}}catch(e){console.error(" Error in contribution award flow:",e)}}showContributionNotification(e,t,n){const i=` ${e} ${t}  ! (${"chat"===n?"":""})`;"Notification"in window&&"granted"===Notification.permission?new Notification("DAO  ",{body:i,icon:"/favicon.ico"}):console.log(i)}initialize(){if(this.isInitialized)return void console.log(" DAO Contribution Tracker already initialized, skipping...");const e=o.J.safeGet();console.log(" Initializing DAO Contribution Tracker..."),e.on("Room.timeline",(e,t)=>{try{var n,i;const o=e.getType(),s=e.getContent();if(o!==r.EventType.Reaction)return;console.log(" Reaction event:",{type:o,content:s,verification:null==s?void 0:s.verification,relatesTo:null==s?void 0:s["m.relates_to"],sender:e.getSender()});if(!((null==s||null===(n=s["m.relates_to"])||void 0===n?void 0:n.rel_type)===r.RelationType.Annotation&&!0===(null==s?void 0:s.verification)))return void console.log(" Not a verification event, skipping");console.log(" Verification event found!");const a=e.getRoomId();if(console.log(" Checking if DCA room:",a),!a||!this.isDCARoom(a))return void console.log(" Not a DCA room, skipping");console.log(" DCA room confirmed!"),console.log(" DCA Verification Timeline event:",{type:o,sender:e.getSender(),room:null==t?void 0:t.name,roomId:a,originalEventId:null==s||null===(i=s["m.relates_to"])||void 0===i?void 0:i.event_id}),console.log(" Processing DCA Verification"),this.handleVerificationEvent(e).catch(e=>{console.error(" Error in verification event handling:",e)})}catch(e){console.error(" Error processing timeline event:",e)}}),this.isInitialized=!0,console.log(" DAO Contribution Tracker initialized successfully")}extractPublicKeyFromEvent(e){try{const t=e.getContent(),n=t.body||"";console.log(" Extracting public key from event:",{eventId:e.getId(),content:t,body:n,bodyLength:n.length,fullEvent:e.event});const i=n.match(/0x[a-fA-F0-9]{40}/);if(i)return console.log(" Found public key with 0x prefix:",i[0]),i[0];const r=n.match(/[a-fA-F0-9]{40}/);if(r)return console.log(" Found public key without 0x prefix:",r[0]),"0x"+r[0];const o=n.match(/[a-fA-F0-9]{32,64}/);if(o)return console.log(" Found wide hex pattern:",o[0]),"0x"+o[0];const s=JSON.stringify(t).match(/0x[a-fA-F0-9]{40}/);if(s)return console.log(" Found public key in content:",s[0]),s[0];const a=JSON.stringify(e.event).match(/0x[a-fA-F0-9]{40}/);return a?(console.log(" Found public key in event:",a[0]),a[0]):t.wallet_address?(console.log(" Found wallet_address field:",t.wallet_address),t.wallet_address):t.public_key?(console.log(" Found public_key field:",t.public_key),t.public_key):t.address?(console.log(" Found address field:",t.address),t.address):(console.log(" No public key pattern found anywhere in the event"),null)}catch(e){return console.error("Failed to extract public key from event:",e),null}}cleanup(){this.recentContributions.clear()}}(0,i.A)(d,"instance",void 0);const u=d},"./src/utils/room/tagRoom.ts":(e,t,n)=>{"use strict";n.d(t,{tagRoom:()=>l});var i=n("./node_modules/matrix-js-sdk/src/logger.ts"),r=n("./src/stores/room-list/RoomListStore.ts"),o=n("./src/stores/room-list/models.ts"),s=n("./src/actions/RoomListActions.ts"),a=n("./src/dispatcher/dispatcher.ts");function l(e,t){if(t===o.DefaultTagID.Favourite||t===o.DefaultTagID.LowPriority){const n=t===o.DefaultTagID.Favourite?o.DefaultTagID.LowPriority:o.DefaultTagID.Favourite,i=r.Ay.instance.getTagsForRoom(e).includes(t),l=i?t:n,c=i?null:t;a.A.dispatch(s.A.tagRoom(e.client,e,l,c,0))}else i.vF.warn(`Unexpected tag ${t} applied to ${e.roomId}`)}},"./src/vector/app.tsx":(e,t,n)=>{"use strict";n.r(t),n.d(t,{loadApp:()=>Ij});var i=n("./node_modules/matrix-js-sdk/src/matrix.ts");if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");let r;globalThis.__js_sdk_entrypoint=!0;try{r=globalThis.indexedDB}catch{}r&&i.setCryptoStoreFactory(()=>new i.IndexedDBCryptoStore(r,"matrix-js-sdk:crypto")),globalThis.matrixcs=i;var o=n("./node_modules/react/index.js"),s=n("./node_modules/matrix-js-sdk/src/logger.ts"),a=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WrapperLifecycle.js"),l=n("./src/PlatformPeg.ts"),c=n("./src/languageHandler.tsx"),d=n("./src/SdkConfig.ts");const u=[i.AutoDiscovery.ERROR_INVALID_HOMESERVER,i.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER],m=Object.values(i.AutoDiscoveryError),h=e=>m.includes(e),p=e=>{switch(e){case i.AutoDiscoveryError.GenericFailure:return(0,c.AO)("auth|autodiscovery_invalid");case i.AutoDiscoveryError.Invalid:return(0,c.AO)("auth|autodiscovery_generic_failure");case i.AutoDiscoveryError.InvalidHsBaseUrl:return(0,c.AO)("auth|autodiscovery_invalid_hs_base_url");case i.AutoDiscoveryError.InvalidHomeserver:return(0,c.AO)("auth|autodiscovery_invalid_hs");case i.AutoDiscoveryError.InvalidIsBaseUrl:return(0,c.AO)("auth|autodiscovery_invalid_is_base_url");case i.AutoDiscoveryError.InvalidIdentityServer:return(0,c.AO)("auth|autodiscovery_invalid_is");case i.AutoDiscoveryError.InvalidIs:return(0,c.AO)("auth|autodiscovery_invalid_is_response");case i.AutoDiscoveryError.MissingWellknown:return(0,c.AO)("auth|autodiscovery_no_well_known");case i.AutoDiscoveryError.InvalidJson:return(0,c.AO)("auth|autodiscovery_invalid_json");case i.AutoDiscoveryError.UnsupportedHomeserverSpecVersion:return(0,c.AO)("auth|autodiscovery_hs_incompatible")}};class g{static isLivelinessError(e){if(!e)return!1;let t=e;return e instanceof c.P7?t=e.cause:e instanceof Error&&(t=e.message),u.includes(t)}static authComponentStateForError(e,t="login"){if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let n=(0,c._t)("cannot_reach_homeserver"),r=(0,c._t)("cannot_reach_homeserver_detail");if(!g.isLivelinessError(e)){const e=d.Ay.get().brand;n=(0,c._t)("auth|misconfigured_title",{brand:e}),r=(0,c._t)("auth|misconfigured_body",{brand:e},{a:e=>o.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let s=!0;return(e instanceof Error?e.message:e)===i.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER&&(s=!1,n=(0,c._t)("auth|failed_connect_identity_server"),r="register"===t?(0,c._t)("auth|failed_connect_identity_server_register"):"reset_password"===t?(0,c._t)("auth|failed_connect_identity_server_reset_password"):(0,c._t)("auth|failed_connect_identity_server_other")),{serverIsAlive:!1,serverErrorIsFatal:s,serverDeadError:o.createElement("div",null,o.createElement("strong",null,n),o.createElement("div",null,r))}}static async validateServerConfigWithStaticUrls(e,t,n=!1){if(!e)throw new c.P7("auth|no_hs_url_provided");const r={"m.homeserver":{base_url:e}};t&&(r["m.identity_server"]={base_url:t});const o=await i.AutoDiscovery.fromDiscoveryConfig(r),s=new URL(e).hostname;return g.buildValidatedConfigFromDiscovery(s,o,n,!0)}static async validateServerName(e){const t=await i.AutoDiscovery.findClientConfig(e);return g.buildValidatedConfigFromDiscovery(e,t)}static async buildValidatedConfigFromDiscovery(e,t,n=!1,r=!1){var o,a;if(null==t||!t["m.homeserver"])throw s.vF.error("Ended up in a state of not knowing which homeserver to connect to."),new c.P7("auth|autodiscovery_unexpected_error_hs");const l=t["m.homeserver"],u=t["m.identity_server"],m=d.Ay.get("validated_server_config");let v=m&&m.isUrl;var f;if(u&&u.state===i.AutoDiscovery.SUCCESS)v=null!==(f=u.base_url)&&void 0!==f?f:void 0;else if(u&&u.state!==i.AutoDiscovery.PROMPT){if(s.vF.error("Error determining preferred identity server URL:",u),u.state===i.AutoDiscovery.FAIL_ERROR){if(h(u.error))throw new c.P7(p(u.error),{cause:l.error});throw new c.P7("auth|autodiscovery_unexpected_error_is")}l.error=i.AutoDiscovery.ERROR_INVALID_IDENTITY_SERVER,u.base_url&&(v=u.base_url)}if(l.state!==i.AutoDiscovery.SUCCESS&&(s.vF.error("Error processing homeserver config:",l),!n||!g.isLivelinessError(l.error))){if(h(l.error))throw new c.P7(p(l.error),{cause:l.error});throw new c.P7("auth|autodiscovery_unexpected_error_hs")}const _=l.base_url;if(!_)throw s.vF.error("No homeserver URL configured"),new c.P7("auth|autodiscovery_unexpected_error_hs");let y=null!=e?e:l.server_name;const b=new URL(_);if(y||(y=b.hostname),!y)throw s.vF.error("Failed to parse homeserver name from homeserver URL"),new c.P7("auth|autodiscovery_unexpected_error_hs");let E,w;try{const e=new i.MatrixClient({baseUrl:_});E=await e.getAuthMetadata()}catch(e){e instanceof i.MatrixError&&404===e.httpStatus&&"M_UNRECOGNIZED"===e.errcode||(w=e)}return{hsUrl:_,hsName:y,hsNameIsDifferent:b.hostname!==y,isUrl:v,isDefault:!1,warning:null!==(o=null!==(a=l.error)&&void 0!==a?a:w)&&void 0!==o?o:null,isNameResolvable:!r,delegatedAuthentication:E}}}var v=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),f=n("./src/MatrixClientPeg.ts"),_=n("./src/modules/ModuleRunner.ts"),y=n("./src/indexing/EventIndexPeg.ts"),b=n("./src/utils/createMatrixClient.ts"),E=n("./src/Notifier.ts"),w=n("./src/UserActivity.ts"),S=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),x=n("./src/dispatcher/dispatcher.ts"),A=n("./src/utils/Timer.ts");const C=new class{constructor(){(0,S.A)(this,"unavailableTimer",void 0),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"state",void 0),(0,S.A)(this,"onAction",e=>{var t;"user_activity"===e.action&&(this.setState(i.SetPresence.Online),null===(t=this.unavailableTimer)||void 0===t||t.restart())})}async start(){for(this.unavailableTimer=new A.A(18e4),this.dispatcherRef=x.A.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(i.SetPresence.Unavailable)}catch{}}stop(){var e;x.A.unregister(this.dispatcherRef),this.dispatcherRef=void 0,null===(e=this.unavailableTimer)||void 0===e||e.abort(),this.unavailableTimer=void 0}getState(){var e;return null!==(e=this.state)&&void 0!==e?e:null}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!f.J.safeGet().isGuest())try{await f.J.safeGet().setSyncPresence(this.state),s.vF.debug("Presence:",e)}catch(e){s.vF.error("Failed to set presence:",e),this.state=t}}};var k=n("./src/utils/DMRoomMap.ts"),R=n("./src/Modal.tsx"),I=n("./src/stores/ActiveWidgetStore.ts");class T{constructor(e,t,n,i){(0,S.A)(this,"flows",[]),(0,S.A)(this,"defaultDeviceDisplayName",void 0),(0,S.A)(this,"delegatedAuthentication",void 0),(0,S.A)(this,"tempClient",null),this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=n,this.defaultDeviceDisplayName=i.defaultDeviceDisplayName,this.delegatedAuthentication=i.delegatedAuthentication}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}setDelegatedAuthentication(e){this.tempClient=null,this.delegatedAuthentication=e}createTemporaryClient(){return this.tempClient||(this.tempClient=(0,i.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})),this.tempClient}async getFlows(e){if(this.delegatedAuthentication)try{return[await P(this.delegatedAuthentication,d.Ay.get().oidc_static_clients,e)]}catch(e){s.vF.error(e)}const t=this.createTemporaryClient(),{flows:n}=await t.loginFlows(),r=n.find(e=>"m.login.sso"===e.type&&i.DELEGATED_OIDC_COMPATIBILITY.findIn(e));return this.flows=r?[r]:n,this.flows}loginViaPassword(e,t,n,i){const r=!!e&&e.indexOf("@")>0;let o;o=t&&n?{type:"m.id.phone",country:t,phone:n,number:n}:r?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const a={password:i,identifier:o,initial_device_display_name:this.defaultDeviceDisplayName},l=e=>N(this.fallbackHsUrl,this.isUrl,"m.login.password",a).catch(t=>{throw s.vF.log("fallback HS login failed",t),e});let c=null;return N(this.hsUrl,this.isUrl,"m.login.password",a).catch(e=>{if(c=e,403===e.httpStatus&&this.fallbackHsUrl)return l(c);throw c}).catch(e=>{throw s.vF.log("Login failed",e),e})}}const P=async(e,t,n)=>{if(n&&!(e=>{const t=e.prompt_values_supported;return Array.isArray(t)&&(null==t?void 0:t.includes("create"))})(e))throw new Error("Registration is not supported by OP");const r=await(async(e,t)=>{const n=((e,t)=>{var n;const i=e.endsWith("/")?e:e+"/";return null==t||null===(n=t[i])||void 0===n?void 0:n.client_id})(e.issuer,t);return n?(s.vF.debug(`Using static clientId for issuer ${e.issuer}`),n):await(0,i.registerOidcClient)(e,await l.A.get().getOidcClientMetadata())})(e,t);return{type:"oidcNativeFlow",clientId:r}};async function N(e,t,n,r){const o=(0,i.createClient)({baseUrl:e,idBaseUrl:t}),a=await o.login(n,r),l=a.well_known;var c,d;l&&(null!==(c=l["m.homeserver"])&&void 0!==c&&c.base_url&&(e=l["m.homeserver"].base_url,s.vF.log(`Overrode homeserver setting with ${e} from login response`)),null!==(d=l["m.identity_server"])&&void 0!==d&&d.base_url&&(t=l["m.identity_server"].base_url,s.vF.log(`Overrode IS setting with ${t} from login response`)));const u={homeserverUrl:e,identityServerUrl:t,userId:a.user_id,deviceId:a.device_id,accessToken:a.access_token};return _.r.instance.extensions.cryptoSetup.examineLoginResponse(a,u),u}var D=n("./src/utils/StorageManager.ts"),M=n("./src/utils/StorageAccess.ts"),O=n("./src/settings/SettingsStore.ts"),F=n("./src/settings/SettingLevel.ts"),L=n("./src/stores/ToastStore.ts"),U=n("./src/integrations/IntegrationManagers.ts"),B=n("./src/mjolnir/Mjolnir.ts"),V=n("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),j=n("./node_modules/matrix-js-sdk/src/randomstring.ts"),z=n("./src/PosthogAnalytics.ts"),H=n("./src/components/views/toasts/GenericToast.tsx"),W=n("./src/dispatcher/actions.ts");const G="mx_snooze_bulk_unverified_device_nag",K="reviewsessions",q=e=>{L.A.sharedInstance().addOrReplaceToast({key:K,title:(0,c._t)("encryption|verification|unverified_sessions_toast_title"),icon:"verification_warning",props:{description:(0,c._t)("encryption|verification|unverified_sessions_toast_description"),primaryLabel:(0,c._t)("action|review"),onPrimaryClick:()=>{Mt.sharedInstance().dismissUnverifiedSessions(e),x.A.dispatch({action:W.r.ViewUserDeviceSettings})},secondaryLabel:(0,c._t)("encryption|verification|unverified_sessions_toast_reject"),onSecondaryClick:()=>{Mt.sharedInstance().dismissUnverifiedSessions(e),(()=>{try{localStorage.setItem(G,String(Date.now()))}catch(e){s.vF.error("Failed to persist bulk unverified device nag snooze",e)}})()}},component:H.A,priority:50})};var $=n("./node_modules/react/jsx-runtime.js");function J(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M7 14q-.824 0-1.412-.588A1.93 1.93 0 0 1 5 12q0-.825.588-1.412A1.93 1.93 0 0 1 7 10q.824 0 1.412.588Q9 11.175 9 12t-.588 1.412A1.93 1.93 0 0 1 7 14m0 4q-2.5 0-4.25-1.75T1 12t1.75-4.25T7 6q1.676 0 3.037.825A6.2 6.2 0 0 1 12.2 9h8.375q.2 0 .387.075.188.075.338.225l2 2q.15.15.212.325.063.175.063.375t-.062.375a.9.9 0 0 1-.213.325l-3.175 3.175a1 1 0 0 1-.3.2q-.175.075-.35.1a.8.8 0 0 1-.35-.025.9.9 0 0 1-.325-.175L17.5 15l-1.425 1.075a.95.95 0 0 1-.887.15.9.9 0 0 1-.288-.15L13.375 15H12.2a6.2 6.2 0 0 1-2.162 2.175Q8.675 18 7 18m0-2q1.4 0 2.463-.85A4.03 4.03 0 0 0 10.875 13H14l1.45 1.025L17.5 12.5l1.775 1.375L21.15 12l-1-1h-9.275a4.03 4.03 0 0 0-1.412-2.15Q8.4 8 7 8 5.35 8 4.175 9.175T3 12t1.175 2.825T7 16"})})}J.displayName="KeyIcon";const Y=(0,o.forwardRef)(J);var X=n("./src/components/views/dialogs/BaseDialog.tsx"),Q=n("./src/components/views/right_panel/EncryptionPanel.tsx");class Z extends o.Component{constructor(e){super(e),this.state={verificationRequest:this.props.verificationRequest}}componentDidMount(){var e;null===(e=this.props.verificationRequestPromise)||void 0===e||e.then(e=>{this.setState({verificationRequest:e})})}render(){const e=this.state.verificationRequest,t=null==e?void 0:e.otherUserId,n=this.props.member||(t?f.J.safeGet().getUser(t):null),i=null!=e&&e.isSelfVerification?(0,c._t)("encryption|verification|verification_dialog_title_device"):(0,c._t)("encryption|verification|verification_dialog_title_user");return n?o.createElement(X.A,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:i,hasCancel:!0},o.createElement(Q.A,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:n,isRoomEncrypted:!1})):null}}var ee=n("./node_modules/events/events.js"),te=n.n(ee),ne=n("./src/SecurityManager.ts"),ie=n("./src/utils/arrays.ts"),re=n("./src/utils/device/dehydration.ts");let oe=function(e){return e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished",e}({});class se extends(te()){constructor(...e){super(...e),(0,S.A)(this,"started",void 0),(0,S.A)(this,"phase",void 0),(0,S.A)(this,"verificationRequest",null),(0,S.A)(this,"backupInfo",null),(0,S.A)(this,"keyId",null),(0,S.A)(this,"keyInfo",null),(0,S.A)(this,"hasDevicesToVerifyAgainst",void 0),(0,S.A)(this,"onUserTrustStatusChanged",async e=>{var t;if(e!==f.J.safeGet().getSafeUserId())return;await(null===(t=f.J.safeGet().getCrypto())||void 0===t?void 0:t.getCrossSigningKeyId())&&(this.phase=oe.Done,this.emit("update"))}),(0,S.A)(this,"onVerificationRequest",e=>{this.setActiveVerificationRequest(e)}),(0,S.A)(this,"onVerificationRequestChange",async()=>{var e,t;if((null===(e=this.verificationRequest)||void 0===e?void 0:e.phase)===V.X9.Cancelled)this.verificationRequest.off(V.FM.Change,this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if((null===(t=this.verificationRequest)||void 0===t?void 0:t.phase)===V.X9.Done){var n;this.verificationRequest.off(V.FM.Change,this.onVerificationRequestChange),this.verificationRequest=null;const e=await(null===(n=f.J.safeGet().getCrypto())||void 0===n?void 0:n.getCrossSigningKeyId());this.phase=e?oe.Done:oe.Busy,this.emit("update")}})}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new se),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=oe.Loading;const e=f.J.safeGet();e.on(V.cr.VerificationRequestReceived,this.onVerificationRequest),e.on(V.cr.UserTrustStatusChanged,this.onUserTrustStatusChanged);const t=e.getCrypto().getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){var e;if(!this.started)return;this.started=!1,null===(e=this.verificationRequest)||void 0===e||e.off(V.FM.Change,this.onVerificationRequestChange);const t=f.J.get();t&&(t.removeListener(V.cr.VerificationRequestReceived,this.onVerificationRequest),t.removeListener(V.cr.UserTrustStatusChanged,this.onUserTrustStatusChanged))}async fetchKeyInfo(){var e,t;if(!this.started)return;const n=f.J.safeGet(),i=await n.secretStorage.isStored("m.cross_signing.master");null===i||0===Object.keys(i).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(i)[0],this.keyInfo=i[this.keyId]);const r=n.getUserId(),o=n.getCrypto(),s=null!==(e=null===(t=(await o.getUserDeviceInfo([r])).get(r))||void 0===t?void 0:t.values())&&void 0!==e?e:[];this.hasDevicesToVerifyAgainst=await(0,ie.rm)(s,async e=>{if(e.dehydrated)return!1;if(!e.getIdentityKey())return!1;const t=await o.getDeviceVerificationStatus(r,e.deviceId);return!(null==t||!t.signedByOwner)}),this.phase=oe.Intro,this.emit("update")}async usePassPhrase(){s.vF.debug("SetupEncryptionStore.usePassphrase"),this.phase=oe.Busy,this.emit("update");try{var e,t,n;const i=f.J.safeGet(),r=null!==(e=await(null===(t=i.getCrypto())||void 0===t?void 0:t.getKeyBackupInfo()))&&void 0!==e?e:null;this.backupInfo=r,this.emit("update"),await new Promise((e,t)=>{(0,ne.cb)(async()=>{var t,n;(s.vF.debug("SetupEncryptionStore.usePassphrase: cross-signing and secret storage set up; checking dehydration and backup in the background"),e(),await(0,re.p)(i),r)&&(await(null===(t=i.getCrypto())||void 0===t?void 0:t.loadSessionBackupPrivateKeyFromSecretStorage()),await(null===(n=i.getCrypto())||void 0===n?void 0:n.restoreKeyBackup()))}).catch(t)}),await(null===(n=i.getCrypto())||void 0===n?void 0:n.getCrossSigningKeyId())&&(s.vF.debug("SetupEncryptionStore.usePassphrase: done"),this.phase=oe.Done,this.emit("update"))}catch(e){e instanceof ne.qQ?s.vF.debug("SetupEncryptionStore.usePassphrase: user cancelled access to secret storage"):s.vF.log("SetupEncryptionStore.usePassphrase: error",e),this.phase=oe.Intro,this.emit("update")}}skip(){this.phase=oe.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=oe.Finished,this.emit("update")}returnAfterSkip(){this.phase=oe.Intro,this.emit("update")}done(){this.phase=oe.Finished,this.emit("update")}async setActiveVerificationRequest(e){this.started&&e.otherUserId===f.J.safeGet().getUserId()&&(this.verificationRequest&&this.verificationRequest.off(V.FM.Change,this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on(V.FM.Change,this.onVerificationRequestChange),this.emit("update"))}lostKeys(){return!this.hasDevicesToVerifyAgainst&&!this.keyInfo}}var ae=n("./src/components/views/elements/AccessibleButton.tsx"),le=n("./src/components/views/elements/Spinner.tsx"),ce=n("./src/contexts/MatrixClientContext.tsx");const de="_visual-list_15wzx_8";var ue=n("./node_modules/classnames/index.js"),me=n.n(ue);const he=["className","children"];function pe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function ge(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pe(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pe(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function ve(e){let{className:t,children:n}=e,i=(0,v.A)(e,he);return(0,$.jsx)("ul",ge(ge({className:ue(de,t)},i),{},{children:n}))}const fe="_visual-list-item_1ma3e_8",_e="_visual-list-item-icon_1ma3e_17",ye="_visual-list-item-icon-success_1ma3e_22",be="_visual-list-item-icon-destructive_1ma3e_26",Ee=["className","children","Icon","success","destructive"];function we(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function Se(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?we(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):we(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function xe(e){let{className:t,children:n,Icon:i,success:r=!1,destructive:o=!1}=e,s=(0,v.A)(e,Ee);return(0,$.jsxs)("li",Se(Se({className:ue(fe,t)},s),{},{children:[(0,$.jsx)(i,{className:ue(_e,{[ye]:r,[be]:o}),width:"24px",height:"24px","aria-hidden":!0}),n]}))}var Ae=n("./node_modules/@vector-im/compound-web/dist/components/Button/Button.js"),Ce=n("./node_modules/@vector-im/compound-web/dist/components/InlineSpinner/InlineSpinner.js"),ke=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check.js");function Re(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M11.288 7.288A.97.97 0 0 1 12 7q.424 0 .713.287Q13 7.576 13 8t-.287.713A.97.97 0 0 1 12 9a.97.97 0 0 1-.713-.287A.97.97 0 0 1 11 8q0-.424.287-.713m.001 4.001A.97.97 0 0 1 12 11q.424 0 .713.287.287.288.287.713v4q0 .424-.287.712A.97.97 0 0 1 12 17a.97.97 0 0 1-.713-.288A.97.97 0 0 1 11 16v-4q0-.424.287-.713"}),(0,$.jsx)("path",{fillRule:"evenodd",d:"M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10m-2 0a8 8 0 1 1-16 0 8 8 0 0 1 16 0",clipRule:"evenodd"})]})}Re.displayName="InfoIcon";const Ie=(0,o.forwardRef)(Re);var Te=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/error-solid.js"),Pe=n("./src/components/views/settings/encryption/EncryptionCard.tsx"),Ne=n("./src/components/views/auth/InteractiveAuthEntryComponents.tsx"),De=n("./src/components/views/dialogs/InteractiveAuthDialog.tsx");async function Me(e,t){try{await t(null)}catch(n){if(!(n instanceof i.MatrixError&&n.data&&n.data.flows))throw n;const r={[Ne.av.PHASE_PREAUTH]:{title:(0,c._t)("auth|uia|sso_title"),body:(0,c._t)("auth|uia|sso_preauth_body"),continueText:(0,c._t)("auth|sso"),continueKind:"primary"},[Ne.av.PHASE_POSTAUTH]:{title:(0,c._t)("encryption|confirm_encryption_setup_title"),body:(0,c._t)("encryption|confirm_encryption_setup_body"),continueText:(0,c._t)("action|confirm"),continueKind:"primary"}},{finished:o}=R.Ay.createDialog(De.A,{title:"",matrixClient:e,makeRequest:t,aestheticsForStagePhases:{[Ne.av.LOGIN_TYPE]:r,[Ne.av.UNSTABLE_LOGIN_TYPE]:r}}),[s]=await o;if(!s)throw new Error("Cross-signing key upload auth canceled")}}var Oe=n("./src/components/views/settings/encryption/EncryptionCardButtons.tsx"),Fe=n("./src/shared-components/utils/Flex/index.ts");function Le({children:e}){return o.createElement(Fe.s,{direction:"column",gap:"var(--cpd-space-3x)",align:"normal",className:"mx_EncryptionCard_emphasisedContent"},e)}function Ue({onCancelClick:e,onReset:t,variant:n}){const i=(0,ce.nH)(),[r,s]=(0,o.useState)(!1);return o.createElement(Pe.g,{Icon:Te.A,destructive:!0,title:Be(n)},o.createElement(Le,null,o.createElement(ve,null,o.createElement(xe,{Icon:ke.A,success:!0},(0,c._t)("settings|encryption|advanced|breadcrumb_first_description")),o.createElement(xe,{Icon:Ie},(0,c._t)("settings|encryption|advanced|breadcrumb_second_description")),o.createElement(xe,{Icon:Ie},(0,c._t)("settings|encryption|advanced|breadcrumb_third_description"))),"compromised"===n&&o.createElement("span",null,(0,c._t)("settings|encryption|advanced|breadcrumb_warning"))),o.createElement(Oe.D,null,o.createElement(Ae.$,{destructive:!0,disabled:r,onClick:async()=>{var e;s(!0),await(null===(e=i.getCrypto())||void 0===e?void 0:e.resetEncryption(e=>Me(i,e))),t()}},r?o.createElement(o.Fragment,null,o.createElement(Ce.Z,null)," ",(0,c._t)("settings|encryption|advanced|reset_in_progress")):(0,c._t)("action|continue")),r?o.createElement(Le,null,o.createElement("span",{className:"mx_ResetIdentityPanel_warning"},(0,c._t)("settings|encryption|advanced|do_not_close_warning"))):o.createElement(Ae.$,{kind:"tertiary",onClick:e},(0,c._t)("action|cancel"))))}function Be(e){switch(e){case"compromised":case"confirm":return(0,c._t)("settings|encryption|advanced|breadcrumb_title");case"sync_failed":return(0,c._t)("settings|encryption|advanced|breadcrumb_title_sync_failed");case"forgot":return(0,c._t)("settings|encryption|advanced|breadcrumb_title_forgot")}}function Ve({onFinished:e,onReset:t,variant:n}){const i=f.J.safeGet();return o.createElement(ce.Ay.Provider,{value:i},o.createElement(Ue,{onReset:()=>{t(),e()},onCancelClick:e,variant:n}))}class je extends o.Component{constructor(e){super(e),(0,S.A)(this,"onStoreUpdate",()=>{const e=se.sharedInstance();e.phase!==oe.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo,lostKeys:e.lostKeys()}):this.props.onFinished()}),(0,S.A)(this,"onUsePassphraseClick",async()=>{se.sharedInstance().usePassPhrase()}),(0,S.A)(this,"onVerifyClick",()=>{var e;const t=f.J.safeGet(),n=t.getSafeUserId(),i=t.getCrypto().requestOwnUserVerification();this.props.onFinished();const{finished:r}=R.Ay.createDialog(Z,{verificationRequestPromise:i,member:null!==(e=t.getUser(n))&&void 0!==e?e:void 0});r.then(async()=>{(await i).cancel(),this.props.onFinished()})}),(0,S.A)(this,"onSkipConfirmClick",()=>{se.sharedInstance().skipConfirm()}),(0,S.A)(this,"onSkipBackClick",()=>{se.sharedInstance().returnAfterSkip()}),(0,S.A)(this,"onResetClick",e=>{e.preventDefault(),R.Ay.createDialog(Ve,{onReset:()=>{this.props.onFinished();se.sharedInstance().done()},variant:"confirm"})}),(0,S.A)(this,"onDoneClick",()=>{se.sharedInstance().done()}),(0,S.A)(this,"onEncryptionPanelClose",()=>{this.props.onFinished()});const t=se.sharedInstance();t.start(),this.state={phase:t.phase,verificationRequest:t.verificationRequest,backupInfo:t.backupInfo,lostKeys:t.lostKeys()}}componentDidMount(){se.sharedInstance().on("update",this.onStoreUpdate)}componentWillUnmount(){const e=se.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const e=f.J.safeGet(),{phase:t,lostKeys:n}=this.state;if(this.state.verificationRequest&&e.getUser(this.state.verificationRequest.otherUserId))return o.createElement(Q.A,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.onEncryptionPanelClose,member:e.getUser(this.state.verificationRequest.otherUserId),isRoomEncrypted:!1});if(t===oe.Intro){if(n)return o.createElement("div",null,o.createElement("p",null,(0,c._t)("encryption|verification|no_key_or_device")),o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.createElement(ae.A,{kind:"primary",onClick:this.onResetClick},(0,c._t)("encryption|verification|reset_proceed_prompt"))));{const e=se.sharedInstance();let t,n,r;return e.keyInfo&&(i=e.keyInfo,Boolean(i.passphrase&&i.passphrase.salt&&i.passphrase.iterations))?t=(0,c._t)("encryption|verification|verify_using_key_or_phrase"):e.keyInfo&&(t=(0,c._t)("encryption|verification|verify_using_key")),t&&(n=o.createElement(ae.A,{kind:"primary",onClick:this.onUsePassphraseClick},t)),e.hasDevicesToVerifyAgainst&&(r=o.createElement(ae.A,{kind:"primary",onClick:this.onVerifyClick},(0,c._t)("encryption|verification|verify_using_device"))),o.createElement("div",null,o.createElement("p",null,(0,c._t)("encryption|verification|verification_description")),o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r,n),o.createElement("div",{className:"mx_SetupEncryptionBody_reset"},(0,c._t)("encryption|reset_all_button",void 0,{a:e=>o.createElement(ae.A,{kind:"link_inline",className:"mx_SetupEncryptionBody_reset_link",onClick:this.onResetClick},e)})))}}if(t===oe.Done){let e;return e=this.state.backupInfo?o.createElement("p",null,(0,c._t)("encryption|verification|verification_success_with_backup")):o.createElement("p",null,(0,c._t)("encryption|verification|verification_success_without_backup")),o.createElement("div",null,o.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),e,o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.createElement(ae.A,{kind:"primary",onClick:this.onDoneClick},(0,c._t)("action|done"))))}return t===oe.ConfirmSkip?o.createElement("div",null,o.createElement("p",null,(0,c._t)("encryption|verification|verification_skip_warning")),o.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.createElement(ae.A,{kind:"danger_outline",onClick:this.onSkipConfirmClick},(0,c._t)("encryption|verification|verify_later")),o.createElement(ae.A,{kind:"primary",onClick:this.onSkipBackClick},(0,c._t)("action|go_back")))):t===oe.Busy||t===oe.Loading?o.createElement(le.A,null):void s.vF.log(`SetupEncryptionBody: Unknown phase ${t}`);var i}}function ze(e){return e===oe.Done?n("./res/img/e2e/verified-deprecated.svg").A:n("./res/img/e2e/warning-deprecated.svg").A}class He extends o.Component{constructor(e){super(e),(0,S.A)(this,"store",void 0),(0,S.A)(this,"onStoreUpdate",()=>{this.setState({icon:ze(this.store.phase)})}),this.store=se.sharedInstance(),this.state={icon:ze(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return o.createElement(X.A,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:(0,c._t)("encryption|verify_toast_title")},o.createElement(je,{onFinished:this.props.onFinished}))}}var We=n("./src/components/views/dialogs/UserTab.ts"),Ge=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/error.js"),Ke=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/pop-out.js");class qe extends o.Component{constructor(e){super(e),(0,S.A)(this,"onGoToSettingsClick",()=>{const e={action:W.r.ViewUserSettings,initialTabId:We.v.Encryption};x.A.dispatch(e),this.props.onFinished(!1)}),(0,S.A)(this,"onDismissClick",()=>{this.props.onFinished(!0)})}render(){return o.createElement(Pe.g,{Icon:Ge.A,destructive:!0,title:(0,c._t)("settings|encryption|confirm_key_storage_off")},(0,c._t)("settings|encryption|confirm_key_storage_off_description",void 0,{a:e=>o.createElement(o.Fragment,null,o.createElement("br",null),o.createElement("a",{href:"https://element.io/help#encryption5",target:"_blank",rel:"noreferrer noopener"},e," ",o.createElement(Ke.A,null)))}),o.createElement(Oe.D,null,o.createElement(Ae.$,{onClick:this.onGoToSettingsClick,autoFocus:!0,kind:"primary",className:""},(0,c._t)("common|go_to_settings")),o.createElement(Ae.$,{onClick:this.onDismissClick,kind:"secondary"},(0,c._t)("action|yes_dismiss"))))}}const $e="setupencryption",Je=e=>{switch(e){case tt.SET_UP_RECOVERY:return(0,c._t)("encryption|set_up_recovery");case tt.VERIFY_THIS_SESSION:return(0,c._t)("encryption|verify_toast_title");case tt.KEY_STORAGE_OUT_OF_SYNC:case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:return(0,c._t)("encryption|key_storage_out_of_sync");case tt.TURN_ON_KEY_STORAGE:return(0,c._t)("encryption|turn_on_key_storage")}},Ye=e=>{switch(e){case tt.SET_UP_RECOVERY:return;case tt.VERIFY_THIS_SESSION:case tt.KEY_STORAGE_OUT_OF_SYNC:case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:return"verification_warning";case tt.TURN_ON_KEY_STORAGE:return"key_storage"}},Xe=e=>{switch(e){case tt.SET_UP_RECOVERY:return(0,c._t)("action|continue");case tt.VERIFY_THIS_SESSION:return(0,c._t)("action|verify");case tt.KEY_STORAGE_OUT_OF_SYNC:case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:return(0,c._t)("encryption|enter_recovery_key");case tt.TURN_ON_KEY_STORAGE:return(0,c._t)("action|continue")}},Qe=e=>{switch(e){case tt.KEY_STORAGE_OUT_OF_SYNC:case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:return Y;default:return}},Ze=e=>{switch(e){case tt.SET_UP_RECOVERY:return(0,c._t)("action|dismiss");case tt.VERIFY_THIS_SESSION:return(0,c._t)("encryption|verification|unverified_sessions_toast_reject");case tt.KEY_STORAGE_OUT_OF_SYNC:case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:return(0,c._t)("encryption|forgot_recovery_key");case tt.TURN_ON_KEY_STORAGE:return(0,c._t)("action|dismiss")}},et=e=>{switch(e){case tt.SET_UP_RECOVERY:return(0,c._t)("encryption|set_up_recovery_toast_description");case tt.VERIFY_THIS_SESSION:return(0,c._t)("encryption|verify_toast_description");case tt.KEY_STORAGE_OUT_OF_SYNC:case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:return(0,c._t)("encryption|key_storage_out_of_sync_description");case tt.TURN_ON_KEY_STORAGE:return(0,c._t)("encryption|turn_on_key_storage_description")}};let tt=function(e){return e.SET_UP_RECOVERY="set_up_recovery",e.VERIFY_THIS_SESSION="verify_this_session",e.KEY_STORAGE_OUT_OF_SYNC="key_storage_out_of_sync",e.KEY_STORAGE_OUT_OF_SYNC_STORE="key_storage_out_of_sync_store",e.TURN_ON_KEY_STORAGE="turn_on_key_storage",e}({});const nt=e=>{if(_.r.instance.extensions.cryptoSetup.setupEncryptionNeeded({kind:e,storeProvider:{getInstance:()=>se.sharedInstance()}}))return;const t=(e,t)=>{if(t instanceof ne.qQ);else{const t={action:W.r.ViewUserSettings,initialTabId:We.v.Encryption,props:{initialEncryptionState:e===tt.KEY_STORAGE_OUT_OF_SYNC?"reset_identity_sync_failed":"change_recovery_key"}};x.A.dispatch(t)}};L.A.sharedInstance().addOrReplaceToast({key:$e,title:Je(e),icon:Ye(e),props:{description:et(e),primaryLabel:Xe(e),PrimaryIcon:Qe(e),onPrimaryClick:async()=>{switch(e){case tt.SET_UP_RECOVERY:case tt.TURN_ON_KEY_STORAGE:{const e={action:W.r.ViewUserSettings,initialTabId:We.v.Encryption};x.A.dispatch(e);break}case tt.VERIFY_THIS_SESSION:R.Ay.createDialog(He,{},void 0,!1,!0);break;case tt.KEY_STORAGE_OUT_OF_SYNC:case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:{const n=R.Ay.createDialog(le.A,void 0,"mx_Dialog_spinner",!1,!0);try{await(0,ne.cb)()}catch(n){t(e,n)}finally{n.close()}break}}},secondaryLabel:Ze(e),onSecondaryClick:async()=>{switch(e){case tt.SET_UP_RECOVERY:{const e=Mt.sharedInstance();await e.recordRecoveryDisabled(),e.dismissEncryptionSetup();break}case tt.KEY_STORAGE_OUT_OF_SYNC:{const e={action:W.r.ViewUserSettings,initialTabId:We.v.Encryption,props:{initialEncryptionState:"reset_identity_forgot"}};x.A.dispatch(e);break}case tt.KEY_STORAGE_OUT_OF_SYNC_STORE:{const e={action:W.r.ViewUserSettings,initialTabId:We.v.Encryption,props:{initialEncryptionState:"change_recovery_key"}};x.A.dispatch(e);break}case tt.TURN_ON_KEY_STORAGE:{const e=R.Ay.createDialog(qe,void 0,"mx_ConfirmKeyStorageOffDialog"),[t]=await e.finished;if(t){const e=Mt.sharedInstance();await e.recordKeyBackupDisabled(),e.dismissEncryptionSetup()}break}default:Mt.sharedInstance().dismissEncryptionSetup()}},overrideWidth:e===tt.KEY_STORAGE_OUT_OF_SYNC?"366px":void 0},component:H.A,priority:e===tt.VERIFY_THIS_SESSION?95:40})},it=()=>{L.A.sharedInstance().dismissToast($e)},rt=async(e,t)=>{var n;const i=await(null===(n=e.getCrypto())||void 0===n?void 0:n.getDeviceVerificationStatus(e.getSafeUserId(),t));return i?i.crossSigningVerified:null};var ot,st=n("./src/utils/device/parseUserAgent.ts");function at(){return at=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},at.apply(null,arguments)}var lt=function(e,t){return o.createElement("svg",at({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 8 14",role:"presentation","aria-hidden":!0,ref:t},e),ot||(ot=o.createElement("path",{fill:"currentColor",d:"M1.333.333C.6.333 0 .933 0 1.666l.007 2.12c0 .354.14.687.386.94L2.667 7 .393 9.286a1.33 1.33 0 0 0-.386.94L0 12.333c0 .733.6 1.333 1.333 1.333h5.334c.733 0 1.333-.6 1.333-1.333v-2.107c0-.353-.14-.693-.387-.94L5.333 7l2.274-2.267C7.86 4.48 8 4.14 8 3.786v-2.12C8 .933 7.4.333 6.667.333zm5.334 9.94v1.393c0 .367-.3.667-.667.667H2a.67.67 0 0 1-.667-.667v-1.393c0-.18.074-.347.194-.473L4 7.333l2.473 2.473c.12.12.194.294.194.467"})))},ct=(0,o.forwardRef)(lt);let dt=function(e){return e.Verified="Verified",e.Unverified="Unverified",e.Inactive="Inactive",e.Unverifiable="Unverifiable",e}({});const ut=7776e6,mt=e=>!!e.last_seen_ts&&e.last_seen_ts<Date.now()-ut,ht={[dt.Verified]:e=>!!e.isVerified,[dt.Unverified]:e=>!e.isVerified,[dt.Inactive]:mt},pt=(e,t)=>{const n=t.map(e=>ht[e]);return n.length?e.filter(e=>n.every(t=>t(e))):e};var gt=n("./src/DateUtils.ts");const vt=(e,t=(new Date).getTime())=>{if(e+5184e5>=t){const t=new Date(e);return(0,gt.Yq)(t)}return(0,gt.fw)(new Date(e))},ft=({value:e,id:t})=>e?o.createElement("span",null,e):null,_t=({device:e})=>{const t=(e=>{if(mt(e)&&e.last_seen_ts)return{id:"inactive",value:o.createElement(o.Fragment,null,o.createElement(ct,{className:"mx_DeviceTile_inactiveIcon"}),(0,c._t)("settings|sessions|inactive_days",{inactiveAgeDays:90})+` (${vt(e.last_seen_ts)})`)}})(e),n=e.last_seen_ts&&`${(0,c._t)("settings|sessions|last_activity")} ${vt(e.last_seen_ts)}`,i=e.isVerified?(0,c._t)("common|verified"):(0,c._t)("common|unverified"),r=t?[t,{id:"lastSeenIp",value:e.last_seen_ip}]:[{id:"isVerified",value:i},{id:"lastActivity",value:n},{id:"lastSeenIp",value:e.last_seen_ip},{id:"deviceId",value:e.device_id}];return o.createElement(o.Fragment,null,r.map(({id:e,value:t},n)=>t?o.createElement(o.Fragment,{key:e},!!n&&"  ",o.createElement(ft,{id:e,value:t})):null))};function yt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function bt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?yt(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):yt(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function Et(e){return"unverified_session_"+e}const wt=async e=>{const t=f.J.safeGet(),n=await t.getDevice(e),i=bt(bt({},n),{},{isVerified:await rt(t,e),deviceType:st.b.Unknown});L.A.sharedInstance().addOrReplaceToast({key:Et(e),title:(0,c._t)("encryption|verification|unverified_session_toast_title"),icon:"verification_warning",props:{description:n.display_name,detail:o.createElement(_t,{device:i}),primaryLabel:(0,c._t)("encryption|verification|unverified_session_toast_accept"),onPrimaryClick:()=>{Mt.sharedInstance().dismissUnverifiedSessions([e])},secondaryLabel:(0,c._t)("action|no"),onSecondaryClick:()=>{Mt.sharedInstance().dismissUnverifiedSessions([e]),x.A.dispatch({action:W.r.ViewUserDeviceSettings})},destructive:"secondary"},component:H.A,priority:80})},St=e=>{L.A.sharedInstance().dismissToast(Et(e))},xt="io.element.matrix_client_information.",At=e=>`${xt}${e}`,Ct=async(e,t,n)=>{const i=e.getDeviceId(),{brand:r}=t,o=await(null==n?void 0:n.getAppVersion()),s=At(i),a=(()=>{if(window.electron)return;const e=new URL(window.location.href);return[e.host,e.pathname.replace(/\/$/,"")].join("")})();await e.setAccountData(s,{name:r,version:o,url:a})},kt=e=>e&&"string"==typeof e?e:void 0,Rt=(e,t)=>{const n=e.getAccountData(At(t));if(!n)return{};const{name:i,version:r,url:o}=n.getContent();return{name:kt(i),version:kt(r),url:kt(o)}};var It=n("./src/settings/UIFeature.ts"),Tt=n("./src/utils/crypto/deviceInfo.ts");const Pt="m.org.matrix.custom.backup_disabled",Nt="io.element.recovery",Dt=s.vF.getChild("DeviceListener:");class Mt{constructor(){(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"dismissed",new Set),(0,S.A)(this,"dismissedThisDeviceToast",!1),(0,S.A)(this,"keyBackupInfo",null),(0,S.A)(this,"keyBackupFetchedAt",null),(0,S.A)(this,"ourDeviceIdsAtStart",null),(0,S.A)(this,"displayingToastsForDeviceIds",new Set),(0,S.A)(this,"running",!1),(0,S.A)(this,"client",void 0),(0,S.A)(this,"shouldRecordClientInformation",!1),(0,S.A)(this,"enableBulkUnverifiedSessionsReminder",!0),(0,S.A)(this,"deviceClientInformationSettingWatcherRef",void 0),(0,S.A)(this,"analyticsVerificationState",void 0),(0,S.A)(this,"analyticsRecoveryState",void 0),(0,S.A)(this,"onDevicesUpdated",async(e,t)=>{if(!this.client)return;if(t)return;const n=this.client.getSafeUserId();e.includes(n)&&await this.ensureDeviceIdsAtStartPopulated(),this.recheck()}),(0,S.A)(this,"onUserTrustStatusChanged",e=>{this.client&&e===this.client.getUserId()&&this.recheck()}),(0,S.A)(this,"onKeyBackupStatusChanged",()=>{Dt.info("Backup status changed"),this.cachedKeyBackupUploadActive=void 0,this.recheck()}),(0,S.A)(this,"onCrossSingingKeysChanged",()=>{this.recheck()}),(0,S.A)(this,"onAccountData",e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing.")||"m.megolm_backup.v1"===e.getType()||e.getType()===Pt||e.getType()===Nt)&&this.recheck()}),(0,S.A)(this,"onSync",(e,t)=>{"PREPARED"===e&&null===t&&this.recheck()}),(0,S.A)(this,"onRoomStateEvents",e=>{e.getType()===i.EventType.RoomEncryption&&this.recheck()}),(0,S.A)(this,"onAction",({action:e})=>{e===W.r.OnLoggedIn&&(this.recheck(),this.updateClientInformation())}),(0,S.A)(this,"onToDeviceEvent",e=>{e.getType()===i.EventType.SecretSend&&this.recheck()}),(0,S.A)(this,"checkKeyBackupStatus",async()=>{await this.isKeyBackupUploadActive(Dt)||x.A.dispatch({action:W.r.ReportKeyBackupNotEnabled})}),(0,S.A)(this,"isKeyBackupUploadActive",async e=>{if(!this.client)return!0;const t=this.client.getCrypto();if(!t)return!1;if(void 0!==this.cachedKeyBackupUploadActive)return this.cachedKeyBackupUploadActive;const n=await t.getActiveSessionBackupVersion();return this.cachedKeyBackupUploadActive=!!n,e.debug("Key backup upload is "+(this.cachedKeyBackupUploadActive?"active":"inactive")),this.cachedKeyBackupUploadActive}),(0,S.A)(this,"cachedKeyBackupUploadActive",void 0),(0,S.A)(this,"onRecordClientInformationSettingChange",(e,t,n,i,r)=>{const o=this.shouldRecordClientInformation;this.shouldRecordClientInformation=!!r,this.shouldRecordClientInformation!==o&&this.updateClientInformation()}),(0,S.A)(this,"updateClientInformation",async()=>{if(this.client)try{var e;if(this.shouldRecordClientInformation)await Ct(this.client,d.Ay.get(),null!==(e=l.A.get())&&void 0!==e?e:void 0);else await(async e=>{const t=e.getDeviceId(),n=At(t),i=Rt(e,t);(i.name||i.version||i.url)&&await e.deleteAccountData(n)})(this.client)}catch(e){Dt.error("Failed to update client information",e)}})}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new Mt),window.mxDeviceListener}start(e){this.running=!0,this.client=e,this.client.on(V.cr.DevicesUpdated,this.onDevicesUpdated),this.client.on(V.cr.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.on(V.cr.KeysChanged,this.onCrossSingingKeysChanged),this.client.on(V.cr.KeyBackupStatus,this.onKeyBackupStatusChanged),this.client.on(i.ClientEvent.AccountData,this.onAccountData),this.client.on(i.ClientEvent.Sync,this.onSync),this.client.on(i.RoomStateEvent.Events,this.onRoomStateEvents),this.client.on(i.ClientEvent.ToDeviceEvent,this.onToDeviceEvent),this.shouldRecordClientInformation=O.A.getValue("deviceClientInformationOptIn"),this.enableBulkUnverifiedSessionsReminder=O.A.getValue(It.f.BulkUnverifiedSessionsReminder),this.deviceClientInformationSettingWatcherRef=O.A.watchSetting("deviceClientInformationOptIn",null,this.onRecordClientInformationSettingChange),this.dispatcherRef=x.A.register(this.onAction),this.recheck(),this.updateClientInformation()}stop(){this.running=!1,this.client&&(this.client.removeListener(V.cr.DevicesUpdated,this.onDevicesUpdated),this.client.removeListener(V.cr.UserTrustStatusChanged,this.onUserTrustStatusChanged),this.client.removeListener(V.cr.KeysChanged,this.onCrossSingingKeysChanged),this.client.removeListener(i.ClientEvent.AccountData,this.onAccountData),this.client.removeListener(i.ClientEvent.Sync,this.onSync),this.client.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents),this.client.removeListener(i.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)),O.A.unwatchSetting(this.deviceClientInformationSettingWatcherRef),x.A.unregister(this.dispatcherRef),this.dispatcherRef=void 0,this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.cachedKeyBackupUploadActive=void 0,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set,this.client=void 0}async dismissUnverifiedSessions(e){Dt.debug("Dismissing unverified sessions: "+Array.from(e).join(","));for(const t of e)this.dismissed.add(t);this.recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this.recheck()}async recordKeyBackupDisabled(){var e;await(null===(e=this.client)||void 0===e?void 0:e.setAccountData(Pt,{disabled:!0}))}async recordRecoveryDisabled(){var e;await(null===(e=this.client)||void 0===e?void 0:e.setAccountData(Nt,{enabled:!1}))}async ensureDeviceIdsAtStartPopulated(){null===this.ourDeviceIdsAtStart&&(this.ourDeviceIdsAtStart=await this.getDeviceIds())}async getDeviceIds(){const e=this.client;return e?await(0,Tt.a)(e,e.getSafeUserId()):new Set}async getKeyBackupInfo(){if(!this.client)return null;const e=(new Date).getTime(),t=this.client.getCrypto();return t?((!this.keyBackupInfo||!this.keyBackupFetchedAt||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await t.getKeyBackupInfo(),this.keyBackupFetchedAt=e),this.keyBackupInfo):null}async shouldShowSetupEncryptionToast(){if((0,ne.kq)())return!1;const e=this.client,t=null==e?void 0:e.getCrypto();return!(!e||!t)&&await(0,ie.qM)(e.getRooms(),({roomId:e})=>t.isEncryptionEnabledInRoom(e))}recheck(){this.doRecheck().catch(e=>{e instanceof i.ClientStoppedError||Dt.error("Error during `DeviceListener.recheck`",e)})}async doRecheck(){var e;if(!this.running||!this.client)return;const t=new s.Tl(Dt,"check_"+(0,j.US)(4));t.debug("starting recheck...");const n=this.client;if(!await n.isVersionSupported("v1.1"))return void t.debug("cross-signing not supported");const i=n.getCrypto();if(!i)return void t.debug("crypto not enabled");if(!n.isInitialSyncComplete())return void t.debug("initial sync not yet complete");const r=await i.isCrossSigningReady(),o=await i.isSecretStorageReady(),a=await i.getCrossSigningStatus(),l=a.privateKeysCachedLocally.masterKey&&a.privateKeysCachedLocally.selfSigningKey&&a.privateKeysCachedLocally.userSigningKey,c=await n.secretStorage.getDefaultKeyId(),d=await this.recheckRecoveryDisabled(n),u=o||d,m=r&&Boolean(null===(e=await i.getDeviceVerificationStatus(n.getSafeUserId(),n.deviceId))||void 0===e?void 0:e.crossSigningVerified),h=await this.isKeyBackupUploadActive(t),p=await this.recheckBackupDisabled(n),g=h||p,v=m&&l&&g&&u;await this.reportCryptoSessionStateToAnalytics(n),this.dismissedThisDeviceToast||v?(t.info("No toast needed"),it(),this.checkKeyBackupStatus()):await this.shouldShowSetupEncryptionToast()?(await i.getUserDeviceInfo([n.getSafeUserId()]),m?l?g?null===c?d?(t.info("Recovery disabled: no toast needed"),it()):h?(t.info("No default 4S key: showing SET_UP_RECOVERY toast"),nt(tt.SET_UP_RECOVERY)):(t.info("No default 4S key but backup disabled: no toast needed"),it()):(t.warn("4S is missing secrets",{crossSigningReady:r,secretStorageReady:o,allCrossSigningSecretsCached:l,isCurrentDeviceTrusted:m,defaultKeyId:c}),nt(tt.KEY_STORAGE_OUT_OF_SYNC_STORE)):(t.info("Key backup upload is unexpectedly turned off: showing TURN_ON_KEY_STORAGE toast"),nt(tt.TURN_ON_KEY_STORAGE)):(t.info("Some secrets not cached: showing KEY_STORAGE_OUT_OF_SYNC toast",a.privateKeysCachedLocally),nt(tt.KEY_STORAGE_OUT_OF_SYNC)):(t.info("Current device not verified: showing VERIFY_THIS_SESSION toast"),nt(tt.VERIFY_THIS_SESSION))):t.info("Not yet ready, but shouldShowSetupEncryptionToast==false"),await this.ensureDeviceIdsAtStartPopulated();const f=new Set,_=new Set;if(r){const e=await this.getDeviceIds();for(const t of e){if(t===n.deviceId)continue;const e=await i.getDeviceVerificationStatus(n.getSafeUserId(),t);var y;if(!(null!=e&&e.crossSigningVerified||this.dismissed.has(t)))null!==(y=this.ourDeviceIdsAtStart)&&void 0!==y&&y.has(t)?f.add(t):_.add(t)}}t.debug("Old unverified sessions: "+Array.from(f).join(",")),t.debug("New unverified sessions: "+Array.from(_).join(",")),t.debug("Currently showing toasts for: "+Array.from(this.displayingToastsForDeviceIds).join(","));const b=(()=>{try{const e=localStorage.getItem(G),t=Number.parseInt(e||"",10);return Number.isInteger(t)&&t+6048e5>Date.now()}catch{return!1}})();f.size>0&&m&&this.enableBulkUnverifiedSessionsReminder&&!b?q(f):L.A.sharedInstance().dismissToast(K);for(const e of _)wt(e);for(const e of this.displayingToastsForDeviceIds)_.has(e)||(t.debug("Hiding unverified session toast for "+e),St(e));this.displayingToastsForDeviceIds=_}async recheckBackupDisabled(e){const t=await e.getAccountDataFromServer(Pt);return!(null==t||!t.disabled)}async recheckRecoveryDisabled(e){const t=await e.getAccountDataFromServer(Nt);return!1===(null==t?void 0:t.enabled)}async reportCryptoSessionStateToAnalytics(e){const t=e.getCrypto(),n=await t.isSecretStorageReady(),i=await t.getCrossSigningStatus(),r=await this.getKeyBackupInfo(),o=null!=await e.secretStorage.getDefaultKeyId(),s=await t.getDeviceVerificationStatus(e.getUserId(),e.getDeviceId()),a=null!=s&&s.signedByOwner&&null!=s&&s.crossSigningVerified?"Verified":"NotVerified";let l;if(o){const e=i.privateKeysCachedLocally.masterKey&&i.privateKeysCachedLocally.selfSigningKey&&i.privateKeysCachedLocally.userSigningKey;if(null!=r){const i=null!=await t.getSessionBackupPrivateKey();l=n&&e&&i?"Enabled":"Incomplete"}else l=n&&e?"Enabled":"Incomplete"}else l="Disabled";this.analyticsVerificationState===a&&this.analyticsRecoveryState===l||(this.analyticsRecoveryState=l,this.analyticsVerificationState=a,z.Vo.instance.setProperty("recoveryState",l),z.Vo.instance.setProperty("verificationState",a),z.Vo.instance.trackEvent({eventName:"CryptoSessionState",verificationState:a,recoveryState:l}))}}var Ot=n("./src/widgets/Jitsi.ts"),Ft=n("./src/BasePlatform.ts"),Lt=n("./node_modules/rfc4648/lib/rfc4648.js");function Ut(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}const Bt="mx_threepid_invite_";class Vt extends(te()){static get instance(){return Vt._instance||(Vt._instance=new Vt),Vt._instance}storeInvite(e,t){const n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ut(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ut(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({roomId:e},t),i=this.generateIdOf(n);return localStorage.setItem(`${Bt}${i}`,JSON.stringify(n)),this.translateInvite(n)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(null!=n&&n.startsWith(Bt))try{e.push(JSON.parse(localStorage.getItem(n)))}catch(e){console.warn("Failed to parse 3pid invite",e)}}return e}getInvites(){return this.getWireInvites().map(e=>this.translateInvite(e))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem(`${Bt}${e.id}`)}generateIdOf(e){return Lt.RG.stringify((new TextEncoder).encode(JSON.stringify(e)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}(0,S.A)(Vt,"_instance",void 0);var jt=n("./src/LegacyCallHandler.tsx"),zt=n("./src/customisations/Lifecycle.ts"),Ht=n("./src/components/views/dialogs/ErrorDialog.tsx"),Wt=n("./src/components/views/dialogs/QuestionDialog.tsx"),Gt=n("./src/components/views/dialogs/BugReportDialog.tsx"),Kt=n("./src/components/views/elements/DialogButtons.tsx");class qt extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"sendBugReport",()=>{R.Ay.createDialog(Gt.A,{error:this.props.error})}),(0,S.A)(this,"onClearStorageClick",()=>{const{finished:e}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("action|sign_out"),description:o.createElement("div",null,(0,c._t)("error|session_restore|clear_storage_description")),button:(0,c._t)("action|sign_out"),danger:!0});e.then(([e])=>this.props.onFinished(e))}),(0,S.A)(this,"onRefreshClick",()=>{window.location.reload()})}render(){const e=d.Ay.get().brand,t=o.createElement("button",{onClick:this.onClearStorageClick,className:"danger"},(0,c._t)("error|session_restore|clear_storage_button"));let n;return n=d.Ay.get().bug_report_endpoint_url?o.createElement(Kt.A,{primaryButton:(0,c._t)("bug_reporting|send_logs"),onPrimaryButtonClick:this.sendBugReport,focus:!0,hasCancel:!1},t):o.createElement(Kt.A,{primaryButton:(0,c._t)("action|refresh"),onPrimaryButtonClick:this.onRefreshClick,focus:!0,hasCancel:!1},t),o.createElement(X.A,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,c._t)("error|session_restore|title"),contentId:"mx_Dialog_content",hasCancel:!1},o.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.createElement("p",null,(0,c._t)("error|session_restore|description_1")),o.createElement("p",null,(0,c._t)("error|session_restore|description_2",{brand:e})),o.createElement("p",null,(0,c._t)("error|session_restore|description_3"))),n)}}class $t extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"sendBugReport",e=>{e.preventDefault(),R.Ay.createDialog(Gt.A,{})}),(0,S.A)(this,"onSignOutClick",()=>{this.props.onFinished(!0)})}render(){let e;return d.Ay.get().bug_report_endpoint_url&&(e=(0,c._t)("bug_reporting|log_request",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.sendBugReport},e)})),o.createElement(X.A,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:(0,c._t)("error|storage_evicted_title"),contentId:"mx_Dialog_content",hasCancel:!1},o.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.createElement("p",null,(0,c._t)("error|storage_evicted_description_1")),o.createElement("p",null,(0,c._t)("error|storage_evicted_description_2")," ",e)),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|sign_out"),onPrimaryButtonClick:this.onSignOutClick,focus:!0,hasCancel:!1}))}}var Jt=n("./src/sentry.ts"),Yt=n("./src/components/views/dialogs/RoomSettingsDialog.tsx"),Xt=n("./node_modules/matrix-js-sdk/src/types.ts"),Qt=n("./src/hooks/useSettings.ts"),Zt=n("./src/settings/enums/Layout.ts"),en=n("./src/Avatar.ts"),tn=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),nn=n("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),rn=n("./node_modules/@vector-im/compound-web/dist/components/Tooltip/Tooltip.js"),on=n("./src/utils/permalinks/Permalinks.ts"),sn=n("./src/utils/FormattingUtils.ts"),an=n("./src/customisations/UserIdentifier.ts");class ln extends o.Component{render(){const{fallbackName:e,member:t,colored:n,emphasizeDisplayName:i,withTooltip:r,onClick:s}=this.props,a=(null==t?void 0:t.rawDisplayName)||e,l=null==t?void 0:t.userId;let d,u,m;if(n&&(d=(0,sn.yJ)(null!=l?l:"")),l){var h,p;const e=null!==(h=null===(p=an.A.getDisplayUserIdentifier)||void 0===p?void 0:p.call(an.A,l,{withDisplayName:!0,roomId:t.roomId}))&&void 0!==h?h:l;null!=t&&t.disambiguate&&(u=o.createElement("span",{className:"mx_DisambiguatedProfile_mxid"},e)),m=(0,c._t)("timeline|disambiguated_profile",{displayName:a,matrixId:e})}const g=me()(d,{mx_DisambiguatedProfile_displayName:i});return o.createElement("div",{className:"mx_DisambiguatedProfile",title:r?m:void 0,onClick:s},o.createElement("span",{className:g,dir:"auto"},a),u)}}var cn=n("./src/hooks/room/useRoomMemberProfile.ts");function dn({mxEvent:e,onClick:t,withTooltip:n}){var r;const s=(0,cn.s)({userId:e.getSender(),member:e.sender});return e.getContent().msgtype!==i.MsgType.Emote?o.createElement(ln,{fallbackName:null!==(r=e.getSender())&&void 0!==r?r:"",onClick:t,member:s,colored:!0,emphasizeDisplayName:!0,withTooltip:n}):o.createElement(o.Fragment,null)}var un=n("./src/components/views/messages/MImageBody.tsx"),mn=n("./src/hooks/useMediaVisible.ts");class hn extends un.R{constructor(...e){super(...e),(0,S.A)(this,"onClick",e=>{e.preventDefault()})}wrapImage(e,t){return t}render(){if(this.state.error)return super.render();const e=this.props.mxEvent.getContent(),t=this.state.contentUrl?this.messageContent(this.state.contentUrl,this.state.thumbUrl,e,44):void 0;return o.createElement("div",{className:"mx_MImageReplyBody"},t)}}const pn=e=>{const[t,n]=(0,mn.E)(e.mxEvent.getId(),e.mxEvent.getRoomId());return o.createElement(hn,(0,tn.A)({mediaVisible:t,setMediaVisible:n},e))};var gn=n("./src/utils/EventUtils.ts"),vn=n("./src/events/EventTileFactory.tsx"),fn=n("./src/call-types.ts");function _n(e,t,n,r){const o=t.getContent(),s=o.msgtype,a=t.getType();let l=!1;if(O.A.getValue("feature_msc3531_hide_messages_pending_moderation"))switch((0,gn.$k)(t,e)){case gn.H3.VISIBLE_FOR_ALL:case gn.H3.HIDDEN_TO_CURRENT_USER:break;case gn.H3.SEE_THROUGH_FOR_CURRENT_USER:l=!0}let c=(0,vn.Sj)(t,e,n),d=a.startsWith("m.key.verification")||a===i.EventType.RoomMessage&&(null==s?void 0:s.startsWith("m.key.verification"))||a===i.EventType.RoomCreate||a===i.EventType.RoomEncryption||c===vn.ur;const u=!d&&(a===i.EventType.CallInvite||fn.Fm.matches(a));let m=((e,t,n,r)=>!(n||r||e===i.EventType.RoomMessage||e===i.EventType.RoomMessageEncrypted||e===i.EventType.Sticker||e===i.EventType.RoomCreate||i.M_POLL_START.matches(e)||i.M_POLL_END.matches(e)||i.M_BEACON_INFO.matches(e)))(a,0,d,u);const h=a===i.EventType.RoomMessage&&s===i.MsgType.Emote||i.M_POLL_START.matches(a)||i.M_BEACON_INFO.matches(a)||(0,gn.wq)(t);return!r&&(0,vn.bN)(t,e,n)||(c=(0,vn.Sj)(t,e,n,!0),c===vn.DD&&(d=!1,m=!0)),{hasRenderer:!!c,isInfoMessage:m,isBubbleMessage:d,isLeftAlignedBubbleMessage:u,noBubbleEvent:h,isSeeingThroughMessageHiddenForModeration:l}}var yn=n("./src/components/views/messages/MFileBody.tsx"),bn=n("./src/components/views/avatars/MemberAvatar.tsx"),En=n("./src/components/views/messages/MVoiceMessageBody.tsx");function wn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function Sn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wn(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wn(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class xn extends o.PureComponent{constructor(...e){super(...e),(0,S.A)(this,"anchorElement",(0,o.createRef)()),(0,S.A)(this,"onDecrypted",()=>{this.forceUpdate()}),(0,S.A)(this,"onEventRequiresUpdate",()=>{this.forceUpdate()}),(0,S.A)(this,"onClick",e=>{const t=e.target;"a"===t.tagName.toLowerCase()&&null!==t.closest("a")&&t!==this.anchorElement.current||(e.preventDefault(),this.props.toggleExpandedQuote&&e.shiftKey?this.props.toggleExpandedQuote():x.A.dispatch({action:W.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}))})}componentDidMount(){this.props.mxEvent.on(i.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(i.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.on(i.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}componentWillUnmount(){this.props.mxEvent.removeListener(i.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(i.MatrixEventEvent.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.removeListener(i.MatrixEventEvent.Replaced,this.onEventRequiresUpdate)}render(){const e=this.props.mxEvent,t=e.getContent().msgtype,n=e.getType(),{hasRenderer:r,isInfoMessage:a,isSeeingThroughMessageHiddenForModeration:l}=_n(f.J.safeGet(),e,!1);if(!r){const{mxEvent:e}=this.props;return s.vF.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),o.createElement("div",{className:"mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"},(0,c._t)("timeline|error_no_renderer"))}const d=me()("mx_ReplyTile",{mx_ReplyTile_inline:t===i.MsgType.Emote,mx_ReplyTile_info:a&&!e.isRedacted(),mx_ReplyTile_audio:t===i.MsgType.Audio,mx_ReplyTile_video:t===i.MsgType.Video});let u,m="#";this.props.permalinkCreator&&(m=this.props.permalinkCreator.forEvent(e.getId()));a||n===i.EventType.RoomCreate||(u=o.createElement("div",{className:"mx_ReplyTile_sender"},o.createElement(bn.A,{member:e.sender,fallbackUserId:e.getSender(),size:"16px"}),o.createElement(dn,{mxEvent:e})));const h={[i.MsgType.Image]:pn,[i.MsgType.Audio]:(0,gn.Mp)(e)?En.A:yn.Ay,[i.MsgType.Video]:yn.Ay},p={[i.EventType.Sticker]:pn};return o.createElement("div",{className:d},o.createElement("a",{href:m,onClick:this.onClick,ref:this.anchorElement},u,(0,vn.BP)(Sn(Sn({},this.props),{},{ref:void 0,showUrlPreview:!1,overrideBodyTypes:h,overrideEventTypes:p,maxImageHeight:96,isSeeingThroughMessageHiddenForModeration:l,highlights:this.props.highlights,highlightLink:this.props.highlightLink,permalinkCreator:this.props.permalinkCreator,showHiddenEvents:!1}),!1)))}}var An=n("./src/components/views/elements/Pill.tsx"),Cn=n("./src/utils/Reply.ts"),kn=n("./src/contexts/RoomContext.ts");class Rn extends o.Component{constructor(e){super(e),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"room",void 0),(0,S.A)(this,"blockquoteRef",o.createRef()),(0,S.A)(this,"canCollapse",()=>this.state.events.length>1),(0,S.A)(this,"collapse",()=>{this.initialize()}),(0,S.A)(this,"onQuoteClick",async()=>{if(!this.state.loadedEv)return;const e=[this.state.loadedEv,...this.state.events];let t=null;e.length>0&&(t=await this.getNextEvent(e[0])),this.setState({loadedEv:t,events:e}),x.A.fire(W.r.FocusSendMessageComposer)}),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.room=this.matrixClient.getRoom(this.props.parentEv.getRoomId())}get matrixClient(){return f.J.safeGet()}componentDidMount(){this.unmounted=!1,this.initialize(),this.trySetExpandableQuotes()}componentDidUpdate(){this.trySetExpandableQuotes()}componentWillUnmount(){this.unmounted=!0}trySetExpandableQuotes(){if(void 0===this.props.isQuoteExpanded&&this.blockquoteRef.current){const e=this.blockquoteRef.current.querySelector(".mx_EventTile_body");if(e){const t=e.querySelector("code"),n=!!t&&t.offsetHeight>=60;(e.offsetHeight>=60||n)&&this.props.setQuoteExpanded(!1)}}}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent((0,Cn.Ul)(e));if(!this.unmounted)if(t){const e=await this.getNextEvent(t);this.setState({events:[t],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(e){try{const t=(0,Cn.Ul)(e);return t?await this.getEvent(t):null}catch{return null}}async getEvent(e){var t;if(!e)return null;const n=this.room.findEventById(e);if(n)return n;try{await this.matrixClient.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch{return null}return null!==(t=this.room.findEventById(e))&&void 0!==t?t:null}getReplyChainColorClass(e){return(0,sn.yJ)(e.getSender()).replace("Username","ReplyChain")}render(){let e;if(this.state.err)e=o.createElement("blockquote",{className:"mx_ReplyChain mx_ReplyChain_error"},(0,c._t)("timeline|reply|error_loading"));else if(this.state.loadedEv&&(0,Cn.c$)(this.state.events[0])){const t=this.state.loadedEv,n=this.matrixClient.getRoom(t.getRoomId());e=o.createElement("blockquote",{className:`mx_ReplyChain ${this.getReplyChainColorClass(t)}`},(0,c._t)("timeline|reply|in_reply_to",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",className:"mx_ReplyChain_show",onClick:this.onQuoteClick},e),pill:o.createElement(An.a,{type:An.y.UserMention,room:null!=n?n:void 0,url:(0,on.Ne)(t.getSender()),shouldShowPillAvatar:O.A.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.props.forExport){const t=(0,Cn.Ul)(this.props.parentEv);e=o.createElement("p",{className:"mx_ReplyChain_Export"},(0,c._t)("timeline|reply|in_reply_to_for_export",{},{a:e=>o.createElement("a",{className:"mx_reply_anchor",href:`#${t}`,"data-scroll-to":t}," ",e," ")}))}else this.state.loading&&(e=o.createElement(le.A,{w:16,h:16}));const{isQuoteExpanded:t}=this.props,n=this.state.events.map(e=>{const n=me()({mx_ReplyChain:!0,[this.getReplyChainColorClass(e)]:!0,"mx_ReplyChain--expanded":!0===t,"mx_ReplyChain--collapsed":!1===t});return o.createElement("blockquote",{ref:this.blockquoteRef,className:n,key:e.getId()},o.createElement(xn,{mxEvent:e,permalinkCreator:this.props.permalinkCreator,toggleExpandedQuote:()=>this.props.setQuoteExpanded(!this.props.isQuoteExpanded),getRelationsForEvent:this.props.getRelationsForEvent}))});return o.createElement("div",{className:"mx_ReplyChain_wrapper"},o.createElement("div",null,e),o.createElement("div",null,n))}}(0,S.A)(Rn,"contextType",kn.Ay);var In=n("./src/components/views/messages/DecryptionFailureBody.tsx"),Tn=n("./src/components/views/avatars/RoomAvatar.tsx"),Pn=n("./src/components/views/context_menus/MessageContextMenu.tsx"),Nn=n("./src/components/structures/ContextMenu.tsx"),Dn=n("./src/utils/objects.ts"),Mn=n("./src/stores/notifications/StaticNotificationState.ts"),On=n("./src/components/views/rooms/NotificationBadge.tsx"),Fn=n("./src/components/views/messages/MessageTimestamp.tsx");function Ln(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M6 14q-.824 0-1.412-.588A1.93 1.93 0 0 1 4 12q0-.825.588-1.412A1.93 1.93 0 0 1 6 10q.824 0 1.412.588Q8 11.175 8 12t-.588 1.412A1.93 1.93 0 0 1 6 14m6 0q-.825 0-1.412-.588A1.93 1.93 0 0 1 10 12q0-.825.588-1.412A1.93 1.93 0 0 1 12 10q.825 0 1.412.588Q14 11.175 14 12t-.588 1.412A1.93 1.93 0 0 1 12 14m6 0q-.824 0-1.413-.588A1.93 1.93 0 0 1 16 12q0-.825.587-1.412A1.93 1.93 0 0 1 18 10q.824 0 1.413.588Q20 11.175 20 12t-.587 1.412A1.93 1.93 0 0 1 18 14"})})}Ln.displayName="OverflowHorizontalIcon";const Un=(0,o.forwardRef)(Ln);var Bn=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/threads.js");function Vn(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{fillRule:"evenodd",d:"M5.457 2.083a1 1 0 0 0-1.414 1.414L8.04 7.494v2.25a.5.5 0 0 1-.15.356l-3.7 3.644a.5.5 0 0 0-.15.356v1.4a.5.5 0 0 0 .5.5h6.5v6a1 1 0 0 0 2 0v-6h3.506l4.497 4.497a1 1 0 0 0 1.414-1.414zM14.546 14 10.04 9.494v.25a2.5 2.5 0 0 1-.746 1.781L6.78 14z",clipRule:"evenodd"}),(0,$.jsx)("path",{d:"M14.04 4v3.85l2.015 2.015a.5.5 0 0 1-.015-.12V5.257a.5.5 0 0 1 .15-.357l2.081-2.043a.5.5 0 0 0-.35-.857h-9.73l2 2z"})]})}Vn.displayName="UnpinIcon";const jn=(0,o.forwardRef)(Vn);function zn(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{fillRule:"evenodd",d:"M6.119 2a.5.5 0 0 0-.35.857L7.85 4.9a.5.5 0 0 1 .15.357v4.487a.5.5 0 0 1-.15.356l-3.7 3.644A.5.5 0 0 0 4 14.1v1.4a.5.5 0 0 0 .5.5H11v6a1 1 0 1 0 2 0v-6h6.5a.5.5 0 0 0 .5-.5v-1.4a.5.5 0 0 0-.15-.356l-3.7-3.644a.5.5 0 0 1-.15-.356V5.257a.5.5 0 0 1 .15-.357l2.081-2.043a.5.5 0 0 0-.35-.857zM10 4h4v5.744a2.5 2.5 0 0 0 .746 1.781L17.26 14H6.74l2.514-2.475A2.5 2.5 0 0 0 10 9.744z",clipRule:"evenodd"})})}zn.displayName="PinIcon";const Hn=(0,o.forwardRef)(zn);var Wn=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/delete.js");function Gn(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M18.93 8A8 8 0 1 1 4 12a1 1 0 1 0-2 0c0 5.523 4.477 10 10 10s10-4.477 10-10a10 10 0 0 0-.832-4A10 10 0 0 0 12 2a9.99 9.99 0 0 0-8 3.999V4a1 1 0 0 0-2 0v4a1 1 0 0 0 1 1h4a1 1 0 0 0 0-2H5.755A7.99 7.99 0 0 1 12 4a8 8 0 0 1 6.93 4"})})}Gn.displayName="RestartIcon";const Kn=(0,o.forwardRef)(Gn);function qn(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M9.405 5.708c.39-.39.39-1.025 0-1.416a.996.996 0 0 0-1.412 0L3.294 9.006a1.004 1.004 0 0 0 0 1.416l4.699 4.714a.996.996 0 0 0 1.412 0c.39-.39.39-1.025 0-1.416l-3.043-3.053h9.153c1.887 0 3.485 1.604 3.485 3.666C19 16.396 17.402 18 15.515 18h-2.093a1 1 0 1 0 0 2h2.093C18.58 20 21 17.425 21 14.333s-2.419-5.666-5.485-5.666H6.456z"})})}qn.displayName="ReplyIcon";const $n=(0,o.forwardRef)(qn);var Jn;function Yn(){return Yn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Yn.apply(null,arguments)}var Xn=function(e,t){return o.createElement("svg",Yn({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),Jn||(Jn=o.createElement("path",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 14h12M5 10.5l7-7"})))},Qn=(0,o.forwardRef)(Xn);var Zn;function ei(){return ei=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ei.apply(null,arguments)}var ti=function(e,t){return o.createElement("svg",ei({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),Zn||(Zn=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M20 1a1 1 0 0 0-1 1v2h-2a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0V6h2a1 1 0 1 0 0-2h-2V2a1 1 0 0 0-1-1M7 9.5C7 8.67 7.67 8 8.5 8s1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5m8.5 1.5c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5M4 12a8 8 0 0 1 9.774-7.803 1 1 0 1 0 .442-1.95A10 10 0 0 0 12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10q0-.318-.02-.632a1 1 0 1 0-1.996.125q.015.25.016.507a8 8 0 1 1-16 0",clipRule:"evenodd"})))},ni=(0,o.forwardRef)(ti);var ii;function ri(){return ri=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ri.apply(null,arguments)}var oi=function(e,t){return o.createElement("svg",ri({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),ii||(ii=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22 8.494a.753.753 0 0 1 1.062-.002l3.724 3.7L8.718 8.48a.753.753 0 0 1 1.062-.002.747.747 0 0 1 .002 1.06L5.54 13.78a.753.753 0 0 1-1.063.002L.221 9.552a.747.747 0 0 1-.002-1.058m9.562-2.988a.753.753 0 0 1-1.062.002l-3.724-3.7L1.283 5.52a.753.753 0 0 1-1.062.002.747.747 0 0 1-.002-1.06L4.462.22A.753.753 0 0 1 5.524.218l4.257 4.23a.747.747 0 0 1 .001 1.058",clipRule:"evenodd"})))},si=(0,o.forwardRef)(oi);var ai;function li(){return li=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},li.apply(null,arguments)}var ci=function(e,t){return o.createElement("svg",li({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0,ref:t},e),ai||(ai=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22.234A.753.753 0 0 1 1.281.232l3.724 3.7L8.718.22A.753.753 0 0 1 9.781.218a.747.747 0 0 1 .001 1.06L5.54 5.52a.753.753 0 0 1-1.063.002L.221 1.292A.747.747 0 0 1 .219.235m9.562 13.532a.753.753 0 0 1-1.062.002l-3.724-3.7-3.713 3.712a.753.753 0 0 1-1.062.002.747.747 0 0 1-.002-1.06L4.462 8.48a.753.753 0 0 1 1.062-.002l4.257 4.23a.747.747 0 0 1 .001 1.058",clipRule:"evenodd"})))},di=(0,o.forwardRef)(ci);var ui=n("./src/accessibility/Toolbar.tsx"),mi=n("./src/accessibility/RovingTabIndex.tsx"),hi=n("./src/Resend.ts"),pi=n("./src/utils/MediaEventHelper.ts"),gi=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/download.js"),vi=n("./src/hooks/useDownloadMedia.ts");function fi({mxEvent:e,mediaEventHelperGet:t}){var n,i;const r=(0,o.useMemo)(()=>t(),[t]),s=null!==(n=null==r?void 0:r.media.srcHttp)&&void 0!==n?n:"",a=null==r?void 0:r.fileName,{download:l,loading:d,canDownload:u}=(0,vi.Q)(s,a,e),m=function(e,t){return e?t?(0,c._t)("timeline|download_action_decrypting"):(0,c._t)("timeline|download_action_downloading"):(0,c._t)("action|download")}(d,null!==(i=null==r?void 0:r.media.isEncrypted)&&void 0!==i&&i);if(!u)return null;const h=d?o.createElement(le.A,{w:18,h:18}):void 0,p=me()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_downloadButton:!0,mx_MessageActionBar_downloadSpinnerButton:!!h});return o.createElement(mi.k,{className:p,title:m,onClick:l,disabled:d,placement:"left"},o.createElement(gi.A,null),h)}var _i=n("./src/components/views/emojipicker/ReactionPicker.tsx"),yi=n("./src/components/views/right_panel/context.ts"),bi=n("./src/Keyboard.ts"),Ei=n("./src/accessibility/KeyboardShortcuts.ts"),wi=n("./src/utils/PinningUtils.ts"),Si=n("./src/PosthogTrackers.ts"),xi=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/visibility-off.js");const Ai=({mxEvent:e})=>{const[t,n]=(0,mn.E)(e.getId(),e.getRoomId());if(t)return o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton ",title:(0,c._t)("action|hide"),onClick:()=>n(!1),placement:"left"},o.createElement(xi.A,null))};var Ci=n("./src/stores/spaces/SpaceStore.ts"),ki=n("./src/utils/DAOContributionTracker.ts");const Ri=({onFinished:e,mxEvent:t})=>{const[n,r]=(0,o.useState)(!1),s=(()=>{try{const e=ki.A.getInstance();return e.extractPublicKeyFromEvent(t)}catch(e){return console.error("Failed to extract public key from message:",e),null}})(),a=()=>{e(!1)};return o.createElement(X.A,{title:(0,c._t)("Check Public Key"),onFinished:a,className:"mx_CheckPublicKeyDialog"},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("div",{className:"mx_CheckPublicKeyDialog_content"},o.createElement("p",null,(0,c._t)("The following public key was embedded in this message:")),o.createElement("div",{className:"mx_CheckPublicKeyDialog_publicKey"},o.createElement("code",null,s||(0,c._t)("No public key found"))),o.createElement("p",{className:"mx_CheckPublicKeyDialog_warning"},(0,c._t)("Please verify this public key before giving Kudos. This action cannot be undone.")))),o.createElement("div",{style:{display:"flex",justifyContent:"flex-start",gap:"12px",marginTop:"16px"}},o.createElement("button",{onClick:a,disabled:n,style:{padding:"8px 16px",border:"1px solid #ccc",borderRadius:"4px",backgroundColor:"#f5f5f5",cursor:"pointer",fontSize:"14px"}},(0,c._t)("Cancel")),o.createElement("button",{onClick:async()=>{r(!0);try{const n=f.J.safeGet(),r=t.getId(),o=t.getRoomId();if(!r||!o)return void console.error("Missing event ID or room ID for verification");console.log(" DCA VERIFICATION CONFIRMED! Starting transaction process...");const s=ki.A.getInstance();s.initialize();const a=n.getSafeUserId();await s.processVerificationForEvent(t,a,o);const l="",c={"m.relates_to":{rel_type:i.RelationType.Annotation,event_id:r,key:l},verification:!0,issued_at:Date.now(),issuer:n.getSafeUserId()};await n.sendEvent(o,i.EventType.Reaction,c),console.log(" Verification reaction sent successfully"),e(!0)}catch(t){console.error("Failed to process verification:",t),e(!1)}finally{r(!1)}},disabled:n,style:{padding:"8px 16px",border:"none",borderRadius:"4px",backgroundColor:"#007bff",color:"white",cursor:n?"not-allowed":"pointer",fontSize:"14px",opacity:n?.6:1}},n?(0,c._t)("Processing..."):(0,c._t)("Confirm Kudos"))))};var Ii=n("./src/utils/DCASettings.ts");function Ti(e){if(!e)return!1;console.log(" Checking if room is DCA:",{roomId:e.roomId,roomName:null==e?void 0:e.name,isRoom:!!e});const t=e.currentState.getStateEvents(i.EventType.SpaceParent);console.log(" Checking parent spaces:",t.length);for(const n of t){const t=n.getStateKey();if(!t)continue;const i=e.client.getRoom(t);if(console.log(" Parent room:",{parentRoomId:t,parentName:null==i?void 0:i.name,isSpace:null==i?void 0:i.isSpaceRoom()}),null!=i&&i.isSpaceRoom()&&"DCA"===i.name)return console.log(" Found DCA room in DCA space:",e.name),!0}return console.log(" Not in DCA space"),!1}function Pi(e){if(!e)return null;const t=e.client;if(e.isSpaceRoom()){const t=Ci.Ay.instance.getChildren(e.roomId).filter(e=>e.isSpaceRoom()),n=t.some(e=>"GOV"===e.name),i=t.some(e=>"DCA"===e.name);if(n&&i)return e}const n=e.currentState.getStateEvents(i.EventType.SpaceParent);for(const e of n){const n=e.getStateKey();if(!n)continue;const i=t.getRoom(n);if(!i)continue;const r=Pi(i);if(r)return r}return null}function Ni(e,t){var n,r,o,s,a;const l=Pi(e);if(l){var c,d,u,m,h;const e=l.currentState.getStateEvents(i.EventType.RoomPowerLevels,""),n=null!==(c=null==e?void 0:e.getContent())&&void 0!==c?c:{},r=null!==(d=null!==(u=null===(m=n.users)||void 0===m?void 0:m[t])&&void 0!==u?u:n.users_default)&&void 0!==d?d:0,o=null!==(h=n.verification)&&void 0!==h?h:25;if(console.log(" DAO Space power level check:",{userId:t,userLevel:r,verificationLevel:o,hasAuthority:r>=o,daoSpaceName:l.name}),r>=o)return!0}const p=e.currentState.getStateEvents(i.EventType.RoomPowerLevels,""),g=null!==(n=null==p?void 0:p.getContent())&&void 0!==n?n:{},v=null!==(r=null!==(o=null===(s=g.users)||void 0===s?void 0:s[t])&&void 0!==o?o:g.users_default)&&void 0!==r?r:0,f=null!==(a=g.verification)&&void 0!==a?a:25;return console.log(" DCA Room power level check:",{userId:t,userLevel:v,verificationLevel:f,hasAuthority:v>=f,roomName:e.name}),v>=f}const Di=({mxEvent:e,getTile:t,getReplyChain:n,permalinkCreator:i,onFocusChange:r,getRelationsForEvent:s})=>{const[a,l,d,u]=(0,Nn.EF)(),[m,h]=(0,mi.A9)(l);(0,o.useEffect)(()=>{r(a)},[r,a]);const p=(0,o.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),d(),m()},[d,m]);let g;if(a&&l.current){const r=null==t?void 0:t(),a=n(),c=l.current.getBoundingClientRect();g=o.createElement(Pn.A,(0,tn.A)({},(0,Nn.qv)(c),{mxEvent:e,permalinkCreator:i,eventTileOps:r&&r.getEventTileOps?r.getEventTileOps():void 0,collapseReplyChain:null!=a&&a.canCollapse()?a.collapse:void 0,onFinished:u,getRelationsForEvent:s}))}return o.createElement(o.Fragment,null,o.createElement(Nn.oW,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_optionsButton",title:(0,c._t)("common|options"),onClick:p,onContextMenu:p,isExpanded:a,ref:l,onFocus:m,tabIndex:h?0:-1,placement:"left"},o.createElement(Un,null)),g)},Mi=({mxEvent:e,reactions:t,onFocusChange:n,onDCADialogOpen:i})=>{var r;const[s,a,l,d]=(0,Nn.EF)(),[u,m]=(0,mi.A9)(a);(0,o.useEffect)(()=>{n(s)},[n,s]);const h=e.getRoomId()?f.J.safeGet().getRoom(e.getRoomId()):null,p=f.J.safeGet().getSafeUserId(),g=!!h&&Ti(h),v=!(!g||null==t||!t.getAnnotationsBySender())&&(null===(r=t.getAnnotationsBySender()[p])||void 0===r?void 0:r.has("")),_=e.getSender()===p,y=h?(0,Ii.ae)(h):null,b=!y||(0,Ii._Q)(y),E=!g||Ni(h,p)&&!v&&(b||!_);let w;if(h&&g&&(console.log("DCA Room detected:",h.name),console.log("User ID:",p),console.log("Message sender:",e.getSender()),console.log("Is own message:",_),console.log("User already verified:",v),console.log("Can react:",E)),s&&a.current&&E){const n=a.current.getBoundingClientRect();w=o.createElement(Nn.Ay,(0,tn.A)({},(0,Nn.qv)(n),{onFinished:d,managed:!1}),o.createElement(_i.A,{mxEvent:e,reactions:t,onFinished:d}))}const S=(0,o.useCallback)(e=>{if(e.preventDefault(),e.stopPropagation(),E){if(g)return console.log(" DCA VERIFICATION CLICKED! Opening public key check dialog..."),void(null==i||i());l(),u()}else console.log(" User cannot react - no verification authority")},[l,u,E,g,e]);return o.createElement(o.Fragment,null,o.createElement(Nn.oW,{className:"mx_MessageActionBar_iconButton "+(E?"":"mx_MessageActionBar_iconButton_disabled"),title:E?g?"Kudos!":(0,c._t)("action|react"):v?"You have already given kudos to this message":_&&!b?"Self verification is disabled in DCA settings":"Kudos authority required",onClick:E?S:e=>{e.preventDefault(),e.stopPropagation()},onContextMenu:E?S:e=>{e.preventDefault(),e.stopPropagation()},isExpanded:s&&E,ref:a,onFocus:E?u:void 0,tabIndex:m&&E?0:-1,placement:"left",disabled:!E,style:E?void 0:{opacity:.5,cursor:"not-allowed"}},g?o.createElement(ke.A,null):o.createElement(ni,null)),w)},Oi=({mxEvent:e})=>{var t;const n=(0,o.useContext)(yi.E),r=null==e||null===(t=e.getRelation())||void 0===t?void 0:t.rel_type,s=!!r&&r!==i.RelationType.Thread,a=t=>{t.preventDefault(),t.stopPropagation();const i=e.getThread();null!=i&&i.rootEvent&&!e.isThreadRoot?x.A.dispatch({action:W.r.ShowThread,rootEvent:i.rootEvent,initialEvent:e,scroll_into_view:!0,highlighted:!0,push:n.isCard}):x.A.dispatch({action:W.r.ShowThread,rootEvent:e,push:n.isCard})},l=s?(0,c._t)("threads|error_start_thread_existing_relation"):(0,c._t)("action|reply_in_thread");return o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_threadButton",disabled:s,title:l,onClick:a,onContextMenu:a,placement:"left"},o.createElement(Bn.A,null))};class Fi extends o.PureComponent{constructor(...e){super(...e),(0,S.A)(this,"state",{showCheckPublicKeyDialog:!1}),(0,S.A)(this,"onDecrypted",()=>{this.forceUpdate()}),(0,S.A)(this,"onBeforeRedaction",()=>{this.forceUpdate()}),(0,S.A)(this,"onRoomEvent",e=>{e&&e.getType()===i.EventType.RoomPinnedEvents&&this.forceUpdate()}),(0,S.A)(this,"onSent",()=>{this.forceUpdate()}),(0,S.A)(this,"onFocusChange",e=>{var t,n;null===(t=(n=this.props).onFocusChange)||void 0===t||t.call(n,e)}),(0,S.A)(this,"onReplyClick",e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType})}),(0,S.A)(this,"onEditClick",e=>{e.preventDefault(),e.stopPropagation(),(0,gn.ju)(f.J.safeGet(),this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent)}),(0,S.A)(this,"forbiddenThreadHeadMsgType",[i.MsgType.KeyVerificationRequest]),(0,S.A)(this,"onResendClick",e=>{e.preventDefault(),e.stopPropagation(),this.runActionOnFailedEv(e=>hi.A.resend(f.J.safeGet(),e))}),(0,S.A)(this,"onCancelClick",e=>{this.runActionOnFailedEv(e=>hi.A.removeFromQueue(f.J.safeGet(),e),e=>(0,gn.d1)(e.status))}),(0,S.A)(this,"onPinClick",async(e,t)=>{e.preventDefault(),e.stopPropagation(),await wi.A.pinOrUnpinEvent(f.J.safeGet(),this.props.mxEvent),Si.A.trackPinUnpinMessage(t?"Pin":"Unpin","Timeline")})}componentDidMount(){var e;this.props.mxEvent.status&&this.props.mxEvent.status!==i.EventStatus.SENT&&this.props.mxEvent.on(i.MatrixEventEvent.Status,this.onSent);f.J.safeGet().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once(i.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(i.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),null===(e=this.context.room)||void 0===e||null===(e=e.getLiveTimeline().getState(i.EventTimeline.FORWARDS))||void 0===e||e.on(i.RoomStateEvent.Events,this.onRoomEvent)}componentWillUnmount(){var e;this.props.mxEvent.off(i.MatrixEventEvent.Status,this.onSent),this.props.mxEvent.off(i.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.off(i.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),null===(e=this.context.room)||void 0===e||null===(e=e.getLiveTimeline().getState(i.EventTimeline.FORWARDS))||void 0===e||e.off(i.RoomStateEvent.Events,this.onRoomEvent)}get showReplyInThreadAction(){const e=this.context.timelineRenderingType!==kn.Ae.Thread,t=!this.forbiddenThreadHeadMsgType.includes(this.props.mxEvent.getContent().msgtype)&&!i.M_BEACON_INFO.matches(this.props.mxEvent.getType());return e&&t}runActionOnFailedEv(e,t){t||(t=()=>!0);const n=this.props.mxEvent,i=n.replacingEvent(),r=[n.localRedactionEvent(),i,n];for(const n of r)if(n&&t(n)){e(n);break}}render(){var e,t;const n=[];if((0,gn.wQ)(f.J.safeGet(),this.props.mxEvent)&&n.push(o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton",title:(0,c._t)("action|edit"),onClick:this.onEditClick,onContextMenu:this.onEditClick,key:"edit",placement:"left"},o.createElement(Qn,null))),wi.A.canPin(f.J.safeGet(),this.props.mxEvent)||wi.A.canUnpin(f.J.safeGet(),this.props.mxEvent)){const e=wi.A.isPinned(f.J.safeGet(),this.props.mxEvent);n.push(o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton",title:e?(0,c._t)("action|unpin"):(0,c._t)("action|pin"),onClick:t=>this.onPinClick(t,e),onContextMenu:t=>this.onPinClick(t,e),key:"pin",placement:"left"},e?o.createElement(jn,null):o.createElement(Hn,null)))}const r=o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton",title:(0,c._t)("action|delete"),onClick:this.onCancelClick,onContextMenu:this.onCancelClick,key:"cancel",placement:"left"},o.createElement(Wn.A,null)),s=o.createElement(Oi,{mxEvent:this.props.mxEvent,key:"reply_thread"}),a=this.props.mxEvent,l=null===(e=a.replacingEvent())||void 0===e?void 0:e.status,d=null===(t=a.localRedactionEvent())||void 0===t?void 0:t.status,u=(0,gn.d1)(a.status)||(0,gn.d1)(l)||(0,gn.d1)(d),m=[a.status,l,d].includes(i.EventStatus.NOT_SENT);if(u&&m)n.splice(0,0,o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_retryButton",title:(0,c._t)("action|retry"),onClick:this.onResendClick,onContextMenu:this.onResendClick,key:"resend",placement:"left"},o.createElement(Kn,null))),n.push(r);else{if((0,gn.qe)(this.props.mxEvent)?(this.context.canSendMessages&&(this.showReplyInThreadAction&&n.splice(0,0,s),n.splice(0,0,o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton",title:(0,c._t)("action|reply"),onClick:this.onReplyClick,onContextMenu:this.onReplyClick,key:"reply",placement:"left"},o.createElement($n,null)))),this.context.canReact&&!this.context.search&&n.splice(0,0,o.createElement(Mi,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,onDCADialogOpen:()=>this.setState({showCheckPublicKeyDialog:!0}),key:"react"})),pi.j.isEligible(this.props.mxEvent)&&n.splice(0,0,o.createElement(fi,{mxEvent:this.props.mxEvent,mediaEventHelperGet:()=>{var e,t;return null===(e=this.props.getTile())||void 0===e||null===(t=e.getMediaHelper)||void 0===t?void 0:t.call(e)},key:"download"})),pi.j.canHide(this.props.mxEvent)&&n.splice(0,0,o.createElement(Ai,{mxEvent:this.props.mxEvent,key:"hide"}))):this.context.timelineRenderingType===kn.Ae.Room&&this.props.mxEvent.getThread()&&n.unshift(s),u&&n.push(r),void 0!==this.props.isQuoteExpanded&&(0,Cn.c$)(this.props.mxEvent)){const e=me()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_expandCollapseMessageButton:!0});n.push(o.createElement(mi.k,{className:e,title:this.props.isQuoteExpanded?(0,c._t)("timeline|mab|collapse_reply_chain"):(0,c._t)("timeline|mab|expand_reply_chain"),caption:(0,c._t)(Ei.hm[bi.Uz.SHIFT])+" + "+(0,c._t)("action|click"),onClick:this.props.toggleThreadExpanded,key:"expand",placement:"left"},this.props.isQuoteExpanded?o.createElement(di,null):o.createElement(si,null)))}n.push(o.createElement(Di,{mxEvent:this.props.mxEvent,getReplyChain:this.props.getReplyChain,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu",getRelationsForEvent:this.props.getRelationsForEvent}))}return o.createElement(o.Fragment,null,o.createElement(ui.A,{className:"mx_MessageActionBar","aria-label":(0,c._t)("timeline|mab|label"),"aria-live":"off"},n),this.state.showCheckPublicKeyDialog&&o.createElement(Ri,{mxEvent:this.props.mxEvent,onFinished:e=>{this.setState({showCheckPublicKeyDialog:!1})}}))}}(0,S.A)(Fi,"contextType",kn.Ay);var Li=n("./node_modules/lodash/lodash.js"),Ui=n("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),Bi=n("./src/accessibility/context_menu/ContextMenuTooltipButton.tsx"),Vi=n("./src/customisations/Media.ts"),ji=n("./src/HtmlUtils.tsx");class zi extends o.PureComponent{render(){const{content:e,reactionEvents:t,mxEvent:n,children:i}=this.props,r=this.context.getRoom(n.getRoomId());if(r){const n=[];let a;for(const e of t){var s;const t=r.getMember(e.getSender()),i=null!==(s=null==t?void 0:t.name)&&void 0!==s?s:e.getSender();n.push(i),a=this.props.customReactionImagesEnabled&&Wi.findIn(e.getContent())||void 0}const l=(0,ji.aS)(e)||a,d=(0,sn.ki)(n,6),u=l?(0,c._t)("timeline|reactions|tooltip_caption",{shortName:l}):void 0;return o.createElement(rn.m,{description:d,caption:u,placement:"right"},i)}return i}}(0,S.A)(zi,"contextType",ce.Ay);class Hi extends o.PureComponent{constructor(...e){super(...e),(0,S.A)(this,"onClick",()=>{const{mxEvent:e,myReactionEvent:t,content:n}=this.props;""===n&&this.isDCARoom(e.getRoomId())?console.log(" Kudos reaction removal blocked in DCA room"):t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),i.EventType.Reaction,{"m.relates_to":{rel_type:i.RelationType.Annotation,event_id:e.getId(),key:n}}),x.A.dispatch({action:"message_sent"}))})}isDCARoom(e){const t=this.context.getRoom(e);if(!t)return!1;const n=t.currentState.getStateEvents(i.EventType.SpaceParent);for(const e of n){const t=e.getStateKey();if(!t)continue;const n=this.context.getRoom(t);if(n){if(n.isSpaceRoom()&&"DCA"===n.name)return!0;if(this.isDCARoom(t))return!0}}return!1}render(){const{mxEvent:e,content:t,count:n,reactionEvents:i,myReactionEvent:r}=this.props,s=""===t&&this.isDCARoom(e.getRoomId()),a=this.props.disabled||s,l=me()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!r}),d=this.context.getRoom(e.getRoomId());let u,m;if(d){const e=[];for(const t of i){const n=d.getMember(t.getSender());e.push((null==n?void 0:n.name)||t.getSender()),m=this.props.customReactionImagesEnabled&&Wi.findIn(t.getContent())||void 0}const n=(0,sn.ki)(e,6);u=t?(0,c._t)("timeline|reactions|label",{reactors:n,content:m||t}):n}let h=o.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t);if(this.props.customReactionImagesEnabled&&t.startsWith("mxc://")){const e=(0,Vi.mediaFromMxc)(t).srcHttp;e&&(h=o.createElement("img",{className:"mx_ReactionsRowButton_content",alt:m||(0,c._t)("timeline|reactions|custom_reaction_fallback_label"),src:e,width:"16",height:"16"}))}return o.createElement(zi,{mxEvent:this.props.mxEvent,content:t,reactionEvents:i,customReactionImagesEnabled:this.props.customReactionImagesEnabled},o.createElement(ae.A,{className:l,"aria-label":u,onClick:this.onClick,disabled:a,title:s?"Verification cannot be removed":void 0},h,o.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},n)))}}(0,S.A)(Hi,"contextType",ce.Ay);const Wi=new Ui.qr("shortcode","com.beeper.reaction.shortcode"),Gi=({mxEvent:e,reactions:t})=>{const[n,i,r,s]=(0,Nn.EF)();let a;if(n&&i.current){const n=i.current.getBoundingClientRect();a=o.createElement(Nn.Ay,(0,tn.A)({},(0,Nn.qv)(n),{onFinished:s,managed:!1}),o.createElement(_i.A,{mxEvent:e,reactions:t,onFinished:s}))}return o.createElement(o.Fragment,null,o.createElement(Bi.o,{className:me()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:n}),title:(0,c._t)("timeline|reactions|add_reaction_prompt"),onClick:r,onContextMenu:e=>{e.preventDefault(),r()},isExpanded:n,ref:i}),a)};class Ki extends o.PureComponent{constructor(e,t){super(e,t),(0,S.A)(this,"onDecrypted",()=>{this.forceUpdate()}),(0,S.A)(this,"onReactionsChange",()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()}),(0,S.A)(this,"onShowAllClick",()=>{this.setState({showAll:!0})}),this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once(i.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.on(i.RelationsEvent.Add,this.onReactionsChange),t.on(i.RelationsEvent.Remove,this.onReactionsChange),t.on(i.RelationsEvent.Redaction,this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off(i.MatrixEventEvent.Decrypted,this.onDecrypted),t&&(t.off(i.RelationsEvent.Add,this.onReactionsChange),t.off(i.RelationsEvent.Remove,this.onReactionsChange),t.off(i.RelationsEvent.Redaction,this.onReactionsChange))}componentDidUpdate(e){this.props.reactions&&e.reactions!==this.props.reactions&&(this.props.reactions.on(i.RelationsEvent.Add,this.onReactionsChange),this.props.reactions.on(i.RelationsEvent.Remove,this.onReactionsChange),this.props.reactions.on(i.RelationsEvent.Redaction,this.onReactionsChange),this.onReactionsChange())}getMyReactions(){var e,t;const n=this.props.reactions;if(!n)return null;const i=null===(e=this.context.room)||void 0===e?void 0:e.client.getUserId();if(!i)return null;const r=null===(t=n.getAnnotationsBySender())||void 0===t?void 0:t[i];return r?[...r.values()]:null}render(){var e,t;const{mxEvent:n,reactions:i}=this.props,{myReactions:r,showAll:s}=this.state;if(!i||!(0,gn.qe)(n))return null;const a=O.A.getValue("feature_render_reaction_images");let l,d,u=null===(e=i.getSortedAnnotationsByKey())||void 0===e?void 0:e.map(([e,t])=>{if(!t.size)return null;const i=(0,Li.uniqBy)([...t],e=>e.getSender()),s=null==r?void 0:r.find(t=>{var n;return!t.isRedacted()&&(null===(n=t.getRelation())||void 0===n?void 0:n.key)===e});return o.createElement(Hi,{key:e,content:e,count:i.length,mxEvent:n,reactionEvents:i,myReactionEvent:s,customReactionImagesEnabled:a,disabled:!this.context.canReact||s&&!s.isRedacted()&&!this.context.canSelfRedact})}).filter(e=>!!e);return null!==(t=u)&&void 0!==t&&t.length?(u.length>9&&!s&&(u=u.slice(0,8),l=o.createElement(ae.A,{kind:"link_inline",className:"mx_ReactionsRow_showAll",onClick:this.onShowAllClick},(0,c._t)("action|show_all"))),this.context.canReact&&(d=o.createElement(Gi,{mxEvent:n,reactions:i})),o.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":(0,c._t)("common|reactions")},u,l,d)):null}}(0,S.A)(Ki,"contextType",kn.Ay);var qi,$i=n("./src/utils/strings.ts"),Ji=n("./node_modules/bloom-filters/dist/bloom/scalable-bloom-filter.js"),Yi=n.n(Ji),Xi=n("./src/utils/crypto/index.ts");function Qi(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}const Zi="mx_decryption_failure_event_ids";class er{constructor(e,t,n,i,r,o){(0,S.A)(this,"timeToDecryptMillis",void 0),this.failedEventId=e,this.errorCode=t,this.ts=n,this.isFederated=i,this.wasVisibleToUser=r,this.userTrustsOwnIdentity=o}}class tr{constructor(e,t,n=!0){if((0,S.A)(this,"failures",new Map),(0,S.A)(this,"visibleEvents",new Set),(0,S.A)(this,"reportedEvents",new(Yi())),(0,S.A)(this,"checkInterval",null),(0,S.A)(this,"trackInterval",null),(0,S.A)(this,"baseProperties",{}),(0,S.A)(this,"userDomain",void 0),(0,S.A)(this,"userTrustsOwnIdentity",void 0),(0,S.A)(this,"checkingVerificationStatus",!1),(0,S.A)(this,"retryVerificationStatus",!1),this.fn=e,this.errorCodeMapFn=t,this.checkReportedEvents=n,!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if("function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}static get instance(){return tr.internalInstance}loadReportedEvents(){const e=localStorage.getItem(Zi);this.reportedEvents=e?Yi().fromJSON(JSON.parse(e)):new(Yi())}saveReportedEvents(){localStorage.setItem(Zi,JSON.stringify(this.reportedEvents.saveAsJSON()))}eventDecrypted(e,t){if(e.getWireContent().algorithm!=Xi.Q)return;const n=e.decryptionFailureReason;if(null===n)return void this.removeDecryptionFailuresForEvent(e,t);const i=e.getId();if(this.reportedEvents.has(i)&&this.checkReportedEvents)return;const r=this.failures.get(i),o=r?r.ts:t,s=e.getSender(),a=null==s?void 0:s.replace(/^.*?:/,"");let l;void 0!==this.userDomain&&void 0!==a&&(l=this.userDomain!==a);const c=this.visibleEvents.has(i);this.failures.set(i,new er(i,n,o,l,c,this.userTrustsOwnIdentity))}addVisibleEvent(e){const t=e.getId();if(this.reportedEvents.has(t)&&this.checkReportedEvents)return;const n=this.failures.get(t);n&&(n.wasVisibleToUser=!0),this.visibleEvents.add(t)}removeDecryptionFailuresForEvent(e,t){const n=e.getId(),i=this.failures.get(n);if(i){this.failures.delete(n);const e=t-i.ts;if(e<tr.GRACE_PERIOD_MS)return;e<=tr.MAXIMUM_LATE_DECRYPTION_PERIOD&&(i.timeToDecryptMillis=e),this.reportFailure(i)}}async handleKeysChanged(e){if(this.checkingVerificationStatus)this.retryVerificationStatus=!0;else{this.checkingVerificationStatus=!0;try{do{this.retryVerificationStatus=!1,this.userTrustsOwnIdentity=(await e.getCrypto().getUserVerificationStatus(e.getUserId())).isCrossSigningVerified()}while(this.retryVerificationStatus)}finally{this.checkingVerificationStatus=!1}}}async start(e){this.loadReportedEvents(),await this.calculateClientProperties(e),this.registerHandlers(e),this.checkInterval=window.setInterval(()=>this.checkFailures(Date.now()),tr.CHECK_INTERVAL_MS)}async calculateClientProperties(e){var t;const n={};this.baseProperties=n,this.userDomain=null!==(t=e.getDomain())&&void 0!==t?t:void 0,"matrix.org"===this.userDomain?n.isMatrixDotOrg=!0:void 0!==this.userDomain&&(n.isMatrixDotOrg=!1);const i=e.getCrypto();if(i){i.getVersion().startsWith("Rust SDK")?n.cryptoSDK="Rust":n.cryptoSDK="Legacy",this.userTrustsOwnIdentity=(await i.getUserVerificationStatus(e.getUserId())).isCrossSigningVerified()}}registerHandlers(e){const t=e=>this.eventDecrypted(e,Date.now()),n=()=>{this.handleKeysChanged(e).catch(e=>{console.log("Error handling KeysChanged event",e)})},r=()=>{e.removeListener(i.MatrixEventEvent.Decrypted,t),e.removeListener(V.cr.KeysChanged,n),e.removeListener(i.HttpApiEvent.SessionLoggedOut,r),this.stop()};e.on(i.MatrixEventEvent.Decrypted,t),e.on(V.cr.KeysChanged,n),e.on(i.HttpApiEvent.SessionLoggedOut,r)}stop(){this.checkInterval&&clearInterval(this.checkInterval),this.trackInterval&&clearInterval(this.trackInterval),this.userTrustsOwnIdentity=void 0,this.failures=new Map,this.visibleEvents=new Set}checkFailures(e){const t=new Map;for(const[n,i]of this.failures)void 0!==i.timeToDecryptMillis||e>i.ts+tr.MAXIMUM_LATE_DECRYPTION_PERIOD?this.reportFailure(i):t.set(n,i);this.failures=t,this.saveReportedEvents()}reportFailure(e){var t;const n=e.errorCode,i=this.errorCodeMapFn(n),r={timeToDecryptMillis:null!==(t=e.timeToDecryptMillis)&&void 0!==t?t:-1,wasVisibleToUser:e.wasVisibleToUser};void 0!==e.isFederated&&(r.isFederated=e.isFederated),void 0!==e.userTrustsOwnIdentity&&(r.userTrustsOwnIdentity=e.userTrustsOwnIdentity),this.baseProperties&&Object.assign(r,this.baseProperties),this.fn(i,n,r),this.reportedEvents.add(e.failedEventId),this.visibleEvents.delete(e.failedEventId)}}qi=tr,(0,S.A)(tr,"internalInstance",new qi((e,t,n)=>{const i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qi(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qi(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({eventName:"Error",domain:"E2EE",name:e,context:`mxc_crypto_error_type_${t}`},n);z.Vo.instance.trackEvent(i)},e=>{switch(e){case V.RT.MEGOLM_UNKNOWN_INBOUND_SESSION_ID:case V.RT.MEGOLM_KEY_WITHHELD:return"OlmKeysNotSentError";case V.RT.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:return"RoomKeysWithheldForUnverifiedDevice";case V.RT.OLM_UNKNOWN_MESSAGE_INDEX:return"OlmIndexError";case V.RT.HISTORICAL_MESSAGE_NO_KEY_BACKUP:case V.RT.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED:case V.RT.HISTORICAL_MESSAGE_WORKING_BACKUP:return"HistoricalMessage";case V.RT.HISTORICAL_MESSAGE_USER_NOT_JOINED:return"ExpectedDueToMembership";case V.RT.SENDER_IDENTITY_PREVIOUSLY_VERIFIED:return"ExpectedVerificationViolation";case V.RT.UNSIGNED_SENDER_DEVICE:return"ExpectedSentByInsecureDevice";default:return"UnknownError"}})),(0,S.A)(tr,"CHECK_INTERVAL_MS",4e4),(0,S.A)(tr,"GRACE_PERIOD_MS",4e3),(0,S.A)(tr,"MAXIMUM_LATE_DECRYPTION_PERIOD",6e4);var nr=n("./src/components/views/messages/RedactedBody.tsx"),ir=n("./src/components/structures/ViewSource.tsx");class rr extends o.Component{constructor(e){super(e),(0,S.A)(this,"onBugReport",()=>{R.Ay.createDialog(Gt.A,{label:"react-soft-crash-tile",error:this.state.error})}),(0,S.A)(this,"onViewSource",()=>{R.Ay.createDialog(ir.A,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")}),this.state={}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let n,i;return d.Ay.get().bug_report_endpoint_url&&(n=o.createElement(o.Fragment,null,"",o.createElement(ae.A,{kind:"link",onClick:this.onBugReport},(0,c._t)("bug_reporting|submit_debug_logs")))),e&&O.A.getValue("developerMode")&&(i=o.createElement(o.Fragment,null,"",o.createElement(ae.A,{onClick:this.onViewSource,kind:"link"},(0,c._t)("action|view_source")))),o.createElement("li",{className:me()(t),"data-layout":this.props.layout},o.createElement("div",{className:"mx_EventTile_line"},o.createElement("span",null,(0,c._t)("timeline|error_rendering_message"),e&&` (${e.getType()})`,n,i)))}return this.props.children}}var or=n("./node_modules/@vector-im/compound-web/dist/components/Icon/IndicatorIcon/IndicatorIcon.js");function sr(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M4 3h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6l-2.293 2.293c-.63.63-1.707.184-1.707-.707V5a2 2 0 0 1 2-2m3 7h10q.424 0 .712-.287A.97.97 0 0 0 18 9a.97.97 0 0 0-.288-.713A.97.97 0 0 0 17 8H7a.97.97 0 0 0-.713.287A.97.97 0 0 0 6 9q0 .424.287.713Q6.576 10 7 10m0 4h6q.424 0 .713-.287A.97.97 0 0 0 14 13a.97.97 0 0 0-.287-.713A.97.97 0 0 0 13 12H7a.97.97 0 0 0-.713.287A.97.97 0 0 0 6 13q0 .424.287.713Q6.576 14 7 14"})})}sr.displayName="ThreadsSolidIcon";const ar=(0,o.forwardRef)(sr);var lr=n("./src/hooks/useEventEmitter.ts"),cr=n("./src/hooks/useUnreadNotifications.ts"),dr=n("./src/utils/notifications.ts"),ur=n("./src/stores/room-list/MessagePreviewStore.ts"),mr=n("./src/hooks/useAsyncMemo.ts");const hr=["mxEvent","className"],pr=["preview","className"];function gr(e){let{mxEvent:t,className:n}=e,i=(0,v.A)(e,hr);const r=fr(t);return r?o.createElement(vr,(0,tn.A)({},i,{preview:r,className:n})):null}function vr(e){let{preview:[t,n],className:i}=e,r=(0,v.A)(e,pr);const s=me()("mx_EventPreview",i);return n?o.createElement("span",(0,tn.A)({},r,{className:s}),(0,c._t)("event_preview|preview",{prefix:n,preview:t},{bold:e=>o.createElement("span",{className:"mx_EventPreview_prefix"},e)})):o.createElement("span",(0,tn.A)({},r,{className:s,title:t}),t)}function fr(e){const t=(0,o.useContext)(ce.Ay),[n,r]=(0,o.useState)(null==e?void 0:e.getContent());(0,lr.YK)(null!=e?e:void 0,i.MatrixEventEvent.Replaced,()=>{r(e.getContent())});const s=(null==e?void 0:e.shouldAttemptDecryption())||(null==e?void 0:e.isBeingDecrypted());return(0,lr.YK)(s&&null!=e?e:void 0,i.MatrixEventEvent.Decrypted,()=>{r(e.getContent())}),(0,mr.e)(async()=>!e||e.isRedacted()||e.isDecryptionFailure()?null:(await t.decryptEventIfNeeded(e),[ur.X.instance.generatePreviewForEvent(e),_r(e.getType(),null==n?void 0:n.msgtype)]),[e,n],null)}function _r(e,t){if(e===i.M_POLL_START.name)return(0,c._t)("event_preview|prefix|poll");switch(t){case i.MsgType.Audio:return(0,c._t)("event_preview|prefix|audio");case i.MsgType.Image:return(0,c._t)("event_preview|prefix|image");case i.MsgType.Video:return(0,c._t)("event_preview|prefix|video");case i.MsgType.File:return(0,c._t)("event_preview|prefix|file");default:return null}}var yr=n("./src/contexts/ScopedRoomContext.tsx");const br=["mxEvent","thread"],Er=({thread:e,showDisplayname:t=!1})=>{var n,r,s;const a=null!==(n=(0,lr.DY)(e,i.ThreadEvent.Update,()=>e.replyToEvent))&&void 0!==n?n:void 0,l=fr(a);return l&&a?o.createElement(o.Fragment,null,o.createElement(bn.A,{member:a.sender,fallbackUserId:a.getSender(),size:"24px",className:"mx_ThreadSummary_avatar"}),t&&o.createElement("div",{className:"mx_ThreadSummary_sender"},null!==(r=null===(s=a.sender)||void 0===s?void 0:s.name)&&void 0!==r?r:a.getSender()),a.isDecryptionFailure()?o.createElement("div",{className:"mx_ThreadSummary_content mx_DecryptionFailureBody",title:(0,c._t)("timeline|decryption_failure|unable_to_decrypt")},(0,c._t)("timeline|decryption_failure|unable_to_decrypt")):o.createElement(vr,{preview:l,className:"mx_ThreadSummary_content"})):null},wr=e=>{let{mxEvent:t,thread:n}=e,r=(0,v.A)(e,br);const s=(0,yr.ME)("narrow"),a=(0,o.useContext)(yi.E),l=(0,lr.DY)(n,i.ThreadEvent.Update,()=>n.length),{level:d}=(0,cr.X)(n.room,n.id);if(!l)return null;let u=l;return s.narrow||(u=(0,c._t)("threads|count_of_reply",{count:l})),o.createElement(ae.A,(0,tn.A)({},r,{className:"mx_ThreadSummary",onClick:e=>{x.A.dispatch({action:W.r.ShowThread,rootEvent:t,push:a.isCard}),Si.A.trackInteraction("WebRoomTimelineThreadSummaryButton",e)},"aria-label":(0,c._t)("threads|open_thread")}),o.createElement(or.N,{size:"24px",indicator:(0,dr.W7)(d)},o.createElement(ar,null)),o.createElement("span",{className:"mx_ThreadSummary_replies_amount"},u),o.createElement(Er,{thread:n,showDisplayname:!s.narrow}),o.createElement("div",{className:"mx_ThreadSummary_chevron"}))};class Sr extends o.Component{constructor(e){super(e),(0,S.A)(this,"nodes",{}),(0,S.A)(this,"children",{}),this.updateChildren(this.props.children)}componentDidUpdate(){this.updateChildren(this.props.children)}applyStyles(e,t){t&&Object.entries(t).forEach(([t,n])=>{e.style[t]=n})}updateChildren(e){const t=this.children||{};this.children={},o.Children.toArray(e).forEach(e=>{if(!function(e){return"object"==typeof e&&"type"in e}(e))return;const n=e.props;if(t[e.key]){const i=t[e.key],r=this.nodes[i.key];r&&n.style&&r.style.left!==n.style.left&&this.applyStyles(r,{left:n.style.left}),this.children[e.key]=o.cloneElement(i,n,n.children)}else{const t={},i=n.style,r=this.props.startStyles;if(r.length>0){const e=r[0];t.style=e}t.ref=t=>this.collectNode(e.key,t,i),this.children[e.key]=o.cloneElement(e,t)}})}collectNode(e,t,n){const i="bigint"==typeof e?Number(e):e;if(t&&void 0===this.nodes[i]&&this.props.startStyles.length>0){const e=this.props.startStyles;for(let n=1;n<e.length;++n)this.applyStyles(t,e[n]);window.setTimeout(()=>{this.applyStyles(t,n)},0)}t?this.nodes[i]=t:delete this.nodes[i],this.props.innerRef&&(this.props.innerRef.current=t)}render(){return o.createElement(o.Fragment,null,Object.values(this.children))}}(0,S.A)(Sr,"defaultProps",{startStyles:[]});var xr=n("./src/utils/units.ts");class Ar extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"avatar",(0,o.createRef)()),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptPosition;e&&(this.props.checkUnmounting&&this.props.checkUnmounting()||this.buildReadReceiptInfo(e))}componentDidMount(){this.state.suppressDisplay&&this.animateMarker()}componentDidUpdate(e){const t=e.offset!==this.props.offset,n=e.hidden!==this.props.hidden;(t||n)&&this.animateMarker()}buildReadReceiptInfo(e={}){const t=this.avatar.current,n=null==t?void 0:t.offsetParent;if(!n||!n.getBoundingClientRect)return s.vF.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid horizontalContainer`),e.top=0,e.right=0,e;const i=t.getBoundingClientRect();return e.top=i.top,e.right=i.right-n.getBoundingClientRect().right,e}animateMarker(){var e;const t=this.props.readReceiptPosition,n=null!==(e=this.buildReadReceiptInfo().top)&&void 0!==e?e:0,i=t&&void 0!==t.top?t.top:-kr,r=[];null!=t&&t.right&&r.push({top:i-n,right:t.right}),r.push({top:i-n,right:0}),this.setState({suppressDisplay:!1,startStyles:r})}render(){var e;if(this.state.suppressDisplay)return o.createElement("div",{ref:this.avatar});const t={right:(0,xr.c)(this.props.offset),top:"0px"};return o.createElement(Sr,{startStyles:this.state.startStyles,innerRef:this.avatar},o.createElement(bn.A,{member:null!==(e=this.props.member)&&void 0!==e?e:null,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true","aria-live":"off",size:"14px",style:t,hideTitle:!0,tabIndex:-1}))}}var Cr=n("./src/components/structures/AutoHideScrollbar.tsx");const kr=16;function Rr({readReceipts:e,readReceiptMap:t,checkUnmounting:n,suppressAnimation:i,isTwelveHour:r}){const[s,a,l,d]=(0,Nn.EF)(),u=e.length>4?3:4,m=function(e,t){return(0,sn.ki)(e,t)}(e.map(e=>{var t,n;return null!==(t=null===(n=e.roomMember)||void 0===n?void 0:n.name)&&void 0!==t?t:e.userId}),u);if(0===e.length)return o.createElement("div",{className:"mx_EventTile_msgOption"},o.createElement("div",{className:"mx_ReadReceiptGroup"},o.createElement("div",{className:"mx_ReadReceiptGroup_button"},o.createElement("span",{className:"mx_ReadReceiptGroup_container"}))));const h=e.map((e,s)=>{const{hidden:a,position:l}=function(e,t){return e<t?{hidden:!1,position:e}:{hidden:!0,position:0}}(s,u),c=e.userId;let d;return t&&(d=t[c],d||(d={},t[c]=d)),o.createElement(Ar,{key:c,member:e.roomMember,fallbackUserId:c,offset:10*l,hidden:a,readReceiptPosition:d,checkUnmounting:n,suppressAnimation:i,timestamp:e.ts,showTwelveHour:r})}).reverse();let p;const g=e.length-u;let v;if(g>0&&(p=o.createElement("span",{className:"mx_ReadReceiptGroup_remainder","aria-live":"off"},"+",g)),s&&a.current){const t=a.current.getBoundingClientRect();v=o.createElement(Nn.Ay,(0,tn.A)({menuClassName:"mx_ReadReceiptGroup_popup",onFinished:d},(0,Nn.qv)(t)),o.createElement(Cr.A,null,o.createElement(Tr,{className:"mx_ReadReceiptGroup_title"},(0,c._t)("timeline|read_receipt_title",{count:e.length})),e.map(e=>o.createElement(Ir,(0,tn.A)({key:e.userId},e,{isTwelveHour:r,onAfterClick:d})))))}return o.createElement("div",{className:"mx_EventTile_msgOption"},o.createElement(rn.m,{label:(0,c._t)("timeline|read_receipt_title",{count:e.length}),caption:m,placement:"top-end"},o.createElement("div",{className:"mx_ReadReceiptGroup",role:"group","aria-label":(0,c._t)("timeline|read_receipts_label")},o.createElement(ae.A,{className:"mx_ReadReceiptGroup_button",ref:a,"aria-label":m,"aria-haspopup":"true",onClick:l},p,o.createElement("span",{className:"mx_ReadReceiptGroup_container",style:{width:10*Math.min(u,e.length)+kr-10}},h)),v)))}function Ir({userId:e,roomMember:t,ts:n,isTwelveHour:i,onAfterClick:r}){var s,a;return o.createElement(rn.m,{description:null!==(s=null==t?void 0:t.rawDisplayName)&&void 0!==s?s:e,caption:e,placement:"top"},o.createElement("div",null,o.createElement(Nn.Dr,{className:"mx_ReadReceiptGroup_person",onClick:()=>{x.A.dispatch({action:W.r.ViewUser,member:null!=t?t:{userId:e},push:!1}),null==r||r()}},o.createElement(bn.A,{member:t,fallbackUserId:e,size:"24px","aria-hidden":"true","aria-live":"off",resizeMethod:"crop",hideTitle:!0}),o.createElement("div",{className:"mx_ReadReceiptGroup_name"},o.createElement("p",null,null!==(a=null==t?void 0:t.name)&&void 0!==a?a:e),o.createElement("p",{className:"mx_ReadReceiptGroup_secondary"},(0,gt.Yq)(new Date(n),i))))))}function Tr({className:e,children:t}){const[n,,i]=(0,mi.A9)();return o.createElement("h3",{className:e,role:"menuitem",onFocus:n,tabIndex:-1,ref:i},t)}var Pr=n("./src/utils/localRoom/isLocalRoom.ts"),Nr=n("./src/components/views/rooms/NotificationBadge/StatelessNotificationBadge.tsx");function Dr({room:e,threadId:t,forceDot:n}){const{symbol:i,count:r,level:s}=(0,cr.X)(e,t);return o.createElement(Nr.V,{symbol:i,count:r,level:s,forceDot:n})}var Mr,Or=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/link.js");function Fr(){return Fr=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Fr.apply(null,arguments)}var Lr=function(e,t){return o.createElement("svg",Fr({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),Mr||(Mr=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M1 2.75A.75.75 0 0 1 1.75 2h.005a.75.75 0 0 1 0 1.5H1.75A.75.75 0 0 1 1 2.75m2.495 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5h-.005a.75.75 0 0 1-.75-.75M1 6.75A.75.75 0 0 1 1.75 6h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 1 6.75m0 3A.75.75 0 0 1 1.75 9h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 1 9.75m0 4a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1-.75-.75m2.495 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 0 1.5h-.01a.75.75 0 0 1-.75-.75m2.5 0a.75.75 0 0 1 .75-.75h.005a.75.75 0 0 1 0 1.5h-.005a.75.75 0 0 1-.75-.75",clipRule:"evenodd"})))},Ur=(0,o.forwardRef)(Lr);function Br({viewInRoom:e,copyLinkToThread:t}){return o.createElement(ui.A,{className:"mx_MessageActionBar","aria-label":(0,c._t)("timeline|mab|label"),"aria-live":"off"},o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton",onClick:e,title:(0,c._t)("timeline|mab|view_in_room"),key:"view_in_room"},o.createElement(Ur,null)),o.createElement(mi.k,{className:"mx_MessageActionBar_iconButton",onClick:t,title:(0,c._t)("timeline|mab|copy_link_thread"),key:"copy_link_to_thread"},o.createElement(Or.A,null)))}function Vr(e){return e.getUnsigned()["io.element.late_event"]}function jr(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M5.769 2.857A.5.5 0 0 1 6.119 2h11.762a.5.5 0 0 1 .35.857L16.15 4.9a.5.5 0 0 0-.15.357v4.487a.5.5 0 0 0 .15.356l3.7 3.644a.5.5 0 0 1 .15.356v1.4a.5.5 0 0 1-.5.5H13v6a1 1 0 1 1-2 0v-6H4.5a.5.5 0 0 1-.5-.5v-1.4a.5.5 0 0 1 .15-.356l3.7-3.644A.5.5 0 0 0 8 9.744V5.257a.5.5 0 0 0-.15-.357z"})})}jr.displayName="PinSolidIcon";const zr=(0,o.forwardRef)(jr);function Hr(){return o.createElement("div",{className:"mx_PinnedMessageBadge"},o.createElement(zr,{width:"16px",height:"16px"}),(0,c._t)("room|pinned_message_badge"))}function Wr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function Gr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Wr(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Wr(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function Kr(e){return!(!(0,vn.S8)(e)&&e.getType()!==i.EventType.RoomMessageEncrypted)}class qr extends o.Component{constructor(e,t){super(e,t),(0,S.A)(this,"suppressReadReceiptAnimation",void 0),(0,S.A)(this,"isListeningForReceipts",void 0),(0,S.A)(this,"tile",(0,o.createRef)()),(0,S.A)(this,"replyChain",(0,o.createRef)()),(0,S.A)(this,"ref",(0,o.createRef)()),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"updateThread",e=>{this.setState({thread:e})}),(0,S.A)(this,"onNewThread",e=>{if(e.id===this.props.mxEvent.getId()){this.updateThread(e);const t=f.J.safeGet().getRoom(this.props.mxEvent.getRoomId());null==t||t.off(i.ThreadEvent.New,this.onNewThread)}}),(0,S.A)(this,"viewInRoom",e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0})}),(0,S.A)(this,"copyLinkToThread",async e=>{e.preventDefault(),e.stopPropagation();const{permalinkCreator:t,mxEvent:n}=this.props;if(!t)return;const i=t.forEvent(n.getId());await(0,$i.nC)(i)}),(0,S.A)(this,"onRoomReceipt",(e,t)=>{t===f.J.safeGet().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate(()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(f.J.safeGet().removeListener(i.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!1)})}),(0,S.A)(this,"onDecrypted",()=>{this.verifyEvent(),this.forceUpdate()}),(0,S.A)(this,"onUserVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent()}),(0,S.A)(this,"onReplaced",()=>{this.verifyEvent()}),(0,S.A)(this,"onSenderProfileClick",()=>{x.A.dispatch({action:W.r.ComposerInsert,userId:this.props.mxEvent.getSender(),timelineRenderingType:this.context.timelineRenderingType})}),(0,S.A)(this,"onPermalinkClicked",e=>{e.preventDefault(),x.A.dispatch({action:W.r.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:this.context.timelineRenderingType===kn.Ae.Search?"MessageSearch":void 0})}),(0,S.A)(this,"onActionBarFocusChange",e=>{this.setState({actionBarFocused:e})}),(0,S.A)(this,"getTile",()=>this.tile.current),(0,S.A)(this,"getReplyChain",()=>this.replyChain.current),(0,S.A)(this,"getReactions",()=>{var e;if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const t=this.props.mxEvent.getId();return null!==(e=this.props.getRelationsForEvent(t,"m.annotation","m.reaction"))&&void 0!==e?e:null}),(0,S.A)(this,"onReactionsCreated",(e,t)=>{"m.annotation"===e&&"m.reaction"===t&&this.setState({reactions:this.getReactions()})}),(0,S.A)(this,"onContextMenu",e=>{this.showContextMenu(e)}),(0,S.A)(this,"onTimestampContextMenu",e=>{var t;this.showContextMenu(e,null===(t=this.props.permalinkCreator)||void 0===t?void 0:t.forEvent(this.props.mxEvent.getId()))}),(0,S.A)(this,"onCloseMenu",()=>{this.setState({contextMenu:void 0,actionBarFocused:!1})}),(0,S.A)(this,"setQuoteExpanded",e=>{this.setState({isQuoteExpanded:e})});const n=this.thread;this.state={actionBarFocused:!1,shieldColour:V.so.NONE,shieldReason:null,reactions:this.getReactions(),hover:!1,thread:n},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!f.J.safeGet().getRoom(this.props.mxEvent.getRoomId()))return!1;const e=f.J.safeGet().getSafeUserId();return this.props.mxEvent.getSender()===e&&Kr(this.props.mxEvent)}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&this.props.eventSendStatus!==i.EventStatus.SENT)return!1;const e=this.props.readReceipts||[],t=f.J.safeGet().getUserId();return!e.some(e=>e.userId!==t)}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||this.props.eventSendStatus===i.EventStatus.SENT)}componentDidMount(){this.unmounted=!1,this.suppressReadReceiptAnimation=!1;const e=f.J.safeGet();this.props.forExport||(e.on(V.cr.UserTrustStatusChanged,this.onUserVerificationChanged),this.props.mxEvent.on(i.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.on(i.MatrixEventEvent.Replaced,this.onReplaced),tr.instance.addVisibleEvent(this.props.mxEvent),this.props.showReactions&&this.props.mxEvent.on(i.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on(i.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0)),this.props.mxEvent.on(i.ThreadEvent.Update,this.updateThread),e.decryptEventIfNeeded(this.props.mxEvent);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.on(i.ThreadEvent.New,this.onNewThread),this.verifyEvent()}shouldComponentUpdate(e,t){return!!(0,Dn.No)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=f.J.get();if(e){e.removeListener(V.cr.UserTrustStatusChanged,this.onUserVerificationChanged),e.removeListener(i.RoomEvent.Receipt,this.onRoomReceipt);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.off(i.ThreadEvent.New,this.onNewThread)}this.isListeningForReceipts=!1,this.props.mxEvent.removeListener(i.MatrixEventEvent.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(i.MatrixEventEvent.Replaced,this.onReplaced),this.props.showReactions&&this.props.mxEvent.removeListener(i.MatrixEventEvent.RelationsCreated,this.onReactionsCreated),this.props.mxEvent.off(i.ThreadEvent.Update,this.updateThread),this.unmounted=!1,this.props.resizeObserver&&this.ref.current&&this.props.resizeObserver.unobserve(this.ref.current)}componentDidUpdate(e,t){this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(f.J.safeGet().on(i.RoomEvent.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0),e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent(),this.props.resizeObserver&&this.ref.current&&this.props.resizeObserver.observe(this.ref.current)}get thread(){let e=this.props.mxEvent.getThread();if(!e){var t;const n=f.J.safeGet().getRoom(this.props.mxEvent.getRoomId());e=null!==(t=null==n?void 0:n.findThreadForEvent(this.props.mxEvent))&&void 0!==t?t:void 0}return null!=e?e:null}renderThreadPanelSummary(){return this.state.thread?o.createElement("div",{className:"mx_ThreadPanel_replies"},o.createElement("span",{className:"mx_ThreadPanel_replies_amount"},this.state.thread.length),o.createElement(Er,{thread:this.state.thread})):null}renderThreadInfo(){return this.state.thread&&this.state.thread.id===this.props.mxEvent.getId()?o.createElement(wr,{mxEvent:this.props.mxEvent,thread:this.state.thread}):this.context.timelineRenderingType===kn.Ae.Search&&this.props.mxEvent.threadRootId?this.props.highlightLink?o.createElement("a",{className:"mx_ThreadSummary_icon",href:this.props.highlightLink},(0,c._t)("timeline|thread_info_basic")):o.createElement("p",{className:"mx_ThreadSummary_icon"},(0,c._t)("timeline|thread_info_basic")):void 0}verifyEvent(){this.doVerifyEvent().catch(e=>{const t=this.props.mxEvent;s.vF.error(`Error getting encryption info on event ${t.getId()} in room ${t.getRoomId()}`,e)})}async doVerifyEvent(){var e,t,n;const i=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if(!i.isEncrypted()||i.isRedacted())return void this.setState({shieldColour:V.so.NONE,shieldReason:null});const r=null!==(t=await(null===(n=f.J.safeGet().getCrypto())||void 0===n?void 0:n.getEncryptionInfoForEvent(i)))&&void 0!==t?t:null;this.unmounted||(null!==r?this.setState({shieldColour:r.shieldColour,shieldReason:r.shieldReason}):this.setState({shieldColour:V.so.NONE,shieldReason:null}))}propsEqual(e,t){const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(let i=0;i<n.length;i++){const r=n[i];if(!t.hasOwnProperty(r))return!1;if("readReceipts"===r){const n=e[r],i=t[r];if(n===i)continue;if(!n||!i)return!1;if(n.length!==i.length)return!1;for(let e=0;e<n.length;e++){if(n[e].userId!==i[e].userId)return!1;if(n[e].roomMember!==i[e].roomMember)return!1}}else if(e[r]!==t[r])return!1}return!0}shouldHighlight(){if(this.props.forExport)return!1;if(this.context.timelineRenderingType===kn.Ae.Notification)return!1;if(this.context.timelineRenderingType===kn.Ae.ThreadsList)return!1;if(this.props.isRedacted)return!1;const e=f.J.safeGet(),t=e.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent),n=this.props.mxEvent.replacingEvent()?e.getPushActionsForEvent(this.props.mxEvent):void 0;return!!(null!=t&&t.tweaks||null!=n&&n.tweaks)&&(this.props.mxEvent.getSender()!==e.credentials.userId&&!!(null!=t&&t.tweaks.highlight||null!=n&&n.tweaks.highlight))}renderE2EPadlock(){var e;const t=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if((0,Pr.F)(t.getRoomId()))return null;if(t.isDecryptionFailure())switch(t.decryptionFailureReason){case V.RT.SENDER_IDENTITY_PREVIOUSLY_VERIFIED:case V.RT.UNSIGNED_SENDER_DEVICE:return null;default:return o.createElement(Yr,null)}if(this.state.shieldColour!==V.so.NONE){let e;switch(this.state.shieldReason){case V.uV.UNVERIFIED_IDENTITY:e=(0,c._t)("encryption|event_shield_reason_unverified_identity");break;case V.uV.UNSIGNED_DEVICE:e=(0,c._t)("encryption|event_shield_reason_unsigned_device");break;case V.uV.UNKNOWN_DEVICE:e=(0,c._t)("encryption|event_shield_reason_unknown_device");break;case V.uV.AUTHENTICITY_NOT_GUARANTEED:e=(0,c._t)("encryption|event_shield_reason_authenticity_not_guaranteed");break;case V.uV.MISMATCHED_SENDER_KEY:e=(0,c._t)("encryption|event_shield_reason_mismatched_sender_key");break;case V.uV.SENT_IN_CLEAR:e=(0,c._t)("common|unencrypted");break;case V.uV.VERIFICATION_VIOLATION:e=(0,c._t)("timeline|decryption_failure|sender_identity_previously_verified");break;case V.uV.MISMATCHED_SENDER:e=(0,c._t)("encryption|event_shield_reason_mismatched_sender");break;default:e=(0,c._t)("error|unknown")}return this.state.shieldColour===V.so.GREY?o.createElement(Qr,{icon:Xr.Normal,title:e}):o.createElement(Qr,{icon:Xr.Warning,title:e})}if(this.context.isRoomEncrypted){if(t.status===i.EventStatus.ENCRYPTING)return null;if(t.status===i.EventStatus.NOT_SENT)return null;if(t.isState())return null;if(t.isRedacted())return null;if(!t.isEncrypted())return o.createElement(Jr,null)}return null}showContextMenu(e,t){var n;const i=e.target,r=i instanceof HTMLAnchorElement?i:i.closest("a");i instanceof HTMLImageElement||(null!==(n=l.A.get())&&void 0!==n&&n.allowOverridingNativeContextMenus()||!r)&&(this.props.editState||(e.preventDefault(),e.stopPropagation(),this.setState({contextMenu:{position:{left:e.clientX,top:e.clientY,bottom:e.clientY},link:(null==r?void 0:r.href)||t},actionBarFocused:!0})))}shouldHideEvent(){var e;return(null===(e=this.props.callEventGrouper)||void 0===e?void 0:e.hangupReason)===nn.Il.Replaced}renderContextMenu(){if(!this.state.contextMenu)return null;const e=this.getTile(),t=this.getReplyChain(),n=null!=e&&e.getEventTileOps?e.getEventTileOps():void 0,i=null!=t&&t.canCollapse()?t.collapse:void 0;return o.createElement(Pn.A,(0,tn.A)({},(0,Nn.ps)(this.state.contextMenu.position),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,eventTileOps:n,collapseReplyChain:i,onFinished:this.onCloseMenu,rightClick:!0,reactions:this.state.reactions,link:this.state.contextMenu.link,getRelationsForEvent:this.props.getRelationsForEvent}))}render(){var e,t,n;const r=this.props.mxEvent.getContent().msgtype,a=this.props.mxEvent.getType(),{hasRenderer:l,isBubbleMessage:d,isInfoMessage:u,isLeftAlignedBubbleMessage:m,noBubbleEvent:h,isSeeingThroughMessageHiddenForModeration:p}=_n(f.J.safeGet(),this.props.mxEvent,this.context.showHiddenEvents,this.shouldHideEvent()),{isQuoteExpanded:g}=this.state;if(!l){const{mxEvent:e}=this.props;return s.vF.warn(`Event type not supported: type:${a} isState:${e.isState()}`),o.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},o.createElement("div",{className:"mx_EventTile_line"},(0,c._t)("timeline|error_no_renderer")))}const v=pi.j.isEligible(this.props.mxEvent),_=me()("mx_EventTile_line",{mx_EventTile_mediaLine:v,mx_EventTile_image:this.props.mxEvent.getType()===i.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===i.MsgType.Image,mx_EventTile_sticker:this.props.mxEvent.getType()===i.EventType.Sticker,mx_EventTile_emote:this.props.mxEvent.getType()===i.EventType.RoomMessage&&this.props.mxEvent.getContent().msgtype===i.MsgType.Emote}),y=["sending","queued","encrypting"].includes(this.props.eventSendStatus),b=(0,vn.S8)(this.props.mxEvent)&&this.props.isRedacted,E=this.props.mxEvent.isDecryptionFailure();let w=this.props.continuation;this.context.timelineRenderingType!==kn.Ae.Room&&this.context.timelineRenderingType!==kn.Ae.Search&&this.context.timelineRenderingType!==kn.Ae.Thread&&this.props.layout!==Zt.P.Bubble&&(w=!1);const S=this.context.timelineRenderingType===kn.Ae.Notification,A=!!this.props.editState,C=me()({mx_EventTile_bubbleContainer:d,mx_EventTile_leftAlignedBubble:m,mx_EventTile:!0,mx_EventTile_isEditing:A,mx_EventTile_info:u,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!A&&y,mx_EventTile_highlight:this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent||this.state.contextMenu,mx_EventTile_continuation:w||a===i.EventType.CallInvite||fn.Fm.matches(a),mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_bad:E,mx_EventTile_emote:r===i.MsgType.Emote,mx_EventTile_noSender:this.props.hideSender,mx_EventTile_clamp:this.context.timelineRenderingType===kn.Ae.ThreadsList||S,mx_EventTile_noBubble:h}),k=null!==this.props.eventSendStatus?"off":void 0;let R="#";this.props.permalinkCreator&&(R=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const I=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let T,P,N=null,D=null;if(S?(T="24px",P=!0):u?(T="14px",P=!1):this.context.timelineRenderingType===kn.Ae.ThreadsList||this.context.timelineRenderingType===kn.Ae.Thread&&!this.props.continuation?(T="32px",P=!0):a===i.EventType.RoomCreate||d?(T=null,P=!1):this.props.layout==Zt.P.IRC?(T="14px",P=!0):this.props.continuation&&this.context.timelineRenderingType!==kn.Ae.File||a===i.EventType.CallInvite||fn.Fm.matches(a)?(T=null,P=!1):this.context.timelineRenderingType===kn.Ae.File?(T="20px",P=!0):(T="30px",P=!0),this.props.mxEvent.sender&&null!==T){let e=null;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender;const t=!this.props.inhibitInteraction&&![kn.Ae.ThreadsList,kn.Ae.Notification].includes(this.context.timelineRenderingType);N=o.createElement("div",{className:"mx_EventTile_avatar"},o.createElement(bn.A,{member:e,size:T,viewUserOnClick:t,forceHistorical:this.props.mxEvent.getType()===i.EventType.RoomMember}))}P&&!0!==this.props.hideSender&&(D=this.context.timelineRenderingType===kn.Ae.Room||this.context.timelineRenderingType===kn.Ae.Search||this.context.timelineRenderingType===kn.Ae.Pinned||this.context.timelineRenderingType===kn.Ae.Thread?o.createElement(dn,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent}):this.context.timelineRenderingType===kn.Ae.ThreadsList?o.createElement(dn,{mxEvent:this.props.mxEvent,withTooltip:!0}):o.createElement(dn,{mxEvent:this.props.mxEvent}));const M=!A&&!this.props.forExport?o.createElement(Fi,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyChain:this.getReplyChain,onFocusChange:this.onActionBarFocusChange,isQuoteExpanded:g,toggleThreadExpanded:()=>this.setQuoteExpanded(!g),getRelationsForEvent:this.props.getRelationsForEvent}):void 0,O=this.props.mxEvent.getTs()&&!this.props.hideTimestamp&&(this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused||Boolean(this.state.contextMenu));let F=this.context.timelineRenderingType!==kn.Ae.ThreadsList?this.props.mxEvent.getTs():null===(e=this.state.thread)||void 0===e||null===(e=e.replyToEvent)||void 0===e?void 0:e.getTs();"number"!=typeof F&&(F=this.props.mxEvent.getTs());const L=o.createElement(Fn.A,{showRelative:this.context.timelineRenderingType===kn.Ae.ThreadsList,showTwelveHour:this.props.isTwelveHour,ts:F,receivedTs:null===(t=Vr(this.props.mxEvent))||void 0===t?void 0:t.received_ts}),U=O&&F?L:null;let B,V;wi.A.isPinned(f.J.safeGet(),this.props.mxEvent)&&(B=o.createElement(Hr,null)),b||(V=o.createElement(Ki,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,key:"mx_EventTile_reactionsRow"}));const j=Boolean(V&&this.state.reactions||B),z=this.props.hideTimestamp?null:o.createElement("a",{href:R,onClick:this.onPermalinkClicked,"aria-label":(0,gt.fU)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour),onContextMenu:this.onTimestampContextMenu},U),H=this.props.layout===Zt.P.IRC,G=H?null:z,K=H?z:null,q=this.props.layout===Zt.P.Bubble?L:void 0,$=!H&&!d&&this.renderE2EPadlock(),J=H&&!d&&this.renderE2EPadlock();let Y,X;if(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)Y=o.createElement(Zr,{messageState:this.props.mxEvent.getAssociatedStatus()});else if(this.props.showReadReceipts){var Q,Z;Y=o.createElement(Rr,{readReceipts:null!==(Q=this.props.readReceipts)&&void 0!==Q?Q:[],readReceiptMap:null!==(Z=this.props.readReceiptMap)&&void 0!==Z?Z:{},checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,isTwelveHour:this.props.isTwelveHour})}(0,vn.bN)(this.props.mxEvent,f.J.safeGet(),this.context.showHiddenEvents)&&(0,Cn.c$)(this.props.mxEvent)&&(X=o.createElement(Rn,{parentEv:this.props.mxEvent,ref:this.replyChain,forExport:this.props.forExport,permalinkCreator:this.props.permalinkCreator,layout:this.props.layout,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.hover,isQuoteExpanded:g,setQuoteExpanded:this.setQuoteExpanded,getRelationsForEvent:this.props.getRelationsForEvent}));const ee=(null===(n=this.props.mxEvent)||void 0===n?void 0:n.getSender())===f.J.safeGet().getUserId();switch(this.context.timelineRenderingType){case kn.Ae.Thread:return o.createElement(this.props.as||"li",{ref:this.ref,className:C,"aria-live":k,"aria-atomic":!0,"data-scroll-tokens":I,"data-has-reply":!!X,"data-layout":this.props.layout,"data-self":ee,"data-event-id":this.props.mxEvent.getId(),onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[o.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},N,D),o.createElement("div",{className:_,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),X,(0,vn.rd)(kn.Ae.Thread,Gr(Gr({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:p,highlights:this.props.highlights,highlightLink:this.props.highlightLink,permalinkCreator:this.props.permalinkCreator,showHiddenEvents:this.context.showHiddenEvents})),M,o.createElement("a",{href:R,onClick:this.onPermalinkClicked},U),Y),j&&o.createElement("div",{className:"mx_EventTile_footer",key:"mx_EventTile_footer"},(this.props.layout===Zt.P.Group||!ee)&&B,V,this.props.layout===Zt.P.Bubble&&ee&&B)]);case kn.Ae.Notification:case kn.Ae.ThreadsList:{const e=f.J.safeGet().getRoom(this.props.mxEvent.getRoomId());return o.createElement(this.props.as||"li",{ref:this.ref,className:C,tabIndex:-1,"aria-live":k,"aria-atomic":"true","data-scroll-tokens":I,"data-layout":this.props.layout,"data-shape":this.context.timelineRenderingType,"data-self":ee,"data-has-reply":!!X,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1}),onClick:e=>{const t=e.currentTarget;let n=-1;switch(t.parentElement&&(n=Array.from(t.parentElement.children).indexOf(t)),this.context.timelineRenderingType){case kn.Ae.Notification:this.viewInRoom(e);break;case kn.Ae.ThreadsList:x.A.dispatch({action:W.r.ShowThread,rootEvent:this.props.mxEvent,push:!0}),Si.A.trackInteraction("WebThreadsPanelThreadItem",e,null!=n?n:-1)}}},o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_EventTile_details"},D,S&&e?o.createElement("span",{className:"mx_EventTile_truncated"}," ",(0,c._t)("timeline|in_room_name",{room:e.name},{strong:e=>o.createElement("strong",null,e)})):"",U,o.createElement(Dr,{room:e||void 0,threadId:this.props.mxEvent.getId(),forceDot:!0})),S&&e?o.createElement("div",{className:"mx_EventTile_avatar"},o.createElement(Tn.A,{room:e,size:"28px"})):N,o.createElement("div",{className:_,key:"mx_EventTile_line"},o.createElement("div",{className:"mx_EventTile_body"},this.props.mxEvent.isRedacted()?o.createElement(nr.A,{mxEvent:this.props.mxEvent}):this.props.mxEvent.isDecryptionFailure()?o.createElement(In.A,{mxEvent:this.props.mxEvent}):o.createElement(gr,{mxEvent:this.props.mxEvent})),this.renderThreadPanelSummary()),this.context.timelineRenderingType===kn.Ae.ThreadsList&&o.createElement(Br,{viewInRoom:this.viewInRoom,copyLinkToThread:this.copyLinkToThread}),Y))}case kn.Ae.File:return o.createElement(this.props.as||"li",{className:C,"aria-live":k,"aria-atomic":!0,"data-scroll-tokens":I},[o.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:R,onClick:this.onPermalinkClicked},o.createElement("div",{className:"mx_EventTile_senderDetails",onContextMenu:this.onTimestampContextMenu},N,D,U)),o.createElement("div",{className:_,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),(0,vn.rd)(kn.Ae.File,Gr(Gr({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:p,highlights:this.props.highlights,highlightLink:this.props.highlightLink,permalinkCreator:this.props.permalinkCreator,showHiddenEvents:this.context.showHiddenEvents})))]);default:return o.createElement(this.props.as||"li",{ref:this.ref,className:C,tabIndex:-1,"aria-live":k,"aria-atomic":"true","data-scroll-tokens":I,"data-layout":this.props.layout,"data-self":ee,"data-event-id":this.props.mxEvent.getId(),"data-has-reply":!!X,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},o.createElement(o.Fragment,null,K,D,J,N,o.createElement("div",{className:_,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),G,$,X,(0,vn.rd)(this.context.timelineRenderingType,Gr(Gr({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:p,timestamp:q,highlights:this.props.highlights,highlightLink:this.props.highlightLink,permalinkCreator:this.props.permalinkCreator,showHiddenEvents:this.context.showHiddenEvents})),M,this.props.layout===Zt.P.IRC&&o.createElement(o.Fragment,null,j&&o.createElement("div",{className:"mx_EventTile_footer"},B,V),this.renderThreadInfo())),this.props.layout!==Zt.P.IRC&&o.createElement(o.Fragment,null,j&&o.createElement("div",{className:"mx_EventTile_footer"},(this.props.layout===Zt.P.Group||!ee)&&B,V,this.props.layout===Zt.P.Bubble&&ee&&B),this.renderThreadInfo()),Y))}}}(0,S.A)(qr,"defaultProps",{forExport:!1,layout:Zt.P.Group}),(0,S.A)(qr,"contextType",kn.Ay);const $r=e=>{var t;return o.createElement(rr,{mxEvent:e.mxEvent,layout:null!==(t=e.layout)&&void 0!==t?t:Zt.P.Group},o.createElement(qr,e))};function Jr(e){return o.createElement(Qr,(0,tn.A)({title:(0,c._t)("common|unencrypted"),icon:Xr.Warning},e))}function Yr(e){return o.createElement(Qr,(0,tn.A)({title:(0,c._t)("timeline|undecryptable_tooltip"),icon:Xr.DecryptionFailure},e))}var Xr=function(e){return e.Normal="normal",e.Warning="warning",e.DecryptionFailure="decryption_failure",e}(Xr||{});class Qr extends o.Component{constructor(e){super(e),this.state={hover:!1}}render(){const e=`mx_EventTile_e2eIcon mx_EventTile_e2eIcon_${this.props.icon}`;return o.createElement(rn.m,{label:this.props.title,isTriggerInteractive:!0},o.createElement("div",{className:e,tabIndex:0,"aria-label":(0,c._t)("timeline|e2e_state")}))}}function Zr({messageState:e}){const t=!e||"sent"===e,n="not_sent"===e,i=me()({mx_EventTile_receiptSent:t,mx_EventTile_receiptSending:!t&&!n});let r;n&&(r=o.createElement(On.A,{notification:Mn.d.RED_EXCLAMATION}));let s=(0,c._t)("timeline|send_state_sending");return"encrypting"===e?s=(0,c._t)("timeline|send_state_encrypting"):t?s=(0,c._t)("timeline|send_state_sent"):n&&(s=(0,c._t)("timeline|send_state_failed")),o.createElement("div",{className:"mx_EventTile_msgOption"},o.createElement("div",{className:"mx_ReadReceiptGroup"},o.createElement(rn.m,{label:s,placement:"top-end"},o.createElement("div",{className:"mx_ReadReceiptGroup_button",role:"status"},o.createElement("span",{className:"mx_ReadReceiptGroup_container"},o.createElement("span",{className:i},r))))))}var eo=n("./src/components/structures/SearchBox.tsx"),to=n("./src/components/views/avatars/DecoratedRoomAvatar.tsx"),no=n("./src/stores/room-list/algorithms/tag-sorting/RecentAlgorithm.ts"),io=n("./src/autocomplete/QueryMatcher.ts"),ro=n("./src/components/views/elements/TruncatedList.tsx"),oo=n("./src/utils/location/index.ts");const so=["room","component"];function ao(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function lo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ao(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ao(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function co(e){let{room:t,component:n}=e,i=(0,v.A)(e,so);const r=function(e){const t=k.A.shared().getUserIdForRoomId(e.roomId),n=e.getMembers().length>2;if(!e.isSpaceRoom()&&t&&!n)return{details:t};const[i,r,...o]=Ci.Ay.instance.getKnownParents(e.roomId);if(r&&(null==o||!o.length)){var s,a;const t=null===(s=e.client.getRoom(i))||void 0===s?void 0:s.name,n=null===(a=e.client.getRoom(r))||void 0===a?void 0:a.name;return{details:(0,sn.ki)([null!=t?t:"",null!=n?n:""]),ariaLabel:(0,c._t)("in_space1_and_space2",{space1Name:t,space2Name:n})}}if(i){var l,d;const t=null!==(l=null===(d=e.client.getRoom(i))||void 0===d?void 0:d.name)&&void 0!==l?l:"",n=o.length;return n>0?{details:(0,sn.ki)([t,...o],1),ariaLabel:(0,c._t)("in_space_and_n_other_spaces",{spaceName:t,count:n})}:{details:t,ariaLabel:(0,c._t)("in_space",{spaceName:t})}}return{details:e.getCanonicalAlias()}}(t);return r?o.createElement(null!=n?n:"div",lo(lo({},i),{},{"aria-label":r.ariaLabel}),[r.details]):o.createElement(o.Fragment,null)}var uo=n("./src/KeyBindingsManager.ts");const mo=({remaining:e,onClick:t})=>o.createElement(ae.A,{onClick:t,className:"mx_OverflowTileView"},o.createElement("div",{className:"mx_OverflowTileView_icon"},o.createElement(Un,{height:"36px",width:"36px"})),o.createElement("div",{className:"mx_OverflowTileView_text"},(0,c._t)("common|and_n_others",{count:e}))),ho=["m.relates_to"];function po(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function go(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?po(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):po(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var vo=function(e){return e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed",e}(vo||{});const fo=({room:e,type:t,content:n,matrixClient:i,onFinished:r})=>{const[s,a]=(0,o.useState)(vo.CanSend),[l,d,u]=(0,mi.A9)();let m,h,p,g=!1;s===vo.CanSend?(m="mx_ForwardList_canSend",e.maySendMessage()||(g=!0,h=(0,c._t)("forward|no_perms_title"))):s===vo.Sending?(m="mx_ForwardList_sending",g=!0,h=(0,c._t)("forward|sending"),p=o.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):s===vo.Sent?(m="mx_ForwardList_sent",g=!0,h=(0,c._t)("forward|sent"),p=o.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):(m="mx_ForwardList_sendFailed",g=!0,h=(0,c._t)("timeline|send_state_failed"),p=o.createElement(On.A,{notification:Mn.d.RED_EXCLAMATION}));const v=`mx_ForwardDialog_entry_${e.roomId}`;return o.createElement("div",{className:me()("mx_ForwardList_entry",{mx_ForwardList_entry_active:d}),"aria-labelledby":`${v}_name`,"aria-describedby":`${v}_send`,role:"listitem",ref:u,onFocus:l,id:v},o.createElement(ae.A,{className:"mx_ForwardList_roomButton",onClick:t=>{x.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:"WebForwardShortcut",metricsViaKeyboard:"click"!==t.type}),r(!0)},title:(0,c._t)("forward|open_room"),placement:"top",tabIndex:d?0:-1},o.createElement(to.A,{room:e,size:"32px",tooltipProps:{tabIndex:d?0:-1}}),o.createElement("span",{className:"mx_ForwardList_entry_name",id:`${v}_name`},e.name),o.createElement(co,{component:"span",className:"mx_ForwardList_entry_detail",room:e})),o.createElement(ae.A,{kind:s===vo.Failed?"danger_outline":"primary_outline",className:`mx_ForwardList_sendButton ${m}`,onClick:async()=>{a(vo.Sending);try{await i.sendEvent(e.roomId,t,n),a(vo.Sent)}catch{a(vo.Failed)}},disabled:g,title:h,placement:"top",tabIndex:d?0:-1,id:`${v}_send`},o.createElement("div",{className:"mx_ForwardList_sendLabel"},(0,c._t)("forward|send_label")),p))},_o=({matrixClient:e,event:t,permalinkCreator:n,onFinished:r})=>{const s=e.getSafeUserId(),[a,l]=(0,o.useState)({});(0,o.useEffect)(()=>{e.getProfileInfo(s).then(e=>l(e))},[e,s]);const{type:d,content:u}=(e=>{const t=e.getContent(),{"m.relates_to":n}=t,r=(0,v.A)(t,ho),o=i.M_BEACON.matches(e.getType())?i.EventType.RoomMessage:e.getType();if((0,gn.wq)(e)&&(0,oo.qy)(r)||i.M_BEACON.matches(e.getType())){const t=i.M_TIMESTAMP.findIn(r),n=(0,oo.jm)(e);return{type:o,content:go(go({},r),i.ContentHelpers.makeLocationContent(void 0,n,t||Date.now(),void 0,i.LocationAssetType.Pin))}}return{type:o,content:r}})(t),m=new i.MatrixEvent({type:"m.room.message",sender:s,content:u,unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:t.getRoomId(),origin_server_ts:t.getTs()});m.sender={name:a.displayname||s,rawDisplayName:a.displayname,userId:s,getAvatarUrl:(...e)=>(0,en.r4)({avatarUrl:a.avatar_url},30,30,"crop"),getMxcAvatarUrl:()=>a.avatar_url};const[h,p]=(0,o.useState)(""),g=h.toLowerCase(),f=(0,Qt.ti)("layout"),_=(0,Qt.ti)("feature_dynamic_room_predecessors");let y=(0,o.useMemo)(()=>(0,no.pP)(e.getVisibleRooms(_).filter(e=>e.getMyMembership()===Xt.O.Join&&!e.isSpaceRoom())),[e,_]);g&&(y=new io.A(y,{keys:["name"],funcs:[e=>(0,ie.Bo)([e.getCanonicalAlias(),...e.getAltAliases()])],shouldMatchWordsOnly:!1}).match(g));const[b,E]=(0,o.useState)(20);function w(e,t){return o.createElement(mo,{remaining:e,onClick:()=>E(t)})}return o.createElement(X.A,{title:(0,c._t)("common|forward_message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:r,fixedWidth:!1},o.createElement("h3",null,(0,c._t)("forward|message_preview_heading")),o.createElement("div",{className:me()("mx_ForwardDialog_preview",{mx_IRCLayout:f==Zt.P.IRC})},o.createElement($r,{mxEvent:m,layout:f,permalinkCreator:n,as:"div",inhibitInteraction:!0})),o.createElement("hr",null),o.createElement(mi.Se,{handleUpDown:!0,handleInputFields:!0,onKeyDown:(e,t)=>{let n=!0;var i;(0,uo.zM)().getAccessibilityAction(e)===Ei.bY.Enter?null===(i=t.activeNode)||void 0===i||null===(i=i.querySelector(".mx_ForwardList_sendButton"))||void 0===i||i.click():n=!1;n&&(e.preventDefault(),e.stopPropagation())},scrollIntoView:{block:"center"}},({onKeyDownHandler:t})=>o.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},o.createElement(mi.ui.Consumer,null,e=>{var n;return o.createElement(eo.A,{className:"mx_textinput_icon mx_textinput_search",placeholder:(0,c._t)("forward|filter_placeholder"),onSearch:t=>{p(t),setTimeout(()=>{const t=e.state.nodes[0];var n;t&&(e.dispatch({type:mi.ZU.SetFocus,payload:{node:t}}),null==t||null===(n=t.scrollIntoView)||void 0===n||n.call(t,{block:"nearest"}))})},autoFocus:!0,onKeyDown:t,"aria-activedescendant":null===(n=e.state.activeNode)||void 0===n?void 0:n.id,"aria-owns":"mx_ForwardDialog_resultsList"})}),o.createElement(Cr.A,{className:"mx_ForwardList_content"},y.length>0?o.createElement("div",{className:"mx_ForwardList_results"},o.createElement(ro.A,{id:"mx_ForwardDialog_resultsList",className:"mx_ForwardList_resultsList",truncateAt:b,createOverflowElement:w,getChildren:(t,n)=>y.slice(t,n).map(t=>o.createElement(fo,{key:t.roomId,room:t,type:d,content:u,matrixClient:e,onFinished:r})),getChildCount:()=>y.length})):o.createElement("span",{className:"mx_ForwardList_noResults"},(0,c._t)("common|no_results"))))))};var yo=n("./src/createRoom.ts"),bo=n("./src/Markdown.ts"),Eo=n("./src/components/views/elements/StyledRadioButton.tsx"),wo=n("./src/components/views/elements/Field.tsx"),So=n("./src/components/views/elements/LabelledCheckbox.tsx");const xo=["org.matrix.msc3215.room.moderation.moderated_by"];var Ao=function(e){return e.Disagreement="org.matrix.msc3215.abuse.nature.disagreement",e.Toxic="org.matrix.msc3215.abuse.nature.toxic",e.Illegal="org.matrix.msc3215.abuse.nature.illegal",e.Spam="org.matrix.msc3215.abuse.nature.spam",e.Other="org.matrix.msc3215.abuse.nature.other",e}(Ao||{}),Co=function(e){return e.Admin="non-standard.abuse.nature.admin",e}(Co||{});class ko extends o.Component{constructor(e){super(e),(0,S.A)(this,"moderation",void 0),(0,S.A)(this,"componentDidMount",async()=>{const e=f.J.safeGet().getCrypto(),t=this.props.mxEvent.getRoomId();e&&t&&this.setState({isRoomEncrypted:await e.isEncryptionEnabledInRoom(t)})}),(0,S.A)(this,"onIgnoreUserTooChanged",e=>{this.setState({ignoreUserToo:e})}),(0,S.A)(this,"onReasonChange",({target:{value:e}})=>{this.setState({reason:e})}),(0,S.A)(this,"onNatureChosen",e=>{this.setState({nature:e.currentTarget.value})}),(0,S.A)(this,"onCancel",()=>{this.props.onFinished(!1)}),(0,S.A)(this,"onSubmit",async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==Ao.Other||this.state.nature==Co.Admin)&&!e)return void this.setState({err:(0,c._t)("report_content|missing_reason")})}else if(!e)return void this.setState({err:(0,c._t)("report_content|missing_reason")});this.setState({busy:!0,err:void 0});try{const e=f.J.safeGet(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!==Co.Admin){const n=this.state.nature,i=await(0,yo.EP)(e,this.moderation.moderationBotUserId);if(!i)throw new c.P7("report_content|error_create_room_moderation_bot");await e.sendEvent(i,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:n,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.state.ignoreUserToo&&await e.setIgnoredUsers([...e.getIgnoredUsers(),t.getSender()]),this.props.onFinished(!0)}catch(e){s.vF.error(e),this.setState({busy:!1,err:e instanceof Error?e.message:String(e)})}});let t=null,n=null;if(O.A.getValue("feature_report_to_moderators")){const i=f.J.safeGet().getRoom(e.mxEvent.getRoomId());for(const e of xo){const r=null==i?void 0:i.currentState.getStateEvents(e,e);if(!r)continue;if(Array.isArray(r))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const o=r.event;if(!("content"in o)||"object"!=typeof o.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",o);continue}const s=o.content;"room_id"in s&&"string"==typeof s.room_id?"user_id"in s&&"string"==typeof s.user_id?(t=s.room_id,n=s.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",o):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",o)}t&&n&&(this.moderation={moderationRoomId:t,moderationBotUserId:n})}this.state={reason:"",busy:!1,err:void 0,nature:void 0,ignoreUserToo:!1,isRoomEncrypted:!1}}render(){var e;let t,n;this.state.err&&(t=o.createElement("div",{className:"error"},this.state.err)),this.state.busy&&(n=o.createElement("div",{className:"progress"},o.createElement(le.A,null)));const i=o.createElement(So.A,{value:this.state.ignoreUserToo,label:(0,c._t)("report_content|ignore_user"),byline:(0,c._t)("report_content|hide_messages_from_user"),onChange:this.onIgnoreUserTooChanged,disabled:this.state.busy}),r=null===(e=d.Ay.getObject("report_event"))||void 0===e?void 0:e.get("admin_message_md","adminMessageMD");let s;if(r){const e=new bo.A(r).toHTML({externalLinks:!0});s=o.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const e=d.Ay.get("validated_server_config").hsName;let r;switch(this.state.nature){case Ao.Disagreement:r=(0,c._t)("report_content|nature_disagreement");break;case Ao.Toxic:r=(0,c._t)("report_content|nature_toxic");break;case Ao.Illegal:r=(0,c._t)("report_content|nature_illegal");break;case Ao.Spam:r=(0,c._t)("report_content|nature_spam");break;case Co.Admin:r=this.state.isRoomEncrypted?(0,c._t)("report_content|nature_nonstandard_admin_encrypted",{homeserver:e}):(0,c._t)("report_content|nature_nonstandard_admin",{homeserver:e});break;case Ao.Other:r=(0,c._t)("report_content|nature_other");break;default:r=(0,c._t)("report_content|nature")}return o.createElement(X.A,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,c._t)("action|report_content"),contentId:"mx_ReportEventDialog"},o.createElement("div",null,o.createElement(Eo.A,{name:"nature",value:Ao.Disagreement,checked:this.state.nature==Ao.Disagreement,onChange:this.onNatureChosen},(0,c._t)("report_content|disagree")),o.createElement(Eo.A,{name:"nature",value:Ao.Toxic,checked:this.state.nature==Ao.Toxic,onChange:this.onNatureChosen},(0,c._t)("report_content|toxic_behaviour")),o.createElement(Eo.A,{name:"nature",value:Ao.Illegal,checked:this.state.nature==Ao.Illegal,onChange:this.onNatureChosen},(0,c._t)("report_content|illegal_content")),o.createElement(Eo.A,{name:"nature",value:Ao.Spam,checked:this.state.nature==Ao.Spam,onChange:this.onNatureChosen},(0,c._t)("report_content|spam_or_propaganda")),o.createElement(Eo.A,{name:"nature",value:Co.Admin,checked:this.state.nature==Co.Admin,onChange:this.onNatureChosen},(0,c._t)("report_content|report_entire_room")),o.createElement(Eo.A,{name:"nature",value:Ao.Other,checked:this.state.nature==Ao.Other,onChange:this.onNatureChosen},(0,c._t)("report_content|other_label")),o.createElement("p",null,r),o.createElement(wo.A,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,c._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),n,t,i),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return o.createElement(X.A,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:(0,c._t)("report_content|report_content_to_homeserver"),contentId:"mx_ReportEventDialog"},o.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},o.createElement("p",null,(0,c._t)("report_content|description")),s,o.createElement(wo.A,{className:"mx_ReportEventDialog_reason",element:"textarea",label:(0,c._t)("room_settings|permissions|ban_reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),n,t,i),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|send_report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}var Ro=n("./src/components/structures/TabbedView.tsx"),Io=n("./src/components/views/elements/StyledCheckbox.tsx");const To=({room:e,children:t})=>{const[n,r]=(0,o.useState)(null==e?void 0:e.name);return(0,lr.YK)(e,i.RoomEvent.Name,()=>{r(null==e?void 0:e.name)}),(0,o.useEffect)(()=>{r(null==e?void 0:e.name)},[e]),t?t(null!=n?n:""):o.createElement(o.Fragment,null,n||"")};let Po=function(e){return e.Appearance="SPACE_PREFERENCE_APPEARANCE_TAB",e}({});var No=n("./src/components/views/settings/tabs/SettingsTab.tsx"),Do=n("./src/components/views/settings/shared/SettingsSection.tsx"),Mo=n("./src/components/views/settings/shared/SettingsSubsection.tsx");const Oo=({space:e})=>{const t=(0,Qt.ti)("Spaces.showPeopleInSpace",e.roomId);return o.createElement(No.A,null,o.createElement(Do.X,{heading:(0,c._t)("space|preferences|sections_section")},o.createElement(Mo.P,null,o.createElement(Io.A,{checked:!!t,onChange:n=>{O.A.setValue("Spaces.showPeopleInSpace",e.roomId,F.p.ROOM_ACCOUNT,!t)},description:(0,c._t)("space|preferences|show_people_in_space",{spaceName:e.name})},(0,c._t)("common|people")),o.createElement(Mo.s,null))))},Fo=({space:e,onFinished:t})=>{const n=[new Ro.oz(Po.Appearance,(0,c.AO)("common|appearance"),"mx_SpacePreferencesDialog_appearanceIcon",o.createElement(Oo,{space:e}))];return o.createElement(X.A,{className:"mx_SpacePreferencesDialog",hasCancel:!0,onFinished:t,title:(0,c._t)("common|preferences"),fixedWidth:!1},o.createElement("h4",null,o.createElement(To,{room:e})),o.createElement("div",{className:"mx_SettingsDialog_content"},o.createElement(Ro.Ay,{tabs:n,activeTabId:Po.Appearance,onChange:()=>{}})))};var Lo=n("./src/hooks/useDispatcher.ts"),Uo=n("./src/components/views/spaces/SpaceBasicSettings.tsx"),Bo=n("./src/editor/serialize.ts"),Vo=n("./src/utils/leave-behaviour.ts");const jo=e=>{var t;const n=null==e||null===(t=e.currentState)||void 0===t||null===(t=t.getStateEvents(i.EventType.RoomTopic,""))||void 0===t?void 0:t.getContent();return n?i.ContentHelpers.parseTopicContent(n):null};function zo(e){const[t,n]=(0,o.useState)(jo(e));return(0,lr.YK)(null==e?void 0:e.currentState,i.RoomStateEvent.Events,t=>{t.getType()===i.EventType.RoomTopic&&n(jo(e))}),(0,o.useEffect)(()=>{n(jo(e))},[e]),t}const Ho=({matrixClient:e,space:t})=>{var n,r,a;const[l,d]=(0,o.useState)(!1),[u,m]=(0,o.useState)(""),h=e.getUserId(),[p,g]=(0,o.useState)(null),v=t.currentState.maySendStateEvent(i.EventType.RoomAvatar,h),f=null!==p,[_,y]=(0,o.useState)(t.name),b=t.currentState.maySendStateEvent(i.EventType.RoomName,h),E=_!==t.name,w=null!==(n=null===(r=jo(t))||void 0===r?void 0:r.text)&&void 0!==n?n:"",[S,x]=(0,o.useState)(w),A=t.currentState.maySendStateEvent(i.EventType.RoomTopic,h),C=S!==w;return o.createElement(No.A,null,o.createElement(Do.X,{heading:(0,c._t)("common|general")},o.createElement("div",null,o.createElement("div",null,(0,c._t)("room_settings|general|description_space")),u&&o.createElement("div",{className:"mx_SpaceRoomView_errorText"},u),o.createElement(Uo.A,{avatarUrl:null!==(a=(0,en.ze)(t,80,80,"crop"))&&void 0!==a?a:void 0,avatarDisabled:l||!v,setAvatar:g,name:_,nameDisabled:l||!b,setName:y,topic:S,topicDisabled:l||!A,setTopic:x}),o.createElement(ae.A,{onClick:()=>{g(null),y(t.name),x(w)},disabled:l||!(f||E||C),kind:"link"},(0,c._t)("action|cancel")),o.createElement(ae.A,{onClick:async()=>{d(!0);const n=[];if(f&&(p?n.push((async()=>{const{content_uri:n}=await e.uploadContent(p);await e.sendStateEvent(t.roomId,i.EventType.RoomAvatar,{url:n},"")})()):n.push(e.sendStateEvent(t.roomId,i.EventType.RoomAvatar,{},""))),E&&n.push(e.setRoomName(t.roomId,_)),C){const i=(0,Bo.Ro)(S,{forceHTML:!1});n.push(e.setRoomTopic(t.roomId,S,i))}const r=await Promise.allSettled(n);d(!1);const o=r.filter(e=>"rejected"===e.status);o.length>0&&(s.vF.error("Failed to save space settings: ",o),m((0,c._t)("room_settings|general|error_save_space_settings")))},disabled:l,kind:"primary"},l?(0,c._t)("common|saving"):(0,c._t)("room_settings|general|save"))),o.createElement(Mo.P,{heading:(0,c._t)("room_settings|general|leave_space")},o.createElement(ae.A,{kind:"danger",onClick:()=>{(0,Vo.e)(t)}},(0,c._t)("room_settings|general|leave_space")))))};var Wo=n("./src/components/views/room_settings/AliasSettings.tsx"),Go=n("./src/hooks/useStateToggle.ts"),Ko=n("./src/components/views/elements/LabelledToggleSwitch.tsx"),qo=n("./src/hooks/useLocalEcho.ts"),$o=n("./src/components/views/settings/JoinRuleSettings.tsx"),Jo=n("./src/hooks/useRoomState.ts"),Yo=n("./src/components/views/settings/SettingsFieldset.tsx");const Xo=({matrixClient:e,space:t,closeSettingsFn:n})=>{const[r,s]=(0,o.useState)(""),a=(0,mr.e)(async()=>e.isVersionSupported("v1.4").then(t=>t||e.doesServerSupportUnstableFeature("org.matrix.msc3827.stable")),[e],!1),l=e.getUserId(),d=(0,Jo.U)(t,e=>e.getJoinRule()),[u,m]=(0,qo.W)(()=>{var e;return(null===(e=t.currentState.getStateEvents(i.EventType.RoomGuestAccess,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.guest_access)===i.GuestAccess.CanJoin},n=>e.sendStateEvent(t.roomId,i.EventType.RoomGuestAccess,{guest_access:n?i.GuestAccess.CanJoin:i.GuestAccess.Forbidden},""),()=>s((0,c._t)("room_settings|visibility|error_update_guest_access"))),[h,p]=(0,qo.W)(()=>{var e;return(null===(e=t.currentState.getStateEvents(i.EventType.RoomHistoryVisibility,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.history_visibility)||i.HistoryVisibility.Shared},n=>e.sendStateEvent(t.roomId,i.EventType.RoomHistoryVisibility,{history_visibility:n},""),()=>s((0,c._t)("room_settings|visibility|error_update_history_visibility"))),[g,v]=(0,Go.X)(),f=t.currentState.maySendStateEvent(i.EventType.RoomGuestAccess,l),_=t.currentState.maySendStateEvent(i.EventType.RoomHistoryVisibility,l),y=t.currentState.mayClientSendStateEvent(i.EventType.RoomCanonicalAlias,e),b=t.currentState.getStateEvents(i.EventType.RoomCanonicalAlias,"");let E,w;return d===i.JoinRule.Public&&(E=o.createElement("div",null,o.createElement(ae.A,{onClick:v,kind:"link",className:"mx_SettingsTab_showAdvanced","aria-expanded":g},g?(0,c._t)("action|hide_advanced"):(0,c._t)("action|show_advanced")),g&&o.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},o.createElement(Ko.A,{value:u,onChange:m,disabled:!f,label:(0,c._t)("room_settings|visibility|guest_access_label")}),o.createElement("p",null,(0,c._t)("room_settings|visibility|guest_access_explainer"),o.createElement("br",null),(0,c._t)("room_settings|visibility|guest_access_explainer_public_space"))))),t.getJoinRule()===i.JoinRule.Public&&(w=o.createElement(Do.X,{heading:(0,c._t)("room_settings|visibility|alias_section")},o.createElement(Wo.A,{roomId:t.roomId,canSetCanonicalAlias:y,canSetAliases:!0,canonicalAliasEvent:null!=b?b:void 0,hidePublishSetting:!a}))),o.createElement(No.A,null,o.createElement(Do.X,{heading:(0,c._t)("room_settings|visibility|title")},r&&o.createElement("div",{className:"mx_SpaceRoomView_errorText"},r),o.createElement(Yo.A,{legend:(0,c._t)("room_settings|access|title"),description:(0,c._t)("room_settings|access|description_space",{spaceName:t.name})},o.createElement($o.A,{room:t,onError:()=>s((0,c._t)("room_settings|visibility|error_failed_save")),closeSettingsFn:n}),E,o.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},o.createElement(Ko.A,{value:h===i.HistoryVisibility.WorldReadable,onChange:e=>{p(e?i.HistoryVisibility.WorldReadable:i.HistoryVisibility.Shared)},disabled:!_,label:(0,c._t)("room_settings|visibility|history_visibility_anyone_space")}),o.createElement("p",null,(0,c._t)("room_settings|visibility|history_visibility_anyone_space_description"),o.createElement("br",null),o.createElement("strong",null,(0,c._t)("room_settings|visibility|history_visibility_anyone_space_recommendation"))))),w))},Qo=({matrixClient:e,space:t})=>{const[n,i]=(0,o.useState)(""),[r,s]=(0,o.useState)(!1),[a,l]=(0,o.useState)(!1),[d,u]=(0,o.useState)("");(0,o.useEffect)(()=>{m()},[t.roomId]);const m=async()=>{s(!0);try{const n=t.currentState.getStateEvents("org.matrix.msc3381.space.gov_settings","");if(n){var e;const t=n.getContent().settings||{};i((null===(e=t.bTokenRequired)||void 0===e?void 0:e.toString())||"")}}catch(e){console.error("Failed to load GOV settings:",e)}finally{s(!1)}};return r?o.createElement(No.A,null,o.createElement(Do.X,{heading:(0,c._t)("gov_settings|title")},o.createElement("div",null,(0,c._t)("common|loading")))):o.createElement(No.A,null,o.createElement(Do.X,{heading:(0,c._t)("gov_settings|title")},o.createElement(Yo.A,{legend:(0,c._t)("gov_settings|b_token_condition_title"),description:(0,c._t)("gov_settings|b_token_condition_description")},o.createElement(wo.A,{label:(0,c._t)("gov_settings|b_token_required_label"),description:(0,c._t)("gov_settings|b_token_required_description"),type:"number",value:n,onChange:e=>{i(e.target.value),u("")},placeholder:"0",min:"0",step:"0.1"}),d&&o.createElement("div",{className:"mx_SpaceSettingsGOVTab_message "+(d.includes("error")||d.includes("invalid")?"error":"success")},d),o.createElement("div",{className:"mx_SpaceSettingsGOVTab_actions"},o.createElement(ae.A,{kind:"primary",onClick:async()=>{l(!0),u("");try{const i=parseFloat(n);if(isNaN(i)||i<0)return void u((0,c._t)("gov_settings|invalid_b_token_amount"));const r={bTokenRequired:i};await e.sendStateEvent(t.roomId,"org.matrix.msc3381.space.gov_settings",{settings:r},""),u((0,c._t)("gov_settings|settings_saved"))}catch(e){console.error("Failed to save GOV settings:",e),u((0,c._t)("gov_settings|save_error"))}finally{l(!1)}},disabled:a},a?(0,c._t)("common|saving"):(0,c._t)("gov_settings|save_settings"))))))};var Zo=n("./src/components/views/settings/tabs/room/AdvancedRoomSettingsTab.tsx"),es=n("./src/components/views/settings/tabs/room/RolesRoomSettingsTab.tsx");let ts=function(e){return e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Roles="SPACE_ROLES_TAB",e.GOV="SPACE_GOV_TAB",e.Advanced="SPACE_ADVANCED_TAB",e}({});const ns=({matrixClient:e,space:t,onFinished:n})=>{(0,Lo.F)(x.A,e=>{e.action===W.r.AfterLeaveRoom&&e.room_id===t.roomId&&n()});const i=(0,o.useMemo)(()=>{const i="GOV"===t.name;return[new Ro.oz(ts.General,(0,c.AO)("common|general"),"mx_SpaceSettingsDialog_generalIcon",o.createElement(Ho,{matrixClient:e,space:t})),new Ro.oz(ts.Visibility,(0,c.AO)("room_settings|visibility|title"),"mx_SpaceSettingsDialog_visibilityIcon",o.createElement(Xo,{matrixClient:e,space:t,closeSettingsFn:n})),new Ro.oz(ts.Roles,(0,c.AO)("room_settings|permissions|title"),"mx_RoomSettingsDialog_rolesIcon",o.createElement(es.A,{room:t})),i?new Ro.oz(ts.GOV,(0,c.AO)("gov_settings|title"),"mx_SpaceSettingsDialog_generalIcon",o.createElement(Qo,{matrixClient:e,space:t})):null,O.A.getValue(It.f.AdvancedSettings)?new Ro.oz(ts.Advanced,(0,c.AO)("common|advanced"),"mx_RoomSettingsDialog_warningIcon",o.createElement(Zo.A,{room:t,closeSettingsFn:n})):null].filter(Boolean)},[e,t,n]),[r,s]=o.useState(ts.General);return o.createElement(X.A,{title:(0,c._t)("space_settings|title",{spaceName:t.name||(0,c._t)("common|unnamed_space")}),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:n,fixedWidth:!1},o.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog"},o.createElement(Ro.Ay,{tabs:i,activeTabId:r,onChange:s})))};var is,rs=n("./src/components/views/dialogs/InviteDialog.tsx"),os=n("./src/components/views/dialogs/AddExistingToSpaceDialog.tsx"),ss=n("./src/utils/space.tsx"),as=n("./src/contexts/SDKContext.ts");class ls{constructor(){(0,S.A)(this,"isRegistered",!1),(0,S.A)(this,"matrixClient",void 0),(0,S.A)(this,"onDispatch",e=>{if(this.matrixClient)switch(e.action){case"open_room_settings":R.Ay.createDialog(Yt.A,{roomId:e.room_id||as.M.instance.roomViewStore.getRoomId(),initialTabId:e.initial_tab_id},void 0,!1,!0);break;case W.r.OpenForwardDialog:R.Ay.createDialog(_o,{matrixClient:this.matrixClient,event:e.event,permalinkCreator:e.permalinkCreator});break;case W.r.OpenReportEventDialog:R.Ay.createDialog(ko,{mxEvent:e.event},"mx_Dialog_reportEvent");break;case W.r.OpenSpacePreferences:R.Ay.createDialog(Fo,{space:e.space},void 0,!1,!0);break;case W.r.OpenSpaceSettings:R.Ay.createDialog(ns,{matrixClient:e.space.client,space:e.space},void 0,!1,!0);break;case W.r.OpenInviteDialog:R.Ay.createDialog(rs.A,{kind:e.kind,call:e.call,roomId:e.roomId},me()("mx_InviteDialog_flexWrapper",e.className),!1,!0).finished.then(t=>{var n;null===(n=e.onFinishedCallback)||void 0===n||n.call(e,t)});break;case W.r.OpenAddToExistingSpaceDialog:{const t=e.space,{finished:n}=R.Ay.createDialog(os.Ay,{onCreateRoomClick:e=>{(0,ss.PT)(t),Si.A.trackInteraction("WebAddExistingToSpaceDialogCreateRoomButton",e)},onAddSubspaceClick:()=>(0,ss.K1)(t),space:t},"mx_AddExistingToSpaceDialog_wrapper");n.then(([e])=>{e&&as.M.instance.roomViewStore.getRoomId()===t.roomId&&x.A.fire(W.r.UpdateSpaceHierarchy)});break}}})}prepare(e){this.matrixClient=e,this.isRegistered||(x.A.register(this.onDispatch),this.isRegistered=!0)}}is=ls,(0,S.A)(ls,"instance",new is);var cs=n("./src/utils/ErrorUtils.tsx"),ds=n("./node_modules/matrix-js-sdk/src/oidc/authorize.ts"),us=n("./node_modules/matrix-js-sdk/src/oidc/error.ts");let ms=function(e){return e.InvalidQueryParameters="Invalid query parameters for OIDC native login. `code` and `state` are required.",e}({});const hs=async(e,t,n,i,r)=>{var o;const s=l.A.get().getOidcCallbackUrl().href,a=(0,j.US)(10),c=r?"create":void 0,d=await(0,ds.R2)({metadata:e,redirectUri:s,clientId:t,homeserverUrl:n,identityServerUrl:i,nonce:a,prompt:c,urlState:null===(o=l.A.get())||void 0===o?void 0:o.getOidcClientState()});window.location.href=d},ps=async e=>{const{code:t,state:n}=(e=>{const t=e.code,n=e.state;if(!t||"string"!=typeof t||!n||"string"!=typeof n)throw new Error(ms.InvalidQueryParameters);return{code:t,state:n}})(e),{homeserverUrl:i,tokenResponse:r,idTokenClaims:o,identityServerUrl:s,oidcClientSettings:a}=await(0,ds.SU)(t,n);return{homeserverUrl:i,identityServerUrl:s,accessToken:r.access_token,refreshToken:r.refresh_token,idToken:r.id_token,clientId:a.clientId,issuer:a.issuer,idTokenClaims:o}};var gs=n("./src/utils/oidc/persistOidcSettings.ts"),vs=n("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts"),fs=n("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts");const _s="mx_access_token",ys="mx_refresh_token",bs="access_token",Es="refresh_token",ws="mx_has_access_token",Ss="mx_has_refresh_token";async function xs(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);const n=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},n,256))}async function As(e,t,n){if("string"==typeof t)return t;if(!e)throw new Error(`Error decrypting secret ${n}: no pickle key found.`);const i=await xs(e),r=await(0,vs.A)(t,i,n);return i.fill(0),r}async function Cs(e,t,n,i,r){if(n?localStorage.setItem(r,"true"):localStorage.removeItem(r),i){let r;if(n)try{const e=await xs(i);r=await(0,fs.A)(n,e,t),e.fill(0)}catch(e){s.vF.warn(`Could not encrypt token for ${t}`,e)}try{await M.x7("account",e,r||n)}catch{n?localStorage.setItem(e,n):localStorage.removeItem(e)}}else try{await M.x7("account",e,n)}catch{n?localStorage.setItem(e,n):localStorage.removeItem(e)}}async function ks(e,t){return Cs(_s,bs,e,t,ws)}async function Rs(e,t){return Cs(ys,Es,e,t,Ss)}class Is extends i.OidcTokenRefresher{constructor(e,t,n,i,r,o){super(e,t,i,n,r),(0,S.A)(this,"deviceId",void 0),this.userId=o,this.deviceId=i}async persistTokens({accessToken:e,refreshToken:t}){var n,i;const r=null!==(n=await(null===(i=l.A.get())||void 0===i?void 0:i.getPickleKey(this.userId,this.deviceId)))&&void 0!==n?n:void 0;await ks(e,r),await Rs(t,r)}}var Ts=n("./src/SupportedBrowser.ts");const Ps=["roomId"],Ns="mx_hs_url",Ds="mx_is_url";x.A.register(e=>{if(e.action===W.r.TriggerLogout)ia();else if(e.action===W.r.OverwriteLogin){const t=e;oa(!1),Js(t.credentials,!0,!0).catch(e=>{s.vF.warn("Failed to overwrite login",e)})}});let Ms=!1;function Os(){if(Ms)throw new Fs("session lock has been released")}class Fs extends Error{}async function Ls(e={}){try{let t=e.enableGuest||!1;const n=e.guestHsUrl,r=e.guestIsUrl,o=e.fragmentQueryParams||{},a=e.defaultDeviceDisplayName;if(t&&!n&&(s.vF.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&n&&o.guest_user_id&&o.guest_access_token)return s.vF.log("Using guest access credentials"),await Js({userId:o.guest_user_id,accessToken:o.guest_access_token,homeserverUrl:n,identityServerUrl:r,guest:!0},!0,!1),!0;return!!await Ks({ignoreGuest:Boolean(e.ignoreGuest)})||!Ms&&(!(!t||!n)&&function(e,t,n){s.vF.log(`Doing guest login on ${e}`);const r=(0,i.createClient)({baseUrl:e});return r.registerGuest({body:{initial_device_display_name:n}}).then(n=>(s.vF.log(`Registered as guest: ${n.user_id}`),Js({userId:n.user_id,deviceId:n.device_id,accessToken:n.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0,!0).then(()=>!0)),e=>(s.vF.error("Failed to register as guest",e),!1))}(n,r,a))}catch(n){var t;return(null===(t=e.abortSignal)||void 0===t||!t.aborted)&&(!(n instanceof Ys)&&(!Ms&&async function(e,t){s.vF.error("Unable to load session",e);const n=R.Ay.createDialog(qt,{error:e}),[i]=await n.finished;if(i)return await ra(),!1;return Ls(t)}(n,e)))}}async function Us(){const{hsUrl:e,userId:t,hasAccessToken:n,isGuest:i}=await Ws();return e&&t&&n?[t,!!i]:[null,null]}async function Bs(e,t,n){return e.code&&e.state?(console.log("We have OIDC params - attempting OIDC login"),async function(e){try{const{accessToken:t,refreshToken:n,homeserverUrl:r,identityServerUrl:o,idToken:a,clientId:l,issuer:c}=await ps(e),{user_id:d,device_id:u,is_guest:m}=await async function(e,t,n){try{const r=(0,i.createClient)({baseUrl:t,accessToken:e,idBaseUrl:n});return await r.whoami()}catch(e){throw s.vF.error("Failed to retrieve userId using accessToken",e),new Error("Failed to retrieve userId using accessToken")}}(t,r,o),h={accessToken:t,refreshToken:n,homeserverUrl:r,identityServerUrl:o,deviceId:u,userId:d,isGuest:m};return s.vF.debug("Logged in via OIDC native flow"),await js(h),(0,gs.UF)(l,c,a),!0}catch(e){return s.vF.error("Failed to login via OIDC",e),zs((e=>{switch(e.message){case us.u.MissingOrInvalidStoredState:return(0,c._t)("auth|oidc|missing_or_invalid_stored_state");case ms.InvalidQueryParameters:case us.u.CodeExchangeFailed:case us.u.InvalidBearerTokenResponse:case us.u.InvalidIdToken:default:return(0,c._t)("auth|oidc|generic_auth_error")}})(e)),!1}}(e)):function(e,t,n){var r;if(!e.loginToken)return Promise.resolve(!1);console.log("We have token login params - attempting token login");const o=localStorage.getItem(Ft.FL),a=null!==(r=localStorage.getItem(Ft.U7))&&void 0!==r?r:void 0;if(!o)return s.vF.warn("Cannot log in with token: can't determine HS URL to use"),zs((0,c._t)("auth|sso_failed_missing_storage")),Promise.resolve(!1);return N(o,a,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then(async function(e){return s.vF.log("Logged in with token"),await js(e),!0}).catch(e=>{const t=()=>{var e;const t=(0,i.createClient)({baseUrl:o,idBaseUrl:a}),r=localStorage.getItem(Ft.ot)||void 0;null===(e=l.A.get())||void 0===e||e.startSingleSignOn(t,"sso",n,r,i.SSOAction.LOGIN)};return zs((0,cs.Y0)(e,{hsUrl:o,hsName:o}),t),s.vF.error("Failed to log in with login token:",e),!1})}(e,t,n)}async function Vs(e){var t,n;const i=e.userId,r=e.deviceId;let o=null!==(t=await(null===(n=l.A.get())||void 0===n?void 0:n.getPickleKey(i,null!=r?r:"")))&&void 0!==t?t:void 0;var a,c;o?s.vF.log(`Pickle key already exists for ${e.userId}|${e.deviceId} do not create a new one`):(o=i&&r&&null!==(a=await(null===(c=l.A.get())||void 0===c?void 0:c.createPickleKey(i,r)))&&void 0!==a?a:void 0,o?s.vF.log(`Created pickle key for ${e.userId}|${e.deviceId}`):s.vF.log("Pickle key not created"));return o}async function js(e){await ra(),e.pickleKey=await Vs(e),await Xs(e),sessionStorage.setItem("mx_fresh_login",String(!0))}function zs(e,t){const{finished:n}=R.Ay.createDialog(Ht.A,{title:(0,c._t)("auth|oidc|error_title"),description:e,button:(0,c._t)("action|try_again")});n.then(([e])=>{e&&(null==t||t())})}async function Hs(e){let t;try{t=await M.Gt("account",e)}catch(t){s.vF.error(`StorageManager.idbLoad failed for account:${e}`,t)}var n;if(!t&&(t=null!==(n=localStorage.getItem(e))&&void 0!==n?n:void 0,t))try{await M.x7("account",e,t),localStorage.removeItem(e)}catch(t){s.vF.error(`migration of token ${e} to IndexedDB failed`,t)}return t}async function Ws(){var e,t,n,i;const r=null!==(e=localStorage.getItem(Ns))&&void 0!==e?e:void 0,o=null!==(t=localStorage.getItem(Ds))&&void 0!==t?t:void 0,s=await Hs(_s),a=await Hs(ys),l="true"===localStorage.getItem(ws)||!!s,c="true"===localStorage.getItem(Ss)||!!a,d=null!==(n=localStorage.getItem("mx_user_id"))&&void 0!==n?n:void 0,u=null!==(i=localStorage.getItem("mx_device_id"))&&void 0!==i?i:void 0;let m;return m=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:r,isUrl:o,hasAccessToken:l,accessToken:s,refreshToken:a,hasRefreshToken:c,userId:d,deviceId:u,isGuest:m}}async function Gs(){if(await async function(){const{finished:e}=R.Ay.createDialog($t),[t]=await e;return!!t}())throw await ra(),new Ys("Aborting login in progress because of storage inconsistency")}async function Ks(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:n,isUrl:i,hasAccessToken:r,accessToken:o,refreshToken:a,userId:c,deviceId:d,isGuest:u}=await Ws();if(r&&!o&&(s.vF.warn("restoreSessionFromStorage: storage indicates we should have an access token, but we do not. Displaying StorageEvictedDialog"),await Gs()),o&&c&&n){var m,h;if(t&&u)return s.vF.log("Ignoring stored guest account: "+c),!1;const e=null!==(m=await(null===(h=l.A.get())||void 0===h?void 0:h.getPickleKey(c,null!=d?d:"")))&&void 0!==m?m:void 0;e?s.vF.log(`Got pickle key for ${c}|${d}`):s.vF.log(`No pickle key available for ${c}|${d}`);const r=await As(e,o,bs),p=a&&await As(e,a,Es),g="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),s.vF.log(`Restoring session for ${c}`),await Js({userId:c,deviceId:d,accessToken:r,refreshToken:p,homeserverUrl:n,identityServerUrl:i,guest:u,pickleKey:null!=e?e:void 0,freshLogin:g},!1,g),!0}return s.vF.log("No previous session found."),!1}async function qs(e){return e.freshLogin=!0,oa(),e.pickleKey=await Vs(e),Js(e,!0,!0)}async function $s(e){const t=f.J.safeGet().getUserId(),n=f.J.safeGet().getDeviceId();oa(),localStorage.removeItem("mx_soft_logout"),Qs=!1;const i=e.userId!==t||e.deviceId!==n;var r,o;(i&&s.vF.warn("Clearing all data: Old session belongs to a different user/session"),e.pickleKey||void 0===e.deviceId)||(s.vF.info("Lifecycle#hydrateSession: Pickle key not provided - trying to get one"),e.pickleKey=null!==(r=await(null===(o=l.A.get())||void 0===o?void 0:o.getPickleKey(e.userId,e.deviceId)))&&void 0!==r?r:void 0);return Js(e,i,!1)}async function Js(e,t,n){Os(),e.guest=Boolean(e.guest);const r=ta();s.vF.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+r," freshLogin: "+e.freshLogin),t&&await ra();const o=await D.zV();o.dataInLocalStorage&&o.cryptoInited&&!o.dataInCryptoStore&&(s.vF.warn("doSetLoggedIn: StorageManager consistency check failed; displaying StorageEvictedDialog."),await Gs());const a=await async function(e){if(!e.refreshToken)return;const t=(0,gs.HB)();if(t)try{const n=(0,gs.rW)(),i=(0,gs.ag)(),r=l.A.get().getOidcCallbackUrl().href,o=e.deviceId;if(!o)throw new Error("Expected deviceId in user credentials.");const s=new Is(t,n,r,o,i,e.userId);return await s.oidcClientReady,s}catch(e){s.vF.error("Failed to initialise OIDC token refresher",e)}}(e);Os(),f.J.replaceUsingCreds(e,null==a?void 0:a.doRefreshAccessToken.bind(a));const c=f.J.safeGet();if((0,Jt.Tm)(e.userId),z.Vo.instance.isEnabled()&&z.Vo.instance.startListeningToSettingsChanges(c),localStorage)try{await Xs(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){s.vF.warn("Error using local storage: can't persist session!",e)}else s.vF.warn("No local storage available: can't persist session!");Os(),x.A.fire(W.r.OnLoggedIn);const d={};e.pickleKey&&(43===e.pickleKey.length?d.rustCryptoStoreKey=(0,i.decodeBase64)(e.pickleKey):d.rustCryptoStorePassword=e.pickleKey);try{await na(c,!r,d)}finally{var u;null===(u=d.rustCryptoStoreKey)||void 0===u||u.fill(0)}return O.A.runMigrations(n),n&&!e.guest&&localStorage.setItem("must_verify_device","true"),c}class Ys extends Error{}async function Xs(e){var t;localStorage.setItem(Ns,e.homeserverUrl),e.identityServerUrl&&localStorage.setItem(Ds,e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),await ks(e.accessToken,e.pickleKey),await Rs(e.refreshToken,e.pickleKey),e.pickleKey?localStorage.setItem("mx_has_pickle_key",String(!0)):"true"===localStorage.getItem("mx_has_pickle_key")&&s.vF.error("Expected a pickle key, but none provided.  Encryption may not work."),e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=_.r.instance.extensions.cryptoSetup)||void 0===t||t.persistCredentials(e),s.vF.log(`Session persisted for ${e.userId}`)}let Qs=!1;function Zs(e){var t,n;const i=f.J.get();i&&(z.Vo.instance.logout(),i.isGuest()?setTimeout(ia,0):(Qs=!0,null===(t=l.A.get())||void 0===t||t.destroyPickleKey(i.getSafeUserId(),null!==(n=i.getDeviceId())&&void 0!==n?n:""),async function(e,t){if(null!=t&&t.isUserAuthenticatedWithOidc){var n,i;const r=null!==(n=e.getAccessToken())&&void 0!==n?n:void 0,o=null!==(i=e.getRefreshToken())&&void 0!==i?i:void 0;await t.revokeTokens(r,o)}else await e.logout(!0)}(i,e).then(ia,e=>{s.vF.warn("Failed to call logout API: token will not be invalidated",e),ia()})))}function ea(){f.J.get()&&(localStorage.setItem("mx_soft_logout","true"),s.vF.log("Soft logout initiated"),Qs=!0,x.A.dispatch({action:"on_client_not_viable"}),oa(!1))}function ta(){return"true"===localStorage.getItem("mx_soft_logout")}async function na(e,t,n){s.vF.log("Lifecycle: Starting MatrixClient"),x.A.dispatch({action:"will_start_client"},!0),as.M.instance.typingStore.reset(),L.A.sharedInstance().reset(),ls.instance.prepare(e),E.default.start(),w.A.sharedInstance().start(),k.A.makeShared(e).start(),U.J.sharedInstance().startWatching(),I.A.instance.start(),jt.Ay.instance.start(),(0,Ts.o7)(),B.u.sharedInstance().start(),t?(await y.A.init(),await f.J.start(n)):(s.vF.warn("Caller requested only auxiliary services be started"),await f.J.assign(n)),Os(),Mt.sharedInstance().start(e),O.A.getValue("lowBandwidth")||C.start(),Ot.k.getInstance().start(),x.A.dispatch({action:"client_started"}),ta()&&ea()}async function ia(){var e,t;x.A.fire(W.r.OnLoggedOut,!0),oa(),await ra({deleteEverything:!0}),null===(e=zt.A.onLoggedOutAndStorageCleared)||void 0===e||e.call(zt.A),await(null===(t=l.A.get())||void 0===t?void 0:t.clearStorage()),O.A.reset(),d.Ay.get().logout_redirect_url&&(s.vF.log("Redirecting to external provider to finish logout"),window.setTimeout(()=>{window.location.href=d.Ay.get().logout_redirect_url},100)),Qs=!1}async function ra(e){var t;if(s.vF.info(`Clearing storage, deleteEverything=${null==e?void 0:e.deleteEverything}`),window.localStorage){const t=O.A.getValueAt(F.p.DEVICE,"language",null,!0,!0),n=Vt.instance.getWireInvites(),i=window.localStorage.getItem("mx_registration_time");window.localStorage.clear();try{await M.pr("account")}catch(e){s.vF.error("idbClear failed for account",e)}null!=e&&e.deleteEverything||(t&&await O.A.setValue("language",null,F.p.DEVICE,t),n.forEach(e=>{let{roomId:t}=e,n=(0,v.A)(e,Ps);Vt.instance.storeInvite(t,n)}),i&&window.localStorage.setItem("mx_registration_time",i))}null===(t=window.sessionStorage)||void 0===t||t.clear();const n=(0,b.A)({baseUrl:""});await y.A.deleteEventIndex(),await n.clearStores()}function oa(e=!0){var t;E.default.stop(),jt.Ay.instance.stop(),w.A.sharedInstance().stop(),as.M.instance.typingStore.reset(),C.stop(),I.A.instance.stop(),U.J.sharedInstance().stopWatching(),B.u.sharedInstance().stop(),Mt.sharedInstance().stop(),null===(t=k.A.shared())||void 0===t||t.stop(),y.A.stop();const n=f.J.get();n&&(n.stopClient(),n.removeAllListeners(),e&&(f.J.unset(),y.A.unset(),n.store.destroy()))}window.mxLoginWithAccessToken=async(e,t)=>{const n=(0,i.createClient)({baseUrl:e,accessToken:t}),{user_id:r,device_id:o}=await n.whoami();await Js({homeserverUrl:e,accessToken:t,userId:r,deviceId:o},!0,!1)};var sa=n("./src/utils/SnakedObject.ts"),aa=n("./node_modules/@vector-im/compound-web/dist/components/Tooltip/TooltipProvider.js"),la=(n("./node_modules/what-input/dist/what-input.js"),n("./node_modules/sanitize-html/index.js")),ca=n.n(la),da=n("./src/RoomInvite.tsx"),ua=n("./src/Rooms.ts"),ma=n("./node_modules/matrix-js-sdk/src/version-support.ts"),ha=n("./src/stores/AsyncStore.ts");const pa={deferredAction:null};class ga extends ha.y{constructor(){super(x.A,pa)}onDispatch(e){switch(e.action){case W.r.DoAfterSyncPrepared:this.updateState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.updateState({deferredAction:null});break;case"MatrixActions.sync":{if(e.state===i.SyncState.Syncing&&e.prevState!==i.SyncState.Syncing&&async function(){try{const e=f.J.get();if(!e)return;for(const t of ma.Hr)if(await e.isVersionSupported(t))return;const t="LEGACY_SERVER";L.A.sharedInstance().addOrReplaceToast({key:t,title:(0,c._t)("unsupported_server_title"),props:{description:(0,c._t)("unsupported_server_description",{version:ma.eD,brand:d.Ay.get().brand}),primaryLabel:(0,c._t)("action|ok"),onPrimaryClick:()=>{L.A.sharedInstance().dismissToast(t)}},component:H.A,priority:98})}catch(e){s.vF.warn("Failed to check server versions",e)}}(),"PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.updateState({deferredAction:null}),x.A.dispatch(t);break}case"on_client_not_viable":case W.r.OnLoggedOut:this.reset()}}}let va=null;va||(va=new ga);var fa,_a=n("./node_modules/matrix-js-sdk/src/utils.ts"),ya=n("./node_modules/uuid/dist/esm-browser/v4.js"),ba=n("./src/rageshake/submit-rageshake.ts"),Ea=n("./src/stores/AsyncStoreWithClient.ts");function wa(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function Sa(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wa(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wa(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const xa="im.vector.auto_rs_request";class Aa extends Ea.r{constructor(){super(x.A,{reportedSessionIds:new Set,lastRageshakeTime:0,initialSyncCompleted:!1}),this.onDecryptionAttempt=this.onDecryptionAttempt.bind(this),this.onDeviceMessage=this.onDeviceMessage.bind(this),this.onSyncStateChange=this.onSyncStateChange.bind(this)}static get instance(){return Aa.internalInstance}async onAction(e){if(e.action===W.r.ReportKeyBackupNotEnabled)this.onReportKeyBackupNotEnabled()}async onReady(){O.A.getValue("automaticDecryptionErrorReporting")&&this.matrixClient&&(this.matrixClient.on(i.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.on(i.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.on(i.ClientEvent.Sync,this.onSyncStateChange))}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(i.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.removeListener(i.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.removeListener(i.ClientEvent.Sync,this.onSyncStateChange))}async onDecryptionAttempt(e){if(!this.state.initialSyncCompleted)return;const t=e.getWireContent(),n=t.session_id;if(e.isDecryptionFailure()&&!this.state.reportedSessionIds.has(n)){var r;if(await(0,_a.yy)(5e3),!e.isDecryptionFailure())return;const o=new Set(this.state.reportedSessionIds);await this.updateState({reportedSessionIds:o.add(n)});const a=(new Date).getTime();if(a-this.state.lastRageshakeTime<6e4)return void s.vF.info(`Not sending recipient-side autorageshake for event ${e.getId()}/session ${n}: last rageshake was too recent`);await this.updateState({lastRageshakeTime:a});const l=e.getSender(),c={event_id:e.getId(),room_id:e.getRoomId(),session_id:n,device_id:t.device_id,user_id:l,sender_key:t.sender_key};s.vF.info(`Sending recipient-side autorageshake for event ${e.getId()}/session ${n}`);const u=await(0,ba.Ay)(d.Ay.get().bug_report_endpoint_url,{userText:"Auto-reporting decryption error (recipient)",sendLogs:!0,labels:["Z-UISI","web","uisi-recipient"],customApp:d.Ay.get().uisi_autorageshake_app,customFields:{auto_uisi:JSON.stringify(c)}}),m=Sa(Sa({},c),{},{recipient_rageshake:u,[i.ToDeviceMessageId]:(0,ya.A)()});null===(r=this.matrixClient)||void 0===r||r.sendToDevice(xa,new Map([[l,new Map([[m.device_id,m]])]]))}}async onSyncStateChange(e,t,n){this.state.initialSyncCompleted||await this.updateState({initialSyncCompleted:!(null==n||!n.nextSyncToken)})}async onDeviceMessage(e){if(e.getType()!==xa)return;const t=e.getContent(),n=t.recipient_rageshake||"",i=(new Date).getTime();i-this.state.lastRageshakeTime>6e4?(await this.updateState({lastRageshakeTime:i}),s.vF.info(`Sending sender-side autorageshake for event ${t.event_id}/session ${t.session_id}`),await(0,ba.Ay)(d.Ay.get().bug_report_endpoint_url,{userText:`Auto-reporting decryption error (sender)\nRecipient rageshake: ${n}`,sendLogs:!0,labels:["Z-UISI","web","uisi-sender"],customApp:d.Ay.get().uisi_autorageshake_app,customFields:{recipient_rageshake:n,auto_uisi:JSON.stringify(t)}})):s.vF.info(`Not sending sender-side autorageshake for event ${t.event_id}/session ${t.session_id}: last rageshake was too recent`)}async onReportKeyBackupNotEnabled(){O.A.getValue("automaticKeyBackNotEnabledReporting")&&await(0,ba.Ay)(d.Ay.get().bug_report_endpoint_url,{userText:"Auto-reporting key backup not enabled",sendLogs:!0,labels:["web",W.r.ReportKeyBackupNotEnabled]})}}fa=Aa,(0,S.A)(Aa,"internalInstance",(()=>{const e=new fa;return e.start(),e})()),window.mxAutoRageshakeStore=Aa.instance;var Ca=n("./src/PageTypes.ts"),ka=n("./src/settings/controllers/ThemeController.ts");const Ra=/^[a-z0-9=_\-./]+$/;class Ia extends ee.EventEmitter{constructor(...e){super(...e),(0,S.A)(this,"_isResizing",!1),(0,S.A)(this,"throttledMiddlePanel",(0,Li.throttle)(()=>this.emit("middlePanelResized"),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}var Ta=n("./src/settings/watchers/ThemeWatcher.ts"),Pa=n("./src/settings/watchers/FontWatcher.ts"),Na=n("./src/RoomAliasCache.ts"),Da=n("./src/MediaDeviceHandler.ts");const Ma=({vertical:e,reverse:t,id:n,passRef:i})=>{const r=["mx_ResizeHandle"];return e?r.push("mx_ResizeHandle--vertical"):r.push("mx_ResizeHandle--horizontal"),t&&r.push("mx_ResizeHandle_reverse"),o.createElement("div",{ref:i,className:r.join(" "),"data-id":n},o.createElement("div",null))};class Oa{constructor(e,t,n,i){(0,S.A)(this,"domNode",void 0),(0,S.A)(this,"id",void 0),(0,S.A)(this,"reverse",void 0),this.resizer=t,this.sizer=n,this.container=i,this.reverse=t.isReverseResizeHandle(e),this.domNode=i||(this.reverse?e.nextElementSibling:e.previousElementSibling),this.id=e.getAttribute("data-id")}copyWith(e,t,n,i){return new(0,this.constructor)(e,t,n,i)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const n=e!==this.reverse;do{var i,r;if(n)t=null===(i=t)||void 0===i?void 0:i.nextElementSibling;else t=null===(r=t)||void 0===r?void 0:r.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){var t,n;this.setRawSize(`${Math.round(e)}px`),null===(t=this.resizer.config)||void 0===t||null===(n=t.onResized)||void 0===n||n.call(t,e,this.id,this.domNode)}clearSize(){var e,t;this.sizer.clearItemSize(this.domNode),null===(e=this.resizer.config)||void 0===e||null===(t=e.onResized)||void 0===t||t.call(e,null,this.id,this.domNode)}first(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).find(e=>this.resizer.isResizeHandle(e));return t?this.copyWith(t,this.resizer,this.sizer):void 0}last(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).reverse().find(e=>this.resizer.isResizeHandle(e));return t?this.copyWith(t,this.resizer,this.sizer):void 0}}class Fa{constructor(e,t,n){this.container=e,this.vertical=t,this.reverse=n}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.removeProperty("height"):e.style.removeProperty("width")}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}class La{static createSizer(e,t,n){return new Fa(e,t,n)}constructor(e){(0,S.A)(this,"beforeOffset",void 0),this.item=e,this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}class Ua extends La{static createItem(e,t,n){return new Oa(e,t,n)}}class Ba extends Oa{notifyCollapsed(e){var t,n;null===(t=this.resizer.config)||void 0===t||null===(n=t.onCollapsed)||void 0===n||n.call(t,e,this.id,this.domNode)}get isCollapsed(){var e,t,n;return null!==(e=null===(t=this.resizer.config)||void 0===t||null===(n=t.isItemCollapsed)||void 0===n?void 0:n.call(t,this.domNode))&&void 0!==e&&e}}class Va extends La{static createItem(e,t,n,i){return new Ba(e,t,n,i)}constructor(e){var t;super(e),(0,S.A)(this,"toggleSize",void 0),(0,S.A)(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(t=t.config)||void 0===t?void 0:t.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=!!this.toggleSize&&e<this.toggleSize;t!==this.isCollapsed&&(this.isCollapsed=t,this.item.notifyCollapsed(t)),t||super.resize(e)}}class ja{constructor(e,t,n){(0,S.A)(this,"classNames",void 0),(0,S.A)(this,"onMouseDown",e=>{var t,n,i;if(0!==e.button)return;const r=e.target&&e.target.closest(`.${this.classNames.handle}`),o=null==this||null===(t=this.config)||void 0===t?void 0:t.handler;if(!r||!o&&r.parentElement!==this.container||o&&r!==o)return;var s;(e.preventDefault(),this.classNames.resizing)&&(null===(s=this.container)||void 0===s||null===(s=s.classList)||void 0===s||s.add(this.classNames.resizing));null===(n=this.config)||void 0===n||null===(i=n.onResizeStart)||void 0===i||i.call(n);const{sizer:a,distributor:l}=this.createSizerAndDistributor(r);l.start();const c=e=>{const t=a.offsetFromEvent(e);l.resizeFromContainerOffset(t)},d=document.body,u=()=>{var e,t,n;this.classNames.resizing&&(null===(n=this.container)||void 0===n||null===(n=n.classList)||void 0===n||n.remove(this.classNames.resizing));l.finish(),null===(e=this.config)||void 0===e||null===(t=e.onResizeStop)||void 0===t||t.call(e),d.removeEventListener("mouseup",u,!1),document.removeEventListener("mouseleave",u,!1),d.removeEventListener("mousemove",c,!1)};d.addEventListener("mouseup",u,!1),document.addEventListener("mouseleave",u,!1),d.addEventListener("mousemove",c,!1)}),(0,S.A)(this,"onResize",(0,Li.throttle)(()=>{const e=this.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())},100,{trailing:!0,leading:!0})),(0,S.A)(this,"getDistributors",()=>this.getResizeHandles().map(e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})),this.container=e,this.distributorCtor=t,this.config=n,this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){var e,t;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(t=t.handler)||void 0===t?void 0:t.parentElement)&&void 0!==e?e:this.container;null==n||n.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){var e,t;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(t=t.handler)||void 0===t?void 0:t.parentElement)&&void 0!==e?e:this.container;null==n||n.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find(t=>t.getAttribute("data-id")===e);if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){var t;const n=e.classList.contains(this.classNames.vertical),i=this.isReverseResizeHandle(e),r=this.distributorCtor,o=null!==(t=this.config)&&void 0!==t&&t.handler?this.container:void 0,s=r.createSizer(this.container,n,i),a=r.createItem(e,this,s,null!=o?o:void 0);return{sizer:s,distributor:new r(a)}}getResizeHandles(){var e,t;return null!=this&&null!==(e=this.config)&&void 0!==e&&e.handler?[this.config.handler]:null!==(t=this.container)&&void 0!==t&&t.children?Array.from(this.container.querySelectorAll(`.${this.classNames.handle}`)):[]}}var za=n("./src/stores/room-list/models.ts");const Ha="serverlimit",Wa=()=>{L.A.sharedInstance().dismissToast(Ha)};var Ga=n("./src/components/views/rooms/LegacyRoomList.tsx"),Ka=n("./src/components/views/rooms/RoomSublist.tsx");class qa extends o.PureComponent{openSpotlight(){x.A.fire(W.r.OpenSpotlight)}render(){const e=me()({mx_RoomSearch:!0,mx_RoomSearch_minimized:this.props.isMinimized},"mx_RoomSearch_spotlightTrigger"),t=o.createElement("div",{className:"mx_RoomSearch_icon"}),n=o.createElement("kbd",{className:"mx_RoomSearch_shortcutPrompt"},bi.vL?" K":(0,c._t)(Ei.hm[bi.Uz.CONTROL])+" K");return o.createElement(ae.A,{onClick:this.openSpotlight,className:e,"aria-label":(0,c._t)("action|search")},t,!this.props.isMinimized&&o.createElement("div",{className:"mx_RoomSearch_spotlightTriggerText"},(0,c._t)("action|search")),n)}}var $a=n("./src/stores/spaces/index.ts"),Ja=n("./src/stores/UIStore.ts"),Ya=n("./src/customisations/helpers/UIComponents.ts"),Xa=n("./src/components/views/beta/BetaCard.tsx"),Qa=n("./src/components/views/context_menus/IconizedContextMenu.tsx");const Za=["space","hideHeader","onFinished"],el=e=>{let{space:t,hideHeader:n,onFinished:r}=e,s=(0,v.A)(e,Za);const a=(0,o.useContext)(ce.Ay).getSafeUserId(),l=(0,Qt.ny)("feature_video_rooms"),d=(0,Qt.ny)("feature_element_call_video_rooms");if(!t)return null;let u=null;if("public"===t.getJoinRule()||t.canInvite(a)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,ss.Lo)(t),r()};u=o.createElement(Qa.R$,{className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:(0,c._t)("action|invite"),onClick:e})}let m=null,h=null;if((0,ss.Kv)(t)){const e=e=>{e.preventDefault(),e.stopPropagation(),(0,ss.hL)(t),r()};m=o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconSettings",label:(0,c._t)("common|settings"),onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),(0,Vo.e)(t),r()};h=o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconLeave",className:"mx_IconizedContextMenu_option_red",label:(0,c._t)("space|leave_dialog_action"),onClick:e})}let p=null;if(O.A.getValue("developerMode")){const e=e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,forceTimeline:!0,metricsTrigger:void 0}),r()};p=o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconSettings",label:(0,c._t)("space|context_menu|devtools_open_timeline"),onClick:e})}const g=t.currentState.maySendStateEvent(i.EventType.SpaceChild,a),f=g&&(0,Ya.g)(It.C.CreateRooms),_=f&&l,y=g&&(0,Ya.g)(It.C.CreateSpaces);let b=null;if(f||y){const e=e=>{e.preventDefault(),e.stopPropagation(),Si.A.trackInteraction("WebSpaceContextMenuNewRoomItem",e),(0,ss.PT)(t),r()},n=e=>{e.preventDefault(),e.stopPropagation(),(0,ss.PT)(t,d?i.RoomType.UnstableCall:i.RoomType.ElementVideo),r()},s=e=>{e.preventDefault(),e.stopPropagation(),(0,ss.Sl)(t),r()};b=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_SpacePanel_contextMenu_separatorLabel"},(0,c._t)("action|add")),f&&o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,c._t)("common|room"),onClick:e}),_&&o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,c._t)("common|video_room"),onClick:n},o.createElement(Xa.s,null)),y&&o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconPlus",label:(0,c._t)("common|space"),onClick:s},o.createElement(Xa.s,null)))}const E=e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,metricsTrigger:void 0}),r()};return o.createElement(Qa.Ay,(0,tn.A)({},s,{onFinished:r,className:"mx_SpacePanel_contextMenu",compact:!0}),!n&&o.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},t.name),o.createElement(Qa.tx,{first:!0},o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconHome",label:(0,c._t)("space|context_menu|home"),onClick:e=>{Si.A.trackInteraction("WebSpaceContextMenuHomeItem",e),E(e)}}),u,o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconExplore",label:f?(0,c._t)("space|context_menu|manage_and_explore"):(0,c._t)("space|context_menu|explore"),onClick:e=>{Si.A.trackInteraction("WebSpaceContextMenuExploreRoomsItem",e),E(e)}}),o.createElement(Qa.R$,{iconClassName:"mx_SpacePanel_iconPreferences",label:(0,c._t)("common|preferences"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ss.Wi)(t),r()}}),p,m,h,b))};var tl=n("./src/components/views/elements/InlineSpinner.tsx"),nl=n("./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js");function il(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function rl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?il(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):il(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function ol(e){return"Minified Redux error #"+e+"; visit https://redux.js.org/Errors?code="+e+" for the full message or use the non-minified dev environment for full errors. "}var sl="function"==typeof Symbol&&Symbol.observable||"@@observable",al=function(){return Math.random().toString(36).substring(7).split("").join(".")},ll={INIT:"@@redux/INIT"+al(),REPLACE:"@@redux/REPLACE"+al(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+al()}};function cl(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function dl(e,t,n){var i;if("function"==typeof t&&"function"==typeof n||"function"==typeof n&&"function"==typeof arguments[3])throw new Error(ol(0));if("function"==typeof t&&void 0===n&&(n=t,t=void 0),void 0!==n){if("function"!=typeof n)throw new Error(ol(1));return n(dl)(e,t)}if("function"!=typeof e)throw new Error(ol(2));var r=e,o=t,s=[],a=s,l=!1;function c(){a===s&&(a=s.slice())}function d(){if(l)throw new Error(ol(3));return o}function u(e){if("function"!=typeof e)throw new Error(ol(4));if(l)throw new Error(ol(5));var t=!0;return c(),a.push(e),function(){if(t){if(l)throw new Error(ol(6));t=!1,c();var n=a.indexOf(e);a.splice(n,1),s=null}}}function m(e){if(!cl(e))throw new Error(ol(7));if(void 0===e.type)throw new Error(ol(8));if(l)throw new Error(ol(9));try{l=!0,o=r(o,e)}finally{l=!1}for(var t=s=a,n=0;n<t.length;n++){(0,t[n])()}return e}return m({type:ll.INIT}),(i={dispatch:m,subscribe:u,getState:d,replaceReducer:function(e){if("function"!=typeof e)throw new Error(ol(10));r=e,m({type:ll.REPLACE})}})[sl]=function(){var e,t=u;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new Error(ol(11));function n(){e.next&&e.next(d())}return n(),{unsubscribe:t(n)}}})[sl]=function(){return this},e},i}function ul(e,t){return function(){return t(e.apply(this,arguments))}}function ml(e,t){if("function"==typeof e)return ul(e,t);if("object"!=typeof e||null===e)throw new Error(ol(16));var n={};for(var i in e){var r=e[i];"function"==typeof r&&(n[i]=ul(r,t))}return n}function hl(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce(function(e,t){return function(){return e(t.apply(void 0,arguments))}})}var pl=o.createContext(null);var gl=function(e){e()},vl=function(){return gl};var fl={notify:function(){},get:function(){return[]}};function _l(e,t){var n,i=fl;function r(){s.onStateChange&&s.onStateChange()}function o(){n||(n=t?t.addNestedSub(r):e.subscribe(r),i=function(){var e=vl(),t=null,n=null;return{clear:function(){t=null,n=null},notify:function(){e(function(){for(var e=t;e;)e.callback(),e=e.next})},get:function(){for(var e=[],n=t;n;)e.push(n),n=n.next;return e},subscribe:function(e){var i=!0,r=n={callback:e,next:null,prev:n};return r.prev?r.prev.next=r:t=r,function(){i&&null!==t&&(i=!1,r.next?r.next.prev=r.prev:n=r.prev,r.prev?r.prev.next=r.next:t=r.next)}}}}())}var s={addNestedSub:function(e){return o(),i.subscribe(e)},notifyNestedSubs:function(){i.notify()},handleChangeWrapper:r,isSubscribed:function(){return Boolean(n)},trySubscribe:o,tryUnsubscribe:function(){n&&(n(),n=void 0,i.clear(),i=fl)},getListeners:function(){return i}};return s}var yl="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement?o.useLayoutEffect:o.useEffect;const bl=function(e){var t=e.store,n=e.context,i=e.children,r=(0,o.useMemo)(function(){var e=_l(t);return{store:t,subscription:e}},[t]),s=(0,o.useMemo)(function(){return t.getState()},[t]);yl(function(){var e=r.subscription;return e.onStateChange=e.notifyNestedSubs,e.trySubscribe(),s!==t.getState()&&e.notifyNestedSubs(),function(){e.tryUnsubscribe(),e.onStateChange=null}},[r,s]);var a=n||pl;return o.createElement(a.Provider,{value:r},i)};var El=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutPropertiesLoose.js"),wl=n("./node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js"),Sl=n.n(wl),xl=n("./node_modules/react-redux/node_modules/react-is/index.js"),Al=["getDisplayName","methodName","renderCountProp","shouldHandleStateChanges","storeKey","withRef","forwardRef","context"],Cl=["reactReduxForwardedRef"],kl=[],Rl=[null,null];function Il(e,t){var n=e[1];return[t.payload,n+1]}function Tl(e,t,n){yl(function(){return e.apply(void 0,t)},n)}function Pl(e,t,n,i,r,o,s){e.current=i,t.current=r,n.current=!1,o.current&&(o.current=null,s())}function Nl(e,t,n,i,r,o,s,a,l,c){if(e){var d=!1,u=null,m=function(){if(!d){var e,n,m=t.getState();try{e=i(m,r.current)}catch(e){n=e,u=e}n||(u=null),e===o.current?s.current||l():(o.current=e,a.current=e,s.current=!0,c({type:"STORE_UPDATED",payload:{error:n}}))}};n.onStateChange=m,n.trySubscribe(),m();return function(){if(d=!0,n.tryUnsubscribe(),n.onStateChange=null,u)throw u}}}var Dl=function(){return[null,0]};function Ml(e,t){void 0===t&&(t={});var n=t,i=n.getDisplayName,r=void 0===i?function(e){return"ConnectAdvanced("+e+")"}:i,s=n.methodName,a=void 0===s?"connectAdvanced":s,l=n.renderCountProp,c=void 0===l?void 0:l,d=n.shouldHandleStateChanges,u=void 0===d||d,m=n.storeKey,h=void 0===m?"store":m,p=(n.withRef,n.forwardRef),g=void 0!==p&&p,v=n.context,f=void 0===v?pl:v,_=(0,El.A)(n,Al),y=f;return function(t){var n=t.displayName||t.name||"Component",i=r(n),s=(0,tn.A)({},_,{getDisplayName:r,methodName:a,renderCountProp:c,shouldHandleStateChanges:u,storeKey:h,displayName:i,wrappedComponentName:n,WrappedComponent:t}),l=_.pure;var d=l?o.useMemo:function(e){return e()};function m(n){var i=(0,o.useMemo)(function(){var e=n.reactReduxForwardedRef,t=(0,El.A)(n,Cl);return[n.context,e,t]},[n]),r=i[0],a=i[1],l=i[2],c=(0,o.useMemo)(function(){return r&&r.Consumer&&(0,xl.isContextConsumer)(o.createElement(r.Consumer,null))?r:y},[r,y]),m=(0,o.useContext)(c),h=Boolean(n.store)&&Boolean(n.store.getState)&&Boolean(n.store.dispatch);Boolean(m)&&Boolean(m.store);var p=h?n.store:m.store,g=(0,o.useMemo)(function(){return function(t){return e(t.dispatch,s)}(p)},[p]),v=(0,o.useMemo)(function(){if(!u)return Rl;var e=_l(p,h?null:m.subscription),t=e.notifyNestedSubs.bind(e);return[e,t]},[p,h,m]),f=v[0],_=v[1],b=(0,o.useMemo)(function(){return h?m:(0,tn.A)({},m,{subscription:f})},[h,m,f]),E=(0,o.useReducer)(Il,kl,Dl),w=E[0][0],S=E[1];if(w&&w.error)throw w.error;var x=(0,o.useRef)(),A=(0,o.useRef)(l),C=(0,o.useRef)(),k=(0,o.useRef)(!1),R=d(function(){return C.current&&l===A.current?C.current:g(p.getState(),l)},[p,w,l]);Tl(Pl,[A,x,k,l,R,C,_]),Tl(Nl,[u,p,f,g,A,x,k,C,_,S],[p,f,g]);var I=(0,o.useMemo)(function(){return o.createElement(t,(0,tn.A)({},R,{ref:a}))},[a,t,R]);return(0,o.useMemo)(function(){return u?o.createElement(c.Provider,{value:b},I):I},[c,I,b])}var p=l?o.memo(m):m;if(p.WrappedComponent=t,p.displayName=m.displayName=i,g){var v=o.forwardRef(function(e,t){return o.createElement(p,(0,tn.A)({},e,{reactReduxForwardedRef:t}))});return v.displayName=i,v.WrappedComponent=t,Sl()(v,t)}return Sl()(p,t)}}function Ol(e,t){return e===t?0!==e||0!==t||1/e==1/t:e!=e&&t!=t}function Fl(e,t){if(Ol(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(var r=0;r<n.length;r++)if(!Object.prototype.hasOwnProperty.call(t,n[r])||!Ol(e[n[r]],t[n[r]]))return!1;return!0}function Ll(e){return function(t,n){var i=e(t,n);function r(){return i}return r.dependsOnOwnProps=!1,r}}function Ul(e){return null!==e.dependsOnOwnProps&&void 0!==e.dependsOnOwnProps?Boolean(e.dependsOnOwnProps):1!==e.length}function Bl(e,t){return function(t,n){n.displayName;var i=function(e,t){return i.dependsOnOwnProps?i.mapToProps(e,t):i.mapToProps(e)};return i.dependsOnOwnProps=!0,i.mapToProps=function(t,n){i.mapToProps=e,i.dependsOnOwnProps=Ul(e);var r=i(t,n);return"function"==typeof r&&(i.mapToProps=r,i.dependsOnOwnProps=Ul(r),r=i(t,n)),r},i}}const Vl=[function(e){return"function"==typeof e?Bl(e):void 0},function(e){return e?void 0:Ll(function(e){return{dispatch:e}})},function(e){return e&&"object"==typeof e?Ll(function(t){return function(e,t){var n={},i=function(i){var r=e[i];"function"==typeof r&&(n[i]=function(){return t(r.apply(void 0,arguments))})};for(var r in e)i(r);return n}(e,t)}):void 0}];const jl=[function(e){return"function"==typeof e?Bl(e):void 0},function(e){return e?void 0:Ll(function(){return{}})}];function zl(e,t,n){return(0,tn.A)({},n,e,t)}const Hl=[function(e){return"function"==typeof e?function(e){return function(t,n){n.displayName;var i,r=n.pure,o=n.areMergedPropsEqual,s=!1;return function(t,n,a){var l=e(t,n,a);return s?r&&o(l,i)||(i=l):(s=!0,i=l),i}}}(e):void 0},function(e){return e?void 0:function(){return zl}}];var Wl=["initMapStateToProps","initMapDispatchToProps","initMergeProps"];function Gl(e,t,n,i){return function(r,o){return n(e(r,o),t(i,o),o)}}function Kl(e,t,n,i,r){var o,s,a,l,c,d=r.areStatesEqual,u=r.areOwnPropsEqual,m=r.areStatePropsEqual,h=!1;function p(r,h){var p,g,v=!u(h,s),f=!d(r,o,h,s);return o=r,s=h,v&&f?(a=e(o,s),t.dependsOnOwnProps&&(l=t(i,s)),c=n(a,l,s)):v?(e.dependsOnOwnProps&&(a=e(o,s)),t.dependsOnOwnProps&&(l=t(i,s)),c=n(a,l,s)):f?(p=e(o,s),g=!m(p,a),a=p,g&&(c=n(a,l,s)),c):c}return function(r,d){return h?p(r,d):(a=e(o=r,s=d),l=t(i,s),c=n(a,l,s),h=!0,c)}}function ql(e,t){var n=t.initMapStateToProps,i=t.initMapDispatchToProps,r=t.initMergeProps,o=(0,El.A)(t,Wl),s=n(e,o),a=i(e,o),l=r(e,o);return(o.pure?Kl:Gl)(s,a,l,e,o)}var $l=["pure","areStatesEqual","areOwnPropsEqual","areStatePropsEqual","areMergedPropsEqual"];function Jl(e,t,n){for(var i=t.length-1;i>=0;i--){var r=t[i](e);if(r)return r}return function(t,i){throw new Error("Invalid value of type "+typeof e+" for "+n+" argument when connecting component "+i.wrappedComponentName+".")}}function Yl(e,t){return e===t}function Xl(e){var t=void 0===e?{}:e,n=t.connectHOC,i=void 0===n?Ml:n,r=t.mapStateToPropsFactories,o=void 0===r?jl:r,s=t.mapDispatchToPropsFactories,a=void 0===s?Vl:s,l=t.mergePropsFactories,c=void 0===l?Hl:l,d=t.selectorFactory,u=void 0===d?ql:d;return function(e,t,n,r){void 0===r&&(r={});var s=r,l=s.pure,d=void 0===l||l,m=s.areStatesEqual,h=void 0===m?Yl:m,p=s.areOwnPropsEqual,g=void 0===p?Fl:p,v=s.areStatePropsEqual,f=void 0===v?Fl:v,_=s.areMergedPropsEqual,y=void 0===_?Fl:_,b=(0,El.A)(s,$l),E=Jl(e,o,"mapStateToProps"),w=Jl(t,a,"mapDispatchToProps"),S=Jl(n,c,"mergeProps");return i(u,(0,tn.A)({methodName:"connect",getDisplayName:function(e){return"Connect("+e+")"},shouldHandleStateChanges:Boolean(e),initMapStateToProps:E,initMapDispatchToProps:w,initMergeProps:S,pure:d,areStatesEqual:h,areOwnPropsEqual:g,areStatePropsEqual:f,areMergedPropsEqual:y},b))}}const Ql=Xl();var Zl,ec=n("./node_modules/react-dom/index.js");function tc(e,t){var n=(0,o.useState)(function(){return{inputs:t,result:e()}})[0],i=(0,o.useRef)(!0),r=(0,o.useRef)(n),s=i.current||Boolean(t&&r.current.inputs&&function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(t,r.current.inputs))?r.current:{inputs:t,result:e()};return(0,o.useEffect)(function(){i.current=!1,r.current=s},[s]),s.result}Zl=ec.unstable_batchedUpdates,gl=Zl;var nc=tc,ic=function(e,t){return tc(function(){return e},t)},rc="Invariant failed";var oc=function(e){var t=e.top,n=e.right,i=e.bottom,r=e.left;return{top:t,right:n,bottom:i,left:r,width:n-r,height:i-t,x:r,y:t,center:{x:(n+r)/2,y:(i+t)/2}}},sc=function(e,t){return{top:e.top-t.top,left:e.left-t.left,bottom:e.bottom+t.bottom,right:e.right+t.right}},ac=function(e,t){return{top:e.top+t.top,left:e.left+t.left,bottom:e.bottom-t.bottom,right:e.right-t.right}},lc={top:0,right:0,bottom:0,left:0},cc=function(e){var t=e.borderBox,n=e.margin,i=void 0===n?lc:n,r=e.border,o=void 0===r?lc:r,s=e.padding,a=void 0===s?lc:s,l=oc(sc(t,i)),c=oc(ac(t,o)),d=oc(ac(c,a));return{marginBox:l,borderBox:oc(t),paddingBox:c,contentBox:d,margin:i,border:o,padding:a}},dc=function(e){var t=e.slice(0,-2);if("px"!==e.slice(-2))return 0;var n=Number(t);return isNaN(n)&&function(e){if(!e)throw new Error(rc)}(!1),n},uc=function(e,t){var n,i,r=e.borderBox,o=e.border,s=e.margin,a=e.padding,l=(i=t,{top:(n=r).top+i.y,left:n.left+i.x,bottom:n.bottom+i.y,right:n.right+i.x});return cc({borderBox:l,border:o,margin:s,padding:a})},mc=function(e,t){return void 0===t&&(t={x:window.pageXOffset,y:window.pageYOffset}),uc(e,t)},hc=function(e,t){var n={top:dc(t.marginTop),right:dc(t.marginRight),bottom:dc(t.marginBottom),left:dc(t.marginLeft)},i={top:dc(t.paddingTop),right:dc(t.paddingRight),bottom:dc(t.paddingBottom),left:dc(t.paddingLeft)},r={top:dc(t.borderTopWidth),right:dc(t.borderRightWidth),bottom:dc(t.borderBottomWidth),left:dc(t.borderLeftWidth)};return cc({borderBox:e,margin:n,padding:i,border:r})},pc=function(e){var t=e.getBoundingClientRect(),n=window.getComputedStyle(e);return hc(t,n)},gc=Number.isNaN||function(e){return"number"==typeof e&&e!=e};function vc(e,t){return e===t||!(!gc(e)||!gc(t))}function fc(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!vc(e[n],t[n]))return!1;return!0}const _c=function(e,t){var n;void 0===t&&(t=fc);var i,r=[],o=!1;return function(){for(var s=[],a=0;a<arguments.length;a++)s[a]=arguments[a];return o&&n===this&&t(s,r)||(i=e.apply(this,s),o=!0,n=this,r=s),i}};const yc=function(e){var t=[],n=null,i=function(){for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];t=r,n||(n=requestAnimationFrame(function(){n=null,e.apply(void 0,t)}))};return i.cancel=function(){n&&(cancelAnimationFrame(n),n=null)},i};function bc(e,t){}bc.bind(null,"warn"),bc.bind(null,"error");function Ec(){}function wc(e,t,n){var i=t.map(function(t){var i=function(e,t){return(0,tn.A)({},e,{},t)}(n,t.options);return e.addEventListener(t.eventName,t.fn,i),function(){e.removeEventListener(t.eventName,t.fn,i)}});return function(){i.forEach(function(e){e()})}}var Sc="Invariant failed";function xc(e){this.message=e}function Ac(e,t){if(!e)throw new xc(Sc)}xc.prototype.toString=function(){return this.message};var Cc=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).callbacks=null,t.unbind=Ec,t.onWindowError=function(e){var n=t.getCallbacks();n.isDragging()&&n.tryAbort(),e.error instanceof xc&&e.preventDefault()},t.getCallbacks=function(){if(!t.callbacks)throw new Error("Unable to find AppCallbacks in <ErrorBoundary/>");return t.callbacks},t.setCallbacks=function(e){t.callbacks=e},t}(0,nl.A)(t,e);var n=t.prototype;return n.componentDidMount=function(){this.unbind=wc(window,[{eventName:"error",fn:this.onWindowError}])},n.componentDidCatch=function(e){if(!(e instanceof xc))throw e;this.setState({})},n.componentWillUnmount=function(){this.unbind()},n.render=function(){return this.props.children(this.setCallbacks)},t}(o.Component),kc=function(e){return e+1},Rc=function(e,t){var n=e.droppableId===t.droppableId,i=kc(e.index),r=kc(t.index);return n?"\n      You have moved the item from position "+i+"\n      to position "+r+"\n    ":"\n    You have moved the item from position "+i+"\n    in list "+e.droppableId+"\n    to list "+t.droppableId+"\n    in position "+r+"\n  "},Ic=function(e,t,n){return t.droppableId===n.droppableId?"\n      The item "+e+"\n      has been combined with "+n.draggableId:"\n      The item "+e+"\n      in list "+t.droppableId+"\n      has been combined with "+n.draggableId+"\n      in list "+n.droppableId+"\n    "},Tc=function(e){return"\n  The item has returned to its starting position\n  of "+kc(e.index)+"\n"},Pc="\n  Press space bar to start a drag.\n  When dragging you can use the arrow keys to move the item around and escape to cancel.\n  Some screen readers may require you to be in focus mode or to use your pass through key\n",Nc=function(e){return"\n  You have lifted an item in position "+kc(e.source.index)+"\n"},Dc=function(e){var t=e.destination;if(t)return Rc(e.source,t);var n=e.combine;return n?Ic(e.draggableId,e.source,n):"You are over an area that cannot be dropped on"},Mc=function(e){if("CANCEL"===e.reason)return"\n      Movement cancelled.\n      "+Tc(e.source)+"\n    ";var t=e.destination,n=e.combine;return t?"\n      You have dropped the item.\n      "+Rc(e.source,t)+"\n    ":n?"\n      You have dropped the item.\n      "+Ic(e.draggableId,e.source,n)+"\n    ":"\n    The item has been dropped while not over a drop area.\n    "+Tc(e.source)+"\n  "},Oc={x:0,y:0},Fc=function(e,t){return{x:e.x+t.x,y:e.y+t.y}},Lc=function(e,t){return{x:e.x-t.x,y:e.y-t.y}},Uc=function(e,t){return e.x===t.x&&e.y===t.y},Bc=function(e){return{x:0!==e.x?-e.x:0,y:0!==e.y?-e.y:0}},Vc=function(e,t,n){var i;return void 0===n&&(n=0),(i={})[e]=t,i["x"===e?"y":"x"]=n,i},jc=function(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},zc=function(e,t){return Math.min.apply(Math,t.map(function(t){return jc(e,t)}))},Hc=function(e){return function(t){return{x:e(t.x),y:e(t.y)}}},Wc=function(e,t){return{top:e.top+t.y,left:e.left+t.x,bottom:e.bottom+t.y,right:e.right+t.x}},Gc=function(e){return[{x:e.left,y:e.top},{x:e.right,y:e.top},{x:e.left,y:e.bottom},{x:e.right,y:e.bottom}]},Kc=function(e,t){return t&&t.shouldClipSubject?function(e,t){var n=oc({top:Math.max(t.top,e.top),right:Math.min(t.right,e.right),bottom:Math.min(t.bottom,e.bottom),left:Math.max(t.left,e.left)});return n.width<=0||n.height<=0?null:n}(t.pageMarginBox,e):oc(e)},qc=function(e){var t=e.page,n=e.withPlaceholder,i=e.axis,r=e.frame,o=function(e,t){return t?Wc(e,t.scroll.diff.displacement):e}(t.marginBox,r),s=function(e,t,n){var i;return n&&n.increasedBy?(0,tn.A)({},e,((i={})[t.end]=e[t.end]+n.increasedBy[t.line],i)):e}(o,i,n);return{page:t,withPlaceholder:n,active:Kc(s,r)}},$c=function(e,t){e.frame||Ac(!1);var n=e.frame,i=Lc(t,n.scroll.initial),r=Bc(i),o=(0,tn.A)({},n,{scroll:{initial:n.scroll.initial,current:t,diff:{value:i,displacement:r},max:n.scroll.max}}),s=qc({page:e.subject.page,withPlaceholder:e.subject.withPlaceholder,axis:e.axis,frame:o});return(0,tn.A)({},e,{frame:o,subject:s})};function Jc(e){return Object.values?Object.values(e):Object.keys(e).map(function(t){return e[t]})}function Yc(e,t){if(e.findIndex)return e.findIndex(t);for(var n=0;n<e.length;n++)if(t(e[n]))return n;return-1}function Xc(e,t){if(e.find)return e.find(t);var n=Yc(e,t);return-1!==n?e[n]:void 0}function Qc(e){return Array.prototype.slice.call(e)}var Zc=_c(function(e){return e.reduce(function(e,t){return e[t.descriptor.id]=t,e},{})}),ed=_c(function(e){return e.reduce(function(e,t){return e[t.descriptor.id]=t,e},{})}),td=_c(function(e){return Jc(e)}),nd=_c(function(e){return Jc(e)}),id=_c(function(e,t){var n=nd(t).filter(function(t){return e===t.descriptor.droppableId}).sort(function(e,t){return e.descriptor.index-t.descriptor.index});return n});function rd(e){return e.at&&"REORDER"===e.at.type?e.at.destination:null}function od(e){return e.at&&"COMBINE"===e.at.type?e.at.combine:null}var sd=_c(function(e,t){return t.filter(function(t){return t.descriptor.id!==e.descriptor.id})}),ad=function(e,t){return e.descriptor.droppableId===t.descriptor.id},ld={point:Oc,value:0},cd={invisible:{},visible:{},all:[]},dd={displaced:cd,displacedBy:ld,at:null},ud=function(e,t){return function(n){return e<=n&&n<=t}},md=function(e){var t=ud(e.top,e.bottom),n=ud(e.left,e.right);return function(i){if(t(i.top)&&t(i.bottom)&&n(i.left)&&n(i.right))return!0;var r=t(i.top)||t(i.bottom),o=n(i.left)||n(i.right);if(r&&o)return!0;var s=i.top<e.top&&i.bottom>e.bottom,a=i.left<e.left&&i.right>e.right;return!(!s||!a)||(s&&o||a&&r)}},hd=function(e){var t=ud(e.top,e.bottom),n=ud(e.left,e.right);return function(e){return t(e.top)&&t(e.bottom)&&n(e.left)&&n(e.right)}},pd={direction:"vertical",line:"y",crossAxisLine:"x",start:"top",end:"bottom",size:"height",crossAxisStart:"left",crossAxisEnd:"right",crossAxisSize:"width"},gd={direction:"horizontal",line:"x",crossAxisLine:"y",start:"left",end:"right",size:"width",crossAxisStart:"top",crossAxisEnd:"bottom",crossAxisSize:"height"},vd=function(e){var t=e.target,n=e.destination,i=e.viewport,r=e.withDroppableDisplacement,o=e.isVisibleThroughFrameFn,s=r?function(e,t){var n=t.frame?t.frame.scroll.diff.displacement:Oc;return Wc(e,n)}(t,n):t;return function(e,t,n){return!!t.subject.active&&n(t.subject.active)(e)}(s,n,o)&&function(e,t,n){return n(t)(e)}(s,i,o)},fd=function(e){return vd((0,tn.A)({},e,{isVisibleThroughFrameFn:md}))},_d=function(e){return vd((0,tn.A)({},e,{isVisibleThroughFrameFn:hd}))};function yd(e){var t=e.afterDragging,n=e.destination,i=e.displacedBy,r=e.viewport,o=e.forceShouldAnimate,s=e.last;return t.reduce(function(e,t){var a=function(e,t){var n=e.page.marginBox,i={top:t.point.y,right:0,bottom:0,left:t.point.x};return oc(sc(n,i))}(t,i),l=t.descriptor.id;if(e.all.push(l),!fd({target:a,destination:n,viewport:r,withDroppableDisplacement:!0}))return e.invisible[t.descriptor.id]=!0,e;var c=function(e,t,n){if("boolean"==typeof n)return n;if(!t)return!0;var i=t.invisible,r=t.visible;if(i[e])return!1;var o=r[e];return!o||o.shouldAnimate}(l,s,o),d={draggableId:l,shouldAnimate:c};return e.visible[l]=d,e},{all:[],visible:{},invisible:{}})}function bd(e){var t=e.insideDestination,n=e.inHomeList,i=e.displacedBy,r=e.destination,o=function(e,t){if(!e.length)return 0;var n=e[e.length-1].descriptor.index;return t.inHomeList?n:n+1}(t,{inHomeList:n});return{displaced:cd,displacedBy:i,at:{type:"REORDER",destination:{droppableId:r.descriptor.id,index:o}}}}function Ed(e){var t=e.draggable,n=e.insideDestination,i=e.destination,r=e.viewport,o=e.displacedBy,s=e.last,a=e.index,l=e.forceShouldAnimate,c=ad(t,i);if(null==a)return bd({insideDestination:n,inHomeList:c,displacedBy:o,destination:i});var d=Xc(n,function(e){return e.descriptor.index===a});if(!d)return bd({insideDestination:n,inHomeList:c,displacedBy:o,destination:i});var u=sd(t,n),m=n.indexOf(d);return{displaced:yd({afterDragging:u.slice(m),destination:i,displacedBy:o,last:s,viewport:r.frame,forceShouldAnimate:l}),displacedBy:o,at:{type:"REORDER",destination:{droppableId:i.descriptor.id,index:a}}}}function wd(e,t){return Boolean(t.effected[e])}var Sd=function(e){var t=e.isMovingForward,n=e.isInHomeList,i=e.draggable,r=e.draggables,o=e.destination,s=e.insideDestination,a=e.previousImpact,l=e.viewport,c=e.afterCritical,d=a.at;if(d||Ac(!1),"REORDER"===d.type){var u=function(e){var t=e.isMovingForward,n=e.isInHomeList,i=e.insideDestination,r=e.location;if(!i.length)return null;var o=r.index,s=t?o+1:o-1,a=i[0].descriptor.index,l=i[i.length-1].descriptor.index;return s<a||s>(n?l:l+1)?null:s}({isMovingForward:t,isInHomeList:n,location:d.destination,insideDestination:s});return null==u?null:Ed({draggable:i,insideDestination:s,destination:o,viewport:l,last:a.displaced,displacedBy:a.displacedBy,index:u})}var m=function(e){var t=e.isMovingForward,n=e.destination,i=e.draggables,r=e.combine,o=e.afterCritical;if(!n.isCombineEnabled)return null;var s=r.draggableId,a=i[s].descriptor.index;return wd(s,o)?t?a:a-1:t?a+1:a}({isMovingForward:t,destination:o,displaced:a.displaced,draggables:r,combine:d.combine,afterCritical:c});return null==m?null:Ed({draggable:i,insideDestination:s,destination:o,viewport:l,last:a.displaced,displacedBy:a.displacedBy,index:m})},xd=function(e){var t=e.afterCritical,n=e.impact,i=e.draggables,r=od(n);r||Ac(!1);var o=r.draggableId,s=i[o].page.borderBox.center,a=function(e){var t=e.displaced,n=e.afterCritical,i=e.combineWith,r=e.displacedBy,o=Boolean(t.visible[i]||t.invisible[i]);return wd(i,n)?o?Oc:Bc(r.point):o?r.point:Oc}({displaced:n.displaced,afterCritical:t,combineWith:o,displacedBy:n.displacedBy});return Fc(s,a)},Ad=function(e,t){return t.margin[e.start]+t.borderBox[e.size]/2},Cd=function(e,t,n){return t[e.crossAxisStart]+n.margin[e.crossAxisStart]+n.borderBox[e.crossAxisSize]/2},kd=function(e){var t=e.axis,n=e.moveRelativeTo,i=e.isMoving;return Vc(t.line,n.marginBox[t.end]+Ad(t,i),Cd(t,n.marginBox,i))},Rd=function(e){var t=e.axis,n=e.moveRelativeTo,i=e.isMoving;return Vc(t.line,n.marginBox[t.start]-function(e,t){return t.margin[e.end]+t.borderBox[e.size]/2}(t,i),Cd(t,n.marginBox,i))},Id=function(e){var t=e.impact,n=e.draggable,i=e.draggables,r=e.droppable,o=e.afterCritical,s=id(r.descriptor.id,i),a=n.page,l=r.axis;if(!s.length)return function(e){var t=e.axis,n=e.moveInto,i=e.isMoving;return Vc(t.line,n.contentBox[t.start]+Ad(t,i),Cd(t,n.contentBox,i))}({axis:l,moveInto:r.page,isMoving:a});var c=t.displaced,d=t.displacedBy,u=c.all[0];if(u){var m=i[u];if(wd(u,o))return Rd({axis:l,moveRelativeTo:m.page,isMoving:a});var h=uc(m.page,d.point);return Rd({axis:l,moveRelativeTo:h,isMoving:a})}var p=s[s.length-1];if(p.descriptor.id===n.descriptor.id)return a.borderBox.center;if(wd(p.descriptor.id,o)){var g=uc(p.page,Bc(o.displacedBy.point));return kd({axis:l,moveRelativeTo:g,isMoving:a})}return kd({axis:l,moveRelativeTo:p.page,isMoving:a})},Td=function(e,t){var n=e.frame;return n?Fc(t,n.scroll.diff.displacement):t},Pd=function(e){var t=function(e){var t=e.impact,n=e.draggable,i=e.droppable,r=e.draggables,o=e.afterCritical,s=n.page.borderBox.center,a=t.at;return i&&a?"REORDER"===a.type?Id({impact:t,draggable:n,draggables:r,droppable:i,afterCritical:o}):xd({impact:t,draggables:r,afterCritical:o}):s}(e),n=e.droppable;return n?Td(n,t):t},Nd=function(e,t){var n=Lc(t,e.scroll.initial),i=Bc(n);return{frame:oc({top:t.y,bottom:t.y+e.frame.height,left:t.x,right:t.x+e.frame.width}),scroll:{initial:e.scroll.initial,max:e.scroll.max,current:t,diff:{value:n,displacement:i}}}};function Dd(e,t){return e.map(function(e){return t[e]})}var Md=function(e){var t=e.pageBorderBoxCenter,n=e.draggable,i=function(e,t){return Fc(e.scroll.diff.displacement,t)}(e.viewport,t),r=Lc(i,n.page.borderBox.center);return Fc(n.client.borderBox.center,r)},Od=function(e){var t=e.draggable,n=e.destination,i=e.newPageBorderBoxCenter,r=e.viewport,o=e.withDroppableDisplacement,s=e.onlyOnMainAxis,a=void 0!==s&&s,l=Lc(i,t.page.borderBox.center),c={target:Wc(t.page.borderBox,l),destination:n,withDroppableDisplacement:o,viewport:r};return a?function(e){return vd((0,tn.A)({},e,{isVisibleThroughFrameFn:(t=e.destination.axis,function(e){var n=ud(e.top,e.bottom),i=ud(e.left,e.right);return function(e){return t===pd?n(e.top)&&n(e.bottom):i(e.left)&&i(e.right)}})}));var t}(c):_d(c)},Fd=function(e){var t=e.isMovingForward,n=e.draggable,i=e.destination,r=e.draggables,o=e.previousImpact,s=e.viewport,a=e.previousPageBorderBoxCenter,l=e.previousClientSelection,c=e.afterCritical;if(!i.isEnabled)return null;var d=id(i.descriptor.id,r),u=ad(n,i),m=function(e){var t=e.isMovingForward,n=e.draggable,i=e.destination,r=e.insideDestination,o=e.previousImpact;if(!i.isCombineEnabled)return null;if(!rd(o))return null;function s(e){var t={type:"COMBINE",combine:{draggableId:e,droppableId:i.descriptor.id}};return(0,tn.A)({},o,{at:t})}var a=o.displaced.all,l=a.length?a[0]:null;if(t)return l?s(l):null;var c=sd(n,r);if(!l)return c.length?s(c[c.length-1].descriptor.id):null;var d=Yc(c,function(e){return e.descriptor.id===l});-1===d&&Ac(!1);var u=d-1;return u<0?null:s(c[u].descriptor.id)}({isMovingForward:t,draggable:n,destination:i,insideDestination:d,previousImpact:o})||Sd({isMovingForward:t,isInHomeList:u,draggable:n,draggables:r,destination:i,insideDestination:d,previousImpact:o,viewport:s,afterCritical:c});if(!m)return null;var h=Pd({impact:m,draggable:n,droppable:i,draggables:r,afterCritical:c});if(Od({draggable:n,destination:i,newPageBorderBoxCenter:h,viewport:s.frame,withDroppableDisplacement:!1,onlyOnMainAxis:!0}))return{clientSelection:Md({pageBorderBoxCenter:h,draggable:n,viewport:s}),impact:m,scrollJumpRequest:null};var p=Lc(h,a),g=function(e){var t=e.impact,n=e.viewport,i=e.destination,r=e.draggables,o=e.maxScrollChange,s=Nd(n,Fc(n.scroll.current,o)),a=i.frame?$c(i,Fc(i.frame.scroll.current,o)):i,l=t.displaced,c=yd({afterDragging:Dd(l.all,r),destination:i,displacedBy:t.displacedBy,viewport:s.frame,last:l,forceShouldAnimate:!1}),d=yd({afterDragging:Dd(l.all,r),destination:a,displacedBy:t.displacedBy,viewport:n.frame,last:l,forceShouldAnimate:!1}),u={},m={},h=[l,c,d];return l.all.forEach(function(e){var t=function(e,t){for(var n=0;n<t.length;n++){var i=t[n].visible[e];if(i)return i}return null}(e,h);t?m[e]=t:u[e]=!0}),(0,tn.A)({},t,{displaced:{all:l.all,invisible:u,visible:m}})}({impact:m,viewport:s,destination:i,draggables:r,maxScrollChange:p});return{clientSelection:l,impact:g,scrollJumpRequest:p}},Ld=function(e){var t=e.subject.active;return t||Ac(!1),t},Ud=function(e,t){var n=e.page.borderBox.center;return wd(e.descriptor.id,t)?Lc(n,t.displacedBy.point):n},Bd=function(e,t){var n=e.page.borderBox;return wd(e.descriptor.id,t)?Wc(n,Bc(t.displacedBy.point)):n},Vd=_c(function(e,t){var n=t[e.line];return{value:n,point:Vc(e.line,n)}}),jd=function(e,t){return(0,tn.A)({},e,{scroll:(0,tn.A)({},e.scroll,{max:t})})},zd=function(e,t,n){var i=e.frame;ad(t,e)&&Ac(!1),e.subject.withPlaceholder&&Ac(!1);var r=Vd(e.axis,t.displaceBy).point,o=function(e,t,n){var i=e.axis;if("virtual"===e.descriptor.mode)return Vc(i.line,t[i.line]);var r=e.subject.page.contentBox[i.size],o=id(e.descriptor.id,n).reduce(function(e,t){return e+t.client.marginBox[i.size]},0)+t[i.line]-r;return o<=0?null:Vc(i.line,o)}(e,r,n),s={placeholderSize:r,increasedBy:o,oldFrameMaxScroll:e.frame?e.frame.scroll.max:null};if(!i){var a=qc({page:e.subject.page,withPlaceholder:s,axis:e.axis,frame:e.frame});return(0,tn.A)({},e,{subject:a})}var l=o?Fc(i.scroll.max,o):i.scroll.max,c=jd(i,l),d=qc({page:e.subject.page,withPlaceholder:s,axis:e.axis,frame:c});return(0,tn.A)({},e,{subject:d,frame:c})},Hd=function(e){var t=e.isMovingForward,n=e.previousPageBorderBoxCenter,i=e.draggable,r=e.isOver,o=e.draggables,s=e.droppables,a=e.viewport,l=e.afterCritical,c=function(e){var t=e.isMovingForward,n=e.pageBorderBoxCenter,i=e.source,r=e.droppables,o=e.viewport,s=i.subject.active;if(!s)return null;var a=i.axis,l=ud(s[a.start],s[a.end]),c=td(r).filter(function(e){return e!==i}).filter(function(e){return e.isEnabled}).filter(function(e){return Boolean(e.subject.active)}).filter(function(e){return md(o.frame)(Ld(e))}).filter(function(e){var n=Ld(e);return t?s[a.crossAxisEnd]<n[a.crossAxisEnd]:n[a.crossAxisStart]<s[a.crossAxisStart]}).filter(function(e){var t=Ld(e),n=ud(t[a.start],t[a.end]);return l(t[a.start])||l(t[a.end])||n(s[a.start])||n(s[a.end])}).sort(function(e,n){var i=Ld(e)[a.crossAxisStart],r=Ld(n)[a.crossAxisStart];return t?i-r:r-i}).filter(function(e,t,n){return Ld(e)[a.crossAxisStart]===Ld(n[0])[a.crossAxisStart]});if(!c.length)return null;if(1===c.length)return c[0];var d=c.filter(function(e){return ud(Ld(e)[a.start],Ld(e)[a.end])(n[a.line])});return 1===d.length?d[0]:d.length>1?d.sort(function(e,t){return Ld(e)[a.start]-Ld(t)[a.start]})[0]:c.sort(function(e,t){var i=zc(n,Gc(Ld(e))),r=zc(n,Gc(Ld(t)));return i!==r?i-r:Ld(e)[a.start]-Ld(t)[a.start]})[0]}({isMovingForward:t,pageBorderBoxCenter:n,source:r,droppables:s,viewport:a});if(!c)return null;var d=id(c.descriptor.id,o),u=function(e){var t=e.pageBorderBoxCenter,n=e.viewport,i=e.destination,r=e.insideDestination,o=e.afterCritical,s=r.filter(function(e){return _d({target:Bd(e,o),destination:i,viewport:n.frame,withDroppableDisplacement:!0})}).sort(function(e,n){var r=jc(t,Td(i,Ud(e,o))),s=jc(t,Td(i,Ud(n,o)));return r<s?-1:s<r?1:e.descriptor.index-n.descriptor.index});return s[0]||null}({pageBorderBoxCenter:n,viewport:a,destination:c,insideDestination:d,afterCritical:l}),m=function(e){var t=e.previousPageBorderBoxCenter,n=e.moveRelativeTo,i=e.insideDestination,r=e.draggable,o=e.draggables,s=e.destination,a=e.viewport,l=e.afterCritical;if(!n){if(i.length)return null;var c={displaced:cd,displacedBy:ld,at:{type:"REORDER",destination:{droppableId:s.descriptor.id,index:0}}},d=Pd({impact:c,draggable:r,droppable:s,draggables:o,afterCritical:l}),u=ad(r,s)?s:zd(s,r,o);return Od({draggable:r,destination:u,newPageBorderBoxCenter:d,viewport:a.frame,withDroppableDisplacement:!1,onlyOnMainAxis:!0})?c:null}var m,h=Boolean(t[s.axis.line]<=n.page.borderBox.center[s.axis.line]),p=(m=n.descriptor.index,n.descriptor.id===r.descriptor.id||h?m:m+1),g=Vd(s.axis,r.displaceBy);return Ed({draggable:r,insideDestination:i,destination:s,viewport:a,displacedBy:g,last:cd,index:p})}({previousPageBorderBoxCenter:n,destination:c,draggable:i,draggables:o,moveRelativeTo:u,insideDestination:d,viewport:a,afterCritical:l});if(!m)return null;var h=Pd({impact:m,draggable:i,droppable:c,draggables:o,afterCritical:l});return{clientSelection:Md({pageBorderBoxCenter:h,draggable:i,viewport:a}),impact:m,scrollJumpRequest:null}},Wd=function(e){var t=e.at;return t?"REORDER"===t.type?t.destination.droppableId:t.combine.droppableId:null},Gd=function(e){var t=e.state,n=e.type,i=function(e,t){var n=Wd(e);return n?t[n]:null}(t.impact,t.dimensions.droppables),r=Boolean(i),o=t.dimensions.droppables[t.critical.droppable.id],s=i||o,a=s.axis.direction,l="vertical"===a&&("MOVE_UP"===n||"MOVE_DOWN"===n)||"horizontal"===a&&("MOVE_LEFT"===n||"MOVE_RIGHT"===n);if(l&&!r)return null;var c="MOVE_DOWN"===n||"MOVE_RIGHT"===n,d=t.dimensions.draggables[t.critical.draggable.id],u=t.current.page.borderBoxCenter,m=t.dimensions,h=m.draggables,p=m.droppables;return l?Fd({isMovingForward:c,previousPageBorderBoxCenter:u,draggable:d,destination:s,draggables:h,viewport:t.viewport,previousClientSelection:t.current.client.selection,previousImpact:t.impact,afterCritical:t.afterCritical}):Hd({isMovingForward:c,previousPageBorderBoxCenter:u,draggable:d,isOver:s,draggables:h,droppables:p,viewport:t.viewport,afterCritical:t.afterCritical})};function Kd(e){return"DRAGGING"===e.phase||"COLLECTING"===e.phase}function qd(e){var t=ud(e.top,e.bottom),n=ud(e.left,e.right);return function(e){return t(e.y)&&n(e.x)}}function $d(e){var t=e.pageBorderBox,n=e.draggable,i=e.droppables,r=td(i).filter(function(e){if(!e.isEnabled)return!1;var n,i,r=e.subject.active;if(!r)return!1;if(i=r,!((n=t).left<i.right&&n.right>i.left&&n.top<i.bottom&&n.bottom>i.top))return!1;if(qd(r)(t.center))return!0;var o=e.axis,s=r.center[o.crossAxisLine],a=t[o.crossAxisStart],l=t[o.crossAxisEnd],c=ud(r[o.crossAxisStart],r[o.crossAxisEnd]),d=c(a),u=c(l);return!d&&!u||(d?a<s:l>s)});return r.length?1===r.length?r[0].descriptor.id:function(e){var t=e.pageBorderBox,n=e.draggable,i=e.candidates,r=n.page.borderBox.center,o=i.map(function(e){var n=e.axis,i=Vc(e.axis.line,t.center[n.line],e.page.borderBox.center[n.crossAxisLine]);return{id:e.descriptor.id,distance:jc(r,i)}}).sort(function(e,t){return t.distance-e.distance});return o[0]?o[0].id:null}({pageBorderBox:t,draggable:n,candidates:r}):null}var Jd=function(e,t){return oc(Wc(e,t))};function Yd(e){var t=e.displaced,n=e.id;return Boolean(t.visible[n]||t.invisible[n])}var Xd=function(e){var t=e.pageOffset,n=e.draggable,i=e.draggables,r=e.droppables,o=e.previousImpact,s=e.viewport,a=e.afterCritical,l=Jd(n.page.borderBox,t),c=$d({pageBorderBox:l,draggable:n,droppables:r});if(!c)return dd;var d=r[c],u=id(d.descriptor.id,i),m=function(e,t){var n=e.frame;return n?Jd(t,n.scroll.diff.value):t}(d,l);return function(e){var t=e.draggable,n=e.pageBorderBoxWithDroppableScroll,i=e.previousImpact,r=e.destination,o=e.insideDestination,s=e.afterCritical;if(!r.isCombineEnabled)return null;var a=r.axis,l=Vd(r.axis,t.displaceBy),c=l.value,d=n[a.start],u=n[a.end],m=Xc(sd(t,o),function(e){var t=e.descriptor.id,n=e.page.borderBox,r=n[a.size]/4,o=wd(t,s),l=Yd({displaced:i.displaced,id:t});return o?l?u>n[a.start]+r&&u<n[a.end]-r:d>n[a.start]-c+r&&d<n[a.end]-c-r:l?u>n[a.start]+c+r&&u<n[a.end]+c-r:d>n[a.start]+r&&d<n[a.end]-r});return m?{displacedBy:l,displaced:i.displaced,at:{type:"COMBINE",combine:{draggableId:m.descriptor.id,droppableId:r.descriptor.id}}}:null}({pageBorderBoxWithDroppableScroll:m,draggable:n,previousImpact:o,destination:d,insideDestination:u,afterCritical:a})||function(e){var t=e.pageBorderBoxWithDroppableScroll,n=e.draggable,i=e.destination,r=e.insideDestination,o=e.last,s=e.viewport,a=e.afterCritical,l=i.axis,c=Vd(i.axis,n.displaceBy),d=c.value,u=t[l.start],m=t[l.end],h=function(e){var t=e.draggable,n=e.closest,i=e.inHomeList;return n?i&&n.descriptor.index>t.descriptor.index?n.descriptor.index-1:n.descriptor.index:null}({draggable:n,closest:Xc(sd(n,r),function(e){var t=e.descriptor.id,n=e.page.borderBox.center[l.line],i=wd(t,a),r=Yd({displaced:o,id:t});return i?r?m<=n:u<n-d:r?m<=n+d:u<n}),inHomeList:ad(n,i)});return Ed({draggable:n,insideDestination:r,destination:i,viewport:s,last:o,displacedBy:c,index:h})}({pageBorderBoxWithDroppableScroll:m,draggable:n,destination:d,insideDestination:u,last:o.displaced,viewport:s,afterCritical:a})},Qd=function(e,t){var n;return(0,tn.A)({},e,((n={})[t.descriptor.id]=t,n))},Zd=function(e){var t=e.previousImpact,n=e.impact,i=e.droppables,r=Wd(t),o=Wd(n);if(!r)return i;if(r===o)return i;var s=i[r];if(!s.subject.withPlaceholder)return i;var a=function(e){var t=e.subject.withPlaceholder;t||Ac(!1);var n=e.frame;if(!n){var i=qc({page:e.subject.page,axis:e.axis,frame:null,withPlaceholder:null});return(0,tn.A)({},e,{subject:i})}var r=t.oldFrameMaxScroll;r||Ac(!1);var o=jd(n,r),s=qc({page:e.subject.page,axis:e.axis,frame:o,withPlaceholder:null});return(0,tn.A)({},e,{subject:s,frame:o})}(s);return Qd(i,a)},eu=function(e){var t=e.state,n=e.clientSelection,i=e.dimensions,r=e.viewport,o=e.impact,s=e.scrollJumpRequest,a=r||t.viewport,l=i||t.dimensions,c=n||t.current.client.selection,d=Lc(c,t.initial.client.selection),u={offset:d,selection:c,borderBoxCenter:Fc(t.initial.client.borderBoxCenter,d)},m={selection:Fc(u.selection,a.scroll.current),borderBoxCenter:Fc(u.borderBoxCenter,a.scroll.current),offset:Fc(u.offset,a.scroll.diff.value)},h={client:u,page:m};if("COLLECTING"===t.phase)return(0,tn.A)({phase:"COLLECTING"},t,{dimensions:l,viewport:a,current:h});var p=l.draggables[t.critical.draggable.id],g=o||Xd({pageOffset:m.offset,draggable:p,draggables:l.draggables,droppables:l.droppables,previousImpact:t.impact,viewport:a,afterCritical:t.afterCritical}),v=function(e){var t=e.draggable,n=e.draggables,i=e.droppables,r=e.previousImpact,o=e.impact,s=Zd({previousImpact:r,impact:o,droppables:i}),a=Wd(o);if(!a)return s;var l=i[a];if(ad(t,l))return s;if(l.subject.withPlaceholder)return s;var c=zd(l,t,n);return Qd(s,c)}({draggable:p,impact:g,previousImpact:t.impact,draggables:l.draggables,droppables:l.droppables});return(0,tn.A)({},t,{current:h,dimensions:{draggables:l.draggables,droppables:v},impact:g,viewport:a,scrollJumpRequest:s||null,forceShouldAnimate:!s&&null})};var tu=function(e){var t=e.impact,n=e.viewport,i=e.draggables,r=e.destination,o=e.forceShouldAnimate,s=t.displaced,a=function(e,t){return e.map(function(e){return t[e]})}(s.all,i),l=yd({afterDragging:a,destination:r,displacedBy:t.displacedBy,viewport:n.frame,forceShouldAnimate:o,last:s});return(0,tn.A)({},t,{displaced:l})},nu=function(e){var t=e.impact,n=e.draggable,i=e.droppable,r=e.draggables,o=e.viewport,s=e.afterCritical,a=Pd({impact:t,draggable:n,draggables:r,droppable:i,afterCritical:s});return Md({pageBorderBoxCenter:a,draggable:n,viewport:o})},iu=function(e){var t=e.state,n=e.dimensions,i=e.viewport;"SNAP"!==t.movementMode&&Ac(!1);var r=t.impact,o=i||t.viewport,s=n||t.dimensions,a=s.draggables,l=s.droppables,c=a[t.critical.draggable.id],d=Wd(r);d||Ac(!1);var u=l[d],m=tu({impact:r,viewport:o,destination:u,draggables:a}),h=nu({impact:m,draggable:c,droppable:u,draggables:a,viewport:o,afterCritical:t.afterCritical});return eu({impact:m,clientSelection:h,state:t,dimensions:s,viewport:o})},ru=function(e){var t=e.draggable,n=e.home,i=e.draggables,r=e.viewport,o=Vd(n.axis,t.displaceBy),s=id(n.descriptor.id,i),a=s.indexOf(t);-1===a&&Ac(!1);var l,c=s.slice(a+1),d=c.reduce(function(e,t){return e[t.descriptor.id]=!0,e},{}),u={inVirtualList:"virtual"===n.descriptor.mode,displacedBy:o,effected:d};return{impact:{displaced:yd({afterDragging:c,destination:n,displacedBy:o,last:null,viewport:r.frame,forceShouldAnimate:!1}),displacedBy:o,at:{type:"REORDER",destination:(l=t.descriptor,{index:l.index,droppableId:l.droppableId})}},afterCritical:u}},ou=function(e){0},su=function(e){0},au=function(e){var t=e.additions,n=e.updatedDroppables,i=e.viewport,r=i.scroll.diff.value;return t.map(function(e){var t=e.descriptor.droppableId,o=function(e){var t=e.frame;return t||Ac(!1),t}(n[t]),s=o.scroll.diff.value,a=function(e){var t=e.draggable,n=e.offset,i=e.initialWindowScroll,r=uc(t.client,n),o=mc(r,i);return(0,tn.A)({},t,{placeholder:(0,tn.A)({},t.placeholder,{client:r}),client:r,page:o})}({draggable:e,offset:Fc(r,s),initialWindowScroll:i.scroll.initial});return a})},lu=function(e){return"SNAP"===e.movementMode},cu=function(e,t,n){var i=function(e,t){return{draggables:e.draggables,droppables:Qd(e.droppables,t)}}(e.dimensions,t);return!lu(e)||n?eu({state:e,dimensions:i}):iu({state:e,dimensions:i})};function du(e){return e.isDragging&&"SNAP"===e.movementMode?(0,tn.A)({phase:"DRAGGING"},e,{scrollJumpRequest:null}):e}var uu={phase:"IDLE",completed:null,shouldFlush:!1},mu=function(e,t){if(void 0===e&&(e=uu),"FLUSH"===t.type)return(0,tn.A)({},uu,{shouldFlush:!0});if("INITIAL_PUBLISH"===t.type){"IDLE"!==e.phase&&Ac(!1);var n=t.payload,i=n.critical,r=n.clientSelection,o=n.viewport,s=n.dimensions,a=n.movementMode,l=s.draggables[i.draggable.id],c=s.droppables[i.droppable.id],d={selection:r,borderBoxCenter:l.client.borderBox.center,offset:Oc},u={client:d,page:{selection:Fc(d.selection,o.scroll.initial),borderBoxCenter:Fc(d.selection,o.scroll.initial),offset:Fc(d.selection,o.scroll.diff.value)}},m=td(s.droppables).every(function(e){return!e.isFixedOnPage}),h=ru({draggable:l,home:c,draggables:s.draggables,viewport:o}),p=h.impact;return{phase:"DRAGGING",isDragging:!0,critical:i,movementMode:a,dimensions:s,initial:u,current:u,isWindowScrollAllowed:m,impact:p,afterCritical:h.afterCritical,onLiftImpact:p,viewport:o,scrollJumpRequest:null,forceShouldAnimate:null}}if("COLLECTION_STARTING"===t.type)return"COLLECTING"===e.phase||"DROP_PENDING"===e.phase?e:("DRAGGING"!==e.phase&&Ac(!1),(0,tn.A)({phase:"COLLECTING"},e,{phase:"COLLECTING"}));if("PUBLISH_WHILE_DRAGGING"===t.type)return"COLLECTING"!==e.phase&&"DROP_PENDING"!==e.phase&&Ac(!1),function(e){var t=e.state,n=e.published;ou();var i=n.modified.map(function(e){var n=t.dimensions.droppables[e.droppableId];return $c(n,e.scroll)}),r=(0,tn.A)({},t.dimensions.droppables,{},Zc(i)),o=ed(au({additions:n.additions,updatedDroppables:r,viewport:t.viewport})),s=(0,tn.A)({},t.dimensions.draggables,{},o);n.removals.forEach(function(e){delete s[e]});var a={droppables:r,draggables:s},l=Wd(t.impact),c=l?a.droppables[l]:null,d=a.draggables[t.critical.draggable.id],u=a.droppables[t.critical.droppable.id],m=ru({draggable:d,home:u,draggables:s,viewport:t.viewport}),h=m.impact,p=m.afterCritical,g=c&&c.isCombineEnabled?t.impact:h,v=Xd({pageOffset:t.current.page.offset,draggable:a.draggables[t.critical.draggable.id],draggables:a.draggables,droppables:a.droppables,previousImpact:g,viewport:t.viewport,afterCritical:p});su();var f=(0,tn.A)({phase:"DRAGGING"},t,{phase:"DRAGGING",impact:v,onLiftImpact:h,dimensions:a,afterCritical:p,forceShouldAnimate:!1});return"COLLECTING"===t.phase?f:(0,tn.A)({phase:"DROP_PENDING"},f,{phase:"DROP_PENDING",reason:t.reason,isWaiting:!1})}({state:e,published:t.payload});if("MOVE"===t.type){if("DROP_PENDING"===e.phase)return e;Kd(e)||Ac(!1);var g=t.payload.client;return Uc(g,e.current.client.selection)?e:eu({state:e,clientSelection:g,impact:lu(e)?e.impact:null})}if("UPDATE_DROPPABLE_SCROLL"===t.type){if("DROP_PENDING"===e.phase)return du(e);if("COLLECTING"===e.phase)return du(e);Kd(e)||Ac(!1);var v=t.payload,f=v.id,_=v.newScroll,y=e.dimensions.droppables[f];if(!y)return e;var b=$c(y,_);return cu(e,b,!1)}if("UPDATE_DROPPABLE_IS_ENABLED"===t.type){if("DROP_PENDING"===e.phase)return e;Kd(e)||Ac(!1);var E=t.payload,w=E.id,S=E.isEnabled,x=e.dimensions.droppables[w];x||Ac(!1),x.isEnabled===S&&Ac(!1);var A=(0,tn.A)({},x,{isEnabled:S});return cu(e,A,!0)}if("UPDATE_DROPPABLE_IS_COMBINE_ENABLED"===t.type){if("DROP_PENDING"===e.phase)return e;Kd(e)||Ac(!1);var C=t.payload,k=C.id,R=C.isCombineEnabled,I=e.dimensions.droppables[k];I||Ac(!1),I.isCombineEnabled===R&&Ac(!1);var T=(0,tn.A)({},I,{isCombineEnabled:R});return cu(e,T,!0)}if("MOVE_BY_WINDOW_SCROLL"===t.type){if("DROP_PENDING"===e.phase||"DROP_ANIMATING"===e.phase)return e;Kd(e)||Ac(!1),e.isWindowScrollAllowed||Ac(!1);var P=t.payload.newScroll;if(Uc(e.viewport.scroll.current,P))return du(e);var N=Nd(e.viewport,P);return lu(e)?iu({state:e,viewport:N}):eu({state:e,viewport:N})}if("UPDATE_VIEWPORT_MAX_SCROLL"===t.type){if(!Kd(e))return e;var D=t.payload.maxScroll;if(Uc(D,e.viewport.scroll.max))return e;var M=(0,tn.A)({},e.viewport,{scroll:(0,tn.A)({},e.viewport.scroll,{max:D})});return(0,tn.A)({phase:"DRAGGING"},e,{viewport:M})}if("MOVE_UP"===t.type||"MOVE_DOWN"===t.type||"MOVE_LEFT"===t.type||"MOVE_RIGHT"===t.type){if("COLLECTING"===e.phase||"DROP_PENDING"===e.phase)return e;"DRAGGING"!==e.phase&&Ac(!1);var O=Gd({state:e,type:t.type});return O?eu({state:e,impact:O.impact,clientSelection:O.clientSelection,scrollJumpRequest:O.scrollJumpRequest}):e}if("DROP_PENDING"===t.type){var F=t.payload.reason;return"COLLECTING"!==e.phase&&Ac(!1),(0,tn.A)({phase:"DROP_PENDING"},e,{phase:"DROP_PENDING",isWaiting:!0,reason:F})}if("DROP_ANIMATE"===t.type){var L=t.payload,U=L.completed,B=L.dropDuration,V=L.newHomeClientOffset;return"DRAGGING"!==e.phase&&"DROP_PENDING"!==e.phase&&Ac(!1),{phase:"DROP_ANIMATING",completed:U,dropDuration:B,newHomeClientOffset:V,dimensions:e.dimensions}}return"DROP_COMPLETE"===t.type?{phase:"IDLE",completed:t.payload.completed,shouldFlush:!1}:e},hu=function(e){return{type:"PUBLISH_WHILE_DRAGGING",payload:e}},pu=function(){return{type:"COLLECTION_STARTING",payload:null}},gu=function(e){return{type:"UPDATE_DROPPABLE_SCROLL",payload:e}},vu=function(e){return{type:"UPDATE_DROPPABLE_IS_ENABLED",payload:e}},fu=function(e){return{type:"UPDATE_DROPPABLE_IS_COMBINE_ENABLED",payload:e}},_u=function(e){return{type:"MOVE",payload:e}},yu=function(){return{type:"MOVE_UP",payload:null}},bu=function(){return{type:"MOVE_DOWN",payload:null}},Eu=function(){return{type:"MOVE_RIGHT",payload:null}},wu=function(){return{type:"MOVE_LEFT",payload:null}},Su=function(e){return{type:"DROP_COMPLETE",payload:e}},xu=function(e){return{type:"DROP",payload:e}},Au=function(){return{type:"DROP_ANIMATION_FINISHED",payload:null}};var Cu="cubic-bezier(.2,1,.1,1)",ku={drop:0,combining:.7},Ru={drop:.75},Iu=.2+"s "+"cubic-bezier(0.2, 0, 0, 1)",Tu={fluid:"opacity "+Iu,snap:"transform "+Iu+", opacity "+Iu,drop:function(e){var t=e+"s "+Cu;return"transform "+t+", opacity "+t},outOfTheWay:"transform "+Iu,placeholder:"height "+Iu+", width "+Iu+", margin "+Iu},Pu=function(e){return Uc(e,Oc)?null:"translate("+e.x+"px, "+e.y+"px)"},Nu=Pu,Du=function(e,t){var n=Pu(e);return n?t?n+" scale("+Ru.drop+")":n:null},Mu=.33,Ou=.55,Fu=Ou-Mu,Lu=function(e){var t=e.getState,n=e.dispatch;return function(e){return function(i){if("DROP"===i.type){var r=t(),o=i.payload.reason;if("COLLECTING"!==r.phase){if("IDLE"!==r.phase){"DROP_PENDING"===r.phase&&r.isWaiting&&Ac(!1),"DRAGGING"!==r.phase&&"DROP_PENDING"!==r.phase&&Ac(!1);var s=r.critical,a=r.dimensions,l=a.draggables[r.critical.draggable.id],c=function(e){var t=e.draggables,n=e.reason,i=e.lastImpact,r=e.home,o=e.viewport,s=e.onLiftImpact;return i.at&&"DROP"===n?"REORDER"===i.at.type?{impact:i,didDropInsideDroppable:!0}:{impact:(0,tn.A)({},i,{displaced:cd}),didDropInsideDroppable:!0}:{impact:tu({draggables:t,impact:s,destination:r,viewport:o,forceShouldAnimate:!0}),didDropInsideDroppable:!1}}({reason:o,lastImpact:r.impact,afterCritical:r.afterCritical,onLiftImpact:r.onLiftImpact,home:r.dimensions.droppables[r.critical.droppable.id],viewport:r.viewport,draggables:r.dimensions.draggables}),d=c.impact,u=c.didDropInsideDroppable,m=u?rd(d):null,h=u?od(d):null,p={index:s.draggable.index,droppableId:s.droppable.id},g={draggableId:l.descriptor.id,type:l.descriptor.type,source:p,reason:o,mode:r.movementMode,destination:m,combine:h},v=function(e){var t=e.impact,n=e.draggable,i=e.dimensions,r=e.viewport,o=e.afterCritical,s=i.draggables,a=i.droppables,l=Wd(t),c=l?a[l]:null,d=a[n.descriptor.droppableId],u=nu({impact:t,draggable:n,draggables:s,afterCritical:o,droppable:c||d,viewport:r});return Lc(u,n.client.borderBox.center)}({impact:d,draggable:l,dimensions:a,viewport:r.viewport,afterCritical:r.afterCritical}),f={critical:r.critical,afterCritical:r.afterCritical,result:g,impact:d};if(!Uc(r.current.client.offset,v)||Boolean(g.combine)){var _=function(e){var t=e.current,n=e.destination,i=e.reason,r=jc(t,n);if(r<=0)return Mu;if(r>=1500)return Ou;var o=Mu+Fu*(r/1500);return Number(("CANCEL"===i?.6*o:o).toFixed(2))}({current:r.current.client.offset,destination:v,reason:o});n(function(e){return{type:"DROP_ANIMATE",payload:e}}({newHomeClientOffset:v,dropDuration:_,completed:f}))}else n(Su({completed:f}))}}else n(function(e){return{type:"DROP_PENDING",payload:e}}({reason:o}))}else e(i)}}},Uu=function(){return{x:window.pageXOffset,y:window.pageYOffset}};function Bu(e){var t=e.onWindowScroll;var n=yc(function(){t(Uu())}),i=function(e){return{eventName:"scroll",options:{passive:!0,capture:!1},fn:function(t){t.target!==window&&t.target!==window.document||e()}}}(n),r=Ec;function o(){return r!==Ec}return{start:function(){o()&&Ac(!1),r=wc(window,[i])},stop:function(){o()||Ac(!1),n.cancel(),r(),r=Ec},isActive:o}}var Vu=function(e){var t=Bu({onWindowScroll:function(t){e.dispatch({type:"MOVE_BY_WINDOW_SCROLL",payload:{newScroll:t}})}});return function(e){return function(n){t.isActive()||"INITIAL_PUBLISH"!==n.type||t.start(),t.isActive()&&function(e){return"DROP_COMPLETE"===e.type||"DROP_ANIMATE"===e.type||"FLUSH"===e.type}(n)&&t.stop(),e(n)}}},ju=function(){var e=[];return{add:function(t){var n=setTimeout(function(){return function(t){var n=Yc(e,function(e){return e.timerId===t});-1===n&&Ac(!1),e.splice(n,1)[0].callback()}(n)}),i={timerId:n,callback:t};e.push(i)},flush:function(){if(e.length){var t=[].concat(e);e.length=0,t.forEach(function(e){clearTimeout(e.timerId),e.callback()})}}}},zu=function(e,t){ou(),t(),su()},Hu=function(e,t){return{draggableId:e.draggable.id,type:e.droppable.type,source:{droppableId:e.droppable.id,index:e.draggable.index},mode:t}},Wu=function(e,t,n,i){if(e){var r=function(e){var t=!1,n=!1,i=setTimeout(function(){n=!0}),r=function(r){t||n||(t=!0,e(r),clearTimeout(i))};return r.wasCalled=function(){return t},r}(n);e(t,{announce:r}),r.wasCalled()||n(i(t))}else n(i(t))},Gu=function(e,t){var n=function(e,t){var n=ju(),i=null,r=function(n){i||Ac(!1),i=null,zu(0,function(){return Wu(e().onDragEnd,n,t,Mc)})};return{beforeCapture:function(t,n){i&&Ac(!1),zu(0,function(){var i=e().onBeforeCapture;i&&i({draggableId:t,mode:n})})},beforeStart:function(t,n){i&&Ac(!1),zu(0,function(){var i=e().onBeforeDragStart;i&&i(Hu(t,n))})},start:function(r,o){i&&Ac(!1);var s=Hu(r,o);i={mode:o,lastCritical:r,lastLocation:s.source,lastCombine:null},n.add(function(){zu(0,function(){return Wu(e().onDragStart,s,t,Nc)})})},update:function(r,o){var s=rd(o),a=od(o);i||Ac(!1);var l=!function(e,t){if(e===t)return!0;var n=e.draggable.id===t.draggable.id&&e.draggable.droppableId===t.draggable.droppableId&&e.draggable.type===t.draggable.type&&e.draggable.index===t.draggable.index,i=e.droppable.id===t.droppable.id&&e.droppable.type===t.droppable.type;return n&&i}(r,i.lastCritical);l&&(i.lastCritical=r);var c,d,u=(d=s,!(null==(c=i.lastLocation)&&null==d||null!=c&&null!=d&&c.droppableId===d.droppableId&&c.index===d.index));u&&(i.lastLocation=s);var m=!function(e,t){return null==e&&null==t||null!=e&&null!=t&&e.draggableId===t.draggableId&&e.droppableId===t.droppableId}(i.lastCombine,a);if(m&&(i.lastCombine=a),l||u||m){var h=(0,tn.A)({},Hu(r,i.mode),{combine:a,destination:s});n.add(function(){zu(0,function(){return Wu(e().onDragUpdate,h,t,Dc)})})}},flush:function(){i||Ac(!1),n.flush()},drop:r,abort:function(){if(i){var e=(0,tn.A)({},Hu(i.lastCritical,i.mode),{combine:null,destination:null,reason:"CANCEL"});r(e)}}}}(e,t);return function(e){return function(t){return function(i){if("BEFORE_INITIAL_CAPTURE"!==i.type){if("INITIAL_PUBLISH"===i.type){var r=i.payload.critical;return n.beforeStart(r,i.payload.movementMode),t(i),void n.start(r,i.payload.movementMode)}if("DROP_COMPLETE"===i.type){var o=i.payload.completed.result;return n.flush(),t(i),void n.drop(o)}if(t(i),"FLUSH"!==i.type){var s=e.getState();"DRAGGING"===s.phase&&n.update(s.critical,s.impact)}else n.abort()}else n.beforeCapture(i.payload.draggableId,i.payload.movementMode)}}}},Ku=function(e){return function(t){return function(n){if("DROP_ANIMATION_FINISHED"===n.type){var i=e.getState();"DROP_ANIMATING"!==i.phase&&Ac(!1),e.dispatch(Su({completed:i.completed}))}else t(n)}}},qu=function(e){var t=null,n=null;return function(i){return function(r){if("FLUSH"!==r.type&&"DROP_COMPLETE"!==r.type&&"DROP_ANIMATION_FINISHED"!==r.type||(n&&(cancelAnimationFrame(n),n=null),t&&(t(),t=null)),i(r),"DROP_ANIMATE"===r.type){var o={eventName:"scroll",options:{capture:!0,passive:!1,once:!0},fn:function(){"DROP_ANIMATING"===e.getState().phase&&e.dispatch({type:"DROP_ANIMATION_FINISHED",payload:null})}};n=requestAnimationFrame(function(){n=null,t=wc(window,[o])})}}}},$u=function(e){return function(t){return function(n){if(t(n),"PUBLISH_WHILE_DRAGGING"===n.type){var i=e.getState();"DROP_PENDING"===i.phase&&(i.isWaiting||e.dispatch(xu({reason:i.reason})))}}}},Ju=hl,Yu=function(e){var t,n=e.dimensionMarshal,i=e.focusMarshal,r=e.styleMarshal,o=e.getResponders,s=e.announce,a=e.autoScroller;return dl(mu,Ju(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return function(){var n=e.apply(void 0,arguments),i=function(){throw new Error(ol(15))},r={getState:n.getState,dispatch:function(){return i.apply(void 0,arguments)}},o=t.map(function(e){return e(r)});return i=hl.apply(void 0,o)(n.dispatch),rl(rl({},n),{},{dispatch:i})}}}((t=r,function(){return function(e){return function(n){"INITIAL_PUBLISH"===n.type&&t.dragging(),"DROP_ANIMATE"===n.type&&t.dropping(n.payload.completed.result.reason),"FLUSH"!==n.type&&"DROP_COMPLETE"!==n.type||t.resting(),e(n)}}}),function(e){return function(){return function(t){return function(n){"DROP_COMPLETE"!==n.type&&"FLUSH"!==n.type&&"DROP_ANIMATE"!==n.type||e.stopPublishing(),t(n)}}}}(n),function(e){return function(t){var n=t.getState,i=t.dispatch;return function(t){return function(r){if("LIFT"===r.type){var o=r.payload,s=o.id,a=o.clientSelection,l=o.movementMode,c=n();"DROP_ANIMATING"===c.phase&&i(Su({completed:c.completed})),"IDLE"!==n().phase&&Ac(!1),i({type:"FLUSH",payload:null}),i({type:"BEFORE_INITIAL_CAPTURE",payload:{draggableId:s,movementMode:l}});var d={draggableId:s,scrollOptions:{shouldPublishImmediately:"SNAP"===l}},u=e.startPublishing(d),m=u.critical,h=u.dimensions,p=u.viewport;i({type:"INITIAL_PUBLISH",payload:{critical:m,dimensions:h,clientSelection:a,movementMode:l,viewport:p}})}else t(r)}}}}(n),Lu,Ku,qu,$u,function(e){return function(t){return function(n){return function(i){if(function(e){return"DROP_COMPLETE"===e.type||"DROP_ANIMATE"===e.type||"FLUSH"===e.type}(i))return e.stop(),void n(i);if("INITIAL_PUBLISH"===i.type){n(i);var r=t.getState();return"DRAGGING"!==r.phase&&Ac(!1),void e.start(r)}n(i),e.scroll(t.getState())}}}}(a),Vu,function(e){var t=!1;return function(){return function(n){return function(i){if("INITIAL_PUBLISH"===i.type)return t=!0,e.tryRecordFocus(i.payload.critical.draggable.id),n(i),void e.tryRestoreFocusRecorded();if(n(i),t){if("FLUSH"===i.type)return t=!1,void e.tryRestoreFocusRecorded();if("DROP_COMPLETE"===i.type){t=!1;var r=i.payload.completed.result;r.combine&&e.tryShiftRecord(r.draggableId,r.combine.draggableId),e.tryRestoreFocusRecorded()}}}}}}(i),Gu(o,s))))};var Xu=function(e){var t=e.scrollHeight,n=e.scrollWidth,i=e.height,r=e.width,o=Lc({x:n,y:t},{x:r,y:i});return{x:Math.max(0,o.x),y:Math.max(0,o.y)}},Qu=function(){var e=document.documentElement;return e||Ac(!1),e},Zu=function(){var e=Qu();return Xu({scrollHeight:e.scrollHeight,scrollWidth:e.scrollWidth,width:e.clientWidth,height:e.clientHeight})},em=function(e){var t=e.critical,n=e.scrollOptions,i=e.registry;ou();var r,o,s,a,l,c,d,u=(r=Uu(),o=Zu(),s=r.y,a=r.x,l=Qu(),c=l.clientWidth,d=l.clientHeight,{frame:oc({top:s,left:a,right:a+c,bottom:s+d}),scroll:{initial:r,current:r,max:o,diff:{value:Oc,displacement:Oc}}}),m=u.scroll.current,h=t.droppable,p=i.droppable.getAllByType(h.type).map(function(e){return e.callbacks.getDimensionAndWatchScroll(m,n)}),g=i.draggable.getAllByType(t.draggable.type).map(function(e){return e.getDimension(m)}),v={draggables:ed(g),droppables:Zc(p)};return su(),{dimensions:v,critical:t,viewport:u}};function tm(e,t,n){return n.descriptor.id!==t.id&&(n.descriptor.type===t.type&&"virtual"===e.droppable.getById(n.descriptor.droppableId).descriptor.mode)}var nm,im,rm=function(e,t){var n=null,i=function(e){var t=e.registry,n=e.callbacks,i={additions:{},removals:{},modified:{}},r=null,o=function(){r||(n.collectionStarting(),r=requestAnimationFrame(function(){r=null,ou();var e=i,o=e.additions,s=e.removals,a=e.modified,l=Object.keys(o).map(function(e){return t.draggable.getById(e).getDimension(Oc)}).sort(function(e,t){return e.descriptor.index-t.descriptor.index}),c=Object.keys(a).map(function(e){return{droppableId:e,scroll:t.droppable.getById(e).callbacks.getScrollWhileDragging()}}),d={additions:l,removals:Object.keys(s),modified:c};i={additions:{},removals:{},modified:{}},su(),n.publish(d)}))};return{add:function(e){var t=e.descriptor.id;i.additions[t]=e,i.modified[e.descriptor.droppableId]=!0,i.removals[t]&&delete i.removals[t],o()},remove:function(e){var t=e.descriptor;i.removals[t.id]=!0,i.modified[t.droppableId]=!0,i.additions[t.id]&&delete i.additions[t.id],o()},stop:function(){r&&(cancelAnimationFrame(r),r=null,i={additions:{},removals:{},modified:{}})}}}({callbacks:{publish:t.publishWhileDragging,collectionStarting:t.collectionStarting},registry:e}),r=function(t){n||Ac(!1);var r=n.critical.draggable;"ADDITION"===t.type&&tm(e,r,t.value)&&i.add(t.value),"REMOVAL"===t.type&&tm(e,r,t.value)&&i.remove(t.value)},o={updateDroppableIsEnabled:function(i,r){e.droppable.exists(i)||Ac(!1),n&&t.updateDroppableIsEnabled({id:i,isEnabled:r})},updateDroppableIsCombineEnabled:function(i,r){n&&(e.droppable.exists(i)||Ac(!1),t.updateDroppableIsCombineEnabled({id:i,isCombineEnabled:r}))},scrollDroppable:function(t,i){n&&e.droppable.getById(t).callbacks.scroll(i)},updateDroppableScroll:function(i,r){n&&(e.droppable.exists(i)||Ac(!1),t.updateDroppableScroll({id:i,newScroll:r}))},startPublishing:function(t){n&&Ac(!1);var i=e.draggable.getById(t.draggableId),o=e.droppable.getById(i.descriptor.droppableId),s={draggable:i.descriptor,droppable:o.descriptor},a=e.subscribe(r);return n={critical:s,unsubscribe:a},em({critical:s,registry:e,scrollOptions:t.scrollOptions})},stopPublishing:function(){if(n){i.stop();var t=n.critical.droppable;e.droppable.getAllByType(t.type).forEach(function(e){return e.callbacks.dragStopped()}),n.unsubscribe(),n=null}}};return o},om=function(e,t){return"IDLE"===e.phase||"DROP_ANIMATING"===e.phase&&(e.completed.result.draggableId!==t&&"DROP"===e.completed.result.reason)},sm=function(e){window.scrollBy(e.x,e.y)},am=_c(function(e){return td(e).filter(function(e){return!!e.isEnabled&&!!e.frame})}),lm=function(e){var t=e.center,n=e.destination,i=e.droppables;if(n){var r=i[n];return r.frame?r:null}var o=function(e,t){var n=Xc(am(t),function(t){return t.frame||Ac(!1),qd(t.frame.pageMarginBox)(e)});return n}(t,i);return o},cm=.25,dm=.05,um=28,mm=function(e){return Math.pow(e,2)},hm={stopDampeningAt:1200,accelerateAt:360},pm=function(e){var t=e.startOfRange,n=e.endOfRange,i=e.current,r=n-t;return 0===r?0:(i-t)/r},gm=hm.accelerateAt,vm=hm.stopDampeningAt,fm=function(e){var t=e.distanceToEdge,n=e.thresholds,i=e.dragStartTime,r=e.shouldUseTimeDampening,o=function(e,t){if(e>t.startScrollingFrom)return 0;if(e<=t.maxScrollValueAt)return um;if(e===t.startScrollingFrom)return 1;var n=pm({startOfRange:t.maxScrollValueAt,endOfRange:t.startScrollingFrom,current:e}),i=um*mm(1-n);return Math.ceil(i)}(t,n);return 0===o?0:r?Math.max(function(e,t){var n=t,i=vm,r=Date.now()-n;if(r>=vm)return e;if(r<gm)return 1;var o=pm({startOfRange:gm,endOfRange:i,current:r}),s=e*mm(o);return Math.ceil(s)}(o,i),1):o},_m=function(e){var t=e.container,n=e.distanceToEdges,i=e.dragStartTime,r=e.axis,o=e.shouldUseTimeDampening,s=function(e,t){return{startScrollingFrom:e[t.size]*cm,maxScrollValueAt:e[t.size]*dm}}(t,r);return n[r.end]<n[r.start]?fm({distanceToEdge:n[r.end],thresholds:s,dragStartTime:i,shouldUseTimeDampening:o}):-1*fm({distanceToEdge:n[r.start],thresholds:s,dragStartTime:i,shouldUseTimeDampening:o})},ym=Hc(function(e){return 0===e?0:e}),bm=function(e){var t=e.dragStartTime,n=e.container,i=e.subject,r=e.center,o=e.shouldUseTimeDampening,s={top:r.y-n.top,right:n.right-r.x,bottom:n.bottom-r.y,left:r.x-n.left},a=_m({container:n,distanceToEdges:s,dragStartTime:t,axis:pd,shouldUseTimeDampening:o}),l=_m({container:n,distanceToEdges:s,dragStartTime:t,axis:gd,shouldUseTimeDampening:o}),c=ym({x:l,y:a});if(Uc(c,Oc))return null;var d=function(e){var t=e.container,n=e.subject,i=e.proposedScroll,r=n.height>t.height,o=n.width>t.width;return o||r?o&&r?null:{x:o?0:i.x,y:r?0:i.y}:i}({container:n,subject:i,proposedScroll:c});return d?Uc(d,Oc)?null:d:null},Em=Hc(function(e){return 0===e?0:e>0?1:-1}),wm=(nm=function(e,t){return e<0?e:e>t?e-t:0},function(e){var t=e.current,n=e.max,i=e.change,r=Fc(t,i),o={x:nm(r.x,n.x),y:nm(r.y,n.y)};return Uc(o,Oc)?null:o}),Sm=function(e){var t=e.max,n=e.current,i=e.change,r={x:Math.max(n.x,t.x),y:Math.max(n.y,t.y)},o=Em(i),s=wm({max:r,current:n,change:o});return!s||(0!==o.x&&0===s.x||0!==o.y&&0===s.y)},xm=function(e,t){return Sm({current:e.scroll.current,max:e.scroll.max,change:t})},Am=function(e,t){var n=e.frame;return!!n&&Sm({current:n.scroll.current,max:n.scroll.max,change:t})},Cm=function(e){var t=e.state,n=e.dragStartTime,i=e.shouldUseTimeDampening,r=e.scrollWindow,o=e.scrollDroppable,s=t.current.page.borderBoxCenter,a=t.dimensions.draggables[t.critical.draggable.id].page.marginBox;if(t.isWindowScrollAllowed){var l=function(e){var t=e.viewport,n=e.subject,i=e.center,r=e.dragStartTime,o=e.shouldUseTimeDampening,s=bm({dragStartTime:r,container:t.frame,subject:n,center:i,shouldUseTimeDampening:o});return s&&xm(t,s)?s:null}({dragStartTime:n,viewport:t.viewport,subject:a,center:s,shouldUseTimeDampening:i});if(l)return void r(l)}var c=lm({center:s,destination:Wd(t.impact),droppables:t.dimensions.droppables});if(c){var d=function(e){var t=e.droppable,n=e.subject,i=e.center,r=e.dragStartTime,o=e.shouldUseTimeDampening,s=t.frame;if(!s)return null;var a=bm({dragStartTime:r,container:s.pageMarginBox,subject:n,center:i,shouldUseTimeDampening:o});return a&&Am(t,a)?a:null}({dragStartTime:n,droppable:c,subject:a,center:s,shouldUseTimeDampening:i});d&&o(c.descriptor.id,d)}},km=function(e){var t=e.move,n=e.scrollDroppable,i=e.scrollWindow,r=function(e,t){if(!Am(e,t))return t;var i=function(e,t){var n=e.frame;return n&&Am(e,t)?wm({current:n.scroll.current,max:n.scroll.max,change:t}):null}(e,t);if(!i)return n(e.descriptor.id,t),null;var r=Lc(t,i);return n(e.descriptor.id,r),Lc(t,r)},o=function(e,t,n){if(!e)return n;if(!xm(t,n))return n;var r=function(e,t){if(!xm(e,t))return null;var n=e.scroll.max,i=e.scroll.current;return wm({current:i,max:n,change:t})}(t,n);if(!r)return i(n),null;var o=Lc(n,r);return i(o),Lc(n,o)};return function(e){var n=e.scrollJumpRequest;if(n){var i=Wd(e.impact);i||Ac(!1);var s=r(e.dimensions.droppables[i],n);if(s){var a=e.viewport,l=o(e.isWindowScrollAllowed,a,s);l&&function(e,n){var i=Fc(e.current.client.selection,n);t({client:i})}(e,l)}}}},Rm=function(e){var t=e.scrollDroppable,n=e.scrollWindow,i=e.move,r=function(e){var t=e.scrollWindow,n=e.scrollDroppable,i=yc(t),r=yc(n),o=null,s=function(e){o||Ac(!1);var t=o,n=t.shouldUseTimeDampening,s=t.dragStartTime;Cm({state:e,scrollWindow:i,scrollDroppable:r,dragStartTime:s,shouldUseTimeDampening:n})};return{start:function(e){ou(),o&&Ac(!1);var t=Date.now(),n=!1,i=function(){n=!0};Cm({state:e,dragStartTime:0,shouldUseTimeDampening:!1,scrollWindow:i,scrollDroppable:i}),o={dragStartTime:t,shouldUseTimeDampening:n},su(),n&&s(e)},stop:function(){o&&(i.cancel(),r.cancel(),o=null)},scroll:s}}({scrollWindow:n,scrollDroppable:t}),o=km({move:i,scrollWindow:n,scrollDroppable:t});return{scroll:function(e){"DRAGGING"===e.phase&&("FLUID"!==e.movementMode?e.scrollJumpRequest&&o(e):r.scroll(e))},start:r.start,stop:r.stop}},Im="data-rbd",Tm={base:im=Im+"-drag-handle",draggableId:im+"-draggable-id",contextId:im+"-context-id"},Pm=function(){var e=Im+"-draggable";return{base:e,contextId:e+"-context-id",id:e+"-id"}}(),Nm=function(){var e=Im+"-droppable";return{base:e,contextId:e+"-context-id",id:e+"-id"}}(),Dm={contextId:Im+"-scroll-container-context-id"},Mm=function(e,t){return e.map(function(e){var n=e.styles[t];return n?e.selector+" { "+n+" }":""}).join(" ")},Om="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement?o.useLayoutEffect:o.useEffect,Fm=function(){var e=document.querySelector("head");return e||Ac(!1),e},Lm=function(e){var t=document.createElement("style");return e&&t.setAttribute("nonce",e),t.type="text/css",t};function Um(e,t){var n=nc(function(){return function(e){var t,n,i,r=(t=e,function(e){return"["+e+'="'+t+'"]'}),o=(n="\n      cursor: -webkit-grab;\n      cursor: grab;\n    ",{selector:r(Tm.contextId),styles:{always:"\n          -webkit-touch-callout: none;\n          -webkit-tap-highlight-color: rgba(0,0,0,0);\n          touch-action: manipulation;\n        ",resting:n,dragging:"pointer-events: none;",dropAnimating:n}}),s=[(i="\n      transition: "+Tu.outOfTheWay+";\n    ",{selector:r(Pm.contextId),styles:{dragging:i,dropAnimating:i,userCancel:i}}),o,{selector:r(Nm.contextId),styles:{always:"overflow-anchor: none;"}},{selector:"body",styles:{dragging:"\n        cursor: grabbing;\n        cursor: -webkit-grabbing;\n        user-select: none;\n        -webkit-user-select: none;\n        -moz-user-select: none;\n        -ms-user-select: none;\n        overflow-anchor: none;\n      "}}];return{always:Mm(s,"always"),resting:Mm(s,"resting"),dragging:Mm(s,"dragging"),dropAnimating:Mm(s,"dropAnimating"),userCancel:Mm(s,"userCancel")}}(e)},[e]),i=(0,o.useRef)(null),r=(0,o.useRef)(null),s=ic(_c(function(e){var t=r.current;t||Ac(!1),t.textContent=e}),[]),a=ic(function(e){var t=i.current;t||Ac(!1),t.textContent=e},[]);Om(function(){(i.current||r.current)&&Ac(!1);var o=Lm(t),l=Lm(t);return i.current=o,r.current=l,o.setAttribute(Im+"-always",e),l.setAttribute(Im+"-dynamic",e),Fm().appendChild(o),Fm().appendChild(l),a(n.always),s(n.resting),function(){var e=function(e){var t=e.current;t||Ac(!1),Fm().removeChild(t),e.current=null};e(i),e(r)}},[t,a,s,n.always,n.resting,e]);var l=ic(function(){return s(n.dragging)},[s,n.dragging]),c=ic(function(e){s("DROP"!==e?n.userCancel:n.dropAnimating)},[s,n.dropAnimating,n.userCancel]),d=ic(function(){r.current&&s(n.resting)},[s,n.resting]);return nc(function(){return{dragging:l,dropping:c,resting:d}},[l,c,d])}var Bm=function(e){return e&&e.ownerDocument?e.ownerDocument.defaultView:window};function Vm(e){return e instanceof Bm(e).HTMLElement}function jm(e,t){var n="["+Tm.contextId+'="'+e+'"]',i=Qc(document.querySelectorAll(n));if(!i.length)return null;var r=Xc(i,function(e){return e.getAttribute(Tm.draggableId)===t});return r&&Vm(r)?r:null}function zm(){var e={draggables:{},droppables:{}},t=[];function n(e){t.length&&t.forEach(function(t){return t(e)})}function i(t){return e.draggables[t]||null}function r(t){return e.droppables[t]||null}return{draggable:{register:function(t){e.draggables[t.descriptor.id]=t,n({type:"ADDITION",value:t})},update:function(t,n){var i=e.draggables[n.descriptor.id];i&&i.uniqueId===t.uniqueId&&(delete e.draggables[n.descriptor.id],e.draggables[t.descriptor.id]=t)},unregister:function(t){var r=t.descriptor.id,o=i(r);o&&t.uniqueId===o.uniqueId&&(delete e.draggables[r],n({type:"REMOVAL",value:t}))},getById:function(e){var t=i(e);return t||Ac(!1),t},findById:i,exists:function(e){return Boolean(i(e))},getAllByType:function(t){return Jc(e.draggables).filter(function(e){return e.descriptor.type===t})}},droppable:{register:function(t){e.droppables[t.descriptor.id]=t},unregister:function(t){var n=r(t.descriptor.id);n&&t.uniqueId===n.uniqueId&&delete e.droppables[t.descriptor.id]},getById:function(e){var t=r(e);return t||Ac(!1),t},findById:r,exists:function(e){return Boolean(r(e))},getAllByType:function(t){return Jc(e.droppables).filter(function(e){return e.descriptor.type===t})}},subscribe:function(e){return t.push(e),function(){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},clean:function(){e.draggables={},e.droppables={},t.length=0}}}var Hm=o.createContext(null),Wm=function(){var e=document.body;return e||Ac(!1),e},Gm={position:"absolute",width:"1px",height:"1px",margin:"-1px",border:"0",padding:"0",overflow:"hidden",clip:"rect(0 0 0 0)","clip-path":"inset(100%)"};var Km=0,qm={separator:"::"};function $m(e,t){return void 0===t&&(t=qm),nc(function(){return""+e+t.separator+Km++},[t.separator,e])}var Jm=o.createContext(null);function Ym(e){0}function Xm(e,t){Ym()}function Qm(){Xm()}function Zm(e){var t=(0,o.useRef)(e);return(0,o.useEffect)(function(){t.current=e}),t}var eh,th=((eh={})[13]=!0,eh[9]=!0,eh),nh=function(e){th[e.keyCode]&&e.preventDefault()},ih=function(){var e="visibilitychange";return"undefined"==typeof document?e:Xc([e,"ms"+e,"webkit"+e,"moz"+e,"o"+e],function(e){return"on"+e in document})||e}();var rh,oh={type:"IDLE"};function sh(e){var t=e.cancel,n=e.completed,i=e.getPhase,r=e.setPhase;return[{eventName:"mousemove",fn:function(e){var t=e.button,n=e.clientX,o=e.clientY;if(0===t){var s={x:n,y:o},a=i();if("DRAGGING"===a.type)return e.preventDefault(),void a.actions.move(s);"PENDING"!==a.type&&Ac(!1);var l=a.point;if(c=l,d=s,Math.abs(d.x-c.x)>=5||Math.abs(d.y-c.y)>=5){var c,d;e.preventDefault();var u=a.actions.fluidLift(s);r({type:"DRAGGING",actions:u})}}}},{eventName:"mouseup",fn:function(e){var r=i();"DRAGGING"===r.type?(e.preventDefault(),r.actions.drop({shouldBlockNextClick:!0}),n()):t()}},{eventName:"mousedown",fn:function(e){"DRAGGING"===i().type&&e.preventDefault(),t()}},{eventName:"keydown",fn:function(e){if("PENDING"!==i().type)return 27===e.keyCode?(e.preventDefault(),void t()):void nh(e);t()}},{eventName:"resize",fn:t},{eventName:"scroll",options:{passive:!0,capture:!1},fn:function(){"PENDING"===i().type&&t()}},{eventName:"webkitmouseforcedown",fn:function(e){var n=i();"IDLE"===n.type&&Ac(!1),n.actions.shouldRespectForcePress()?t():e.preventDefault()}},{eventName:ih,fn:t}]}function ah(){}var lh=((rh={})[34]=!0,rh[33]=!0,rh[36]=!0,rh[35]=!0,rh);function ch(e,t){function n(){t(),e.cancel()}return[{eventName:"keydown",fn:function(i){return 27===i.keyCode?(i.preventDefault(),void n()):32===i.keyCode?(i.preventDefault(),t(),void e.drop()):40===i.keyCode?(i.preventDefault(),void e.moveDown()):38===i.keyCode?(i.preventDefault(),void e.moveUp()):39===i.keyCode?(i.preventDefault(),void e.moveRight()):37===i.keyCode?(i.preventDefault(),void e.moveLeft()):void(lh[i.keyCode]?i.preventDefault():nh(i))}},{eventName:"mousedown",fn:n},{eventName:"mouseup",fn:n},{eventName:"click",fn:n},{eventName:"touchstart",fn:n},{eventName:"resize",fn:n},{eventName:"wheel",fn:n,options:{passive:!0}},{eventName:ih,fn:n}]}var dh={type:"IDLE"};var uh={input:!0,button:!0,textarea:!0,select:!0,option:!0,optgroup:!0,video:!0,audio:!0};function mh(e,t){if(null==t)return!1;if(Boolean(uh[t.tagName.toLowerCase()]))return!0;var n=t.getAttribute("contenteditable");return"true"===n||""===n||t!==e&&mh(e,t.parentElement)}function hh(e,t){var n=t.target;return!!Vm(n)&&mh(e,n)}var ph=function(e){return oc(e.getBoundingClientRect()).center};var gh=function(){var e="matches";return"undefined"==typeof document?e:Xc([e,"msMatchesSelector","webkitMatchesSelector"],function(e){return e in Element.prototype})||e}();function vh(e,t){return null==e?null:e[gh](t)?e:vh(e.parentElement,t)}function fh(e,t){return e.closest?e.closest(t):vh(e,t)}function _h(e,t){var n,i=t.target;if(!((n=i)instanceof Bm(n).Element))return null;var r=function(e){return"["+Tm.contextId+'="'+e+'"]'}(e),o=fh(i,r);return o&&Vm(o)?o:null}function yh(e){e.preventDefault()}function bh(e){var t=e.expected,n=e.phase,i=e.isLockActive;e.shouldWarn;return!!i()&&t===n}function Eh(e){var t=e.lockAPI,n=e.store,i=e.registry,r=e.draggableId;if(t.isClaimed())return!1;var o=i.draggable.findById(r);return!!o&&(!!o.options.isEnabled&&!!om(n.getState(),r))}function wh(e){var t=e.lockAPI,n=e.contextId,i=e.store,r=e.registry,o=e.draggableId,s=e.forceSensorStop,a=e.sourceEvent;if(!Eh({lockAPI:t,store:i,registry:r,draggableId:o}))return null;var l=r.draggable.getById(o),c=function(e,t){var n="["+Pm.contextId+'="'+e+'"]',i=Xc(Qc(document.querySelectorAll(n)),function(e){return e.getAttribute(Pm.id)===t});return i&&Vm(i)?i:null}(n,l.descriptor.id);if(!c)return null;if(a&&!l.options.canDragInteractiveElements&&hh(c,a))return null;var d=t.claim(s||Ec),u="PRE_DRAG";function m(){return l.options.shouldRespectForcePress}function h(){return t.isActive(d)}var p=function(e,t){bh({expected:e,phase:u,isLockActive:h,shouldWarn:!0})&&i.dispatch(t())}.bind(null,"DRAGGING");function g(e){function n(){t.release(),u="COMPLETED"}function r(t,r){if(void 0===r&&(r={shouldBlockNextClick:!1}),e.cleanup(),r.shouldBlockNextClick){var o=wc(window,[{eventName:"click",fn:yh,options:{once:!0,passive:!1,capture:!0}}]);setTimeout(o)}n(),i.dispatch(xu({reason:t}))}return"PRE_DRAG"!==u&&(n(),"PRE_DRAG"!==u&&Ac(!1)),i.dispatch(function(e){return{type:"LIFT",payload:e}}(e.liftActionArgs)),u="DRAGGING",(0,tn.A)({isActive:function(){return bh({expected:"DRAGGING",phase:u,isLockActive:h,shouldWarn:!1})},shouldRespectForcePress:m,drop:function(e){return r("DROP",e)},cancel:function(e){return r("CANCEL",e)}},e.actions)}var v={isActive:function(){return bh({expected:"PRE_DRAG",phase:u,isLockActive:h,shouldWarn:!1})},shouldRespectForcePress:m,fluidLift:function(e){var t=yc(function(e){p(function(){return _u({client:e})})}),n=g({liftActionArgs:{id:o,clientSelection:e,movementMode:"FLUID"},cleanup:function(){return t.cancel()},actions:{move:t}});return(0,tn.A)({},n,{move:t})},snapLift:function(){var e={moveUp:function(){return p(yu)},moveRight:function(){return p(Eu)},moveDown:function(){return p(bu)},moveLeft:function(){return p(wu)}};return g({liftActionArgs:{id:o,clientSelection:ph(c),movementMode:"SNAP"},cleanup:Ec,actions:e})},abort:function(){bh({expected:"PRE_DRAG",phase:u,isLockActive:h,shouldWarn:!0})&&t.release()}};return v}var Sh=[function(e){var t=(0,o.useRef)(oh),n=(0,o.useRef)(Ec),i=nc(function(){return{eventName:"mousedown",fn:function(t){if(!t.defaultPrevented&&0===t.button&&!(t.ctrlKey||t.metaKey||t.shiftKey||t.altKey)){var i=e.findClosestDraggableId(t);if(i){var r=e.tryGetLock(i,a,{sourceEvent:t});if(r){t.preventDefault();var o={x:t.clientX,y:t.clientY};n.current(),d(r,o)}}}}}},[e]),r=nc(function(){return{eventName:"webkitmouseforcewillbegin",fn:function(t){if(!t.defaultPrevented){var n=e.findClosestDraggableId(t);if(n){var i=e.findOptionsForDraggable(n);i&&(i.shouldRespectForcePress||e.canGetLock(n)&&t.preventDefault())}}}}},[e]),s=ic(function(){n.current=wc(window,[r,i],{passive:!1,capture:!0})},[r,i]),a=ic(function(){"IDLE"!==t.current.type&&(t.current=oh,n.current(),s())},[s]),l=ic(function(){var e=t.current;a(),"DRAGGING"===e.type&&e.actions.cancel({shouldBlockNextClick:!0}),"PENDING"===e.type&&e.actions.abort()},[a]),c=ic(function(){var e=sh({cancel:l,completed:a,getPhase:function(){return t.current},setPhase:function(e){t.current=e}});n.current=wc(window,e,{capture:!0,passive:!1})},[l,a]),d=ic(function(e,n){"IDLE"!==t.current.type&&Ac(!1),t.current={type:"PENDING",point:n,actions:e},c()},[c]);Om(function(){return s(),function(){n.current()}},[s])},function(e){var t=(0,o.useRef)(ah),n=nc(function(){return{eventName:"keydown",fn:function(n){if(!n.defaultPrevented&&32===n.keyCode){var r=e.findClosestDraggableId(n);if(r){var o=e.tryGetLock(r,l,{sourceEvent:n});if(o){n.preventDefault();var s=!0,a=o.snapLift();t.current(),t.current=wc(window,ch(a,l),{capture:!0,passive:!1})}}}function l(){s||Ac(!1),s=!1,t.current(),i()}}}},[e]),i=ic(function(){t.current=wc(window,[n],{passive:!1,capture:!0})},[n]);Om(function(){return i(),function(){t.current()}},[i])},function(e){var t=(0,o.useRef)(dh),n=(0,o.useRef)(Ec),i=ic(function(){return t.current},[]),r=ic(function(e){t.current=e},[]),s=nc(function(){return{eventName:"touchstart",fn:function(t){if(!t.defaultPrevented){var i=e.findClosestDraggableId(t);if(i){var r=e.tryGetLock(i,l,{sourceEvent:t});if(r){var o=t.touches[0],s={x:o.clientX,y:o.clientY};n.current(),m(r,s)}}}}}},[e]),a=ic(function(){n.current=wc(window,[s],{capture:!0,passive:!1})},[s]),l=ic(function(){var e=t.current;"IDLE"!==e.type&&("PENDING"===e.type&&clearTimeout(e.longPressTimerId),r(dh),n.current(),a())},[a,r]),c=ic(function(){var e=t.current;l(),"DRAGGING"===e.type&&e.actions.cancel({shouldBlockNextClick:!0}),"PENDING"===e.type&&e.actions.abort()},[l]),d=ic(function(){var e={capture:!0,passive:!1},t={cancel:c,completed:l,getPhase:i},r=wc(window,function(e){var t=e.cancel,n=e.completed,i=e.getPhase;return[{eventName:"touchmove",options:{capture:!1},fn:function(e){var n=i();if("DRAGGING"===n.type){n.hasMoved=!0;var r=e.touches[0],o={x:r.clientX,y:r.clientY};e.preventDefault(),n.actions.move(o)}else t()}},{eventName:"touchend",fn:function(e){var r=i();"DRAGGING"===r.type?(e.preventDefault(),r.actions.drop({shouldBlockNextClick:!0}),n()):t()}},{eventName:"touchcancel",fn:function(e){"DRAGGING"===i().type?(e.preventDefault(),t()):t()}},{eventName:"touchforcechange",fn:function(e){var n=i();"IDLE"===n.type&&Ac(!1);var r=e.touches[0];if(r&&r.force>=.15){var o=n.actions.shouldRespectForcePress();if("PENDING"!==n.type)return o?n.hasMoved?void e.preventDefault():void t():void e.preventDefault();o&&t()}}},{eventName:ih,fn:t}]}(t),e),o=wc(window,function(e){var t=e.cancel,n=e.getPhase;return[{eventName:"orientationchange",fn:t},{eventName:"resize",fn:t},{eventName:"contextmenu",fn:function(e){e.preventDefault()}},{eventName:"keydown",fn:function(e){"DRAGGING"===n().type?(27===e.keyCode&&e.preventDefault(),t()):t()}},{eventName:ih,fn:t}]}(t),e);n.current=function(){r(),o()}},[c,i,l]),u=ic(function(){var e=i();"PENDING"!==e.type&&Ac(!1);var t=e.actions.fluidLift(e.point);r({type:"DRAGGING",actions:t,hasMoved:!1})},[i,r]),m=ic(function(e,t){"IDLE"!==i().type&&Ac(!1);var n=setTimeout(u,120);r({type:"PENDING",point:t,actions:e,longPressTimerId:n}),d()},[d,i,r,u]);Om(function(){return a(),function(){n.current();var e=i();"PENDING"===e.type&&(clearTimeout(e.longPressTimerId),r(dh))}},[i,a,r]),Om(function(){return wc(window,[{eventName:"touchmove",fn:function(){},options:{capture:!1,passive:!1}}])},[])}];function xh(e){var t=e.contextId,n=e.store,i=e.registry,r=e.customSensors,s=e.enableDefaultSensors,a=[].concat(s?Sh:[],r||[]),l=(0,o.useState)(function(){return function(){var e=null;function t(){e||Ac(!1),e=null}return{isClaimed:function(){return Boolean(e)},isActive:function(t){return t===e},claim:function(t){e&&Ac(!1);var n={abandon:t};return e=n,n},release:t,tryAbandon:function(){e&&(e.abandon(),t())}}}()})[0],c=ic(function(e,t){e.isDragging&&!t.isDragging&&l.tryAbandon()},[l]);Om(function(){var e=n.getState();return n.subscribe(function(){var t=n.getState();c(e,t),e=t})},[l,n,c]),Om(function(){return l.tryAbandon},[l.tryAbandon]);var d=ic(function(e){return Eh({lockAPI:l,registry:i,store:n,draggableId:e})},[l,i,n]),u=ic(function(e,r,o){return wh({lockAPI:l,registry:i,contextId:t,store:n,draggableId:e,forceSensorStop:r,sourceEvent:o&&o.sourceEvent?o.sourceEvent:null})},[t,l,i,n]),m=ic(function(e){return function(e,t){var n=_h(e,t);return n?n.getAttribute(Tm.draggableId):null}(t,e)},[t]),h=ic(function(e){var t=i.draggable.findById(e);return t?t.options:null},[i.draggable]),p=ic(function(){l.isClaimed()&&(l.tryAbandon(),"IDLE"!==n.getState().phase&&n.dispatch({type:"FLUSH",payload:null}))},[l,n]),g=ic(l.isClaimed,[l]),v=nc(function(){return{canGetLock:d,tryGetLock:u,findClosestDraggableId:m,findOptionsForDraggable:h,tryReleaseLock:p,isLockClaimed:g}},[d,u,m,h,p,g]);Ym();for(var f=0;f<a.length;f++)a[f](v)}function Ah(e){return e.current||Ac(!1),e.current}function Ch(e){var t=e.contextId,n=e.setCallbacks,i=e.sensors,r=e.nonce,s=e.dragHandleUsageInstructions,a=(0,o.useRef)(null);Qm();var l=Zm(e),c=ic(function(){return function(e){return{onBeforeCapture:e.onBeforeCapture,onBeforeDragStart:e.onBeforeDragStart,onDragStart:e.onDragStart,onDragEnd:e.onDragEnd,onDragUpdate:e.onDragUpdate}}(l.current)},[l]),d=function(e){var t=nc(function(){return function(e){return"rbd-announcement-"+e}(e)},[e]),n=(0,o.useRef)(null);return(0,o.useEffect)(function(){var e=document.createElement("div");return n.current=e,e.id=t,e.setAttribute("aria-live","assertive"),e.setAttribute("aria-atomic","true"),(0,tn.A)(e.style,Gm),Wm().appendChild(e),function(){setTimeout(function(){var t=Wm();t.contains(e)&&t.removeChild(e),e===n.current&&(n.current=null)})}},[t]),ic(function(e){var t=n.current;t&&(t.textContent=e)},[])}(t),u=function(e){var t=e.contextId,n=e.text,i=$m("hidden-text",{separator:"-"}),r=nc(function(){return"rbd-hidden-text-"+(e={contextId:t,uniqueId:i}).contextId+"-"+e.uniqueId;var e},[i,t]);return(0,o.useEffect)(function(){var e=document.createElement("div");return e.id=r,e.textContent=n,e.style.display="none",Wm().appendChild(e),function(){var t=Wm();t.contains(e)&&t.removeChild(e)}},[r,n]),r}({contextId:t,text:s}),m=Um(t,r),h=ic(function(e){Ah(a).dispatch(e)},[]),p=nc(function(){return ml({publishWhileDragging:hu,updateDroppableScroll:gu,updateDroppableIsEnabled:vu,updateDroppableIsCombineEnabled:fu,collectionStarting:pu},h)},[h]),g=function(){var e=nc(zm,[]);return(0,o.useEffect)(function(){return function(){requestAnimationFrame(e.clean)}},[e]),e}(),v=nc(function(){return rm(g,p)},[g,p]),f=nc(function(){return Rm((0,tn.A)({scrollWindow:sm,scrollDroppable:v.scrollDroppable},ml({move:_u},h)))},[v.scrollDroppable,h]),_=function(e){var t=(0,o.useRef)({}),n=(0,o.useRef)(null),i=(0,o.useRef)(null),r=(0,o.useRef)(!1),s=ic(function(e,n){var i={id:e,focus:n};return t.current[e]=i,function(){var n=t.current;n[e]!==i&&delete n[e]}},[]),a=ic(function(t){var n=jm(e,t);n&&n!==document.activeElement&&n.focus()},[e]),l=ic(function(e,t){n.current===e&&(n.current=t)},[]),c=ic(function(){i.current||r.current&&(i.current=requestAnimationFrame(function(){i.current=null;var e=n.current;e&&a(e)}))},[a]),d=ic(function(e){n.current=null;var t=document.activeElement;t&&t.getAttribute(Tm.draggableId)===e&&(n.current=e)},[]);return Om(function(){return r.current=!0,function(){r.current=!1;var e=i.current;e&&cancelAnimationFrame(e)}},[]),nc(function(){return{register:s,tryRecordFocus:d,tryRestoreFocusRecorded:c,tryShiftRecord:l}},[s,d,c,l])}(t),y=nc(function(){return Yu({announce:d,autoScroller:f,dimensionMarshal:v,focusMarshal:_,getResponders:c,styleMarshal:m})},[d,f,v,_,c,m]);a.current=y;var b=ic(function(){var e=Ah(a);"IDLE"!==e.getState().phase&&e.dispatch({type:"FLUSH",payload:null})},[]),E=ic(function(){var e=Ah(a).getState();return e.isDragging||"DROP_ANIMATING"===e.phase},[]);n(nc(function(){return{isDragging:E,tryAbort:b}},[E,b]));var w=ic(function(e){return om(Ah(a).getState(),e)},[]),S=ic(function(){return Kd(Ah(a).getState())},[]),x=nc(function(){return{marshal:v,focus:_,contextId:t,canLift:w,isMovementAllowed:S,dragHandleUsageInstructionsId:u,registry:g}},[t,v,u,_,w,S,g]);return xh({contextId:t,store:y,registry:g,customSensors:i,enableDefaultSensors:!1!==e.enableDefaultSensors}),(0,o.useEffect)(function(){return b},[b]),o.createElement(Jm.Provider,{value:x},o.createElement(bl,{context:Hm,store:y},e.children))}var kh=0;function Rh(e){var t=nc(function(){return""+kh++},[]),n=e.dragHandleUsageInstructions||Pc;return o.createElement(Cc,null,function(i){return o.createElement(Ch,{nonce:e.nonce,contextId:t,setCallbacks:i,dragHandleUsageInstructions:n,enableDefaultSensors:e.enableDefaultSensors,sensors:e.sensors,onBeforeCapture:e.onBeforeCapture,onBeforeDragStart:e.onBeforeDragStart,onDragStart:e.onDragStart,onDragUpdate:e.onDragUpdate,onDragEnd:e.onDragEnd},e.children)})}var Ih=function(e){return function(t){return e===t}},Th=Ih("scroll"),Ph=Ih("auto"),Nh=(Ih("visible"),function(e,t){return t(e.overflowX)||t(e.overflowY)}),Dh=function e(t){return null==t||t===document.body||t===document.documentElement?null:function(e){var t=window.getComputedStyle(e),n={overflowX:t.overflowX,overflowY:t.overflowY};return Nh(n,Th)||Nh(n,Ph)}(t)?t:e(t.parentElement)},Mh=function(e){return{x:e.scrollLeft,y:e.scrollTop}},Oh=function e(t){return!!t&&("fixed"===window.getComputedStyle(t).position||e(t.parentElement))},Fh=function(e){return{closestScrollable:Dh(e),isFixedOnPage:Oh(e)}},Lh=function(e){var t=e.ref,n=e.descriptor,i=e.env,r=e.windowScroll,o=e.direction,s=e.isDropDisabled,a=e.isCombineEnabled,l=e.shouldClipSubject,c=i.closestScrollable,d=function(e,t){var n=pc(e);if(!t)return n;if(e!==t)return n;var i=n.paddingBox.top-t.scrollTop,r=n.paddingBox.left-t.scrollLeft,o=i+t.scrollHeight,s=r+t.scrollWidth,a=sc({top:i,right:s,bottom:o,left:r},n.border);return cc({borderBox:a,margin:n.margin,border:n.border,padding:n.padding})}(t,c),u=mc(d,r),m=function(){if(!c)return null;var e=pc(c),t={scrollHeight:c.scrollHeight,scrollWidth:c.scrollWidth};return{client:e,page:mc(e,r),scroll:Mh(c),scrollSize:t,shouldClipSubject:l}}(),h=function(e){var t=e.descriptor,n=e.isEnabled,i=e.isCombineEnabled,r=e.isFixedOnPage,o=e.direction,s=e.client,a=e.page,l=e.closest,c=function(){if(!l)return null;var e=l.scrollSize,t=l.client,n=Xu({scrollHeight:e.scrollHeight,scrollWidth:e.scrollWidth,height:t.paddingBox.height,width:t.paddingBox.width});return{pageMarginBox:l.page.marginBox,frameClient:t,scrollSize:e,shouldClipSubject:l.shouldClipSubject,scroll:{initial:l.scroll,current:l.scroll,max:n,diff:{value:Oc,displacement:Oc}}}}(),d="vertical"===o?pd:gd;return{descriptor:t,isCombineEnabled:i,isFixedOnPage:r,axis:d,isEnabled:n,client:s,page:a,frame:c,subject:qc({page:a,withPlaceholder:null,axis:d,frame:c})}}({descriptor:n,isEnabled:!s,isCombineEnabled:a,isFixedOnPage:i.isFixedOnPage,direction:o,client:d,page:u,closest:m});return h},Uh={passive:!1},Bh={passive:!0},Vh=function(e){return e.shouldPublishImmediately?Uh:Bh};function jh(e){var t=(0,o.useContext)(e);return t||Ac(!1),t}var zh=function(e){return e&&e.env.closestScrollable||null};function Hh(){}var Wh={width:0,height:0,margin:{top:0,right:0,bottom:0,left:0}},Gh=function(e){var t=e.isAnimatingOpenOnMount,n=e.placeholder,i=e.animate,r=function(e){var t=e.isAnimatingOpenOnMount,n=e.placeholder,i=e.animate;return t||"close"===i?Wh:{height:n.client.borderBox.height,width:n.client.borderBox.width,margin:n.client.margin}}({isAnimatingOpenOnMount:t,placeholder:n,animate:i});return{display:n.display,boxSizing:"border-box",width:r.width,height:r.height,marginTop:r.margin.top,marginRight:r.margin.right,marginBottom:r.margin.bottom,marginLeft:r.margin.left,flexShrink:"0",flexGrow:"0",pointerEvents:"none",transition:"none"!==i?Tu.placeholder:null}};var Kh=o.memo(function(e){var t=(0,o.useRef)(null),n=ic(function(){t.current&&(clearTimeout(t.current),t.current=null)},[]),i=e.animate,r=e.onTransitionEnd,s=e.onClose,a=e.contextId,l=(0,o.useState)("open"===e.animate),c=l[0],d=l[1];(0,o.useEffect)(function(){return c?"open"!==i?(n(),d(!1),Hh):t.current?Hh:(t.current=setTimeout(function(){t.current=null,d(!1)}),n):Hh},[i,c,n]);var u=ic(function(e){"height"===e.propertyName&&(r(),"close"===i&&s())},[i,s,r]),m=Gh({isAnimatingOpenOnMount:c,animate:e.animate,placeholder:e.placeholder});return o.createElement(e.placeholder.tagName,{style:m,"data-rbd-placeholder-context-id":a,onTransitionEnd:u,ref:e.innerRef})}),qh=o.createContext(null);var $h=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).state={isVisible:Boolean(t.props.on),data:t.props.on,animate:t.props.shouldAnimate&&t.props.on?"open":"none"},t.onClose=function(){"close"===t.state.animate&&t.setState({isVisible:!1})},t}return(0,nl.A)(t,e),t.getDerivedStateFromProps=function(e,t){return e.shouldAnimate?e.on?{isVisible:!0,data:e.on,animate:"open"}:t.isVisible?{isVisible:!0,data:t.data,animate:"close"}:{isVisible:!1,animate:"close",data:null}:{isVisible:Boolean(e.on),data:e.on,animate:"none"}},t.prototype.render=function(){if(!this.state.isVisible)return null;var e={onClose:this.onClose,data:this.state.data,animate:this.state.animate};return this.props.children(e)},t}(o.PureComponent),Jh=5e3,Yh=4500,Xh=function(e,t){return t?Tu.drop(t.duration):e?Tu.snap:Tu.fluid},Qh=function(e,t){return e?t?ku.drop:ku.combining:null};function Zh(e){return"DRAGGING"===e.type?function(e){var t=e.dimension.client,n=e.offset,i=e.combineWith,r=e.dropping,o=Boolean(i),s=function(e){return null!=e.forceShouldAnimate?e.forceShouldAnimate:"SNAP"===e.mode}(e),a=Boolean(r),l=a?Du(n,o):Nu(n);return{position:"fixed",top:t.marginBox.top,left:t.marginBox.left,boxSizing:"border-box",width:t.borderBox.width,height:t.borderBox.height,transition:Xh(s,r),transform:l,opacity:Qh(o,a),zIndex:a?Yh:Jh,pointerEvents:"none"}}(e):{transform:Nu((t=e).offset),transition:t.shouldAnimateDisplacement?null:"none"};var t}function ep(e){var t=$m("draggable"),n=e.descriptor,i=e.registry,r=e.getDraggableRef,s=e.canDragInteractiveElements,a=e.shouldRespectForcePress,l=e.isEnabled,c=nc(function(){return{canDragInteractiveElements:s,shouldRespectForcePress:a,isEnabled:l}},[s,l,a]),d=ic(function(e){var t=r();return t||Ac(!1),function(e,t,n){void 0===n&&(n=Oc);var i=window.getComputedStyle(t),r=t.getBoundingClientRect(),o=hc(r,i),s=mc(o,n);return{descriptor:e,placeholder:{client:o,tagName:t.tagName.toLowerCase(),display:i.display},displaceBy:{x:o.marginBox.width,y:o.marginBox.height},client:o,page:s}}(n,t,e)},[n,r]),u=nc(function(){return{uniqueId:t,descriptor:n,options:c,getDimension:d}},[n,d,c,t]),m=(0,o.useRef)(u),h=(0,o.useRef)(!0);Om(function(){return i.draggable.register(m.current),function(){return i.draggable.unregister(m.current)}},[i.draggable]),Om(function(){if(h.current)h.current=!1;else{var e=m.current;m.current=u,i.draggable.update(u,e)}},[u,i.draggable])}function tp(e,t,n){Xm()}function np(e){e.preventDefault()}var ip=function(e,t){return e===t},rp=function(e){var t=e.combine,n=e.destination;return n?n.droppableId:t?t.droppableId:null};function op(e){return{isDragging:!1,isDropAnimating:!1,isClone:!1,dropAnimation:null,mode:null,draggingOver:null,combineTargetFor:e,combineWith:null}}var sp={mapped:{type:"SECONDARY",offset:Oc,combineTargetFor:null,shouldAnimateDisplacement:!0,snapshot:op(null)}};var ap=Ql(function(){var e,t,n,i=(e=_c(function(e,t){return{x:e,y:t}}),t=_c(function(e,t,n,i,r){return{isDragging:!0,isClone:t,isDropAnimating:Boolean(r),dropAnimation:r,mode:e,draggingOver:n,combineWith:i,combineTargetFor:null}}),n=_c(function(e,n,i,r,o,s,a){return{mapped:{type:"DRAGGING",dropping:null,draggingOver:o,combineWith:s,mode:n,offset:e,dimension:i,forceShouldAnimate:a,snapshot:t(n,r,o,s,null)}}}),function(i,r){if(i.isDragging){if(i.critical.draggable.id!==r.draggableId)return null;var o=i.current.client.offset,s=i.dimensions.draggables[r.draggableId],a=Wd(i.impact),l=(d=i.impact).at&&"COMBINE"===d.at.type?d.at.combine.draggableId:null,c=i.forceShouldAnimate;return n(e(o.x,o.y),i.movementMode,s,r.isClone,a,l,c)}var d;if("DROP_ANIMATING"===i.phase){var u=i.completed;if(u.result.draggableId!==r.draggableId)return null;var m=r.isClone,h=i.dimensions.draggables[r.draggableId],p=u.result,g=p.mode,v=rp(p),f=function(e){return e.combine?e.combine.draggableId:null}(p),_={duration:i.dropDuration,curve:Cu,moveTo:i.newHomeClientOffset,opacity:f?ku.drop:null,scale:f?Ru.drop:null};return{mapped:{type:"DRAGGING",offset:i.newHomeClientOffset,dimension:h,dropping:_,draggingOver:v,combineWith:f,mode:g,forceShouldAnimate:null,snapshot:t(g,m,v,f,_)}}}return null}),r=function(){var e=_c(function(e,t){return{x:e,y:t}}),t=_c(op),n=_c(function(e,n,i){return void 0===n&&(n=null),{mapped:{type:"SECONDARY",offset:e,combineTargetFor:n,shouldAnimateDisplacement:i,snapshot:t(n)}}}),i=function(e){return e?n(Oc,e,!0):null},r=function(t,r,o,s){var a=o.displaced.visible[t],l=Boolean(s.inVirtualList&&s.effected[t]),c=od(o),d=c&&c.draggableId===t?r:null;if(!a){if(!l)return i(d);if(o.displaced.invisible[t])return null;var u=Bc(s.displacedBy.point),m=e(u.x,u.y);return n(m,d,!0)}if(l)return i(d);var h=o.displacedBy.point,p=e(h.x,h.y);return n(p,d,a.shouldAnimate)};return function(e,t){if(e.isDragging)return e.critical.draggable.id===t.draggableId?null:r(t.draggableId,e.critical.draggable.id,e.impact,e.afterCritical);if("DROP_ANIMATING"===e.phase){var n=e.completed;return n.result.draggableId===t.draggableId?null:r(t.draggableId,n.result.draggableId,n.impact,n.afterCritical)}return null}}();return function(e,t){return i(e,t)||r(e,t)||sp}},{dropAnimationFinished:Au},null,{context:Hm,pure:!0,areStatePropsEqual:ip})(function(e){var t=(0,o.useRef)(null),n=ic(function(e){t.current=e},[]),i=ic(function(){return t.current},[]),r=jh(Jm),s=r.contextId,a=r.dragHandleUsageInstructionsId,l=r.registry,c=jh(qh),d=c.type,u=c.droppableId,m=nc(function(){return{id:e.draggableId,index:e.index,type:d,droppableId:u}},[e.draggableId,e.index,d,u]),h=e.children,p=e.draggableId,g=e.isEnabled,v=e.shouldRespectForcePress,f=e.canDragInteractiveElements,_=e.isClone,y=e.mapped,b=e.dropAnimationFinished;tp(),Ym(),_||ep(nc(function(){return{descriptor:m,registry:l,getDraggableRef:i,canDragInteractiveElements:f,shouldRespectForcePress:v,isEnabled:g}},[m,l,i,f,v,g]));var E=nc(function(){return g?{tabIndex:0,role:"button","aria-describedby":a,"data-rbd-drag-handle-draggable-id":p,"data-rbd-drag-handle-context-id":s,draggable:!1,onDragStart:np}:null},[s,a,p,g]),w=ic(function(e){"DRAGGING"===y.type&&y.dropping&&"transform"===e.propertyName&&b()},[b,y]),S=nc(function(){var e=Zh(y),t="DRAGGING"===y.type&&y.dropping?w:null;return{innerRef:n,draggableProps:{"data-rbd-draggable-context-id":s,"data-rbd-draggable-id":p,style:e,onTransitionEnd:t},dragHandleProps:E}},[s,E,p,y,w,n]),x=nc(function(){return{draggableId:m.id,type:m.type,source:{index:m.index,droppableId:m.droppableId}}},[m.droppableId,m.id,m.index,m.type]);return h(S,y.snapshot,x)});function lp(e){return jh(qh).isUsingCloneFor!==e.draggableId||e.isClone?o.createElement(ap,e):null}function cp(e){var t="boolean"!=typeof e.isDragDisabled||!e.isDragDisabled,n=Boolean(e.disableInteractiveElementBlocking),i=Boolean(e.shouldRespectForcePress);return o.createElement(lp,(0,tn.A)({},e,{isClone:!1,isEnabled:t,canDragInteractiveElements:n,shouldRespectForcePress:i}))}var dp=function(e,t){return e===t.droppable.type},up=function(e,t){return t.draggables[e.draggable.id]};var mp={mode:"standard",type:"DEFAULT",direction:"vertical",isDropDisabled:!1,isCombineEnabled:!1,ignoreContainerClipping:!1,renderClone:null,getContainerForClone:function(){return document.body||Ac(!1),document.body}},hp=Ql(function(){var e={placeholder:null,shouldAnimatePlaceholder:!0,snapshot:{isDraggingOver:!1,draggingOverWith:null,draggingFromThisWith:null,isUsingPlaceholder:!1},useClone:null},t=(0,tn.A)({},e,{shouldAnimatePlaceholder:!1}),n=_c(function(e){return{draggableId:e.id,type:e.type,source:{index:e.index,droppableId:e.droppableId}}}),i=_c(function(i,r,o,s,a,l){var c=a.descriptor.id;if(a.descriptor.droppableId===i){var d=l?{render:l,dragging:n(a.descriptor)}:null,u={isDraggingOver:o,draggingOverWith:o?c:null,draggingFromThisWith:c,isUsingPlaceholder:!0};return{placeholder:a.placeholder,shouldAnimatePlaceholder:!1,snapshot:u,useClone:d}}if(!r)return t;if(!s)return e;var m={isDraggingOver:o,draggingOverWith:c,draggingFromThisWith:null,isUsingPlaceholder:!0};return{placeholder:a.placeholder,shouldAnimatePlaceholder:!0,snapshot:m,useClone:null}});return function(n,r){var o=r.droppableId,s=r.type,a=!r.isDropDisabled,l=r.renderClone;if(n.isDragging){var c=n.critical;if(!dp(s,c))return t;var d=up(c,n.dimensions),u=Wd(n.impact)===o;return i(o,a,u,u,d,l)}if("DROP_ANIMATING"===n.phase){var m=n.completed;if(!dp(s,m.critical))return t;var h=up(m.critical,n.dimensions);return i(o,a,rp(m.result)===o,Wd(m.impact)===o,h,l)}if("IDLE"===n.phase&&n.completed&&!n.shouldFlush){var p=n.completed;if(!dp(s,p.critical))return t;var g=Wd(p.impact)===o,v=Boolean(p.impact.at&&"COMBINE"===p.impact.at.type),f=p.critical.droppable.id===o;return g?v?e:t:f?e:t}return t}},{updateViewportMaxScroll:function(e){return{type:"UPDATE_VIEWPORT_MAX_SCROLL",payload:e}}},null,{context:Hm,pure:!0,areStatePropsEqual:ip})(function(e){var t=(0,o.useContext)(Jm);t||Ac(!1);var n=t.contextId,i=t.isMovementAllowed,r=(0,o.useRef)(null),s=(0,o.useRef)(null),a=e.children,l=e.droppableId,c=e.type,d=e.mode,u=e.direction,m=e.ignoreContainerClipping,h=e.isDropDisabled,p=e.isCombineEnabled,g=e.snapshot,v=e.useClone,f=e.updateViewportMaxScroll,_=e.getContainerForClone,y=ic(function(){return r.current},[]),b=ic(function(e){r.current=e},[]),E=(ic(function(){return s.current},[]),ic(function(e){s.current=e},[]));Xm();var w=ic(function(){i()&&f({maxScroll:Zu()})},[i,f]);!function(e){var t=(0,o.useRef)(null),n=jh(Jm),i=$m("droppable"),r=n.registry,s=n.marshal,a=Zm(e),l=nc(function(){return{id:e.droppableId,type:e.type,mode:e.mode}},[e.droppableId,e.mode,e.type]),c=(0,o.useRef)(l),d=nc(function(){return _c(function(e,n){t.current||Ac(!1);var i={x:e,y:n};s.updateDroppableScroll(l.id,i)})},[l.id,s]),u=ic(function(){var e=t.current;return e&&e.env.closestScrollable?Mh(e.env.closestScrollable):Oc},[]),m=ic(function(){var e=u();d(e.x,e.y)},[u,d]),h=nc(function(){return yc(m)},[m]),p=ic(function(){var e=t.current,n=zh(e);e&&n||Ac(!1),e.scrollOptions.shouldPublishImmediately?m():h()},[h,m]),g=ic(function(e,i){t.current&&Ac(!1);var r=a.current,o=r.getDroppableRef();o||Ac(!1);var s=Fh(o),c={ref:o,descriptor:l,env:s,scrollOptions:i};t.current=c;var d=Lh({ref:o,descriptor:l,env:s,windowScroll:e,direction:r.direction,isDropDisabled:r.isDropDisabled,isCombineEnabled:r.isCombineEnabled,shouldClipSubject:!r.ignoreContainerClipping}),u=s.closestScrollable;return u&&(u.setAttribute(Dm.contextId,n.contextId),u.addEventListener("scroll",p,Vh(c.scrollOptions))),d},[n.contextId,l,p,a]),v=ic(function(){var e=t.current,n=zh(e);return e&&n||Ac(!1),Mh(n)},[]),f=ic(function(){var e=t.current;e||Ac(!1);var n=zh(e);t.current=null,n&&(h.cancel(),n.removeAttribute(Dm.contextId),n.removeEventListener("scroll",p,Vh(e.scrollOptions)))},[p,h]),_=ic(function(e){var n=t.current;n||Ac(!1);var i=zh(n);i||Ac(!1),i.scrollTop+=e.y,i.scrollLeft+=e.x},[]),y=nc(function(){return{getDimensionAndWatchScroll:g,getScrollWhileDragging:v,dragStopped:f,scroll:_}},[f,g,v,_]),b=nc(function(){return{uniqueId:i,descriptor:l,callbacks:y}},[y,l,i]);Om(function(){return c.current=b.descriptor,r.droppable.register(b),function(){t.current&&f(),r.droppable.unregister(b)}},[y,l,f,b,s,r.droppable]),Om(function(){t.current&&s.updateDroppableIsEnabled(c.current.id,!e.isDropDisabled)},[e.isDropDisabled,s]),Om(function(){t.current&&s.updateDroppableIsCombineEnabled(c.current.id,e.isCombineEnabled)},[e.isCombineEnabled,s])}({droppableId:l,type:c,mode:d,direction:u,isDropDisabled:h,isCombineEnabled:p,ignoreContainerClipping:m,getDroppableRef:y});var S=o.createElement($h,{on:e.placeholder,shouldAnimate:e.shouldAnimatePlaceholder},function(e){var t=e.onClose,i=e.data,r=e.animate;return o.createElement(Kh,{placeholder:i,onClose:t,innerRef:E,animate:r,contextId:n,onTransitionEnd:w})}),x=nc(function(){return{innerRef:b,placeholder:S,droppableProps:{"data-rbd-droppable-id":l,"data-rbd-droppable-context-id":n}}},[n,l,S,b]),A=v?v.dragging.draggableId:null,C=nc(function(){return{droppableId:l,type:c,isUsingCloneFor:A}},[l,A,c]);return o.createElement(qh.Provider,{value:C},a(x,g),function(){if(!v)return null;var e=v.dragging,t=v.render,n=o.createElement(lp,{draggableId:e.draggableId,index:e.source.index,isClone:!0,isEnabled:!0,shouldRespectForcePress:!1,canDragInteractiveElements:!0},function(n,i){return t(n,i,e)});return ec.createPortal(n,_())}())});hp.defaultProps=mp;var pp=n("./src/components/views/spaces/SpaceCreateMenu.tsx");const gp=(e,t)=>{let n="";if(t)for(const e of t.entries())n+=e+"/";return`mx_space_collapsed_${n+e}`};class vp{static get instance(){return vp.internalInstance||(vp.internalInstance=new vp),vp.internalInstance}setSpaceCollapsedState(e,t,n){localStorage.setItem(gp(e,t),n.toString())}getSpaceCollapsedState(e,t,n){const i=localStorage.getItem(gp(e,t));return i?"true"===i:n}}(0,S.A)(vp,"internalInstance",void 0);var fp=n("./src/stores/notifications/NotificationLevel.ts");const _p=["space","spaceKey","className","selected","label","contextMenuTooltip","notificationState","size","isNarrow","children","innerRef","ContextMenuComponent"],yp=["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef","dragHandleProps"],bp=["tabIndex"];const Ep=e=>{var t;let{space:n,spaceKey:i,className:r,selected:s,label:a,contextMenuTooltip:l,notificationState:d,size:u,isNarrow:m,children:h,innerRef:p,ContextMenuComponent:g}=e,f=(0,v.A)(e,_p);const[_,y,b,E]=(0,Nn.EF)(p),[w,S,A]=(0,mi.A9)(y),C=S?0:-1,k=null!=i?i:null==n?void 0:n.roomId;let R,I,T=o.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},o.createElement("div",{className:"mx_SpaceButton_icon"}));if(n&&(T=o.createElement(Tn.A,{size:u,room:n,type:"square"})),k&&d){let e=(0,c._t)("a11y_jump_first_unread_room");(null==n?void 0:n.getMyMembership())===Xt.O.Invite&&(e=(0,c._t)("a11y|jump_first_invite"));const t=e=>{e.stopPropagation(),e.preventDefault(),Ci.Ay.instance.setActiveRoomInSpace(k)};R=o.createElement("div",{className:"mx_SpacePanel_badgeContainer"},o.createElement(On.A,{onClick:t,notification:d,"aria-label":e,tabIndex:C,showUnsentTooltip:!0}))}_&&y.current&&g&&(I=o.createElement(g,(0,tn.A)({},(0,Nn.Dq)(y.current.getBoundingClientRect(),0),{space:n,onFinished:E})));const P=null!==(t=f.onClick)&&void 0!==t?t:s&&n?()=>x.A.dispatch({action:W.r.ViewRoom,room_id:n.roomId}):()=>{k&&Ci.Ay.instance.setActiveSpace(k)};return o.createElement(ae.A,(0,tn.A)({},f,{className:me()("mx_SpaceButton",r,{mx_SpaceButton_active:s,mx_SpaceButton_hasMenuOpen:_,mx_SpaceButton_narrow:m}),"aria-label":a,title:!m||_?void 0:a,onClick:P,onContextMenu:b,ref:A,tabIndex:C,onFocus:w}),h,o.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},o.createElement("div",{className:"mx_SpaceButton_avatarWrapper"},T,R),!m&&o.createElement("span",{className:"mx_SpaceButton_name"},a),g&&o.createElement(Bi.o,{className:"mx_SpaceButton_menuButton",onClick:b,title:l,isExpanded:_}),I))};class wp extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"buttonRef",(0,o.createRef)()),(0,S.A)(this,"onSpaceUpdate",()=>{this.setState({childSpaces:this.childSpaces})}),(0,S.A)(this,"onRoomNameChange",()=>{this.setState({name:this.props.space.name})}),(0,S.A)(this,"toggleCollapse",e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;vp.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()}),(0,S.A)(this,"onKeyDown",e=>{var t;let n=!0;const i=(0,uo.zM)().getRoomListAction(e),r=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(i){case Ei.bY.CollapseRoomListSection:if(r&&!this.isCollapsed)this.toggleCollapse(e);else{var o;const e=null===(o=this.buttonRef)||void 0===o||null===(o=o.current)||void 0===o||null===(o=o.parentElement)||void 0===o?void 0:o.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case Ei.bY.ExpandRoomListSection:if(r)if(this.isCollapsed)this.toggleCollapse(e);else{var s,a;const e=null===(s=this.buttonRef)||void 0===s||null===(s=s.current)||void 0===s?void 0:s.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(a=t.querySelector(".mx_SpaceButton"))||void 0===a||a.focus()}break;default:n=!1}n&&(e.stopPropagation(),e.preventDefault())});const t=vp.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={name:this.props.space.name,collapsed:t,childSpaces:this.childSpaces}}componentDidMount(){Ci.Ay.instance.on(this.props.space.roomId,this.onSpaceUpdate),this.props.space.on(i.RoomEvent.Name,this.onRoomNameChange)}componentWillUnmount(){Ci.Ay.instance.off(this.props.space.roomId,this.onSpaceUpdate),this.props.space.off(i.RoomEvent.Name,this.onRoomNameChange)}get childSpaces(){return Ci.Ay.instance.getChildSpaces(this.props.space.roomId).filter(e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))})}get isCollapsed(){return this.state.collapsed||!!this.props.isPanelCollapsed}render(){var e,t;const n=this.props,{space:i,activeSpaces:r,isNested:s,isPanelCollapsed:a,onExpand:l,parents:d,innerRef:u,dragHandleProps:m}=n,h=(0,v.A)(n,yp),p=this.isCollapsed,g=me()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:a,collapsed:p,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),f=i.getMyMembership()===Xt.O.Invite,_=f?Mn.d.forSymbol("!",fp.S.Highlight):Ci.Ay.instance.getNotificationState(i.roomId),y=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;let b;y&&!p&&(b=o.createElement(Sp,{spaces:this.state.childSpaces,activeSpaces:r,isNested:!0,parents:new Set(d).add(i.roomId)}));const E=y?o.createElement(ae.A,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":p?(0,c._t)("action|expand"):(0,c._t)("action|collapse")}):null,w=m||{},{tabIndex:S}=w,A=(0,v.A)(w,bp),C=r.includes(i.roomId),k=function(e){const t=Ci.Ay.instance.getChildren(e.roomId).filter(e=>e.isSpaceRoom()),n=t.some(e=>"GOV"===e.name),i=t.some(e=>"DCA"===e.name);return n&&i}(i),R=k?function(e){const t=Ci.Ay.instance.getChildren(e.roomId).filter(e=>e.isSpaceRoom());return{gov:t.find(e=>"GOV"===e.name),dca:t.find(e=>"DCA"===e.name)}}(i):{};return o.createElement("li",(0,tn.A)({},h,{className:g,ref:u,"aria-expanded":y?!p:void 0,"aria-selected":C,role:"treeitem"}),o.createElement("div",{className:k?"mx_SpaceItem_dao":void 0},o.createElement(Ep,(0,tn.A)({},A,{space:i,className:f?"mx_SpaceButton_invite":void 0,selected:C,label:this.state.name,contextMenuTooltip:(0,c._t)("space|context_menu|options"),notificationState:_,isNarrow:a,size:s?"24px":"32px",onKeyDown:this.onKeyDown,ContextMenuComponent:this.props.space.getMyMembership()===Xt.O.Join?el:void 0}),E),k&&!a&&o.createElement("div",{className:"mx_SpaceItem_daoSubspaces"},R.gov&&o.createElement(ae.A,{className:"mx_SpaceItem_daoButton mx_SpaceItem_daoButton_gov",onClick:()=>x.A.dispatch({action:W.r.ViewRoom,room_id:R.gov.roomId,metricsTrigger:"SpacePanel"})},"GOV"),R.dca&&o.createElement(ae.A,{className:"mx_SpaceItem_daoButton mx_SpaceItem_daoButton_dca",onClick:()=>x.A.dispatch({action:W.r.ViewRoom,room_id:R.dca.roomId,metricsTrigger:"SpacePanel"})},"DCA"))),!k&&b)}}const Sp=({spaces:e,activeSpaces:t,isNested:n,parents:i})=>o.createElement("ul",{className:"mx_SpaceTreeLevel",role:"group"},e.map(e=>o.createElement(wp,{key:e.roomId,activeSpaces:t,space:e,isNested:n,parents:i})));var xp=n("./src/stores/notifications/RoomNotificationStateStore.ts");function Ap(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"m12.897 2.817 2.336 4.733 5.223.76a1 1 0 0 1 .555 1.705L17.23 13.7l.892 5.202a1 1 0 0 1-1.45 1.054L12 17.5l-4.672 2.456a1 1 0 0 1-1.451-1.054l.892-5.202-3.78-3.685a1 1 0 0 1 .555-1.706l5.223-.759 2.336-4.733a1 1 0 0 1 1.794 0"})})}Ap.displayName="FavouriteSolidIcon";const Cp=(0,o.forwardRef)(Ap);var kp=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/user-profile-solid.js");function Rp(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"m12.971 3.54 7 3.889A2 2 0 0 1 21 9.177V19a2 2 0 0 1-2 2h-4v-9H9v9H5a2 2 0 0 1-2-2V9.177a2 2 0 0 1 1.029-1.748l7-3.89a2 2 0 0 1 1.942 0"})})}Rp.displayName="HomeSolidIcon";const Ip=(0,o.forwardRef)(Rp);var Tp=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/video-call-solid.js");function Pp(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function Np(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Pp(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Pp(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const Dp=(e,t)=>async n=>{const i=O.A.getValue("Spaces.enabledMetaSpaces");await O.A.setValue("Spaces.enabledMetaSpaces",null,F.p.ACCOUNT,Np(Np({},i),{},{[e]:n.target.checked})),Si.A.trackInteraction(t,n,[$a._b.Home,null,$a._b.Favourites,$a._b.People,$a._b.Orphans,$a._b.VideoRooms].indexOf(e))},Mp=()=>{const{[$a._b.Home]:e,[$a._b.Favourites]:t,[$a._b.People]:n,[$a._b.Orphans]:i,[$a._b.VideoRooms]:r}=(0,Qt.ti)("Spaces.enabledMetaSpaces"),s=(0,Qt.ti)("Spaces.allRoomsInHome"),a=(0,o.useMemo)(()=>d.Ay.get("element_call").guest_spa_url,[]),l=(0,c._t)("settings|sidebar|metaspaces_video_rooms_description")+(a?" "+(0,c._t)("settings|sidebar|metaspaces_video_rooms_description_invite_extension"):""),u=(0,Qt.ti)("feature_new_room_list");return o.createElement(No.A,null,o.createElement(Do.X,null,o.createElement(Mo.P,{heading:(0,c._t)("settings|sidebar|metaspaces_subsection"),description:(0,c._t)("settings|sidebar|spaces_explainer")},o.createElement(Io.A,{checked:!!e,onChange:Dp($a._b.Home,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",disabled:e,description:(0,c._t)("settings|sidebar|metaspaces_home_description")},o.createElement(Ip,{className:"mx_SidebarUserSettingsTab_icon"}),(0,c._t)("common|home")),o.createElement(Io.A,{checked:s,disabled:!e,onChange:async e=>{await O.A.setValue("Spaces.allRoomsInHome",null,F.p.ACCOUNT,e.target.checked),Si.A.trackInteraction("WebSettingsSidebarTabSpacesCheckbox",e,1)},className:"mx_SidebarUserSettingsTab_checkbox mx_SidebarUserSettingsTab_homeAllRoomsCheckbox",description:(0,c._t)("settings|sidebar|metaspaces_home_all_rooms_description")},(0,c._t)("settings|sidebar|metaspaces_home_all_rooms")),!u&&o.createElement(o.Fragment,null,o.createElement(Io.A,{checked:!!t,onChange:Dp($a._b.Favourites,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",description:(0,c._t)("settings|sidebar|metaspaces_favourites_description")},o.createElement(Cp,{className:"mx_SidebarUserSettingsTab_icon"}),(0,c._t)("common|favourites")),o.createElement(Io.A,{checked:!!n,onChange:Dp($a._b.People,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",description:(0,c._t)("settings|sidebar|metaspaces_people_description")},o.createElement(kp.A,{className:"mx_SidebarUserSettingsTab_icon"}),(0,c._t)("common|people"))),o.createElement(Io.A,{checked:!!i,onChange:Dp($a._b.Orphans,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",description:(0,c._t)("settings|sidebar|metaspaces_orphans_description")},(0,c._t)("settings|sidebar|metaspaces_orphans")),O.A.getValue("feature_video_rooms")&&o.createElement(Io.A,{checked:!!r,onChange:Dp($a._b.VideoRooms,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_checkbox",description:l},o.createElement(Tp.A,{className:"mx_SidebarUserSettingsTab_icon"}),(0,c._t)("settings|sidebar|metaspaces_video_rooms")))))};var Op=n("./src/theme.ts"),Fp=n("./src/components/views/elements/Dropdown.tsx");function Lp(){const e=(0,Qt.ti)("theme"),t=(0,Qt.wL)(F.p.DEVICE,"use_system_theme",null,!1,!0),n=(0,Qt.wL)(F.p.DEVICE,"theme",null,!1,!0),i=(0,Qt.ti)("use_system_theme");return t?{theme:e,systemThemeActivated:!0}:n?{theme:e,systemThemeActivated:!1}:{theme:e,systemThemeActivated:i}}const Up="MATCH_SYSTEM_THEME_ID",Bp=({requestClose:e})=>{const t=(0,o.useMemo)(()=>(0,Op.E0)(),[]),n=Lp(),i=(0,Op.kZ)(n.theme),r=i||n.theme,{systemThemeActivated:s}=n,a=[{id:Up,name:(0,c._t)("theme|match_system")},...t],l=s?Up:r;return o.createElement("div",{className:"mx_QuickThemeSwitcher"},o.createElement("h4",{className:"mx_QuickThemeSwitcher_heading"},(0,c._t)("common|theme")),o.createElement(Fp.A,{id:"mx_QuickSettingsButton_themePickerDropdown",onOptionChange:async t=>{Si.A.trackInteraction("WebQuickSettingsThemeDropdown");try{t===Up?await O.A.setValue("use_system_theme",null,F.p.DEVICE,!0):(x.A.dispatch({action:W.r.RecheckTheme,forceTheme:t}),await Promise.all([O.A.setValue("theme",null,F.p.DEVICE,t),O.A.setValue("use_system_theme",null,F.p.DEVICE,!1)]))}catch{x.A.dispatch({action:W.r.RecheckTheme})}e()},value:l,label:(0,c._t)("common|theme")},a.map(e=>o.createElement("div",{key:e.id},e.name))))};var Vp=n("./src/components/views/dialogs/DevtoolsDialog.tsx");const jp=({isPanelCollapsed:e=!1})=>{const[t,n,i,r]=(0,Nn.EF)(),{[$a._b.Favourites]:s,[$a._b.People]:a}=(0,Qt.ti)("Spaces.enabledMetaSpaces"),l=as.M.instance.roomViewStore.getRoomId(),d=(0,Qt.ti)("developerMode"),u=(0,Qt.ti)("feature_new_room_list");let m;return t&&n.current&&(m=o.createElement(Nn.Ay,(0,tn.A)({},(0,Nn.Gi)(n.current.getBoundingClientRect(),Nn.t4.None,16),{wrapperClassName:me()("mx_QuickSettingsButton_ContextMenuWrapper",{mx_QuickSettingsButton_ContextMenuWrapper_new_room_list:u}),onFinished:r,managed:!1,focusLock:!0}),o.createElement("h2",null,(0,c._t)("quick_settings|title")),o.createElement(ae.A,{onClick:()=>{r(),x.A.dispatch({action:W.r.ViewUserSettings})},kind:"primary_outline"},(0,c._t)("quick_settings|all_settings")),l&&d&&o.createElement(ae.A,{onClick:()=>{r(),R.Ay.createDialog(Vp.A,{roomId:l},"mx_DevtoolsDialog_wrapper")},kind:"danger_outline"},(0,c._t)("devtools|title")),!u&&o.createElement(o.Fragment,null,o.createElement("h4",null,o.createElement(zr,{className:"mx_QuickSettingsButton_icon"}),(0,c._t)("quick_settings|metaspace_section")),o.createElement(Io.A,{className:"mx_QuickSettingsButton_option",checked:!!s,onChange:Dp($a._b.Favourites,"WebQuickSettingsPinToSidebarCheckbox")},o.createElement(Cp,{className:"mx_QuickSettingsButton_icon"}),(0,c._t)("common|favourites")),o.createElement(Io.A,{className:"mx_QuickSettingsButton_option",checked:!!a,onChange:Dp($a._b.People,"WebQuickSettingsPinToSidebarCheckbox")},o.createElement(kp.A,{className:"mx_QuickSettingsButton_icon"}),(0,c._t)("common|people")),o.createElement(ae.A,{className:"mx_QuickSettingsButton_moreOptionsButton mx_QuickSettingsButton_option",onClick:()=>{r(),x.A.dispatch({action:W.r.ViewUserSettings,initialTabId:We.v.Sidebar})}},o.createElement(Un,{className:"mx_QuickSettingsButton_icon"}),(0,c._t)("quick_settings|sidebar_settings"))),o.createElement(Bp,{requestClose:r}))),o.createElement(o.Fragment,null,o.createElement(ae.A,{className:me()("mx_QuickSettingsButton",{expanded:!e}),onClick:i,"aria-label":(0,c._t)("quick_settings|title"),title:e?(0,c._t)("quick_settings|title"):void 0,ref:n,"aria-expanded":!e},e?null:(0,c._t)("common|settings")),m)};var zp=n("./src/components/views/dialogs/InfoDialog.tsx"),Hp=n("./src/components/views/elements/ExternalLink.tsx");const Wp=e=>{const t=(0,o.useRef)(null),[n,i]=(0,o.useState)(""),[r,s]=(0,Go.X)(!1);(0,o.useEffect)(()=>{var e;null===(e=t.current)||void 0===e||e.focus()},[]);const a=()=>{e.onFinished(),R.Ay.createDialog(Gt.A,{})},l=!!d.Ay.get().bug_report_endpoint_url;let u,m;l&&(u=o.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},o.createElement("h3",null,(0,c._t)("feedback|comment_label")),o.createElement("p",null,(0,c._t)("feedback|platform_username")),o.createElement(wo.A,{id:"feedbackComment",label:(0,c._t)("common|feedback"),type:"text",autoComplete:"off",value:n,element:"textarea",onChange:e=>{i(e.target.value)},ref:t}),o.createElement(Io.A,{checked:r,onChange:s},(0,c._t)("feedback|may_contact_label")))),l&&(m=o.createElement("p",{className:"mx_FeedbackDialog_section_microcopy"},(0,c._t)("feedback|pro_type",{},{debugLogsLink:e=>o.createElement(ae.A,{kind:"link_inline",onClick:a},e)})));const h=d.Ay.getObject("feedback").get("existing_issues_url"),p=d.Ay.getObject("feedback").get("new_issue_url");return o.createElement(Wt.A,{className:"mx_FeedbackDialog",hasCancelButton:l,title:(0,c._t)("common|feedback"),description:o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},o.createElement("h3",null,(0,c._t)("common|report_a_bug")),o.createElement("p",null,(0,c._t)("feedback|existing_issue_link",{},{existingIssuesLink:e=>o.createElement(Hp.A,{target:"_blank",rel:"noreferrer noopener",href:h},e),newIssueLink:e=>o.createElement(Hp.A,{target:"_blank",rel:"noreferrer noopener",href:p},e)})),m),u),button:l?(0,c._t)("feedback|send_feedback_action"):(0,c._t)("action|go_back"),buttonDisabled:l&&!n,onFinished:t=>{if(l&&t){const t=e.feature?`${e.feature}-feedback`:"feedback";(0,ba.Wz)(t,n,r),R.Ay.createDialog(zp.A,{title:(0,c._t)("feedback|sent"),description:(0,c._t)("bug_reporting|thank_you")})}e.onFinished()}})};var Gp=function(e){return e[e.LOADING=0]="LOADING",e[e.NO_CRYPTO=1]="NO_CRYPTO",e[e.BACKUP_ACTIVE=2]="BACKUP_ACTIVE",e[e.SERVER_BACKUP_BUT_DISABLED=3]="SERVER_BACKUP_BUT_DISABLED",e[e.BACKUP_NO_RECOVERY=4]="BACKUP_NO_RECOVERY",e[e.NO_BACKUP=5]="NO_BACKUP",e[e.ERROR=6]="ERROR",e}(Gp||{});async function Kp(e){const t=null==e?void 0:e.getCrypto();if(!t)return!1;const n=e.getRooms();for(const e of n){if(await t.isEncryptionEnabledInRoom(e.roomId))return!0}return!1}class qp extends o.Component{constructor(e){super(e),(0,S.A)(this,"onExportE2eKeysClicked",()=>{R.Ay.createDialog((0,o.lazy)(()=>n.e(7692).then(n.bind(n,"./src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx"))),{matrixClient:f.J.safeGet()})}),(0,S.A)(this,"onFinished",e=>{e&&x.A.dispatch({action:"logout"}),this.props.onFinished(!!e)}),(0,S.A)(this,"onSetRecoveryMethodClick",()=>{const e={action:W.r.ViewUserSettings,initialTabId:We.v.Encryption};x.A.dispatch(e),this.props.onFinished(!0)}),(0,S.A)(this,"onLogoutConfirm",()=>{x.A.dispatch({action:"logout"}),this.props.onFinished(!0)}),this.state={backupStatus:Gp.LOADING}}componentDidMount(){this.startLoadBackupStatus()}startLoadBackupStatus(){this.loadBackupStatus().catch(e=>{s.vF.log("Unable to fetch key backup status",e),this.setState({backupStatus:Gp.ERROR})})}async loadBackupStatus(){const e=f.J.safeGet().getCrypto();if(!e)return void this.setState({backupStatus:Gp.NO_CRYPTO});if(null!==await e.getActiveSessionBackupVersion())return void(await e.isSecretStorageReady()?this.setState({backupStatus:Gp.BACKUP_ACTIVE}):this.setState({backupStatus:Gp.BACKUP_NO_RECOVERY}));const t=await e.getKeyBackupInfo();this.setState({backupStatus:t?Gp.SERVER_BACKUP_BUT_DISABLED:Gp.NO_BACKUP})}renderSetupRecoveryMethod(){const e=o.createElement("div",null,o.createElement("p",null,(0,c._t)("auth|logout_dialog|setup_secure_backup_description_1")),o.createElement("p",null,(0,c._t)("auth|logout_dialog|setup_secure_backup_description_2")),o.createElement("p",null,(0,c._t)("encryption|setup_secure_backup|explainer"))),t=o.createElement("div",null,o.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},e),o.createElement(Kt.A,{primaryButton:(0,c._t)("common|go_to_settings"),hasCancel:!1,onPrimaryButtonClick:this.onSetRecoveryMethodClick,focus:!0},o.createElement("button",{onClick:this.onLogoutConfirm},(0,c._t)("auth|logout_dialog|skip_key_backup"))),o.createElement("details",null,o.createElement("summary",{className:"mx_LogoutDialog_ExportKeyAdvanced"},(0,c._t)("common|advanced")),o.createElement("p",null,o.createElement("button",{onClick:this.onExportE2eKeysClicked},(0,c._t)("auth|logout_dialog|megolm_export")))));return o.createElement(X.A,{title:(0,c._t)("auth|logout_dialog|setup_key_backup_title"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},t)}render(){switch(this.state.backupStatus){case Gp.LOADING:return o.createElement(X.A,{title:(0,c._t)("action|sign_out"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},o.createElement(le.A,null));case Gp.NO_CRYPTO:case Gp.BACKUP_ACTIVE:return o.createElement(Wt.A,{hasCancelButton:!0,title:(0,c._t)("action|sign_out"),description:(0,c._t)("auth|logout_dialog|description"),button:(0,c._t)("action|sign_out"),onFinished:this.onFinished});case Gp.NO_BACKUP:case Gp.SERVER_BACKUP_BUT_DISABLED:case Gp.ERROR:case Gp.BACKUP_NO_RECOVERY:return this.renderSetupRecoveryMethod()}}}(0,S.A)(qp,"defaultProps",{onFinished:function(){}});var $p=n("./src/utils/WellKnownUtils.ts");function Jp(e,t){const n=new sa.Q(e).get("embedded_pages");let i=n?new sa.Q(n).get("home_url"):null;var r;(i||(i=e.welcomePageUrl,i&&s.vF.warn("You are using a deprecated config option: `welcomePageUrl`. Please use `embedded_pages.home_url` instead, per https://github.com/vector-im/element-web/issues/21428")),i)||(i=null===(r=(0,$p.qh)(t))||void 0===r?void 0:r.home_url);return i}var Yp=n("./src/stores/OwnProfileStore.ts"),Xp=n("./src/components/views/avatars/BaseAvatar.tsx"),Qp=n("./src/utils/Feedback.ts");class Zp extends o.Component{constructor(e){super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"themeWatcherRef",void 0),(0,S.A)(this,"dndWatcherRef",void 0),(0,S.A)(this,"buttonRef",(0,o.createRef)()),(0,S.A)(this,"onProfileUpdate",async()=>{this.forceUpdate()}),(0,S.A)(this,"onSelectedSpaceUpdate",async()=>{this.setState({selectedSpace:Ci.Ay.instance.activeSpaceRoom})}),(0,S.A)(this,"onThemeChanged",()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme()})}),(0,S.A)(this,"onAction",e=>{if(e.action===W.r.ToggleUserMenu)this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click()}),(0,S.A)(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:e.currentTarget.getBoundingClientRect()})}),(0,S.A)(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})}),(0,S.A)(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),(0,S.A)(this,"onSwitchThemeClick",e=>{e.preventDefault(),e.stopPropagation(),Si.A.trackInteraction("WebUserMenuThemeToggleButton",e),O.A.setValue("use_system_theme",null,F.p.DEVICE,!1);let t=this.state.isDarkTheme?"light":"dark";if(this.state.isHighContrast){const e=(0,Op.TJ)(t);e&&(t=e)}O.A.setValue("theme",null,F.p.DEVICE,t)}),(0,S.A)(this,"onSettingsOpen",(e,t,n)=>{e.preventDefault(),e.stopPropagation();const i={action:W.r.ViewUserSettings,initialTabId:t,props:n};x.A.dispatch(i),this.setState({contextMenuPosition:null})}),(0,S.A)(this,"onProvideFeedback",e=>{e.preventDefault(),e.stopPropagation(),R.Ay.createDialog(Wp),this.setState({contextMenuPosition:null})}),(0,S.A)(this,"onSignOutClick",async e=>{e.preventDefault(),e.stopPropagation(),await Kp(f.J.safeGet())?R.Ay.createDialog(qp):x.A.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})}),(0,S.A)(this,"onSignInClick",()=>{x.A.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})}),(0,S.A)(this,"onRegisterClick",()=>{x.A.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})}),(0,S.A)(this,"onHomeClick",e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.ViewHomePage}),this.setState({contextMenuPosition:null})}),(0,S.A)(this,"onWalletClick",async e=>{e.preventDefault(),e.stopPropagation();const t=await n.e(1615).then(n.bind(n,"./src/components/views/dialogs/DAOWalletDialog.tsx"));R.Ay.createDialog(t.default),this.setState({contextMenuPosition:null})}),(0,S.A)(this,"renderContextMenu",()=>{if(!this.state.contextMenuPosition)return null;let e,t,n;f.J.safeGet().isGuest()&&(e=o.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},(0,c._t)("auth|sign_in_prompt",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.onSignInClick},e)}),O.A.getValue(It.f.Registration)?(0,c._t)("auth|create_account_prompt",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.onRegisterClick},e)}):null)),this.hasHomePage&&(t=o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconHome",label:(0,c._t)("common|home"),onClick:this.onHomeClick})),(0,Qp.I)()&&(n=o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconMessage",label:(0,c._t)("common|feedback"),onClick:this.onProvideFeedback}));const i=o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconQr",label:(0,c._t)("user_menu|link_new_device"),onClick:e=>this.onSettingsOpen(e,We.v.SessionManager,{showMsc4108QrCode:!0})});let r=o.createElement(Qa.tx,null,t,i,o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconBell",label:(0,c._t)("notifications|enable_prompt_toast_title"),onClick:e=>this.onSettingsOpen(e,We.v.Notifications)}),o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconLock",label:(0,c._t)("room_settings|security|title"),onClick:e=>this.onSettingsOpen(e,We.v.Security)}),o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconWallet",label:"My Wallet",onClick:this.onWalletClick}),o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconSettings",label:(0,c._t)("user_menu|settings"),onClick:e=>this.onSettingsOpen(e)}),n,o.createElement(Qa.R$,{className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_UserMenu_iconSignOut",label:(0,c._t)("action|sign_out"),onClick:this.onSignOutClick}));f.J.safeGet().isGuest()&&(r=o.createElement(Qa.tx,null,t,o.createElement(Qa.R$,{iconClassName:"mx_UserMenu_iconSettings",label:(0,c._t)("common|settings"),onClick:e=>this.onSettingsOpen(e)}),n));const s=this.props.isPanelCollapsed?{left:(a=this.state.contextMenuPosition).width+a.left+8,top:a.top,chevronFace:Nn.t4.None}:(e=>({left:e.left,top:e.top+e.height,chevronFace:Nn.t4.None}))(this.state.contextMenuPosition);var a;const l=an.A.getDisplayUserIdentifier(f.J.safeGet().getSafeUserId(),{withDisplayName:!0});return o.createElement(Qa.Ay,(0,tn.A)({},s,{onFinished:this.onCloseMenu,className:"mx_UserMenu_contextMenu"}),o.createElement("div",{className:"mx_UserMenu_contextMenu_header"},o.createElement("div",{className:"mx_UserMenu_contextMenu_name"},o.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},Yp.V.instance.displayName),o.createElement("span",{className:"mx_UserMenu_contextMenu_userId",title:l||""},l)),o.createElement(mi.k,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.isDarkTheme?(0,c._t)("user_menu|switch_theme_light"):(0,c._t)("user_menu|switch_theme_dark")},o.createElement("img",{src:"img/element-icons/roomlist/dark-light-mode.475dde8.svg",role:"presentation",alt:"",width:16}))),e,r)}),this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme(),isHighContrast:this.isUserOnHighContrastTheme(),selectedSpace:Ci.Ay.instance.activeSpaceRoom}}get hasHomePage(){return!!Jp(d.Ay.get(),this.context.client)}componentDidMount(){Yp.V.instance.on(ha.H,this.onProfileUpdate),Ci.Ay.instance.on($a.tw,this.onSelectedSpaceUpdate),this.dispatcherRef=x.A.register(this.onAction),this.themeWatcherRef=O.A.watchSetting("theme",null,this.onThemeChanged)}componentWillUnmount(){O.A.unwatchSetting(this.themeWatcherRef),O.A.unwatchSetting(this.dndWatcherRef),x.A.unregister(this.dispatcherRef),Yp.V.instance.off(ha.H,this.onProfileUpdate),Ci.Ay.instance.off($a.tw,this.onSelectedSpaceUpdate)}isUserOnDarkTheme(){if(O.A.getValue("use_system_theme"))return window.matchMedia("(prefers-color-scheme: dark)").matches;{const e=O.A.getValue("theme");return e.startsWith("custom-")?!!(0,Op.TP)(e.substring(7)).is_dark:"dark"===e}}isUserOnHighContrastTheme(){if(O.A.getValue("use_system_theme"))return window.matchMedia("(prefers-contrast: more)").matches;{const e=O.A.getValue("theme");return!e.startsWith("custom-")&&(0,Op.AZ)(e)}}render(){const e=f.J.safeGet().getSafeUserId(),t=Yp.V.instance.displayName||e,n=Yp.V.instance.getHttpAvatarUrl(32);let i;return this.props.isPanelCollapsed||(i=o.createElement("div",{className:"mx_UserMenu_name"},t)),o.createElement("div",{className:"mx_UserMenu"},o.createElement(Nn.VJ,{className:"mx_UserMenu_contextMenuButton",onClick:this.onOpenMenuClick,ref:this.buttonRef,label:(0,c._t)("a11y|user_menu"),isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},o.createElement("div",{className:"mx_UserMenu_userAvatar"},o.createElement(Xp.A,{idName:e,name:t,url:n,size:"32px",className:"mx_UserMenu_userAvatar_BaseAvatar"})),i,this.renderContextMenu()),this.props.children)}}(0,S.A)(Zp,"contextType",as.A);const eg=["children","trackHorizontalOverflow","verticalScrollsHorizontally"];class tg extends o.Component{constructor(e){super(e),(0,S.A)(this,"autoHideScrollbar",(0,o.createRef)()),(0,S.A)(this,"scrollElement",void 0),(0,S.A)(this,"likelyTrackpadUser",null),(0,S.A)(this,"checkAgainForTrackpad",0),(0,S.A)(this,"collectScroller",e=>{var t,n;null===(t=(n=this.props).wrappedRef)||void 0===t||t.call(n,e),e&&!this.scrollElement&&(this.scrollElement=e,this.scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())}),(0,S.A)(this,"checkOverflow",()=>{if(!this.scrollElement)return;const e=this.scrollElement.scrollTop>0,t=this.scrollElement.scrollHeight>this.scrollElement.scrollTop+this.scrollElement.clientHeight,n=this.scrollElement.scrollLeft>0,i=this.scrollElement.scrollWidth>this.scrollElement.scrollLeft+this.scrollElement.clientWidth;e?this.scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this.scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),n?this.scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),i?this.scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:n?`${this.scrollElement.scrollLeft}px`:"0",rightIndicatorOffset:i?`-${this.scrollElement.scrollLeft}px`:"0"})}),(0,S.A)(this,"onMouseWheel",e=>{if(this.props.verticalScrollsHorizontally&&this.scrollElement){const t=0,n=1,i=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this.likelyTrackpadUser=!0,this.checkAgainForTrackpad=i+6e4):this.likelyTrackpadUser&&i>=this.checkAgainForTrackpad&&(this.likelyTrackpadUser=!1),this.likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,i=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this.scrollElement.scrollLeft+=i*n}}}),this.state={leftIndicatorOffset:"0",rightIndicatorOffset:"0"}}componentDidUpdate(e){o.Children.count(e.children)!==o.Children.count(this.props.children)&&this.checkOverflow()}componentDidMount(){this.checkOverflow(),Ja.A.instance.on(Ja.x.Resize,this.checkOverflow)}componentWillUnmount(){var e;null===(e=this.scrollElement)||void 0===e||e.removeEventListener("scroll",this.checkOverflow),Ja.A.instance.off(Ja.x.Resize,this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:n,verticalScrollsHorizontally:i}=e,r=(0,v.A)(e,eg),s={left:this.state.leftIndicatorOffset},a={right:this.state.rightIndicatorOffset},l=n?o.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:s}):null,c=n?o.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:a}):null;return o.createElement(Cr.A,(0,tn.A)({},r,{ref:this.autoHideScrollbar,wrappedRef:this.collectScroller,onWheel:this.onMouseWheel}),l,t,c)}}var ng=n("./node_modules/@vector-im/compound-web/dist/components/Menu/Menu.js"),ig=n("./node_modules/@vector-im/compound-web/dist/components/Menu/MenuItem.js"),rg=n("./node_modules/@vector-im/compound-web/dist/components/Button/IconButton/IconButton.js"),og=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Text.js");const sg=["displayLabel","notificationLevel","disableTooltip","ref"],ag=function(e){let{displayLabel:t,notificationLevel:n,disableTooltip:i,ref:r}=e,s=(0,v.A)(e,sg);const a=!i&&!t&&void 0;return o.createElement(rn.m,{label:(0,c._t)("common|threads"),placement:"right",open:a},o.createElement(rg.K,(0,tn.A)({"aria-label":(0,c._t)("common|threads"),className:me()("mx_ThreadsActivityCentreButton",{expanded:t}),indicator:(0,dr.W7)(n)},s,{ref:r}),o.createElement(o.Fragment,null,o.createElement(ar,{className:"mx_ThreadsActivityCentreButton_Icon"}),t&&o.createElement(og.E,{className:"mx_ThreadsActivityCentreButton_Text",as:"span",size:"md",title:(0,c._t)("common|threads")},(0,c._t)("common|threads")))))};var lg=n("./src/stores/right-panel/RightPanelStore.ts"),cg=n("./src/stores/right-panel/RightPanelStorePhases.ts"),dg=n("./src/Unread.ts"),ug=n("./src/stores/room-list/filters/VisibilityProvider.ts");function mg(e){const t=(0,Qt.ti)("feature_dynamic_room_predecessors"),n=(0,Qt.ti)("Notifications.tac_only_notifications"),r=(0,ce.nH)(),[s,a]=(0,o.useState)({greatestNotificationLevel:fp.S.None,rooms:[]}),l=(0,o.useCallback)(()=>{a(function(e,t,n){const i=e.getVisibleRooms(t);let r=fp.S.None;const o=[];for(const e of i)if(ug.W.instance.isRoomVisible(e)&&(0,dg.Nb)(e)){const t=(0,dr.gM)(e);if(n&&t<=fp.S.Activity)continue;t>r&&(r=t),o.push({room:e,notificationLevel:t})}const s=o.sort((e,t)=>function(e,t){var n,i;const{notificationLevel:r,room:o}=e,{notificationLevel:s,room:a}=t,l=null===(n=o.getLastThread())||void 0===n||null===(n=n.events.at(-1))||void 0===n?void 0:n.getTs(),c=null===(i=a.getLastThread())||void 0===i||null===(i=i.events.at(-1))||void 0===i?void 0:i.getTs();return r>s?-1:s>r?1:l?c?c-l:-1:1}(e,t));return{greatestNotificationLevel:r,rooms:s}}(r,t,n))},[r,t,n]),c=(0,o.useMemo)(()=>(0,Li.throttle)(l,500,{leading:!1,trailing:!0}),[l]);return(0,lr.ml)(r,i.ClientEvent.Sync,c),(0,lr.ml)(r,i.MatrixEventEvent.Decrypted,c),(0,o.useEffect)(()=>{e&&l()},[l,e]),s}function hg({displayButtonLabel:e}){const[t,n]=(0,o.useState)(!1),i=mg(t),r=(0,Qt.ti)("Notifications.tac_only_notifications")?(0,c._t)("threads_activity_centre|no_rooms_with_threads_notifs"):(0,c._t)("threads_activity_centre|no_rooms_with_unread_threads");return o.createElement("div",{className:"mx_ThreadsActivityCentre_container",onKeyDown:e=>{if(!t)return;(0,uo.zM)().getNavigationAction(e)===Ei.bY.FilterRooms&&e.stopPropagation()}},o.createElement(ng.W,{align:"start",side:"top",open:t,onOpenChange:e=>{e&&Si.A.trackInteraction("WebThreadsActivityCentreButton"),n(e)},title:(0,c._t)("threads_activity_centre|header"),trigger:o.createElement(ag,{displayLabel:e,notificationLevel:i.greatestNotificationLevel})},o.createElement("div",{className:"mx_ThreadsActivityCentre_rows"},i.rooms.map(({room:e,notificationLevel:t})=>o.createElement(pg,{key:e.roomId,room:e,notificationLevel:t,onClick:()=>n(!1)})),0===i.rooms.length&&o.createElement("div",{className:"mx_ThreadsActivityCentre_emptyCaption"},r))))}function pg({room:e,onClick:t,notificationLevel:n}){return o.createElement(ig.D,{className:"mx_ThreadsActivityCentreRow",onSelect:n=>{t(),lg.A.instance.setCard({phase:cg.n.ThreadPanel},!0,e.roomId),Si.A.trackInteraction("WebThreadsActivityCentreRoomItem",n),x.A.dispatch({action:W.r.ViewRoom,show_room_tile:!0,room_id:e.roomId,metricsTrigger:"WebThreadsActivityCentre",focusNext:"threadsPanel"})},label:e.name,Icon:o.createElement(to.A,{room:e,size:"32px"})},o.createElement(Nr.V,{level:n,count:0,symbol:null,forceDot:!0}))}var gg=n("./src/accessibility/LandmarkNavigation.ts"),vg=n("./src/components/views/settings/KeyboardShortcut.tsx");const fg=["onFinished","hideHeader"],_g=["selected","isPanelCollapsed","size"],yg=["children","isPanelCollapsed","setPanelCollapsed","isDraggingOver","innerRef"],bg=e=>{let{onFinished:t,hideHeader:n}=e,i=(0,v.A)(e,fg);const r=(0,Qt.ti)("Spaces.allRoomsInHome");return o.createElement(Qa.Ay,(0,tn.A)({},i,{onFinished:t,className:"mx_SpacePanel_contextMenu",compact:!0}),!n&&o.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},(0,c._t)("common|home")),o.createElement(Qa.tx,{first:!0},o.createElement(Qa.LS,{iconClassName:"mx_SpacePanel_noIcon",label:(0,c._t)("settings|sidebar|metaspaces_home_all_rooms"),active:r,onClick:()=>{t(),O.A.setValue("Spaces.allRoomsInHome",null,F.p.ACCOUNT,!r)}})))},Eg=e=>{let{selected:t,isPanelCollapsed:n,size:i="32px"}=e,r=(0,v.A)(e,_g);return o.createElement("li",{className:me()("mx_SpaceItem",{collapsed:n}),role:"treeitem","aria-selected":t},o.createElement(Ep,(0,tn.A)({},r,{selected:t,isNarrow:n,size:i})))},wg=()=>Ci.Ay.instance.allRoomsInHome?xp.n.instance.globalState:Ci.Ay.instance.getNotificationState($a._b.Home),Sg=({isPanelCollapsed:e,setPanelCollapsed:t})=>{const[n,i,r,s]=(0,Nn.EF)();let a;(0,o.useEffect)(()=>{!e&&n&&s()},[e]),n&&(a=o.createElement(pp.Ay,{onFinished:s}));const l=n?s:()=>{e||t(!0),r()};return o.createElement("li",{className:me()("mx_SpaceItem mx_SpaceItem_new",{collapsed:e}),role:"treeitem","aria-selected":!1},o.createElement(Ep,{className:me()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:n}),label:n?(0,c._t)("action|cancel"):"Create DAO",onClick:l,isNarrow:e,innerRef:i,size:"32px"}),a)},xg={[$a._b.Home]:({selected:e,isPanelCollapsed:t})=>{const n=(0,lr.dF)(Ci.Ay.instance,$a.EC,()=>Ci.Ay.instance.allRoomsInHome),[i,r]=(0,o.useState)(wg()),s=(0,o.useCallback)(()=>{r(wg())},[]);return(0,o.useEffect)(s,[s,n]),(0,lr.ml)(xp.n.instance,xp.N,s),o.createElement(Eg,{spaceKey:$a._b.Home,className:"mx_SpaceButton_home",selected:e,isPanelCollapsed:t,label:(0,$a.Ff)($a._b.Home,n),notificationState:i,ContextMenuComponent:bg,contextMenuTooltip:(0,c._t)("common|options"),size:"32px"})},[$a._b.Favourites]:({selected:e,isPanelCollapsed:t})=>o.createElement(Eg,{spaceKey:$a._b.Favourites,className:"mx_SpaceButton_favourites",selected:e,isPanelCollapsed:t,label:(0,$a.Ff)($a._b.Favourites),notificationState:Ci.Ay.instance.getNotificationState($a._b.Favourites),size:"32px"}),[$a._b.People]:({selected:e,isPanelCollapsed:t})=>o.createElement(Eg,{spaceKey:$a._b.People,className:"mx_SpaceButton_people",selected:e,isPanelCollapsed:t,label:(0,$a.Ff)($a._b.People),notificationState:Ci.Ay.instance.getNotificationState($a._b.People),size:"32px"}),[$a._b.Orphans]:({selected:e,isPanelCollapsed:t})=>o.createElement(Eg,{spaceKey:$a._b.Orphans,className:"mx_SpaceButton_orphans",selected:e,isPanelCollapsed:t,label:(0,$a.Ff)($a._b.Orphans),notificationState:Ci.Ay.instance.getNotificationState($a._b.Orphans),size:"32px"}),[$a._b.VideoRooms]:({selected:e,isPanelCollapsed:t})=>o.createElement(Eg,{spaceKey:$a._b.VideoRooms,className:"mx_SpaceButton_videoRooms",selected:e,isPanelCollapsed:t,label:(0,$a.Ff)($a._b.VideoRooms),notificationState:Ci.Ay.instance.getNotificationState($a._b.VideoRooms),size:"32px"})},Ag=o.memo(e=>{let{children:t,isPanelCollapsed:n,setPanelCollapsed:i,isDraggingOver:r,innerRef:s}=e,a=(0,v.A)(e,yg);const[l,d,u,m]=(()=>{const e=(0,lr.dF)(Ci.Ay.instance,$a.kQ,()=>Ci.Ay.instance.invitedSpaces),[t,n]=(0,lr.dF)(Ci.Ay.instance,$a.bZ,()=>[Ci.Ay.instance.enabledMetaSpaces,Ci.Ay.instance.spacePanelSpaces]);return[e,t,n,(0,lr.dF)(Ci.Ay.instance,$a.tw,()=>Ci.Ay.instance.activeSpace)]})(),h=m?[m]:[],p=d.filter(e=>!(e===$a._b.VideoRooms&&!O.A.getValue("feature_video_rooms"))).map(e=>{const t=xg[e];return o.createElement(t,{key:e,selected:m===e,isPanelCollapsed:n})});return o.createElement(tg,(0,tn.A)({},a,{wrappedRef:s,className:"mx_SpaceTreeLevel",style:r?{pointerEvents:"none"}:void 0,element:"ul",role:"tree","aria-label":(0,c._t)("common|spaces")}),p,l.map(e=>o.createElement(wp,{key:e.roomId,space:e,activeSpaces:h,isPanelCollapsed:n,onExpand:()=>i(!1)})),u.map((e,t)=>o.createElement(cp,{key:e.roomId,draggableId:e.roomId,index:t},(t,r)=>o.createElement(wp,(0,tn.A)({},t.draggableProps,{dragHandleProps:t.dragHandleProps,key:e.roomId,innerRef:t.innerRef,className:r.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:h,isPanelCollapsed:n,onExpand:()=>i(!1)})))),t,(0,Ya.g)(It.C.CreateSpaces)&&o.createElement(Sg,{isPanelCollapsed:n,setPanelCollapsed:i}))}),Cg=()=>{const[e,t]=(0,o.useState)(!1),[n,i]=(0,o.useState)(!0),r=(0,o.useRef)(null);(0,o.useLayoutEffect)(()=>(r.current&&Ja.A.instance.trackElementDimensions("SpacePanel",r.current),()=>Ja.A.instance.stopTrackingElementDimensions("SpacePanel")),[]),(0,Lo.F)(x.A,e=>{e.action===W.r.ToggleSpacePanel&&i(!n)});const s=(0,Qt.ti)("feature_new_room_list");return o.createElement(o.Fragment,null,o.createElement(mi.Se,{handleHomeEnd:!0,handleUpDown:!e},({onKeyDownHandler:e,onDragEndHandler:a})=>o.createElement(Rh,{onDragStart:()=>{t(!0)},onDragEnd:e=>{t(!1),e.destination&&(Ci.Ay.instance.moveRootSpace(e.source.index,e.destination.index),a())}},o.createElement("nav",{className:me()("mx_SpacePanel",{collapsed:n,newUi:s}),onKeyDown:t=>{const n=(0,uo.zM)().getNavigationAction(t);if(n===Ei.bY.NextLandmark||n===Ei.bY.PreviousLandmark)return gg.r.findAndFocusNextLandmark(gg.H.ACTIVE_SPACE_BUTTON,n===Ei.bY.PreviousLandmark),t.stopPropagation(),void t.preventDefault();e(t)},ref:r,"aria-label":(0,c._t)("common|spaces")},o.createElement(Zp,{isPanelCollapsed:n},o.createElement(ae.A,{className:me()("mx_SpacePanel_toggleCollapse",{expanded:!n}),onClick:()=>i(!n),title:n?(0,c._t)("action|expand"):(0,c._t)("action|collapse"),caption:o.createElement(vg.S,{value:{ctrlOrCmdKey:!0,shiftKey:!0,key:"d"},className:"mx_SpacePanel_Tooltip_KeyboardShortcut"})})),o.createElement(hp,{droppableId:"top-level-spaces"},(e,t)=>o.createElement(Ag,(0,tn.A)({},e.droppableProps,{isPanelCollapsed:n,setPanelCollapsed:i,isDraggingOver:t.isDraggingOver,innerRef:e.innerRef}),e.placeholder)),o.createElement(hg,{displayButtonLabel:!n}),o.createElement(jp,{isPanelCollapsed:n})))))},kg=e=>({left:e.left+window.scrollX,top:e.bottom+window.scrollY+12,chevronFace:Nn.t4.None});var Rg=function(e){return e[e.JoinRoom=0]="JoinRoom",e[e.BulkRedact=1]="BulkRedact",e}(Rg||{});const Ig=({onVisibilityChange:e})=>{var t,n,r;const s=(0,o.useContext)(ce.Ay),[a,l,d,u]=(0,Nn.EF)(),[m,h,p,g]=(0,Nn.EF)(),[v,f]=(0,lr.dF)(Ci.Ay.instance,$a.tw,()=>[Ci.Ay.instance.activeSpace,Ci.Ay.instance.activeSpaceRoom]),_=(0,lr.dF)(Ci.Ay.instance,$a.EC,()=>Ci.Ay.instance.allRoomsInHome),y=(0,Qt.ny)("feature_video_rooms"),b=(0,Qt.ny)("feature_element_call_video_rooms"),E=(()=>{const e=(0,o.useContext)(ce.Ay),[t,n]=(0,o.useState)(new Map),r=(e,i)=>{const r=new Set(t.get(e));r.add(i),n(new Map(t).set(e,r))},s=(e,i)=>{const r=new Set(t.get(e));r.delete(i)&&n(new Map(t).set(e,r))};return(0,Lo.F)(x.A,e=>{switch(e.action){case W.r.JoinRoom:r(Rg.JoinRoom,e.roomId);break;case W.r.JoinRoomReady:case W.r.JoinRoomError:s(Rg.JoinRoom,e.roomId);break;case W.r.BulkRedactStart:r(Rg.BulkRedact,e.roomId);break;case W.r.BulkRedactEnd:s(Rg.BulkRedact,e.roomId)}}),(0,lr.YK)(e,i.ClientEvent.Room,e=>s(Rg.JoinRoom,e.roomId)),t})(),w=f||v===$a._b.Home;(0,o.useEffect)(()=>{a&&!w&&u()},[u,w,a]);const S=(0,lr.DY)(null!=f?f:void 0,i.RoomEvent.Name,()=>null==f?void 0:f.name);(0,o.useEffect)(()=>{null==e||e()},[e]);const A=(0,Ya.g)(It.C.ExploreRooms),C=(0,Ya.g)(It.C.CreateRooms),k=(0,Ya.g)(It.C.CreateSpaces),R=(null==f||null===(t=f.currentState)||void 0===t||t.maySendStateEvent(i.EventType.SpaceChild,s.getUserId()),"GOV"===(null==f?void 0:f.name)||(null==f||null===(n=f.getCanonicalAlias())||void 0===n?void 0:n.includes("gov"))||(null==f?void 0:f.roomId.includes("gov"))),I="DCA"===(null==f?void 0:f.name)||(null==f||null===(r=f.getCanonicalAlias())||void 0===r?void 0:r.includes("dca"))||(null==f?void 0:f.roomId.includes("dca")),T=C||A||k||f;let P,N;if(a&&l.current){let e;e=f?el:bg,P=o.createElement(e,(0,tn.A)({},kg(l.current.getBoundingClientRect()),{space:f,onFinished:u,hideHeader:!0}))}else if(m&&f){let e,t;(0,ss.MI)(f)&&(e=o.createElement(Qa.R$,{label:(0,c._t)("action|invite"),iconClassName:"mx_LegacyRoomListHeader_iconInvite",onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ss.Lo)(f),g()}})),null!=f&&f.currentState.maySendStateEvent(i.EventType.RoomAvatar,s.getUserId())&&(t=o.createElement(o.Fragment,null,o.createElement(Qa.R$,{iconClassName:"mx_LegacyRoomListHeader_iconNewRoom",label:R?"New agenda":I?"New DCA":(0,c._t)("action|new_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ss.PT)(f),Si.A.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),g()}}),y&&o.createElement(Qa.R$,{iconClassName:"mx_LegacyRoomListHeader_iconNewVideoRoom",label:(0,c._t)("action|new_video_room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),(0,ss.PT)(f,b?i.RoomType.UnstableCall:i.RoomType.ElementVideo),g()}},o.createElement(Xa.s,null)))),P=o.createElement(Qa.Ay,(0,tn.A)({},kg(h.current.getBoundingClientRect()),{onFinished:g,compact:!0}),o.createElement(Qa.tx,{first:!0},e,t,o.createElement(Qa.R$,{label:(0,c._t)("action|explore_rooms"),iconClassName:"mx_LegacyRoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.ViewRoom,room_id:f.roomId,metricsTrigger:void 0}),g(),Si.A.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e)}})))}else if(m){let e,t;C&&(e=o.createElement(o.Fragment,null,o.createElement(Qa.R$,{label:(0,c._t)("action|start_new_chat"),iconClassName:"mx_LegacyRoomListHeader_iconStartChat",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.CreateChat}),Si.A.trackInteraction("WebRoomListHeaderPlusMenuCreateChatItem",e),g()}}),o.createElement(Qa.R$,{label:(0,c._t)("action|new_room"),iconClassName:"mx_LegacyRoomListHeader_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.CreateRoom}),Si.A.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),g()}}),y&&o.createElement(Qa.R$,{label:(0,c._t)("action|new_video_room"),iconClassName:"mx_LegacyRoomListHeader_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.CreateRoom,type:b?i.RoomType.UnstableCall:i.RoomType.ElementVideo}),g()}},o.createElement(Xa.s,null)))),A&&(t=o.createElement(Qa.R$,{label:(0,c._t)("room_list|join_public_room_label"),iconClassName:"mx_LegacyRoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.ViewRoomDirectory}),Si.A.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e),g()}})),P=o.createElement(Qa.Ay,(0,tn.A)({},kg(h.current.getBoundingClientRect()),{onFinished:g,compact:!0}),o.createElement(Qa.tx,{first:!0},e,t))}N=f&&S?S:(0,$a.Ff)(v,_);const D=[...E.entries()].filter(([e,t])=>t.size>0).map(([e,t])=>{switch(e){case Rg.JoinRoom:return(0,c._t)("room_list|joining_rooms_status",{count:t.size});case Rg.BulkRedact:return(0,c._t)("room_list|redacting_messages_status",{count:t.size})}}).join("\n");let M=o.createElement("div",{className:"mx_LegacyRoomListHeader_contextLessTitle"},N);if(w){const e={ref:l,onClick:d,isExpanded:a,className:"mx_LegacyRoomListHeader_contextMenuButton",children:N};M=f?o.createElement(Nn.VJ,(0,tn.A)({},e,{label:(0,c._t)("room_list|space_menu_label",{spaceName:null!=S?S:f.name})})):o.createElement(Nn.oW,(0,tn.A)({},e,{title:(0,c._t)("room_list|home_menu_label")}))}return o.createElement("aside",{className:"mx_LegacyRoomListHeader","aria-label":(0,c._t)("room|context_menu|title")},M,D?o.createElement(rn.m,{label:D,isTriggerInteractive:!1},o.createElement(tl.A,null)):null,T&&o.createElement(Nn.oW,{ref:h,onClick:p,isExpanded:m,className:"mx_LegacyRoomListHeader_plusButton",title:(0,c._t)("action|add")}),P)};var Tg=n("./src/stores/BreadcrumbsStore.ts"),Pg=n("./src/stores/room-list/RoomListStore.ts"),Ng=n("./node_modules/react-transition-group/esm/CSSTransition.js");const Dg=({room:e,onClick:t})=>{const[n,i,r]=(0,mi.A9)();return o.createElement(ae.A,{className:"mx_RoomBreadcrumbs_crumb",onClick:t,"aria-label":(0,c._t)("a11y|room_name",{name:e.name}),title:e.name,onFocus:n,ref:r,tabIndex:i?0:-1,placement:"right"},o.createElement(to.A,{room:e,size:"32px",displayBadge:!0,hideIfDot:!0,tooltipProps:{tabIndex:i?0:-1}}))};class Mg extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"toolbar",(0,o.createRef)()),(0,S.A)(this,"onBreadcrumbsUpdate",()=>{this.unmounted||(this.setState({doAnimation:!1,skipFirst:!0}),window.setTimeout(()=>this.setState({doAnimation:!0,skipFirst:!1}),0))}),(0,S.A)(this,"viewRoom",(e,t,n=!1)=>{x.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:"WebHorizontalBreadcrumbs",metricsViaKeyboard:n})}),this.state={doAnimation:!0,skipFirst:!1}}componentDidMount(){this.unmounted=!1,Tg.Y.instance.on(ha.H,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.unmounted=!0,Tg.Y.instance.off(ha.H,this.onBreadcrumbsUpdate)}render(){const e=Tg.Y.instance.rooms.map((e,t)=>o.createElement(Dg,{key:e.roomId,room:e,onClick:n=>this.viewRoom(e,t,"click"!==n.type)}));return e.length>0?o.createElement(Ng.A,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs",nodeRef:this.toolbar},o.createElement(ui.A,{className:"mx_RoomBreadcrumbs","aria-label":(0,c._t)("room_list|breadcrumbs_label"),ref:this.toolbar},e.slice(this.state.skipFirst?1:0))):o.createElement("div",{className:"mx_RoomBreadcrumbs"},o.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},(0,c._t)("room_list|breadcrumbs_empty")))}}function Og(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12 13a.97.97 0 0 1-.713-.287A.97.97 0 0 1 11 12q0-.424.287-.713A.97.97 0 0 1 12 11q.424 0 .713.287.287.288.287.713 0 .424-.287.713A.97.97 0 0 1 12 13m0 9a9.7 9.7 0 0 1-3.9-.788 10.1 10.1 0 0 1-3.175-2.137q-1.35-1.35-2.137-3.175A9.7 9.7 0 0 1 2 12q0-2.075.788-3.9a10.1 10.1 0 0 1 2.137-3.175q1.35-1.35 3.175-2.137A9.7 9.7 0 0 1 12 2q2.075 0 3.9.788a10.1 10.1 0 0 1 3.175 2.137q1.35 1.35 2.137 3.175A9.7 9.7 0 0 1 22 12a9.7 9.7 0 0 1-.788 3.9 10.1 10.1 0 0 1-2.137 3.175q-1.35 1.35-3.175 2.137A9.7 9.7 0 0 1 12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4 6.325 6.325 4 12t2.325 5.675T12 20m0 0q-3.35 0-5.675-2.325T4 12t2.325-5.675T12 4t5.675 2.325T20 12t-2.325 5.675T12 20m1.675-5.85q.15-.075.275-.2t.2-.275l2.925-6.25q.125-.25-.062-.437-.188-.188-.438-.063l-6.25 2.925q-.15.075-.275.2t-.2.275l-2.925 6.25q-.125.25.063.438.186.186.437.062z"})})}Og.displayName="ExploreIcon";const Fg=(0,o.forwardRef)(Og);var Lg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/search.js");function Ug(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12 18.6c-.99 0-1.8.81-1.8 1.8s.81 1.8 1.8 1.8 1.8-.81 1.8-1.8-.81-1.8-1.8-1.8M6.6 2.4c-.99 0-1.8.81-1.8 1.8S5.61 6 6.6 6s1.8-.81 1.8-1.8-.81-1.8-1.8-1.8m0 5.4c-.99 0-1.8.81-1.8 1.8s.81 1.8 1.8 1.8 1.8-.81 1.8-1.8-.81-1.8-1.8-1.8m0 5.4c-.99 0-1.8.81-1.8 1.8s.81 1.8 1.8 1.8 1.8-.81 1.8-1.8-.81-1.8-1.8-1.8M17.4 6c.99 0 1.8-.81 1.8-1.8s-.81-1.8-1.8-1.8-1.8.81-1.8 1.8.81 1.8 1.8 1.8M12 13.2c-.99 0-1.8.81-1.8 1.8s.81 1.8 1.8 1.8 1.8-.81 1.8-1.8-.81-1.8-1.8-1.8m5.4 0c-.99 0-1.8.81-1.8 1.8s.81 1.8 1.8 1.8 1.8-.81 1.8-1.8-.81-1.8-1.8-1.8m0-5.4c-.99 0-1.8.81-1.8 1.8s.81 1.8 1.8 1.8 1.8-.81 1.8-1.8-.81-1.8-1.8-1.8m-5.4 0c-.99 0-1.8.81-1.8 1.8s.81 1.8 1.8 1.8 1.8-.81 1.8-1.8-.81-1.8-1.8-1.8m0-5.4c-.99 0-1.8.81-1.8 1.8S11.01 6 12 6s1.8-.81 1.8-1.8-.81-1.8-1.8-1.8"})})}Ug.displayName="DialPadIcon";const Bg=(0,o.forwardRef)(Ug);function Vg({activeSpace:e}){const t=e===$a._b.Home&&(0,Ya.g)(It.C.ExploreRooms),n=(0,lr.DY)(jt.Ay.instance,jt.uv.ProtocolSupport,()=>jt.Ay.instance.getSupportsPstnProtocol());return o.createElement(Fe.s,{className:"mx_RoomListSearch",role:"search",gap:"var(--cpd-space-2x)",align:"center"},o.createElement(Ae.$,{className:"mx_RoomListSearch_search",kind:"secondary",size:"sm",Icon:Lg.A,onClick:()=>x.A.fire(W.r.OpenSpotlight)},o.createElement(Fe.s,{as:"span",justify:"space-between"},o.createElement("span",{className:"mx_RoomListSearch_search_text"},(0,c._t)("action|search")),o.createElement("kbd",null,bi.vL?" K":(0,c._t)(Ei.hm[bi.Uz.CONTROL])+" K"))),n&&o.createElement(Ae.$,{kind:"secondary",size:"sm",Icon:Bg,iconOnly:!0,"aria-label":(0,c._t)("left_panel|open_dial_pad"),onClick:e=>{x.A.fire(W.r.OpenDialPad)}}),t&&o.createElement(Ae.$,{kind:"secondary",size:"sm",Icon:Fg,iconOnly:!0,"aria-label":(0,c._t)("action|explore_rooms"),onClick:e=>{x.A.fire(W.r.ViewRoomDirectory),Si.A.trackInteraction("WebLeftPanelExploreRoomsButton",e)}}))}function jg(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{fillRule:"evenodd",d:"M16.937 2.82a2 2 0 0 1 2.828 0l1.415 1.414a2 2 0 0 1 0 2.829l-7.071 7.07c-.195.196-.42.342-.66.44a1 1 0 0 1-.168.072l-3.993 1.331a1 1 0 0 1-1.265-1.265l1.331-3.992q.03-.09.073-.168m10.338-4.903-6.717 6.718-1.414-1.414 6.717-6.718z",clipRule:"evenodd"}),(0,$.jsx)("path",{d:"M3 5a2 2 0 0 1 2-2h6a1 1 0 1 1 0 2H5v14h14v-6a1 1 0 1 1 2 0v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"})]})}jg.displayName="ComposeIcon";const zg=(0,o.forwardRef)(jg);var Hg=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/user-add.js");function Wg(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12 14.95q-.2 0-.375-.062a.9.9 0 0 1-.325-.213l-4.6-4.6a.95.95 0 0 1-.275-.7q0-.425.275-.7a.95.95 0 0 1 .7-.275q.425 0 .7.275l3.9 3.9 3.9-3.9a.95.95 0 0 1 .7-.275q.425 0 .7.275a.95.95 0 0 1 .275.7.95.95 0 0 1-.275.7l-4.6 4.6q-.15.15-.325.212a1.1 1.1 0 0 1-.375.063"})})}Wg.displayName="ChevronDownIcon";const Gg=(0,o.forwardRef)(Wg);function Kg(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"m8.566 17-.944 4.094q-.086.406-.372.656t-.687.25q-.543 0-.887-.469a1.18 1.18 0 0 1-.2-1.031l.801-3.5H3.158q-.572 0-.916-.484a1.27 1.27 0 0 1-.2-1.078 1.12 1.12 0 0 1 1.116-.938H6.85l1.145-5h-3.12q-.57 0-.915-.484a1.27 1.27 0 0 1-.2-1.078A1.12 1.12 0 0 1 4.875 7h3.691l.945-4.094q.085-.406.372-.656.286-.25.686-.25.544 0 .887.469.345.468.2 1.031l-.8 3.5h4.578l.944-4.094q.085-.406.372-.656.286-.25.687-.25.543 0 .887.469t.2 1.031L17.723 7h3.119q.573 0 .916.484.343.485.2 1.079a1.12 1.12 0 0 1-1.116.937H17.15l-1.145 5h3.12q.57 0 .915.484.343.485.2 1.079a1.12 1.12 0 0 1-1.116.937h-3.691l-.944 4.094q-.087.406-.373.656t-.686.25q-.544 0-.887-.469a1.18 1.18 0 0 1-.2-1.031l.8-3.5zm.573-2.5h4.578l1.144-5h-4.578z"})})}Kg.displayName="RoomIcon";const qg=(0,o.forwardRef)(Kg);function $g(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{fillRule:"evenodd",d:"M16 11v8h3V9.177l-7-3.889-7 3.889V19h3v-8zm-6 10H5a2 2 0 0 1-2-2V9.177a2 2 0 0 1 1.029-1.748l7-3.89a2 2 0 0 1 1.942 0l7 3.89A2 2 0 0 1 21 9.177V19a2 2 0 0 1-2 2h-5v-8h-4z",clipRule:"evenodd"})})}$g.displayName="HomeIcon";const Jg=(0,o.forwardRef)($g);function Yg(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{fillRule:"evenodd",d:"M6.5 2h11a4.5 4.5 0 1 1 0 9h-11a4.5 4.5 0 0 1 0-9m0 2h7.258A4.5 4.5 0 0 0 13 6.5c0 .925.28 1.785.758 2.5H6.5a2.5 2.5 0 0 1 0-5M15 6.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0m-13 11A4.5 4.5 0 0 1 6.5 13h11a4.5 4.5 0 1 1 0 9h-11q-.233 0-.46-.023A4.5 4.5 0 0 1 2 17.5m8.242-2.5H17.5a2.5 2.5 0 0 1 0 5h-7.258A4.5 4.5 0 0 0 11 17.5c0-.925-.28-1.785-.758-2.5M6.5 15a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5",clipRule:"evenodd"})})}Yg.displayName="PreferencesIcon";const Xg=(0,o.forwardRef)(Yg);function Qg(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0m-2 0a2 2 0 1 0-4 0 2 2 0 0 0 4 0"}),(0,$.jsx)("path",{d:"M11.312 2h1.376A2.31 2.31 0 0 1 15 4.312v.247l.002.003c.01.014.031.033.064.047.03.013.056.013.07.01h.002l.177-.177a2.31 2.31 0 0 1 3.27 0l.973.974a2.31 2.31 0 0 1 0 3.269l-.177.177v.003a.13.13 0 0 0 .01.07.15.15 0 0 0 .047.063l.003.002h.247A2.31 2.31 0 0 1 22 11.312v1.376A2.31 2.31 0 0 1 19.688 15h-.247l-.003.002a.15.15 0 0 0-.047.064.13.13 0 0 0-.01.07v.002l.177.177a2.31 2.31 0 0 1 0 3.27l-.974.973a2.31 2.31 0 0 1-3.269 0l-.177-.177h-.003a.13.13 0 0 0-.07.01.15.15 0 0 0-.063.047l-.002.003v.247A2.31 2.31 0 0 1 12.688 22h-1.376A2.31 2.31 0 0 1 9 19.688v-.247l-.002-.003a.15.15 0 0 0-.064-.047.13.13 0 0 0-.07-.01h-.002l-.177.177a2.31 2.31 0 0 1-3.27 0l-.973-.974a2.31 2.31 0 0 1 0-3.269l.177-.177v-.003a.14.14 0 0 0-.01-.07.15.15 0 0 0-.047-.063L4.559 15h-.247A2.31 2.31 0 0 1 2 12.688v-1.376A2.31 2.31 0 0 1 4.312 9h.247l.003-.002a.15.15 0 0 0 .047-.064.14.14 0 0 0 .01-.07v-.002l-.177-.177a2.31 2.31 0 0 1 0-3.27l.974-.973a2.31 2.31 0 0 1 3.269 0l.177.177h.003a.14.14 0 0 0 .07-.01.15.15 0 0 0 .063-.047L9 4.559v-.247A2.31 2.31 0 0 1 11.312 2M11 4.312v.257c0 .893-.59 1.593-1.299 1.887-.716.297-1.622.21-2.248-.418l-.182-.182a.31.31 0 0 0-.441 0l-.974.974a.31.31 0 0 0 0 .44l.182.183c.627.626.715 1.531.418 2.248C6.162 10.41 5.462 11 4.569 11h-.257a.31.31 0 0 0-.312.312v1.376c0 .172.14.312.312.312h.257c.893 0 1.593.59 1.887 1.299.297.716.21 1.622-.418 2.248l-.182.182a.31.31 0 0 0 0 .441l.974.973a.31.31 0 0 0 .44 0l.183-.181c.626-.627 1.532-.715 2.248-.418.709.294 1.299.994 1.299 1.887v.257c0 .172.14.312.312.312h1.376c.172 0 .312-.14.312-.312v-.257c0-.893.59-1.593 1.299-1.887.716-.297 1.622-.21 2.249.418l.181.181c.122.122.32.122.441 0l.973-.973a.31.31 0 0 0 0-.44l-.181-.183c-.627-.626-.715-1.532-.418-2.248.294-.709.994-1.299 1.887-1.299h.257c.172 0 .312-.14.312-.312v-1.376a.31.31 0 0 0-.312-.312h-.257c-.893 0-1.593-.59-1.887-1.299-.297-.717-.21-1.622.418-2.248l.181-.182a.31.31 0 0 0 0-.441l-.973-.974a.31.31 0 0 0-.44 0l-.183.182c-.626.627-1.532.715-2.248.418C13.59 6.162 13 5.462 13 4.569v-.257A.31.31 0 0 0 12.688 4h-1.376a.31.31 0 0 0-.312.312"})]})}Qg.displayName="SettingsIcon";const Zg=(0,o.forwardRef)(Qg);function ev(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M2 8a4 4 0 0 1 4-4h10a2 2 0 0 1 2 2v4.286l3.35-2.871a1 1 0 0 1 1.65.76v7.65a1 1 0 0 1-1.65.76L18 13.715V18a2 2 0 0 1-2 2H6a4 4 0 0 1-4-4zm4-2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10V6zm15 7.652v-3.303L19.073 12z"})})}ev.displayName="VideoCallIcon";const tv=(0,o.forwardRef)(ev);var nv=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chat.js"),iv=n("./src/utils/membership.ts");function rv(e){return e.getMyMembership()===i.KnownMembership.Invite||e.getMyMembership()!==i.KnownMembership.Knock&&!(0,iv.yE)(e)&&(0,Ya.g)(It.C.RoomOptionsMenu)}function ov(e,t,n){return!t&&!n&&rv(e)}async function sv(e){e?await(0,ss.PT)(e):x.A.fire(W.r.CreateRoom)}function av(e,t){var n;const r=(0,Ya.g)(It.C.CreateRooms);return t&&r?Boolean(null==t||null===(n=t.getLiveTimeline().getState(i.EventTimeline.FORWARDS))||void 0===n?void 0:n.maySendStateEvent(i.EventType.RoomAvatar,e.getSafeUserId())):r}class lv{constructor(e){(0,S.A)(this,"_isInActiveSpace",!1),(0,S.A)(this,"next",[]),(0,S.A)(this,"previous",[]),(0,S.A)(this,"filterKeysSet",new Set),this.room=e}get isInActiveSpace(){return this._isInActiveSpace}checkIfRoomBelongsToActiveSpace(){const e=Ci.Ay.instance.activeSpace;this._isInActiveSpace=Ci.Ay.instance.isRoomInSpace(e,this.room.roomId)}doesRoomMatchFilters(e){return!e.some(e=>!this.filterKeysSet.has(e))}applyFilters(e){this.filterKeysSet=new Set;for(const t of e)t.matches(this.room)&&this.filterKeysSet.add(t.key)}}function cv(){return Math.random()<.5}class dv{get size(){return this._size}constructor(e){(0,S.A)(this,"head",void 0),(0,S.A)(this,"current",void 0),(0,S.A)(this,"_size",0),this.level=e}setNext(e){this.head||(this.head=e),this.current?(e.previous[this.level]=this.current,this.current.next[this.level]=e,this.current=e):this.current=e,this._size++}generateNextLevel(){const e=new dv(this.level+1);let t=this.head;for(;t;)cv()&&e.setNext(t),t=t.next[this.level];return e}removeNode(e){if(!(this.head===e||e.previous[this.level]))return;const t=e.previous[this.level];if(t){const n=e.next[this.level];t.next[this.level]=n,n&&(n.previous[this.level]=t)}else{const t=e.next[this.level];this.head=t,t&&(t.previous[this.level]=e.previous[this.level])}this._size--}insertAfter(e,t){const n=this.level,i=e.next[n];i&&(t.next[n]=i,i.previous[n]=t),e.next[n]=t,t.previous[n]=e,this._size++}insertAtHead(e){const t=this.head;this.head=e,t&&(e.next[this.level]=t,t.previous[this.level]=e),this._size++}}class uv{constructor(e){this.current=e}next(){const e=this.current;return e?(this.current=e.next[0],{value:e.room}):{value:void 0,done:!0}}}class mv{constructor(e,t){this.current=e,this.filters=t}[Symbol.iterator](){return this}next(){let e=this.current;for(;e&&(!e.isInActiveSpace||!e.doesRoomMatchFilters(this.filters));)e=e.next[0];return e?(this.current=e.next[0],{value:e.room}):{value:void 0,done:!0}}}class hv{constructor(e,t=[]){(0,S.A)(this,"levels",[new dv(0)]),(0,S.A)(this,"roomNodeMap",new Map),(0,S.A)(this,"initialized",!1),this.sorter=e,this.filters=t}reset(){this.levels=[new dv(0)],this.roomNodeMap=new Map}seed(e){const t=this.sorter.sort(e).map(e=>new lv(e));let n=this.levels[0];for(const e of t)e.applyFilters(this.filters),n.setNext(e),this.roomNodeMap.set(e.room.roomId,e);do{this.levels[n.level]=n,n=n.generateNextLevel()}while(n.size>1);this.calculateActiveSpaceForNodes(),this.initialized=!0}calculateActiveSpaceForNodes(){for(const e of this.roomNodeMap.values())e.checkIfRoomBelongsToActiveSpace()}useNewSorter(e,t){this.reset(),this.sorter=e,this.seed(t)}removeRoom(e){const t=this.roomNodeMap.get(e.roomId);if(this.roomNodeMap.delete(e.roomId),t)for(const e of this.levels)e.removeNode(t)}reInsertRoom(e){this.roomNodeMap.has(e.roomId)&&(this.removeRoom(e),this.addNewRoom(e))}addNewRoom(e){if(this.roomNodeMap.has(e.roomId))throw new Error(`Can't add room to skiplist: ${e.roomId} is already in the skiplist!`);this.insertRoom(e)}insertRoom(e){const t=new lv(e);t.checkIfRoomBelongsToActiveSpace(),t.applyFilters(this.filters),this.roomNodeMap.set(e.roomId,t);const n=[];for(let t=this.levels.length-1;t>=0;--t){const i=this.levels[t];if(!i.head){n[t]=null;continue}let r=i.head,o=null;for(;r&&this.sorter.comparator(r.room,e)<0;)o=r,r=r.next[t];n[t]=o}for(const[e,i]of n.entries()){if(0!==e&&!cv())break;{const n=this.levels[e];i?n.insertAfter(i,t):n.insertAtHead(t)}}}[Symbol.iterator](){return new uv(this.levels[0].head)}getRoomsInActiveSpace(e=[]){return new mv(this.levels[0].head,e)}get size(){return this.levels[0].size}get activeSortAlgorithm(){return this.sorter.type}}var pv=n("./src/stores/room-list-v3/skip-list/sorters/index.ts");class gv{constructor(e){this.myUserId=e}sort(e){const t={};return[...e].sort((e,n)=>this.comparator(e,n,t))}comparator(e,t,n){const i=this.getScore(e)-this.getScore(t);if(0!==i)return i;const r=this.getTs(e,n);return this.getTs(t,n)-r}get type(){return pv.U.Recency}getScore(e){const t=!!e.tags[za.DefaultTagID.LowPriority],n=xp.n.instance.getRoomState(e).muted;return n&&t?5:n?10:t?2:0}getTs(e,t){var n;const i=null!==(n=null==t?void 0:t[e.roomId])&&void 0!==n?n:(0,no.Qi)(e,this.myUserId);return t&&(t[e.roomId]=i),i}}class vv{constructor(){(0,S.A)(this,"collator",new Intl.Collator)}sort(e){return[...e].sort((e,t)=>this.comparator(e,t))}comparator(e,t){return this.collator.compare(e.name,t.name)}get type(){return pv.U.Alphabetic}}var fv=n("./src/utils/read-receipts.ts");let _v=function(e){return e[e.FavouriteFilter=0]="FavouriteFilter",e[e.UnreadFilter=1]="UnreadFilter",e[e.PeopleFilter=2]="PeopleFilter",e[e.RoomsFilter=3]="RoomsFilter",e[e.LowPriorityFilter=4]="LowPriorityFilter",e[e.MentionsFilter=5]="MentionsFilter",e[e.InvitesFilter=6]="InvitesFilter",e}({});var yv=n("./src/stores/room-list/utils/roomMute.ts");const bv=[new class{matches(e){return!!e.tags[za.DefaultTagID.Favourite]}get key(){return _v.FavouriteFilter}},new class{matches(e){return xp.n.instance.getRoomState(e).hasUnreadCount||!!(0,dr.nx)(e)}get key(){return _v.UnreadFilter}},new class{matches(e){return!!k.A.shared().getUserIdForRoomId(e.roomId)}get key(){return _v.PeopleFilter}},new class{matches(e){return!k.A.shared().getUserIdForRoomId(e.roomId)}get key(){return _v.RoomsFilter}},new class{matches(e){return e.getMyMembership()===i.KnownMembership.Invite}get key(){return _v.InvitesFilter}},new class{matches(e){return xp.n.instance.getRoomState(e).isMention}get key(){return _v.MentionsFilter}},new class{matches(e){return!!e.tags[za.DefaultTagID.LowPriority]}get key(){return _v.LowPriorityFilter}}];let Ev=function(e){return e.ListsUpdate="lists_update",e.ListsLoaded="lists_loaded",e}({});const wv=Ev.ListsUpdate,Sv=Ev.ListsLoaded;class xv extends Ea.r{constructor(e){super(e),(0,S.A)(this,"roomSkipList",void 0),(0,S.A)(this,"msc3946ProcessDynamicPredecessor",void 0),this.msc3946ProcessDynamicPredecessor=O.A.getValue("feature_dynamic_room_predecessors"),Ci.Ay.instance.on($a.tw,()=>{this.onActiveSpaceChanged()}),Ci.Ay.instance.on($a.EC,()=>this.onActiveSpaceChanged())}getRooms(){var e,t;let n=null!==(e=null===(t=this.matrixClient)||void 0===t?void 0:t.getVisibleRooms(this.msc3946ProcessDynamicPredecessor))&&void 0!==e?e:[];return n=n.filter(e=>ug.W.instance.isRoomVisible(e)),n}get isLoadingRooms(){var e;return!(null!==(e=this.roomSkipList)&&void 0!==e&&e.initialized)}getSortedRooms(){var e;return null!==(e=this.roomSkipList)&&void 0!==e&&e.initialized?Array.from(this.roomSkipList):[]}getSortedRoomsInActiveSpace(e){var t;const n=Ci.Ay.instance.activeSpace;return null!==(t=this.roomSkipList)&&void 0!==t&&t.initialized?{spaceId:n,filterKeys:e,rooms:Array.from(this.roomSkipList.getRoomsInActiveSpace(e))}:{spaceId:n,filterKeys:e,rooms:[]}}resort(e){if(!this.roomSkipList)throw new Error("Cannot resort room list before skip list is created.");if(!this.matrixClient)throw new Error("Cannot resort room list without matrix client.");if(this.roomSkipList.activeSortAlgorithm===e)return;const t=e===pv.U.Alphabetic?new vv:new gv(this.matrixClient.getSafeUserId());this.roomSkipList.useNewSorter(t,this.getRooms()),this.emit(wv),O.A.setValue("RoomList.preferredSorting",null,F.p.DEVICE,e)}get activeSortAlgorithm(){var e;return null===(e=this.roomSkipList)||void 0===e?void 0:e.activeSortAlgorithm}async onReady(){var e;if(null!==(e=this.roomSkipList)&&void 0!==e&&e.initialized||!this.matrixClient)return;const t=this.getPreferredSorter(this.matrixClient.getSafeUserId());this.roomSkipList=new hv(t,bv),await Ci.Ay.instance.storeReadyPromise;const n=this.getRooms();this.roomSkipList.seed(n),this.emit(Sv),this.emit(wv)}async onAction(e){var t;if(this.matrixClient&&null!==(t=this.roomSkipList)&&void 0!==t&&t.initialized)switch(e.action){case"MatrixActions.Room.receipt":if((0,fv.A)(e.event,this.matrixClient)){const t=e.room;if(!t)return void s.vF.warn(`Own read receipt was in unknown room ${t.roomId}`);this.addRoomAndEmit(t)}break;case"MatrixActions.Room.tags":{const t=e.room;this.addRoomAndEmit(t);break}case"MatrixActions.Room.accountData":{const t=e.event_type;if(t===dr.uk||t===dr.HG){const t=e.room;this.addRoomAndEmit(t)}break}case"MatrixActions.Event.decrypted":{const t=e.event.getRoomId();if(!t)return;const n=this.matrixClient.getRoom(t);if(!n)return void s.vF.warn(`Event ${e.event.getId()} was decrypted in an unknown room ${t}`);this.addRoomAndEmit(n);break}case"MatrixActions.accountData":this.handleAccountDataPayload(e);break;case"MatrixActions.Room.timeline":if(!e.isLiveEvent||!e.isLiveUnfilteredRoomTimelineEvent||!e.room)return;this.addRoomAndEmit(e.room);break;case"MatrixActions.Room.myMembership":{var n;const t=(0,iv.Cs)(e.oldMembership),o=(0,iv.E3)(e.room,e.membership),a=this.matrixClient.getSafeUserId();if(null===(n=e.room.getMember(a))||void 0===n?void 0:n.isKicked())return void this.addRoomAndEmit(e.room);if((e.oldMembership===i.KnownMembership.Invite||e.oldMembership===i.KnownMembership.Join)&&e.membership===i.KnownMembership.Leave)return this.roomSkipList.removeRoom(e.room),void this.emit(wv);if(t!==iv._T.Join&&o===iv._T.Join){const t=e.room.currentState.findPredecessor(this.msc3946ProcessDynamicPredecessor);if(t){var r;const e=null===(r=this.matrixClient)||void 0===r?void 0:r.getRoom(t.roomId);e?this.roomSkipList.removeRoom(e):s.vF.warn(`Unable to find predecessor room with id ${t.roomId}`)}}this.addRoomAndEmit(e.room,!0);break}case W.r.AfterForgetRoom:{const t=e.room;this.roomSkipList.removeRoom(t),this.emit(wv);break}}}handleAccountDataPayload(e){let t=!1;switch(e.event_type){case i.EventType.Direct:{const n=e.event.getContent();for(const e of Object.keys(n)){const i=n[e];for(const e of i){const n=this.matrixClient.getRoom(e);n?(this.roomSkipList.reInsertRoom(n),t=!0):s.vF.warn(`${e} was found in DMs but the room is not in the store`)}}break}case i.EventType.PushRules:{const n=(0,yv.Q)(e);if(!n)return;const i=n.map(e=>{var t;return null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e)}).filter(e=>!!e);for(const e of i)this.roomSkipList.reInsertRoom(e),t=!0;break}}t&&this.emit(wv)}getPreferredSorter(e){switch(O.A.getValue("RoomList.preferredSorting")){case pv.U.Alphabetic:return new vv;case pv.U.Recency:return new gv(e);default:throw new Error("Got unknown sort preference from RoomList.preferredSorting setting")}}addRoomAndEmit(e,t=!1){if(!this.roomSkipList)throw new Error("roomSkipList hasn't been created yet!");if(t){if(!ug.W.instance.isRoomVisible(e))return void s.vF.info(`RoomListStoreV3: Refusing to add new room ${e.roomId} because isRoomVisible returned false.`);this.roomSkipList.addNewRoom(e)}else this.roomSkipList.reInsertRoom(e);this.emit(wv)}onActiveSpaceChanged(){this.roomSkipList&&(this.roomSkipList.calculateActiveSpaceForNodes(),this.emit(wv))}}class Av{static get instance(){if(!Av.internalInstance){const e=new xv(x.A);e.start(),Av.internalInstance=e}return this.internalInstance}}(0,S.A)(Av,"internalInstance",void 0),window.mxRoomListStoreV3=Av.instance;let Cv=function(e){return e[e.Activity=pv.U.Recency]="Activity",e[e.AToZ=pv.U.Alphabetic]="AToZ",e}({});const kv={[pv.U.Alphabetic]:Cv.AToZ,[pv.U.Recency]:Cv.Activity},Rv={[Cv.AToZ]:pv.U.Alphabetic,[Cv.Activity]:pv.U.Recency};function Iv(){const e=(0,ce.nH)(),{activeSpace:t,title:n}=function(){const[e,t]=(0,lr.dF)(Ci.Ay.instance,$a.tw,()=>[Ci.Ay.instance.activeSpace,Ci.Ay.instance.activeSpaceRoom]),n=(0,lr.DY)(null!=t?t:void 0,i.RoomEvent.Name,()=>null==t?void 0:t.name),r=(0,lr.dF)(Ci.Ay.instance,$a.EC,()=>Ci.Ay.instance.allRoomsInHome),o=null!=n?n:(0,$a.Ff)(e,r);return{activeSpace:t,title:o}}(),r=Boolean(t),s=av(e,t),a=(0,Qt.ny)("feature_video_rooms")&&s,l=s,c=r,d=Boolean((null==t?void 0:t.getJoinRule())===i.JoinRule.Public||(null==t?void 0:t.canInvite(e.getSafeUserId()))),u=Boolean(t&&(0,ss.Kv)(t)),{activeSortOption:m,sort:h}=function(){const[e,t]=(0,o.useState)(()=>O.A.getValue("RoomList.preferredSorting"));return{sort:e=>{const n=Rv[e];Av.instance.resort(n),t(n)},activeSortOption:kv[e]}}(),p=(0,o.useCallback)(e=>{x.A.fire(W.r.CreateChat),Si.A.trackInteraction("WebRoomListHeaderPlusMenuCreateChatItem",e)},[]),g=(0,o.useCallback)(e=>{sv(t),Si.A.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e)},[t]),v=(0,Qt.ny)("feature_element_call_video_rooms");return{title:n,displayComposeMenu:l,displaySpaceMenu:c,canCreateRoom:s,canCreateVideoRoom:a,canInviteInSpace:d,canAccessSpaceSettings:u,createChatRoom:p,createRoom:g,createVideoRoom:(0,o.useCallback)(()=>{const e=v?i.RoomType.UnstableCall:i.RoomType.ElementVideo;t?(0,ss.PT)(t,e):x.A.dispatch({action:W.r.CreateRoom,type:e})},[t,v]),openSpaceHome:(0,o.useCallback)(()=>{t&&x.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,metricsTrigger:void 0})},[t]),inviteInSpace:(0,o.useCallback)(()=>{t&&(0,ss.Lo)(t)},[t]),openSpacePreferences:(0,o.useCallback)(()=>{t&&(0,ss.Wi)(t)},[t]),openSpaceSettings:(0,o.useCallback)(()=>{t&&(0,ss.hL)(t)},[t]),activeSortOption:m,sort:h}}var Tv=n("./node_modules/@vector-im/compound-web/dist/components/Menu/MenuTitle.js"),Pv=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/Radio/Radio.js");const Nv=(0,o.forwardRef)(function({className:e,label:t,onSelect:n,checked:i,disabled:r},s){const a=(0,o.useId)(),l=(0,o.useCallback)(()=>{},[]);return(0,$.jsx)(ig.D,{as:"div",role:"menuitemradio","aria-checked":i,className:e,label:t,onSelect:n,disabled:r,Icon:(0,$.jsx)(Pv.A,{id:a,ref:s,"aria-hidden":!0,checked:i,disabled:r,onChange:l})})}),Dv=["ref"],Mv=e=>{let{ref:t}=e,n=(0,v.A)(e,Dv);return o.createElement(rn.m,{label:(0,c._t)("room_list|room_options")},o.createElement(rg.K,(0,tn.A)({"aria-label":(0,c._t)("room_list|room_options")},n,{ref:t}),o.createElement(Un,{color:"var(--cpd-color-icon-secondary)"})))};function Ov({vm:e}){const[t,n]=(0,o.useState)(!1),i=(0,o.useCallback)(()=>{e.sort(Cv.Activity)},[e]),r=(0,o.useCallback)(()=>{e.sort(Cv.AToZ)},[e]);return o.createElement(ng.W,{open:t,onOpenChange:n,title:(0,c._t)("room_list|room_options"),showTitle:!1,align:"start",trigger:o.createElement(Mv,null)},o.createElement(Tv.e,{title:(0,c._t)("room_list|sort")}),o.createElement(Nv,{label:(0,c._t)("room_list|sort_type|activity"),checked:e.activeSortOption===Cv.Activity,onSelect:i}),o.createElement(Nv,{label:(0,c._t)("room_list|sort_type|atoz"),checked:e.activeSortOption===Cv.AToZ,onSelect:r}))}function Fv(){const e=Iv();return o.createElement(Fe.s,{as:"header",className:"mx_RoomListHeaderView","aria-label":(0,c._t)("room|context_menu|title"),justify:"space-between",align:"center"},o.createElement(Fe.s,{className:"mx_RoomListHeaderView_title",align:"center",gap:"var(--cpd-space-1x)"},o.createElement("h1",{title:e.title},e.title),e.displaySpaceMenu&&o.createElement(Lv,{vm:e})),o.createElement(Fe.s,{align:"center",gap:"var(--cpd-space-2x)"},o.createElement(Ov,{vm:e}),e.displayComposeMenu?o.createElement(Uv,{vm:e}):o.createElement(rg.K,{"aria-label":(0,c._t)("action|start_chat"),onClick:t=>e.createChatRoom(t.nativeEvent)},o.createElement(zg,{color:"var(--cpd-color-icon-secondary)"}))))}function Lv({vm:e}){const[t,n]=(0,o.useState)(!1);return o.createElement(ng.W,{open:t,onOpenChange:n,title:e.title,side:"right",align:"start",trigger:o.createElement(rg.K,{className:"mx_SpaceMenu_button","aria-label":(0,c._t)("room_list|open_space_menu"),size:"20px"},o.createElement(Gg,{color:"var(--cpd-color-icon-secondary)"}))},o.createElement(ig.D,{Icon:Jg,label:(0,c._t)("room_list|space_menu|home"),onSelect:e.openSpaceHome,hideChevron:!0}),e.canInviteInSpace&&o.createElement(ig.D,{Icon:Hg.A,label:(0,c._t)("action|invite"),onSelect:e.inviteInSpace,hideChevron:!0}),o.createElement(ig.D,{Icon:Xg,label:(0,c._t)("common|preferences"),onSelect:e.openSpacePreferences,hideChevron:!0}),e.canAccessSpaceSettings&&o.createElement(ig.D,{Icon:Zg,label:(0,c._t)("room_list|space_menu|space_settings"),onSelect:e.openSpaceSettings,hideChevron:!0}))}function Uv({vm:e}){var t;const[n,i]=(0,o.useState)(!1),r=Ci.Ay.instance.activeSpaceRoom,s="DCA"===(null==r?void 0:r.name)||(null==r||null===(t=r.getCanonicalAlias())||void 0===t?void 0:t.includes("dca"))||(null==r?void 0:r.roomId.includes("dca"));return o.createElement(ng.W,{open:n,onOpenChange:i,showTitle:!1,title:(0,c._t)("action|open_menu"),side:"right",align:"start",trigger:o.createElement(rg.K,{"aria-label":(0,c._t)("action|add")},o.createElement(zg,{color:"var(--cpd-color-icon-secondary)"}))},o.createElement(ig.D,{Icon:nv.A,label:(0,c._t)("action|start_chat"),onSelect:e.createChatRoom,hideChevron:!0}),e.canCreateRoom&&o.createElement(ig.D,{Icon:qg,label:s?"New DCA":(0,c._t)("action|new_room"),onSelect:e.createRoom,hideChevron:!0}),e.canCreateVideoRoom&&o.createElement(ig.D,{Icon:tv,label:(0,c._t)("action|new_video_room"),onSelect:e.createVideoRoom,hideChevron:!0}))}const Bv=new Map([[_v.UnreadFilter,(0,c.AO)("room_list|filters|unread")],[_v.PeopleFilter,(0,c.AO)("room_list|filters|people")],[_v.RoomsFilter,(0,c.AO)("room_list|filters|rooms")],[_v.MentionsFilter,(0,c.AO)("room_list|filters|mentions")],[_v.InvitesFilter,(0,c.AO)("room_list|filters|invites")],[_v.FavouriteFilter,(0,c.AO)("room_list|filters|favourite")],[_v.LowPriorityFilter,(0,c.AO)("room_list|filters|low_priority")]]);function Vv(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function jv(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Vv(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vv(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function zv(e,t){const n=e.findIndex(e=>e.roomId===t);return-1===n?void 0:n}function Hv(){const e=(0,ce.nH)(),{isLoadingRooms:t,primaryFilters:n,activePrimaryFilter:i,roomsResult:r}=function(){const[e,t]=(0,o.useState)(),[n,i]=(0,o.useState)(()=>Av.instance.getSortedRoomsInActiveSpace()),[r,s]=(0,o.useState)(()=>Av.instance.isLoadingRooms),a=(0,o.useCallback)((e=[])=>{const t=Av.instance.getSortedRoomsInActiveSpace(e);i(t)},[]);(0,lr.ml)(Ci.Ay.instance,$a.tw,()=>t(void 0));const l=e=>e.filter(e=>void 0!==e),d=(0,o.useCallback)(()=>l([e]),[e]);(0,o.useEffect)(()=>{const e=d();a(e)},[d,a]),(0,lr.ml)(Av.instance,wv,()=>{const e=d();a(e)}),(0,lr.ml)(Av.instance,Sv,()=>{s(!1)});const u=(0,o.useMemo)(()=>{const n=(n,i)=>({toggle:()=>{t(e=>{const t=e===n?void 0:n;return a(l([t])),t})},active:e===n,name:i,key:n}),i=[];for(const[e,t]of Bv.entries())i.push(n(e,(0,c._t)(t)));return i},[e,a]),m=(0,o.useMemo)(()=>u.find(e=>e.active),[u]);return{isLoadingRooms:r,primaryFilters:u,activePrimaryFilter:m,roomsResult:n}}(),{activeIndex:s,roomsResult:a}=function(e){const[t,n]=(0,o.useState)({activeIndex:zv(e.rooms,as.M.instance.roomViewStore.getRoomId()),roomsResult:e}),i=(0,o.useRef)(Ci.Ay.instance.activeSpace),r=(0,o.useCallback)((t,i=!1)=>{n(n=>{const r=null!=t?t:as.M.instance.roomViewStore.getRoomId(),o=zv(e.rooms,r),s=n.activeIndex,{newIndex:a,newRooms:l}=function(e,t,n,i){const r={newIndex:n,newRooms:e};if(i)return r;if(void 0===n||void 0===t)return r;if(n===t)return r;if(t>e.length-1)return r;const o=[...e],[s]=o.splice(n,1);return o.splice(t,0,s),{newIndex:t,newRooms:o}}(e.rooms,s,o,i);return{activeIndex:a,roomsResult:jv(jv({},e),{},{rooms:l})}})},[e]);return(0,Lo.F)(x.A,e=>{e.action===W.r.ActiveRoomChanged&&r(e.newRoomId,!0)}),(0,o.useEffect)(()=>{let t=null,n=!1;i.current!==e.spaceId&&(t=Ci.Ay.instance.getLastSelectedRoomIdForSpace(e.spaceId),n=!0,i.current=e.spaceId),r(t,n)},[e,r]),t}(r);!function(e){(0,Lo.F)(x.A,t=>{if(t.action!==W.r.ViewRoomDelta)return;const n=as.M.instance.roomViewStore.getRoomId();if(!n)return;const{delta:i,unread:r}=t,o=r?e.filter(e=>{const t=xp.n.instance.getRoomState(e);return e.roomId===n||t.isUnread}):e,s=o.findIndex(e=>e.roomId===n);if(-1===s)return;const[a]=o.slice((s+i)%o.length);a&&x.A.dispatch({action:W.r.ViewRoom,room_id:a.roomId,show_room_tile:!0,metricsTrigger:"WebKeyboardShortcut",metricsViaKeyboard:!0})})}(a.rooms);const l=(0,lr.dF)(Ci.Ay.instance,$a.tw,()=>Ci.Ay.instance.activeSpaceRoom),d=av(e,l),u=(0,o.useCallback)(()=>x.A.fire(W.r.CreateChat),[]);return{isLoadingRooms:t,roomsResult:a,canCreateRoom:d,createRoom:(0,o.useCallback)(()=>sv(l),[l]),createChatRoom:u,primaryFilters:n,activePrimaryFilter:i,activeIndex:s}}var Wv=n("./src/hooks/useCall.ts"),Gv=n("./src/stores/notifications/NotificationState.ts");function Kv(e){const t=(0,ce.nH)(),n=(0,lr.dF)(e,i.RoomEvent.Tags,()=>e.tags),r=Boolean(n[za.DefaultTagID.Archived]),s=(0,lr.dF)(e,i.RoomEvent.Name,()=>e.name),a=(0,o.useMemo)(()=>xp.n.instance.getRoomState(e),[e]),[l,c]=(0,o.useState)($v(s,a)),[{isBold:d,invited:u,hasVisibleNotification:m},h]=(0,o.useState)(qv(a));(0,o.useEffect)(()=>{c($v(s,a))},[s,a]),(0,lr.YK)(a,Gv.ce.Update,()=>{c($v(s,a)),h(qv(a))}),(0,o.useEffect)(()=>{h(qv(a))},[a]);const p=!u&&rv(e),g=!u&&(p||ov(e,t.isGuest(),r)),v=function(e){const{shouldShowMessagePreview:t}=function(){const e=(0,Qt.ti)("RoomList.showMessagePreview");return{toggleMessagePreview:(0,o.useCallback)(()=>{const t=!e;O.A.setValue("RoomList.showMessagePreview",null,F.p.DEVICE,t)},[e]),shouldShowMessagePreview:e}}(),[n,i]=(0,o.useState)(void 0),r=(0,o.useCallback)(async()=>{if(!t)return void i(void 0);const n=Boolean(k.A.shared().getUserIdForRoomId(e.roomId)),r=await ur.X.instance.getPreviewForRoom(e,n?za.DefaultTagID.DM:za.DefaultTagID.Untagged);i(null==r?void 0:r.text)},[e,t]);return(0,lr.ml)(ur.X.instance,ur.X.getPreviewChangedEventName(e),()=>{r()}),(0,o.useEffect)(()=>{r()},[r]),n}(e),f=e.isElementVideoRoom()||e.isCallRoom(),_=(0,Wv.Gc)(e.roomId),y=(0,Wv.jd)(_),b=(0,Wv.q0)(_)>0,E=_?y:null,w=m||b,S=(0,o.useCallback)(()=>{x.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:"RoomList"})},[e]);return{name:s,notificationState:a,showContextMenu:p,showHoverMenu:g,openRoom:S,a11yLabel:l,isBold:d,isVideoRoom:f,callConnectionState:E,hasParticipantInCall:b,messagePreview:v,showNotificationDecoration:w}}function qv(e){const t=e.invited;return{computeA11yLabel:t=>$v(t,e),isBold:e.hasAnyNotificationOrActivity,invited:t,hasVisibleNotification:e.hasAnyNotificationOrActivity||e.muted}}function $v(e,t){return t.isUnsentMessage?(0,c._t)("a11y|room_messsage_not_sent",{roomName:e}):t.invited?(0,c._t)("a11y|room_n_unread_invite",{roomName:e}):t.isMention?(0,c._t)("a11y|room_n_unread_messages_mentions",{roomName:e,count:t.count}):t.hasUnreadCount?(0,c._t)("a11y|room_n_unread_messages",{roomName:e,count:t.count}):(0,c._t)("room_list|room|open_room",{roomName:e})}const Jv="_container_19o42_10",Yv="_input_19o42_24",Xv="_ui_19o42_34";var Qv=n("./node_modules/@radix-ui/react-form/dist/index.mjs");const Zv=["className"];function ef(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function tf(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ef(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ef(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const nf=(0,o.forwardRef)(function(e,t){let{className:n}=e,i=(0,v.A)(e,Zv);const r=ue(Jv,n);return(0,$.jsxs)("div",{className:r,children:[(0,$.jsx)("input",tf(tf({ref:t,className:Yv},i),{},{type:"checkbox"})),(0,$.jsx)("div",{className:Xv})]})}),rf=(0,o.forwardRef)(function(e,t){return(0,$.jsx)(Qv.Ec,{asChild:!0,children:(0,$.jsx)(nf,tf({ref:t},e))})}),of=(0,o.forwardRef)(function({className:e,Icon:t,label:n,onSelect:i,checked:r,disabled:s,onClick:a},l){const c=(0,o.useId)(),d=(0,o.useCallback)(()=>{},[]);return(0,$.jsx)(ig.D,{as:"div",role:"menuitemcheckbox","aria-checked":r,className:e,Icon:t,label:n,onSelect:i,disabled:s,onClick:a,children:(0,$.jsx)(nf,{id:c,ref:l,"aria-hidden":!0,checked:r,disabled:s,onChange:d})})});var sf=n("./node_modules/@vector-im/compound-web/dist/components/Separator/Separator.js");function af(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M21.324 9.13c0-.66-.339-1.237-.862-1.558l-7.37-4.318a1.81 1.81 0 0 0-1.851 0L3.87 7.572C3.348 7.892 3 8.47 3 9.13v9.167c0 1.008.825 1.833 1.833 1.833H19.5a1.84 1.84 0 0 0 1.833-1.833zm-10.129 3.978-6.6-4.124 6.646-3.896a1.81 1.81 0 0 1 1.851 0l6.646 3.896-6.6 4.124a1.85 1.85 0 0 1-1.943 0"})})}af.displayName="MarkAsReadIcon";const lf=(0,o.forwardRef)(af);function cf(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M20 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4"}),(0,$.jsx)("path",{fillRule:"evenodd",d:"M17 5H5a2 2 0 0 0-2 2v10.4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7.83a3 3 0 0 1-2 0q-.316-.113-.595-.288L12 11.89 5 7.138V7h12.764A3 3 0 0 1 17 5m-4.438 8.927L19 9.555V17.4H5V9.555l6.438 4.372a1 1 0 0 0 1.124 0",clipRule:"evenodd"})]})}cf.displayName="MarkAsUnreadIcon";const df=(0,o.forwardRef)(cf);function uf(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M13.905 9.378 12 5.52l-1.905 3.86-4.259.618 3.082 3.004-.727 4.242L12 15.24l3.81 2.003-.728-4.242 3.082-3.004zM8.767 7.55l2.336-4.733a1 1 0 0 1 1.794 0l2.336 4.733 5.223.76a1 1 0 0 1 .555 1.705L17.23 13.7l.892 5.202a1 1 0 0 1-1.45 1.054L12 17.5l-4.672 2.456a1 1 0 0 1-1.451-1.054l.892-5.202-3.78-3.685a1 1 0 0 1 .555-1.706z"})})}uf.displayName="FavouriteIcon";const mf=(0,o.forwardRef)(uf);function hf(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12 4.5a1 1 0 0 1 1 1v10.586l4.293-4.293a1 1 0 0 1 1.414 1.414l-6 6a1 1 0 0 1-1.414 0l-6-6a1 1 0 1 1 1.414-1.414L11 16.086V5.5a1 1 0 0 1 1-1"})})}hf.displayName="ArrowDownIcon";const pf=(0,o.forwardRef)(hf);var gf=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/leave.js");function vf(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M20.293 17.293c.63.63.184 1.707-.707 1.707H4.414c-.89 0-1.337-1.077-.707-1.707L5 16v-6s0-7 7-7 7 7 7 7v6zM12 22a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2"})})}vf.displayName="NotificationsSolidIcon";const ff=(0,o.forwardRef)(vf);function _f(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"m4.917 2.083 17 17a1 1 0 0 1-1.414 1.414L19.006 19H4.414c-.89 0-1.337-1.077-.707-1.707L5 16v-6s0-2.034 1.096-3.91L3.504 3.498a1 1 0 0 1 1.414-1.414M19 13.35 9.136 3.484C9.93 3.181 10.874 3 12 3c7 0 7 7 7 7z"}),(0,$.jsx)("path",{d:"M10 20h4a2 2 0 0 1-4 0"})]})}_f.displayName="NotificationsOffSolidIcon";const yf=(0,o.forwardRef)(_f);var bf=n("./src/utils/room/tagRoom.ts"),Ef=n("./src/RoomNotifs.ts"),wf=n("./src/hooks/useRoomNotificationState.ts");function Sf(e){const t=(0,ce.nH)(),n=(0,lr.dF)(e,i.RoomEvent.Tags,()=>e.tags),{level:r}=(0,cr.X)(e),s=Boolean(k.A.shared().getUserIdForRoomId(e.roomId)),a=Boolean(n[za.DefaultTagID.Favourite]),l=Boolean(n[za.DefaultTagID.LowPriority]),c=Boolean(n[za.DefaultTagID.Archived]),d=rv(e),u=ov(e,t.isGuest(),c),m=r>fp.S.None,h=!m&&!c,p=e.canInvite(t.getUserId())&&!s&&(0,Ya.g)(It.C.InviteUsers),g=!s,[v,f]=(0,wf.I)(e);return{showMoreOptionsMenu:d,showNotificationMenu:u,isFavourite:a,isLowPriority:l,canInvite:p,canCopyRoomLink:g,canMarkAsRead:m,canMarkAsUnread:h,isNotificationAllMessage:v===Ef.dC.AllMessages,isNotificationAllMessageLoud:v===Ef.dC.AllMessagesLoud,isNotificationMentionOnly:v===Ef.dC.MentionsOnly,isNotificationMute:v===Ef.dC.Mute,markAsRead:(0,o.useCallback)(async n=>{await(0,dr.G9)(e,t),Si.A.trackInteraction("WebRoomListRoomTileContextMenuMarkRead",n)},[e,t]),markAsUnread:(0,o.useCallback)(async n=>{await(0,dr.bR)(e,t,!0),Si.A.trackInteraction("WebRoomListRoomTileContextMenuMarkUnread",n)},[e,t]),toggleFavorite:(0,o.useCallback)(t=>{(0,bf.tagRoom)(e,za.DefaultTagID.Favourite),Si.A.trackInteraction("WebRoomListRoomTileContextMenuFavouriteToggle",t)},[e]),toggleLowPriority:(0,o.useCallback)(()=>(0,bf.tagRoom)(e,za.DefaultTagID.LowPriority),[e]),invite:(0,o.useCallback)(t=>{x.A.dispatch({action:"view_invite",roomId:e.roomId}),Si.A.trackInteraction("WebRoomListRoomTileContextMenuInviteItem",t)},[e]),copyRoomLink:(0,o.useCallback)(t=>{x.A.dispatch({action:"copy_room",room_id:e.roomId}),Si.A.trackInteraction("WebRoomListRoomTileContextMenuFavouriteToggle",t)},[e]),leaveRoom:(0,o.useCallback)(t=>{x.A.dispatch({action:c?"forget_room":"leave_room",room_id:e.roomId}),Si.A.trackInteraction("WebRoomListRoomTileContextMenuLeaveItem",t)},[e,c]),setRoomNotifState:f}}const xf=["isRoomMuted","ref"];function Af({room:e,setMenuOpen:t}){const n=Sf(e);return o.createElement(Fe.s,{className:"mx_RoomListItemMenuView",align:"center",gap:"var(--cpd-space-1x)"},n.showMoreOptionsMenu&&o.createElement(Cf,{setMenuOpen:t,vm:n}),n.showNotificationMenu&&o.createElement(If,{setMenuOpen:t,vm:n}))}function Cf({vm:e,setMenuOpen:t}){const[n,i]=(0,o.useState)(!1);return o.createElement(ng.W,{open:n,onOpenChange:e=>{i(e),t(e)},title:(0,c._t)("room_list|room|more_options"),showTitle:!1,align:"start",trigger:o.createElement(Rf,{size:"24px"})},o.createElement(kf,{vm:e}))}function kf({vm:e}){return o.createElement("div",{onKeyDown:e=>e.stopPropagation()},e.canMarkAsRead&&o.createElement(ig.D,{Icon:lf,label:(0,c._t)("room_list|more_options|mark_read"),onSelect:e.markAsRead,onClick:e=>e.stopPropagation(),hideChevron:!0}),e.canMarkAsUnread&&o.createElement(ig.D,{Icon:df,label:(0,c._t)("room_list|more_options|mark_unread"),onSelect:e.markAsUnread,onClick:e=>e.stopPropagation(),hideChevron:!0}),o.createElement(of,{checked:e.isFavourite,Icon:mf,label:(0,c._t)("room_list|more_options|favourited"),onSelect:e.toggleFavorite,onClick:e=>e.stopPropagation()}),o.createElement(of,{checked:e.isLowPriority,Icon:pf,label:(0,c._t)("room_list|more_options|low_priority"),onSelect:e.toggleLowPriority,onClick:e=>e.stopPropagation()}),e.canInvite&&o.createElement(ig.D,{Icon:Hg.A,label:(0,c._t)("action|invite"),onSelect:e.invite,onClick:e=>e.stopPropagation(),hideChevron:!0}),e.canCopyRoomLink&&o.createElement(ig.D,{Icon:Or.A,label:(0,c._t)("room_list|more_options|copy_link"),onSelect:e.copyRoomLink,onClick:e=>e.stopPropagation(),hideChevron:!0}),o.createElement(sf.w,null),o.createElement(ig.D,{kind:"critical",Icon:gf.A,label:(0,c._t)("room_list|more_options|leave_room"),onSelect:e.leaveRoom,onClick:e=>e.stopPropagation(),hideChevron:!0}))}const Rf=function(e){return o.createElement(rn.m,{label:(0,c._t)("room_list|room|more_options")},o.createElement(rg.K,(0,tn.A)({"aria-label":(0,c._t)("room_list|room|more_options")},e),o.createElement(Un,null)))};function If({vm:e,setMenuOpen:t}){const[n,i]=(0,o.useState)(!1),r=o.createElement(ke.A,{width:"24px",height:"24px",color:"var(--cpd-color-icon-primary)"});return o.createElement("div",{onKeyDown:e=>e.stopPropagation()},o.createElement(ng.W,{open:n,onOpenChange:e=>{i(e),t(e)},title:(0,c._t)("room_list|notification_options"),showTitle:!1,align:"start",trigger:o.createElement(Tf,{isRoomMuted:e.isNotificationMute,size:"24px"})},o.createElement(ig.D,{"aria-selected":e.isNotificationAllMessage,hideChevron:!0,label:(0,c._t)("notifications|default_settings"),onSelect:()=>e.setRoomNotifState(Ef.dC.AllMessages),onClick:e=>e.stopPropagation()},e.isNotificationAllMessage&&r),o.createElement(ig.D,{"aria-selected":e.isNotificationAllMessageLoud,hideChevron:!0,label:(0,c._t)("notifications|all_messages"),onSelect:()=>e.setRoomNotifState(Ef.dC.AllMessagesLoud),onClick:e=>e.stopPropagation()},e.isNotificationAllMessageLoud&&r),o.createElement(ig.D,{"aria-selected":e.isNotificationMentionOnly,hideChevron:!0,label:(0,c._t)("notifications|mentions_keywords"),onSelect:()=>e.setRoomNotifState(Ef.dC.MentionsOnly),onClick:e=>e.stopPropagation()},e.isNotificationMentionOnly&&r),o.createElement(ig.D,{"aria-selected":e.isNotificationMute,hideChevron:!0,label:(0,c._t)("notifications|mute_room"),onSelect:()=>e.setRoomNotifState(Ef.dC.Mute),onClick:e=>e.stopPropagation()},e.isNotificationMute&&r)))}const Tf=function(e){let{isRoomMuted:t,ref:n}=e,i=(0,v.A)(e,xf);return o.createElement(rn.m,{label:(0,c._t)("room_list|notification_options")},o.createElement(rg.K,(0,tn.A)({"aria-label":(0,c._t)("room_list|notification_options")},i,{ref:n}),t?o.createElement(yf,null):o.createElement(ff,null)))};var Pf=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/mention.js");function Nf(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2m0 5.111a1 1 0 0 0 .514.874l7 3.89a1 1 0 0 0 .972 0l7-3.89a1 1 0 1 0-.972-1.748L12 11.856 5.486 8.237A1 1 0 0 0 4 9.111"})})}Nf.displayName="EmailSolidIcon";const Df=(0,o.forwardRef)(Nf),Mf="_unread-counter_9mg0k_8",Of=["count"];function Ff(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function Lf(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ff(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ff(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function Uf(e){let{count:t}=e,n=(0,v.A)(e,Of);return null===t?(0,$.jsx)("div",Lf(Lf({},n),{},{className:Mf})):(0,$.jsx)("span",Lf(Lf({},n),{},{className:Mf,children:t}))}const Bf="_unread_1k06b_8";function Vf(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function jf(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Vf(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vf(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function zf(e){return(0,$.jsx)("div",jf(jf({},e),{},{className:Bf,children:(0,$.jsx)("div",{})}))}const Hf=["notificationState","hasVideoCall"];function Wf(e){let{notificationState:t,hasVideoCall:n}=e,i=(0,v.A)(e,Hf);const{hasAnyNotificationOrActivity:r,isUnsentMessage:s,invited:a,isMention:l,isActivityNotification:c,isNotification:d,count:u,muted:m}=(0,lr.DY)(t,Gv.ce.Update,()=>({hasAnyNotificationOrActivity:t.hasAnyNotificationOrActivity,isUnsentMessage:t.isUnsentMessage,invited:t.invited,isMention:t.isMention,isActivityNotification:t.isActivityNotification,isNotification:t.isNotification,count:t.count,muted:t.muted}));return r||m||n?o.createElement(Fe.s,(0,tn.A)({align:"center",justify:"center",gap:"var(--cpd-space-1x)"},i),s&&o.createElement(Te.A,{width:"20px",height:"20px",fill:"var(--cpd-color-icon-critical-primary)"}),n&&o.createElement(Tp.A,{width:"20px",height:"20px",fill:"var(--cpd-color-icon-accent-primary)"}),a&&o.createElement(Df,{width:"20px",height:"20px",fill:"var(--cpd-color-icon-accent-primary)"}),l&&o.createElement(Pf.A,{width:"20px",height:"20px",fill:"var(--cpd-color-icon-accent-primary)"}),(l||d)&&o.createElement(Uf,{count:u||null}),c&&o.createElement(zf,null),m&&o.createElement(yf,{width:"20px",height:"20px",fill:"var(--cpd-color-icon-tertiary)"})):null}function Gf(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12 22a9.7 9.7 0 0 1-3.9-.788 10.1 10.1 0 0 1-3.175-2.137q-1.35-1.35-2.137-3.175A9.7 9.7 0 0 1 2 12q0-2.075.788-3.9a10.1 10.1 0 0 1 2.137-3.175q1.35-1.35 3.175-2.137A9.7 9.7 0 0 1 12 2q2.075 0 3.9.788a10.1 10.1 0 0 1 3.175 2.137q1.35 1.35 2.137 3.175A9.7 9.7 0 0 1 22 12a9.7 9.7 0 0 1-.788 3.9 10.1 10.1 0 0 1-2.137 3.175q-1.35 1.35-3.175 2.137A9.7 9.7 0 0 1 12 22m-1-2.05V18q-.825 0-1.412-.587A1.93 1.93 0 0 1 9 16v-1l-4.8-4.8q-.075.45-.138.9Q4 11.55 4 12q0 3.025 1.987 5.3T11 19.95m6.9-2.55q.5-.55.9-1.187.4-.638.662-1.326.263-.687.4-1.412Q20 12.75 20 12a7.85 7.85 0 0 0-1.363-4.475A7.7 7.7 0 0 0 15 4.6V5q0 .824-.588 1.412A1.93 1.93 0 0 1 13 7h-2v2q0 .424-.287.713A.97.97 0 0 1 10 10H8v2h6q.424 0 .713.287.287.288.287.713v3h1q.65 0 1.175.387.525.388.725 1.013"})})}Gf.displayName="PublicIcon";const Kf=(0,o.forwardRef)(Gf);function qf(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 8 8",ref:t,...e,children:[(0,$.jsx)("g",{clipPath:"url(#a)",children:(0,$.jsx)("path",{d:"M8 4a4 4 0 1 1-8 0 4 4 0 0 1 8 0"})}),(0,$.jsx)("defs",{children:(0,$.jsx)("clipPath",{id:"a",children:(0,$.jsx)("path",{d:"M0 0h8v8H0z"})})})]})}qf.displayName="PresenceSolid8X8Icon";const $f=(0,o.forwardRef)(qf);function Jf(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 8 8",ref:t,...e,children:[(0,$.jsx)("g",{clipPath:"url(#a)",children:(0,$.jsx)("path",{fillRule:"evenodd",d:"M4 6.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5M4 8a4 4 0 1 0 0-8 4 4 0 0 0 0 8",clipRule:"evenodd"})}),(0,$.jsx)("defs",{children:(0,$.jsx)("clipPath",{id:"a",children:(0,$.jsx)("path",{d:"M0 0h8v8H0z"})})})]})}Jf.displayName="PresenceOutline8X8Icon";const Yf=(0,o.forwardRef)(Jf);function Xf(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 8 8",ref:t,...e,children:[(0,$.jsx)("g",{clipPath:"url(#a)",children:(0,$.jsx)("path",{fillRule:"evenodd",d:"M8 4a4 4 0 1 1-8 0 4 4 0 0 1 8 0M5.435 6.048A2.5 2.5 0 0 1 1.687 3.05zm.914-1.19L2.648 1.897a2.5 2.5 0 0 1 3.701 2.961",clipRule:"evenodd"})}),(0,$.jsx)("defs",{children:(0,$.jsx)("clipPath",{id:"a",children:(0,$.jsx)("path",{d:"M0 0h8v8H0z"})})})]})}Xf.displayName="PresenceStrikethrough8X8Icon";const Qf=(0,o.forwardRef)(Xf);var Zf=n("./src/components/views/avatars/WithPresenceIndicator.tsx");let e_=function(e){return e.LowPriority="LowPriority",e.VideoRoom="VideoRoom",e.PublicRoom="PublicRoom",e.Presence="Presence",e}({});function t_(e){const t=e.isElementVideoRoom()||e.isCallRoom(),n=(0,Zf.rT)(e),r=(0,Zf.xQ)(e,n),s=function(e){const[t,n]=(0,o.useState)(n_(e));return(0,lr.YK)(e,i.RoomEvent.Timeline,(t,r)=>{e.roomId===r.roomId&&(t.getType()!==i.EventType.RoomJoinRules&&t.getType()!==i.EventType.RoomMember||n(n_(r)))}),(0,o.useEffect)(()=>{n(n_(e))},[e]),t}(e);let a;return!!e.tags[za.DefaultTagID.LowPriority]?a=e_.LowPriority:t?a=e_.VideoRoom:s?a=e_.PublicRoom:r&&(a=e_.Presence),{badgeDecoration:a,presence:r}}function n_(e){return e.getJoinRule()===i.JoinRule.Public}function i_({room:e}){const t=t_(e);if(!t.badgeDecoration)return o.createElement(Tn.A,{size:"32px",room:e});const n=function(e,t){if(e===e_.LowPriority)return o.createElement(pf,{width:"16px",height:"16px",className:"mx_RoomAvatarView_icon",color:"var(--cpd-color-icon-tertiary)","aria-label":r_(e,t)});if(e===e_.VideoRoom)return o.createElement(Tp.A,{width:"16px",height:"16px",className:"mx_RoomAvatarView_icon",color:"var(--cpd-color-icon-tertiary)","aria-label":r_(e,t)});if(e===e_.PublicRoom)return o.createElement(Kf,{width:"16px",height:"16px",className:"mx_RoomAvatarView_icon",color:"var(--cpd-color-icon-info-primary)","aria-label":r_(e,t)});if(e===e_.Presence)return function(e){switch(e){case Zf.Cq.Online:return o.createElement($f,{width:"8px",height:"8px",className:"mx_RoomAvatarView_PresenceDecoration",color:"var(--cpd-color-icon-accent-primary)","aria-label":o_(e)});case Zf.Cq.Away:return o.createElement($f,{width:"8px",height:"8px",className:"mx_RoomAvatarView_PresenceDecoration",color:"var(--cpd-color-icon-quaternary)","aria-label":o_(e)});case Zf.Cq.Offline:return o.createElement(Yf,{width:"8px",height:"8px",className:"mx_RoomAvatarView_PresenceDecoration",color:"var(--cpd-color-icon-tertiary)","aria-label":o_(e)});case Zf.Cq.Busy:return o.createElement(Qf,{width:"8px",height:"8px",className:"mx_RoomAvatarView_PresenceDecoration",color:"var(--cpd-color-icon-tertiary)","aria-label":o_(e)})}}(t)}(t.badgeDecoration,t.presence),i=r_(t.badgeDecoration,t.presence),r=t.badgeDecoration===e_.Presence?"mx_RoomAvatarView_RoomAvatar_presence":"mx_RoomAvatarView_RoomAvatar_icon";return o.createElement("div",{className:"mx_RoomAvatarView"},o.createElement(Tn.A,{className:me()("mx_RoomAvatarView_RoomAvatar",r),size:"32px",room:e}),i?o.createElement(rn.m,{label:i},n):n)}function r_(e,t){switch(e){case e_.LowPriority:return(0,c._t)("room|room_is_low_priority");case e_.VideoRoom:return(0,c._t)("room|video_room");case e_.PublicRoom:return(0,c._t)("room|header|room_is_public");case e_.Presence:return o_(t)}}function o_(e){switch(e){case Zf.Cq.Online:return(0,c._t)("presence|online");case Zf.Cq.Away:return(0,c._t)("presence|away");case Zf.Cq.Offline:return(0,c._t)("presence|offline");case Zf.Cq.Busy:return(0,c._t)("presence|busy")}}var s_=n("./node_modules/@radix-ui/primitive/dist/index.mjs");function a_(...e){const t=e[0];if(1===e.length)return t;const n=()=>{const n=e.map(e=>({useScope:e(),scopeName:e.scopeName}));return function(e){const i=n.reduce((t,{useScope:n,scopeName:i})=>({...t,...n(e)[`__scope${i}`]}),{});return o.useMemo(()=>({[`__scope${t.scopeName}`]:i}),[i])}};return n.scopeName=t.scopeName,n}var l_=n("./node_modules/@radix-ui/react-primitive/dist/index.mjs"),c_=n("./node_modules/@radix-ui/react-menu/dist/index.mjs"),d_=n("./node_modules/@radix-ui/react-use-callback-ref/dist/index.mjs"),u_=n("./node_modules/@radix-ui/react-use-controllable-state/dist/index.mjs"),m_="ContextMenu",[h_,p_]=function(e,t=[]){let n=[];const i=()=>{const t=n.map(e=>o.createContext(e));return function(n){const i=n?.[e]||t;return o.useMemo(()=>({[`__scope${e}`]:{...n,[e]:i}}),[n,i])}};return i.scopeName=e,[function(t,i){const r=o.createContext(i),s=n.length;n=[...n,i];const a=t=>{const{scope:n,children:i,...a}=t,l=n?.[e]?.[s]||r,c=o.useMemo(()=>a,Object.values(a));return(0,$.jsx)(l.Provider,{value:c,children:i})};return a.displayName=t+"Provider",[a,function(n,a){const l=a?.[e]?.[s]||r,c=o.useContext(l);if(c)return c;if(void 0!==i)return i;throw new Error(`\`${n}\` must be used within \`${t}\``)}]},a_(i,...t)]}(m_,[c_.UE]),g_=(0,c_.UE)(),[v_,f_]=h_(m_),__=e=>{const{__scopeContextMenu:t,children:n,onOpenChange:i,dir:r,modal:s=!0}=e,[a,l]=o.useState(!1),c=g_(t),d=(0,d_.c)(i),u=o.useCallback(e=>{l(e),d(e)},[d]);return(0,$.jsx)(v_,{scope:t,open:a,onOpenChange:u,modal:s,children:(0,$.jsx)(c_.bL,{...c,dir:r,open:a,onOpenChange:u,modal:s,children:n})})};__.displayName=m_;var y_="ContextMenuTrigger",b_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,disabled:i=!1,...r}=e,s=f_(y_,n),a=g_(n),l=o.useRef({x:0,y:0}),c=o.useRef({getBoundingClientRect:()=>DOMRect.fromRect({width:0,height:0,...l.current})}),d=o.useRef(0),u=o.useCallback(()=>window.clearTimeout(d.current),[]),m=e=>{l.current={x:e.clientX,y:e.clientY},s.onOpenChange(!0)};return o.useEffect(()=>u,[u]),o.useEffect(()=>{i&&u()},[i,u]),(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(c_.Mz,{...a,virtualRef:c}),(0,$.jsx)(l_.sG.span,{"data-state":s.open?"open":"closed","data-disabled":i?"":void 0,...r,ref:t,style:{WebkitTouchCallout:"none",...e.style},onContextMenu:i?e.onContextMenu:(0,s_.m)(e.onContextMenu,e=>{u(),m(e),e.preventDefault()}),onPointerDown:i?e.onPointerDown:(0,s_.m)(e.onPointerDown,F_(e=>{u(),d.current=window.setTimeout(()=>m(e),700)})),onPointerMove:i?e.onPointerMove:(0,s_.m)(e.onPointerMove,F_(u)),onPointerCancel:i?e.onPointerCancel:(0,s_.m)(e.onPointerCancel,F_(u)),onPointerUp:i?e.onPointerUp:(0,s_.m)(e.onPointerUp,F_(u))})]})});b_.displayName=y_;var E_=e=>{const{__scopeContextMenu:t,...n}=e,i=g_(t);return(0,$.jsx)(c_.ZL,{...i,...n})};E_.displayName="ContextMenuPortal";var w_="ContextMenuContent",S_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=f_(w_,n),s=g_(n),a=o.useRef(!1);return(0,$.jsx)(c_.UC,{...s,...i,ref:t,side:"right",sideOffset:2,align:"start",onCloseAutoFocus:t=>{e.onCloseAutoFocus?.(t),!t.defaultPrevented&&a.current&&t.preventDefault(),a.current=!1},onInteractOutside:t=>{e.onInteractOutside?.(t),t.defaultPrevented||r.modal||(a.current=!0)},style:{...e.style,"--radix-context-menu-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-context-menu-content-available-width":"var(--radix-popper-available-width)","--radix-context-menu-content-available-height":"var(--radix-popper-available-height)","--radix-context-menu-trigger-width":"var(--radix-popper-anchor-width)","--radix-context-menu-trigger-height":"var(--radix-popper-anchor-height)"}})});S_.displayName=w_;var x_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.YJ,{...r,...i,ref:t})});x_.displayName="ContextMenuGroup";var A_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.JU,{...r,...i,ref:t})});A_.displayName="ContextMenuLabel";var C_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.q7,{...r,...i,ref:t})});C_.displayName="ContextMenuItem";var k_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.H_,{...r,...i,ref:t})});k_.displayName="ContextMenuCheckboxItem";var R_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.z6,{...r,...i,ref:t})});R_.displayName="ContextMenuRadioGroup";var I_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.hN,{...r,...i,ref:t})});I_.displayName="ContextMenuRadioItem";var T_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.VF,{...r,...i,ref:t})});T_.displayName="ContextMenuItemIndicator";var P_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.wv,{...r,...i,ref:t})});P_.displayName="ContextMenuSeparator";var N_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.i3,{...r,...i,ref:t})});N_.displayName="ContextMenuArrow";var D_=e=>{const{__scopeContextMenu:t,children:n,onOpenChange:i,open:r,defaultOpen:o}=e,s=g_(t),[a,l]=(0,u_.i)({prop:r,defaultProp:o,onChange:i});return(0,$.jsx)(c_.Pb,{...s,open:a,onOpenChange:l,children:n})};D_.displayName="ContextMenuSub";var M_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.ZP,{...r,...i,ref:t})});M_.displayName="ContextMenuSubTrigger";var O_=o.forwardRef((e,t)=>{const{__scopeContextMenu:n,...i}=e,r=g_(n);return(0,$.jsx)(c_.G5,{...r,...i,ref:t,style:{...e.style,"--radix-context-menu-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-context-menu-content-available-width":"var(--radix-popper-available-width)","--radix-context-menu-content-available-height":"var(--radix-popper-available-height)","--radix-context-menu-trigger-width":"var(--radix-popper-anchor-width)","--radix-context-menu-trigger-height":"var(--radix-popper-anchor-height)"}})});function F_(e){return t=>"mouse"!==t.pointerType?e(t):void 0}O_.displayName="ContextMenuSubContent";var L_=__,U_=b_,B_=E_,V_=S_,j_=n("./node_modules/@vector-im/compound-web/dist/components/Menu/FloatingMenu.js"),z_=n("./node_modules/vaul/dist/index.mjs"),H_=n("./node_modules/@vector-im/compound-web/dist/components/Menu/DrawerMenu.module.css.js");const W_="_content_vnv5k_8";var G_=n("./node_modules/@vector-im/compound-web/dist/components/Menu/MenuContext.js"),K_=n("./node_modules/@vector-im/compound-web/dist/components/Menu/DrawerMenu.js"),q_=n("./node_modules/@vector-im/compound-web/dist/utils/platform.js");const $_=({onSelect:e,children:t})=>(0,$.jsx)(C_,{onSelect:null!=e?e:void 0,asChild:!0,children:t}),J_=({title:e,showTitle:t=!0,onOpenChange:n,trigger:i,hasAccessibleAlternative:r,children:s})=>{const[a,l]=(0,o.useState)(!1),c=(0,o.useCallback)(e=>{l(e),null==n||n(e)},[l,n]),d=(0,q_.u)(),u="android"===d||"ios"===d,m=(0,o.useMemo)(()=>({MenuItemWrapper:u?null:$_,onOpenChange:c}),[c]),h=(0,$.jsx)(G_.x.Provider,{value:m,children:s}),p=(0,$.jsx)(U_,{"aria-haspopup":"menu",tabIndex:r?void 0:0,asChild:!0,children:i});return u?(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(L_,{onOpenChange:c,children:p}),(0,$.jsx)(z_._s.Root,{open:a,onOpenChange:c,children:(0,$.jsxs)(z_._s.Portal,{children:[(0,$.jsx)(z_._s.Overlay,{className:ue(H_.Ay.bg)}),(0,$.jsx)(z_._s.Content,{asChild:!0,children:(0,$.jsx)(K_.Z,{title:e,children:h})})]})})]}):(0,$.jsxs)(L_,{onOpenChange:c,children:[p,(0,$.jsx)(B_,{children:(0,$.jsx)(V_,{asChild:!0,className:ue(W_),children:(0,$.jsx)(j_.y,{showTitle:t,title:e,children:h})})})]})};function Y_({room:e,setMenuOpen:t,children:n}){const i=Sf(e);return o.createElement(J_,{title:(0,c._t)("room_list|room|more_options"),showTitle:!1,hasAccessibleAlternative:!0,trigger:n,onOpenChange:t},o.createElement(kf,{vm:i}))}const X_=["room","isSelected","isFocused","onFocus","roomIndex","roomCount"],Q_=(0,o.memo)(function(e){let{room:t,isSelected:n,isFocused:i,onFocus:r,roomIndex:s,roomCount:a}=e,l=(0,v.A)(e,X_);const c=(0,o.useRef)(null),d=Kv(t),[u,m]=(0,o.useState)(!1),[h,p]=(0,o.useState)(!1),g=h||i||u,f=g&&d.showHoverMenu,_=(0,o.useCallback)(()=>{setTimeout(()=>p(!1),10)},[]);(0,o.useEffect)(()=>{var e;i&&(null===(e=c.current)||void 0===e||e.focus({preventScroll:!0,focusVisible:!0}))},[i]);const y=o.createElement(Fe.s,(0,tn.A)({as:"button",ref:c,className:me()("mx_RoomListItemView",{mx_RoomListItemView_hover:g,mx_RoomListItemView_menu_open:f,mx_RoomListItemView_selected:n,mx_RoomListItemView_bold:d.isBold}),gap:"var(--cpd-space-3x)",align:"center",type:"button",role:"option","aria-posinset":s+1,"aria-setsize":a,"aria-selected":n,"aria-label":d.a11yLabel,onClick:()=>d.openRoom(),onFocus:r,onMouseOver:()=>m(!0),onMouseOut:()=>m(!1),onBlur:()=>m(!1),tabIndex:i?0:-1},l),o.createElement(i_,{room:t}),o.createElement(Fe.s,{className:"mx_RoomListItemView_content",gap:"var(--cpd-space-2x)",align:"center",justify:"space-between"},o.createElement("div",{className:"mx_RoomListItemView_text"},o.createElement("div",{className:"mx_RoomListItemView_roomName",title:d.name},d.name),d.messagePreview&&o.createElement("div",{className:"mx_RoomListItemView_messagePreview",title:d.messagePreview},d.messagePreview)),f?o.createElement(Af,{room:t,setMenuOpen:e=>e?p(!0):_()}):o.createElement(o.Fragment,null,d.showNotificationDecoration&&o.createElement(Wf,{notificationState:d.notificationState,"aria-hidden":!0,hasVideoCall:d.hasParticipantInCall}))));return d.showContextMenu?o.createElement(Y_,{room:t,setMenuOpen:e=>{e?setTimeout(()=>p(!0),0):_()}},y):y});function Z_(e){return()=>e}function ey(e){e()}function ty(e,t){return n=>e(t(n))}function ny(e,t){return()=>e(t)}function iy(e){return void 0!==e}function ry(){}function oy(e,t){return t(e),e}function sy(e,t){return t(e)}function ay(...e){return e}function ly(e,t){return e(1,t)}function cy(e,t){e(0,t)}function dy(e){e(2)}function uy(e){return e(4)}function my(e,t){return ly(e,function(e,t){return n=>e(t,n)}(t,0))}function hy(e,t){const n=e(1,e=>{n(),t(e)});return n}function py(e){let t,n;return i=>r=>{t=r,n&&clearTimeout(n),n=setTimeout(()=>{i(t)},e)}}function gy(e,t){return e===t}function vy(e=gy){let t;return n=>i=>{e(t,i)||(t=i,n(i))}}function fy(e){return t=>n=>{e(n)&&t(n)}}function _y(e){return t=>ty(t,e)}function yy(e){return t=>()=>{t(e)}}function by(e,...t){const n=function(...e){return t=>e.reduceRight(sy,t)}(...t);return(t,i)=>{switch(t){case 2:return void dy(e);case 1:return ly(e,n(i))}}}function Ey(e,t){return n=>i=>{n(t=e(t,i))}}function wy(e){return t=>n=>{e>0?e--:t(n)}}function Sy(e){let t,n=null;return i=>r=>{n=r,!t&&(t=setTimeout(()=>{t=void 0,i(n)},e))}}function xy(...e){const t=new Array(e.length);let n=0,i=null;const r=Math.pow(2,e.length)-1;return e.forEach((e,o)=>{const s=Math.pow(2,o);ly(e,e=>{const a=n;n|=s,t[o]=e,a!==r&&n===r&&i&&(i(),i=null)})}),e=>o=>{const s=()=>{e([o].concat(t))};n===r?s():i=s}}function Ay(e){let t=e;const n=ky();return(e,i)=>{switch(e){case 0:t=i;break;case 1:i(t);break;case 4:return t}return n(e,i)}}function Cy(e,t){return oy(Ay(t),t=>my(e,t))}function ky(){const e=[];return(t,n)=>{switch(t){case 0:return void e.slice().forEach(e=>{e(n)});case 2:return void e.splice(0,e.length);case 1:return e.push(n),()=>{const t=e.indexOf(n);t>-1&&e.splice(t,1)}}}}function Ry(e){return oy(ky(),t=>my(e,t))}function Iy(e,t=[],{singleton:n}={singleton:!0}){return{constructor:e,dependencies:t,id:Ty(),singleton:n}}const Ty=()=>Symbol();function Py(...e){const t=ky(),n=new Array(e.length);let i=0;const r=Math.pow(2,e.length)-1;return e.forEach((e,o)=>{const s=Math.pow(2,o);ly(e,e=>{n[o]=e,i|=s,i===r&&cy(t,n)})}),function(e,o){switch(e){case 2:return void dy(t);case 1:return i===r&&o(n),ly(t,o)}}}function Ny(e,t=gy){return by(e,vy(t))}function Dy(...e){return function(t,n){switch(t){case 2:return;case 1:return function(...e){return()=>{e.map(ey)}}(...e.map(e=>ly(e,n)))}}}var My=(e=>(e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e))(My||{});const Oy={0:"debug",3:"error",1:"log",2:"warn"},Fy=Iy(()=>{const e=Ay(3);return{log:Ay((t,n,i=1)=>{var r;i>=(null!=(r=(typeof globalThis>"u"?window:globalThis).VIRTUOSO_LOG_LEVEL)?r:uy(e))&&console[Oy[i]]("%creact-virtuoso: %c%s %o","color: #0253b3; font-weight: bold","color: initial",t,n)}),logLevel:e}},[],{singleton:!0});function Ly(e,t,n){return Uy(e,t,n).callbackRef}function Uy(e,t,n){const i=o.useRef(null);let r=e=>{};const s=o.useMemo(()=>typeof ResizeObserver<"u"?new ResizeObserver(t=>{const i=()=>{const n=t[0].target;null!==n.offsetParent&&e(n)};n?i():requestAnimationFrame(i)}):null,[e,n]);return r=e=>{e&&t?(null==s||s.observe(e),i.current=e):(i.current&&(null==s||s.unobserve(i.current)),i.current=null)},{callbackRef:r,ref:i}}function By(e,t,n,i,r,s,a,l,c){const d=o.useCallback(n=>{const o=function(e,t,n,i){const r=e.length;if(0===r)return null;const o=[];for(let s=0;s<r;s++){const r=e.item(s);if(void 0===r.dataset.index)continue;const a=parseInt(r.dataset.index),l=parseFloat(r.dataset.knownSize),c=t(r,n);if(0===c&&i("Zero-sized element, this should not happen",{child:r},My.ERROR),c===l)continue;const d=o[o.length-1];0===o.length||d.size!==c||d.endIndex!==a-1?o.push({endIndex:a,size:c,startIndex:a}):o[o.length-1].endIndex++}return o}(n.children,t,l?"offsetWidth":"offsetHeight",r);let c=n.parentElement;for(;!c.dataset.virtuosoScroller;)c=c.parentElement;const d="window"===c.lastElementChild.dataset.viewportType;let u;d&&(u=c.ownerDocument.defaultView);const m=a?l?a.scrollLeft:a.scrollTop:d?l?u.scrollX||u.document.documentElement.scrollLeft:u.scrollY||u.document.documentElement.scrollTop:l?c.scrollLeft:c.scrollTop,h=a?l?a.scrollWidth:a.scrollHeight:d?l?u.document.documentElement.scrollWidth:u.document.documentElement.scrollHeight:l?c.scrollWidth:c.scrollHeight,p=a?l?a.offsetWidth:a.offsetHeight:d?l?u.innerWidth:u.innerHeight:l?c.offsetWidth:c.offsetHeight;i({scrollHeight:h,scrollTop:Math.max(m,0),viewportHeight:p}),null==s||s(l?Vy("column-gap",getComputedStyle(n).columnGap,r):Vy("row-gap",getComputedStyle(n).rowGap,r)),null!==o&&e(o)},[e,t,r,s,a,i,l]);return Uy(d,n,c)}function Vy(e,t,n){return"normal"!==t&&!(null!=t&&t.endsWith("px"))&&n(`${e} was not resolved to pixel value correctly`,t,My.WARN),"normal"===t?0:parseInt(null!=t?t:"0",10)}function jy(e,t,n){const i=o.useRef(null),r=o.useCallback(n=>{if(null==n||!n.offsetParent)return;const r=n.getBoundingClientRect(),o=r.width;let s,l;if(t){const e=t.getBoundingClientRect(),n=r.top-e.top;l=e.height-Math.max(0,n),s=n+t.scrollTop}else{const e=a.current.ownerDocument.defaultView;l=e.innerHeight-Math.max(0,r.top),s=r.top+e.scrollY}i.current={offsetTop:s,visibleHeight:l,visibleWidth:o},e(i.current)},[e,t]),{callbackRef:s,ref:a}=Uy(r,!0,n),l=o.useCallback(()=>{r(a.current)},[r,a]);return o.useEffect(()=>{var e;if(t){t.addEventListener("scroll",l);const e=new ResizeObserver(()=>{requestAnimationFrame(l)});return e.observe(t),()=>{t.removeEventListener("scroll",l),e.unobserve(t)}}{const t=null==(e=a.current)?void 0:e.ownerDocument.defaultView;return null==t||t.addEventListener("scroll",l),null==t||t.addEventListener("resize",l),()=>{null==t||t.removeEventListener("scroll",l),null==t||t.removeEventListener("resize",l)}}},[l,t,a]),s}const zy=Iy(()=>{const e=ky(),t=ky(),n=Ay(0),i=ky(),r=Ay(0),o=ky(),s=ky(),a=Ay(0),l=Ay(0),c=Ay(0),d=Ay(0),u=ky(),m=ky(),h=Ay(!1),p=Ay(!1),g=Ay(!1);return my(by(e,_y(({scrollTop:e})=>e)),t),my(by(e,_y(({scrollHeight:e})=>e)),s),my(t,r),{deviation:n,fixedFooterHeight:c,fixedHeaderHeight:l,footerHeight:d,headerHeight:a,horizontalDirection:p,scrollBy:m,scrollContainerState:e,scrollHeight:s,scrollingInProgress:h,scrollTo:u,scrollTop:t,skipAnimationFrameInResizeObserver:g,smoothScrollTargetReached:i,statefulScrollTop:r,viewportHeight:o}},[],{singleton:!0}),Hy={lvl:0};function Wy(e,t){const n=e.length;if(0===n)return[];let{index:i,value:r}=t(e[0]);const o=[];for(let s=1;s<n;s++){const{index:n,value:a}=t(e[s]);o.push({end:n-1,start:i,value:r}),i=n,r=a}return o.push({end:1/0,start:i,value:r}),o}function Gy(e){return e===Hy}function Ky(e,t){if(!Gy(e))return t===e.k?e.v:t<e.k?Ky(e.l,t):Ky(e.r,t)}function qy(e,t,n="k"){if(Gy(e))return[-1/0,void 0];if(Number(e[n])===t)return[e.k,e.v];if(Number(e[n])<t){const i=qy(e.r,t,n);return i[0]===-1/0?[e.k,e.v]:i}return qy(e.l,t,n)}function $y(e,t,n){return Gy(e)?ob(t,n,1):t===e.k?tb(e,{k:t,v:n}):t<e.k?sb(tb(e,{l:$y(e.l,t,n)})):sb(tb(e,{r:$y(e.r,t,n)}))}function Jy(){return Hy}function Yy(e,t,n){if(Gy(e))return[];return function(e){return Wy(e,({k:e,v:t})=>({index:e,value:t}))}(Zy(e,qy(e,t)[0],n))}function Xy(e,t){if(Gy(e))return Hy;const{k:n,l:i,r}=e;if(t===n){if(Gy(i))return r;if(Gy(r))return i;{const[t,n]=rb(i);return eb(tb(e,{k:t,l:nb(i),v:n}))}}return eb(tb(e,t<n?{l:Xy(i,t)}:{r:Xy(r,t)}))}function Qy(e){return Gy(e)?[]:[...Qy(e.l),{k:e.k,v:e.v},...Qy(e.r)]}function Zy(e,t,n){if(Gy(e))return[];const{k:i,l:r,r:o,v:s}=e;let a=[];return i>t&&(a=a.concat(Zy(r,t,n))),i>=t&&i<=n&&a.push({k:i,v:s}),i<=n&&(a=a.concat(Zy(o,t,n))),a}function eb(e){const{l:t,lvl:n,r:i}=e;if(i.lvl>=n-1&&t.lvl>=n-1)return e;if(n>i.lvl+1){if(ib(t))return ab(tb(e,{lvl:n-1}));if(!Gy(t)&&!Gy(t.r))return tb(t.r,{l:tb(t,{r:t.r.l}),lvl:n,r:tb(e,{l:t.r.r,lvl:n-1})});throw new Error("Unexpected empty nodes")}if(ib(e))return lb(tb(e,{lvl:n-1}));if(Gy(i)||Gy(i.l))throw new Error("Unexpected empty nodes");{const t=i.l,r=ib(t)?i.lvl-1:i.lvl;return tb(t,{l:tb(e,{lvl:n-1,r:t.l}),lvl:t.lvl+1,r:lb(tb(i,{l:t.r,lvl:r}))})}}function tb(e,t){return ob(void 0!==t.k?t.k:e.k,void 0!==t.v?t.v:e.v,void 0!==t.lvl?t.lvl:e.lvl,void 0!==t.l?t.l:e.l,void 0!==t.r?t.r:e.r)}function nb(e){return Gy(e.r)?e.l:eb(tb(e,{r:nb(e.r)}))}function ib(e){return Gy(e)||e.lvl>e.r.lvl}function rb(e){return Gy(e.r)?[e.k,e.v]:rb(e.r)}function ob(e,t,n,i=Hy,r=Hy){return{k:e,l:i,lvl:n,r,v:t}}function sb(e){return lb(ab(e))}function ab(e){const{l:t}=e;return Gy(t)||t.lvl!==e.lvl?e:tb(t,{r:tb(e,{l:t.r})})}function lb(e){const{lvl:t,r:n}=e;return Gy(n)||Gy(n.r)||n.lvl!==t||n.r.lvl!==t?e:tb(n,{l:tb(e,{r:n.l}),lvl:t+1})}function cb(e,t){return!(!e||e.startIndex!==t.startIndex||e.endIndex!==t.endIndex)}function db(e,t){return!(!e||e[0]!==t[0]||e[1]!==t[1])}const ub=Iy(()=>({recalcInProgress:Ay(!1)}),[],{singleton:!0});function mb(e,t,n){return e[hb(e,t,n)]}function hb(e,t,n,i=0){let r=e.length-1;for(;i<=r;){const o=Math.floor((i+r)/2),s=n(e[o],t);if(0===s)return o;if(-1===s){if(r-i<2)return o-1;r=o-1}else{if(r===i)return o;i=o+1}}throw new Error(`Failed binary finding record in array - ${e.join(",")}, searched for ${t}`)}function pb(e,t){return Math.round(e.getBoundingClientRect()[t])}function gb(e){return!Gy(e.groupOffsetTree)}function vb({index:e},t){return t===e?0:t<e?-1:1}function fb({offset:e},t){return t===e?0:t<e?-1:1}function _b(e,t,n){if(0===t.length)return 0;const{index:i,offset:r,size:o}=mb(t,e,vb),s=e-i,a=o*s+(s-1)*n+r;return a>0?a+n:a}function yb(e,t){if(!gb(t))return e;let n=0;for(;t.groupIndices[n]<=e+n;)n++;return e+n}function bb(e,t,n){if(function(e){return typeof e.groupIndex<"u"}(e))return t.groupIndices[e.groupIndex]+1;{let i=yb("LAST"===e.index?n:e.index,t);return i=Math.max(0,i,Math.min(n,i)),i}}function Eb(e,t,n,i=0){return i>0&&(t=Math.max(t,mb(e,i,vb).offset)),Wy(function(e,t,n,i){const r=hb(e,t,i),o=hb(e,n,i,r);return e.slice(r,o+1)}(e,t,n,fb),Ab)}function wb(e,[t,n,i,r]){t.length>0&&i("received item sizes",t,My.DEBUG);const o=e.sizeTree;let s=o,a=0;if(n.length>0&&Gy(o)&&2===t.length){const e=t[0].size,i=t[1].size;s=n.reduce((t,n)=>$y($y(t,n,e),n+1,i),s)}else[s,a]=function(e,t){let n=Gy(e)?0:1/0;for(const i of t){const{endIndex:t,size:r,startIndex:o}=i;if(n=Math.min(n,o),Gy(e)){e=$y(e,0,r);continue}const s=Yy(e,o-1,t+1);if(s.some(Cb(i)))continue;let a=!1,l=!1;for(const{end:n,start:i,value:o}of s)a?(t>=i||r===o)&&(e=Xy(e,i)):(l=o!==r,a=!0),n>t&&t>=i&&o!==r&&(e=$y(e,t+1,o));l&&(e=$y(e,o,r))}return[e,n]}(s,t);if(s===o)return e;const{lastIndex:l,lastOffset:c,lastSize:d,offsetTree:u}=xb(e.offsetTree,a,s,r);return{groupIndices:n,groupOffsetTree:n.reduce((e,t)=>$y(e,t,_b(t,u,r)),Jy()),lastIndex:l,lastOffset:c,lastSize:d,offsetTree:u,sizeTree:s}}function Sb(e,t){let n=0,i=0;for(;n<e;)n+=t[i+1]-t[i]-1,i++;return i-(n===e?0:1)}function xb(e,t,n,i){let r=e,o=0,s=0,a=0,l=0;if(0!==t){l=hb(r,t-1,vb),a=r[l].offset;const e=qy(n,t-1);o=e[0],s=e[1],r.length&&r[l].size===qy(n,t)[1]&&(l-=1),r=r.slice(0,l+1)}else r=[];for(const{start:e,value:l}of Yy(n,t,1/0)){const t=e-o,n=t*s+a+t*i;r.push({index:e,offset:n,size:l}),o=e,a=n,s=l}return{lastIndex:o,lastOffset:a,lastSize:s,offsetTree:r}}function Ab(e){return{index:e.index,value:e}}function Cb(e){const{endIndex:t,size:n,startIndex:i}=e;return e=>e.start===i&&(e.end===t||e.end===1/0)&&e.value===n}const kb={offsetHeight:"height",offsetWidth:"width"},Rb=Iy(([{log:e},{recalcInProgress:t}])=>{const n=ky(),i=ky(),r=Cy(i,0),o=ky(),s=ky(),a=Ay(0),l=Ay([]),c=Ay(void 0),d=Ay(void 0),u=Ay((e,t)=>pb(e,kb[t])),m=Ay(void 0),h=Ay(0),p={groupIndices:[],groupOffsetTree:Jy(),lastIndex:0,lastOffset:0,lastSize:0,offsetTree:[],sizeTree:Jy()},g=Cy(by(n,xy(l,e,h),Ey(wb,p),vy()),p),v=Cy(by(l,vy(),Ey((e,t)=>({current:t,prev:e.current}),{current:[],prev:[]}),_y(({prev:e})=>e)),[]);my(by(l,fy(e=>e.length>0),xy(g,h),_y(([e,t,n])=>{const i=e.reduce((e,i,r)=>$y(e,i,_b(i,t.offsetTree,n)||r),Jy());return{...t,groupIndices:e,groupOffsetTree:i}})),g),my(by(i,xy(g),fy(([e,{lastIndex:t}])=>e<t),_y(([e,{lastIndex:t,lastSize:n}])=>[{endIndex:t,size:n,startIndex:e}])),n),my(c,d);const f=Cy(by(c,_y(e=>void 0===e)),!0);my(by(d,fy(e=>void 0!==e&&Gy(uy(g).sizeTree)),_y(e=>[{endIndex:0,size:e,startIndex:0}])),n);const _=Ry(by(n,xy(g),Ey(({sizes:e},[t,n])=>({changed:n!==e,sizes:n}),{changed:!1,sizes:p}),_y(e=>e.changed)));ly(by(a,Ey((e,t)=>({diff:e.prev-t,prev:t}),{diff:0,prev:0}),_y(e=>e.diff)),e=>{const{groupIndices:n}=uy(g);if(e>0)cy(t,!0),cy(o,e+Sb(e,n));else if(e<0){const t=uy(v);t.length>0&&(e-=Sb(-e,t)),cy(s,e)}}),ly(by(a,xy(e)),([e,t])=>{e<0&&t("`firstItemIndex` prop should not be set to less than zero. If you don't know the total count, just use a very high value",{firstItemIndex:a},My.ERROR)});const y=Ry(o);my(by(o,xy(g),_y(([e,t])=>{const n=t.groupIndices.length>0,i=[],r=t.lastSize;if(n){const n=Ky(t.sizeTree,0);let o=0,s=0;for(;o<e;){const e=t.groupIndices[s],a=t.groupIndices.length===s+1?1/0:t.groupIndices[s+1]-e-1;i.push({endIndex:e,size:n,startIndex:e}),i.push({endIndex:e+1+a-1,size:r,startIndex:e+1}),s++,o+=a+1}const a=Qy(t.sizeTree);return o!==e&&a.shift(),a.reduce((t,{k:n,v:i})=>{let r=t.ranges;return 0!==t.prevSize&&(r=[...t.ranges,{endIndex:n+e-1,size:t.prevSize,startIndex:t.prevIndex}]),{prevIndex:n+e,prevSize:i,ranges:r}},{prevIndex:e,prevSize:0,ranges:i}).ranges}return Qy(t.sizeTree).reduce((t,{k:n,v:i})=>({prevIndex:n+e,prevSize:i,ranges:[...t.ranges,{endIndex:n+e-1,size:t.prevSize,startIndex:t.prevIndex}]}),{prevIndex:0,prevSize:r,ranges:[]}).ranges})),n);const b=Ry(by(s,xy(g,h),_y(([e,{offsetTree:t},n])=>_b(-e,t,n))));return my(by(s,xy(g,h),_y(([e,t,n])=>{if(t.groupIndices.length>0){if(Gy(t.sizeTree))return t;let i=Jy();const r=uy(v);let o=0,s=0,a=0;for(;o<-e;){a=r[s];const e=r[s+1]-a-1;s++,o+=e+1}if(i=Qy(t.sizeTree).reduce((t,{k:n,v:i})=>$y(t,Math.max(0,n+e),i),i),o!==-e){i=$y(i,0,Ky(t.sizeTree,a));i=$y(i,1,qy(t.sizeTree,1-e)[1])}return{...t,sizeTree:i,...xb(t.offsetTree,0,i,n)}}{const i=Qy(t.sizeTree).reduce((t,{k:n,v:i})=>$y(t,Math.max(0,n+e),i),Jy());return{...t,sizeTree:i,...xb(t.offsetTree,0,i,n)}}})),g),{beforeUnshiftWith:y,data:m,defaultItemSize:d,firstItemIndex:a,fixedItemSize:c,gap:h,groupIndices:l,itemSize:u,listRefresh:_,shiftWith:s,shiftWithOffset:b,sizeRanges:n,sizes:g,statefulTotalCount:r,totalCount:i,trackItemSizes:f,unshiftWith:o}},ay(Fy,ub),{singleton:!0});function Ib(e){return e.reduce((e,t)=>(e.groupIndices.push(e.totalCount),e.totalCount+=t+1,e),{groupIndices:[],totalCount:0})}const Tb=Iy(([{groupIndices:e,sizes:t,totalCount:n},{headerHeight:i,scrollTop:r}])=>{const o=ky(),s=ky(),a=Ry(by(o,_y(Ib)));return my(by(a,_y(e=>e.totalCount)),n),my(by(a,_y(e=>e.groupIndices)),e),my(by(Py(r,t,i),fy(([e,t])=>gb(t)),_y(([e,t,n])=>qy(t.groupOffsetTree,Math.max(e-n,0),"v")[0]),vy(),_y(e=>[e])),s),{groupCounts:o,topItemsIndexes:s}},ay(Rb,zy)),Pb=Iy(([{log:e}])=>{const t=Ay(!1),n=Ry(by(t,fy(e=>e),vy()));return ly(t,t=>{t&&uy(e)("props updated",{},My.DEBUG)}),{didMount:n,propsReady:t}},ay(Fy),{singleton:!0}),Nb=typeof document<"u"&&"scrollBehavior"in document.documentElement.style;function Db(e){const t="number"==typeof e?{index:e}:e;return t.align||(t.align="start"),(!t.behavior||!Nb)&&(t.behavior="auto"),t.offset||(t.offset=0),t}const Mb=Iy(([{gap:e,listRefresh:t,sizes:n,totalCount:i},{fixedFooterHeight:r,fixedHeaderHeight:o,footerHeight:s,headerHeight:a,scrollingInProgress:l,scrollTo:c,smoothScrollTargetReached:d,viewportHeight:u},{log:m}])=>{const h=ky(),p=ky(),g=Ay(0);let v=null,f=null,_=null;function y(){v&&(v(),v=null),_&&(_(),_=null),f&&(clearTimeout(f),f=null),cy(l,!1)}return my(by(h,xy(n,u,i,g,a,s,m),xy(e,o,r),_y(([[e,n,i,r,o,s,a,c],u,m,g])=>{const b=Db(e),{align:E,behavior:w,offset:S}=b,x=r-1,A=bb(b,n,x);let C=_b(A,n.offsetTree,u)+s;"end"===E?(C+=m+qy(n.sizeTree,A)[1]-i+g,A===x&&(C+=a)):"center"===E?C+=(m+qy(n.sizeTree,A)[1]-i+g)/2:C-=o,S&&(C+=S);const k=t=>{y(),t?(c("retrying to scroll to",{location:e},My.DEBUG),cy(h,e)):(cy(p,!0),c("list did not change, scroll successful",{},My.DEBUG))};if(y(),"smooth"===w){let e=!1;_=ly(t,t=>{e=e||t}),v=hy(d,()=>{k(e)})}else v=hy(by(t,function(e){return t=>{const n=setTimeout(()=>{t(!1)},e);return e=>{e&&(t(!0),clearTimeout(n))}}}(150)),k);return f=setTimeout(()=>{y()},1200),cy(l,!0),c("scrolling from index to",{behavior:w,index:A,top:C},My.DEBUG),{behavior:w,top:C}})),c),{scrollTargetReached:p,scrollToIndex:h,topListHeight:g}},ay(Rb,zy,Fy),{singleton:!0});function Ob(e,t){0==e?t():requestAnimationFrame(()=>{Ob(e-1,t)})}function Fb(e,t){const n=t-1;return"number"==typeof e?e:"LAST"===e.index?n:e.index}const Lb=Iy(([{defaultItemSize:e,listRefresh:t,sizes:n},{scrollTop:i},{scrollTargetReached:r,scrollToIndex:o},{didMount:s}])=>{const a=Ay(!0),l=Ay(0),c=Ay(!0);return my(by(s,xy(l),fy(([e,t])=>!!t),yy(!1)),a),my(by(s,xy(l),fy(([e,t])=>!!t),yy(!1)),c),ly(by(Py(t,s),xy(a,n,e,c),fy(([[,e],t,{sizeTree:n},i,r])=>e&&(!Gy(n)||iy(i))&&!t&&!r),xy(l)),([,e])=>{hy(r,()=>{cy(c,!0)}),Ob(4,()=>{hy(i,()=>{cy(a,!0)}),cy(o,e)})}),{initialItemFinalLocationReached:c,initialTopMostItemIndex:l,scrolledToInitialItem:a}},ay(Rb,zy,Mb,Pb),{singleton:!0});function Ub(e,t){return Math.abs(e-t)<1.01}const Bb="up",Vb="down",jb={atBottom:!1,notAtBottomBecause:"NOT_SHOWING_LAST_ITEM",state:{offsetBottom:0,scrollHeight:0,scrollTop:0,viewportHeight:0}},zb=Iy(([{footerHeight:e,headerHeight:t,scrollBy:n,scrollContainerState:i,scrollTop:r,viewportHeight:o}])=>{const s=Ay(!1),a=Ay(!0),l=ky(),c=ky(),d=Ay(4),u=Ay(0),m=Cy(by(Dy(by(Ny(r),wy(1),yy(!0)),by(Ny(r),wy(1),yy(!1),py(100))),vy()),!1),h=Cy(by(Dy(by(n,yy(!0)),by(n,yy(!1),py(200))),vy()),!1);my(by(Py(Ny(r),Ny(u)),_y(([e,t])=>e<=t),vy()),a),my(by(a,Sy(50)),c);const p=Ry(by(Py(i,Ny(o),Ny(t),Ny(e),Ny(d)),Ey((e,[{scrollHeight:t,scrollTop:n},i,r,o,s])=>{const a={scrollHeight:t,scrollTop:n,viewportHeight:i};if(n+i-t>-s){let t,i;return n>e.state.scrollTop?(t="SCROLLED_DOWN",i=e.state.scrollTop-n):(t="SIZE_DECREASED",i=e.state.scrollTop-n||e.scrollTopDelta),{atBottom:!0,atBottomBecause:t,scrollTopDelta:i,state:a}}let l;return l=a.scrollHeight>e.state.scrollHeight?"SIZE_INCREASED":i<e.state.viewportHeight?"VIEWPORT_HEIGHT_DECREASING":n<e.state.scrollTop?"SCROLLING_UPWARDS":"NOT_FULLY_SCROLLED_TO_LAST_ITEM_BOTTOM",{atBottom:!1,notAtBottomBecause:l,state:a}},jb),vy((e,t)=>e&&e.atBottom===t.atBottom))),g=Cy(by(i,Ey((e,{scrollHeight:t,scrollTop:n,viewportHeight:i})=>{if(Ub(e.scrollHeight,t))return{changed:!1,jump:0,scrollHeight:t,scrollTop:n};{const r=t-(n+i)<1;return e.scrollTop!==n&&r?{changed:!0,jump:e.scrollTop-n,scrollHeight:t,scrollTop:n}:{changed:!0,jump:0,scrollHeight:t,scrollTop:n}}},{changed:!1,jump:0,scrollHeight:0,scrollTop:0}),fy(e=>e.changed),_y(e=>e.jump)),0);my(by(p,_y(e=>e.atBottom)),s),my(by(s,Sy(50)),l);const v=Ay(Vb);my(by(i,_y(({scrollTop:e})=>e),vy(),Ey((e,t)=>uy(h)?{direction:e.direction,prevScrollTop:t}:{direction:t<e.prevScrollTop?Bb:Vb,prevScrollTop:t},{direction:Vb,prevScrollTop:0}),_y(e=>e.direction)),v),my(by(i,Sy(50),yy("none")),v);const f=Ay(0);return my(by(m,fy(e=>!e),yy(0)),f),my(by(r,Sy(100),xy(m),fy(([e,t])=>!!t),Ey(([e,t],[n])=>[t,n],[0,0]),_y(([e,t])=>t-e)),f),{atBottomState:p,atBottomStateChange:l,atBottomThreshold:d,atTopStateChange:c,atTopThreshold:u,isAtBottom:s,isAtTop:a,isScrolling:m,lastJumpDueToItemResize:g,scrollDirection:v,scrollVelocity:f}},ay(zy)),Hb="top",Wb="bottom",Gb="none";function Kb(e,t,n){return"number"==typeof e?n===Bb&&t===Hb||n===Vb&&t===Wb?e:0:n===Bb?t===Hb?e.main:e.reverse:t===Wb?e.main:e.reverse}function qb(e,t){var n;return"number"==typeof e?e:null!=(n=e[t])?n:0}const $b=Iy(([{deviation:e,fixedHeaderHeight:t,headerHeight:n,scrollTop:i,viewportHeight:r}])=>{const o=ky(),s=Ay(0),a=Ay(0),l=Ay(0);return{increaseViewportBy:a,listBoundary:o,overscan:l,topListHeight:s,visibleRange:Cy(by(Py(Ny(i),Ny(r),Ny(n),Ny(o,db),Ny(l),Ny(s),Ny(t),Ny(e),Ny(a)),_y(([e,t,n,[i,r],o,s,a,l,c])=>{const d=e-l,u=s+a,m=Math.max(n-d,0);let h=Gb;const p=qb(c,Hb),g=qb(c,Wb);return i-=l,r+=n+a,(i+=n+a)>e+u-p&&(h=Bb),(r-=l)<e-m+t+g&&(h=Vb),h!==Gb?[Math.max(d-n-Kb(o,Hb,h)-p,0),d-m-a+t+Kb(o,Wb,h)+g]:null}),fy(e=>null!=e),vy(db)),[0,0])}},ay(zy),{singleton:!0});const Jb={bottom:0,firstItemIndex:0,items:[],offsetBottom:0,offsetTop:0,top:0,topItems:[],topListHeight:0,totalCount:0};function Yb(e,t,n,i,r,o){const{lastIndex:s,lastOffset:a,lastSize:l}=r;let c=0,d=0;if(e.length>0){c=e[0].offset;const t=e[e.length-1];d=t.offset+t.size}const u=n-s,m=c,h=a+u*l+(u-1)*i-d;return{bottom:d,firstItemIndex:o,items:Qb(e,r,o),offsetBottom:h,offsetTop:c,top:m,topItems:Qb(t,r,o),topListHeight:t.reduce((e,t)=>t.size+e,0),totalCount:n}}function Xb(e,t,n,i,r,o){let s=0;if(n.groupIndices.length>0)for(const t of n.groupIndices){if(t-s>=e)break;s++}const a=e+s,l=Fb(t,a);return Yb(Array.from({length:a}).map((e,t)=>({data:o[t+l],index:t+l,offset:0,size:0})),[],a,r,n,i)}function Qb(e,t,n){if(0===e.length)return[];if(!gb(t))return e.map(e=>({...e,index:e.index+n,originalIndex:e.index}));const i=e[0].index,r=e[e.length-1].index,o=[],s=Yy(t.groupOffsetTree,i,r);let a,l=0;for(const i of e){let e;(!a||a.end<i.index)&&(a=s.shift(),l=t.groupIndices.indexOf(a.start)),e=i.index===a.start?{index:l,type:"group"}:{groupIndex:l,index:i.index-(l+1)+n},o.push({...e,data:i.data,offset:i.offset,originalIndex:i.index,size:i.size})}return o}const Zb=Iy(([{data:e,firstItemIndex:t,gap:n,sizes:i,totalCount:r},o,{listBoundary:s,topListHeight:a,visibleRange:l},{initialTopMostItemIndex:c,scrolledToInitialItem:d},{topListHeight:u},m,{didMount:h},{recalcInProgress:p}])=>{const g=Ay([]),v=Ay(0),f=ky();my(o.topItemsIndexes,g);const _=Cy(by(Py(h,p,Ny(l,db),Ny(r),Ny(i),Ny(c),d,Ny(g),Ny(t),Ny(n),e),fy(([e,t,,n,,,,,,,i])=>{const r=i&&i.length!==n;return e&&!t&&!r}),_y(([,,[e,t],n,i,r,o,s,a,l,c])=>{const d=i,{offsetTree:u,sizeTree:m}=d,h=uy(v);if(0===n)return{...Jb,totalCount:n};if(0===e&&0===t)return 0===h?{...Jb,totalCount:n}:Xb(h,r,i,a,l,c||[]);if(Gy(m))return h>0?null:Yb(function(e,t,n){if(gb(t)){const i=yb(e,t);return[{index:qy(t.groupOffsetTree,i)[0],offset:0,size:0},{data:null==n?void 0:n[0],index:i,offset:0,size:0}]}return[{data:null==n?void 0:n[0],index:e,offset:0,size:0}]}(Fb(r,n),d,c),[],n,l,d,a);const p=[];if(s.length>0){const e=s[0],t=s[s.length-1];let n=0;for(const i of Yy(m,e,t)){const r=i.value,o=Math.max(i.start,e),s=Math.min(i.end,t);for(let e=o;e<=s;e++)p.push({data:null==c?void 0:c[e],index:e,offset:n,size:r}),n+=r}}if(!o)return Yb([],p,n,l,d,a);const g=s.length>0?s[s.length-1]+1:0,f=Eb(u,e,t,g);if(0===f.length)return null;const _=n-1;return Yb(oy([],n=>{for(const i of f){const r=i.value;let o=r.offset,s=i.start;const a=r.size;if(r.offset<e){s+=Math.floor((e-r.offset+l)/(a+l));const t=s-i.start;o+=t*a+t*l}s<g&&(o+=(g-s)*a,s=g);const d=Math.min(i.end,_);for(let e=s;e<=d&&!(o>=t);e++)n.push({data:null==c?void 0:c[e],index:e,offset:o,size:a}),o+=a+l}}),p,n,l,d,a)}),fy(e=>null!==e),vy()),Jb);my(by(e,fy(iy),_y(e=>null==e?void 0:e.length)),r),my(by(_,_y(e=>e.topListHeight)),u),my(u,a),my(by(_,_y(e=>[e.top,e.bottom])),s),my(by(_,_y(e=>e.items)),f);const y=Ry(by(_,fy(({items:e})=>e.length>0),xy(r,e),fy(([{items:e},t])=>e[e.length-1].originalIndex===t-1),_y(([,e,t])=>[e-1,t]),vy(db),_y(([e])=>e))),b=Ry(by(_,Sy(200),fy(({items:e,topItems:t})=>e.length>0&&e[0].originalIndex===t.length),_y(({items:e})=>e[0].index),vy())),E=Ry(by(_,fy(({items:e})=>e.length>0),_y(({items:e})=>{let t=0,n=e.length-1;for(;"group"===e[t].type&&t<n;)t++;for(;"group"===e[n].type&&n>t;)n--;return{endIndex:e[n].index,startIndex:e[t].index}}),vy(cb)));return{endReached:y,initialItemCount:v,itemsRendered:f,listState:_,rangeChanged:E,startReached:b,topItemsIndexes:g,...m}},ay(Rb,Tb,$b,Lb,Mb,zb,Pb,ub),{singleton:!0}),eE=Iy(([{fixedFooterHeight:e,fixedHeaderHeight:t,footerHeight:n,headerHeight:i},{listState:r}])=>{const o=ky(),s=Cy(by(Py(n,e,i,t,r),_y(([e,t,n,i,r])=>e+t+n+i+r.offsetBottom+r.bottom)),0);return my(Ny(s),o),{totalListHeight:s,totalListHeightChanged:o}},ay(zy,Zb),{singleton:!0}),tE=Iy(([{viewportHeight:e},{totalListHeight:t}])=>{const n=Ay(!1);return{alignToBottom:n,paddingTopAddition:Cy(by(Py(n,e,t),fy(([e])=>e),_y(([,e,t])=>Math.max(0,e-t)),Sy(0),vy()),0)}},ay(zy,eE),{singleton:!0}),nE=Iy(()=>({context:Ay(null)})),iE=({itemBottom:e,itemTop:t,locationParams:{align:n,behavior:i,...r},viewportBottom:o,viewportTop:s})=>t<s?{...r,align:null!=n?n:"start",behavior:i}:e>o?{...r,align:null!=n?n:"end",behavior:i}:null,rE=Iy(([{gap:e,sizes:t,totalCount:n},{fixedFooterHeight:i,fixedHeaderHeight:r,headerHeight:o,scrollingInProgress:s,scrollTop:a,viewportHeight:l},{scrollToIndex:c}])=>{const d=ky();return my(by(d,xy(t,l,n,o,r,i,a),xy(e),_y(([[e,t,n,i,r,o,a,l],c])=>{const{align:d,behavior:u,calculateViewLocation:m=iE,done:h,...p}=e,g=bb(e,t,i-1),v=_b(g,t.offsetTree,c)+r+o,f=m({itemBottom:v+qy(t.sizeTree,g)[1],itemTop:v,locationParams:{align:d,behavior:u,...p},viewportBottom:l+n-a,viewportTop:l+o});return f?h&&hy(by(s,fy(e=>!e),wy(uy(s)?1:2)),h):h&&h(),f}),fy(e=>null!==e)),c),{scrollIntoView:d}},ay(Rb,zy,Mb,Zb,Fy),{singleton:!0});function oE(e){return!!e&&("smooth"===e?"smooth":"auto")}const sE=Iy(([{listRefresh:e,totalCount:t,fixedItemSize:n,data:i},{atBottomState:r,isAtBottom:o},{scrollToIndex:s},{scrolledToInitialItem:a},{didMount:l,propsReady:c},{log:d},{scrollingInProgress:u},{context:m},{scrollIntoView:h}])=>{const p=Ay(!1),g=ky();let v=null;function f(e){cy(s,{align:"end",behavior:e,index:"LAST"})}function _(e){const t=hy(r,t=>{e&&!t.atBottom&&"SIZE_INCREASED"===t.notAtBottomBecause&&!v&&(uy(d)("scrolling to bottom due to increased size",{},My.DEBUG),f("auto"))});setTimeout(t,100)}ly(by(Py(by(Ny(t),wy(1)),l),xy(Ny(p),o,a,u),_y(([[e,t],n,i,r,o])=>{let s=t&&r,a="auto";return s&&(a=((e,t)=>"function"==typeof e?oE(e(t)):t&&oE(e))(n,i||o),s=s&&!!a),{followOutputBehavior:a,shouldFollow:s,totalCount:e}}),fy(({shouldFollow:e})=>e)),({followOutputBehavior:t,totalCount:i})=>{v&&(v(),v=null),uy(n)?requestAnimationFrame(()=>{uy(d)("following output to ",{totalCount:i},My.DEBUG),f(t)}):v=hy(e,()=>{uy(d)("following output to ",{totalCount:i},My.DEBUG),f(t),v=null})}),ly(by(Py(Ny(p),t,c),fy(([e,,t])=>e&&t),Ey(({value:e},[,t])=>({refreshed:e===t,value:t}),{refreshed:!1,value:0}),fy(({refreshed:e})=>e),xy(p,t)),([,e])=>{uy(a)&&_(!1!==e)}),ly(g,()=>{_(!1!==uy(p))}),ly(Py(Ny(p),r),([e,t])=>{e&&!t.atBottom&&"VIEWPORT_HEIGHT_DECREASING"===t.notAtBottomBecause&&f("auto")});const y=Ay(null),b=ky();return my(Dy(by(Ny(i),_y(e=>{var t;return null!=(t=null==e?void 0:e.length)?t:0})),by(Ny(t))),b),ly(by(Py(by(b,wy(1)),l),xy(Ny(y),a,u,m),_y(([[e,t],n,i,r,o])=>t&&i&&(null==n?void 0:n({context:o,totalCount:e,scrollingInProgress:r}))),fy(e=>!!e),Sy(0)),t=>{v&&(v(),v=null),uy(n)?requestAnimationFrame(()=>{uy(d)("scrolling into view",{}),cy(h,t)}):v=hy(e,()=>{uy(d)("scrolling into view",{}),cy(h,t),v=null})}),{autoscrollToBottom:g,followOutput:p,scrollIntoViewOnChange:y}},ay(Rb,zb,Mb,Lb,Pb,Fy,zy,nE,rE)),aE=Iy(([{data:e,firstItemIndex:t,gap:n,sizes:i},{initialTopMostItemIndex:r},{initialItemCount:o,listState:s},{didMount:a}])=>(my(by(a,xy(o),fy(([,e])=>0!==e),xy(r,i,t,n,e),_y(([[,e],t,n,i,r,o=[]])=>Xb(e,t,n,i,r,o))),s),{}),ay(Rb,Lb,Zb,Pb),{singleton:!0}),lE=Iy(([{didMount:e},{scrollTo:t},{listState:n}])=>{const i=Ay(0);return ly(by(e,xy(i),fy(([,e])=>0!==e),_y(([,e])=>({top:e}))),e=>{hy(by(n,wy(1),fy(e=>e.items.length>1)),()=>{requestAnimationFrame(()=>{cy(t,e)})})}),{initialScrollTop:i}},ay(Pb,zy,Zb),{singleton:!0}),cE=Iy(([{scrollVelocity:e}])=>{const t=Ay(!1),n=ky(),i=Ay(!1);return my(by(e,xy(i,t,n),fy(([e,t])=>!!t),_y(([e,t,n,i])=>{const{enter:r,exit:o}=t;if(n){if(o(e,i))return!1}else if(r(e,i))return!0;return n}),vy()),t),ly(by(Py(t,e,n),xy(i)),([[e,t,n],i])=>{e&&i&&i.change&&i.change(t,n)}),{isSeeking:t,scrollSeekConfiguration:i,scrollSeekRangeChanged:n,scrollVelocity:e}},ay(zb),{singleton:!0}),dE=Iy(([{scrollContainerState:e,scrollTo:t}])=>{const n=ky(),i=ky(),r=ky(),o=Ay(!1),s=Ay(void 0);return my(by(Py(n,i),_y(([{scrollHeight:e,scrollTop:t,viewportHeight:n},{offsetTop:i}])=>({scrollHeight:e,scrollTop:Math.max(0,t-i),viewportHeight:n}))),e),my(by(t,xy(i),_y(([e,{offsetTop:t}])=>({...e,top:e.top+t}))),r),{customScrollParent:s,useWindowScroll:o,windowScrollContainerState:n,windowScrollTo:r,windowViewportRect:i}},ay(zy)),uE=Iy(([{sizeRanges:e,sizes:t},{headerHeight:n,scrollTop:i},{initialTopMostItemIndex:r},{didMount:o},{useWindowScroll:s,windowScrollContainerState:a,windowViewportRect:l}])=>{const c=ky(),d=Ay(void 0),u=Ay(null),m=Ay(null);return my(a,u),my(l,m),ly(by(c,xy(t,i,s,u,m,n)),([e,t,n,i,r,o,s])=>{const a=function(e){return Qy(e).map(({k:e,v:t},n,i)=>{const r=i[n+1];return{endIndex:r?r.k-1:1/0,size:t,startIndex:e}})}(t.sizeTree);i&&null!==r&&null!==o&&(n=r.scrollTop-o.offsetTop),e({ranges:a,scrollTop:n-=s})}),my(by(d,fy(iy),_y(mE)),r),my(by(o,xy(d),fy(([,e])=>void 0!==e),vy(),_y(([,e])=>e.ranges)),e),{getState:c,restoreStateFrom:d}},ay(Rb,zy,Lb,Pb,dE));function mE(e){return{align:"start",index:0,offset:e.scrollTop}}const hE=Iy(([{topItemsIndexes:e}])=>{const t=Ay(0);return my(by(t,fy(e=>e>=0),_y(e=>Array.from({length:e}).map((e,t)=>t))),e),{topItemCount:t}},ay(Zb));function pE(e){let t,n=!1;return()=>(n||(n=!0,t=e()),t)}const gE=pE(()=>/iP(ad|od|hone)/i.test(navigator.userAgent)&&/WebKit/i.test(navigator.userAgent)),vE=Iy(([{deviation:e,scrollBy:t,scrollingInProgress:n,scrollTop:i},{isAtBottom:r,isScrolling:o,lastJumpDueToItemResize:s,scrollDirection:a},{listState:l},{beforeUnshiftWith:c,gap:d,shiftWithOffset:u,sizes:m},{log:h},{recalcInProgress:p}])=>{const g=Ry(by(l,xy(s),Ey(([,e,t,n],[{bottom:i,items:r,offsetBottom:o,totalCount:s},a])=>{const l=i+o;let c=0;return t===s&&e.length>0&&r.length>0&&(0===r[0].originalIndex&&0===e[0].originalIndex||(c=l-n,0!==c&&(c+=a))),[c,r,s,l]},[0,[],0,0]),fy(([e])=>0!==e),xy(i,a,n,r,h,p),fy(([,e,t,n,,,i])=>!i&&!n&&0!==e&&t===Bb),_y(([[e],,,,,t])=>(t("Upward scrolling compensation",{amount:e},My.DEBUG),e))));function v(n){n>0?(cy(t,{behavior:"auto",top:-n}),cy(e,0)):(cy(e,0),cy(t,{behavior:"auto",top:-n}))}return ly(by(g,xy(e,o)),([t,n,i])=>{i&&gE()?cy(e,n-t):v(-t)}),ly(by(Py(Cy(o,!1),e,p),fy(([e,t,n])=>!e&&!n&&0!==t),_y(([e,t])=>t),Sy(1)),v),my(by(u,_y(e=>({top:-e}))),t),ly(by(c,xy(m,d),_y(([e,{groupIndices:t,lastSize:n,sizeTree:i},r])=>{function o(e){return e*(n+r)}if(0===t.length)return o(e);{let n=0;const r=Ky(i,0);let s=0,a=0;for(;s<e;){s++,n+=r;let i=t.length===a+1?1/0:t[a+1]-t[a]-1;s+i>e&&(n-=r,i=e-s+1),s+=i,n+=o(i),a++}return n}})),n=>{cy(e,n),requestAnimationFrame(()=>{cy(t,{top:n}),requestAnimationFrame(()=>{cy(e,0),cy(p,!1)})})}),{deviation:e}},ay(zy,zb,Zb,Rb,Fy,ub)),fE=Iy(([e,t,n,i,r,o,s,a,l,c,d])=>({...e,...t,...n,...i,...r,...o,...s,...a,...l,...c,...d}),ay($b,aE,Pb,cE,eE,lE,tE,dE,rE,Fy,nE)),_E=Iy(([{data:e,defaultItemSize:t,firstItemIndex:n,fixedItemSize:i,gap:r,groupIndices:o,itemSize:s,sizeRanges:a,sizes:l,statefulTotalCount:c,totalCount:d,trackItemSizes:u},{initialItemFinalLocationReached:m,initialTopMostItemIndex:h,scrolledToInitialItem:p},g,v,f,{listState:_,topItemsIndexes:y,...b},{scrollToIndex:E},w,{topItemCount:S},{groupCounts:x},A])=>(my(b.rangeChanged,A.scrollSeekRangeChanged),my(by(A.windowViewportRect,_y(e=>e.visibleHeight)),g.viewportHeight),{data:e,defaultItemHeight:t,firstItemIndex:n,fixedItemHeight:i,gap:r,groupCounts:x,initialItemFinalLocationReached:m,initialTopMostItemIndex:h,scrolledToInitialItem:p,sizeRanges:a,topItemCount:S,topItemsIndexes:y,totalCount:d,...f,groupIndices:o,itemSize:s,listState:_,scrollToIndex:E,statefulTotalCount:c,trackItemSizes:u,...b,...A,...g,sizes:l,...v}),ay(Rb,Lb,zy,uE,sE,Zb,Mb,vE,hE,Tb,fE));function yE(e,t){const n={},i={};let r=0;const o=e.length;for(;r<o;)i[e[r]]=1,r+=1;for(const e in t)Object.hasOwn(i,e)||(n[e]=t[e]);return n}const bE=typeof document<"u"?o.useLayoutEffect:o.useEffect;function EE(e,t,n){const i=Object.keys(t.required||{}),r=Object.keys(t.optional||{}),s=Object.keys(t.methods||{}),a=Object.keys(t.events||{}),l=o.createContext({});function c(e,n){e.propsReady&&cy(e.propsReady,!1);for(const r of i){cy(e[t.required[r]],n[r])}for(const i of r)if(i in n){cy(e[t.optional[i]],n[i])}e.propsReady&&cy(e.propsReady,!0)}function d(e){return a.reduce((n,i)=>(n[i]=function(e){let t,n;const i=()=>null==t?void 0:t();return function(r,o){switch(r){case 1:return o?n===o?void 0:(i(),n=o,t=ly(e,o),t):(i(),ry);case 2:return i(),void(n=null)}}}(e[t.events[i]]),n),{})}const u=o.forwardRef((u,m)=>{const{children:h,...p}=u,[g]=o.useState(()=>oy(function(e){const t=new Map,n=({constructor:e,dependencies:i,id:r,singleton:o})=>{if(o&&t.has(r))return t.get(r);const s=e(i.map(e=>n(e)));return o&&t.set(r,s),s};return n(e)}(e),e=>{c(e,p)})),[v]=o.useState(ny(d,g));bE(()=>{for(const e of a)e in p&&ly(v[e],p[e]);return()=>{Object.values(v).map(dy)}},[p,v,g]),bE(()=>{c(g,p)}),o.useImperativeHandle(m,Z_(function(e){return s.reduce((n,i)=>(n[i]=n=>{cy(e[t.methods[i]],n)},n),{})}(g)));const f=n;return(0,$.jsx)(l.Provider,{value:g,children:n?(0,$.jsx)(f,{...yE([...i,...r,...a],p),children:h}):h})});return{Component:u,useEmitter:(e,t)=>{const n=o.useContext(l)[e];bE(()=>ly(n,t),[t,n])},useEmitterValue:o.version.startsWith("18")?e=>{const t=o.useContext(l)[e],n=o.useCallback(e=>ly(t,e),[t]);return o.useSyncExternalStore(n,()=>uy(t),()=>uy(t))}:e=>{const t=o.useContext(l)[e],[n,i]=o.useState(ny(uy,t));return bE(()=>ly(t,e=>{e!==n&&i(Z_(e))}),[t,n]),n},usePublisher:e=>{const t=o.useContext(l);return o.useCallback(n=>{cy(t[e],n)},[t,e])}}}const wE=o.createContext(void 0),SE=o.createContext(void 0),xE=typeof document<"u"?o.useLayoutEffect:o.useEffect;function AE(e){return"self"in e}function CE(e,t,n,i=ry,r,s){const a=o.useRef(null),l=o.useRef(null),c=o.useRef(null),d=o.useCallback(n=>{let i,r,o;const a=n.target;if(function(e){return"body"in e}(a)||AE(a)){const e=AE(a)?a:a.defaultView;o=s?e.scrollX:e.scrollY,i=s?e.document.documentElement.scrollWidth:e.document.documentElement.scrollHeight,r=s?e.innerWidth:e.innerHeight}else o=s?a.scrollLeft:a.scrollTop,i=s?a.scrollWidth:a.scrollHeight,r=s?a.offsetWidth:a.offsetHeight;const d=()=>{e({scrollHeight:i,scrollTop:Math.max(o,0),viewportHeight:r})};n.suppressFlushSync?d():ec.flushSync(d),null!==l.current&&(o===l.current||o<=0||o===i-r)&&(l.current=null,t(!0),c.current&&(clearTimeout(c.current),c.current=null))},[e,t,s]);return o.useEffect(()=>{const e=r||a.current;return i(r||a.current),d({suppressFlushSync:!0,target:e}),e.addEventListener("scroll",d,{passive:!0}),()=>{i(null),e.removeEventListener("scroll",d)}},[a,d,n,i,r]),{scrollByCallback:function(e){s&&(e={behavior:e.behavior,left:e.top}),a.current.scrollBy(e)},scrollerRef:a,scrollToCallback:function(n){const i=a.current;if(!i||(s?"offsetWidth"in i&&0===i.offsetWidth:"offsetHeight"in i&&0===i.offsetHeight))return;const r="smooth"===n.behavior;let o,d,u;AE(i)?(d=Math.max(pb(i.document.documentElement,s?"width":"height"),s?i.document.documentElement.scrollWidth:i.document.documentElement.scrollHeight),o=s?i.innerWidth:i.innerHeight,u=s?window.scrollX:window.scrollY):(d=i[s?"scrollWidth":"scrollHeight"],o=pb(i,s?"width":"height"),u=i[s?"scrollLeft":"scrollTop"]);const m=d-o;if(n.top=Math.ceil(Math.max(Math.min(m,n.top),0)),Ub(o,d)||n.top===u)return e({scrollHeight:d,scrollTop:u,viewportHeight:o}),void(r&&t(!0));r?(l.current=n.top,c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{c.current=null,l.current=null,t(!0)},1e3)):l.current=null,s&&(n={behavior:n.behavior,left:n.top}),i.scrollTo(n)}}}const kE="-webkit-sticky",RE="sticky",IE=pE(()=>{if(typeof document>"u")return RE;const e=document.createElement("div");return e.style.position=kE,e.style.position===kE?kE:RE});function TE(e){return e}const PE=Iy(([e,t])=>({...e,...t}),ay(_E,Iy(()=>{const e=Ay(e=>`Item ${e}`),t=Ay(e=>`Group ${e}`),n=Ay({}),i=Ay(TE),r=Ay("div"),o=Ay(ry),s=(e,t=null)=>Cy(by(n,_y(t=>t[e]),vy()),t);return{components:n,computeItemKey:i,EmptyPlaceholder:s("EmptyPlaceholder"),FooterComponent:s("Footer"),GroupComponent:s("Group","div"),groupContent:t,HeaderComponent:s("Header"),HeaderFooterTag:r,ItemComponent:s("Item","div"),itemContent:e,ListComponent:s("List","div"),ScrollerComponent:s("Scroller","div"),scrollerRef:o,ScrollSeekPlaceholder:s("ScrollSeekPlaceholder"),TopItemListComponent:s("TopItemList")}}))),NE=({height:e})=>(0,$.jsx)("div",{style:{height:e}}),DE={overflowAnchor:"none",position:IE(),zIndex:1},ME={overflowAnchor:"none"},OE={...ME,display:"inline-block",height:"100%"},FE=o.memo(function({showTopList:e=!1}){const t=ZE("listState"),n=ew("sizeRanges"),i=ZE("useWindowScroll"),r=ZE("customScrollParent"),s=ew("windowScrollContainerState"),a=ew("scrollContainerState"),l=r||i?s:a,c=ZE("itemContent"),d=ZE("context"),u=ZE("groupContent"),m=ZE("trackItemSizes"),h=ZE("itemSize"),p=ZE("log"),g=ew("gap"),v=ZE("horizontalDirection"),{callbackRef:f}=By(n,h,m,e?ry:l,p,g,r,v,ZE("skipAnimationFrameInResizeObserver")),[_,y]=o.useState(0);QE("deviation",e=>{_!==e&&y(e)});const b=ZE("EmptyPlaceholder"),E=ZE("ScrollSeekPlaceholder")||NE,w=ZE("ListComponent"),S=ZE("ItemComponent"),x=ZE("GroupComponent"),A=ZE("computeItemKey"),C=ZE("isSeeking"),k=ZE("groupIndices").length>0,R=ZE("alignToBottom"),I=ZE("initialItemFinalLocationReached"),T=e?{}:{boxSizing:"border-box",...v?{display:"inline-block",height:"100%",marginLeft:0!==_?_:R?"auto":0,paddingLeft:t.offsetTop,paddingRight:t.offsetBottom,whiteSpace:"nowrap"}:{marginTop:0!==_?_:R?"auto":0,paddingBottom:t.offsetBottom,paddingTop:t.offsetTop},...I?{}:{visibility:"hidden"}};return!e&&0===t.totalCount&&b?(0,$.jsx)(b,{...jE(b,d)}):(0,$.jsx)(w,{...jE(w,d),"data-testid":e?"virtuoso-top-item-list":"virtuoso-item-list",ref:f,style:T,children:(e?t.topItems:t.items).map(e=>{const n=e.originalIndex,i=A(n+t.firstItemIndex,e.data,d);return C?(0,o.createElement)(E,{...jE(E,d),height:e.size,index:e.index,key:i,type:e.type||"item",..."group"===e.type?{}:{groupIndex:e.groupIndex}}):"group"===e.type?(0,o.createElement)(x,{...jE(x,d),"data-index":n,"data-item-index":e.index,"data-known-size":e.size,key:i,style:DE},u(e.index,d)):(0,o.createElement)(S,{...jE(S,d),...zE(S,e.data),"data-index":n,"data-item-group-index":e.groupIndex,"data-item-index":e.index,"data-known-size":e.size,key:i,style:v?OE:ME},k?c(e.index,e.groupIndex,e.data,d):c(e.index,e.data,d))})})}),LE={height:"100%",outline:"none",overflowY:"auto",position:"relative",WebkitOverflowScrolling:"touch"},UE={outline:"none",overflowX:"auto",position:"relative"},BE=e=>({height:"100%",position:"absolute",top:0,width:"100%",...e?{display:"flex",flexDirection:"column"}:{}}),VE={position:IE(),top:0,width:"100%",zIndex:1};function jE(e,t){if("string"!=typeof e)return{context:t}}function zE(e,t){return{item:"string"==typeof e?void 0:t}}const HE=o.memo(function(){const e=ZE("HeaderComponent"),t=ew("headerHeight"),n=ZE("HeaderFooterTag"),i=Ly(o.useMemo(()=>e=>{t(pb(e,"height"))},[t]),!0,ZE("skipAnimationFrameInResizeObserver")),r=ZE("context");return e?(0,$.jsx)(n,{ref:i,children:(0,$.jsx)(e,{...jE(e,r)})}):null}),WE=o.memo(function(){const e=ZE("FooterComponent"),t=ew("footerHeight"),n=ZE("HeaderFooterTag"),i=Ly(o.useMemo(()=>e=>{t(pb(e,"height"))},[t]),!0,ZE("skipAnimationFrameInResizeObserver")),r=ZE("context");return e?(0,$.jsx)(n,{ref:i,children:(0,$.jsx)(e,{...jE(e,r)})}):null});function GE({useEmitter:e,useEmitterValue:t,usePublisher:n}){return o.memo(function({children:i,style:r,...o}){const s=n("scrollContainerState"),a=t("ScrollerComponent"),l=n("smoothScrollTargetReached"),c=t("scrollerRef"),d=t("context"),u=t("horizontalDirection")||!1,{scrollByCallback:m,scrollerRef:h,scrollToCallback:p}=CE(s,l,a,c,void 0,u);return e("scrollTo",p),e("scrollBy",m),(0,$.jsx)(a,{"data-testid":"virtuoso-scroller","data-virtuoso-scroller":!0,ref:h,style:{...u?UE:LE,...r},tabIndex:0,...o,...jE(a,d),children:i})})}function KE({useEmitter:e,useEmitterValue:t,usePublisher:n}){return o.memo(function({children:i,style:r,...s}){const a=n("windowScrollContainerState"),l=t("ScrollerComponent"),c=n("smoothScrollTargetReached"),d=t("totalListHeight"),u=t("deviation"),m=t("customScrollParent"),h=t("context"),p=o.useRef(null),g=t("scrollerRef"),{scrollByCallback:v,scrollerRef:f,scrollToCallback:_}=CE(a,c,l,g,m);return xE(()=>{var e;return f.current=m||(null==(e=p.current)?void 0:e.ownerDocument.defaultView),()=>{f.current=null}},[f,m]),e("windowScrollTo",_),e("scrollBy",v),(0,$.jsx)(l,{ref:p,"data-virtuoso-scroller":!0,style:{position:"relative",...r,...0!==d?{height:d+u}:{}},...s,...jE(l,h),children:i})})}const qE=({children:e})=>{const t=o.useContext(wE),n=ew("viewportHeight"),i=ew("fixedItemHeight"),r=ZE("alignToBottom"),s=ZE("horizontalDirection"),a=Ly(o.useMemo(()=>ty(n,e=>pb(e,s?"width":"height")),[n,s]),!0,ZE("skipAnimationFrameInResizeObserver"));return o.useEffect(()=>{t&&(n(t.viewportHeight),i(t.itemHeight))},[t,n,i]),(0,$.jsx)("div",{"data-viewport-type":"element",ref:a,style:BE(r),children:e})},$E=({children:e})=>{const t=o.useContext(wE),n=ew("windowViewportRect"),i=ew("fixedItemHeight"),r=ZE("customScrollParent"),s=jy(n,r,ZE("skipAnimationFrameInResizeObserver")),a=ZE("alignToBottom");return o.useEffect(()=>{t&&(i(t.itemHeight),n({offsetTop:0,visibleHeight:t.viewportHeight,visibleWidth:100}))},[t,n,i]),(0,$.jsx)("div",{"data-viewport-type":"window",ref:s,style:BE(a),children:e})},JE=({children:e})=>{const t=ZE("TopItemListComponent")||"div",n=ZE("headerHeight"),i={...VE,marginTop:`${n}px`},r=ZE("context");return(0,$.jsx)(t,{style:i,...jE(t,r),children:e})},YE=o.memo(function(e){const t=ZE("useWindowScroll"),n=ZE("topItemsIndexes").length>0,i=ZE("customScrollParent"),r=ZE("context"),o=i||t?nw:tw,s=i||t?$E:qE;return(0,$.jsxs)(o,{...e,...jE(o,r),children:[n&&(0,$.jsx)(JE,{children:(0,$.jsx)(FE,{showTopList:!0})}),(0,$.jsxs)(s,{children:[(0,$.jsx)(HE,{}),(0,$.jsx)(FE,{}),(0,$.jsx)(WE,{})]})]})}),{Component:XE,useEmitter:QE,useEmitterValue:ZE,usePublisher:ew}=EE(PE,{required:{},optional:{restoreStateFrom:"restoreStateFrom",context:"context",followOutput:"followOutput",scrollIntoViewOnChange:"scrollIntoViewOnChange",itemContent:"itemContent",groupContent:"groupContent",overscan:"overscan",increaseViewportBy:"increaseViewportBy",totalCount:"totalCount",groupCounts:"groupCounts",topItemCount:"topItemCount",firstItemIndex:"firstItemIndex",initialTopMostItemIndex:"initialTopMostItemIndex",components:"components",atBottomThreshold:"atBottomThreshold",atTopThreshold:"atTopThreshold",computeItemKey:"computeItemKey",defaultItemHeight:"defaultItemHeight",fixedItemHeight:"fixedItemHeight",itemSize:"itemSize",scrollSeekConfiguration:"scrollSeekConfiguration",headerFooterTag:"HeaderFooterTag",data:"data",initialItemCount:"initialItemCount",initialScrollTop:"initialScrollTop",alignToBottom:"alignToBottom",useWindowScroll:"useWindowScroll",customScrollParent:"customScrollParent",scrollerRef:"scrollerRef",logLevel:"logLevel",horizontalDirection:"horizontalDirection",skipAnimationFrameInResizeObserver:"skipAnimationFrameInResizeObserver"},methods:{scrollToIndex:"scrollToIndex",scrollIntoView:"scrollIntoView",scrollTo:"scrollTo",scrollBy:"scrollBy",autoscrollToBottom:"autoscrollToBottom",getState:"getState"},events:{isScrolling:"isScrolling",endReached:"endReached",startReached:"startReached",rangeChanged:"rangeChanged",atBottomStateChange:"atBottomStateChange",atTopStateChange:"atTopStateChange",totalListHeightChanged:"totalListHeightChanged",itemsRendered:"itemsRendered",groupIndices:"groupIndices"}},YE),tw=GE({useEmitter:QE,useEmitterValue:ZE,usePublisher:ew}),nw=KE({useEmitter:QE,useEmitterValue:ZE,usePublisher:ew}),iw=XE,rw=Iy(([e,t])=>({...e,...t}),ay(_E,Iy(()=>{const e=Ay(e=>(0,$.jsxs)("td",{children:["Item $",e]})),t=Ay(null),n=Ay(e=>(0,$.jsxs)("td",{colSpan:1e3,children:["Group ",e]})),i=Ay(null),r=Ay(null),o=Ay({}),s=Ay(TE),a=Ay(ry),l=(e,t=null)=>Cy(by(o,_y(t=>t[e]),vy()),t);return{components:o,computeItemKey:s,context:t,EmptyPlaceholder:l("EmptyPlaceholder"),FillerRow:l("FillerRow"),fixedFooterContent:r,fixedHeaderContent:i,itemContent:e,groupContent:n,ScrollerComponent:l("Scroller","div"),scrollerRef:a,ScrollSeekPlaceholder:l("ScrollSeekPlaceholder"),TableBodyComponent:l("TableBody","tbody"),TableComponent:l("Table","table"),TableFooterComponent:l("TableFoot","tfoot"),TableHeadComponent:l("TableHead","thead"),TableRowComponent:l("TableRow","tr"),GroupComponent:l("Group","tr")}}))),ow=({height:e})=>(0,$.jsx)("tr",{children:(0,$.jsx)("td",{style:{height:e}})}),sw=({height:e})=>(0,$.jsx)("tr",{children:(0,$.jsx)("td",{style:{border:0,height:e,padding:0}})}),aw={overflowAnchor:"none"},lw={position:IE(),zIndex:2,overflowAnchor:"none"},cw=o.memo(function({showTopList:e=!1}){const t=vw("listState"),n=vw("computeItemKey"),i=vw("firstItemIndex"),r=vw("context"),s=vw("isSeeking"),a=vw("fixedHeaderHeight"),l=vw("groupIndices").length>0,c=vw("itemContent"),d=vw("groupContent"),u=vw("ScrollSeekPlaceholder")||ow,m=vw("GroupComponent"),h=vw("TableRowComponent"),p=(e?t.topItems:[]).reduce((e,t,n)=>(0===n?e.push(t.size):e.push(e[n-1]+t.size),e),[]),g=(e?t.topItems:t.items).map(t=>{const g=t.originalIndex,v=n(g+i,t.data,r),f=e?0===g?0:p[g-1]:0;return s?(0,o.createElement)(u,{...jE(u,r),height:t.size,index:t.index,key:v,type:t.type||"item"}):"group"===t.type?(0,o.createElement)(m,{...jE(m,r),"data-index":g,"data-item-index":t.index,"data-known-size":t.size,key:v,style:{...lw,top:a}},d(t.index,r)):(0,o.createElement)(h,{...jE(h,r),...zE(h,t.data),"data-index":g,"data-item-index":t.index,"data-known-size":t.size,"data-item-group-index":t.groupIndex,key:v,style:e?{...lw,top:a+f}:aw},l?c(t.index,t.groupIndex,t.data,r):c(t.index,t.data,r))});return(0,$.jsx)($.Fragment,{children:g})}),dw=o.memo(function(){const e=vw("listState"),t=vw("topItemsIndexes").length>0,n=fw("sizeRanges"),i=vw("useWindowScroll"),r=vw("customScrollParent"),s=fw("windowScrollContainerState"),a=fw("scrollContainerState"),l=r||i?s:a,c=vw("trackItemSizes"),d=vw("itemSize"),u=vw("log"),{callbackRef:m,ref:h}=By(n,d,c,l,u,void 0,r,!1,vw("skipAnimationFrameInResizeObserver")),[p,g]=o.useState(0);gw("deviation",e=>{p!==e&&(h.current.style.marginTop=`${e}px`,g(e))});const v=vw("EmptyPlaceholder"),f=vw("FillerRow")||sw,_=vw("TableBodyComponent"),y=vw("paddingTopAddition"),b=vw("statefulTotalCount"),E=vw("context");if(0===b&&v)return(0,$.jsx)(v,{...jE(v,E)});const w=(t?e.topItems:[]).reduce((e,t)=>e+t.size,0),S=e.offsetTop+y+p-w,x=e.offsetBottom,A=S>0?(0,$.jsx)(f,{context:E,height:S},"padding-top"):null,C=x>0?(0,$.jsx)(f,{context:E,height:x},"padding-bottom"):null;return(0,$.jsxs)(_,{"data-testid":"virtuoso-item-list",ref:m,...jE(_,E),children:[A,t&&(0,$.jsx)(cw,{showTopList:!0}),(0,$.jsx)(cw,{}),C]})}),uw=({children:e})=>{const t=o.useContext(wE),n=fw("viewportHeight"),i=fw("fixedItemHeight"),r=Ly(o.useMemo(()=>ty(n,e=>pb(e,"height")),[n]),!0,vw("skipAnimationFrameInResizeObserver"));return o.useEffect(()=>{t&&(n(t.viewportHeight),i(t.itemHeight))},[t,n,i]),(0,$.jsx)("div",{"data-viewport-type":"element",ref:r,style:BE(!1),children:e})},mw=({children:e})=>{const t=o.useContext(wE),n=fw("windowViewportRect"),i=fw("fixedItemHeight"),r=vw("customScrollParent"),s=jy(n,r,vw("skipAnimationFrameInResizeObserver"));return o.useEffect(()=>{t&&(i(t.itemHeight),n({offsetTop:0,visibleHeight:t.viewportHeight,visibleWidth:100}))},[t,n,i]),(0,$.jsx)("div",{"data-viewport-type":"window",ref:s,style:BE(!1),children:e})},hw=o.memo(function(e){const t=vw("useWindowScroll"),n=vw("customScrollParent"),i=fw("fixedHeaderHeight"),r=fw("fixedFooterHeight"),s=vw("fixedHeaderContent"),a=vw("fixedFooterContent"),l=vw("context"),c=Ly(o.useMemo(()=>ty(i,e=>pb(e,"height")),[i]),!0,vw("skipAnimationFrameInResizeObserver")),d=Ly(o.useMemo(()=>ty(r,e=>pb(e,"height")),[r]),!0,vw("skipAnimationFrameInResizeObserver")),u=n||t?yw:_w,m=n||t?mw:uw,h=vw("TableComponent"),p=vw("TableHeadComponent"),g=vw("TableFooterComponent"),v=s?(0,$.jsx)(p,{ref:c,style:{position:"sticky",top:0,zIndex:2},...jE(p,l),children:s()},"TableHead"):null,f=a?(0,$.jsx)(g,{ref:d,style:{bottom:0,position:"sticky",zIndex:1},...jE(g,l),children:a()},"TableFoot"):null;return(0,$.jsx)(u,{...e,...jE(u,l),children:(0,$.jsx)(m,{children:(0,$.jsxs)(h,{style:{borderSpacing:0,overflowAnchor:"none"},...jE(h,l),children:[v,(0,$.jsx)(dw,{},"TableBody"),f]})})})}),{Component:pw,useEmitter:gw,useEmitterValue:vw,usePublisher:fw}=EE(rw,{required:{},optional:{restoreStateFrom:"restoreStateFrom",context:"context",followOutput:"followOutput",firstItemIndex:"firstItemIndex",itemContent:"itemContent",groupContent:"groupContent",fixedHeaderContent:"fixedHeaderContent",fixedFooterContent:"fixedFooterContent",overscan:"overscan",increaseViewportBy:"increaseViewportBy",totalCount:"totalCount",topItemCount:"topItemCount",initialTopMostItemIndex:"initialTopMostItemIndex",components:"components",groupCounts:"groupCounts",atBottomThreshold:"atBottomThreshold",atTopThreshold:"atTopThreshold",computeItemKey:"computeItemKey",defaultItemHeight:"defaultItemHeight",fixedItemHeight:"fixedItemHeight",itemSize:"itemSize",scrollSeekConfiguration:"scrollSeekConfiguration",data:"data",initialItemCount:"initialItemCount",initialScrollTop:"initialScrollTop",alignToBottom:"alignToBottom",useWindowScroll:"useWindowScroll",customScrollParent:"customScrollParent",scrollerRef:"scrollerRef",logLevel:"logLevel"},methods:{scrollToIndex:"scrollToIndex",scrollIntoView:"scrollIntoView",scrollTo:"scrollTo",scrollBy:"scrollBy",getState:"getState"},events:{isScrolling:"isScrolling",endReached:"endReached",startReached:"startReached",rangeChanged:"rangeChanged",atBottomStateChange:"atBottomStateChange",atTopStateChange:"atTopStateChange",totalListHeightChanged:"totalListHeightChanged",itemsRendered:"itemsRendered",groupIndices:"groupIndices"}},hw),_w=GE({useEmitter:gw,useEmitterValue:vw,usePublisher:fw}),yw=KE({useEmitter:gw,useEmitterValue:vw,usePublisher:fw}),bw={bottom:0,itemHeight:0,items:[],itemWidth:0,offsetBottom:0,offsetTop:0,top:0},Ew={bottom:0,itemHeight:0,items:[{index:0}],itemWidth:0,offsetBottom:0,offsetTop:0,top:0},{ceil:ww,floor:Sw,max:xw,min:Aw,round:Cw}=Math;function kw(e,t,n){return Array.from({length:t-e+1}).map((t,i)=>({data:null===n?null:n[i+e],index:i+e}))}function Rw(e,t){return e&&e.width===t.width&&e.height===t.height}function Iw(e,t){return e&&e.column===t.column&&e.row===t.row}const Tw=Iy(([{increaseViewportBy:e,listBoundary:t,overscan:n,visibleRange:i},{footerHeight:r,headerHeight:o,scrollBy:s,scrollContainerState:a,scrollTo:l,scrollTop:c,smoothScrollTargetReached:d,viewportHeight:u},m,h,{didMount:p,propsReady:g},{customScrollParent:v,useWindowScroll:f,windowScrollContainerState:_,windowScrollTo:y,windowViewportRect:b},E])=>{const w=Ay(0),S=Ay(0),x=Ay(bw),A=Ay({height:0,width:0}),C=Ay({height:0,width:0}),k=ky(),R=ky(),I=Ay(0),T=Ay(null),P=Ay({column:0,row:0}),N=ky(),D=ky(),M=Ay(!1),O=Ay(0),F=Ay(!0),L=Ay(!1),U=Ay(!1);ly(by(p,xy(O),fy(([e,t])=>!!t)),()=>{cy(F,!1)}),ly(by(Py(p,F,C,A,O,L),fy(([e,t,n,i,,r])=>e&&!t&&0!==n.height&&0!==i.height&&!r)),([,,,,e])=>{cy(L,!0),Ob(1,()=>{cy(k,e)}),hy(by(c),()=>{cy(t,[0,0]),cy(F,!0)})}),my(by(D,fy(e=>null!=e&&e.scrollTop>0),yy(0)),S),ly(by(p,xy(D),fy(([,e])=>null!=e)),([,e])=>{e&&(cy(A,e.viewport),cy(C,e.item),cy(P,e.gap),e.scrollTop>0&&(cy(M,!0),hy(by(c,wy(1)),e=>{cy(M,!1)}),cy(l,{top:e.scrollTop})))}),my(by(A,_y(({height:e})=>e)),u),my(by(Py(Ny(A,Rw),Ny(C,Rw),Ny(P,(e,t)=>e&&e.column===t.column&&e.row===t.row),Ny(c)),_y(([e,t,n,i])=>({gap:n,item:t,scrollTop:i,viewport:e}))),N),my(by(Py(Ny(w),i,Ny(P,Iw),Ny(C,Rw),Ny(A,Rw),Ny(T),Ny(S),Ny(M),Ny(F),Ny(O)),fy(([,,,,,,,e])=>!e),_y(([e,[t,n],i,r,o,s,a,,l,c])=>{const{column:d,row:u}=i,{height:m,width:h}=r,{width:p}=o;if(0===a&&(0===e||0===p))return bw;if(0===h){const t=Fb(c,e);return function(e){return{...Ew,items:e}}(kw(t,t+Math.max(a-1,0),s))}const g=Pw(p,h,d);let v,f;l?0===t&&0===n&&a>0?(v=0,f=a-1):(v=g*Sw((t+u)/(m+u)),f=g*ww((n+u)/(m+u))-1,f=Aw(e-1,xw(f,g-1)),v=Aw(f,xw(0,v))):(v=0,f=-1);const _=kw(v,f,s),{bottom:y,top:b}=Nw(o,i,r,_),E=ww(e/g);return{bottom:y,itemHeight:m,items:_,itemWidth:h,offsetBottom:E*m+(E-1)*u-y,offsetTop:b,top:b}})),x),my(by(T,fy(e=>null!==e),_y(e=>e.length)),w),my(by(Py(A,C,x,P),fy(([e,t,{items:n}])=>n.length>0&&0!==t.height&&0!==e.height),_y(([e,t,{items:n},i])=>{const{bottom:r,top:o}=Nw(e,i,t,n);return[o,r]}),vy(db)),t);const B=Ay(!1);my(by(c,xy(B),_y(([e,t])=>t||0!==e)),B);const V=Ry(by(Py(x,w),fy(([{items:e}])=>e.length>0),xy(B),fy(([[e,t],n])=>{const i=e.items[e.items.length-1].index===t-1;return(n||e.bottom>0&&e.itemHeight>0&&0===e.offsetBottom&&e.items.length===t)&&i}),_y(([[,e]])=>e-1),vy())),j=Ry(by(Ny(x),fy(({items:e})=>e.length>0&&0===e[0].index),yy(0),vy())),z=Ry(by(Ny(x),xy(M),fy(([{items:e},t])=>e.length>0&&!t),_y(([{items:e}])=>({endIndex:e[e.length-1].index,startIndex:e[0].index})),vy(cb),Sy(0)));my(z,h.scrollSeekRangeChanged),my(by(k,xy(A,C,w,P),_y(([e,t,n,i,r])=>{const o=Db(e),{align:s,behavior:a,offset:l}=o;let c=o.index;"LAST"===c&&(c=i-1),c=xw(0,c,Aw(i-1,c));let d=Dw(t,r,n,c);return"end"===s?d=Cw(d-t.height+n.height):"center"===s&&(d=Cw(d-t.height/2+n.height/2)),l&&(d+=l),{behavior:a,top:d}})),l);const H=Cy(by(x,_y(e=>e.offsetBottom+e.bottom)),0);return my(by(b,_y(e=>({height:e.visibleHeight,width:e.visibleWidth}))),A),{customScrollParent:v,data:T,deviation:I,footerHeight:r,gap:P,headerHeight:o,increaseViewportBy:e,initialItemCount:S,itemDimensions:C,overscan:n,restoreStateFrom:D,scrollBy:s,scrollContainerState:a,scrollHeight:R,scrollTo:l,scrollToIndex:k,scrollTop:c,smoothScrollTargetReached:d,totalCount:w,useWindowScroll:f,viewportDimensions:A,windowScrollContainerState:_,windowScrollTo:y,windowViewportRect:b,...h,gridState:x,horizontalDirection:U,initialTopMostItemIndex:O,totalListHeight:H,...m,endReached:V,propsReady:g,rangeChanged:z,startReached:j,stateChanged:N,stateRestoreInProgress:M,...E}},ay($b,zy,zb,cE,Pb,dE,Fy));function Pw(e,t,n){return xw(1,Sw((e+n)/(Sw(t)+n)))}function Nw(e,t,n,i){const{height:r}=n;if(void 0===r||0===i.length)return{bottom:0,top:0};const o=Dw(e,t,n,i[0].index);return{bottom:Dw(e,t,n,i[i.length-1].index)+r,top:o}}function Dw(e,t,n,i){const r=Pw(e.width,n.width,t.column),o=Sw(i/r),s=o*n.height+xw(0,o-1)*t.row;return s>0?s+t.row:s}const Mw=Iy(([e,t])=>({...e,...t}),ay(Tw,Iy(()=>{const e=Ay(e=>`Item ${e}`),t=Ay({}),n=Ay(null),i=Ay("virtuoso-grid-item"),r=Ay("virtuoso-grid-list"),o=Ay(TE),s=Ay("div"),a=Ay(ry),l=(e,n=null)=>Cy(by(t,_y(t=>t[e]),vy()),n),c=Ay(!1),d=Ay(!1);return my(Ny(d),c),{components:t,computeItemKey:o,context:n,FooterComponent:l("Footer"),HeaderComponent:l("Header"),headerFooterTag:s,itemClassName:i,ItemComponent:l("Item","div"),itemContent:e,listClassName:r,ListComponent:l("List","div"),readyStateChanged:c,reportReadyState:d,ScrollerComponent:l("Scroller","div"),scrollerRef:a,ScrollSeekPlaceholder:l("ScrollSeekPlaceholder","div")}}))),Ow=o.memo(function(){const e=Hw("gridState"),t=Hw("listClassName"),n=Hw("itemClassName"),i=Hw("itemContent"),r=Hw("computeItemKey"),s=Hw("isSeeking"),a=Ww("scrollHeight"),l=Hw("ItemComponent"),c=Hw("ListComponent"),d=Hw("ScrollSeekPlaceholder"),u=Hw("context"),m=Ww("itemDimensions"),h=Ww("gap"),p=Hw("log"),g=Hw("stateRestoreInProgress"),v=Ww("reportReadyState"),f=Ly(o.useMemo(()=>e=>{const t=e.parentElement.parentElement.scrollHeight;a(t);const n=e.firstChild;if(n){const{height:e,width:t}=n.getBoundingClientRect();m({height:e,width:t})}h({column:qw("column-gap",getComputedStyle(e).columnGap,p),row:qw("row-gap",getComputedStyle(e).rowGap,p)})},[a,m,h,p]),!0,!1);return xE(()=>{e.itemHeight>0&&e.itemWidth>0&&v(!0)},[e]),g?null:(0,$.jsx)(c,{className:t,ref:f,...jE(c,u),"data-testid":"virtuoso-item-list",style:{paddingBottom:e.offsetBottom,paddingTop:e.offsetTop},children:e.items.map(t=>{const a=r(t.index,t.data,u);return s?(0,$.jsx)(d,{...jE(d,u),height:e.itemHeight,index:t.index,width:e.itemWidth},a):(0,o.createElement)(l,{...jE(l,u),className:n,"data-index":t.index,key:a},i(t.index,t.data,u))})})}),Fw=o.memo(function(){const e=Hw("HeaderComponent"),t=Ww("headerHeight"),n=Hw("headerFooterTag"),i=Ly(o.useMemo(()=>e=>{t(pb(e,"height"))},[t]),!0,!1),r=Hw("context");return e?(0,$.jsx)(n,{ref:i,children:(0,$.jsx)(e,{...jE(e,r)})}):null}),Lw=o.memo(function(){const e=Hw("FooterComponent"),t=Ww("footerHeight"),n=Hw("headerFooterTag"),i=Ly(o.useMemo(()=>e=>{t(pb(e,"height"))},[t]),!0,!1),r=Hw("context");return e?(0,$.jsx)(n,{ref:i,children:(0,$.jsx)(e,{...jE(e,r)})}):null}),Uw=({children:e})=>{const t=o.useContext(SE),n=Ww("itemDimensions"),i=Ww("viewportDimensions"),r=Ly(o.useMemo(()=>e=>{i(e.getBoundingClientRect())},[i]),!0,!1);return o.useEffect(()=>{t&&(i({height:t.viewportHeight,width:t.viewportWidth}),n({height:t.itemHeight,width:t.itemWidth}))},[t,i,n]),(0,$.jsx)("div",{ref:r,style:BE(!1),children:e})},Bw=({children:e})=>{const t=o.useContext(SE),n=Ww("windowViewportRect"),i=Ww("itemDimensions"),r=Hw("customScrollParent"),s=jy(n,r,!1);return o.useEffect(()=>{t&&(i({height:t.itemHeight,width:t.itemWidth}),n({offsetTop:0,visibleHeight:t.viewportHeight,visibleWidth:t.viewportWidth}))},[t,n,i]),(0,$.jsx)("div",{ref:s,style:BE(!1),children:e})},Vw=o.memo(function({...e}){const t=Hw("useWindowScroll"),n=Hw("customScrollParent"),i=n||t?Kw:Gw,r=n||t?Bw:Uw,o=Hw("context");return(0,$.jsx)(i,{...e,...jE(i,o),children:(0,$.jsxs)(r,{children:[(0,$.jsx)(Fw,{}),(0,$.jsx)(Ow,{}),(0,$.jsx)(Lw,{})]})})}),{Component:jw,useEmitter:zw,useEmitterValue:Hw,usePublisher:Ww}=EE(Mw,{optional:{context:"context",totalCount:"totalCount",overscan:"overscan",itemContent:"itemContent",components:"components",computeItemKey:"computeItemKey",data:"data",initialItemCount:"initialItemCount",scrollSeekConfiguration:"scrollSeekConfiguration",headerFooterTag:"headerFooterTag",listClassName:"listClassName",itemClassName:"itemClassName",useWindowScroll:"useWindowScroll",customScrollParent:"customScrollParent",scrollerRef:"scrollerRef",logLevel:"logLevel",restoreStateFrom:"restoreStateFrom",initialTopMostItemIndex:"initialTopMostItemIndex",increaseViewportBy:"increaseViewportBy"},methods:{scrollTo:"scrollTo",scrollBy:"scrollBy",scrollToIndex:"scrollToIndex"},events:{isScrolling:"isScrolling",endReached:"endReached",startReached:"startReached",rangeChanged:"rangeChanged",atBottomStateChange:"atBottomStateChange",atTopStateChange:"atTopStateChange",stateChanged:"stateChanged",readyStateChanged:"readyStateChanged"}},Vw),Gw=GE({useEmitter:zw,useEmitterValue:Hw,usePublisher:Ww}),Kw=KE({useEmitter:zw,useEmitterValue:Hw,usePublisher:Ww});function qw(e,t,n){return"normal"!==t&&!(null!=t&&t.endsWith("px"))&&n(`${e} was not resolved to pixel value correctly`,t,My.WARN),"normal"===t?0:parseInt(null!=t?t:"0",10)}const $w=["items","getItemComponent","isItemFocusable","getItemKey","context","onKeyDown"];function Jw(e){const{items:t,getItemComponent:n,isItemFocusable:i,getItemKey:r,context:s,onKeyDown:a}=e,l=(0,v.A)(e,$w),c=(0,o.useRef)(null),d=(0,o.useRef)(null),[u,m]=(0,o.useState)(e.items[0]?r(e.items[0]):void 0),[h,p]=(0,o.useState)(void 0),[g,f]=(0,o.useState)(new Map),_=(0,o.useRef)(!1),[y,b]=(0,o.useState)(!1);(0,o.useEffect)(()=>{const e=new Map;t.forEach((t,n)=>{const i=r(t);e.set(i,n)}),f(e)},[t,r]),(0,o.useEffect)(()=>{!t.length||u&&void 0!==g.get(u)||m(r(t[0]))},[t,r,u,g]);const E=(0,o.useCallback)((e,n)=>{const i=Math.max(0,Math.min(e,t.length-1));if(!_.current&&t[i]){var o;const e=r(t[i]);m(e),_.current=!0,null===(o=c.current)||void 0===o||o.scrollIntoView({index:i,align:n,behavior:"auto",done:()=>{_.current=!1}})}},[t,r]),w=(0,o.useCallback)((e,n,r)=>{const o=t.length;let s;for(let r=e;n?r<o:r>=0;r+=n?1:-1)if(i(t[r])){s=r;break}void 0!==s&&E(s,r)},[E,t,i]),S=(0,o.useCallback)(e=>{const n=u?g.get(u):void 0;let i=!1;if(e||!(0,bi.fg)(e))if(e.code===bi.Uz.ARROW_UP&&void 0!==n)w(n-1,!1),i=!0;else if(e.code===bi.Uz.ARROW_DOWN&&void 0!==n)w(n+1,!0),i=!0;else if(e.code===bi.Uz.HOME)E(0),i=!0;else if(e.code===bi.Uz.END)E(t.length-1),i=!0;else if(e.code===bi.Uz.PAGE_DOWN&&h&&void 0!==n){const e=h.endIndex-h.startIndex;w(Math.min(n+e,t.length-1),!0,"start"),i=!0}else if(e.code===bi.Uz.PAGE_UP&&h&&void 0!==n){const e=h.endIndex-h.startIndex;w(Math.max(n-e,0),!1,"start"),i=!0}i?(e.stopPropagation(),e.preventDefault()):null==a||a(e)},[E,w,u,g,h,t,a]),x=(0,o.useCallback)(e=>{d.current=e},[]),A=(0,o.useCallback)((e,t,i)=>n(e,t,i,e=>{const n=r(t);b(!0),m(n),e.stopPropagation()}),[n,r]),C=(0,o.useCallback)(e=>{if((null==e?void 0:e.currentTarget)!==d.current||"string"!=typeof u)return;b(!0);const t=g.get(u);void 0!==t&&h&&(t<h.startIndex||t>h.endIndex)&&E(t),null==e||e.stopPropagation(),null==e||e.preventDefault()},[g,h,E,u]),k=(0,o.useCallback)(e=>{e.currentTarget.contains(e.relatedTarget)||b(!1)},[]),R={tabIndexKey:u,focused:y,context:e.context||{}};return o.createElement(iw,(0,tn.A)({tabIndex:e.tabIndex||void 0,ref:c,scrollerRef:x,onKeyDown:S,context:R,rangeChanged:p,overscan:e.overscan||0,data:e.items,onFocus:C,onBlur:k,itemContent:A},l))}function Yw({vm:{roomsResult:e,activeIndex:t}}){const n=(0,o.useRef)(void 0),i=(0,o.useRef)(void 0),r=e.rooms.length,s=(0,o.useCallback)((e,n,i,s)=>{const a=n.roomId,l=a===i.tabIndexKey,c=l&&i.focused,d=t===e;return o.createElement(Q_,{room:n,key:a,isSelected:d,isFocused:c,tabIndex:l?0:-1,roomIndex:e,roomCount:r,onFocus:s})},[t,r]),a=(0,o.useCallback)(e=>e.roomId,[]),l=(0,o.useCallback)(e=>{const{spaceId:r,filterKeys:o}=e.context.context,s=n.current!==r||!(0,Li.isEqual)(i.current,o);return i.current=o,n.current=r,!!s&&{align:"start",index:t||0,behavior:"auto"}},[t]),d=(0,o.useCallback)(e=>{const t=(0,uo.zM)().getNavigationAction(e);if(t===Ei.bY.NextLandmark||t===Ei.bY.PreviousLandmark)return gg.r.findAndFocusNextLandmark(gg.H.ROOM_LIST,t===Ei.bY.PreviousLandmark),e.stopPropagation(),void e.preventDefault()},[]);return o.createElement(Jw,{context:{spaceId:e.spaceId,filterKeys:e.filterKeys},scrollIntoViewOnChange:l,initialTopMostItemIndex:t,role:"listbox","aria-label":(0,c._t)("room_list|list_title"),fixedItemHeight:48,items:e.rooms,getItemComponent:s,getItemKey:a,isItemFocusable:()=>!0,onKeyDown:d})}function Xw({vm:e}){if(!e.activePrimaryFilter)return o.createElement(Zw,{vm:e});switch(e.activePrimaryFilter.key){case _v.FavouriteFilter:return o.createElement(Qw,{title:(0,c._t)("room_list|empty|no_favourites"),description:(0,c._t)("room_list|empty|no_favourites_description")});case _v.PeopleFilter:return o.createElement(Qw,{title:(0,c._t)("room_list|empty|no_people"),description:(0,c._t)("room_list|empty|no_people_description")});case _v.RoomsFilter:return o.createElement(Qw,{title:(0,c._t)("room_list|empty|no_rooms"),description:(0,c._t)("room_list|empty|no_rooms_description")});case _v.UnreadFilter:return o.createElement(eS,{title:(0,c._t)("room_list|empty|no_unread"),action:(0,c._t)("room_list|empty|show_chats"),filter:e.activePrimaryFilter});case _v.InvitesFilter:return o.createElement(eS,{title:(0,c._t)("room_list|empty|no_invites"),action:(0,c._t)("room_list|empty|show_activity"),filter:e.activePrimaryFilter});case _v.MentionsFilter:return o.createElement(eS,{title:(0,c._t)("room_list|empty|no_mentions"),action:(0,c._t)("room_list|empty|show_activity"),filter:e.activePrimaryFilter});case _v.LowPriorityFilter:return o.createElement(eS,{title:(0,c._t)("room_list|empty|no_lowpriority"),action:(0,c._t)("room_list|empty|show_activity"),filter:e.activePrimaryFilter});default:return}}function Qw({title:e,description:t,children:n}){return o.createElement(Fe.s,{className:"mx_EmptyRoomList_GenericPlaceholder",direction:"column",align:"stretch",justify:"center",gap:"var(--cpd-space-2x)"},o.createElement("span",{className:"mx_EmptyRoomList_GenericPlaceholder_title"},e),t&&o.createElement("span",{className:"mx_EmptyRoomList_GenericPlaceholder_description"},t),n)}function Zw({vm:e}){return o.createElement(Qw,{title:(0,c._t)("room_list|empty|no_chats"),description:e.canCreateRoom?(0,c._t)("room_list|empty|no_chats_description"):(0,c._t)("room_list|empty|no_chats_description_no_room_rights")},o.createElement(Fe.s,{className:"mx_EmptyRoomList_DefaultPlaceholder",align:"center",justify:"center",direction:"column",gap:"var(--cpd-space-4x)"},o.createElement(Ae.$,{size:"sm",kind:"secondary",Icon:nv.A,onClick:e.createChatRoom},(0,c._t)("action|start_chat")),e.canCreateRoom&&o.createElement(Ae.$,{size:"sm",kind:"secondary",Icon:qg,onClick:e.createRoom},(0,c._t)("action|new_room"))))}function eS({filter:e,title:t,action:n}){return o.createElement(Qw,{title:t},o.createElement(Ae.$,{kind:"tertiary",onClick:e.toggle},n))}var tS=n("./node_modules/@vector-im/compound-web/dist/components/Button/UnstyledButton.js");const nS="_chat-filter_5qdp0_8",iS=["children","selected"];function rS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function oS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rS(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rS(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const sS=(0,o.forwardRef)(function(e,t){let{children:n,selected:i}=e,r=(0,v.A)(e,iS);return(0,$.jsx)(tS.N,oS(oS({},r),{},{className:nS,"aria-selected":i,as:"button",ref:t,tabIndex:0,children:n}))});function aS({vm:e}){const t=(0,o.useId)(),[n,i]=(0,o.useState)(!1),{ref:r,isWrapping:s,wrappingIndex:a}=function(e){const t=(0,o.useRef)(null),[n,i]=(0,o.useState)(!1),[r,s]=(0,o.useState)(-1);return(0,o.useEffect)(()=>{if(!t.current)return;const n=t=>{let n=!1;Array.from(t.children).forEach((t,i)=>{const r=t,o="mx_RoomListPrimaryFilters_wrapping";if(r.setAttribute("aria-hidden","false"),r.classList.remove(o),e)return;const a=r.previousElementSibling;a&&r.offsetLeft<a.offsetLeft&&(n||s(i),n=!0),r.classList.toggle(o,n),r.setAttribute("aria-hidden",n.toString())}),n||s(-1),i(e||n)};n(t.current);const r=new ResizeObserver(e=>e.forEach(e=>n(e.target)));return r.observe(t.current),()=>{r.disconnect()}},[e]),{ref:t,isWrapping:n,wrappingIndex:r}}(n),l=function(e,t){const[n,i]=(0,o.useState)(e);return(0,o.useEffect)(()=>{e.findIndex(e=>e.active)>=t&&-1!==t?i(e.slice().sort((e,t)=>e.active&&!t.active?-1:!e.active&&t.active?1:0)):i(e)},[e,t]),n}(e.primaryFilters,a);return o.createElement(Fe.s,{className:"mx_RoomListPrimaryFilters",gap:"var(--cpd-space-3x)",direction:"row-reverse"},s&&o.createElement(rg.K,{kind:"secondary","aria-expanded":n,"aria-controls":t,className:"mx_RoomListPrimaryFilters_IconButton","aria-label":n?(0,c._t)("room_list|collapse_filters"):(0,c._t)("room_list|expand_filters"),size:"28px",onClick:()=>i(e=>!e)},o.createElement(Gg,null)),o.createElement(Fe.s,{id:t,as:"ul",role:"listbox","aria-label":(0,c._t)("room_list|primary_filters"),align:"center",gap:"var(--cpd-space-2x)",wrap:"wrap",ref:r},l.map((e,t)=>o.createElement("li",{role:"option","aria-selected":e.active,key:t},o.createElement(sS,{selected:e.active,onClick:()=>e.toggle()},e.name)))))}function lS(){const e=Hv(),t=0===e.roomsResult.rooms.length;let n;return n=e.isLoadingRooms?o.createElement("div",{className:"mx_RoomListSkeleton"}):t?o.createElement(Xw,{vm:e}):o.createElement(Yw,{vm:e}),o.createElement(o.Fragment,null,o.createElement(aS,{vm:e}),n)}const cS=({activeSpace:e})=>{const t=(0,Ya.g)(It.C.FilterContainer);return o.createElement(Fe.s,{as:"nav",className:"mx_RoomListPanel",direction:"column",align:"stretch","aria-label":(0,c._t)("room_list|list_title")},t&&o.createElement(Vg,{activeSpace:e}),o.createElement(Fv,null),o.createElement(lS,null))};var dS=function(e){return e[e.Disabled=0]="Disabled",e[e.Legacy=1]="Legacy",e}(dS||{});class uS extends o.Component{constructor(e){super(e),(0,S.A)(this,"listContainerRef",(0,o.createRef)()),(0,S.A)(this,"roomListRef",(0,o.createRef)()),(0,S.A)(this,"focusedElement",null),(0,S.A)(this,"isDoingStickyHeaders",!1),(0,S.A)(this,"updateProtocolSupport",()=>{this.setState({supportsPstnProtocol:jt.Ay.instance.getSupportsPstnProtocol()})}),(0,S.A)(this,"updateActiveSpace",e=>{this.setState({activeSpace:e})}),(0,S.A)(this,"onDialPad",()=>{x.A.fire(W.r.OpenDialPad)}),(0,S.A)(this,"onExplore",e=>{x.A.fire(W.r.ViewRoomDirectory),Si.A.trackInteraction("WebLeftPanelExploreRoomsButton",e)}),(0,S.A)(this,"refreshStickyHeaders",()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)}),(0,S.A)(this,"onBreadcrumbsUpdate",()=>{const e=uS.breadcrumbsMode;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}}),(0,S.A)(this,"onScroll",e=>{const t=e.target;this.handleStickyHeaders(t)}),(0,S.A)(this,"onFocus",e=>{this.focusedElement=e.target}),(0,S.A)(this,"onBlur",()=>{this.focusedElement=null}),(0,S.A)(this,"onKeyDown",(e,t)=>{if(!this.focusedElement)return;var n;(0,uo.zM)().getRoomListAction(e)===Ei.bY.NextRoom&&(t||(e.stopPropagation(),e.preventDefault(),null===(n=this.roomListRef.current)||void 0===n||n.focus()));const i=(0,uo.zM)().getNavigationAction(e);i!==Ei.bY.PreviousLandmark&&i!==Ei.bY.NextLandmark||(e.stopPropagation(),e.preventDefault(),gg.r.findAndFocusNextLandmark(gg.H.ROOM_SEARCH,i===Ei.bY.PreviousLandmark))}),this.state={activeSpace:Ci.Ay.instance.activeSpace,showBreadcrumbs:uS.breadcrumbsMode,supportsPstnProtocol:jt.Ay.instance.getSupportsPstnProtocol()}}static get breadcrumbsMode(){return Tg.Y.instance.visible?dS.Legacy:dS.Disabled}componentDidMount(){Tg.Y.instance.on(ha.H,this.onBreadcrumbsUpdate),Pg.Ay.instance.on(Pg.lA,this.onBreadcrumbsUpdate),Ci.Ay.instance.on($a.tw,this.updateActiveSpace),jt.Ay.instance.on(jt.uv.ProtocolSupport,this.updateProtocolSupport),this.listContainerRef.current&&(Ja.A.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),this.listContainerRef.current.addEventListener("scroll",this.onScroll,{passive:!0})),Ja.A.instance.on("ListContainer",this.refreshStickyHeaders)}componentWillUnmount(){var e;Tg.Y.instance.off(ha.H,this.onBreadcrumbsUpdate),Pg.Ay.instance.off(Pg.lA,this.onBreadcrumbsUpdate),Ci.Ay.instance.off($a.tw,this.updateActiveSpace),jt.Ay.instance.off(jt.uv.ProtocolSupport,this.updateProtocolSupport),Ja.A.instance.stopTrackingElementDimensions("ListContainer"),Ja.A.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame(()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1}))}doStickyHeaders(e){if(!e.parentElement)return;const t=e.scrollTop,n=e.offsetHeight+e.scrollTop,i=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),r=new Map;let o,s;for(const e of i){const a=e.querySelector(".mx_RoomSublist_stickable");if(!a)continue;a.style.removeProperty("display");const l=.4,c=e.offsetTop+l*Ka.u<=t,d=e.offsetTop+l*Ka.u>=n;c||e===i[0]?(r.set(a,{stickyTop:!0}),o&&(o.style.display="none",r.set(o,{makeInvisible:!0})),o=a):d&&!s?(r.set(a,{stickyBottom:!0}),s=a):r.set(a,{})}for(const t of r.keys()){const n=r.get(t);if(n.makeInvisible)t.style.display="none";else{if(n.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const n=`${e.parentElement.offsetTop}px`;t.style.top!==n&&(t.style.top=n)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(n.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const n=`${Ja.A.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)}px`;t.style.bottom!==n&&(t.style.bottom=n)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(n.stickyTop||n.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=Ja.A.instance.getElementDimensions("ListContainer");if(e){const n=15,i=`${e.width-n}px`;t.style.width!==i&&(t.style.width=i)}}else n.stickyTop||n.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const a=e.parentElement;a&&(o?a.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):a.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),s?a.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):a.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom"))}renderBreadcrumbs(){if(this.state.showBreadcrumbs===dS.Legacy&&!this.props.isMinimized)return o.createElement(tg,{role:"navigation","aria-label":(0,c._t)("a11y|recent_rooms"),className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0},o.createElement(Mg,null))}renderSearchDialExplore(){let e,t;return this.state.supportsPstnProtocol&&(e=o.createElement(ae.A,{className:me()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:(0,c._t)("left_panel|open_dial_pad")})),this.state.activeSpace===$a._b.Home&&(0,Ya.g)(It.C.ExploreRooms)&&(t=o.createElement(ae.A,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:(0,c._t)("action|explore_rooms")})),o.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,role:"search"},o.createElement(qa,{isMinimized:this.props.isMinimized}),e,t)}render(){const e=O.A.getValue("feature_new_room_list"),t=me()({mx_LeftPanel:!0,mx_LeftPanel_newRoomList:e,mx_LeftPanel_minimized:this.props.isMinimized}),n=me()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");if(e)return o.createElement("div",{className:t},o.createElement("div",{className:"mx_LeftPanel_roomListContainer"},o.createElement(cS,{activeSpace:this.state.activeSpace})));const i=o.createElement(Ga.A,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders,ref:this.roomListRef});return o.createElement("div",{className:t},o.createElement("div",{className:"mx_LeftPanel_roomListContainer"},(0,Ya.g)(It.C.FilterContainer)&&this.renderSearchDialExplore(),this.renderBreadcrumbs(),!this.props.isMinimized&&o.createElement(Ig,{onVisibilityChange:this.refreshStickyHeaders}),o.createElement("nav",{className:"mx_LeftPanel_roomListWrapper","aria-label":(0,c._t)("common|rooms")},o.createElement("div",{className:n,ref:this.listContainerRef,tabIndex:-1},i))))}}var mS=n("./src/stores/NonUrgentToastStore.ts");class hS extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"onUpdateToasts",()=>{this.setState({toasts:mS.A.instance.components})}),this.state={toasts:mS.A.instance.components}}componentDidMount(){mS.A.instance.on(ha.H,this.onUpdateToasts)}componentWillUnmount(){mS.A.instance.off(ha.H,this.onUpdateToasts)}render(){const e=this.state.toasts.map((e,t)=>o.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:`toast-${t}`},o.createElement(e,{})));return o.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}var pS=n("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts");class gS extends o.Component{constructor(e){super(e),(0,S.A)(this,"element",(0,o.createRef)()),(0,S.A)(this,"onAudioOutputChanged",e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){s.vF.error("Couldn't set requested audio output device: using default",e),s.vF.warn("Couldn't set requested audio output device: using default",e)}}),(0,S.A)(this,"onNewStream",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted()}),this.playMedia()}),this.state={audioMuted:this.props.feed.isAudioMuted()}}componentDidMount(){Da.Ay.instance.addListener(Da.hW.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener(pS.BL.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){Da.Ay.instance.removeListener(Da.hW.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener(pS.BL.NewStream,this.onNewStream),this.stopMedia()}async playMedia(){const e=this.element.current;if(e){this.onAudioOutputChanged(Da.Ay.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.load()}catch(e){s.vF.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.removeAttribute("src"))}render(){return this.state.audioMuted?null:o.createElement("audio",{ref:this.element})}}class vS extends o.Component{constructor(e){super(e),(0,S.A)(this,"onFeedsChanged",()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})}),this.state={feeds:this.props.call.getRemoteFeeds()}}componentDidMount(){this.props.call.addListener(nn.$E.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(nn.$E.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map((e,t)=>o.createElement(gS,{feed:e,key:t}))}}var fS=n("./src/shouldHideEvent.ts"),_S=n("./src/TimezoneHandler.ts"),yS=n("./src/ContentMessages.ts"),bS=n("./node_modules/re-resizable/lib/index.js");class ES extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),(0,S.A)(this,"onResize",()=>{this.props.resizeNotifier.notifyRightHandleResized()}),(0,S.A)(this,"onResizeStop",(e,t,n,i)=>{const r=this.loadSidePanelSize().width+i.width;this.props.resizeNotifier.stopResizing(),window.localStorage.setItem(this.sizeSettingStorageKey,r.toString()),z.Vo.instance.trackEvent({eventName:"WebPanelResize",panel:"right",roomType:this.props.analyticsRoomType,size:r})})}get sizeSettingStorageKey(){let e="mx_rhs_size";return this.props.sizeKey&&(e+=`_${this.props.sizeKey}`),e}loadSidePanelSize(){let e=parseInt(window.localStorage.getItem(this.sizeSettingStorageKey),10);return isNaN(e)&&(e=this.props.defaultSize),{height:"100%",width:e}}render(){const e=o.Children.only(this.props.children),t=this.props.panel;let n;return!this.props.collapsedRhs&&t&&(n=o.createElement(bS.c,{key:this.props.sizeKey,defaultSize:this.loadSidePanelSize(),minWidth:320,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_ResizeHandle--horizontal"}},t)),o.createElement("div",{className:"mx_MainSplit"},e,n)}}(0,S.A)(ES,"defaultProps",{defaultSize:320});var wS=n("./node_modules/@vector-im/compound-web/dist/components/Link/Link.js"),SS=n("./node_modules/@vector-im/compound-web/dist/components/Typography/Heading.js"),xS=n("./node_modules/@vector-im/compound-web/dist/components/Badge/Badge.js"),AS=n("./node_modules/@vector-im/compound-web/dist/components/Form/Root.js");const CS="_search_b2pjl_8",kS="_icon_b2pjl_37",RS="_input_b2pjl_52";var IS=n("./node_modules/@vector-im/compound-web/dist/components/Form/Field.js"),TS=n("./node_modules/@vector-im/compound-web/dist/components/Form/Label.js");const PS=["className","onChange","placeholder","name"];function NS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function DS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?NS(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):NS(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const MS=(0,o.forwardRef)(function(e,t){let{className:n,onChange:i,placeholder:r="Search",name:s}=e,a=(0,v.A)(e,PS);const l=ue(CS,n),c=(0,o.useId)();return(0,$.jsx)(IS.D,{name:s,asChild:!0,children:(0,$.jsxs)(TS.J,{className:l,htmlFor:c,children:[(0,$.jsx)(Lg.A,{className:kS,width:20,height:20}),(0,$.jsx)("input",DS(DS({ref:t},a),{},{id:c,name:s,type:"search",placeholder:r,onChange:i,className:RS}))]})})});function OS(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M5 21q-.824 0-1.412-.587A1.93 1.93 0 0 1 3 19V6.5q0-.375.125-.675t.325-.575l1.4-1.7q.2-.274.5-.412T6 3h12q.35 0 .65.138.3.137.5.412l1.4 1.7q.2.275.325.575T21 6.5V19q0 .824-.587 1.413A1.93 1.93 0 0 1 19 21zm.4-15h13.2l-.85-1H6.25zM5 19h14V8H5zm7-1.425q.2 0 .375-.062a.9.9 0 0 0 .325-.213l2.6-2.6a.95.95 0 0 0 .275-.7.95.95 0 0 0-.275-.7.95.95 0 0 0-.7-.275.95.95 0 0 0-.7.275l-.9.9V11a.97.97 0 0 0-.287-.713A.97.97 0 0 0 12 10a.97.97 0 0 0-.713.287A.97.97 0 0 0 11 11v3.2l-.9-.9a.95.95 0 0 0-.7-.275.95.95 0 0 0-.7.275.95.95 0 0 0-.275.7q0 .425.275.7l2.6 2.6q.15.15.325.212.175.063.375.063"})})}OS.displayName="ExportArchiveIcon";const FS=(0,o.forwardRef)(OS);var LS=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/files.js");function US(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M17.25 11.672a.9.9 0 0 1-.663-.282L12.61 7.413a.9.9 0 0 1-.282-.663q0-.381.282-.663l3.977-3.977a.9.9 0 0 1 .663-.282q.381 0 .663.282l3.977 3.977a.9.9 0 0 1 .282.663.9.9 0 0 1-.282.663l-3.977 3.977a.9.9 0 0 1-.663.282m2.475-4.922L17.25 4.275 14.775 6.75l2.475 2.475zM4 11a.97.97 0 0 1-.712-.287A.97.97 0 0 1 3 10V4q0-.424.288-.712A.97.97 0 0 1 4 3h6q.424 0 .713.288Q11 3.575 11 4v6q0 .424-.287.713A.97.97 0 0 1 10 11zm5-2V5H5v4zm5 12a.97.97 0 0 1-.713-.288A.97.97 0 0 1 13 20v-6q0-.424.287-.713A.97.97 0 0 1 14 13h6q.424 0 .712.287.288.288.288.713v6q0 .424-.288.712A.97.97 0 0 1 20 21zm5-2v-4h-4v4zM4 21a.97.97 0 0 1-.712-.288A.97.97 0 0 1 3 20v-6q0-.424.288-.713A.97.97 0 0 1 4 13h6q.424 0 .713.287.287.288.287.713v6q0 .424-.287.712A.97.97 0 0 1 10 21zm5-2v-4H5v4z"})})}US.displayName="ExtensionsIcon";const BS=(0,o.forwardRef)(US);function VS(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M9.175 13.825Q10.35 15 12 15t2.825-1.175T16 11t-1.175-2.825T12 7 9.175 8.175 8 11t1.175 2.825m4.237-1.412A1.93 1.93 0 0 1 12 13q-.825 0-1.412-.588A1.93 1.93 0 0 1 10 11q0-.825.588-1.412A1.93 1.93 0 0 1 12 9q.825 0 1.412.588Q14 10.175 14 11t-.588 1.412"}),(0,$.jsx)("path",{d:"M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10m-2 0a8 8 0 1 0-16 0 8 8 0 0 0 16 0"}),(0,$.jsx)("path",{d:"M16.23 18.792a13 13 0 0 0-1.455-.455 11.6 11.6 0 0 0-5.55 0q-.73.18-1.455.455a8 8 0 0 1-1.729-1.454q1.336-.618 2.709-.95A13.8 13.8 0 0 1 12 16q1.65 0 3.25.387 1.373.333 2.709.95a8 8 0 0 1-1.73 1.455"})]})}VS.displayName="UserProfileIcon";const jS=(0,o.forwardRef)(VS);function zS(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M16 10q.424 0 .712-.287A.97.97 0 0 0 17 9a.97.97 0 0 0-.288-.713A.97.97 0 0 0 16 8h-3a.97.97 0 0 0-.713.287A.97.97 0 0 0 12 9q0 .424.287.713.288.287.713.287zm0 6q.424 0 .712-.287A.97.97 0 0 0 17 15a.97.97 0 0 0-.288-.713A.97.97 0 0 0 16 14h-3a.97.97 0 0 0-.713.287A.97.97 0 0 0 12 15q0 .424.287.713.288.287.713.287zm-7-5q.825 0 1.412-.588Q11 9.826 11 9t-.588-1.412A1.93 1.93 0 0 0 9 7q-.825 0-1.412.588A1.93 1.93 0 0 0 7 9q0 .825.588 1.412Q8.175 11 9 11m0 6q.825 0 1.412-.587Q11 15.825 11 15t-.588-1.412A1.93 1.93 0 0 0 9 13q-.825 0-1.412.588A1.93 1.93 0 0 0 7 15q0 .824.588 1.413Q8.175 17 9 17m-4 4q-.824 0-1.412-.587A1.93 1.93 0 0 1 3 19V5q0-.824.587-1.412A1.93 1.93 0 0 1 5 3h14q.824 0 1.413.587Q21 4.176 21 5v14q0 .824-.587 1.413A1.93 1.93 0 0 1 19 21zm0-2h14V5H5z"})})}zS.displayName="PollsIcon";const HS=(0,o.forwardRef)(zS);var WS=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/lock-solid.js"),GS=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/lock-off.js"),KS=n("./src/components/views/right_panel/BaseCard.tsx"),qS=n("./src/utils/ShieldUtils.ts"),$S=n("./src/shared-components/utils/Box/Box.module.css");const JS=["as","flex","shrink","grow","className","children"];function YS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function XS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?YS(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):YS(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function QS(e){let{as:t="div",flex:n=null,shrink:i=null,grow:r=null,className:s,children:a}=e,l=(0,v.A)(e,JS);const c=(0,o.useMemo)(()=>{const e={};return n&&(e["--mx-box-flex"]=n),i&&(e["--mx-box-shrink"]=i),r&&(e["--mx-box-grow"]=r),e},[n,r,i]);return o.createElement(t,XS(XS({},l),{},{className:me()(s,{[$S.A["box-flex"]]:!!n,[$S.A["box-shrink"]]:!!i,[$S.A["box-grow"]]:!!r}),style:c}),a)}var ZS=n("./node_modules/@floating-ui/react/dist/floating-ui.react.mjs");const ex="_content_3xq91_8",tx="_header_3xq91_37",nx="_description_3xq91_43",ix="_button_3xq91_48",rx="_arrow_3xq91_53",ox=(0,o.createContext)(null);function sx(){const e=(0,o.useContext)(ox);if(null==e)throw new Error("ReleaseAnnouncement components must be wrapped in <ReleaseAnnouncement />");return e}var ax=n("./node_modules/@floating-ui/dom/dist/floating-ui.dom.mjs"),lx=n("./node_modules/@floating-ui/react-dom/dist/floating-ui.react-dom.mjs");function cx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function dx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cx(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cx(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const ux=["children","placement","displayArrow"],mx=["context","arrowRef","displayArrow"];function hx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function px(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?hx(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):hx(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function gx(e){let{children:t,placement:n="right",displayArrow:i=!0}=e;const r=function({open:e,header:t,description:n,closeLabel:i,placement:r,onClick:s,displayArrow:a}){const l=(0,ZS.Bi)(),c=(0,ZS.Bi)(),d=(0,o.useRef)(null),u=(0,ZS.we)({placement:r,open:e,whileElementsMounted:ax.ll,middleware:[(0,lx.cY)(16),(0,lx.BN)({limiter:(0,lx.ER)({offset:50})}),a&&(0,lx.UE)({element:d})]}),m=(0,ZS.It)(u.context),h=(0,ZS.bv)([m]);return(0,o.useMemo)(()=>dx(dx(dx({open:e},u),h),{},{labelId:l,descriptionId:c,header:t,description:n,closeLabel:i,onClick:s,displayArrow:a,arrowRef:d}),[e,m,h,u,l,c,t,n,i,s,a,d])}(px({placement:n,displayArrow:i},(0,v.A)(e,ux)));return(0,$.jsxs)(ox.Provider,{value:r,children:[(0,$.jsx)(vx,{children:t}),(0,$.jsx)(fx,{children:(0,$.jsx)(_x,{})})]})}function vx({children:e}){const t=sx(),n=null==e?void 0:e.ref,i=(0,ZS.SV)([t.refs.setReference,n]);if(!(0,o.isValidElement)(e))throw new Error("ReleaseAnnouncement anchor must be a single valid React element");return(0,o.cloneElement)(e,t.getReferenceProps(px({ref:i},t.open&&{"aria-describedby":t.getFloatingProps().id})))}function fx({children:e}){const t=sx(),{context:n,arrowRef:i,displayArrow:r}=t,o=(0,v.A)(t,mx);return n.open?(0,$.jsx)(ZS.XF,{children:(0,$.jsx)(ZS.s3,{context:n,modal:!1,children:(0,$.jsxs)("div",px(px({ref:o.refs.setFloating,style:o.floatingStyles,"aria-labelledby":o.labelId,"aria-describedby":o.descriptionId},o.getFloatingProps()),{},{className:ex,children:[r&&(0,$.jsx)(ZS.ie,{ref:i,context:n,width:20,height:12,className:rx}),e]}))})}):null}function _x(){const{labelId:e,descriptionId:t,header:n,description:i,closeLabel:r,onClick:o}=sx();return(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(og.E,{as:"h3",id:e,className:tx,size:"lg",weight:"semibold",children:n}),(0,$.jsx)(og.E,{as:"span",id:t,className:nx,size:"sm",weight:"regular",children:i}),(0,$.jsx)(Ae.$,{size:"sm",kind:"secondary",className:ix,onClick:o,children:r})]})}var yx=n("./src/settings/Settings.tsx");const bx=["pinningMessageList"];class Ex extends i.TypedEventEmitter{static get instance(){return Ex.internalInstance||(Ex.internalInstance=new Ex),Ex.internalInstance}constructor(){super(),(0,S.A)(this,"index",0),O.A.watchSetting("releaseAnnouncementData",null,()=>{this.emit("releaseAnnouncementChanged",this.getReleaseAnnouncement())})}getViewedReleaseAnnouncements(){return(0,Li.cloneDeep)(O.A.getValue("releaseAnnouncementData"))}isReleaseAnnouncementEnabled(){return O.A.getValue(yx.O5.ReleaseAnnouncement)}getReleaseAnnouncement(){if(!this.isReleaseAnnouncementEnabled())return null;const e=this.getViewedReleaseAnnouncements();for(let t=this.index;t<bx.length;t++)if(!e[bx[t]])return this.index=t,bx[this.index];return null}async markReleaseAnnouncementAsViewed(){if(!this.isReleaseAnnouncementEnabled())return;const e=this.getViewedReleaseAnnouncements();if(!bx[this.index])return;e[bx[this.index]]=!0,this.index++;if(!O.A.isLevelSupported(F.p.ACCOUNT))return;if(O.A.canSetValue("releaseAnnouncementData",null,F.p.ACCOUNT))try{await O.A.setValue("releaseAnnouncementData",null,F.p.ACCOUNT,e)}catch(e){s.vF.log("Failed to set release announcement settings",e)}}async nextReleaseAnnouncement(){await this.markReleaseAnnouncementAsViewed(),this.emit("releaseAnnouncementChanged",this.getReleaseAnnouncement())}}function wx(e){const t=function(){const[e,t]=(0,o.useState)(!1);return(0,lr.YK)(R.Ay,R.XM.Opened,()=>t(!0)),(0,lr.YK)(R.Ay,R.XM.Closed,()=>!R.Ay.hasDialogs()&&t(!1)),e}(),n=(0,lr.DY)(Ex.instance,"releaseAnnouncementChanged",()=>Ex.instance.getReleaseAnnouncement()===e);return!t&&n}(0,S.A)(Ex,"internalInstance",void 0);const Sx=["feature","children"];function xx(e){let{feature:t,children:n}=e,i=(0,v.A)(e,Sx);const r=wx(t);return o.createElement(gx,(0,tn.A)({open:r,onClick:()=>Ex.instance.nextReleaseAnnouncement()},i),n)}var Ax=n("./src/hooks/useIsEncrypted.ts"),Cx=n("./src/utils/video-rooms.ts");function kx(e){const t=e.client;return(!!e.canInvite(t.getSafeUserId())||!(!e.isSpaceRoom()||e.getJoinRule()!==i.JoinRule.Public))&&e.getMyMembership()===Xt.O.Join&&(0,Ya.g)(It.C.InviteUsers)}var Rx=n("./src/components/views/polls/pollHistory/PollHistory.tsx");const Ix=({room:e,matrixClient:t,permalinkCreator:n,onFinished:i})=>o.createElement(X.A,{onFinished:i},o.createElement(Rx.a,{room:e,matrixClient:t,permalinkCreator:n,onFinished:i}));var Tx=n("./src/components/views/elements/StyledRadioGroup.tsx");let Px=function(e){return e.Html="Html",e.PlainText="PlainText",e.Json="Json",e}({}),Nx=function(e){return e.Timeline="Timeline",e.Beginning="Beginning",e.LastNMessages="LastNMessages",e}({});const Dx=e=>{switch(e){case Px.Html:return(0,c._t)("export_chat|html");case Px.Json:return(0,c._t)("export_chat|json");case Px.PlainText:return(0,c._t)("export_chat|text");default:throw new Error("Unknown format")}};var Mx=n("./src/components/views/elements/Validation.tsx"),Ox=n("./node_modules/react-dom/client.js"),Fx=n("./node_modules/react-dom/server.browser.js"),Lx=n("./node_modules/escape-html/index.js"),Ux=n.n(Lx),Bx=n("./node_modules/file-saver/dist/FileSaver.min.js"),Vx=n("./node_modules/sanitize-filename/index.js"),jx=n.n(Vx),zx=n("./src/utils/DecryptFile.ts");function Hx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function Wx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Hx(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Hx(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class Gx{constructor(e,t,n,i){if((0,S.A)(this,"files",[]),(0,S.A)(this,"fileNames",new Map),(0,S.A)(this,"cancelled",!1),(0,S.A)(this,"getRelationsForEvent",(e,t,n)=>this.room.getUnfilteredTimelineSet().relations.getChildEventsForEvent(e,t,n)),this.room=e,this.exportType=t,this.exportOptions=n,this.setProgressText=i,n.maxSize<1048576||n.maxSize>8388608e3||n.numberOfMessages&&n.numberOfMessages>10**8||t===Nx.LastNMessages&&!n.numberOfMessages)throw new Error("Invalid export options");window.addEventListener("beforeunload",this.onBeforeUnload)}get destinationFileName(){return this.makeFileNameNoExtension(d.Ay.get().brand)+".zip"}onBeforeUnload(e){return e.preventDefault(),e.returnValue=(0,c._t)("export_chat|unload_confirm")}updateProgress(e,t=!0,n=!0){t&&s.vF.log(e),n&&this.setProgressText(e)}addFile(e,t){const n={name:e,blob:t};this.files.push(n)}makeFileNameNoExtension(e="matrix"){var t;const n=jx()(null!==(t=this.room.name)&&void 0!==t?t:(0,c._t)("common|unnamed_room")).trim()||"Unnamed Room",i=(0,gt.td)(new Date).replace(/:/g,"-");return`${jx()(e)} - ${n} - Chat Export - ${i}`}async downloadZIP(){const e=this.destinationFileName,t=e.substring(0,e.lastIndexOf(".")),{default:i}=await n.e(3260).then(n.t.bind(n,"./node_modules/jszip/dist/jszip.min.js",23)),r=new i;if(this.cancelled)return this.cleanUp();this.updateProgress((0,c._t)("export_chat|generating_zip"));for(const e of this.files)r.file(t+"/"+e.name,e.blob);const o=await r.generateAsync({type:"blob"});(0,Bx.saveAs)(o,t+".zip")}cleanUp(){return s.vF.log("Cleaning up..."),window.removeEventListener("beforeunload",this.onBeforeUnload),""}async cancelExport(){s.vF.log("Cancelling export..."),this.cancelled=!0}downloadPlainText(e,t){const n=new Blob([t],{type:"text/plain"});(0,Bx.saveAs)(n,e)}setEventMetadata(e){return e.setMetadata(this.room.currentState,!1),e}getLimit(){let e;if(this.exportType===Nx.LastNMessages)e=this.exportOptions.numberOfMessages;else e=10**8;return e}async getRequiredEvents(){const e=this.room.client.getEventMapper();let t=null,n=[];if(this.exportType===Nx.Timeline)n=this.room.getLiveTimeline().getEvents();else{let o=this.getLimit();for(;o;){var r;const s=Math.min(o,1e3),a=await this.room.client.createMessagesRequest(this.room.roomId,t,s,i.Direction.Backward);if(this.cancelled)return this.cleanUp(),[];if(0===a.chunk.length)break;o-=a.chunk.length;const l=a.chunk.map(e);for(const e of l)n.push(e);this.exportType===Nx.LastNMessages?this.updateProgress((0,c._t)("export_chat|fetched_n_events_with_total",{count:n.length,total:this.exportOptions.numberOfMessages})):this.updateProgress((0,c._t)("export_chat|fetched_n_events",{count:n.length})),t=null!==(r=a.end)&&void 0!==r?r:null}n.reverse()}const o=n.filter(e=>e.isEncrypted()).map(e=>this.room.client.decryptEventIfNeeded(e,{emit:!1}));await Promise.all(o);for(let e=0;e<n.length;e++)this.setEventMetadata(n[e]);return n}async getMediaBlob(e){let t;try{const n=e.isEncrypted(),i=e.getContent();if(n&&i.hasOwnProperty("file")&&"m.sticker"!==e.getType())t=await(0,zx.It)(i.file);else{const e=(0,Vi.mediaFromContent)(i);if(!e.srcHttp)throw new Error("Cannot fetch without srcHttp");const n=await fetch(e.srcHttp);t=await n.blob()}}catch{s.vF.log("Error decrypting media")}if(!t)throw new Error("Unable to fetch file");return t}splitFileName(e){const t=e.lastIndexOf(".");if(-1===t)return[e,""];return[e.slice(0,t),"."+e.slice(t+1)]}makeUniqueFilePath(e){const t=({directory:e,name:t,date:n,extension:i,count:r=0})=>`${e}/${t}-${n}${r>0?` (${r})`:""}${i}`,n=t(e),i=this.fileNames.get(n)||0;return this.fileNames.set(n,i+1),i>0?t(Wx(Wx({},e),{},{count:i})):n}getFilePath(e){let t;switch(e.getContent().msgtype){case"m.image":t="images";break;case"m.video":t="videos";break;case"m.audio":t="audio";break;default:t="m.sticker"===e.getType()?"stickers":"files"}const n=(0,gt.ej)(new Date(e.getTs()));let[i,r]=this.splitFileName(e.getContent().body);return"m.sticker"===e.getType()&&(r=".png"),(0,gn.Mp)(e)&&(r=".ogg"),this.makeUniqueFilePath({directory:t,name:i,date:n,extension:r})}isReply(e){const t=(e.isEncrypted()?e.event.content:e.getContent())["m.relates_to"];return!(!t||!t["m.in_reply_to"])}isAttachment(e){const t=["m.sticker","m.image","m.file","m.video","m.audio"];return e.getType()===t[0]||t.includes(e.getContent().msgtype)}}class Kx extends o.Component{constructor(e){super(e),(0,S.A)(this,"onMouseDown",e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)}),(0,S.A)(this,"onMouseUp",e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)}),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return o.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown})}}class qx extends o.Component{constructor(e){super(e),(0,S.A)(this,"dragFunc",(e,t)=>{const n=t.clientX-e.currentX,i=this.state.width+n;return i<this.props.minWidth||i>this.props.maxWidth?e:(this.setState({width:i}),this.updateCSSWidth.bind(this)(i),{currentX:t.clientX,currentY:e.currentY})}),(0,S.A)(this,"onMoueUp",()=>{this.props.roomId&&O.A.setValue("ircDisplayNameWidth",this.props.roomId,F.p.ROOM_DEVICE,this.state.width)}),this.state={width:O.A.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},()=>this.updateCSSWidth(this.state.width))}updateCSSWidth(e){var t;null===(t=this.state.IRCLayoutRoot)||void 0===t||t.style.setProperty("--name-width",e+"px")}render(){return o.createElement(Kx,{className:"mx_ProfileResizer",dragFunc:this.dragFunc,onMouseUp:this.onMoueUp})}}function $x(e){return Yx(e,[e.client.getSafeUserId()].concat(e.client.getIgnoredUsers()))}function Jx(e){return Yx(e,[e.client.getSafeUserId()])}function Yx(e,t=[]){const n=[],i=Object.keys(e.currentState.members);for(const r of i)e.currentState.members[r].typing&&-1===t.indexOf(r)&&n.push(e.currentState.members[r]);return n}class Xx extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"state",{usersTyping:Jx(this.props.room),delayedStopTypingTimers:{}}),(0,S.A)(this,"isVisible",()=>Xx.isVisible(this.state)),(0,S.A)(this,"onRoomTimeline",(e,t)=>{if((null==t?void 0:t.roomId)===this.props.room.roomId){const t=e.getSender(),n=this.state.usersTyping.filter(e=>e.userId!==t);n.length!==this.state.usersTyping.length&&this.setState({usersTyping:n}),this.abortUserTimer(t)}}),(0,S.A)(this,"onRoomMemberTyping",()=>{const e=$x(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})})}componentDidMount(){f.J.safeGet().on(i.RoomMemberEvent.Typing,this.onRoomMemberTyping),f.J.safeGet().on(i.RoomEvent.Timeline,this.onRoomTimeline)}componentDidUpdate(e,t){const n=Xx.isVisible(t),i=Xx.isVisible(this.state);this.props.onShown&&!n&&i?this.props.onShown():this.props.onHidden&&n&&!i&&this.props.onHidden()}componentWillUnmount(){const e=f.J.get();e&&(e.removeListener(i.RoomMemberEvent.Typing,this.onRoomMemberTyping),e.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach(e=>e.abort())}static isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter(t=>!e.some(e=>t.userId===e.userId)),n=e.filter(e=>!this.state.usersTyping.some(t=>e.userId===t.userId));n.forEach(e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()});let i=Object.assign({},this.state.delayedStopTypingTimers);return i=n.reduce((e,t)=>(delete e[t.userId],e),i),i=t.reduce((e,t)=>{if(!e[t.userId]){const n=new A.A(5e3);e[t.userId]=n,n.start(),n.finished().then(()=>this.removeUserTimer(t.userId),()=>{})}return e},i),i}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let n=0;e.length>t&&(n=e.length-t+1,e=e.slice(0,t-1));const i=e.map(e=>o.createElement(bn.A,{key:e.userId,member:e,size:"24px",resizeMethod:"crop",viewUserOnClick:!0,"aria-live":"off"}));return n>0&&i.push(o.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",n)),i}render(){const e=[...this.state.usersTyping];for(const t in this.state.delayedStopTypingTimers){const n=this.props.room.getMember(t);n&&e.push(n)}const t=new Intl.Collator;e.sort((e,n)=>t.compare(e.name,n.name));const n=function(e,t){let n=0;if(e.length>t&&(n=e.length-t+1),0===e.length)return"";if(1===e.length)return(0,c._t)("timeline|typing_indicator|one_user",{displayName:e[0].name});const i=e.map(e=>e.name);if(n>=1)return(0,c._t)("timeline|typing_indicator|more_users",{names:i.slice(0,t-1).join(", "),count:n});{const e=i.pop();return(0,c._t)("timeline|typing_indicator|two_users",{names:i.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return n?o.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},o.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),o.createElement("div",{className:"mx_WhoIsTypingTile_label"},n)):null}}(0,S.A)(Xx,"defaultProps",{whoIsTypingLimit:3});var Qx=n("./src/components/structures/ScrollPanel.tsx"),Zx=n("./src/components/views/messages/DateSeparator.tsx"),eA=n("./src/components/views/messages/TimelineSeparator.tsx"),tA=n("./src/components/views/elements/ErrorBoundary.tsx"),nA=n("./src/Editing.ts");class iA{constructor(e,t,n,i,r,o){(0,S.A)(this,"events",[]),(0,S.A)(this,"ejectedEvents",[]),(0,S.A)(this,"readMarker",void 0),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=n,this.lastShownEvent=i,this.nextEvent=r,this.nextEventTile=o,this.readMarker=e.readMarkerForEvent(t.event.getId(),t.event===i)}}(0,S.A)(iA,"canStartGroup",(e,t)=>!0);var rA=n("./src/TextForEvent.tsx"),oA=n("./src/components/views/messages/EventTileBubble.tsx");const sA=()=>{var e;const{room:t}=(0,yr.ME)("room"),n=null==t?void 0:t.getLiveTimeline().getState(i.EventTimeline.BACKWARDS),r=null==n||null===(e=n.getStateEvents("m.room.history_visibility")[0])||void 0===e?void 0:e.getContent().history_visibility;let s;return"invited"==r?s=(0,c._t)("timeline|no_permission_messages_before_invite"):"joined"==r&&(s=(0,c._t)("timeline|no_permission_messages_before_join")),o.createElement(oA.A,{className:"mx_HistoryTile",title:(0,c._t)("timeline|historical_messages_unavailable"),subtitle:s})},aA=({events:e,children:t,threshold:n=3,onToggle:i,startExpanded:r=!1,summaryMembers:a=[],summaryText:l,layout:d=Zt.P.Group})=>{const[u,m]=(0,Go.X)(r);(0,o.useEffect)(()=>{i&&i()},[u]);const h=e.map(e=>e.getId()).join(",");if(e.length<n)return o.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":h,"data-expanded":!0,"data-layout":d},o.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));let p;if(u)p=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_GenericEventListSummary_spacer"},""),o.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},t));else{const e=(0,Li.uniqBy)(a.filter(e=>!(null==e||!e.getMxcAvatarUrl)||(s.vF.error("EventListSummary given null summaryMember, termites may be afoot eating event senders",a),!1)),e=>e.getMxcAvatarUrl()).map(e=>o.createElement(bn.A,{key:e.userId,member:e,size:"14px"}));p=o.createElement("div",{className:"mx_EventTile_line"},o.createElement("div",{className:"mx_EventTile_info"},o.createElement("span",{className:"mx_GenericEventListSummary_avatars",onClick:m},e),o.createElement("span",{className:"mx_TextualEvent mx_GenericEventListSummary_summary"},l)))}return o.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":h,"data-expanded":u+"","data-layout":d},o.createElement(ae.A,{kind:"link_inline",className:"mx_GenericEventListSummary_toggle",onClick:m,"aria-expanded":u},u?(0,c._t)("action|collapse"):(0,c._t)("action|expand")),p)};var lA=n("./src/utils/ReactUtils.tsx");const cA=()=>{lg.A.instance.setCard({phase:cg.n.PinnedMessages},!1)},dA=[i.EventType.RoomMember];var uA=function(e){return e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl",e.ChangedPins="pinned_messages",e.MessageRemoved="message_removed",e.HiddenEvent="hidden_event",e}(uA||{});class mA extends o.Component{constructor(e){super(e),(0,S.A)(this,"onEventSentinelUpdated",(0,Li.throttle)(()=>{console.log("@@ SENTINEL UPDATED"),this.setState(this.generateState())},500,{leading:!0,trailing:!0})),this.state=this.generateState()}generateState(){const e=this.props.events,t=new Map,n={};return e.forEach((e,r)=>{var o;const s=e.getType();let a=e.getSender();e.isState()&&s===i.EventType.RoomThirdPartyInvite?a=e.getContent().display_name:e.isState()&&s===i.EventType.RoomMember?a=e.getStateKey():e.isRedacted()&&null!==(o=e.getUnsigned())&&void 0!==o&&o.redacted_because&&(a=e.getUnsigned().redacted_because.sender),n[a]||(n[a]=[]);let l=a;if(e.isRedacted()){var c;const e=null===(c=this.context)||void 0===c||null===(c=c.room)||void 0===c?void 0:c.getMember(a);e&&(l=e.name,t.set(a,e))}else e.target&&dA.includes(s)?(l=e.target.name,t.set(a,e.target)):e.sender&&s!==i.EventType.RoomThirdPartyInvite&&(l=e.sender.name,t.set(a,e.sender));n[a].push({mxEvent:e,displayName:l,index:r})}),{userEvents:n,summaryMembers:Array.from(t.values())}}componentDidMount(){this.bindSentinelListeners(this.props.events)}componentDidUpdate(e){e.events!==this.props.events&&(this.unbindSentinelListeners(e.events),this.bindSentinelListeners(this.props.events),this.setState(this.generateState()))}componentWillUnmount(){this.unbindSentinelListeners(this.props.events)}bindSentinelListeners(e){for(const t of e)t.on(i.MatrixEventEvent.SentinelUpdated,this.onEventSentinelUpdated)}unbindSentinelListeners(e){for(const t of e)t.on(i.MatrixEventEvent.SentinelUpdated,this.onEventSentinelUpdated)}shouldComponentUpdate(e,t){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold||e.layout!==this.props.layout||(0,ie.dc)(t.summaryMembers,this.state.summaryMembers)||(0,ie.dc)(Object.values(t.userEvents),Object.values(this.state.userEvents))||Object.keys(t.userEvents).length!==Object.keys(this.state.userEvents).length||Object.keys(t.userEvents).some(e=>t.userEvents[e].some((t,n)=>{var i,r;return(0,Dn.No)(t,null!==(i=null===(r=this.state.userEvents[e])||void 0===r?void 0:r[n])&&void 0!==i?i:{})}))}generateSummary(e,t){const n=t.map(t=>{const n=e[t],i=this.renderNameList(n),r=t.split(","),o=mA.getCanonicalTransitions(r),s=mA.coalesceRepeatedTransitions(o).map(e=>mA.getDescriptionForTransition(e.transitionType,n.length,e.repeats)),a=(0,sn.ki)(s);return(0,c._t)("timeline|summary|format",{nameList:i,transitionList:a})});return n?(0,lA.i)(n,", "):null}renderNameList(e){return(0,sn.ki)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[uA.Joined]:{after:uA.Left,newTransition:uA.JoinedAndLeft},[uA.Left]:{after:uA.Joined,newTransition:uA.LeftAndJoined}},n=[];for(let i=0;i<e.length;i++){const r=e[i],o=e[i+1];let s=r;i<e.length-1&&t[r]&&t[r].after===o&&(s=t[r].newTransition,i++),n.push(s)}return n}static coalesceRepeatedTransitions(e){const t=[];for(const n of e)t.length>0&&t[t.length-1].transitionType===n?t[t.length-1].repeats+=1:t.push({transitionType:n,repeats:1});return t}static getDescriptionForTransition(e,t,n){let i;switch(e){case uA.Joined:i=t>1?(0,c._t)("timeline|summary|joined_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|joined",{oneUser:"",count:n});break;case uA.Left:i=t>1?(0,c._t)("timeline|summary|left_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|left",{oneUser:"",count:n});break;case uA.JoinedAndLeft:i=t>1?(0,c._t)("timeline|summary|joined_and_left_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|joined_and_left",{oneUser:"",count:n});break;case uA.LeftAndJoined:i=t>1?(0,c._t)("timeline|summary|rejoined_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|rejoined",{oneUser:"",count:n});break;case uA.InviteReject:i=t>1?(0,c._t)("timeline|summary|rejected_invite_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|rejected_invite",{oneUser:"",count:n});break;case uA.InviteWithdrawal:i=t>1?(0,c._t)("timeline|summary|invite_withdrawn_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|invite_withdrawn",{oneUser:"",count:n});break;case uA.Invited:i=t>1?(0,c._t)("timeline|summary|invited_multiple",{count:n}):(0,c._t)("timeline|summary|invited",{count:n});break;case uA.Banned:i=t>1?(0,c._t)("timeline|summary|banned_multiple",{count:n}):(0,c._t)("timeline|summary|banned",{count:n});break;case uA.Unbanned:i=t>1?(0,c._t)("timeline|summary|unbanned_multiple",{count:n}):(0,c._t)("timeline|summary|unbanned",{count:n});break;case uA.Kicked:i=t>1?(0,c._t)("timeline|summary|kicked_multiple",{count:n}):(0,c._t)("timeline|summary|kicked",{count:n});break;case uA.ChangedName:i=t>1?(0,c._t)("timeline|summary|changed_name_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|changed_name",{oneUser:"",count:n});break;case uA.ChangedAvatar:i=t>1?(0,c._t)("timeline|summary|changed_avatar_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|changed_avatar",{oneUser:"",count:n});break;case uA.NoChange:i=t>1?(0,c._t)("timeline|summary|no_change_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|no_change",{oneUser:"",count:n});break;case uA.ServerAcl:i=t>1?(0,c._t)("timeline|summary|server_acls_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|server_acls",{oneUser:"",count:n});break;case uA.ChangedPins:i=t>1?(0,c._t)("timeline|summary|pinned_events_multiple",{severalUsers:"",count:n},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:cA},e)}):(0,c._t)("timeline|summary|pinned_events",{oneUser:"",count:n},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:cA},e)});break;case uA.MessageRemoved:i=t>1?(0,c._t)("timeline|summary|redacted_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|redacted",{oneUser:"",count:n});break;case uA.HiddenEvent:i=t>1?(0,c._t)("timeline|summary|hidden_event_multiple",{severalUsers:"",count:n}):(0,c._t)("timeline|summary|hidden_event",{oneUser:"",count:n})}return null!=i?i:null}static getTransitionSequence(e){return e.map(mA.getTransition)}static getTransition(e){if(e.mxEvent.isRedacted())return uA.MessageRemoved;switch(e.mxEvent.getType()){case i.EventType.RoomThirdPartyInvite:return(0,da.Qo)(e.mxEvent)?uA.Invited:uA.InviteWithdrawal;case i.EventType.RoomServerAcl:return uA.ServerAcl;case i.EventType.RoomPinnedEvents:return uA.ChangedPins;case i.EventType.RoomMember:switch(e.mxEvent.getContent().membership){case Xt.O.Invite:return uA.Invited;case Xt.O.Ban:return uA.Banned;case Xt.O.Join:return e.mxEvent.getPrevContent().membership===Xt.O.Join?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?uA.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?uA.ChangedAvatar:uA.NoChange:uA.Joined;case Xt.O.Leave:if(e.mxEvent.getSender()===e.mxEvent.getStateKey())return e.mxEvent.getPrevContent().membership===Xt.O.Invite?uA.InviteReject:uA.Left;switch(e.mxEvent.getPrevContent().membership){case Xt.O.Invite:return uA.InviteWithdrawal;case Xt.O.Ban:return uA.Unbanned;default:return uA.Kicked}default:return null}default:return uA.HiddenEvent}}getAggregate(e){const t={},n={};return Object.keys(e).forEach(i=>{const r=e[i][0],o=r.displayName,s=mA.getTransitionSequence(e[i]).join(",");t[s]||(t[s]=[],n[s]=-1),t[s].push(o),(-1===n[s]||r.index<n[s])&&(n[s]=r.index)}),{names:t,indices:n}}render(){const e=this.getAggregate(this.state.userEvents),t=Object.keys(e.names).sort((t,n)=>e.indices[t]-e.indices[n]);return o.createElement(aA,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:this.state.summaryMembers,layout:this.props.layout,summaryText:this.generateSummary(e.names,t)})}}(0,S.A)(mA,"contextType",kn.Ay),(0,S.A)(mA,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5,layout:Zt.P.Group});const hA=[i.EventType.RoomMember,i.EventType.RoomThirdPartyInvite,i.EventType.RoomServerAcl,i.EventType.RoomPinnedEvents];class pA extends iA{constructor(e,t,n,i,r,o){super(e,t,n,i,r,o),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=n,this.lastShownEvent=i,this.events=[t]}shouldGroup({event:e,shouldShow:t}){return!t||this.panel.wantsSeparator(this.events[0].event,e)!==eA.W.Date&&(!(!e.isState()||!hA.includes(e.getType()))||(!!e.isRedacted()||!(!this.panel.showHiddenEvents||this.panel.shouldShowEvent(e,!0))))}add(e){const{event:t,shouldShow:n}=e;(t.getType()!==i.EventType.RoomMember||(0,rA.I3)(t,f.J.safeGet(),this.panel.showHiddenEvents))&&(this.readMarker=this.readMarker||this.panel.readMarkerForEvent(t.getId(),t===this.lastShownEvent),(this.panel.showHiddenEvents||n)&&t.getType()!==i.EventType.RoomPinnedEvents&&this.events.push(e))}generateKey(){return"eventlistsummary-"+this.events[0].event.getId()}getTiles(){var e;if(null===(e=this.events)||void 0===e||!e.length)return[];const t=this.panel,n=this.lastShownEvent,i=[];if(t.wantsSeparator(this.prevEvent,this.events[0].event)===eA.W.Date){const e=this.events[0].event.getTs();i.push(o.createElement("li",{key:e+"~"},o.createElement(Zx.A,{roomId:this.events[0].event.getRoomId(),ts:e})))}const r=this.events.find(e=>this.panel.grouperKeyMap.get(e.event)),s=r&&this.panel.grouperKeyMap.has(r.event)?this.panel.grouperKeyMap.get(r.event):this.generateKey();r||this.panel.grouperKeyMap.set(this.events[0].event,s);let a=!1,l=this.events.map((e,i)=>(e.event.getId()===t.props.highlightedEventId&&(a=!0),t.getTilesForEvent(0===i?this.prevEvent:this.events[i-1].event,e,e.event===n,true,this.nextEvent,this.nextEventTile))).reduce((e,t)=>e.concat(t),[]);return 0===l.length&&(l=null),this.panel.props.canBackPaginate||this.prevEvent||i.push(o.createElement(sA,{key:"historytile"})),i.push(o.createElement(mA,{key:s,events:this.events.map(e=>e.event),onToggle:t.onHeightChanged,startExpanded:a,layout:this.panel.props.layout},l)),this.readMarker&&i.push(this.readMarker),i}getNewPrevEvent(){return this.events[this.events.length-1].event}}(0,S.A)(pA,"canStartGroup",function(e,{event:t,shouldShow:n}){return!!n&&(!(!t.isState()||!hA.includes(t.getType()))||(!!t.isRedacted()||!(!e.showHiddenEvents||e.shouldShowEvent(t,!0))))});var gA=n("./src/utils/BrowserWorkarounds.ts"),vA=n("./src/components/views/settings/AvatarSetting.tsx");const fA="52px",_A=({hasAvatar:e,hasAvatarLabel:t,noAvatarLabel:n,setAvatarUrl:r,isUserAvatar:s,children:a,onClick:l})=>{var c;const d=(0,o.useContext)(ce.Ay),[u,m]=(0,o.useState)(!1),h=(0,o.useRef)(null),p=e||u?t:n,{room:g}=(0,yr.ME)("room");return s||(null==g||null===(c=g.currentState)||void 0===c?void 0:c.maySendStateEvent(i.EventType.RoomAvatar,d.getSafeUserId()))?o.createElement(o.Fragment,null,o.createElement("input",{type:"file",ref:h,className:"mx_MiniAvatarUploader_input",onClick:e=>{(0,gA.e)(e),null==l||l(e)},onChange:async e=>{m(!0);const t=(0,vA.B)(e);if(t){const{content_uri:e}=await d.uploadContent(t);await r(e)}m(!1)},accept:"image/*"}),o.createElement(ae.A,{className:me()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:u,mx_MiniAvatarUploader_hasAvatar:e}),disabled:u,onClick:()=>{var e;null===(e=h.current)||void 0===e||e.click()},"aria-label":p},a,o.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},u?o.createElement(le.A,{w:20,h:20}):o.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})))):o.createElement(o.Fragment,null,a)};var yA=n("./src/utils/rooms.ts"),bA=n("./src/models/LocalRoom.ts");const EA=e=>{if(!(0,yA.u)(e.client))return{shouldEncrypt:!1};if(!k.A.shared().getRoomIds().has(e.roomId))return{shouldEncrypt:!1};if(1!==e.getInvitedAndJoinedMemberCount())return{shouldEncrypt:!1};const t=e.currentState.getStateEvents("m.room.third_party_invite")||[];return 1===t.length?{shouldEncrypt:!0,inviteEvent:t[0]}:{shouldEncrypt:!1}};const wA=()=>{var e;const t=(0,o.useContext)(ce.Ay),{room:n,roomId:r}=(0,yr.ME)("room","roomId");if(!n||!r)throw new Error("Unable to create a NewRoomIntro without room and roomId");const s=n instanceof bA.Np,a=s?null===(e=n.targets[0])||void 0===e?void 0:e.userId:k.A.shared().getUserIdForRoomId(r);let l;if(a){const{shouldEncrypt:e}=EA(n),t=((e,t)=>e instanceof bA.Np?(0,c.AO)("room|intro|send_message_start_dm"):t?(0,c.AO)("room|intro|encrypted_3pid_dm_pending_join"):(0,c.AO)("room|intro|start_of_dm_history"))(n,e);let i;n instanceof bA.Np||e||n.getJoinedMemberCount()+n.getInvitedMemberCount()!==2||(i=(0,c._t)("room|intro|dm_caption"));const r=null==n?void 0:n.getMember(a),s=(null==n?void 0:n.name)||(null==r?void 0:r.rawDisplayName)||a;l=o.createElement(o.Fragment,null,o.createElement(Tn.A,{room:n,size:fA,onClick:()=>{x.A.dispatch({action:W.r.ViewUser,member:r||{userId:a}})}}),o.createElement("h2",null,n.name),o.createElement("p",null,(0,c._t)(t,{},{displayName:()=>o.createElement("strong",null,s)})),i&&o.createElement("p",null,i))}else{var d,u,m,h,p;const e=n&&n.getMyMembership()===Xt.O.Join,s=null===(d=n.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===d||null===(d=d.getContent())||void 0===d?void 0:d.topic,a=e&&n.currentState.maySendStateEvent(i.EventType.RoomTopic,t.getSafeUserId()),g=()=>{x.A.dispatch({action:"open_room_settings",room_id:r},!0),setTimeout(()=>{var e;null===(e=window.document.getElementById("profileTopic"))||void 0===e||e.focus()})};let v;a&&s?v=(0,c._t)("room|intro|topic_edit",{topic:s},{a:e=>o.createElement(ae.A,{element:"a",kind:"link_inline",onClick:g},e)}):s?v=(0,c._t)("room|intro|topic",{topic:s}):a&&(v=(0,c._t)("room|intro|no_topic",{},{a:e=>o.createElement(ae.A,{element:"a",kind:"link_inline",onClick:g},e)}));const f=null===(u=n.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===u?void 0:u.getSender(),_=f&&(null==n||null===(m=n.getMember(f))||void 0===m?void 0:m.rawDisplayName)||f;let y,b,E;y=f===t.getUserId()?(0,c._t)("room|intro|you_created"):(0,c._t)("room|intro|user_created",{displayName:_}),null!==(h=Ci.Ay.instance.activeSpaceRoom)&&void 0!==h&&h.canInvite(t.getSafeUserId())&&Ci.Ay.instance.isRoomInSpace(Ci.Ay.instance.activeSpace,n.roomId)&&(b=Ci.Ay.instance.activeSpaceRoom),b&&(0,Ya.g)(It.C.InviteUsers)?E=o.createElement("div",{className:"mx_NewRoomIntro_buttons"},o.createElement(ae.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{(0,ss.Lo)(b)}},(0,c._t)("invite|to_space",{spaceName:b.name})),n.canInvite(t.getSafeUserId())&&o.createElement(ae.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{x.A.dispatch({action:"view_invite",roomId:r})}},(0,c._t)("room|intro|room_invite"))):n.canInvite(t.getSafeUserId())&&(0,Ya.g)(It.C.InviteUsers)&&(E=o.createElement("div",{className:"mx_NewRoomIntro_buttons"},o.createElement(ae.A,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{x.A.dispatch({action:"view_invite",roomId:r})}},(0,c._t)("room|invite_this_room"))));const w=null===(p=n.currentState.getStateEvents(i.EventType.RoomAvatar,""))||void 0===p||null===(p=p.getContent())||void 0===p?void 0:p.url;let S=o.createElement(Tn.A,{room:n,size:fA,viewAvatarOnClick:!!w});w||(S=o.createElement(_A,{hasAvatar:!1,noAvatarLabel:(0,c._t)("room|intro|no_avatar_label"),setAvatarUrl:e=>t.sendStateEvent(r,i.EventType.RoomAvatar,{url:e},"")},S)),l=o.createElement(o.Fragment,null,S,o.createElement("h2",null,n.name),o.createElement("p",null,y," ",(0,c._t)("room|intro|start_of_room",{},{roomName:()=>o.createElement("strong",null,n.name)})),o.createElement("p",null,v),E)}const g=(0,c._t)("room|intro|private_unencrypted_warning");let v;n.currentState.mayClientSendStateEvent(i.EventType.RoomEncryption,f.J.safeGet())&&!s&&(v=o.createElement(ae.A,{kind:"link_inline",onClick:function(e){e.preventDefault(),x.A.dispatch({action:"open_room_settings",initial_tab_id:Yt.e.Security})}},(0,c._t)("room|intro|enable_encryption_prompt")));const _=o.createElement("span",null," ",g," ",v," ");return o.createElement("li",{className:"mx_NewRoomIntro"},!function(e,t){const n=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!(0,yA.u)(e)||n}(t,n)&&o.createElement(oA.A,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:(0,c._t)("room|intro|unencrypted_warning"),subtitle:_}),l)};class SA extends iA{shouldGroup({event:e,shouldShow:t}){const n=this.panel,r=this.firstEventAndShouldShow.event;if(!t)return!0;if(n.wantsSeparator(this.firstEventAndShouldShow.event,e)===eA.W.Date)return!1;const o=e.getType();return(o!==i.EventType.RoomMember||e.getStateKey()===r.getSender()&&e.getContent().membership===Xt.O.Join)&&(!i.M_BEACON_INFO.matches(o)&&!(!e.isState()||e.getSender()!==r.getSender()))}add(e){const{event:t,shouldShow:n}=e,r=this.panel;this.readMarker=this.readMarker||r.readMarkerForEvent(t.getId(),t===this.lastShownEvent),n&&(t.getType()===i.EventType.RoomEncryption?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){var e,t;if(!this.events||!this.events.length)return[];const n=this.panel,i=[],r=!0,s=this.firstEventAndShouldShow,a=this.lastShownEvent;if(n.wantsSeparator(this.prevEvent,s.event)===eA.W.Date){const e=s.event.getTs();i.push(o.createElement("li",{key:e+"~"},o.createElement(Zx.A,{roomId:s.event.getRoomId(),ts:e})))}s.shouldShow&&i.push(...n.getTilesForEvent(s.event,s));for(const e of this.ejectedEvents)i.push(...n.getTilesForEvent(s.event,e,s.event===a,r));const l=this.events.map(e=>n.getTilesForEvent(e.event,e,e.event===a,r)).reduce((e,t)=>e.concat(t),[]),d=this.events[this.events.length-1].event;let u;const m=d.getRoomId(),h=null!==(e=null===(t=d.sender)||void 0===t?void 0:t.name)&&void 0!==e?e:d.getSender();return u=m&&k.A.shared().getUserIdForRoomId(m)?(0,c._t)("timeline|creation_summary_dm",{creator:h}):(0,c._t)("timeline|creation_summary_room",{creator:h}),i.push(o.createElement(wA,{key:"newroomintro"})),i.push(o.createElement(aA,{key:"roomcreationsummary",events:this.events.map(e=>e.event),onToggle:n.onHeightChanged,summaryMembers:d.sender?[d.sender]:void 0,summaryText:u,layout:this.panel.props.layout},l)),this.readMarker&&i.push(this.readMarker),i}getNewPrevEvent(){return this.firstEventAndShouldShow.event}}(0,S.A)(SA,"canStartGroup",function(e,{event:t}){return t.getType()===i.EventType.RoomCreate});const xA=[i.EventType.Sticker,i.EventType.RoomMessage];function AA(e,t,n,i,r){return r!==kn.Ae.ThreadsList&&(!(null==e||!e.sender||!t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||xA.includes(t.getType())&&xA.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&((!(0,gn.zr)(t)&&!(0,gn.zr)(e)||r===kn.Ae.Thread)&&!!(0,vn.bN)(e,n,i)))))))}class CA extends o.Component{constructor(e){super(e),(0,S.A)(this,"readReceiptMap",{}),(0,S.A)(this,"readReceiptsByEvent",new Map),(0,S.A)(this,"readReceiptsByUserId",new Map),(0,S.A)(this,"_showHiddenEvents",void 0),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"readMarkerNode",(0,o.createRef)()),(0,S.A)(this,"whoIsTyping",(0,o.createRef)()),(0,S.A)(this,"scrollPanel",(0,o.createRef)()),(0,S.A)(this,"showTypingNotificationsWatcherRef",void 0),(0,S.A)(this,"eventTiles",{}),(0,S.A)(this,"grouperKeyMap",new WeakMap),(0,S.A)(this,"calculateRoomMembersCount",()=>{this.setState({hideSender:this.shouldHideSender()})}),(0,S.A)(this,"onShowTypingNotificationsChange",()=>{this.setState({showTypingNotifications:O.A.getValue("showTypingNotifications")})}),(0,S.A)(this,"isUnmounting",()=>this.unmounted),(0,S.A)(this,"collectGhostReadMarker",e=>{e&&requestAnimationFrame(()=>{e.style.width="10%",e.style.opacity="0"})}),(0,S.A)(this,"onGhostTransitionEnd",e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter(e=>e!==t)})}),(0,S.A)(this,"collectEventTile",(e,t)=>{this.eventTiles[e]=t}),(0,S.A)(this,"onHeightChanged",()=>{var e;null===(e=this.scrollPanel.current)||void 0===e||e.checkScroll()}),(0,S.A)(this,"resizeObserver",new ResizeObserver(this.onHeightChanged)),(0,S.A)(this,"onTypingShown",()=>{const e=this.scrollPanel.current;null==e||e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()}),(0,S.A)(this,"onTypingHidden",()=>{const e=this.scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())}),this.state={ghostReadMarkers:[],showTypingNotifications:O.A.getValue("showTypingNotifications"),hideSender:this.shouldHideSender()},this._showHiddenEvents=O.A.getValue("showHiddenEventsInTimeline")}componentDidMount(){var e;this.unmounted=!1,this.showTypingNotificationsWatcherRef=O.A.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange),this.calculateRoomMembersCount(),null===(e=this.props.room)||void 0===e||e.currentState.on(i.RoomStateEvent.Update,this.calculateRoomMembersCount)}componentWillUnmount(){var e;this.unmounted=!0,null===(e=this.props.room)||void 0===e||e.currentState.off(i.RoomStateEvent.Update,this.calculateRoomMembersCount),O.A.unwatchSetting(this.showTypingNotificationsWatcherRef),this.readReceiptMap={},this.resizeObserver.disconnect()}componentDidUpdate(e,t){if(e.layout!==this.props.layout&&this.calculateRoomMembersCount(),e.readMarkerVisible&&e.readMarkerEventId&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}const n=this.pendingEditItem;if(!this.props.editState&&this.props.room&&n){const e=this.props.room.findEventById(n);x.A.dispatch({action:W.r.EditEvent,event:null!=e&&e.isRedacted()?null:e,timelineRenderingType:this.context.timelineRenderingType})}}shouldHideSender(){return!!this.props.room&&this.props.room.getInvitedAndJoinedMemberCount()<=2&&this.props.layout===Zt.P.Bubble}getNodeForEventId(e){var t,n;if(this.eventTiles)return null!==(t=null===(n=this.eventTiles[e])||void 0===n||null===(n=n.ref)||void 0===n?void 0:n.current)&&void 0!==t?t:void 0}getTileForEventId(e){if(this.eventTiles&&e)return this.eventTiles[e]}isAtBottom(){var e;return null===(e=this.scrollPanel.current)||void 0===e?void 0:e.isAtBottom()}getScrollState(){var e,t;return null!==(e=null===(t=this.scrollPanel.current)||void 0===t?void 0:t.getScrollState())&&void 0!==e?e:null}getReadMarkerPosition(){var e;const t=this.readMarkerNode.current,n=null===(e=this.scrollPanel.current)||void 0===e?void 0:e.divScroll;if(!t||!n)return null;const i=n.getBoundingClientRect(),r=t.getBoundingClientRect();return r.bottom+2<i.top?-1:r.top<i.bottom?0:1}scrollToTop(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToTop()}scrollToBottom(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToBottom()}handleScrollKey(e){var t;null===(t=this.scrollPanel.current)||void 0===t||t.handleScrollKey(e)}scrollToEvent(e,t,n){var i;null===(i=this.scrollPanel.current)||void 0===i||i.scrollToToken(e,t,n)}scrollToEventIfNeeded(e){const t=this.getNodeForEventId(e);t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}get showHiddenEvents(){var e,t;return null!==(e=null===(t=this.context)||void 0===t?void 0:t.showHiddenEvents)&&void 0!==e?e:this._showHiddenEvents}shouldShowEvent(e,t=!1){if(this.props.hideThreadedMessages&&this.props.room){const{shouldLiveInRoom:t}=this.props.room.eventShouldLiveIn(e,this.props.events);if(!t)return!1}return!f.J.safeGet().isUserIgnored(e.getSender())&&(!(!this.showHiddenEvents||t)||!!(0,vn.bN)(e,f.J.safeGet(),this.showHiddenEvents)&&(this.props.highlightedEventId===e.getId()||!(0,fS.A)(e,this.context)))}readMarkerForEvent(e,t){if(this.context.timelineRenderingType===kn.Ae.File)return null;const n=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return n&&(t=o.createElement("hr",{style:{opacity:1,width:"99%"}})),o.createElement("li",{key:"readMarker_"+e,ref:this.readMarkerNode,className:"mx_MessagePanel_myReadMarker","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=o.createElement("hr",{ref:this.collectGhostReadMarker,onTransitionEnd:this.onGhostTransitionEnd,"data-eventid":e});return o.createElement("li",{key:"_readuptoghost_"+e,className:"mx_MessagePanel_myReadMarker"},t)}return null}getNextEventInfo(e,t){const n=t<e.length-1?e[t+1]:null,i=function(e,t){for(let n=e+1;n<t.length;n++){const{event:e,shouldShow:i}=t[n];if(i)return e}return null}(t,e);return{nextEventAndShouldShow:n,nextTile:i}}get pendingEditItem(){if(!this.props.room)return null;try{return localStorage.getItem((0,nA.O)(this.props.room.roomId,this.context.timelineRenderingType))}catch(e){return s.vF.error(e),null}}isSentState(e){const t=e.getAssociatedStatus();return!t||t===i.EventStatus.SENT}getEventTiles(){let e;const t=this.props.events.map(e=>({event:e,shouldShow:this.shouldShowEvent(e)})),n=f.J.safeGet().getSafeUserId();let i=!1,r=-1;for(let o=t.length-1;o>=0;o--){const{event:s,shouldShow:a}=t[o];if(a&&(void 0===e&&(e=s),!i&&this.isSentState(s)&&Kr(s)&&(i=!0,s.getSender()===n&&(t[o].lastSuccessfulWeSent=!0)),r<0&&!s.status&&(r=o),r>=0&&i))break}const o=[];let s=null;this.readReceiptsByEvent=new Map,this.props.showReadReceipts&&(this.readReceiptsByEvent=this.getReadReceiptsByShownEvent(t));let a=null;for(let n=0;n<t.length;n++){const i=t[n],{event:l,shouldShow:c}=i,d=l.getId(),u=l===e,{nextEventAndShouldShow:m,nextTile:h}=this.getNextEventInfo(t,n);if(a){if(a.shouldGroup(i)){a.add(i);continue}o.push(...a.getTiles()),s=a.getNewPrevEvent(),a=null}for(const t of kA)if(t.canStartGroup(this,i)&&!this.props.disableGrouping){a=new t(this,i,s,e,m,h);break}if(!a){c&&(o.push(...this.getTilesForEvent(s,i,u,!1,m,h)),s=l);const e=this.readMarkerForEvent(d,n>=r);e&&o.push(e)}}return a&&o.push(...a.getTiles()),o}getTilesForEvent(e,t,n=!1,i=!1,r=null,s=null){var a,l,d;const u=t.event,m=[],h=(null===(a=this.props.editState)||void 0===a?void 0:a.getEvent().getId())===u.getId(),p=null!==(l=u.getTs())&&void 0!==l?l:Date.now(),g=this.wantsSeparator(e,u);if(!i&&this.props.room)if(g===eA.W.Date)m.push(o.createElement("li",{key:p},o.createElement(Zx.A,{key:p,roomId:this.props.room.roomId,ts:p})));else if(g===eA.W.LateEvent){var v;const e=(0,c._t)("timeline|late_event_separator",{dateTime:(0,gt.Yq)(null!==(v=u.getDate())&&void 0!==v?v:new Date)});m.push(o.createElement("li",{key:p},o.createElement(eA.A,{key:p,label:e},e)))}const _=f.J.safeGet();let y=!0;if(s){const e=s;y=this.wantsSeparator(u,e)===eA.W.Date||u.getSender()!==e.getSender()||_n(_,e,this.showHiddenEvents).isInfoMessage||!AA(u,e,_,this.showHiddenEvents,this.context.timelineRenderingType)}const b=g===eA.W.None&&AA(e,u,_,this.showHiddenEvents,this.context.timelineRenderingType),E=u.getId(),w=E===this.props.highlightedEventId,S=this.readReceiptsByEvent.get(E),x=this.props.callEventGroupers.get(u.getContent().call_id);return m.push(o.createElement($r,{key:u.getTxnId()||E,as:"li",ref:this.collectEventTile.bind(this,E),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:u,continuation:b,isRedacted:u.isRedacted(),replacingEventId:u.replacingEventId(),editState:h?this.props.editState:void 0,resizeObserver:this.resizeObserver,readReceipts:S,readReceiptMap:this.readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this.isUnmounting,eventSendStatus:null!==(d=u.getAssociatedStatus())&&void 0!==d?d:void 0,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:n,lastInSection:y,lastSuccessful:t.lastSuccessfulWeSent,isSelectedEvent:w,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,showReadReceipts:this.props.showReadReceipts,callEventGrouper:x,hideSender:this.state.hideSender})),m}wantsSeparator(e,t){var n;if(this.context.timelineRenderingType===kn.Ae.ThreadsList)return eA.W.None;if(null!==e){var i;const n=Vr(t);if((null==n?void 0:n.group_id)!==(null===(i=Vr(e))||void 0===i?void 0:i.group_id))return void 0!==n?eA.W.LateEvent:eA.W.Date}if(null===e&&!this.props.canBackPaginate)return eA.W.Date;const r=null!==(n=t.getDate())&&void 0!==n?n:new Date;return null!==e&&(0,gt.fq)(e.getDate()||void 0,r)?eA.W.Date:eA.W.None}getReadReceiptsForEvent(e){const t=f.J.safeGet().credentials.userId,{room:n}=this.props;if(!n)return null;const i=this.context.threadId?n.getThread(this.context.threadId):n,r=[];return i?(i.getReceiptsForEvent(e).forEach(e=>{if(!e.userId||!(0,_a.ll)(e.type)||e.userId===t)return;if(f.J.safeGet().isUserIgnored(e.userId))return;const i=n.getMember(e.userId);r.push({userId:e.userId,roomMember:i,ts:e.data?e.data.ts:0})}),r):(s.vF.debug("Discarding request, could not find the receiptDestination for event: "+this.context.threadId),r)}getReadReceiptsByShownEvent(e){const t=new Map,n=new Map;let i;for(const e of this.props.events){if(this.shouldShowEvent(e)&&(i=e.getId()),!i)continue;const r=t.get(i)||[],o=this.getReadReceiptsForEvent(e);if(o){t.set(i,r.concat(o));for(const e of o)n.set(e.userId,{lastShownEventId:i,receipt:e})}}for(const e of this.readReceiptsByUserId.keys()){if(n.get(e))continue;const{lastShownEventId:i,receipt:r}=this.readReceiptsByUserId.get(e),o=t.get(i)||[];t.set(i,o.concat(r)),n.set(e,{lastShownEventId:i,receipt:r})}this.readReceiptsByUserId=n;for(const e of t.values())e.sort((e,t)=>t.ts-e.ts);return t}updateTimelineMinHeight(){const e=this.scrollPanel.current;if(e){const t=e.isAtBottom(),n=this.whoIsTyping.current,i=n&&n.isVisible();t&&i&&e.preventShrinking()}}onTimelineReset(){const e=this.scrollPanel.current;e&&e.clearPreventShrinking()}render(){let e,t;this.props.backPaginating&&(e=o.createElement("li",{key:"_topSpinner"},o.createElement(le.A,null))),this.props.forwardPaginating&&(t=o.createElement("li",{key:"_bottomSpinner"},o.createElement(le.A,null)));const n=this.props.hidden?{display:"none"}:{};let i,r;var s,a;(this.props.room&&this.state.showTypingNotifications&&this.context.timelineRenderingType===kn.Ae.Room&&(i=o.createElement(Xx,{room:this.props.room,onShown:this.onTypingShown,onHidden:this.onTypingHidden,ref:this.whoIsTyping})),this.props.layout==Zt.P.IRC)&&(r=o.createElement(qx,{minWidth:20,maxWidth:600,roomId:null!==(s=null===(a=this.props.room)||void 0===a?void 0:a.roomId)&&void 0!==s?s:null}));const l=me()(this.props.className,{mx_MessagePanel_narrow:this.context.narrow});return o.createElement(tA.A,null,o.createElement(Qx.A,{ref:this.scrollPanel,className:l,onScroll:this.props.onScroll,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:n,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:r},e,this.getEventTiles(),i,t))}}(0,S.A)(CA,"contextType",kn.Ay),(0,S.A)(CA,"defaultProps",{disableGrouping:!1});const kA=[SA,pA];var RA=n("./node_modules/raw-loader/dist/cjs.js!./src/utils/exportUtils/exportCustomCSS.css");const IA=/\.[\w-]+/g;function TA(e){const t="-apple-system, BlinkMacSystemFont, avenir next,\n            avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif";return e.replace(/font-family: ?(Inter|'Inter'|"Inter")/g,`font-family: ${t}`).replace(/--cpd-font-family-sans: ?(Inter|'Inter'|"Inter")/g,`--cpd-font-family-sans: ${t}`).replace(/font-family: ?Inconsolata/g,"font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace")}function PA(e,t){return"Raw"!==e.prelude.type||!e.block.children.isEmpty&&e.prelude.value.split(",").some(e=>{const n=e.trim().match(IA);return!(n&&!n.every(e=>t.has(e.substring(1))))})}const NA=async e=>{const t=await n.e(5914).then(n.bind(n,"./node_modules/css-tree/lib/index.js")),i=["bundle.css","theme-light.css"].map(e=>{var t;return null===(t=document.querySelector(`link[rel="stylesheet"][href$="${e}"]`))||void 0===t?void 0:t.href});let r="";for(const n of i){if(!n)continue;const i=await fetch(n),o=await i.text(),s=t.parse(o,{context:"stylesheet",parseAtrulePrelude:!1,parseRulePrelude:!1,parseValue:!1,parseCustomProperty:!1});for(const n of s.children)"Atrule"===n.type&&"font-face"===n.name||("Rule"!==n.type||PA(n,e))&&(r+=TA(t.generate(n)))}return r+RA.A};class DA extends Gx{constructor(e,t,n,i){super(e,t,n,i),(0,S.A)(this,"avatars",void 0),(0,S.A)(this,"permalinkCreator",void 0),(0,S.A)(this,"totalSize",void 0),(0,S.A)(this,"mediaOmitText",void 0),this.avatars=new Map,this.permalinkCreator=new on.pE(this.room),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,c._t)("export_chat|media_omitted_file_size"):(0,c._t)("export_chat|media_omitted")}async getRoomAvatar(){let e;const t=en.ze(this.room,32,32,"crop"),n="room.png";if(t)try{const i=await fetch(t);e=await i.blob(),this.totalSize+=e.size,this.addFile(n,e)}catch(e){s.vF.log("Failed to fetch room's avatar"+e)}const i=o.createElement(Xp.A,{size:"32px",name:this.room.name,title:this.room.name,url:e?n:""});return(0,Fx.qV)(i)}async wrapHTML(e,t,n){var r,s,a,l;const d=await this.getRoomAvatar(),u=(0,gt.Ah)(new Date),m=null===(r=this.room.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===r?void 0:r.getSender(),h=(m?null===(s=this.room.getMember(m))||void 0===s?void 0:s.rawDisplayName:m)||m,p=this.room.client.getSafeUserId(),g=null===(a=this.room.getMember(p))||void 0===a?void 0:a.rawDisplayName,v=(null===(l=this.room.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===l||null===(l=l.getContent())||void 0===l?void 0:l.topic)||"",f=Ux()((0,c._t)("export_chat|creator_summary",{creatorName:h})),_=Ux()(p),y=Ux()(this.room.name),b=Ux()(v),E=(0,Fx.qV)(o.createElement("p",null,(0,c._t)("export_chat|export_info",{exportDate:u},{roomName:()=>o.createElement("strong",null,y),exporterDetails:()=>o.createElement("a",{href:`https://matrix.to/#/${encodeURIComponent(p)}`,target:"_blank",rel:"noopener noreferrer"},g?o.createElement(o.Fragment,null,o.createElement("strong",null,Ux()(g)),"I "," ("+_+")"):o.createElement("strong",null,_))}))),w=v?(0,c._t)("export_chat|topic",{topic:b}):"",S=(0,Fx.qV)(0!==t?o.createElement("div",{style:{textAlign:"center"}},o.createElement("a",{href:`./messages${1===t?"":t}.html`,style:{fontWeight:"bold"}},(0,c._t)("export_chat|previous_page"))):o.createElement(o.Fragment,null)),x=(0,Fx.qV)(t<n-1?o.createElement("div",{style:{textAlign:"center",margin:"10px"}},o.createElement("a",{href:"./messages"+(t+2)+".html",style:{fontWeight:"bold"}},(0,c._t)("export_chat|next_page"))):o.createElement(o.Fragment,null));return`\n          <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8" />\n                <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n                <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n                <link href="css/style.css" rel="stylesheet" />\n                <script src="js/script.js"><\/script>\n                <title>${(0,c._t)("export_chat|html_title")}</title>\n            </head>\n            <body style="height: 100vh;" class="cpd-theme-light">\n                <div id="matrixchat" style="height: 100%; overflow: auto">\n                    <div class="mx_MatrixChat_wrapper" aria-hidden="false">\n                        <div class="mx_MatrixChat">\n                        <main class="mx_RoomView">\n                            <div class="mx_RoomHeader light-panel">\n                                ${d}\n                                <div class="mx_RoomHeader_infoWrapper">\n                                    <div\n                                        dir="auto"\n                                        class="mx_RoomHeader_info"\n                                        title="${y}"\n                                    >\n                                        <span class="mx_RoomHeader_truncated mx_lineClamp">\n                                            ${y}\n                                        </span>\n                                    </div>\n                                </div>\n                            </div>\n                            ${S}\n                            <div class="mx_MainSplit">\n                            <div class="mx_RoomView_body">\n                                <div\n                                class="mx_RoomView_timeline mx_RoomView_timeline_rr_enabled"\n                                >\n                                <div\n                                    class="\n                                    mx_AutoHideScrollbar\n                                    mx_ScrollPanel\n                                    mx_RoomView_messagePanel\n                                    "\n                                >\n                                    <div class="mx_RoomView_messageListWrapper">\n                                    <ol\n                                        class="mx_RoomView_MessageList"\n                                        aria-live="polite"\n                                        role="list"\n                                    >\n                                    ${0==t?`<div class="mx_NewRoomIntro">\n                                            ${d}\n                                            <h2> ${y} </h2>\n                                            <p> ${f} <br/><br/> ${E} </p>\n                                            <br/>\n                                            <p> ${w} </p>\n                                        </div>`:""}\n                                    ${e}\n                                    </ol>\n                                    </div>\n                                </div>\n                                </div>\n                                <div class="mx_RoomView_statusArea">\n                                <div class="mx_RoomView_statusAreaBox">\n                                    <div class="mx_RoomView_statusAreaBox_line"></div>\n                                </div>\n                                </div>\n                            </div>\n                            </div>\n                            ${x}\n                        </main>\n                        </div>\n                    </div>\n                </div>\n                <div id="snackbar"/>\n            </body>\n        </html>`}getAvatarURL(e){const t=e.sender,n=null==t?void 0:t.getMxcAvatarUrl();return n?(0,Vi.mediaFromMxc)(n).getThumbnailOfSourceHttp(30,30,"crop"):null}async saveAvatarIfNeeded(e){const t=e.sender;if(!this.avatars.has(t.userId))try{const n=this.getAvatarURL(e);this.avatars.set(t.userId,!0);const i=await fetch(n),r=await i.blob();this.addFile(`users/${t.userId.replace(/:/g,"-")}.png`,r)}catch(e){s.vF.log("Failed to fetch user's avatar"+e)}}getDateSeparator(e){const t=e.getTs(),n=o.createElement("li",{key:t},o.createElement(Zx.A,{forExport:!0,key:t,roomId:e.getRoomId(),ts:t}));return(0,Fx.qV)(n)}needsDateSeparator(e,t){return!t||(0,gt.fq)(t.getDate()||void 0,e.getDate()||void 0)}getEventTile(e,t,n){return o.createElement("div",{className:"mx_Export_EventWrapper",id:e.getId()},o.createElement(ce.Ay.Provider,{value:this.room.client},o.createElement(aa.B,null,o.createElement($r,{mxEvent:e,continuation:t,isRedacted:e.isRedacted(),replacingEventId:e.replacingEventId(),forExport:!0,alwaysShowTimestamps:!0,showUrlPreview:!1,checkUnmounting:()=>!1,isTwelveHour:!1,last:!1,lastInSection:!1,permalinkCreator:this.permalinkCreator,lastSuccessful:!1,isSelectedEvent:!1,showReactions:!0,layout:Zt.P.Group,showReadReceipts:!1,getRelationsForEvent:this.getRelationsForEvent,ref:n}))))}async getEventTileMarkup(e,t,n){const r=this.getAvatarURL(e),o=!!r;o&&await this.saveAvatarIfNeeded(e);const s=Promise.withResolvers(),a=this.getEventTile(e,t,s.resolve);let l;if(e.getContent().msgtype==i.MsgType.Emote||e.getContent().msgtype==i.MsgType.Notice||e.getContent().msgtype===i.MsgType.Text){const e=document.createElement("div"),t=(0,Ox.createRoot)(e);t.render(a),await s.promise,l=e.innerHTML,t.unmount()}else l=(0,Fx.qV)(a);if(n){var c,d;const t=null!==(c=e.getContent().url)&&void 0!==c?c:null===(d=e.getContent().file)||void 0===d?void 0:d.url;l=l.split(t).join(n)}return l=l.replace(/<span class="mx_MFileBody_info_icon".*?>.*?<\/span>/,""),o&&(l=l.replace(encodeURI(r).replace(/&/g,"&amp;"),`users/${e.sender.userId.replace(/:/g,"-")}.png`)),l}createModifiedEvent(e,t,n=!0){const r={msgtype:i.MsgType.Text,body:`${e}`,format:"org.matrix.custom.html",formatted_body:`${e}`};n&&(r.formatted_body="<em>"+r.formatted_body+"</em>",r.body="*"+r.body+"*");const o=new i.MatrixEvent;return o.event=t.event,o.sender=t.sender,o.event.type="m.room.message",o.event.content=r,o}async createMessageBody(e,t=!1){let n;try{if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const i=await this.getMediaBlob(e);if(this.totalSize+i.size>this.exportOptions.maxSize)n=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else{this.totalSize+=i.size;const r=this.getFilePath(e);n=await this.getEventTileMarkup(e,t,r),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(r,i)}}catch(i){s.vF.log("Error while fetching file"+i),n=await this.getEventTileMarkup(this.createModifiedEvent((0,c._t)("export_chat|error_fetching_file"),e),t)}else n=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else n=await this.getEventTileMarkup(e,t)}catch(i){s.vF.error(i),n=await this.getEventTileMarkup(this.createModifiedEvent((0,rA.Rd)(e,this.room.client),e,!1),t)}return n}async createHTML(e,t,n,i){let r="",o=null;for(let n=t;n<Math.min(t+1e3,e.length);n++){const t=e[n];if(this.updateProgress((0,c._t)("export_chat|processing_event_n",{number:n+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,vn.bN)(t,this.room.client,!1))continue;r+=this.needsDateSeparator(t,o)?this.getDateSeparator(t):"";const i=!this.needsDateSeparator(t,o)&&AA(o,t,this.room.client,!1),s=await this.createMessageBody(t,i);this.totalSize+=(new TextEncoder).encode(s).byteLength,r+=s,o=t}return this.wrapHTML(r,n,i)}async export(){this.updateProgress((0,c._t)("export_chat|starting_export"));const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();this.updateProgress((0,c._t)("export_chat|fetched_n_events_in_time",{count:t.length,seconds:(n-e)/1e3}),!0,!1),this.updateProgress((0,c._t)("export_chat|creating_html"));const i=new Set;for(let e=0;e<t.length/1e3;e++){const n=await this.createHTML(t,1e3*e,e,t.length/1e3);(new DOMParser).parseFromString(n,"text/html").querySelectorAll("*").forEach(e=>{e.classList.forEach(e=>i.add(e))}),this.addFile(`messages${e?e+1:""}.html`,new Blob([n]))}const r=await NA(i);this.addFile("css/style.css",new Blob([r])),this.addFile("js/script.js",new Blob(['/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2021 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\n// This file is raw-imported (imported as plain text) for the export bundle, which is why this is in JS\r\nfunction showToastIfNeeded(replyId) {\r\n    const el = document.getElementById(replyId);\r\n    if (!el) {\r\n        showToast("The message you\'re looking for wasn\'t exported");\r\n        return;\r\n    }\r\n}\r\n\r\nfunction showToast(text) {\r\n    const el = document.getElementById("snackbar");\r\n    el.innerHTML = text;\r\n    el.className = "mx_show";\r\n    window.setTimeout(() => {\r\n        el.className = el.className.replace("mx_show", "");\r\n    }, 2000);\r\n}\r\n\r\nwindow.onload = () => {\r\n    document.querySelectorAll(".mx_reply_anchor").forEach((element) => {\r\n        element.addEventListener("click", (event) => {\r\n            showToastIfNeeded(event.target.dataset.scrollTo);\r\n        });\r\n    });\r\n};\r\n'])),await this.downloadZIP();const o=performance.now();this.cancelled?s.vF.info("Export cancelled successfully"):(this.updateProgress((0,c._t)("export_chat|export_successful")),this.updateProgress((0,c._t)("export_chat|exported_n_events_in_time",{count:t.length,seconds:(o-e)/1e3}))),this.cleanUp()}}class MA extends Gx{constructor(e,t,n,i){super(e,t,n,i),(0,S.A)(this,"totalSize",0),(0,S.A)(this,"messages",[])}get destinationFileName(){return this.makeFileNameNoExtension()+".json"}createJSONString(){var e,t,n,r;const o=(0,gt.Ah)(new Date),s=null===(e=this.room.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===e?void 0:e.getSender(),a=s&&(null===(t=this.room)||void 0===t||null===(t=t.getMember(s))||void 0===t?void 0:t.rawDisplayName)||s,l=(null===(n=this.room.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.topic)||"",c=this.room.client.getUserId(),d=(null===(r=this.room)||void 0===r||null===(r=r.getMember(c))||void 0===r?void 0:r.rawDisplayName)||c,u={room_name:this.room.name,room_creator:a,topic:l,export_date:o,exported_by:d,messages:this.messages};return JSON.stringify(u,null,2)}async getJSONString(e){if(this.exportOptions.attachmentsIncluded&&this.isAttachment(e))try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size<this.exportOptions.maxSize){this.totalSize+=t.size;const n=this.getFilePath(e);this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(n,t)}}catch(e){s.vF.log("Error fetching file: "+e)}return e.getEffectiveEvent()}async createOutput(e){for(let t=0;t<e.length;t++){const n=e[t];if(this.updateProgress((0,c._t)("export_chat|processing_event_n",{number:t+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();(0,vn.bN)(n,this.room.client,!1)&&this.messages.push(await this.getJSONString(n))}return this.createJSONString()}async export(){s.vF.info("Starting export process..."),s.vF.info("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();s.vF.log(`Fetched ${t.length} events in ${(n-e)/1e3}s`),s.vF.info("Creating output...");const i=await this.createOutput(t);if(this.files.length)this.addFile("export.json",new Blob([i])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,i)}const r=performance.now();this.cancelled?s.vF.info("Export cancelled successfully"):(s.vF.info("Export successful!"),s.vF.log(`Exported ${t.length} events in ${(r-e)/1e3} seconds`)),this.cleanUp()}}class OA extends Gx{constructor(e,t,n,i){super(e,t,n,i),(0,S.A)(this,"totalSize",void 0),(0,S.A)(this,"mediaOmitText",void 0),(0,S.A)(this,"textForReplyEvent",e=>{const t=/> <(.*?)>(.*?)\n\n(.*)/s.exec(e.body);if(!t)return e.body;let n;const i=t[1],r=t[3];n=t[2].substring(1);const o=n.split("\n").filter(e=>!/^\s*$/.test(e));return o.length>0?(n=o[0].substring(0,32),o[0].length>32&&(n+="..."),n=` "${n}"`):n="",`<${i}${n}> ${r}`}),(0,S.A)(this,"plainTextForEvent",async e=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let n="";if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size>this.exportOptions.maxSize)n=` (${this.mediaOmitText})`;else{this.totalSize+=t.size;const i=this.getFilePath(e);n=" ("+(0,c._t)("export_chat|file_attached")+")",this.addFile(i,t),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1)}}catch(e){n=" ("+(0,c._t)("export_chat|error_fetching_file")+")",s.vF.log("Error fetching file "+e)}else n=` (${this.mediaOmitText})`;return this.isReply(e)?t+": "+this.textForReplyEvent(e.getContent())+n:(0,rA.Rd)(e,this.room.client)+n}),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?(0,c._t)("export_chat|media_omitted_file_size"):(0,c._t)("export_chat|media_omitted")}get destinationFileName(){return this.makeFileNameNoExtension()+".txt"}async createOutput(e){let t="";for(let n=0;n<e.length;n++){const i=e[n];if(this.updateProgress((0,c._t)("export_chat|processing_event_n",{number:n+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!(0,vn.bN)(i,this.room.client,!1))continue;const r=await this.plainTextForEvent(i);t+=r&&`${(0,gt.Lu)(new Date(i.getTs()),O.A.getValue("showTwelveHourTimestamps"))} - ${r}\n`}return t}async export(){this.updateProgress((0,c._t)("export_chat|starting_export")),this.updateProgress((0,c._t)("export_chat|fetching_events"));const e=performance.now(),t=await this.getRequiredEvents(),n=performance.now();s.vF.log(`Fetched ${t.length} events in ${(n-e)/1e3}s`),this.updateProgress((0,c._t)("export_chat|creating_output"));const i=await this.createOutput(t);if(this.files.length)this.addFile("export.txt",new Blob([i])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,i)}const r=performance.now();this.cancelled?s.vF.info("Export cancelled successfully"):(s.vF.info("Export successful!"),s.vF.log(`Exported ${t.length} events in ${(r-e)/1e3} seconds`)),this.cleanUp()}}var FA=n("./src/customisations/ChatExport.ts");const LA=(e,t)=>n=>"number"==typeof n&&!(isNaN(n)||e>n||n>t),UA=({room:e,onFinished:t})=>{const{exportFormat:n,exportType:i,includeAttachments:r,numberOfMessages:a,sizeLimit:l,setExportFormat:d,setExportType:u,setNumberOfMessages:m,setSizeLimit:h,setAttachments:p}=(()=>{var e,t,n,i,r;const s=FA.A.getForceChatExportParameters(),[a,l]=(0,o.useState)(null!==(e=s.format)&&void 0!==e?e:Px.Html),[c,d]=(0,o.useState)(null!==(t=s.range)&&void 0!==t?t:Nx.Timeline),[u,m]=(0,o.useState)(null!==(n=s.includeAttachments)&&void 0!==n&&n),[h,p]=(0,o.useState)(null!==(i=s.numberOfMessages)&&void 0!==i?i:100),[g,v]=(0,o.useState)(null!==(r=s.sizeMb)&&void 0!==r?r:8);return{exportFormat:a,exportType:c,includeAttachments:u,numberOfMessages:h,sizeLimit:g,setExportFormat:s.format?void 0:l,setExportType:s.range?void 0:d,setNumberOfMessages:s.numberOfMessages?void 0:p,setSizeLimit:s.sizeMb?void 0:v,setAttachments:void 0===s.includeAttachments?m:void 0}})(),[g,v]=(0,o.useState)(!1),f=(0,o.useRef)(null),_=(0,o.useRef)(null),[y,b]=(0,o.useState)((0,c._t)("export_chat|processing")),[E,w]=(0,o.useState)(!1),[S,x]=(0,o.useState)(!1),[A,C]=(0,o.useState)(!1),[k,R]=((e,t)=>{const[n,i]=(0,o.useState)(e);return[n,e=>{i(e),t(e)}]})(null,async e=>{await(null==e?void 0:e.export().then(()=>{S||C(!0)}))}),I=async()=>{var t;if(!h||await(null===(t=f.current)||void 0===t?void 0:t.validate({focused:!1}))){if(i===Nx.LastNMessages){var o;var c;if(!await(null===(o=_.current)||void 0===o?void 0:o.validate({focused:!1})))return void(null===(c=_.current)||void 0===c||c.validate({focused:!0}))}v(!0),await(async()=>{const t={numberOfMessages:a,attachmentsIncluded:r,maxSize:1024*l*1024};switch(n){case Px.Html:R(new DA(e,Nx[i],t,b));break;case Px.Json:R(new MA(e,Nx[i],t,b));break;case Px.PlainText:R(new OA(e,Nx[i],t,b));break;default:return void s.vF.error("Unknown export format")}})()}else{var d;null===(d=f.current)||void 0===d||d.validate({focused:!0})}},T=(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("export_chat|enter_number_between_min_max",{min:1,max:2e3})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return LA(1,2e3)(t)},invalid:()=>(0,c._t)("export_chat|size_limit_min_max",{min:1,max:2e3})}]}),P=async e=>await T(e),N=(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("export_chat|enter_number_between_min_max",{min:1,max:10**8})},{key:"number",test:({value:e})=>{const t=parseInt(e,10);return LA(1,10**8)(t)},invalid:()=>(0,c._t)("export_chat|num_messages_min_max",{min:1,max:10**8})}]}),D=async e=>await N(e),M=async()=>{g?w(!0):t(!1)},O=async()=>{await(null==k?void 0:k.cancelExport()),x(!0),v(!1),R(null)},F=Object.values(Px).map(e=>({value:e,label:Dx(e)})),L=Object.values(Nx).map(e=>o.createElement("option",{key:Nx[e],value:e},(e=>{switch(e){case Nx.Beginning:return(0,c._t)("export_chat|from_the_beginning");case Nx.LastNMessages:return(0,c._t)("export_chat|number_of_messages");case Nx.Timeline:return(0,c._t)("export_chat|current_timeline");default:throw new Error("Unknown type: "+e)}})(e)));let U;i===Nx.LastNMessages&&m&&(U=o.createElement(wo.A,{id:"message-count",element:"input",type:"number",value:a.toString(),ref:_,onValidate:D,label:(0,c._t)("export_chat|num_messages"),onChange:e=>{m(parseInt(e.target.value))}}));const B=o.createElement("span",null,(0,c._t)("export_chat|size_limit_postfix"));return S?o.createElement(zp.A,{title:(0,c._t)("export_chat|cancelled"),description:(0,c._t)("export_chat|cancelled_detail"),hasCloseButton:!0,onFinished:t}):A?o.createElement(zp.A,{title:(0,c._t)("export_chat|successful"),description:(0,c._t)("export_chat|successful_detail"),hasCloseButton:!0,onFinished:t}):E?o.createElement(X.A,{title:(0,c._t)("common|warning"),className:"mx_ExportDialog",contentId:"mx_Dialog_content",onFinished:t,fixedWidth:!0},o.createElement("p",null,(0,c._t)("export_chat|confirm_stop")),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|stop"),primaryButtonClass:"danger",hasCancel:!0,cancelButton:(0,c._t)("action|continue"),onCancel:()=>w(!1),onPrimaryButtonClick:O})):o.createElement(X.A,{title:g?(0,c._t)("export_chat|exporting_your_data"):(0,c._t)("export_chat|title"),className:`mx_ExportDialog ${g&&"mx_ExportDialog_Exporting"}`,contentId:"mx_Dialog_content",hasCancel:!0,onFinished:t,fixedWidth:!0},g?null:o.createElement("p",null,(0,c._t)("export_chat|select_option")),o.createElement("div",{className:"mx_ExportDialog_options"},!!d&&o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_ExportDialog_subheading"},(0,c._t)("export_chat|format")),o.createElement(Tx.A,{name:"exportFormat",value:n,onChange:e=>d(Px[e]),definitions:F})),!!u&&o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_ExportDialog_subheading"},(0,c._t)("export_chat|messages")),o.createElement(wo.A,{id:"export-type",element:"select",value:i,onChange:e=>{u(Nx[e.target.value])}},L),U),h&&o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_ExportDialog_subheading"},(0,c._t)("export_chat|size_limit")),o.createElement(wo.A,{id:"size-limit",type:"number",autoComplete:"off",onValidate:P,element:"input",ref:f,value:l.toString(),postfixComponent:B,onChange:e=>h(parseInt(e.target.value))})),p&&o.createElement(o.Fragment,null,o.createElement(Io.A,{className:"mx_ExportDialog_attachments-checkbox",id:"include-attachments",checked:r,onChange:e=>p(e.target.checked)},(0,c._t)("export_chat|include_attachments")))),g?o.createElement("div",{className:"mx_ExportDialog_progress"},o.createElement(le.A,{w:24,h:24}),o.createElement("p",null,y),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|cancel"),primaryButtonClass:"danger",hasCancel:!1,onPrimaryButtonClick:M})):o.createElement(Kt.A,{primaryButton:(0,c._t)("action|export"),onPrimaryButtonClick:I,onCancel:()=>t(!1)}))};var BA=n("./src/components/views/dialogs/ShareDialog.tsx"),VA=n("./node_modules/@vector-im/compound-web/dist/components/Form/Message.js");const jA=function({roomId:e,onFinished:t}){var n;const[i,r]=(0,o.useState)(),[s,a]=(0,o.useState)(!1),[l,u]=(0,o.useState)(""),[m,h]=(0,o.useState)(!1),p=f.J.safeGet(),g=(0,o.useCallback)(e=>u(e.target.value),[]),v=(0,o.useCallback)(()=>t(!1),[t]),_=(0,o.useCallback)(async()=>{a(!0);try{await p.reportRoom(e,l),t(m)}catch(e){a(!1),e instanceof Error?r(e.message):r("Unknown error")}},[e,l,p,m,t]),y=null===(n=d.Ay.getObject("report_event"))||void 0===n?void 0:n.get("admin_message_md","adminMessageMD");let b;if(y){const e=new bo.A(y).toHTML({externalLinks:!0});b=o.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}return o.createElement(X.A,{className:"mx_ReportRoomDialog",onFinished:v,title:(0,c._t)("action|report_room"),contentId:"mx_ReportEventDialog"},o.createElement(AS.b,{id:"mx_ReportEventDialog",onSubmit:_},o.createElement(IS.D,{name:"reason"},o.createElement(TS.J,{htmlFor:"mx_ReportRoomDialog_reason"},(0,c._t)("report_room|reason_label")),o.createElement("textarea",{id:"mx_ReportRoomDialog_reason",rows:5,onChange:g,value:l,disabled:s}),i?o.createElement(VA.Kw,null,i):null,o.createElement(VA.po,null,(0,c._t)("report_room|description"))),b,s?o.createElement(Ce.Z,null):null,o.createElement(Ko.A,{label:(0,c._t)("room_list|more_options|leave_room"),value:m,onChange:h}),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|send_report"),onPrimaryButtonClick:_,focus:!0,onCancel:v,primaryButtonClass:"danger",primaryDisabled:s||!l})))};var zA=n("./src/components/views/right_panel/types.ts"),HA=n("./src/utils/promise.ts");function WA(e){var t,n;const r=null!==(t=null==e||null===(n=e.getLiveTimeline().getState(i.EventTimeline.FORWARDS))||void 0===n||null===(n=n.getStateEvents(i.EventType.RoomPinnedEvents,""))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.pinned)&&void 0!==t?t:[];return Array.isArray(r)?r.slice(0,100):(s.vF.warn("Encountered invalid pinned events state in room",null==e?void 0:e.roomId,r),[])}const GA=e=>{const[t,n]=(0,o.useState)(WA(e)),r=(0,o.useCallback)(t=>{t&&t.getType()!==i.EventType.RoomPinnedEvents||n(WA(e))},[e]);return(0,lr.YK)(null==e?void 0:e.getLiveTimeline().getState(i.EventTimeline.FORWARDS),i.RoomStateEvent.Events,r),(0,o.useEffect)(()=>(n(WA(e)),()=>{n([])}),[e]),t};function KA(e){var t,n;return new Set(null!==(t=null==e||null===(n=e.getAccountData(zA.M))||void 0===n||null===(n=n.getContent())||void 0===n?void 0:n.event_ids)&&void 0!==t?t:[])}function qA(e,t){const n=(0,ce.nH)();return(0,mr.e)(()=>{const r=t.map(t=>()=>async function(e,t,n){var r;const o=e.getUnfilteredTimelineSet(),a=null==o||null===(r=o.getTimelineForEvent(t))||void 0===r?void 0:r.getEvents().find(e=>e.getId()===t);if(null!=a&&a.isEncrypted()&&await n.decryptEventIfNeeded(a,{emit:!1}),a)return wi.A.isUnpinnable(a)?a:null;try{const[r,{events:[o]}]=await Promise.all([n.fetchRoomEvent(e.roomId,t),n.relations(e.roomId,t,i.RelationType.Replace,null,{limit:1})]),s=new i.MatrixEvent(r);if(s.isEncrypted()&&await n.decryptEventIfNeeded(s,{emit:!1}),await e.processPollEvents([s]),s.getSender()&&wi.A.isUnpinnable(s))return s.setMetadata(e.currentState,!1),o&&s.makeReplaced(o),s}catch(n){s.vF.error(`Error looking up pinned event ${t} in room ${e.roomId}`),s.vF.error(n)}return null}(e,t,n));return(0,HA.vA)(r,10)},[n,e,t],null)}function $A(e,t){const n=qA(e,t);return(0,o.useMemo)(()=>n?n.sort((e,t)=>e?t?e.getTs()-t.getTs():1:-1):[],[n])}function JA(e){e.client.isGuest()?x.A.dispatch({action:"require_registration"}):x.A.dispatch({action:"view_invite",roomId:e.roomId})}const YA=e=>{const t=((e,t)=>{const[n,r]=(0,o.useState)(()=>{return null==(n=e.getAccountData(t))?void 0:n.getContent();var n}),s=(0,o.useCallback)(e=>{e.getType()===t&&r(e.getContent())},[t]);return(0,lr.YK)(e,i.ClientEvent.AccountData,s),n||{}})(e.client,i.EventType.Direct),[n,r]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{for(const[,i]of Object.entries(t)){var n;if(i.includes(null!==(n=null==e?void 0:e.roomId)&&void 0!==n?n:"")){r(!0);break}}},[e,t]),n};function XA(e,t,n){var r;const s=(0,ce.nH)(),a=null!==(r=(0,Ax.g)(s,e))&&void 0!==r&&r,l=(0,yr.ME)("e2eStatus","timelineRenderingType").e2eStatus,c=(0,Cx.j)(e),d=(0,Jo.U)(e).getJoinRule(),u=e.getCanonicalAlias()||e.getAltAliases()[0]||"",m=GA(e).length,h=(0,lr.dF)(e,i.RoomStateEvent.Update,()=>kx(e)),p=(0,lr.dF)(Pg.Ay.instance,Pg.lA,()=>Pg.Ay.instance.getTagsForRoom(e)).includes(za.DefaultTagID.Favourite),g=YA(e),{searchInputRef:v,onUpdateSearchInput:f}=(e=>{const t=(0,o.useRef)(null);return(0,Lo.F)(x.A,e=>{var n;e.action===W.r.FocusMessageSearch&&(null===(n=t.current)||void 0===n||n.focus())}),{searchInputRef:t,onUpdateSearchInput:n=>{t.current&&n.key===bi.Uz.ESCAPE&&(t.current.value="",null==e||e())}}})(n);return{isDirectMessage:g,isRoomEncrypted:a,roomJoinRule:d,e2eStatus:l,isVideoRoom:c,alias:u,isFavorite:p,canInviteToState:h,searchInputRef:v,pinCount:m,onRoomMembersClick:()=>{lg.A.instance.pushCard({phase:cg.n.MemberList},!0)},onRoomThreadsClick:()=>{lg.A.instance.pushCard({phase:cg.n.ThreadPanel},!0)},onRoomFilesClick:()=>{lg.A.instance.pushCard({phase:cg.n.FilePanel},!0)},onRoomExtensionsClick:()=>{lg.A.instance.pushCard({phase:cg.n.Extensions},!0)},onRoomPinsClick:()=>{Si.A.trackInteraction("PinnedMessageRoomInfoButton"),lg.A.instance.pushCard({phase:cg.n.PinnedMessages},!0)},onRoomSettingsClick:e=>{x.A.dispatch({action:"open_room_settings"}),Si.A.trackInteraction("WebRightPanelRoomInfoSettingsButton",e)},onLeaveRoomClick:()=>{x.A.dispatch({action:"leave_room",room_id:e.roomId})},onShareRoomClick:()=>{R.Ay.createDialog(BA.G,{target:e})},onRoomExportClick:async()=>{R.Ay.createDialog(UA,{room:e})},onRoomPollHistoryClick:()=>{R.Ay.createDialog(Ix,{room:e,matrixClient:s,permalinkCreator:t})},onReportRoomClick:async()=>{const[t]=await R.Ay.createDialog(jA,{roomId:e.roomId}).finished;t&&x.A.dispatch({action:"leave_room",room_id:e.roomId})},onUpdateSearchInput:f,onFavoriteToggleClick:()=>{(0,bf.tagRoom)(e,za.DefaultTagID.Favourite)},onInviteToRoomClick:()=>{JA(e)}}}const QA=["room","className"];function ZA(e){const t=e.target,n=(0,on.uK)(t.href);n!==t.href&&(e.preventDefault(),window.location.hash=n)}function eC(e){let{room:t,className:n}=e,r=(0,v.A)(e,QA);const s=(0,o.useContext)(ce.Ay),[a,l]=(0,o.useState)(!1),d=zo(t),u=(0,ji.sH)(null==d?void 0:d.text,null==d?void 0:d.html),m=(0,o.useCallback)(e=>{var t;null===(t=r.onClick)||void 0===t||t.call(r,e);"A"===e.target.tagName.toUpperCase()?ZA(e):x.A.fire(W.r.ShowRoomTopic)},[r]),h=e=>{l("A"===e.target.tagName.toUpperCase())};return(0,Lo.F)(x.A,e=>{if(e.action===W.r.ShowRoomTopic){const e=t.currentState.maySendStateEvent(i.EventType.RoomTopic,s.getSafeUserId()),n=(0,ji.sH)(null==d?void 0:d.text,null==d?void 0:d.html,void 0,!0),r=R.Ay.createDialog(zp.A,{title:t.name,description:o.createElement("div",null,o.createElement(ji.XZ,{options:{attributes:{onClick(e){m(e),r.close()}}},as:"p"},n),e&&o.createElement(ae.A,{kind:"primary_outline",onClick:()=>{r.close(),x.A.dispatch({action:"open_room_settings"})}},(0,c._t)("room|edit_topic"))),hasCloseButton:!0,button:!1})}}),u?o.createElement(rn.m,{description:(0,c._t)("room|read_topic"),disabled:a},o.createElement("div",(0,tn.A)({},r,{tabIndex:0,role:"button",onClick:m,className:me()(n,"mx_RoomTopic"),onMouseOver:h,onFocus:h,"aria-label":(0,c._t)("room|read_topic")}),o.createElement(ji.XZ,null,u))):o.createElement("div",{className:me()(n,"mx_RoomTopic")})}const tC=({room:e})=>{var t,n;const r=function(e){const[t,n]=(0,o.useState)(!0);return{topic:zo(e),expanded:t,canEditTopic:(0,Jo.U)(e,t=>t.maySendStateEvent(i.EventType.RoomTopic,e.client.getSafeUserId())),onEditClick:e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:"open_room_settings"})},onExpandedClick:e=>{e.preventDefault(),e.stopPropagation(),n(e=>!e)},onTopicLinkClick:e=>{e.target instanceof HTMLAnchorElement&&ZA(e)}}}(e),s=(0,ji.sH)(null===(t=r.topic)||void 0===t?void 0:t.text,null===(n=r.topic)||void 0===n?void 0:n.html);if(!s&&!r.canEditTopic)return null;if(!s)return o.createElement(Fe.s,{as:"section",direction:"column",justify:"center",gap:"var(--cpd-space-2x)",className:"mx_RoomSummaryCard_topic"},o.createElement(QS,{flex:"1",className:"mx_RoomSummaryCard_topic_box"},o.createElement(wS.N,{kind:"primary",onClick:r.onEditClick},o.createElement(og.E,{size:"sm",weight:"regular"},(0,c._t)("right_panel|add_topic")))));const a=r.expanded?o.createElement(ji.XZ,null,s):s;return o.createElement(Fe.s,{as:"section",direction:"column",justify:"center",gap:"var(--cpd-space-2x)",className:me()("mx_RoomSummaryCard_topic",{mx_RoomSummaryCard_topic_collapsed:!r.expanded})},o.createElement(QS,{flex:"1",className:"mx_RoomSummaryCard_topic_container mx_RoomSummaryCard_topic_box"},o.createElement(og.E,{size:"sm",weight:"regular",onClick:r.onTopicLinkClick},a),o.createElement(rg.K,{className:"mx_RoomSummaryCard_topic_chevron",size:"24px",onClick:r.onExpandedClick},o.createElement(Gg,null))),r.expanded&&r.canEditTopic&&o.createElement(QS,{flex:"1",className:"mx_RoomSummaryCard_topic_edit"},o.createElement(wS.N,{kind:"primary",onClick:r.onEditClick},o.createElement(og.E,{size:"sm",weight:"regular"},(0,c._t)("action|edit")))))},nC=({room:e,permalinkCreator:t,onSearchChange:n,onSearchCancel:r,focusRoomSearch:s,searchTerm:a=""})=>{const l=XA(e,t,r),[d,u]=(0,o.useState)(a);(0,o.useEffect)(()=>{u(a)},[a]);const m=o.createElement("header",{className:"mx_RoomSummaryCard_container"},o.createElement(Tn.A,{room:e,size:"80px",viewAvatarOnClick:!0}),o.createElement(To,{room:e},e=>o.createElement(SS.D,{as:"h1",size:"md",weight:"semibold",className:"mx_RoomSummaryCard_roomName text-primary",title:e},e)),o.createElement(og.E,{as:"div",size:"sm",weight:"semibold",className:"mx_RoomSummaryCard_alias text-secondary",title:l.alias},l.alias),o.createElement(Fe.s,{as:"section",justify:"center",gap:"var(--cpd-space-2x)",className:"mx_RoomSummaryCard_badges"},!l.isDirectMessage&&l.roomJoinRule===i.JoinRule.Public&&o.createElement(xS.E,{kind:"blue"},o.createElement(Kf,{width:"1em",color:"var(--cpd-color-icon-info-primary)"}),(0,c._t)("common|public_room")),l.isRoomEncrypted&&l.e2eStatus!==qS.z.Warning&&o.createElement(xS.E,{kind:"green"},o.createElement(WS.A,{width:"1em"}),(0,c._t)("common|encrypted")),!l.isRoomEncrypted&&o.createElement(xS.E,{kind:"blue"},o.createElement(GS.A,{width:"1em",color:"var(--cpd-color-icon-info-primary)"}),(0,c._t)("common|unencrypted")),l.e2eStatus===qS.z.Warning&&o.createElement(xS.E,{kind:"red"},o.createElement(Te.A,{width:"1em"}),(0,c._t)("common|not_trusted"))),o.createElement(tC,{room:e})),h=n&&o.createElement(AS.b,{className:"mx_RoomSummaryCard_search",onSubmit:e=>e.preventDefault()},o.createElement(MS,{placeholder:(0,c._t)("room|search|placeholder"),name:"room_message_search",onChange:e=>{u(e.currentTarget.value),n(e.currentTarget.value)},value:d,className:"mx_no_textinput",ref:l.searchInputRef,autoFocus:s,onKeyDown:l.onUpdateSearchInput}));return o.createElement(KS.A,{id:"room-summary-panel",className:"mx_RoomSummaryCard",ariaLabelledBy:"room-summary-panel-tab",role:"tabpanel",header:h},m,o.createElement(sf.w,null),o.createElement("div",{role:"menubar","aria-orientation":"vertical"},o.createElement(of,{Icon:mf,label:(0,c._t)("room|context_menu|favourite"),checked:l.isFavorite,onSelect:l.onFavoriteToggleClick}),o.createElement(ig.D,{Icon:Hg.A,label:(0,c._t)("action|invite"),disabled:!l.canInviteToState,onSelect:l.onInviteToRoomClick}),o.createElement(sf.w,null),o.createElement(ig.D,{Icon:jS,label:(0,c._t)("common|people"),onSelect:l.onRoomMembersClick}),o.createElement(ig.D,{Icon:Bn.A,label:(0,c._t)("common|threads"),onSelect:l.onRoomThreadsClick}),!l.isVideoRoom&&o.createElement(o.Fragment,null,o.createElement(xx,{feature:"pinningMessageList",header:(0,c._t)("right_panel|pinned_messages|release_announcement|title"),description:(0,c._t)("right_panel|pinned_messages|release_announcement|description"),closeLabel:(0,c._t)("right_panel|pinned_messages|release_announcement|close"),placement:"top"},o.createElement("div",null,o.createElement(ig.D,{Icon:Hn,label:(0,c._t)("right_panel|pinned_messages_button"),onSelect:l.onRoomPinsClick},o.createElement(og.E,{as:"span",size:"sm"},l.pinCount)))),o.createElement(ig.D,{Icon:LS.A,label:(0,c._t)("right_panel|files_button"),onSelect:l.onRoomFilesClick}),o.createElement(ig.D,{Icon:BS,label:(0,c._t)("right_panel|extensions_button"),onSelect:l.onRoomExtensionsClick})),o.createElement(sf.w,null),o.createElement(ig.D,{Icon:Or.A,label:(0,c._t)("action|copy_link"),onSelect:l.onShareRoomClick}),!l.isVideoRoom&&o.createElement(o.Fragment,null,o.createElement(ig.D,{Icon:HS,label:(0,c._t)("right_panel|polls_button"),onSelect:l.onRoomPollHistoryClick}),o.createElement(ig.D,{Icon:FS,label:(0,c._t)("export_chat|title"),onSelect:l.onRoomExportClick})),o.createElement(ig.D,{Icon:Zg,label:(0,c._t)("common|settings"),onSelect:l.onRoomSettingsClick}),o.createElement(sf.w,null),o.createElement("div",{className:"mx_RoomSummaryCard_bottomOptions"},o.createElement(ig.D,{Icon:Ge.A,kind:"critical",label:(0,c._t)("action|report_room"),onSelect:l.onReportRoomClick}),o.createElement(ig.D,{className:"mx_RoomSummaryCard_leave",Icon:gf.A,kind:"critical",label:(0,c._t)("action|leave_room"),onSelect:l.onLeaveRoomClick}))))};var iC=n("./src/utils/WidgetUtils.ts"),rC=n("./node_modules/matrix-widget-api/lib/index.js"),oC=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/WidgetLifecycle.js"),sC=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/collapse.js"),aC=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/expand.js"),lC=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/minus.js");function cC(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M12 8a1.5 1.5 0 0 0-1.5 1.5 1 1 0 1 1-2 0 3.5 3.5 0 1 1 6.01 2.439q-.183.188-.352.355c-.287.288-.54.54-.76.824-.293.375-.398.651-.398.882a1 1 0 1 1-2 0c0-.874.407-1.58.819-2.11.305-.392.688-.775 1-1.085l.257-.26A1.5 1.5 0 0 0 12 8m1 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0"}),(0,$.jsx)("path",{d:"M8.1 21.213A9.7 9.7 0 0 0 12 22a9.7 9.7 0 0 0 3.9-.788 10.1 10.1 0 0 0 3.175-2.137q1.35-1.35 2.137-3.175A9.7 9.7 0 0 0 22 12a9.7 9.7 0 0 0-.788-3.9 10.1 10.1 0 0 0-2.137-3.175q-1.35-1.35-3.175-2.137A9.7 9.7 0 0 0 12 2a9.7 9.7 0 0 0-3.9.788 10.1 10.1 0 0 0-3.175 2.137Q3.575 6.275 2.788 8.1A9.7 9.7 0 0 0 2 12q0 2.075.788 3.9a10.1 10.1 0 0 0 2.137 3.175q1.35 1.35 3.175 2.137m9.575-3.538Q15.35 20 12 20t-5.675-2.325T4 12t2.325-5.675T12 4t5.675 2.325T20 12t-2.325 5.675"})]})}cC.displayName="HelpIcon";const dC=(0,o.forwardRef)(cC);var uC=n("./src/components/views/typography/Heading.tsx"),mC=n("./src/utils/UrlUtils.ts");function hC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}class pC extends o.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),n=f.J.safeGet().getRoom(this.props.roomId);let i=null;n&&(i=n.getMember(this.props.creatorUserId)),this.state=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?hC(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):hC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({roomMember:i},t)}parseWidgetUrl(){const e=(0,mC.Dl)(this.props.url);if(iC.A.isScalarUrl(this.props.url)&&e.searchParams.has("url")){const t=(0,mC.Dl)(e.searchParams.get("url"));return{widgetDomain:t.host||t.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=d.Ay.get().brand,t=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,n=t===this.props.creatorUserId?null:this.props.creatorUserId,i=this.state.roomMember?o.createElement(bn.A,{member:this.state.roomMember,size:"38px"}):o.createElement(Xp.A,{name:this.props.creatorUserId,size:"38px"}),r=o.createElement(rn.m,{label:(0,c._t)("analytics|shared_data_heading"),caption:o.createElement("ul",null,o.createElement("li",null,(0,c._t)("widget|shared_data_name")),o.createElement("li",null,(0,c._t)("widget|shared_data_avatar")),o.createElement("li",null,(0,c._t)("widget|shared_data_mxid")),o.createElement("li",null,(0,c._t)("widget|shared_data_device_id")),o.createElement("li",null,(0,c._t)("widget|shared_data_theme")),o.createElement("li",null,(0,c._t)("widget|shared_data_lang")),o.createElement("li",null,(0,c._t)("widget|shared_data_url",{brand:e})),o.createElement("li",null,(0,c._t)("widget|shared_data_room_id")),o.createElement("li",null,(0,c._t)("widget|shared_data_widget_id")))},o.createElement("div",{className:"mx_TextWithTooltip_target mx_TextWithTooltip_target--helpIcon"},o.createElement(dC,{className:"mx_Icon mx_Icon_12"}))),s=this.state.isWrapped?(0,c._t)("widget|shared_data_warning_im",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>r}):(0,c._t)("widget|shared_data_warning",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>r}),a=this.props.isRoomEncrypted?(0,c._t)("widget|unencrypted_warning"):null;return o.createElement("div",{className:"mx_AppPermission"},o.createElement("div",{className:"mx_AppPermission_content"},o.createElement("div",{className:"mx_AppPermission_content_bolder"},(0,c._t)("widget|added_by")),o.createElement("div",null,i,o.createElement(uC.A,{size:"4"},t),o.createElement("div",null,n)),o.createElement("div",null,s),o.createElement("div",null,(0,c._t)("widget|cookie_warning"),"",a),o.createElement("div",null,o.createElement(ae.A,{kind:"primary_sm",onClick:this.props.onPermissionGranted},(0,c._t)("action|continue")))))}}(0,S.A)(pC,"defaultProps",{onPermissionGranted:()=>{}});var gC=n("./res/img/warning.svg");const vC=e=>o.createElement("div",{className:"mx_AppWarning"},o.createElement("div",null,o.createElement("img",{src:gC.A,alt:""})),o.createElement("div",null,o.createElement("span",null,e.errorMsg||"Error")));function fC(e){const t=document.createElement("div");return t.id=e,function(){let e=document.getElementById("mx_PersistedElement_container");return e||(e=document.createElement("div"),e.id="mx_PersistedElement_container",document.body.appendChild(e)),e}().appendChild(t),t}class _C extends o.Component{constructor(e){super(e),(0,S.A)(this,"resizeObserver",void 0),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"childContainer",void 0),(0,S.A)(this,"child",void 0),(0,S.A)(this,"collectChildContainer",e=>{this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)}),(0,S.A)(this,"collectChild",e=>{this.child=e,this.updateChild()}),(0,S.A)(this,"onAction",e=>{"timeline_resize"===e.action?this.repositionChild():"logout"===e.action&&_C.destroyElement(this.props.persistKey)}),(0,S.A)(this,"repositionChild",()=>{this.updateChildPosition(this.child,this.childContainer)}),this.resizeObserver=new ResizeObserver(this.repositionChild),this.props.moveRef&&(this.props.moveRef.current=this.repositionChild)}static destroyElement(e){const t=_C.rootMap[e];t&&(t[0].unmount(),t[1].remove()),delete _C.rootMap[e]}static isMounted(e){return Boolean(_C.rootMap[e])}componentDidMount(){window.addEventListener("resize",this.repositionChild),this.dispatcherRef=x.A.register(this.onAction),this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this.repositionChild),x.A.unregister(this.dispatcherRef)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=o.createElement(o.StrictMode,null,o.createElement(ce.Ay.Provider,{value:f.J.safeGet()},o.createElement(aa.B,null,o.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children))));let t=_C.rootMap[this.props.persistKey];if(!t){const e=fC("mx_persistedElement_"+this.props.persistKey);t=[(0,Ox.createRoot)(e),e],_C.rootMap[this.props.persistKey]=t}t[0].render(e)}updateChildVisibility(e,t=!1){e&&(e.style.display=t?"block":"none")}updateChildPosition(e,t){if(!e||!t)return;const n=t.getBoundingClientRect();Object.assign(e.style,{zIndex:(0,_a.hX)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:"0",left:"0",transform:`translateX(${n.left}px) translateY(${n.top}px)`,width:n.width+"px",height:n.height+"px"})}render(){return o.createElement("div",{ref:this.collectChildContainer})}}(0,S.A)(_C,"rootMap",{});var yC=n("./src/widgets/WidgetType.ts");var bC=n("./src/stores/widgets/WidgetPermissionStore.ts");class EC extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"onAllow",()=>{this.onPermissionSelection(!0)}),(0,S.A)(this,"onDeny",()=>{this.onPermissionSelection(!1)}),(0,S.A)(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),this.state={rememberSelection:!1}}onPermissionSelection(e){this.state.rememberSelection&&(s.vF.log(`Remembering ${this.props.widget.id} as allowed=${e} for OpenID`),as.M.instance.widgetPermissionStore.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?bC.R.Allowed:bC.R.Denied)),this.props.onFinished(e)}render(){return o.createElement(X.A,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,c._t)("widget|open_id_permissions_dialog|title")},o.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},o.createElement("p",null,(0,c._t)("widget|open_id_permissions_dialog|starting_text")),o.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|continue"),onPrimaryButtonClick:this.onAllow,onCancel:this.onDeny,additive:o.createElement(Ko.A,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,c._t)("widget|open_id_permissions_dialog|remember_selection")})}))}}let wC=function(e){return e.CanChangeViewedRoom="io.element.view_room",e.RequiresClient="io.element.requires_client",e}({});var SC=n("./src/components/views/elements/TextWithTooltip.tsx");const xC="generic";class AC{static bylineFor(e){return e.kind===rC.EventKind.State?e.keyStr?(0,c._t)("widget|capability|byline_state_key",{stateKey:e.keyStr}):(0,c._t)("widget|capability|byline_empty_state_key"):null}static for(e,t){if(AC.simpleCaps[e]){const n=AC.simpleCaps[e];if(n[t])return{primary:(0,c._t)(n[t])};if(n[xC])return{primary:(0,c._t)(n[xC])}}if((0,rC.isTimelineCapability)(e)){if((0,rC.isTimelineCapabilityFor)(e,rC.Symbols.AnyRoom))return{primary:(0,c._t)("widget|capability|any_room")};{const t=(0,rC.getTimelineRoomIDFromCapability)(e),n=f.J.safeGet().getRoom(t);return{primary:(0,c._t)("widget|capability|specific_room",{},{Room:()=>{var e;return n?o.createElement(SC.A,{tooltip:null!==(e=n.getCanonicalAlias())&&void 0!==e?e:t},o.createElement("strong",null,n.name)):o.createElement("strong",null,o.createElement("code",null,t))}})}}}const[n]=rC.WidgetEventCapability.findEventCapabilities([e]);if(n){if(n.kind===rC.EventKind.Event&&n.eventType===i.EventType.RoomMessage)return AC.forRoomMessageCap(n,t);const e=n.kind===rC.EventKind.State?AC.stateSendRecvCaps:AC.nonStateSendRecvCaps;if(e[n.eventType]){const i=e[n.eventType],r=(null==i?void 0:i[t])||(null==i?void 0:i[xC]);if(null!=r&&r[n.direction])return{primary:(0,c._t)(r[n.direction])}}return t===rC.WidgetKind.Room?n.direction===rC.EventDirection.Send?{primary:(0,c._t)("widget|capability|send_event_type_this_room",{eventType:n.eventType},{b:e=>o.createElement("strong",null,e)}),byline:AC.bylineFor(n)}:{primary:(0,c._t)("widget|capability|see_event_type_sent_this_room",{eventType:n.eventType},{b:e=>o.createElement("strong",null,e)}),byline:AC.bylineFor(n)}:n.direction===rC.EventDirection.Send?{primary:(0,c._t)("widget|capability|send_event_type_active_room",{eventType:n.eventType},{b:e=>o.createElement("strong",null,e)}),byline:AC.bylineFor(n)}:{primary:(0,c._t)("widget|capability|see_event_type_sent_active_room",{eventType:n.eventType},{b:e=>o.createElement("strong",null,e)}),byline:AC.bylineFor(n)}}return{primary:(0,c._t)("widget|capability|capability",{capability:e},{b:e=>o.createElement("strong",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===rC.EventDirection.Send?{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|send_messages_this_room"):(0,c._t)("widget|capability|send_messages_active_room")}:{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|see_messages_sent_this_room"):(0,c._t)("widget|capability|see_messages_sent_active_room")};switch(e.keyStr){case i.MsgType.Text:return e.direction===rC.EventDirection.Send?{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|send_text_messages_this_room"):(0,c._t)("widget|capability|send_text_messages_active_room")}:{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|see_text_messages_sent_this_room"):(0,c._t)("widget|capability|see_text_messages_sent_active_room")};case i.MsgType.Emote:return e.direction===rC.EventDirection.Send?{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|send_emotes_this_room"):(0,c._t)("widget|capability|send_emotes_active_room")}:{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|see_sent_emotes_this_room"):(0,c._t)("widget|capability|see_sent_emotes_active_room")};case i.MsgType.Image:return e.direction===rC.EventDirection.Send?{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|send_images_this_room"):(0,c._t)("widget|capability|send_images_active_room")}:{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|see_images_sent_this_room"):(0,c._t)("widget|capability|see_images_sent_active_room")};case i.MsgType.Video:return e.direction===rC.EventDirection.Send?{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|send_videos_this_room"):(0,c._t)("widget|capability|send_videos_active_room")}:{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|see_videos_sent_this_room"):(0,c._t)("widget|capability|see_videos_sent_active_room")};case i.MsgType.File:return e.direction===rC.EventDirection.Send?{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|send_files_this_room"):(0,c._t)("widget|capability|send_files_active_room")}:{primary:t===rC.WidgetKind.Room?(0,c._t)("widget|capability|see_sent_files_this_room"):(0,c._t)("widget|capability|see_sent_files_active_room")};default:{let n;return n=e.direction===rC.EventDirection.Send?t===rC.WidgetKind.Room?(0,c._t)("widget|capability|send_msgtype_this_room",{msgtype:e.keyStr},{b:e=>o.createElement("strong",null,e)}):(0,c._t)("widget|capability|send_msgtype_active_room",{msgtype:e.keyStr},{b:e=>o.createElement("strong",null,e)}):t===rC.WidgetKind.Room?(0,c._t)("widget|capability|see_msgtype_sent_this_room",{msgtype:e.keyStr},{b:e=>o.createElement("strong",null,e)}):(0,c._t)("widget|capability|see_msgtype_sent_active_room",{msgtype:e.keyStr},{b:e=>o.createElement("strong",null,e)}),{primary:n}}}}}(0,S.A)(AC,"simpleCaps",{[rC.MatrixCapabilities.AlwaysOnScreen]:{[rC.WidgetKind.Room]:(0,c.AO)("widget|capability|always_on_screen_viewing_another_room"),[xC]:(0,c.AO)("widget|capability|always_on_screen_generic")},[rC.MatrixCapabilities.StickerSending]:{[rC.WidgetKind.Room]:(0,c.AO)("widget|capability|send_stickers_this_room"),[xC]:(0,c.AO)("widget|capability|send_stickers_active_room")},[wC.CanChangeViewedRoom]:{[xC]:(0,c.AO)("widget|capability|switch_room")},[rC.MatrixCapabilities.MSC2931Navigate]:{[xC]:(0,c.AO)("widget|capability|switch_room_message_user")}}),(0,S.A)(AC,"stateSendRecvCaps",{[i.EventType.RoomTopic]:{[rC.WidgetKind.Room]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|change_topic_this_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_topic_change_this_room")},[xC]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|change_topic_active_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_topic_change_active_room")}},[i.EventType.RoomName]:{[rC.WidgetKind.Room]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|change_name_this_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_name_change_this_room")},[xC]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|change_name_active_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_name_change_active_room")}},[i.EventType.RoomAvatar]:{[rC.WidgetKind.Room]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|change_avatar_this_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_avatar_change_this_room")},[xC]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|change_avatar_active_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_avatar_change_active_room")}},[i.EventType.RoomMember]:{[rC.WidgetKind.Room]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|remove_ban_invite_leave_this_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|receive_membership_this_room")},[xC]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|remove_ban_invite_leave_active_room"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|receive_membership_active_room")}}}),(0,S.A)(AC,"nonStateSendRecvCaps",{[i.EventType.Sticker]:{[rC.WidgetKind.Room]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|send_stickers_this_room_as_you"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_sticker_posted_this_room")},[xC]:{[rC.EventDirection.Send]:(0,c.AO)("widget|capability|send_stickers_active_room_as_you"),[rC.EventDirection.Receive]:(0,c.AO)("widget|capability|see_sticker_posted_active_room")}}});class CC extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"eventPermissionsMap",new Map),(0,S.A)(this,"onToggle",e=>{const t=(0,Dn.tn)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})}),(0,S.A)(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),(0,S.A)(this,"onSubmit",async()=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter(([e,t])=>t).map(([e])=>e))}),(0,S.A)(this,"onReject",async()=>{this.closeAndTryRemember([])});rC.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach(e=>this.eventPermissionsMap.set(e.raw,e));const t={};this.props.requestedCapabilities.forEach(e=>t[e]=!0),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){this.props.onFinished({approved:e,remember:this.state.rememberSelection})}render(){const e=Object.entries(this.state.booleanStates).sort(([e],[t])=>{const n=(0,rC.isTimelineCapability)(e),i=(0,rC.isTimelineCapability)(t);return n||i?n&&!i?1:!n&&i?-1:n&&i?(0,_a.aw)(e,t):0:(0,_a.aw)(e,t)}).map(([e,t],n)=>{const i=AC.for(e,this.props.widgetKind);return o.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:e+n},o.createElement(Io.A,{checked:t,onChange:()=>this.onToggle(e),description:i.byline},i.primary))});return o.createElement(X.A,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:(0,c._t)("widget|capabilities_dialog|title")},o.createElement("form",{onSubmit:this.onSubmit},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("div",{className:"text-muted"},(0,c._t)("widget|capabilities_dialog|content_starting_text")),e,o.createElement(Kt.A,{primaryButton:(0,c._t)("action|approve"),cancelButton:(0,c._t)("widget|capabilities_dialog|decline_all_permission"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:o.createElement(Ko.A,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:(0,c._t)("widget|capabilities_dialog|remember_Selection")})}))))}}var kC=n("./src/customisations/WidgetPermissions.ts"),RC=n("./src/effects/index.ts"),IC=n("./src/effects/utils.ts"),TC=n("./src/utils/permalinks/navigator.ts");function PC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}const NC=({urls:e,username:t,credential:n})=>({uris:e,username:t,password:n});class DC extends rC.WidgetDriver{constructor(e,t,n,r,o){if(super(),(0,S.A)(this,"allowedCapabilities",void 0),this.forWidget=t,this.forWidgetKind=n,this.inRoomId=o,this.allowedCapabilities=new Set([...e,rC.MatrixCapabilities.Screenshots,wC.RequiresClient]),yC.x.JITSI.matches(this.forWidget.type)&&n===rC.WidgetKind.Room)this.allowedCapabilities.add(rC.MatrixCapabilities.AlwaysOnScreen);else if(yC.x.STICKERPICKER.matches(this.forWidget.type)&&n===rC.WidgetKind.Account){const e=rC.WidgetEventCapability.forRoomEvent(rC.EventDirection.Send,i.EventType.Sticker).raw;this.allowedCapabilities.add(rC.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}else if(r&&yC.x.CALL.matches(this.forWidget.type)&&n===rC.WidgetKind.Room){this.allowedCapabilities.add(rC.MatrixCapabilities.AlwaysOnScreen),this.allowedCapabilities.add(rC.MatrixCapabilities.MSC3846TurnServers),this.allowedCapabilities.add(`org.matrix.msc2762.timeline:${o}`),this.allowedCapabilities.add(rC.MatrixCapabilities.MSC4157SendDelayedEvent),this.allowedCapabilities.add(rC.MatrixCapabilities.MSC4157UpdateDelayedEvent),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Receive,i.EventType.RoomName).raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Receive,i.EventType.RoomMember).raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Receive,"org.matrix.msc3401.call").raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Receive,i.EventType.RoomEncryption).raw);const e=f.J.safeGet().getSafeUserId();this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Send,"org.matrix.msc3401.call.member",e).raw);const r=f.J.safeGet().getDeviceId();null!==r&&(this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Send,"org.matrix.msc3401.call.member",`_${e}_${r}`).raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Send,"org.matrix.msc3401.call.member",`_${e}_${r}_m.call`).raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Send,"org.matrix.msc3401.call.member",`${e}_${r}`).raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Send,"org.matrix.msc3401.call.member",`${e}_${r}_m.call`).raw)),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Receive,"org.matrix.msc3401.call.member").raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forStateEvent(rC.EventDirection.Receive,i.EventType.RoomCreate).raw);const s=[i.EventType.CallNotify,i.EventType.RTCNotification],a=["io.element.call.encryption_keys","org.matrix.rageshake_request",i.EventType.Reaction,i.EventType.RoomRedaction,"io.element.call.reaction"];for(const e of[...s,...a])this.allowedCapabilities.add(rC.WidgetEventCapability.forRoomEvent(rC.EventDirection.Send,e).raw);for(const e of a)this.allowedCapabilities.add(rC.WidgetEventCapability.forRoomEvent(rC.EventDirection.Receive,e).raw);const l=[i.EventType.CallInvite,i.EventType.CallCandidates,i.EventType.CallAnswer,i.EventType.CallHangup,i.EventType.CallReject,i.EventType.CallSelectAnswer,i.EventType.CallNegotiate,i.EventType.CallSDPStreamMetadataChanged,i.EventType.CallSDPStreamMetadataChangedPrefix,i.EventType.CallReplaces,i.EventType.CallEncryptionKeysPrefix];for(const e of l)this.allowedCapabilities.add(rC.WidgetEventCapability.forToDeviceEvent(rC.EventDirection.Send,e).raw),this.allowedCapabilities.add(rC.WidgetEventCapability.forToDeviceEvent(rC.EventDirection.Receive,e).raw);as.M.instance.widgetPermissionStore.setOIDCState(t,n,o,bC.R.Allowed)}}async validateCapabilities(e){const t=(n=e,i=this.allowedCapabilities,(0,ie.ZQ)(Array.from(n),Array.from(i)));var n,i;const r=new Set(t.removed),o=new Set(this.allowedCapabilities);var a;let l;if((a=this.forWidget,JSON.parse(localStorage.getItem(`widget_${a.id}_approved_caps`)||"[]")).forEach(e=>{o.add(e),r.delete(e)}),kC.l.preapproveCapabilities)l=await kC.l.preapproveCapabilities(this.forWidget,e);else{const t={approvedCapabilities:void 0};_.r.instance.invoke(oC.Z.CapabilitiesRequest,t,this.forWidget,e),l=t.approvedCapabilities}l&&l.forEach(e=>{o.add(e),r.delete(e)});let c=!1;if(r.size>0)try{var d;const[e]=await R.Ay.createDialog(CC,{requestedCapabilities:r,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;null==e||null===(d=e.approved)||void 0===d||d.forEach(e=>o.add(e)),c=!(null==e||!e.remember)}catch(e){s.vF.error("Non-fatal error getting capabilities: ",e)}const u=new Set(function(e,t){return(0,ie.LY)(Array.from(e),Array.from(t))}(o,e));return c&&function(e,t){localStorage.setItem(`widget_${e.id}_approved_caps`,JSON.stringify(t))}(this.forWidget,Array.from(u)),u}async sendEvent(e,t,n=null,r=null){const o=f.J.get(),s=r||as.M.instance.roomViewStore.getRoomId();if(!o||!s)throw new Error("Not in a room or not attached to a client");let a;return null!==n?a=await o.sendStateEvent(s,e,t,n):e===i.EventType.RoomRedaction?a=await o.redactEvent(s,t.redacts):(a=await o.sendEvent(s,e,t),e===i.EventType.RoomMessage&&RC.y.forEach(e=>{if((0,IC._)(t,e.emojis)){var n;(null===(n=t["m.relates_to"])||void 0===n?void 0:n.rel_type)!==i.THREAD_RELATION_TYPE.name&&x.A.dispatch({action:`effects.${e.command}`})}})),{roomId:s,eventId:a.event_id}}async sendDelayedEvent(e,t,n,i,r=null,o=null){const s=f.J.get(),a=o||as.M.instance.roomViewStore.getRoomId();if(!s||!a)throw new Error("Not in a room or not attached to a client");let l,c;if(null!==e)l=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?PC(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):PC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({delay:e},null!==t&&{parent_delay_id:t});else{if(null===t)throw new Error("Must provide at least one of delay or parentDelayId");l={parent_delay_id:t}}return c=null!==r?await s._unstable_sendDelayedStateEvent(a,l,n,i,r):await s._unstable_sendDelayedEvent(a,l,null,n,i),{roomId:a,delayId:c.delay_id}}async updateDelayedEvent(e,t){const n=f.J.get();if(!n)throw new Error("Not in a room or not attached to a client");await n._unstable_updateDelayedEvent(e,t)}async sendToDevice(e,t,n){const i=f.J.safeGet();if(t){const t=i.getCrypto();if(!t)throw new Error("E2EE not enabled");const r={};for(const e of Object.keys(n)){const t=n[e];for(const n of Object.keys(t)){const i=t[n],o=JSON.stringify(i);r[o]=r[o]||[],r[o].push({userId:e,deviceId:n})}}await Promise.all(Object.entries(r).map(async([n,r])=>{const o=await t.encryptToDeviceMessages(e,r,JSON.parse(n));await i.queueToDevice(o)}))}else await i.queueToDevice({eventType:e,batch:Object.entries(n).flatMap(([e,t])=>Object.entries(t).map(([t,n])=>({userId:e,deviceId:t,payload:n})))})}async readRoomTimeline(e,t,n,r,o,s){o=o>0?Math.min(o,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const a=f.J.safeGet().getRoom(e);if(null===a)return[];const l=[],c=a.getLiveTimeline().getEvents();for(let e=c.length-1;e>=0;e--){const a=c[e];if(l.length>=o)break;if(void 0!==s&&a.getId()===s)break;a.getType()===t&&(t===i.EventType.RoomMessage&&n&&n!==a.getContent().msgtype||void 0!==r&&a.getStateKey()!==r||l.push(a))}return l.map(e=>e.getEffectiveEvent())}async readRoomState(e,t,n){const r=f.J.safeGet().getRoom(e);if(null===r)return[];const o=r.getLiveTimeline().getState(i.Direction.Forward);if(void 0===o)return[];if(void 0===n)return o.getStateEvents(t).map(e=>e.getEffectiveEvent());const s=o.getStateEvents(t,n);return null===s?[]:[s.getEffectiveEvent()]}async askOpenID(e){const t={approved:void 0};if(_.r.instance.invoke(oC.Z.IdentityRequest,t,this.forWidget),t.approved)return e.update({state:rC.OpenIDRequestState.Allowed,token:await f.J.safeGet().getOpenIdToken()});const n=as.M.instance.widgetPermissionStore.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),i=()=>f.J.safeGet().getOpenIdToken();if(n===bC.R.Denied)return e.update({state:rC.OpenIDRequestState.Blocked});if(n===bC.R.Allowed)return e.update({state:rC.OpenIDRequestState.Allowed,token:await i()});e.update({state:rC.OpenIDRequestState.PendingUserConfirmation});const{finished:r}=R.Ay.createDialog(EC,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId}),[o]=await r;o?e.update({state:rC.OpenIDRequestState.Allowed,token:await i()}):e.update({state:rC.OpenIDRequestState.Blocked})}async navigate(e){(0,TC.O)(e)}async*getTurnServers(){const e=f.J.safeGet();if(!e.pollingTurnServers||!e.getTurnServers().length)return;let t,n;const r=([e])=>t(NC(e)),o=(e,t)=>{t&&n(e)};e.on(i.ClientEvent.TurnServers,r),e.on(i.ClientEvent.TurnServersError,o);try{const i=e.getTurnServers()[0];for(yield NC(i);;)yield await new Promise((e,i)=>{t=e,n=i})}finally{e.off(i.ClientEvent.TurnServers,r),e.off(i.ClientEvent.TurnServersError,o)}}async readEventRelations(e,t,n,i,r,o,s,a){var l;const c=f.J.safeGet(),d=a;if("string"!=typeof(t=null!==(l=null!=t?t:as.M.instance.roomViewStore.getRoomId())&&void 0!==l?l:void 0))throw new Error("Error while reading the current room");const{events:u,nextBatch:m,prevBatch:h}=await c.relations(t,e,null!=n?n:null,null!=i?i:null,{from:r,to:o,limit:s,dir:d});return{chunk:u.map(e=>e.getEffectiveEvent()),nextBatch:null!=m?m:void 0,prevBatch:null!=h?h:void 0}}async searchUserDirectory(e,t){const n=f.J.safeGet(),{limited:i,results:r}=await n.searchUserDirectory({term:e,limit:t});return{limited:i,results:r.map(e=>({userId:e.user_id,displayName:e.display_name,avatarUrl:e.avatar_url}))}}async getMediaConfig(){const e=f.J.safeGet();return await e.getMediaConfig()}async uploadFile(e){const t=f.J.safeGet();return{contentUri:(await t.uploadContent(e)).content_uri}}async downloadFile(e){const t=f.J.safeGet(),n=(0,Vi.mediaFromMxc)(e,t),i=await n.downloadSource();return{file:await i.blob()}}getKnownRooms(){return f.J.safeGet().getVisibleRooms(O.A.getValue("feature_dynamic_room_predecessors")).map(e=>e.roomId)}processError(e){return e instanceof i.MatrixError?{matrix_api_error:e.asWidgetApiErrorData()}:void 0}}var MC=n("./src/stores/widgets/WidgetMessagingStore.ts"),OC=n("./src/stores/widgets/ElementWidgetActions.ts");const FC="io.element.web";function LC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function UC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?LC(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):LC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class BC extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"widget",void 0),(0,S.A)(this,"possibleButtons",void 0),(0,S.A)(this,"appFrame",o.createRef()),(0,S.A)(this,"themeWatcher",new Ta.A),(0,S.A)(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter(e=>e.disabled).map(e=>e.id)}),(0,S.A)(this,"onReady",()=>{var e;this.themeWatcher.start(),this.themeWatcher.on(Ta.S.Change,this.onThemeChange),this.onThemeChange(this.themeWatcher.getEffectiveTheme()),null===(e=this.state.messaging)||void 0===e||e.sendWidgetConfig(this.props.widgetDefinition)}),(0,S.A)(this,"onLoad",()=>{this.state.messaging&&(this.state.messaging.once("ready",this.onReady),this.state.messaging.on(`action:${rC.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.on(`action:${rC.WidgetApiFromWidgetAction.SetModalButtonEnabled}`,this.onButtonEnableToggle))}),(0,S.A)(this,"onThemeChange",e=>{var t;null===(t=this.state.messaging)||void 0===t||t.updateTheme({name:e})}),(0,S.A)(this,"onWidgetClose",e=>{this.props.onFinished(!0,e.detail.data)}),(0,S.A)(this,"onButtonEnableToggle",e=>{var t;e.preventDefault();var n;if(e.detail.data.button===rC.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return null===(n=this.state.messaging)||void 0===n?void 0:n.transport.reply(e.detail,{error:{message:"Invalid button"}});let i;if(e.detail.data.enabled)i=(0,ie.PF)(this.state.disabledButtonIds).filter(t=>t!==e.detail.data.button);else{const t=new Set(this.state.disabledButtonIds);t.add(e.detail.data.button),i=Array.from(t)}this.setState({disabledButtonIds:i}),null===(t=this.state.messaging)||void 0===t||t.transport.reply(e.detail,{})}),this.widget=new $C(UC(UC({},this.props.widgetDefinition),{},{creatorUserId:f.J.safeGet().getSafeUserId(),id:`modal_${this.props.sourceWidgetId}`})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map(e=>e.id)}componentDidMount(){const e=new DC([],this.widget,rC.WidgetKind.Modal,!1),t=new rC.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.themeWatcher.off(Ta.S.Change,this.onThemeChange),this.themeWatcher.stop(),this.state.messaging&&(this.state.messaging.off("ready",this.onReady),this.state.messaging.off(`action:${rC.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.stop())}render(){var e,t,n;const i=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:f.J.safeGet().getSafeUserId(),userDisplayName:null!==(e=Yp.V.instance.displayName)&&void 0!==e?e:void 0,userHttpAvatarUrl:null!==(t=Yp.V.instance.getHttpAvatarUrl())&&void 0!==t?t:void 0,clientId:FC,clientTheme:this.themeWatcher.getEffectiveTheme(),clientLanguage:(0,c.mf)(),baseUrl:f.J.safeGet().baseUrl}),r=new URL(i);r.searchParams.set("widgetId",this.widget.id),r.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const s=r.toString().replace(/%24/g,"$");let a;return this.props.widgetDefinition.buttons&&(a=this.props.widgetDefinition.buttons.slice(0,3).reverse().map(e=>{let t="secondary";switch(e.kind){case rC.ModalButtonKind.Primary:t="primary";break;case rC.ModalButtonKind.Secondary:t="primary_outline";break;case rC.ModalButtonKind.Danger:t="danger"}const n=this.state.disabledButtonIds.includes(e.id);return o.createElement(ae.A,{key:e.id,kind:t,onClick:()=>{var t;null===(t=this.state.messaging)||void 0===t||t.notifyModalWidgetButtonClicked(e.id)},disabled:n},e.label)})),o.createElement(X.A,{title:this.props.widgetDefinition.name||(0,c._t)("widget|modal_title_default"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},o.createElement("div",{className:"mx_ModalWidgetDialog_warning"},o.createElement(Ge.A,{width:"16px",height:"16px"}),(0,c._t)("widget|modal_data_warning",{widgetDomain:r.hostname})),o.createElement("div",null,o.createElement("iframe",{title:null!==(n=this.widget.name)&&void 0!==n?n:void 0,ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:s,onLoad:this.onLoad})),o.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},a))}}var VC;function jC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function zC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?jC(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):jC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class HC extends Ea.r{constructor(){super(x.A,{}),(0,S.A)(this,"modalInstance",null),(0,S.A)(this,"openSourceWidgetId",null),(0,S.A)(this,"openSourceWidgetRoomId",null),(0,S.A)(this,"canOpenModalWidget",()=>!this.modalInstance),(0,S.A)(this,"openModalWidget",(e,t,n)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.openSourceWidgetRoomId=null!=n?n:null,this.modalInstance=R.Ay.createDialog(BC,{widgetDefinition:zC({},e),widgetRoomId:n,sourceWidgetId:t.id},void 0,!1,!0),this.modalInstance.finished.then(([e,i])=>{this.closeModalWidget(t,n,e&&i?i:{"m.exited":!0}),this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance=null}))}),(0,S.A)(this,"closeModalWidget",(e,t,n)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id&&this.openSourceWidgetRoomId===t){this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance.close(),this.modalInstance=null;const i=MC.c.instance.getMessaging(e,t);if(!i)return void s.vF.error("No source widget messaging for modal widget");i.notifyModalWidgetClose(n)}})}static get instance(){return HC.internalInstance}async onAction(e){}}VC=HC,(0,S.A)(HC,"internalInstance",(()=>{const e=new VC;return e.start(),e})()),window.mxModalWidgetStore=HC.instance;var WC=n("./src/stores/WidgetStore.ts"),GC=n("./src/customisations/WidgetVariables.ts");function KC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function qC(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?KC(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):KC(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class $C extends rC.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return yC.x.JITSI.matches(this.type)?iC.A.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return yC.x.JITSI.matches(this.type)?iC.A.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="meet.element.io");let n=(new Ta.A).getEffectiveTheme();if(n.startsWith("custom-")){const e=(0,Op.TP)(n.slice(7));n=e.is_dark?"dark":"light"}return n=n.includes("light")?"light":"dark",qC(qC({},super.rawData),{},{theme:n,conferenceId:e,domain:t})}getCompleteUrl(e,t=!1){return(0,rC.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,qC(qC({},this.rawDefinition),{},{data:this.rawData}),e)}}class JC extends ee.EventEmitter{constructor(e){var t;super(),(0,S.A)(this,"client",void 0),(0,S.A)(this,"iframe",null),(0,S.A)(this,"messaging",null),(0,S.A)(this,"mockWidget",void 0),(0,S.A)(this,"scalarToken",void 0),(0,S.A)(this,"roomId",void 0),(0,S.A)(this,"viewedRoomId",null),(0,S.A)(this,"kind",void 0),(0,S.A)(this,"virtual",void 0),(0,S.A)(this,"themeWatcher",new Ta.A),(0,S.A)(this,"readUpToMap",{}),(0,S.A)(this,"stickyPromise",void 0),(0,S.A)(this,"eventsToFeed",new WeakSet),(0,S.A)(this,"onThemeChange",e=>{var t;null===(t=this.messaging)||void 0===t||t.updateTheme({name:e})}),(0,S.A)(this,"onOpenModal",async e=>{var t,n;(e.preventDefault(),HC.instance.canOpenModalWidget())?(HC.instance.openModalWidget(e.detail.data,this.mockWidget,this.roomId),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{})):null===(n=this.messaging)||void 0===n||n.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})}),(0,S.A)(this,"onRoomViewStoreUpdate",()=>{var e;const t=null!==(e=as.M.instance.roomViewStore.getRoomId())&&void 0!==e?e:null;t!==this.viewedRoomId&&(this.messaging.setViewedRoomId(t),this.viewedRoomId=t)}),(0,S.A)(this,"onEvent",e=>{this.client.decryptEventIfNeeded(e),this.feedEvent(e)}),(0,S.A)(this,"onEventDecrypted",e=>{this.feedEvent(e)}),(0,S.A)(this,"onStateUpdate",e=>{if(null===this.messaging)return;const t=e.getEffectiveEvent();this.messaging.feedStateUpdate(t).catch(e=>{s.vF.error("Error sending state update to widget: ",e)})}),(0,S.A)(this,"onToDeviceMessage",async e=>{var t;const{message:n,encryptionInfo:i}=e;await(null===(t=this.messaging)||void 0===t?void 0:t.feedToDevice(n,null!=i))}),this.appTileProps=e,this.client=f.J.safeGet();let n=e.app;n.creatorUserId||(n=(0,Dn.tn)(n),n.creatorUserId=this.client.getUserId()),this.mockWidget=new $C(n),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?rC.WidgetKind.Account:rC.WidgetKind.Room,this.virtual=(0,WC.Sw)(n)&&void 0===n.eventId,this.stickyPromise=e.stickyPromise}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(e={asPopout:!1}){var t,n,i,r,o;const s=null!==(t=null===GC.c||void 0===GC.c||null===(n=GC.c.provideVariables)||void 0===n?void 0:n.call(GC.c))&&void 0!==t?t:{},a={widgetRoomId:this.roomId,currentUserId:this.client.getUserId(),userDisplayName:null!==(i=Yp.V.instance.displayName)&&void 0!==i?i:void 0,userHttpAvatarUrl:null!==(r=Yp.V.instance.getHttpAvatarUrl())&&void 0!==r?r:void 0,clientId:FC,clientTheme:this.themeWatcher.getEffectiveTheme(),clientLanguage:(0,c.mf)(),deviceId:null!==(o=this.client.getDeviceId())&&void 0!==o?o:void 0,baseUrl:this.client.baseUrl},l=this.mockWidget.getCompleteUrl(Object.assign(a,s),null==e?void 0:e.asPopout),d=new URL(l);return null!=e&&e.asPopout||(d.searchParams.set("widgetId",this.mockWidget.id),d.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&d.searchParams.set("scalar_token",this.scalarToken)),d.toString().replace(/%24/g,"$")}startMessaging(e){if(null!==this.messaging)return;this.iframe=e;const t=this.appTileProps.whitelistCapabilities||[],n=new DC(t,this.mockWidget,this.kind,this.virtual,this.roomId);var r;(this.messaging=new rC.ClientWidgetApi(this.mockWidget,e,n),this.messaging.on("preparing",()=>this.emit("preparing")),this.messaging.on("error:preparing",e=>this.emit("error:preparing",e)),this.messaging.once("ready",()=>{MC.c.instance.storeMessaging(this.mockWidget,this.roomId,this.messaging),this.emit("ready"),this.themeWatcher.start(),this.themeWatcher.on(Ta.S.Change,this.onThemeChange),this.onThemeChange(this.themeWatcher.getEffectiveTheme())}),this.messaging.on("capabilitiesNotified",()=>this.emit("capabilitiesNotified")),this.messaging.on(`action:${rC.WidgetApiFromWidgetAction.OpenModalWidget}`,this.onOpenModal),void 0===this.roomId)?(this.messaging.setViewedRoomId(null!==(r=as.M.instance.roomViewStore.getRoomId())&&void 0!==r?r:null),as.M.instance.roomViewStore.on(ha.H,this.onRoomViewStoreUpdate)):this.messaging.setViewedRoomId(this.roomId);this.messaging.on(`action:${OC.k.ViewRoom}`,e=>{var t;e.preventDefault();const n=(e.detail.data||{}).room_id;var i,r;return n?null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(wC.CanChangeViewedRoom)?(x.A.dispatch({action:W.r.ViewRoom,room_id:n,metricsTrigger:"Widget"}),void this.messaging.transport.reply(e.detail,{})):null===(r=this.messaging)||void 0===r?void 0:r.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):null===(i=this.messaging)||void 0===i?void 0:i.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})});for(const e of this.client.getRooms()){var o;const t=(null===(o=e.getLiveTimeline())||void 0===o?void 0:o.getEvents())||[],n=t[t.length-1];n&&(this.readUpToMap[e.roomId]=n.getId())}this.client.on(i.ClientEvent.Event,this.onEvent),this.client.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.on(i.RoomStateEvent.Events,this.onStateUpdate),this.client.on(i.ClientEvent.ReceivedToDeviceMessage,this.onToDeviceMessage),this.messaging.on(`action:${rC.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen}`,async e=>{var t,n;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(rC.MatrixCapabilities.AlwaysOnScreen)&&(e.preventDefault(),e.detail.data.value&&this.stickyPromise&&await this.stickyPromise(),I.A.instance.setWidgetPersistence(this.mockWidget.id,null!==(n=this.roomId)&&void 0!==n?n:null,e.detail.data.value),this.messaging.transport.reply(e.detail,{}))}),this.messaging.on(`action:${rC.WidgetApiFromWidgetAction.SendSticker}`,e=>{var t;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(rC.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),x.A.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))}),yC.x.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on(`action:${OC.k.OpenIntegrationManager}`,e=>{var t,n;e.preventDefault(),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{}),x.A.dispatch({action:"stickerpicker_close"});const i=e.detail.data,r=null==i?void 0:i.integType,o=null==i?void 0:i.integId,s=as.M.instance.roomViewStore.getRoomId(),a=s?this.client.getRoom(s):void 0;a&&(null===(n=U.J.sharedInstance())||void 0===n||null===(n=n.getPrimaryManager())||void 0===n||n.open(a,`type_${r}`,o))}),yC.x.JITSI.matches(this.mockWidget.type)&&this.messaging.on(`action:${OC.k.HangupCall}`,e=>{var t,n;e.preventDefault(),null!==(t=e.detail.data)&&void 0!==t&&t.errorMessage&&R.Ay.createDialog(Ht.A,{title:(0,c._t)("widget|error_hangup_title"),description:(0,c._t)("widget|error_hangup_description",{message:e.detail.data.errorMessage})}),null===(n=this.messaging)||void 0===n||n.transport.reply(e.detail,{})})}async prepare(){var e,t;if(await(null!==(e=null===GC.c||void 0===GC.c||null===(t=GC.c.isReady)||void 0===t?void 0:t.call(GC.c))&&void 0!==e?e:Promise.resolve()),this.scalarToken)return;const n=MC.c.instance.getMessaging(this.mockWidget,this.roomId);n&&(this.messaging=n);try{if(iC.A.isScalarUrl(this.mockWidget.templateUrl)){const e=U.J.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(t&&iC.A.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){s.vF.error("Error preparing widget communications: ",e)}}stopMessaging(e={forceDestroy:!1}){var t,n;if(null!==this.messaging&&null!==this.iframe){if(e.forceDestroy)this.iframe.src="about:blank";else if(I.A.instance.getWidgetPersistence(this.mockWidget.id,null!==(t=this.roomId)&&void 0!==t?t:null))return void s.vF.log("Skipping destroy - persistent widget");MC.c.instance.stopMessaging(this.mockWidget,this.roomId),null===(n=this.messaging)||void 0===n||n.removeAllListeners(),this.messaging=null,this.iframe=null,as.M.instance.roomViewStore.off(ha.H,this.onRoomViewStoreUpdate),this.client.off(i.ClientEvent.Event,this.onEvent),this.client.off(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),this.client.off(i.RoomStateEvent.Events,this.onStateUpdate),this.client.off(i.ClientEvent.ReceivedToDeviceMessage,this.onToDeviceMessage)}}relatesToUnknown(e){if(!e.relationEventId||e.replyEventId)return!1;const t=this.client.getRoom(e.getRoomId());return null===t||!t.findEventById(e.relationEventId)}isFromInvite(e){const t=this.client.getRoom(e.getRoomId());return(null==t?void 0:t.getMyMembership())===Xt.O.Invite}advanceReadUpToMarker(e){const t=e.getId();if(void 0===t)return!1;const n=e.getRoomId();if(void 0===n)return!1;const i=this.client.getRoom(n);if(null===i)return!1;const r=this.readUpToMap[e.getRoomId()];if(!r)return this.readUpToMap[n]=t,!0;if(r===t)return!1;const o=i.getLiveTimeline(),s=(0,ie.PF)(o.getEvents()).reverse().slice(0,100);for(const i of s){if(i.getId()===r)return!1;if(i.getId()===e.getId())return this.readUpToMap[n]=t,!0}return!1}feedEvent(e){if(null!==this.messaging&&(this.eventsToFeed.delete(e)||this.relatesToUnknown(e)||this.isFromInvite(e)||this.advanceReadUpToMarker(e)))if(e.isBeingDecrypted()||e.isDecryptionFailure())this.eventsToFeed.add(e);else{const t=e.getEffectiveEvent();this.messaging.feedEvent(t).catch(e=>{s.vF.error("Error sending event to widget: ",e)})}}}var YC=n("./src/stores/widgets/WidgetLayoutStore.ts");function XC(){return d.Ay.get("audio_stream_url")}async function QC(e,t,n){const i=await async function(e,t){const n=await e.getOpenIdToken(),i=XC()+"/createStream",r=await window.fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:t,openid_token:n})});return(await r.json()).stream_id}(e,n);await t.transport.send(OC.k.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+i})}const ZC=["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"],ek=e=>!!XC()&&yC.x.JITSI.matches(e.type),tk=(e,t)=>t&&iC.A.isManagedByManager(e),nk=(e,t,n,i)=>{var r;const o=(0,WC.Sw)(n)&&void 0!==n.eventId&&null!==(r=O.A.getValue("allowedWidgets",t)[n.eventId])&&void 0!==r&&r||n.creatorUserId===(null==e?void 0:e.getUserId()),s=yC.x.JITSI.matches(n.type);return!i&&!s&&o},ik=(e,t)=>!!t||e,rk=e=>O.A.getValue("enableWidgetScreenshots")&&!(null==e||!e.hasCapability(rC.MatrixCapabilities.Screenshots)),ok=(e,t,n)=>{if(!n)return[!1,!1];const i=t?YC.aK.instance.getContainerWidgets(t,YC.mc.Top):[],r=i.findIndex(t=>t.id===e.id);return[r>0,r<i.length-1]},sk=(e,t,n,i,r,o)=>{const s=i||iC.A.canUserModifyWidgets(e,null==t?void 0:t.roomId),a=MC.c.instance.getMessagingForUid(iC.A.getWidgetUid(n));return ek(n)||tk(n,s)||nk(e,null==t?void 0:t.roomId,n,i)||ik(s,o)||rk(a)||ok(n,t,r).some(Boolean)},ak=e=>{let{onFinished:t,app:n,userWidget:i,onDeleteClick:r,onEditClick:a,showUnpin:l}=e,d=(0,v.A)(e,ZC);const u=(0,o.useContext)(ce.Ay),{room:m,roomId:h}=(0,yr.ME)("room","roomId"),p=MC.c.instance.getMessagingForUid(iC.A.getWidgetUid(n)),g=i||iC.A.canUserModifyWidgets(u,h);let f,y,b,E,w;if(h&&ek(n)){const e=async()=>{try{await QC(u,p,h)}catch(e){s.vF.error("Failed to start livestream",e);const t=e instanceof Error?e.message:(0,c._t)("widget|error_unable_start_audio_stream_description");R.Ay.createDialog(Ht.A,{title:(0,c._t)("widget|error_unable_start_audio_stream_title"),description:t})}t()};f=o.createElement(Qa.R$,{onClick:e,label:(0,c._t)("widget|context_menu|start_audio_stream")})}if(tk(n,g)){const e=()=>{a?a():m&&iC.A.editWidget(m,n),t()};y=o.createElement(Qa.R$,{onClick:e,label:(0,c._t)("action|edit")})}if(rk(p)){const e=()=>{null==p||p.takeScreenshot().then(e=>{x.A.dispatch({action:"picture_snapshot",file:e.screenshot})}).catch(e=>{s.vF.error("Failed to take screenshot: ",e)}),t()};b=o.createElement(Qa.R$,{onClick:e,label:(0,c._t)("widget|context_menu|screenshot")})}if(ik(g,r)){const e=()=>{if(r)r();else if(h){const{finished:e}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("widget|context_menu|delete"),description:(0,c._t)("widget|context_menu|delete_warning"),button:(0,c._t)("widget|context_menu|delete")});e.then(([e])=>{e&&iC.A.setRoomWidget(u,h,n.id)})}t()};E=o.createElement(Qa.R$,{onClick:e,label:i?(0,c._t)("action|remove"):(0,c._t)("widget|context_menu|remove")})}if(nk(u,h,n,i)){const e={approved:void 0};if(_.r.instance.invoke(oC.Z.PreLoadRequest,e,new $C(n)),!e.approved){const e=()=>{const e=(0,WC.Sw)(n)?n.eventId:void 0;s.vF.info("Revoking permission for widget to load: "+e);const i=O.A.getValue("allowedWidgets",h);void 0!==e&&(i[e]=!1);const r=O.A.firstSupportedLevel("allowedWidgets");if(!r)throw new Error("level must be defined");O.A.setValue("allowedWidgets",null!=h?h:null,r,i).catch(e=>{s.vF.error(e)}),t()};w=o.createElement(Qa.R$,{onClick:e,label:(0,c._t)("widget|context_menu|revoke")})}}const[S,A]=ok(n,m,l);let C,k;if(S){const e=()=>{if(!m)throw new Error("room must be defined");YC.aK.instance.moveWithinContainer(m,YC.mc.Top,n,-1),t()};C=o.createElement(Qa.R$,{onClick:e,label:(0,c._t)("widget|context_menu|move_left")})}if(A){const e=()=>{if(!m)throw new Error("room must be defined");YC.aK.instance.moveWithinContainer(m,YC.mc.Top,n,1),t()};k=o.createElement(Qa.R$,{onClick:e,label:(0,c._t)("widget|context_menu|move_right")})}return o.createElement(Qa.Ay,(0,tn.A)({},d,{chevronFace:Nn.t4.None,onFinished:t}),o.createElement(Qa.tx,null,f,y,w,E,b,C,k))},lk=["app","className","size"],ck=e=>{let{app:t,className:i,size:r="20px"}=e,s=(0,v.A)(e,lk),a=[n("./res/img/element-icons/room/default_app.svg").A];return t.type.includes("jitsi")?a=[n("./res/img/element-icons/room/default_video.svg").A]:t.type.includes("meeting")||t.type.includes("calendar")?a=[n("./res/img/element-icons/room/default_cal.svg").A]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?a=[n("./res/img/element-icons/room/default_doc.svg").A]:t.type.includes("clock")&&(a=[n("./res/img/element-icons/room/default_clock.svg").A]),o.createElement(Xp.A,(0,tn.A)({},s,{name:t.id,className:me()("mx_WidgetAvatar",i),url:(0,WC.Sw)(t)&&t.avatar_url?(0,Vi.mediaFromMxc)(t.avatar_url).getSquareThumbnailHttp(20):null,urls:a,size:r}))};var dk=n("./res/img/external-link.svg");function uk(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function mk(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?uk(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uk(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class hk extends o.Component{constructor(e,t){super(e,t),(0,S.A)(this,"contextMenuButton",(0,o.createRef)()),(0,S.A)(this,"iframeParent",null),(0,S.A)(this,"allowedWidgetsWatchRef",void 0),(0,S.A)(this,"persistKey",void 0),(0,S.A)(this,"sgWidget",void 0),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"watchUserReady",()=>{Yp.V.instance.isProfileInfoFetched||Yp.V.instance.once(ha.H,this.onUserReady)}),(0,S.A)(this,"onUserReady",()=>{this.setState({isUserProfileReady:!0})}),(0,S.A)(this,"hasPermissionToLoad",e=>{var t;if(this.usingLocalWidget())return!0;if(!e.room)return!0;const n={approved:void 0};if(_.r.instance.invoke(oC.Z.PreLoadRequest,n,new $C(this.props.app)),n.approved)return!0;const i=O.A.getValue("allowedWidgets",e.room.roomId);return(0,WC.Sw)(e.app)&&void 0!==e.app.eventId&&null!==(t=i[e.app.eventId])&&void 0!==t&&t||e.userId===e.creatorUserId}),(0,S.A)(this,"onMyMembership",(e,t)=>{var n;t!==Xt.O.Leave&&t!==Xt.O.Ban||e.roomId!==(null===(n=this.props.room)||void 0===n?void 0:n.roomId)||this.onUserLeftRoom()}),(0,S.A)(this,"onAllowedWidgetsChange",()=>{const e=this.hasPermissionToLoad(this.props);var t;this.state.hasPermissionToLoad&&!e&&(I.A.instance.destroyPersistentWidget(this.props.app.id,(0,WC.Sw)(this.props.app)?this.props.app.roomId:null),_C.destroyElement(this.persistKey),null===(t=this.sgWidget)||void 0===t||t.stopMessaging());this.setState({hasPermissionToLoad:e})}),(0,S.A)(this,"iframeParentRef",e=>{var t;this.unmounted||(null===(t=this.iframeParent)||void 0===t||null===(t=t.querySelector("iframe"))||void 0===t||t.remove(),this.iframeParent=e,e&&this.sgWidget?this.startMessaging():this.resetWidget(this.props))}),(0,S.A)(this,"onWidgetReady",()=>{this.setState({loading:!1})}),(0,S.A)(this,"updateRequiresClient",()=>{var e;this.setState({requiresClient:!(null===(e=this.sgWidget)||void 0===e||null===(e=e.widgetApi)||void 0===e||!e.hasCapability(wC.RequiresClient))})}),(0,S.A)(this,"onAction",e=>{var t,n;switch(e.action){case"m.sticker":e.widgetId===this.props.app.id&&null!==(t=this.sgWidget)&&void 0!==t&&null!==(t=t.widgetApi)&&void 0!==t&&t.hasCapability(rC.MatrixCapabilities.StickerSending)?(x.A.dispatch({action:"post_sticker_message",data:mk(mk({},e.data),{},{threadId:this.props.threadId})}),x.A.dispatch({action:"stickerpicker_close"})):s.vF.warn("Ignoring sticker message. Invalid capability");break;case W.r.AfterLeaveRoom:e.room_id===(null===(n=this.props.room)||void 0===n?void 0:n.roomId)&&this.onUserLeftRoom()}}),(0,S.A)(this,"grantWidgetPermission",()=>{var e;const t=null===(e=this.props.room)||void 0===e?void 0:e.roomId,n=(0,WC.Sw)(this.props.app)?this.props.app.eventId:void 0;s.vF.info("Granting permission for widget to load: "+n);const i=O.A.getValue("allowedWidgets",t);void 0!==n&&(i[n]=!0);const r=O.A.firstSupportedLevel("allowedWidgets");O.A.setValue("allowedWidgets",null!=t?t:null,r,i).then(()=>{this.setState({hasPermissionToLoad:!0}),this.startWidget()}).catch(e=>{s.vF.error(e)})}),(0,S.A)(this,"onPopoutWidgetClick",()=>{var e;yC.x.JITSI.matches(this.props.app.type)&&this.reload(),Object.assign(document.createElement("a"),{target:"_blank",href:null===(e=this.sgWidget)||void 0===e?void 0:e.popoutUrl,rel:"noreferrer noopener"}).click()}),(0,S.A)(this,"onToggleMaximisedClick",()=>{if(!this.props.room)return;const e=YC.aK.instance.isInContainer(this.props.room,this.props.app,YC.mc.Center)?YC.mc.Top:YC.mc.Center;YC.aK.instance.moveToContainer(this.props.room,this.props.app,e),e===YC.mc.Top&&this.closeChatCardIfNeeded()}),(0,S.A)(this,"onMinimiseClicked",()=>{this.props.room&&(YC.aK.instance.moveToContainer(this.props.room,this.props.app,YC.mc.Right),this.closeChatCardIfNeeded())}),(0,S.A)(this,"closeChatCardIfNeeded",()=>{this.props.room&&lg.A.instance.currentCardForRoom(this.props.room.roomId).phase===cg.n.Timeline&&lg.A.instance.popCard(this.props.room.roomId)}),(0,S.A)(this,"onContextMenuClick",()=>{this.setState({menuDisplayed:!0})}),(0,S.A)(this,"closeContextMenu",()=>{this.setState({menuDisplayed:!1})}),this.persistKey="widget_"+iC.A.getWidgetUid(this.props.app);try{this.sgWidget=new JC(this.props)}catch(e){s.vF.log("Failed to construct widget",e),this.sgWidget=void 0}this.state=this.getNewState(e)}onUserLeftRoom(){I.A.instance.getWidgetPersistence(this.props.app.id,(0,WC.Sw)(this.props.app)?this.props.app.roomId:null)&&(this.props.room&&as.M.instance.roomViewStore.getRoomId()!==this.props.room.roomId?this.endWidgetActions():yC.x.JITSI.matches(this.props.app.type)?this.reload():I.A.instance.destroyPersistentWidget(this.props.app.id,(0,WC.Sw)(this.props.app)?this.props.app.roomId:null))}determineInitialRequiresClientState(){try{var e;const t=new $C(this.props.app),n=MC.c.instance.getMessaging(t,null===(e=this.props.room)||void 0===e?void 0:e.roomId);if(n)return n.hasCapability(wC.RequiresClient)}catch{}return!0}getNewState(e){return{initialising:!0,loading:!this.props.waitForIframeLoad&&!_C.isMounted(this.persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),isUserProfileReady:Yp.V.instance.isProfileInfoFetched,error:null,menuDisplayed:!1,requiresClient:this.determineInitialRequiresClientState(),hasContextMenuOptions:sk(this.context,this.props.room,e.app,e.userWidget,!e.userWidget,e.onDeleteClick)}}isMixedContent(){const e=window.location.protocol,t=(0,mC.Dl)(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(s.vF.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.unmounted=!1,this.props.miniMode||I.A.instance.dockWidget(this.props.app.id,(0,WC.Sw)(this.props.app)?this.props.app.roomId:null),this.sgWidget&&this.setupSgListeners(),this.sgWidget&&this.state.hasPermissionToLoad&&this.startWidget(),this.watchUserReady(),this.props.room&&this.context.on(i.RoomEvent.MyMembership,this.onMyMembership),this.allowedWidgetsWatchRef=O.A.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange),this.dispatcherRef=x.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,this.props.miniMode||I.A.instance.undockWidget(this.props.app.id,(0,WC.Sw)(this.props.app)?this.props.app.roomId:null),I.A.instance.isLive(this.props.app.id,(0,WC.Sw)(this.props.app)?this.props.app.roomId:null)||this.endWidgetActions(),x.A.unregister(this.dispatcherRef),this.props.room&&this.context.off(i.RoomEvent.MyMembership,this.onMyMembership),O.A.unwatchSetting(this.allowedWidgetsWatchRef),Yp.V.instance.removeListener(ha.H,this.onUserReady)}setupSgListeners(){var e,t,n;null===(e=this.sgWidget)||void 0===e||e.on("ready",this.onWidgetReady),null===(t=this.sgWidget)||void 0===t||t.on("error:preparing",this.updateRequiresClient),null===(n=this.sgWidget)||void 0===n||n.on("capabilitiesNotified",this.updateRequiresClient)}stopSgListeners(){var e;this.sgWidget&&(null===(e=this.sgWidget)||void 0===e||e.off("ready",this.onWidgetReady),this.sgWidget.off("error:preparing",this.updateRequiresClient),this.sgWidget.off("capabilitiesNotified",this.updateRequiresClient))}resetWidget(e){var t;null===(t=this.sgWidget)||void 0===t||t.stopMessaging(),this.stopSgListeners();try{this.sgWidget=new JC(e),this.setupSgListeners(),this.startWidget()}catch(e){s.vF.error("Failed to construct widget",e),this.sgWidget=void 0}}startWidget(){var e;null===(e=this.sgWidget)||void 0===e||e.prepare().then(()=>{this.unmounted||this.setState({initialising:!1})})}startMessaging(){const e=document.createElement("iframe");e.title=iC.A.getWidgetName(this.props.app),e.allow="microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write; clipboard-read;",e.src=this.sgWidget.embedUrl,e.allowFullscreen=!0,e.sandbox="allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation allow-downloads",this.iframeParent.appendChild(e),requestAnimationFrame(()=>{if(null!==e.parentElement)try{var t;null===(t=this.sgWidget)||void 0===t||t.startMessaging(e)}catch(e){s.vF.error("Failed to start widget",e)}})}componentDidUpdate(e){e.app.url!==this.props.app.url&&(this.getNewState(this.props),this.state.hasPermissionToLoad&&this.resetWidget(this.props))}endWidgetActions(){var e;yC.x.JITSI.matches(this.props.app.type)&&this.props.room&&jt.Ay.instance.hangupCallApp(this.props.room.roomId),_C.destroyElement(this.persistKey),I.A.instance.destroyPersistentWidget(this.props.app.id,(0,WC.Sw)(this.props.app)?this.props.app.roomId:null),null===(e=this.sgWidget)||void 0===e||e.stopMessaging({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}usingLocalWidget(){return yC.x.JITSI.matches(this.props.app.type)}getTileTitle(){const e=this.formatAppTileName(),t=o.createElement("span",null,"-");let n="";return this.props.widgetPageTitle&&this.props.widgetPageTitle!==this.formatAppTileName()&&(n=this.props.widgetPageTitle),o.createElement("span",null,o.createElement(ck,{app:this.props.app,size:"20px"}),o.createElement("h3",null,e),o.createElement("span",null,n?t:"",n))}reload(){var e;this.endWidgetActions(),this.resetWidget(this.props),null===(e=this.iframeParent)||void 0===e||null===(e=e.querySelector("iframe"))||void 0===e||e.remove(),this.startMessaging()}render(){let e;const t=me()({mx_AppTileBody:!0,"mx_AppTileBody--large":!this.props.miniMode,"mx_AppTileBody--mini":this.props.miniMode,"mx_AppTileBody--loading":this.state.loading,"mx_AppTileBody--call":this.props.app.type===yC.x.CALL.preferred}),n={};this.props.pointerEvents&&(n.pointerEvents=this.props.pointerEvents);const i=o.createElement("div",{className:"mx_AppTileBody_fadeInSpinner"},o.createElement(le.A,{message:(0,c._t)("common|loading")}));if(null===this.sgWidget)e=o.createElement("div",{className:t,style:n},o.createElement(vC,{errorMsg:(0,c._t)("widget|error_loading")}));else if(!this.state.hasPermissionToLoad&&this.props.room&&this.sgWidget){const i=this.context.isRoomEncrypted(this.props.room.roomId);e=o.createElement("div",{className:t,style:n},o.createElement(pC,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.sgWidget.embedUrl,isRoomEncrypted:i,onPermissionGranted:this.grantWidgetPermission}))}else if(this.state.initialising||!this.state.isUserProfileReady)e=o.createElement("div",{className:t,style:n},i);else if(this.isMixedContent())e=o.createElement("div",{className:t,style:n},o.createElement(vC,{errorMsg:(0,c._t)("widget|error_mixed_content")}));else if(this.sgWidget&&(e=o.createElement(o.Fragment,null,o.createElement("div",{className:t,style:n,ref:this.iframeParentRef},this.state.loading&&i),this.props.overlay),!this.props.userWidget)){const t=101;e=o.createElement("div",{className:"mx_AppTile_persistedWrapper"},o.createElement(_C,{zIndex:this.props.miniMode?t:9,persistKey:this.persistKey,moveRef:this.props.movePersistedElement},e))}let r,s;r=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},r=me()(r),this.state.menuDisplayed&&(s=o.createElement(ak,(0,tn.A)({},(0,Nn.qv)(this.contextMenuButton.current.getBoundingClientRect()),{app:this.props.app,onFinished:this.closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick})));const a=[];if(this.props.showLayoutButtons){const e=this.props.room&&YC.aK.instance.isInContainer(this.props.room,this.props.app,YC.mc.Center);a.push(o.createElement(ae.A,{key:"toggleMaximised",className:"mx_AppTileMenuBar_widgets_button",title:e?(0,c._t)("widget|unmaximise"):(0,c._t)("action|maximise"),onClick:this.onToggleMaximisedClick},e?o.createElement(sC.A,{className:"mx_Icon mx_Icon_12"}):o.createElement(aC.A,{className:"mx_Icon mx_Icon_12"}))),a.push(o.createElement(ae.A,{key:"minimise",className:"mx_AppTileMenuBar_widgets_button",title:(0,c._t)("action|minimise"),onClick:this.onMinimiseClicked},o.createElement(lC.A,{className:"mx_Icon mx_Icon_16"})))}return o.createElement(o.Fragment,null,o.createElement("div",{className:r,id:this.props.app.id},this.props.showMenubar&&o.createElement("div",{className:"mx_AppTileMenuBar"},o.createElement("span",{className:"mx_AppTileMenuBar_title",style:{pointerEvents:this.props.handleMinimisePointerEvents?"all":"none"}},this.props.showTitle&&this.getTileTitle()),o.createElement("span",{className:"mx_AppTileMenuBar_widgets"},a,this.props.showPopout&&!this.state.requiresClient&&o.createElement(ae.A,{className:"mx_AppTileMenuBar_widgets_button",title:(0,c._t)("widget|popout"),onClick:this.onPopoutWidgetClick},o.createElement(dk.I,{className:"mx_Icon mx_Icon_12 mx_Icon--stroke"})),this.state.hasContextMenuOptions&&o.createElement(Nn.VJ,{className:"mx_AppTileMenuBar_widgets_button",label:(0,c._t)("common|options"),isExpanded:this.state.menuDisplayed,ref:this.contextMenuButton,onClick:this.onContextMenuClick},o.createElement(Un,{className:"mx_Icon mx_Icon_12"})))),e),s)}}(0,S.A)(hk,"contextType",ce.Ay),(0,S.A)(hk,"defaultProps",{waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1,threadId:null,showLayoutButtons:!0});const pk=({room:e,widgetId:t,onClose:n})=>{const i=(0,o.useContext)(ce.Ay),r=(0,iC.X)(e).find(e=>e.id===t),s=r&&YC.aK.instance.isInContainer(e,r,YC.mc.Right),[a,l,d,u]=(0,Nn.EF)();if((0,o.useEffect)(()=>{r&&s||lg.A.instance.popCard()},[r,s]),!r||!s)return null;let m;if(a){var h;const e=null===(h=l.current)||void 0===h?void 0:h.getBoundingClientRect(),t=e?e.right:0,n=e?e.bottom:0;m=o.createElement(ak,{chevronFace:Nn.t4.None,right:Ja.A.instance.windowWidth-t-12,top:n+12,onFinished:u,app:r})}const p=o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(uC.A,{size:"4",className:"mx_BaseCard_header_title_heading"},iC.A.getWidgetName(r)),o.createElement(Nn.VJ,{className:"mx_BaseCard_header_title_button--option",ref:l,onClick:d,isExpanded:a,label:(0,c._t)("common|options")}),m);return o.createElement(KS.A,{header:p,className:"mx_WidgetCard",onClose:n,withoutScrollContainer:!0},o.createElement(hk,{app:r,fullWidth:!0,showMenubar:!1,room:e,userId:i.getSafeUserId(),creatorUserId:r.creatorUserId,widgetPageTitle:iC.A.getWidgetDataTitle(r),waitForIframeLoad:r.waitForIframeLoad}))};var gk=n("./src/components/views/right_panel/UserInfo.tsx");class vk extends o.Component{constructor(e){var t,n,r,o;super(e),(0,S.A)(this,"room",void 0),(0,S.A)(this,"onRoomStateEvents",e=>{if(e.getType()===i.EventType.RoomThirdPartyInvite&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,n={invited:(0,da.Qo)(e)};t&&(n.displayName=t),this.setState(n)}}),(0,S.A)(this,"onCancel",()=>{x.A.dispatch({action:W.r.View3pidInvite,event:null})}),(0,S.A)(this,"onKickClick",()=>{f.J.safeGet().sendStateEvent(this.state.roomId,i.EventType.RoomThirdPartyInvite,{},this.state.stateKey).catch(e=>{s.vF.error(e),this.setState({invited:!0}),R.Ay.createDialog(Ht.A,{title:(0,c._t)("user_info|error_revoke_3pid_invite_title"),description:(0,c._t)("user_info|error_revoke_3pid_invite_description")})}),this.setState({invited:!1})}),this.room=f.J.safeGet().getRoom(this.props.event.getRoomId());const a=null===(t=this.room)||void 0===t?void 0:t.getMember(f.J.safeGet().getSafeUserId()),l=null===(n=this.room)||void 0===n?void 0:n.currentState.getStateEvents("m.room.power_levels",""),d=this.props.event.getSender();let u=l?l.getContent().kick:50;"number"!=typeof u&&(u=50);const m=null===(r=this.room)||void 0===r?void 0:r.getMember(d);this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!a&&a.powerLevel>u,senderName:null!==(o=null==m?void 0:m.name)&&void 0!==o?o:d}}componentDidMount(){f.J.safeGet().on(i.RoomStateEvent.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=f.J.get();e&&e.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents)}render(){let e;return this.state.canKick&&this.state.invited&&(e=o.createElement(Fe.s,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},o.createElement(og.E,{as:"span",role:"heading",size:"lg",weight:"semibold"},(0,c._t)("user_info|admin_tools_section")),o.createElement(Ae.$,{size:"sm",kind:"destructive",className:"mx_MemberInfo_field",onClick:this.onKickClick},(0,c._t)("user_info|revoke_invite")))),o.createElement(KS.A,{onClose:this.props.onClose,header:(0,c._t)("common|profile")},o.createElement(Fe.s,{className:"mx_ThirdPartyMemberInfo",direction:"column",gap:"var(--cpd-space-4x)"},o.createElement(Fe.s,{direction:"column",as:"section",justify:"start",gap:"var(--cpd-space-2x)"},o.createElement(og.E,{as:"span",role:"heading",size:"lg",weight:"semibold"},this.state.displayName),o.createElement(og.E,{as:"span"},(0,c._t)("user_info|invited_by",{sender:this.state.senderName}))),e))}}let fk=function(e){return e[e.Files=0]="Files",e[e.Search=1]="Search",e}({});function _k({isRoomEncrypted:e,kind:t,showLogo:n=!0}){if(!e)return o.createElement(o.Fragment,null);if(y.A.get())return o.createElement(o.Fragment,null);if(y.A.error)return o.createElement("div",{className:"mx_SearchWarning"},(0,c._t)("seshat|error_initialising",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:e=>{e.preventDefault(),x.A.dispatch({action:W.r.ViewUserSettings,initialTabId:We.v.Security})}},e)}));const i=d.Ay.get("brand"),r=d.Ay.getObject("desktop_builds");let a,l;if(null!=r&&r.get("available")){l=o.createElement("img",{alt:"",src:r.get("logo"),width:"32px"});const e=r.get("url");switch(t){case fk.Files:a=(0,c._t)("seshat|warning_kind_files_app",{},{a:t=>o.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)});break;case fk.Search:a=(0,c._t)("seshat|warning_kind_search_app",{},{a:t=>o.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)})}}else switch(t){case fk.Files:a=(0,c._t)("seshat|warning_kind_files",{brand:i});break;case fk.Search:a=(0,c._t)("seshat|warning_kind_search",{brand:i})}return a?o.createElement("div",{className:"mx_SearchWarning"},n?l:null,o.createElement("span",null,a)):(s.vF.warn("Unknown desktop builds warning kind: ",t),o.createElement(o.Fragment,null))}var yk=n("./src/components/structures/LegacyCallEventGrouper.ts");const bk=(...e)=>{O.A.getValue("debug_timeline_panel")&&s.vF.log.call(console,"TimelinePanel debuglog:",...e)};class Ek extends o.Component{constructor(e,t){if(super(e,t),(0,S.A)(this,"lastRRSentEventId",void 0),(0,S.A)(this,"lastRMSentEventId",void 0),(0,S.A)(this,"messagePanel",(0,o.createRef)()),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"timelineWindow",void 0),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"readReceiptActivityTimer",null),(0,S.A)(this,"readMarkerActivityTimer",null),(0,S.A)(this,"callEventGroupers",new Map),(0,S.A)(this,"initialReadMarkerId",null),(0,S.A)(this,"onDumpDebugLogs",()=>{var e,t,n,r,o,a;const l=null===(e=this.props.timelineSet)||void 0===e?void 0:e.room,c=null===(t=this.state)||void 0===t||null===(t=t.events)||void 0===t?void 0:t.map(e=>e.getId());let d,u,m;try{const e=this.messagePanelDiv;if(e){d=[...e.querySelectorAll("[data-event-id]")].map(e=>e.getAttribute("data-event-id"))}}catch(e){s.vF.error("onDumpDebugLogs: Failed to get the actual event ID's in the DOM",e)}const h={};if(l){const e=l.getTimelineSets(),t=l.threadsTimelineSets;try{u=wk(e),m=wk(t)}catch(e){s.vF.error("onDumpDebugLogs: Failed to serialize event IDs from timelinesets",e)}try{l.getThreads().forEach(e=>{var t,n;h[e.id]={events:e.events.map(e=>e.getId()),numTimelines:e.timelineSet.getTimelines().length,liveTimeline:e.timelineSet.getLiveTimeline().getEvents().length,prevTimeline:null===(t=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(i.Direction.Backward))||void 0===t?void 0:t.getEvents().length,nextTimeline:null===(n=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(i.Direction.Forward))||void 0===n?void 0:n.getEvents().length}})}catch(e){s.vF.error("onDumpDebugLogs: Failed to serialize event IDs from the threads",e)}}let p,g;try{var v;p=null===(v=this.timelineWindow)||void 0===v?void 0:v.getEvents().map(e=>e.getId())}catch(e){s.vF.error("onDumpDebugLogs: Failed to get event IDs from the timelineWindow",e)}try{g=this.props.timelineSet.getPendingEvents().map(e=>e.getId())}catch(e){s.vF.error("onDumpDebugLogs: Failed to get pending event IDs",e)}s.vF.debug(`TimelinePanel(${this.context.timelineRenderingType}): Debugging info for ${null==l?void 0:l.roomId}\n\tevents(${c.length})=${JSON.stringify(c)}\n\trenderedEventIds(${null!==(n=null===(r=d)||void 0===r?void 0:r.length)&&void 0!==n?n:0})=${JSON.stringify(d)}\n\tserializedEventIdsFromTimelineSets=${JSON.stringify(u)}\n\tserializedEventIdsFromThreadsTimelineSets=${JSON.stringify(m)}\n\tserializedThreadsMap=${JSON.stringify(h)}\n\ttimelineWindowEventIds(${null===(o=p)||void 0===o?void 0:o.length})=${JSON.stringify(p)}\n\tpendingEventIds(${null===(a=g)||void 0===a?void 0:a.length})=${JSON.stringify(g)}`)}),(0,S.A)(this,"onMessageListUnfillRequest",(e,t)=>{const n=e?i.EventTimeline.BACKWARDS:i.EventTimeline.FORWARDS;bk("unpaginating events in direction",n);const r=t,o=this.timelineWindow.getEvents(),s=o.findIndex(e=>e.getId()===r);let a;a=-1===s?0:e?s+1:o.length-s,a>0&&(bk("Unpaginating",a,"in direction",n),this.timelineWindow.unpaginate(a,e));const{events:l,liveEvents:c}=this.getEvents();this.buildLegacyCallEventGroupers(l),this.setState({events:l,liveEvents:c}),e?this.setState({canBackPaginate:!0}):this.setState({canForwardPaginate:!0})}),(0,S.A)(this,"onPaginationRequest",(e,t,n)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,n):e.paginate(t,n)),(0,S.A)(this,"onMessageListFillRequest",e=>{var t;if(!this.shouldPaginate())return Promise.resolve(!1);const n=e?i.EventTimeline.BACKWARDS:i.EventTimeline.FORWARDS,r=e?"canBackPaginate":"canForwardPaginate",o=e?"backPaginating":"forwardPaginating";return this.state[r]?null!==(t=this.timelineWindow)&&void 0!==t&&t.canPaginate(n)?(bk("Initiating paginate; backwards:"+e),this.setState({[o]:!0}),this.onPaginationRequest(this.timelineWindow,n,50).then(async t=>{var n;if(this.unmounted)return!1;bk("paginate complete backwards:"+e+"; success:"+t);const{events:s,liveEvents:a}=this.getEvents();this.buildLegacyCallEventGroupers(s);const l={[o]:!1,[r]:t,events:s,liveEvents:a},c=e?i.EventTimeline.FORWARDS:i.EventTimeline.BACKWARDS,d=e?"canForwardPaginate":"canBackPaginate";return!this.state[d]&&null!==(n=this.timelineWindow)&&void 0!==n&&n.canPaginate(c)&&(bk("can now",c,"paginate again"),l[d]=!0),new Promise(e=>{this.setState(l,()=>{e(t)})})})):(bk("can't",n,"paginate any further"),this.setState({[r]:!1}),Promise.resolve(!1)):(bk("have given up",n,"paginating this timeline"),Promise.resolve(!1))}),(0,S.A)(this,"onMessageListScroll",e=>{var t,n;null===(t=(n=this.props).onScroll)||void 0===t||t.call(n,e),this.props.manageReadMarkers&&this.doManageReadMarkers()}),(0,S.A)(this,"doManageReadMarkers",(0,Li.debounce)(()=>{var e;const t=this.getReadMarkerPosition();if(null===t)return;t<0&&this.setState({readMarkerVisible:!0});const n=this.readMarkerTimeout(t);null===(e=this.readMarkerActivityTimer)||void 0===e||e.changeTimeout(n)},100,{leading:!1,trailing:!0})),(0,S.A)(this,"onAction",e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate();break;case W.r.DumpDebugLogs:this.onDumpDebugLogs()}}),(0,S.A)(this,"onRoomTimeline",(e,t,n,r,o)=>{var s,a;o.timeline.getTimelineSet()===this.props.timelineSet&&(i.Thread.hasServerSideSupport||this.context.timelineRenderingType!==kn.Ae.Thread||(n&&!this.state.canBackPaginate&&this.setState({canBackPaginate:!0}),n||this.state.canForwardPaginate||this.setState({canForwardPaginate:!0})),!n&&o&&o.liveEvent&&null!==(s=this.messagePanel.current)&&void 0!==s&&s.getScrollState()&&(null!==(a=this.messagePanel.current.getScrollState())&&void 0!==a&&a.stuckAtBottom?this.timelineWindow.paginate(i.EventTimeline.FORWARDS,1,!1).then(()=>{if(this.unmounted)return;const{events:t,liveEvents:n}=this.getEvents();this.buildLegacyCallEventGroupers(t);const i=n[n.length-1],r={events:t,liveEvents:n};let o=!1;if(this.props.manageReadMarkers){const t=f.J.safeGet().credentials.userId;if(o=!1,e.getSender()===t||w.A.sharedInstance().userActiveRecently()){if(i&&0===this.getReadMarkerPosition()){var s;this.setReadMarker(null!==(s=i.getId())&&void 0!==s?s:null,i.getTs(),!0),r.readMarkerVisible=!1,r.readMarkerEventId=i.getId(),o=!0}}else r.readMarkerVisible=!0}this.setState(r,()=>{var e,t,n;(null===(e=this.messagePanel.current)||void 0===e||e.updateTimelineMinHeight(),o)&&(null===(t=(n=this.props).onReadMarkerUpdated)||void 0===t||t.call(n))})}):this.setState({canForwardPaginate:!0})))}),(0,S.A)(this,"onRoomTimelineReset",(e,t)=>{t===this.props.timelineSet&&this.canResetTimeline()&&this.loadTimeline()}),(0,S.A)(this,"canResetTimeline",()=>{var e;return!0===(null===(e=this.messagePanel)||void 0===e||null===(e=e.current)||void 0===e?void 0:e.isAtBottom())}),(0,S.A)(this,"onRoomRedaction",(e,t)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.forceUpdate()}),(0,S.A)(this,"onThreadUpdate",e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.roomId))return;const n=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.id);n&&n.forceUpdate()}),(0,S.A)(this,"onEventVisibilityChange",e=>{var t;if(this.unmounted)return;if(!this.hasTimelineSetFor(e.getRoomId()))return;const n=null===(t=this.messagePanel.current)||void 0===t?void 0:t.getTileForEventId(e.getId());n&&n.forceUpdate()}),(0,S.A)(this,"onVisibilityPowerLevelChange",(e,t)=>{var n;if(!this.unmounted&&this.hasTimelineSetFor(t.roomId)&&t.userId==(null===(n=f.J.safeGet().credentials)||void 0===n?void 0:n.userId)){for(const e of this.state.events){var i;const t=null===(i=this.messagePanel.current)||void 0===i?void 0:i.getTileForEventId(e.getId());t&&t.forceUpdate()}this.forceUpdate()}}),(0,S.A)(this,"onEventReplaced",e=>{this.unmounted||this.hasTimelineSetFor(e.getRoomId())&&this.forceUpdate()}),(0,S.A)(this,"onRoomReceipt",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),(0,S.A)(this,"onLocalEchoUpdated",(e,t,n)=>{this.unmounted||this.hasTimelineSetFor(t.roomId)&&this.reloadEvents()}),(0,S.A)(this,"onAccountData",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&e.getType()===i.EventType.FullyRead&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)}),(0,S.A)(this,"onEventDecrypted",e=>{this.props.timelineSet.room&&this.hasTimelineSetFor(e.getRoomId())&&this.state.events.includes(e)&&(this.buildLegacyCallEventGroupers(this.state.events),this.forceUpdate())}),(0,S.A)(this,"onSync",(e,t,n)=>{this.unmounted||this.setState({clientSyncState:e})}),(0,S.A)(this,"sendReadReceipts",async()=>{var e,t;if(O.A.getValue("lowBandwidth"))return;if(!this.messagePanel.current)return;if(!this.props.manageReadReceipts)return;const n=f.J.get();if(!n||n.isGuest())return;const i=this.getCurrentReadReceipt(!0),r=this.indexForEventId(i),o=this.getLastDisplayedEventIndex({ignoreOwn:!0}),s=null!==(e=this.state.events[null!=o?o:this.state.events.length-1])&&void 0!==e?e:null,a=this.shouldSendReadReceipt(i,r,s,o),l=this.state.readMarkerEventId,c=this.shouldSendFullyReadMarker(l),d=null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId;bk(`Sending Read Markers for ${d}: `,{shouldSendReadReceipt:a,shouldSendFullyReadMarker:c,currentReadReceiptEventId:i,currentReadReceiptEventIndex:r,lastReadEventId:null==s?void 0:s.getId(),lastReadEventIndex:o,readMarkerEventId:this.state.readMarkerEventId});const u=[];if(a&&u.push(this.sendReadReceipt(n,s)),c){this.props.timelineSet.findEventById(l)&&u.push(this.sendFullyReadMarker(n,null!=d?d:"",l))}await Promise.all(u)}),(0,S.A)(this,"updateReadMarker",async()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this.getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];await this.setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),await this.sendReadReceipts()}),(0,S.A)(this,"jumpToLiveTimeline",()=>{var e,t;null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(i.EventTimeline.FORWARDS)?this.loadTimeline():null===(t=this.messagePanel.current)||void 0===t||t.scrollToBottom()}),(0,S.A)(this,"scrollToEventIfNeeded",e=>{var t;null===(t=this.messagePanel.current)||void 0===t||t.scrollToEventIfNeeded(e)}),(0,S.A)(this,"jumpToReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(!this.messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this.messagePanel.current.getReadMarkerPosition()?this.loadTimeline(this.state.readMarkerEventId,0,1/3):this.messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)}),(0,S.A)(this,"forgetReadMarker",async()=>{if(!this.props.manageReadMarkers)return;const e=this.getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(null!=e?e:"");let n;if(t){const i=t.getEvents().find(t=>t.getId()==e);i&&(n=i.getTs())}await this.setReadMarker(e,n),await this.sendReadReceipts()}),(0,S.A)(this,"isAtEndOfLiveTimeline",()=>{var e;return(null===(e=this.messagePanel.current)||void 0===e?void 0:e.isAtBottom())&&this.timelineWindow&&!this.timelineWindow.canPaginate(i.EventTimeline.FORWARDS)}),(0,S.A)(this,"getScrollState",()=>this.messagePanel.current?this.messagePanel.current.getScrollState():null),(0,S.A)(this,"getReadMarkerPosition",()=>{if(!this.props.manageReadMarkers)return null;if(!this.messagePanel.current)return null;if(!this.props.timelineSet.room)return null;const e=this.messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=Ek.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null}),(0,S.A)(this,"canJumpToReadMarker",()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(null===e||e<0)}),(0,S.A)(this,"handleScrollKey",e=>{if(!this.messagePanel.current)return;(0,uo.zM)().getRoomAction(e)===Ei.bY.JumpToLatestMessage?this.jumpToLiveTimeline():this.messagePanel.current.handleScrollKey(e)}),(0,S.A)(this,"getRelationsForEvent",(e,t,n)=>{var i;return null===(i=this.props.timelineSet.relations)||void 0===i?void 0:i.getChildEventsForEvent(e,t,n)}),bk("mounting"),this.props.manageReadMarkers){var n;const e=null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.getAccountData("m.fully_read");this.initialReadMarkerId=e?e.getContent().event_id:this.getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:this.initialReadMarkerId,backPaginating:!1,forwardPaginating:!1,clientSyncState:f.J.safeGet().getSyncState(),isTwelveHour:O.A.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:O.A.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:O.A.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:O.A.getValue("readMarkerOutOfViewThresholdMs")}}componentDidMount(){var e;this.unmounted=!1,this.dispatcherRef=x.A.register(this.onAction);const t=f.J.safeGet();t.on(i.RoomEvent.Timeline,this.onRoomTimeline),t.on(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),t.on(i.RoomEvent.Redaction,this.onRoomRedaction),O.A.getValue("feature_msc3531_hide_messages_pending_moderation")&&(t.on(i.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),t.on(i.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange)),t.on(i.RoomEvent.RedactionCancelled,this.onRoomRedaction),t.on(i.RoomEvent.Receipt,this.onRoomReceipt),t.on(i.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),t.on(i.RoomEvent.AccountData,this.onAccountData),t.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),t.on(i.MatrixEventEvent.Replaced,this.onEventReplaced),t.on(i.ClientEvent.Sync,this.onSync),null===(e=this.props.timelineSet.room)||void 0===e||e.on(i.ThreadEvent.Update,this.onThreadUpdate),this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this.initTimeline(this.props)}componentDidUpdate(e){var t,n;e.timelineSet!==this.props.timelineSet&&s.vF.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue"),null===(t=this.props.timelineSet.room)||void 0===t||t.off(i.ThreadEvent.Update,this.onThreadUpdate),null===(n=this.props.timelineSet.room)||void 0===n||n.on(i.ThreadEvent.Update,this.onThreadUpdate);const r=e.eventId!=this.props.eventId,o=e.highlightedEventId!=this.props.highlightedEventId,a=e.eventScrollIntoView&&!this.props.eventScrollIntoView;(r||o||a)&&(s.vF.log(`TimelinePanel switching to eventId ${this.props.eventId} (was ${e.eventId}), scrollIntoView: ${this.props.eventScrollIntoView} (was ${e.eventScrollIntoView})`),this.initTimeline(this.props))}componentWillUnmount(){this.unmounted=!0,this.readReceiptActivityTimer&&(this.readReceiptActivityTimer.abort(),this.readReceiptActivityTimer=null),this.readMarkerActivityTimer&&(this.readMarkerActivityTimer.abort(),this.readMarkerActivityTimer=null),x.A.unregister(this.dispatcherRef);const e=f.J.get();var t;e&&(e.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),e.removeListener(i.RoomEvent.Redaction,this.onRoomRedaction),e.removeListener(i.RoomEvent.RedactionCancelled,this.onRoomRedaction),e.removeListener(i.RoomEvent.Receipt,this.onRoomReceipt),e.removeListener(i.RoomEvent.LocalEchoUpdated,this.onLocalEchoUpdated),e.removeListener(i.RoomEvent.AccountData,this.onAccountData),e.removeListener(i.RoomMemberEvent.PowerLevel,this.onVisibilityPowerLevelChange),e.removeListener(i.MatrixEventEvent.Decrypted,this.onEventDecrypted),e.removeListener(i.MatrixEventEvent.Replaced,this.onEventReplaced),e.removeListener(i.MatrixEventEvent.VisibilityChange,this.onEventVisibilityChange),e.removeListener(i.ClientEvent.Sync,this.onSync),null===(t=this.props.timelineSet.room)||void 0===t||t.removeListener(i.ThreadEvent.Update,this.onThreadUpdate))}get messagePanelDiv(){var e,t;return null!==(e=null===(t=this.messagePanel.current)||void 0===t||null===(t=t.scrollPanel.current)||void 0===t?void 0:t.divScroll)&&void 0!==e?e:null}hasTimelineSetFor(e){var t;return void 0!==e&&e===(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId)}readMarkerTimeout(e){var t,n,i,r;return 0===e?null!==(t=null===(n=this.context)||void 0===n?void 0:n.readMarkerInViewThresholdMs)&&void 0!==t?t:this.state.readMarkerInViewThresholdMs:null!==(i=null===(r=this.context)||void 0===r?void 0:r.readMarkerOutOfViewThresholdMs)&&void 0!==i?i:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this.readMarkerTimeout(this.getReadMarkerPosition());for(this.readMarkerActivityTimer=new A.A(e);this.readMarkerActivityTimer;){w.A.sharedInstance().timeWhileActiveRecently(this.readMarkerActivityTimer);try{await this.readMarkerActivityTimer.finished()}catch{continue}await this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this.readReceiptActivityTimer=new A.A(500);this.readReceiptActivityTimer;){w.A.sharedInstance().timeWhileActiveNow(this.readReceiptActivityTimer);try{await this.readReceiptActivityTimer.finished()}catch{continue}await this.sendReadReceipts()}}async determineReceiptType(e){var t,n;const r=null!==(t=null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId)&&void 0!==t?t:null;return O.A.getValue("sendReadReceipts",r)?i.ReceiptType.Read:await e.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await e.isVersionSupported("v1.4")?i.ReceiptType.ReadPrivate:(s.vF.warn("Falling back to public instead of private receipts because the homeserver does not support them"),i.ReceiptType.Read)}shouldSendFullyReadMarker(e){return!!this.state.readMarkerEventId&&((!this.lastRMSentEventId||this.lastRMSentEventId!==this.state.readMarkerEventId)&&((!this.state.readMarkerEventId||this.state.readMarkerEventId!==this.initialReadMarkerId)&&!this.props.timelineSet.thread))}shouldSendReadReceipt(e,t,n,r){var o;return!!n&&((!e||null!==t||null===(o=this.timelineWindow)||void 0===o||!o.canPaginate(i.EventTimeline.FORWARDS))&&((null===r||null===t||r>t)&&(!this.lastRRSentEventId||this.lastRRSentEventId!==(null==n?void 0:n.getId()))))}async sendReadReceipt(e,t){this.lastRRSentEventId=t.getId();const n=await this.determineReceiptType(e);try{await e.sendReadReceipt(t,n)}catch(e){var i;this.lastRRSentEventId=void 0,s.vF.error("Error sending receipt",{room:null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId,error:e})}}async sendFullyReadMarker(e,t,n){this.lastRMSentEventId=this.state.readMarkerEventId;try{await e.setRoomReadMarkers(t,n)}catch(e){this.lastRMSentEventId=void 0,s.vF.error("Error sending fully_read",{roomId:t,error:e})}}advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers||!this.timelineWindow)return;const e=this.timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const n=f.J.safeGet().credentials.userId;for(t++;t<e.length;t++){if(e[t].getSender()!==n)break}t--;const i=e[t];this.setReadMarker(i.getId(),i.getTs())}initTimeline(e){const t=e.eventId,n=e.eventPixelOffset;let i=1;return null==n&&(i=.5),this.loadTimeline(t,n,i,e.eventScrollIntoView)}scrollIntoView(e,t,n){var i,r;const o=()=>{this.messagePanel.current&&(e?(bk("TimelinePanel scrolling to eventId "+e+" at position "+100*n+"% + "+t),this.messagePanel.current.scrollToEvent(e,t,n)):(bk("TimelinePanel scrolling to bottom"),this.messagePanel.current.scrollToBottom()))};bk("TimelinePanel scheduling scroll to event"),null===(i=(r=this.props).onEventScrolledIntoView)||void 0===i||i.call(r,e),o(),window.requestAnimationFrame(()=>{o()})}loadTimeline(e,t,n,r=!0){const o=f.J.safeGet();this.timelineWindow=new i.TimelineWindow(o,this.props.timelineSet,{windowLimit:this.props.timelineCap});const a=()=>{var o,a,l,c,d;this.unmounted||(null===(o=this.messagePanel.current)||void 0===o||o.onTimelineReset(),this.reloadEvents(),this.advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:null!==(a=null===(l=this.timelineWindow)||void 0===l?void 0:l.canPaginate(i.EventTimeline.BACKWARDS))&&void 0!==a&&a,canForwardPaginate:null!==(c=null===(d=this.timelineWindow)||void 0===d?void 0:d.canPaginate(i.EventTimeline.FORWARDS))&&void 0!==c&&c,timelineLoading:!1},()=>{this.messagePanel.current?(r&&this.scrollIntoView(e,t,n),this.props.sendReadReceiptOnLoad&&this.sendReadReceipts().catch(e=>{s.vF.warn("Error sending receipts on load",e)})):s.vF.log("can't initialise scroll state because messagePanel didn't load")}))};if(this.props.timelineSet.getTimelineForEvent(e))return this.timelineWindow.load(e,30),void a();const l=this.timelineWindow.load(e,30);this.buildLegacyCallEventGroupers(),this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),l.then(a,t=>{var n;if(this.unmounted)return;let i,r;this.setState({timelineLoading:!1}),s.vF.error(`Error loading timeline panel at ${null===(n=this.props.timelineSet.room)||void 0===n?void 0:n.roomId}/${e}`,t),e&&this.props.timelineSet.room&&(i=()=>{x.A.dispatch({action:W.r.ViewRoom,room_id:this.props.timelineSet.room.roomId,metricsTrigger:void 0})}),r="M_FORBIDDEN"==t.errcode?(0,c._t)("timeline|load_error|no_permission"):(0,c._t)("timeline|load_error|unable_to_find");const{finished:o}=R.Ay.createDialog(Ht.A,{title:(0,c._t)("timeline|load_error|title"),description:r});i&&o.then(i)})}reloadEvents(){if(this.unmounted)return;const e=this.getEvents();this.buildLegacyCallEventGroupers(e.events),this.setState(e)}refreshTimeline(e){this.loadTimeline(e,void 0,void 0,!1),this.reloadEvents()}getEvents(){const e=this.timelineWindow.getEvents(),t=f.J.safeGet();for(let n=e.length-1;n>=0;--n)t.decryptEventIfNeeded(e[n]);const n=[...e];if(!this.timelineWindow.canPaginate(i.EventTimeline.FORWARDS)){const t=this.props.timelineSet.getPendingEvents();e.push(...t.filter(e=>{const{shouldLiveInRoom:n,threadId:i}=this.props.timelineSet.room.eventShouldLiveIn(e,t);return this.context.timelineRenderingType===kn.Ae.Thread?i===this.context.threadId:n}))}return{events:e,liveEvents:n}}indexForEventId(e){if(null===e)return null;if(this.context.timelineRenderingType===kn.Ae.Thread)return 0;const t=this.state.events.findIndex(t=>t.getId()===e);return t>-1?t:null}getLastDisplayedEventIndex(e={}){const t=e.ignoreOwn||!1,n=e.allowPartial||!1,i=this.messagePanel.current;if(!i)return null;const r=this.messagePanelDiv;if(!r)return null;const o=r.getBoundingClientRect(),s=f.J.safeGet().credentials.userId,a=e=>{if(e){const t=e.getBoundingClientRect();if(n&&t.top<=o.bottom||!n&&t.bottom<=o.bottom)return!0}return!1};let l=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){var c;const n=this.state.liveEvents[e],r=i.getNodeForEventId(n.getId()),o=a(r);if(o&&0!==l)return e+l;r&&!o&&(l=0);const d=!!n.status||t&&n.getSender()===s;if(!(!(0,vn.bN)(n,f.J.safeGet(),null===(c=this.context)||void 0===c?void 0:c.showHiddenEvents)||(0,fS.A)(n,this.context))&&r){if(!d&&o)return e}else(!d||d&&0!==l)&&++l}return null}getCurrentReadReceipt(e=!1){var t,n;const i=f.J.get();if(null==i)return null;const r=i.getSafeUserId(),o=null!==(t=this.props.timelineSet.thread)&&void 0!==t?t:this.props.timelineSet.room;return null!==(n=null==o?void 0:o.getEventReadUpTo(r,e))&&void 0!==n?n:null}async setReadMarker(e,t,n=!1){var i;const r=null===(i=this.props.timelineSet.room)||void 0===i?void 0:i.roomId;e!==this.state.readMarkerEventId&&null!==e&&(void 0!==t?Ek.roomReadMarkerTsMap[null!=r?r:""]=t:delete Ek.roomReadMarkerTsMap[null!=r?r:""],n||await new Promise(t=>{this.setState({readMarkerEventId:e},()=>{var e,n;null===(e=(n=this.props).onReadMarkerUpdated)||void 0===e||e.call(n),t()})}))}shouldPaginate(){return!this.state.events.some(e=>e.isBeingDecrypted())}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,yk.fN)(this.callEventGroupers,e)}render(){var e,t,n,r,s,a;if(this.state.timelineLoading)return o.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.createElement(le.A,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return o.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},o.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const l=!(null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(i.EventTimeline.FORWARDS)),c=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),d=this.state.events;return o.createElement(CA,{ref:this.messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:c,events:d,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,canBackPaginate:this.state.canBackPaginate,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:f.J.safeGet().getSafeUserId(),stickyBottom:l,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:null!==(t=null===(n=this.context)||void 0===n?void 0:n.showTwelveHourTimestamps)&&void 0!==t?t:this.state.isTwelveHour,alwaysShowTimestamps:null!==(r=null!==(s=this.props.alwaysShowTimestamps)&&void 0!==s?s:null===(a=this.context)||void 0===a?void 0:a.alwaysShowTimestamps)&&void 0!==r?r:this.state.alwaysShowTimestamps,className:this.props.className,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,hideThreadedMessages:this.props.hideThreadedMessages,disableGrouping:this.props.disableGrouping,callEventGroupers:this.callEventGroupers})}}function wk(e){return e.map(e=>{const t={},n=e.getTimelines(),i=e.getLiveTimeline();return n.forEach((e,n)=>{t[e===i?"liveTimeline":`${n}`]=e.getEvents().map(e=>e.getId())}),t})}(0,S.A)(Ek,"contextType",kn.Ay),(0,S.A)(Ek,"roomReadMarkerTsMap",{}),(0,S.A)(Ek,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0,hideThreadedMessages:!0,disableGrouping:!1});const Sk=Ek;class xk extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"instanceId",void 0),(0,S.A)(this,"onResize",(e,t)=>{e===Ja.x.Resize&&this.props.onMeasurement(t.contentRect.width<=this.props.breakpoint)}),this.instanceId=xk.instanceCount++}componentDidMount(){Ja.A.instance.on(`Measured${this.instanceId}`,this.onResize)}componentDidUpdate(e){const t=e.sensor.current,n=this.props.sensor.current;t!==n&&(t&&Ja.A.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`),n&&Ja.A.instance.trackElementDimensions(`Measured${this.instanceId}`,n))}componentWillUnmount(){Ja.A.instance.off(`Measured${this.instanceId}`,this.onResize),Ja.A.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`)}render(){return null}}(0,S.A)(xk,"instanceCount",0),(0,S.A)(xk,"defaultProps",{breakpoint:500});const Ak=({Icon:e,title:t,description:n})=>o.createElement(Fe.s,{className:"mx_EmptyState",direction:"column",gap:"var(--cpd-space-4x)",align:"center",justify:"center"},o.createElement(e,{width:"32px",height:"32px"}),o.createElement(og.E,{size:"lg",weight:"semibold"},t),o.createElement(og.E,{size:"md",weight:"regular"},n));class Ck extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"decryptingEvents",new Set),(0,S.A)(this,"noRoom",!1),(0,S.A)(this,"card",(0,o.createRef)()),(0,S.A)(this,"state",{timelineSet:null,narrow:!1}),(0,S.A)(this,"onRoomTimeline",(e,t,n,i,r)=>{if((null==t?void 0:t.roomId)!==this.props.roomId)return;if(n||!r||!r.liveEvent||e.isRedacted())return;f.J.safeGet().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)}),(0,S.A)(this,"onEventDecrypted",(e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const n=e.getId();this.decryptingEvents.delete(n)&&(t||this.addEncryptedLiveEvent(e))}),(0,S.A)(this,"onPaginationRequest",(e,t,n)=>{const i=f.J.safeGet(),r=y.A.get(),o=this.props.roomId,s=i.getRoom(o);return s&&i.isRoomEncrypted(o)&&null!==r?r.paginateTimelineWindow(s,e,t,n):e.paginate(t,n)}),(0,S.A)(this,"onMeasurement",e=>{this.setState({narrow:e})})}addEncryptedLiveEvent(e){if(!this.state.timelineSet)return;const t=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&["m.file","m.image","m.video","m.audio"].includes(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,t,{fromCache:!1,addToState:!1,toStartOfTimeline:!1}))}async componentDidMount(){const e=f.J.safeGet();await this.updateTimelineSet(this.props.roomId),e.isRoomEncrypted(this.props.roomId)&&null!==y.A.get()&&(e.on(i.RoomEvent.Timeline,this.onRoomTimeline),e.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted))}componentWillUnmount(){const e=f.J.get();null!==e&&e.isRoomEncrypted(this.props.roomId)&&null!==y.A.get()&&(e.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline),e.removeListener(i.MatrixEventEvent.Decrypted,this.onEventDecrypted))}async fetchFileEventsServer(e){const t=f.J.safeGet(),n=new i.Filter(t.getSafeUserId());return n.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}}),n.filterId=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,n),e.getOrCreateFilteredTimelineSet(n)}async updateTimelineSet(e){const t=f.J.safeGet(),n=t.getRoom(e),i=y.A.get();if(this.noRoom=!n,n){let r;try{if(r=await this.fetchFileEventsServer(n),t.isRoomEncrypted(e)&&null!==i){const e=r.getLiveTimeline();await i.populateFileTimeline(r,e,n,10)}this.setState({timelineSet:r})}catch(e){s.vF.error("Failed to get or create file panel filter",e)}}else s.vF.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(f.J.safeGet().isGuest())return o.createElement(KS.A,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,header:(0,c._t)("right_panel|files_button")},o.createElement("div",{className:"mx_RoomView_empty"},(0,c._t)("file_panel|guest_note",{},{a:e=>o.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return o.createElement(KS.A,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,header:(0,c._t)("right_panel|files_button")},o.createElement("div",{className:"mx_RoomView_empty"},(0,c._t)("file_panel|peek_note")));const e=o.createElement(Ak,{Icon:LS.A,title:(0,c._t)("file_panel|empty_heading"),description:(0,c._t)("file_panel|empty_description")}),t=!this.noRoom&&f.J.safeGet().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?o.createElement(yr.yw,(0,tn.A)({},this.context,{timelineRenderingType:kn.Ae.File,narrow:this.state.narrow}),o.createElement(KS.A,{className:"mx_FilePanel",onClose:this.props.onClose,withoutScrollContainer:!0,ref:this.card,header:(0,c._t)("right_panel|files_button")},o.createElement(xk,{sensor:this.card,onMeasurement:this.onMeasurement}),o.createElement(_k,{isRoomEncrypted:t,kind:fk.Files}),o.createElement(Sk,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,resizeNotifier:this.props.resizeNotifier,empty:e,layout:Zt.P.Group}))):o.createElement(yr.yw,(0,tn.A)({},this.context,{timelineRenderingType:kn.Ae.File}),o.createElement(KS.A,{className:"mx_FilePanel",onClose:this.props.onClose,header:(0,c._t)("right_panel|files_button")},o.createElement(le.A,null)))}}(0,S.A)(Ck,"contextType",kn.Ay);const kk=Ck;class Rk extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"resize",()=>{this.props.onResize&&this.props.onResize()})}componentDidMount(){window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}render(){return o.createElement("div",null,this.props.element)}}const Ik="stickerPicker";class Tk extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"prevSentVisibility",void 0),(0,S.A)(this,"popoverWidth",300),(0,S.A)(this,"popoverHeight",300),(0,S.A)(this,"scalarClient",null),(0,S.A)(this,"removeStickerpickerWidgets",async()=>{const e=await this.acquireScalarClient();s.vF.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(yC.x.STICKERPICKER,this.state.widgetId).then(()=>{s.vF.log("Assets disabled")}).catch(()=>{s.vF.error("Failed to disable assets")}):s.vF.error("Cannot disable assets: no scalar client"):s.vF.warn("No widget ID specified, not disabling assets"),this.props.setStickerPickerOpen(!1),iC.A.removeStickerpickerWidgets(this.props.room.client).then(()=>{this.forceUpdate()}).catch(e=>{s.vF.error("Failed to remove sticker picker widget",e)})}),(0,S.A)(this,"updateWidget",()=>{var e,t,n,i;const r=iC.A.getStickerpickerWidgets(this.props.room.client)[0];if(!r)return Tk.currentWidget=void 0,void this.setState({stickerpickerWidget:null,widgetId:null});const o=Tk.currentWidget,s=null!==(e=null==o||null===(t=o.content)||void 0===t?void 0:t.url)&&void 0!==e?e:null;(null!==(n=null==r||null===(i=r.content)||void 0===i?void 0:i.url)&&void 0!==n?n:null)!==s&&_C.destroyElement(Ik),Tk.currentWidget=r,this.setState({stickerpickerWidget:r,widgetId:r?r.id:null})}),(0,S.A)(this,"onAction",e=>{switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":case"show_left_panel":case"hide_left_panel":this.props.setStickerPickerOpen(!1)}}),(0,S.A)(this,"onRightPanelStoreUpdate",()=>{this.props.setStickerPickerOpen(!1)}),(0,S.A)(this,"onResize",()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)}),(0,S.A)(this,"onFinished",()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)}),(0,S.A)(this,"launchManageIntegrations",()=>{var e,t;null===(e=U.J.sharedInstance())||void 0===e||null===(e=e.getPrimaryManager())||void 0===e||e.open(this.props.room,`type_${yC.x.STICKERPICKER.preferred}`,null!==(t=this.state.widgetId)&&void 0!==t?t:void 0)}),this.state={imError:null,stickerpickerWidget:null,widgetId:null}}async acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):U.J.sharedInstance().hasManager()?(this.scalarClient=null!==(e=null===(t=U.J.sharedInstance().getPrimaryManager())||void 0===t?void 0:t.getScalarClient())&&void 0!==e?e:null,null===(n=this.scalarClient)||void 0===n?void 0:n.connect().then(()=>(this.forceUpdate(),this.scalarClient)).catch(e=>{this.imError((0,c.AO)("integration_manager|error_connecting_heading"),e)})):void U.J.sharedInstance().openNoManagerDialog();var e,t,n}componentDidMount(){window.addEventListener("resize",this.onResize),this.dispatcherRef=x.A.register(this.onAction),f.J.safeGet().on(i.ClientEvent.AccountData,this.updateWidget),lg.A.instance.on(ha.H,this.onRightPanelStoreUpdate),this.updateWidget()}componentWillUnmount(){const e=f.J.get();e&&e.removeListener(i.ClientEvent.AccountData,this.updateWidget),lg.A.instance.off(ha.H,this.onRightPanelStoreUpdate),window.removeEventListener("resize",this.onResize),x.A.unregister(this.dispatcherRef)}componentDidUpdate(){this.sendVisibilityToWidget(this.props.isStickerPickerOpen)}imError(e,t){s.vF.error(e,t),this.setState({imError:(0,c._t)(e)}),this.props.setStickerPickerOpen(!1)}defaultStickerpickerContent(){const e=n("./res/img/stickerpack-placeholder.png");return o.createElement(ae.A,{onClick:this.launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},o.createElement("p",null,(0,c._t)("stickers|empty")),o.createElement("p",{className:"mx_Stickers_addLink"},(0,c._t)("stickers|empty_add_prompt")),o.createElement("img",{src:e,alt:""}))}errorStickerpickerContent(){return o.createElement("div",{style:{textAlign:"center"},className:"error"},o.createElement("p",null," ",this.state.imError," "))}sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=MC.c.instance.getMessagingForUid(iC.A.calcWidgetUid(this.state.stickerpickerWidget.id));t&&e!==this.prevSentVisibility&&(t.updateVisibility(e).catch(e=>{s.vF.error("Error updating widget visibility: ",e)}),this.prevSentVisibility=e)}getStickerpickerContent(){var e;if(this.state.imError)return this.errorStickerpickerContent();const t=this.state.stickerpickerWidget;let n;if(null!=t&&null!==(e=t.content)&&void 0!==e&&e.url){t.content.name=t.content.name||(0,c._t)("common|stickerpack");const e={id:t.id,url:t.content.url,name:t.content.name,type:t.content.type,data:t.content.data,creatorUserId:t.content.creatorUserId||t.sender};n=o.createElement("div",{className:"mx_Stickers_content_container"},o.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},o.createElement(_C,{persistKey:Ik,zIndex:3500},o.createElement(hk,{app:e,room:this.props.room,threadId:this.props.threadId,fullWidth:!0,userId:f.J.safeGet().credentials.userId,creatorUserId:t.sender||f.J.safeGet().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this.launchManageIntegrations,onDeleteClick:this.removeStickerpickerWidgets,showTitle:!1,showPopout:!1,handleMinimisePointerEvents:!0,userWidget:!0,showLayoutButtons:!1}))))}else n=this.defaultStickerpickerContent();return n}render(){return this.props.isStickerPickerOpen?o.createElement(Nn.Ay,(0,tn.A)({chevronFace:Nn.t4.Bottom,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this.onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500,mountAsChild:!0},this.props.menuPosition),o.createElement(Rk,{element:this.getStickerpickerContent(),onResize:this.onFinished})):null}}(0,S.A)(Tk,"defaultProps",{threadId:null}),(0,S.A)(Tk,"currentWidget",void 0);var Pk=n("./src/components/views/rooms/E2EIcon.tsx");class Nk extends o.Component{render(){return this.props.replyToEvent?o.createElement("div",{className:"mx_ReplyPreview"},o.createElement("div",{className:"mx_ReplyPreview_section"},o.createElement("div",{className:"mx_ReplyPreview_header"},o.createElement("span",null,(0,c._t)("composer|replying_title")),o.createElement(ae.A,{className:"mx_ReplyPreview_header_cancel",onClick:()=>{return e=this.context.timelineRenderingType,void x.A.dispatch({action:"reply_to_event",event:null,context:e});var e}})),o.createElement(xn,{mxEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}))):null}}function Dk(e,t){const n=(0,ce.nH)(),r=n.getCrypto(),[a,l]=(0,o.useState)([]),[c,d]=(0,o.useState)(void 0),u=(0,o.useMemo)(()=>(0,Li.throttle)(async()=>{if(!(r&&await r.isEncryptionEnabledInRoom(e.roomId)))return l([]),void d(void 0);const t=await e.getEncryptionTargetMembers();l(t);const n=await async function(e,t){const n=new Array;for(const i of t){const t=await e.getUserVerificationStatus(i.userId);t.wasCrossSigningVerified()&&!t.isCrossSigningVerified()?n.push({member:i,type:"VerificationViolation"}):t.needsUserApproval&&n.push({member:i,type:"PinViolation"})}return n}(r,t);let i;if(n.length>0){const e=n.sort((e,t)=>e.member.userId.localeCompare(t.member.userId));i=e[0]}else i=void 0;d(e=>e&&n.includes(e)?e:i||void 0)}),[r,e]);(0,lr.YK)(n,i.RoomStateEvent.Events,(0,o.useCallback)(async t=>{if(!r||t.getRoomId()!==e.roomId)return;let n=!1;const o=t.getType();if(o===i.EventType.RoomEncryption&&""===t.getStateKey())n=!0;else if(o==i.EventType.RoomMember){n=!!t.getStateKey()}n&&u().catch(e=>{s.vF.error("Error refreshing UserIdentityWarningViewModel:",e)})},[r,e,u])),(0,lr.YK)(n,V.cr.UserTrustStatusChanged,(0,o.useCallback)(e=>{a.find(t=>t.userId==e)&&u().catch(e=>{s.vF.error("Error refreshing UserIdentityWarning:",e)})},[u,a])),(0,o.useEffect)(()=>{u().catch(e=>{s.vF.error("Error initialising UserIdentityWarning:",e)})},[u]);return{currentPrompt:c,dispatchAction:(0,o.useCallback)(e=>{r&&("PinUserIdentity"===e.type?r.pinCurrentUserIdentity(e.userId).catch(e=>{s.vF.error("Error pinning user identity:",e)}):"WithdrawVerification"===e.type&&r.withdrawVerificationRequirement(e.userId).catch(e=>{s.vF.error("Error withdrawing verification requirement:",e)}))},[r])}}(0,S.A)(Nk,"contextType",kn.Ay);const Mk=({room:e})=>{const{currentPrompt:t,dispatchAction:n}=Dk(e,e.roomId);if(!t)return null;const[i,r]=function(e){let t,n;"VerificationViolation"===e.type?(t=e.member.rawDisplayName===e.member.userId?(0,c._t)("encryption|verified_identity_changed_no_displayname",{userId:e.member.userId},{a:Ok,b:Fk}):(0,c._t)("encryption|verified_identity_changed",{displayName:e.member.rawDisplayName,userId:e.member.userId},{a:Ok,b:Fk}),n=(0,c._t)("encryption|withdraw_verification_action")):(t=e.member.rawDisplayName===e.member.userId?(0,c._t)("encryption|pinned_identity_changed_no_displayname",{userId:e.member.userId},{a:Ok,b:Fk}):(0,c._t)("encryption|pinned_identity_changed",{displayName:e.member.rawDisplayName,userId:e.member.userId},{a:Ok,b:Fk}),n=(0,c._t)("action|dismiss"));return[t,n]}(t);return function(e,t,n,i,r){return o.createElement("div",{className:me()("mx_UserIdentityWarning",{critical:e})},o.createElement(sf.w,null),o.createElement("div",{className:"mx_UserIdentityWarning_row"},t,o.createElement("span",{className:me()("mx_UserIdentityWarning_main",{critical:e})},n),o.createElement(Ae.$,{kind:"secondary",size:"sm",onClick:r},i)))}("VerificationViolation"===t.type,(s=t.member,o.createElement(bn.A,{member:s,title:s.userId,size:"30px"})),i,r,e=>{e.preventDefault(),"VerificationViolation"===t.type?n({type:"WithdrawVerification",userId:t.member.userId}):n({type:"PinUserIdentity",userId:t.member.userId})});var s};function Ok(e){return o.createElement("a",{href:"https://element.io/help#encryption18",target:"_blank",rel:"noreferrer noopener"},e)}function Fk(e){return o.createElement("b",null,e)}var Lk=n("./src/audio/VoiceRecording.ts"),Uk=n("./src/components/views/audio_messages/Waveform.tsx"),Bk=n("./src/utils/MarkedExecution.ts");class Vk extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"waveform",[]),(0,S.A)(this,"scheduledUpdate",new Bk.L(()=>this.updateWaveform(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={waveform:(0,ie.DG)(0,Lk.IZ)}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.waveform=(0,ie.$S)(Array.from(e.waveform),Lk.IZ),this.scheduledUpdate.mark()})}updateWaveform(){this.setState({waveform:this.waveform})}render(){return o.createElement(Uk.A,{relHeights:this.state.waveform})}}(0,S.A)(Vk,"defaultProps",{progress:1});var jk=n("./src/shared-components/audio/Clock/index.tsx");class zk extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"seconds",0),(0,S.A)(this,"scheduledUpdate",new Bk.L(()=>this.updateClock(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()})}updateClock(){this.setState({seconds:this.seconds})}render(){return o.createElement(jk.z,{seconds:this.state.seconds,"aria-live":"off"})}}var Hk=n("./src/utils/Singleflight.ts"),Wk=n("./src/audio/Playback.ts");class Gk{constructor(e,t){(0,S.A)(this,"lastUpload",void 0),(0,S.A)(this,"buffer",new Uint8Array(0)),(0,S.A)(this,"playback",void 0),(0,S.A)(this,"onDataAvailable",e=>{const t=new Uint8Array(e);this.buffer=(0,ie.xW)(this.buffer,t)}),this.matrixClient=e,this.voiceRecording=t,this.voiceRecording.onDataAvailable=this.onDataAvailable}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");return this.voiceRecording.start()}async stop(){return await this.voiceRecording.stop(),this.audioBuffer}on(e,t){return this.voiceRecording.on(e,t),this}off(e,t){return this.voiceRecording.off(e,t),this}emit(e,...t){return this.voiceRecording.emit(e,...t)}get hasRecording(){return this.buffer.length>0}get isRecording(){return this.voiceRecording.isRecording}getPlayback(){return this.playback=Hk.j.for(this,"playback").do(()=>new Wk.Y(this.audioBuffer.buffer,this.voiceRecording.amplitudes)),this.playback}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;try{this.emit(Lk.$T.Uploading);const{url:t,file:n}=await(0,yS.QM)(this.matrixClient,e,new Blob([this.audioBuffer],{type:this.contentType}));this.lastUpload={mxc:t,encrypted:n},this.emit(Lk.$T.Uploaded)}catch(e){throw this.emit(Lk.$T.Ended),e}return this.lastUpload}get durationSeconds(){return this.voiceRecording.durationSeconds}get contentType(){return this.voiceRecording.contentType}get contentLength(){return this.buffer.length}get liveData(){return this.voiceRecording.liveData}get isSupported(){return this.voiceRecording.isSupported}destroy(){var e;null===(e=this.playback)||void 0===e||e.destroy(),this.voiceRecording.destroy()}get audioBuffer(){return this.buffer.slice(0)}}function Kk(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function qk(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function $k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qk(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qk(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class Jk extends Ea.r{constructor(){super(x.A,{})}static get instance(){return this.internalInstance||(this.internalInstance=new Jk,this.internalInstance.start()),this.internalInstance}async onAction(e){}static getVoiceRecordingId(e,t){return"io.element.thread"===(null==t?void 0:t.rel_type)||(null==t?void 0:t.rel_type)===i.RelationType.Thread?e.roomId+"|"+t.event_id:e.roomId}getActiveRecording(e){return this.state[e]}startRecording(e){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(!e)throw new Error("Recording must be associated with a room");if(this.state[e])throw new Error("A recording is already in progress");const t=(n=this.matrixClient,new Gk(n,new Lk.Qj));var n;return this.updateState($k($k({},this.state),{},{[e]:t})),t}disposeRecording(e){var t;null===(t=this.state[e])||void 0===t||t.destroy();const n=this.state,{[e]:i}=n,r=(0,v.A)(n,[e].map(Kk));return this.reset(r)}}(0,S.A)(Jk,"internalInstance",void 0),window.mxVoiceRecordingStore=Jk.instance;var Yk=n("./src/components/views/audio_messages/RecordingPlayback.tsx"),Xk=n("./src/audio/PlaybackManager.ts"),Qk=n("./src/utils/local-room.ts"),Zk=n("./src/components/views/rooms/SendMessageComposer.tsx");class eR extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"voiceRecordingId",void 0),(0,S.A)(this,"onCancel",async()=>{await this.disposeRecording()}),(0,S.A)(this,"onRecordStartEndClick",async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{R.Ay.createDialog(Ht.A,{title:(0,c._t)("voip|unable_to_access_audio_input_title"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("voip|unable_to_access_audio_input_description")))})};try{var t;const e=await Da.Ay.getDevices();if(null==e||null===(t=e[Da.cm.AudioInput])||void 0===t||!t.length)return void R.Ay.createDialog(Ht.A,{title:(0,c._t)("voip|no_audio_input_title"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("voip|no_audio_input_description")))})}catch(t){return s.vF.error("Error getting devices: ",t),void e()}try{Xk.T.instance.pauseAllExcept();const e=Jk.instance.startRecording(this.voiceRecordingId);await e.start(),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:Lk.$T.Started})}catch(t){s.vF.error("Error starting recording: ",t),e(),Jk.instance.disposeRecording(this.voiceRecordingId)}}),(0,S.A)(this,"onRecordingUpdate",e=>{e!==Lk.$T.EndingSoon&&this.setState({recordingPhase:e})}),this.state={},this.voiceRecordingId=Jk.getVoiceRecordingId(this.props.room,this.props.relation)}componentDidMount(){const e=Jk.instance.getActiveRecording(this.voiceRecordingId);e&&(!e.isRecording&&e.hasRecording||s.vF.warn("Cached recording hasn't ended yet and might cause issues"),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:Lk.$T.Ended}))}async componentWillUnmount(){const e=Jk.instance.getActiveRecording(this.voiceRecordingId);await(null==e?void 0:e.stop()),this.bindNewRecorder(null)}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");const{replyToEvent:e,relation:t}=this.props;let n;await this.state.recorder.stop();try{n=await this.state.recorder.upload(this.voiceRecordingId)}catch(e){return s.vF.error("Error uploading voice message:",e),void this.setState({didUploadFail:!0})}try{const s=(r=n.mxc,o=this.state.recorder.contentType,a=Math.round(1e3*this.state.recorder.durationSeconds),l=this.state.recorder.contentLength,c=n.encrypted,d=this.state.recorder.getPlayback().thumbnailWaveform.map(e=>Math.round(1024*e)),{body:"Voice message",msgtype:i.MsgType.Audio,url:r,file:c,info:{duration:a,mimetype:o,size:l},"org.matrix.msc1767.text":"Voice message","org.matrix.msc1767.file":{url:r,file:c,name:"Voice message.ogg",mimetype:o,size:l},"org.matrix.msc1767.audio":{duration:a,waveform:d},"org.matrix.msc3245.voice":{}});(0,Zk.LO)(f.J.safeGet().getSafeUserId(),s,null,e),(0,Zk.gV)(s,t),e&&((0,Cn.fh)(s,e),x.A.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType})),(0,Qk.Y)(this.props.room.roomId,e=>f.J.safeGet().sendMessage(e,s),this.props.room.client)}catch(e){s.vF.error("Error sending voice message:",e)}var r,o,a,l,c,d;await this.disposeRecording()}async disposeRecording(){await Jk.instance.disposeRecording(this.voiceRecordingId),this.setState({recorder:void 0,recordingPhase:void 0,didUploadFail:!1})}bindNewRecorder(e){this.state.recorder&&this.state.recorder.off(ha.H,this.onRecordingUpdate),e&&e.on(ha.H,this.onRecordingUpdate)}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==Lk.$T.Started?o.createElement(Yk.A,{playback:this.state.recorder.getPlayback(),layout:Yk._.Composer}):o.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},o.createElement(zk,{recorder:this.state.recorder}),o.createElement(Vk,{recorder:this.state.recorder})):null}render(){if(!this.state.recordingPhase)return null;let e,t,n;if(this.state.recordingPhase===Lk.$T.Started){var i;let t=(0,c._t)("composer|send_voice_message");this.state.recorder&&(t=(0,c._t)("composer|stop_voice_message")),e=o.createElement(ae.A,{className:"mx_VoiceRecordComposerTile_stop",onClick:this.onRecordStartEndClick,title:t}),!this.state.recorder||null!==(i=this.state.recorder)&&void 0!==i&&i.isRecording||(e=null)}return this.state.recorder&&this.state.recordingPhase!==Lk.$T.Uploading&&(t=o.createElement(ae.A,{className:"mx_VoiceRecordComposerTile_delete",title:(0,c._t)("action|delete"),onClick:this.onCancel})),this.state.recordingPhase===Lk.$T.Uploading?n=o.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadingState"},o.createElement(tl.A,{w:16,h:16})):this.state.didUploadFail&&this.state.recordingPhase===Lk.$T.Ended&&(n=o.createElement("span",{className:"mx_VoiceRecordComposerTile_failedState"},o.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadState_badge"},o.createElement(On.A,{notification:Mn.d.forSymbol("!",fp.S.Highlight)})),o.createElement("span",{className:"text-warning"},(0,c._t)("timeline|send_state_failed")))),o.createElement(o.Fragment,null,n,t,e,this.renderWaveformArea())}}(0,S.A)(eR,"contextType",kn.Ay);var tR=n("./src/components/views/rooms/MessageComposerButtons.tsx"),nR=n("./src/components/views/rooms/wysiwyg_composer/index.ts");const iR="mx_wysiwyg_state_";let rR=0;function oR(e){var t;return o.createElement(ae.A,{className:"mx_MessageComposer_sendMessage",onClick:e.onClick,title:null!==(t=e.title)&&void 0!==t?t:(0,c._t)("composer|send_button_title")})}function sR(e){var t;const n=e.currentState.getStateEvents("m.room.topic","");return((null==n||null===(t=n.getContent())||void 0===t?void 0:t.topic)||"").includes("Contribution Value:")}class aR extends o.Component{constructor(e){var t;super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"messageComposerInput",(0,o.createRef)()),(0,S.A)(this,"voiceRecordingButton",(0,o.createRef)()),(0,S.A)(this,"ref",(0,o.createRef)()),(0,S.A)(this,"instanceId",void 0),(0,S.A)(this,"_voiceRecording",void 0),(0,S.A)(this,"saveWysiwygEditorState",()=>{if(this.shouldSaveWysiwygEditorState()){const{isRichTextEnabled:e,composerContent:t}=this.state,n={content:t,isRichText:e,replyEventId:this.props.replyToEvent?this.props.replyToEvent.getId():void 0};localStorage.setItem(this.editorStateKey,JSON.stringify(n))}else this.clearStoredEditorState()}),(0,S.A)(this,"shouldSaveWysiwygEditorState",()=>{const{isWysiwygLabEnabled:e,isComposerEmpty:t}=this.state;return e&&(!t||!!this.props.replyToEvent)}),(0,S.A)(this,"onResize",(e,t)=>{if(e===Ja.x.Resize){const{narrow:e}=this.context;this.setState({isMenuOpen:!!e&&this.state.isMenuOpen,isStickerPickerOpen:!1})}}),(0,S.A)(this,"onAction",e=>{switch(e.action){case"reply_to_event":e.context===this.context.timelineRenderingType&&window.setTimeout(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()},100);break;case W.r.SettingUpdated:{const t=e;switch(t.settingName){case"MessageComposerInput.showStickersButton":{const e=O.A.getValue("MessageComposerInput.showStickersButton");this.state.showStickersButton!==e&&this.setState({showStickersButton:e});break}case"MessageComposerInput.showPollsButton":{const e=O.A.getValue("MessageComposerInput.showPollsButton");this.state.showPollsButton!==e&&this.setState({showPollsButton:e});break}case"feature_wysiwyg_composer":this.state.isWysiwygLabEnabled!==t.newValue&&this.setState({isWysiwygLabEnabled:Boolean(t.newValue)})}}}}),(0,S.A)(this,"onTombstoneClick",e=>{var t,n;e.preventDefault();const r=null===(t=this.context.tombstone)||void 0===t?void 0:t.getContent().replacement_room,o=f.J.safeGet().getRoom(r);let s;if(o){const e=o.currentState.getStateEvents(i.EventType.RoomCreate,"");null!=e&&e.getId()&&(s=e.getId())}const a=null===(n=this.context.tombstone)||void 0===n?void 0:n.getSender(),l=a?[a.split(":").slice(1).join(":")]:void 0;x.A.dispatch({action:W.r.ViewRoom,highlighted:!0,event_id:s,room_id:r,auto_join:!0,via_servers:l,metricsTrigger:"Tombstone",metricsViaKeyboard:"click"!==e.type})}),(0,S.A)(this,"renderPlaceholderText",()=>{if(this.props.replyToEvent){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===i.THREAD_RELATION_TYPE.name;return t&&this.props.e2eStatus?(0,c._t)("composer|placeholder_thread_encrypted"):t?(0,c._t)("composer|placeholder_thread"):this.props.e2eStatus?(0,c._t)("composer|placeholder_reply_encrypted"):(0,c._t)("composer|placeholder_reply")}return this.props.e2eStatus?(0,c._t)("composer|placeholder_encrypted"):(0,c._t)("composer|placeholder")}),(0,S.A)(this,"addEmoji",e=>(x.A.dispatch({action:W.r.ComposerInsert,text:e,timelineRenderingType:this.context.timelineRenderingType}),!0)),(0,S.A)(this,"sendMessage",async()=>{var e,t;if(this.state.haveRecording&&this.voiceRecordingButton.current)await(null===(t=this.voiceRecordingButton.current)||void 0===t?void 0:t.send());else if(null===(e=this.messageComposerInput.current)||void 0===e||e.sendMessage(),this.state.isWysiwygLabEnabled){const{relation:e,replyToEvent:t}=this.props,n=this.state.composerContent;this.setState({composerContent:"",initialComposerContent:""}),x.A.dispatch({action:W.r.ClearAndFocusSendMessageComposer,timelineRenderingType:this.context.timelineRenderingType}),await(0,nR._z)(n,this.state.isRichTextEnabled,{mxClient:this.props.mxClient,roomContext:this.context,relation:e,replyToEvent:t})}}),(0,S.A)(this,"onChange",e=>{this.setState({isComposerEmpty:e.isEmpty})}),(0,S.A)(this,"onWysiwygChange",e=>{this.setState({composerContent:e,isComposerEmpty:0===(null==e?void 0:e.length)})}),(0,S.A)(this,"onRichTextToggle",async()=>{const{richToPlain:e,plainToRich:t}=await(0,nR.Os)(),{isRichTextEnabled:n,composerContent:i}=this.state,r=n?await e(i,!1):await t(i,!1);this.setState({isRichTextEnabled:!n,composerContent:r,initialComposerContent:r})}),(0,S.A)(this,"onVoiceStoreUpdate",()=>{this.updateRecordingState()}),(0,S.A)(this,"onRecordingStarted",()=>{const e=Jk.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=Jk.instance.getActiveRecording(e),this.setState({haveRecording:!!this.voiceRecording})}),(0,S.A)(this,"onRecordingEndingSoon",({secondsLeft:e})=>{this.setState({recordingTimeLeftSeconds:e}),window.setTimeout(()=>this.setState({recordingTimeLeftSeconds:void 0}),3e3)}),(0,S.A)(this,"setStickerPickerOpen",e=>{this.setState({isStickerPickerOpen:e,isMenuOpen:!1})}),(0,S.A)(this,"toggleStickerPickerOpen",()=>{this.setStickerPickerOpen(!this.state.isStickerPickerOpen)}),(0,S.A)(this,"toggleButtonMenu",()=>{this.setState({isMenuOpen:!this.state.isMenuOpen})}),(0,S.A)(this,"onRecordStartEndClick",()=>{var e;null===(e=this.voiceRecordingButton.current)||void 0===e||e.onRecordStartEndClick(),this.context.narrow&&this.toggleButtonMenu()});const n=O.A.getValue("feature_wysiwyg_composer");let r=!0,s="";if(n){const e=this.restoreWysiwygEditorState();e&&(r=e.isRichText,s=e.content)}const a=this.isGOVProposalRoom();this.state={isComposerEmpty:0===(null===(t=s)||void 0===t?void 0:t.length),composerContent:s,haveRecording:!1,recordingTimeLeftSeconds:void 0,isMenuOpen:!1,isStickerPickerOpen:!1,showStickersButton:O.A.getValue("MessageComposerInput.showStickersButton"),showPollsButton:O.A.getValue("MessageComposerInput.showPollsButton")&&!a,isWysiwygLabEnabled:n,isRichTextEnabled:r,initialComposerContent:s},this.instanceId=rR++}get editorStateKey(){var e;let t=iR+this.props.room.roomId;return(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===i.THREAD_RELATION_TYPE.name&&(t+=`_${this.props.relation.event_id}`),t}isGOVProposalRoom(){const e=this.props.room;if(!e)return!1;const t=e.name;return null==t?void 0:t.startsWith("Proposal #")}isLedgerRoom(){const e=this.props.room;if(!e)return!1;return"ledger"===e.name}restoreWysiwygEditorState(){const e=localStorage.getItem(this.editorStateKey);if(e)try{return JSON.parse(e)}catch(e){s.vF.error(e)}}clearStoredEditorState(){localStorage.removeItem(this.editorStateKey)}get voiceRecording(){return this._voiceRecording}set voiceRecording(e){this._voiceRecording&&(this._voiceRecording.off(Lk.$T.Started,this.onRecordingStarted),this._voiceRecording.off(Lk.$T.EndingSoon,this.onRecordingEndingSoon)),this._voiceRecording=e,e&&(e.on(Lk.$T.Started,this.onRecordingStarted),e.on(Lk.$T.EndingSoon,this.onRecordingEndingSoon))}componentDidMount(){if(Jk.instance.on(ha.H,this.onVoiceStoreUpdate),window.addEventListener("beforeunload",this.saveWysiwygEditorState),this.state.isWysiwygLabEnabled){const e=this.restoreWysiwygEditorState();null!=e&&e.replyEventId&&x.A.dispatch({action:"reply_to_event",event:this.props.room.findEventById(e.replyEventId),context:this.context.timelineRenderingType})}O.A.monitorSetting("MessageComposerInput.showStickersButton",null),O.A.monitorSetting("MessageComposerInput.showPollsButton",null),O.A.monitorSetting("feature_wysiwyg_composer",null),this.dispatcherRef=x.A.register(this.onAction),this.waitForOwnMember(),Ja.A.instance.trackElementDimensions(`MessageComposer${this.instanceId}`,this.ref.current),Ja.A.instance.on(`MessageComposer${this.instanceId}`,this.onResize),this.updateRecordingState()}waitForOwnMember(){const e=this.props.room.getMember(f.J.safeGet().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then(()=>{var e;const t=null!==(e=this.props.room.getMember(f.J.safeGet().getSafeUserId()))&&void 0!==e?e:void 0;this.setState({me:t})})}componentWillUnmount(){Jk.instance.off(ha.H,this.onVoiceStoreUpdate),x.A.unregister(this.dispatcherRef),Ja.A.instance.stopTrackingElementDimensions(`MessageComposer${this.instanceId}`),Ja.A.instance.removeListener(`MessageComposer${this.instanceId}`,this.onResize),window.removeEventListener("beforeunload",this.saveWysiwygEditorState),this.saveWysiwygEditorState(),this.voiceRecording=null}updateRecordingState(){const e=Jk.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=Jk.instance.getActiveRecording(e),this.voiceRecording?this.voiceRecording.hasRecording&&!this.voiceRecording.isRecording&&this.setState({haveRecording:!0}):this.setState({haveRecording:!1})}get showStickersButton(){return this.state.showStickersButton&&!(0,Pr.F)(this.props.room)}getMenuPosition(){if(this.ref.current){const e=this.state.isWysiwygLabEnabled&&this.state.isRichTextEnabled,t=this.ref.current.getBoundingClientRect(),n=e?36:0,i=new DOMRect(t.x,t.y+n,t.width,t.height-n);return(0,Nn.qv)(i)}}render(){var e;let t=!1;this.state.isWysiwygLabEnabled||(this.props.e2eStatus?this.props.e2eStatus!==qS.z.Normal&&(t=o.createElement("div",{className:"mx_MessageComposer_e2eIconWrapper"},o.createElement(Pk.A,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"}))):t=o.createElement("div",{className:"mx_MessageComposer_e2eIconWrapper"},o.createElement(GS.A,{width:12,height:12,color:"var(--cpd-color-icon-info-primary)",className:"mx_E2EIcon mx_MessageComposer_e2eIcon"})));const n=[],r=this.getMenuPosition(),s=this.context.canSendMessages&&!this.context.tombstone&&!this.isLedgerRoom();let a;if(s)a=this.state.isWysiwygLabEnabled&&r?o.createElement(nR.W1,{key:"controls_input",disabled:this.state.haveRecording,onChange:this.onWysiwygChange,onSend:this.sendMessage,isRichTextEnabled:this.state.isRichTextEnabled,initialContent:this.state.initialComposerContent,e2eStatus:this.props.e2eStatus,menuPosition:r,placeholder:this.renderPlaceholderText(),eventRelation:this.props.relation}):o.createElement(Zk.Ay,{ref:this.messageComposerInput,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),relation:this.props.relation,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording,toggleStickerPickerOpen:this.toggleStickerPickerOpen}),n.push(o.createElement(eR,{key:"controls_voice_record",ref:this.voiceRecordingButton,room:this.props.room,relation:this.props.relation,replyToEvent:this.props.replyToEvent}));else if(this.context.tombstone){const e=this.context.tombstone.getContent().replacement_room,t=e?o.createElement("a",{href:(0,on.B4)(f.J.safeGet(),e),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},(0,c._t)("composer|room_upgraded_link")):"";n.push(o.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},o.createElement("div",{className:"mx_MessageComposer_replaced_valign"},o.createElement("img",{"aria-hidden":!0,alt:"",className:"mx_MessageComposer_roomReplaced_icon",src:"img/room_replaced.26077c1.svg"}),o.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},(0,c._t)("composer|room_upgraded_notice")),o.createElement("br",null),t)))}else this.isLedgerRoom()?n.push(o.createElement("div",{key:"controls_ledger",className:"mx_MessageComposer_noperm_error"}," Chat is disabled in the ledger room. Only transaction records are automatically recorded.")):n.push(o.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},(0,c._t)("composer|no_perms_notice")));const l=Boolean(this.state.recordingTimeLeftSeconds),d=this.state.recordingTimeLeftSeconds?Math.round(this.state.recordingTimeLeftSeconds):0,u=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===i.THREAD_RELATION_TYPE.name?this.props.relation.event_id:null;n.push(o.createElement(Tk,{room:this.props.room,threadId:u,isStickerPickerOpen:this.state.isStickerPickerOpen,setStickerPickerOpen:this.setStickerPickerOpen,menuPosition:r,key:"stickers"}));const m=s&&(!this.state.isComposerEmpty||this.state.haveRecording),h=me()({mx_MessageComposer:!0,"mx_MessageComposer--compact":this.props.compact,mx_MessageComposer_e2eStatus:t,mx_MessageComposer_wysiwyg:this.state.isWysiwygLabEnabled});return o.createElement(rn.m,{open:l,description:(0,gt.U)(d),placement:"bottom"},o.createElement("div",{className:h,ref:this.ref,role:"region","aria-label":(0,c._t)("a11y|message_composer")},o.createElement("div",{className:"mx_MessageComposer_wrapper"},o.createElement(Mk,{room:this.props.room,key:this.props.room.roomId}),o.createElement(Nk,{replyToEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator}),o.createElement("div",{className:"mx_MessageComposer_row"},t,a,o.createElement("div",{className:"mx_MessageComposer_actions"},n,s&&o.createElement(tR.Ay,{addEmoji:this.addEmoji,haveRecording:this.state.haveRecording,isMenuOpen:this.state.isMenuOpen,isStickerPickerOpen:this.state.isStickerPickerOpen,menuPosition:r,relation:this.props.relation,onRecordStartEndClick:this.onRecordStartEndClick,setStickerPickerOpen:this.setStickerPickerOpen,showLocationButton:!window.electron&&O.A.getValue(It.f.LocationSharing),showPollsButton:this.state.showPollsButton,showStickersButton:this.showStickersButton,isRichTextEnabled:this.state.isRichTextEnabled,onComposerModeClick:this.onRichTextToggle,toggleButtonMenu:this.toggleButtonMenu}),m&&o.createElement(oR,{key:"controls_send",onClick:this.sendMessage,title:this.state.haveRecording?(0,c._t)("composer|send_button_voice_message"):sR(this.props.room)?"Request Verification":void 0}))))))}}(0,S.A)(aR,"contextType",kn.Ay),(0,S.A)(aR,"defaultProps",{compact:!1,isRichTextEnabled:!0});const lR=(0,ce.dt)(aR);class cR{constructor(e){(0,S.A)(this,"serializedParts",null),(0,S.A)(this,"caret",null),this.event=e}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}var dR=n("./src/components/views/elements/ProgressBar.tsx"),uR=n("./src/utils/FileUtils.ts");class mR extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"onAction",e=>{this.unmounted||function(e){return[W.r.UploadStarted,W.r.UploadProgress,W.r.UploadFailed,W.r.UploadFinished,W.r.UploadCanceled].includes(e.action)}(e)&&this.setState(this.calculateState())}),(0,S.A)(this,"onCancelClick",e=>{e.preventDefault(),yS.Ay.sharedInstance().cancelUpload(this.state.currentUpload)}),this.state=this.calculateState()}componentDidMount(){this.unmounted=!1,this.dispatcherRef=x.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,x.A.unregister(this.dispatcherRef)}getUploadsInRoom(){return yS.Ay.sharedInstance().getCurrentUploads(this.props.relation).filter(e=>e.roomId===this.props.room.roomId)}calculateState(){const[e,...t]=this.getUploadsInRoom();return{currentUpload:e,currentFile:null==e?void 0:e.fileName,currentLoaded:null==e?void 0:e.loaded,currentTotal:null==e?void 0:e.total,countFiles:t.length+1}}render(){if(!this.state.currentFile)return null;let e;e=this.state.countFiles>1?(0,c._t)("room|upload|uploading_multiple_file",{filename:this.state.currentFile,count:this.state.countFiles-1}):(0,c._t)("room|upload|uploading_single_file",{filename:this.state.currentFile});const t=(0,uR.Ov)(this.state.currentTotal);return o.createElement("div",{className:"mx_UploadBar"},o.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),o.createElement(ae.A,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),o.createElement(dR.A,{value:this.state.currentLoaded,max:this.state.currentTotal}))}}const hR=["mxEvent","permalinkCreator","onMenuToggle"],pR=e=>{let{mxEvent:t,permalinkCreator:n,onMenuToggle:i}=e,r=(0,v.A)(e,hR);const[s,a,l,d]=(0,Nn.EF)(),u=(0,o.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),x.A.dispatch({action:W.r.ViewRoom,event_id:t.getId(),highlighted:!0,room_id:t.getRoomId(),metricsTrigger:void 0}),d()},[t,d]),m=(0,o.useCallback)(async e=>{if(n){null==e||e.preventDefault(),null==e||e.stopPropagation();const i=n.forEvent(t.getId());await(0,$i.nC)(i),d()}},[t,d,n]);(0,o.useEffect)(()=>{null==i||i(s)},[s,i]);const h=f.J.safeGet().getRoom(t.getRoomId()),p=!!h&&!YC.aK.instance.hasMaximisedWidget(h);return o.createElement(o.Fragment,null,o.createElement(Nn.oW,(0,tn.A)({},r,{className:"mx_BaseCard_header_title_button--option",onClick:l,title:(0,c._t)("right_panel|thread_list|context_menu_label"),isExpanded:s,ref:a})),s&&o.createElement(Qa.Ay,(0,tn.A)({onFinished:d,className:"mx_RoomTile_contextMenu",compact:!0,rightAligned:!0},{left:(g=a.current.getBoundingClientRect()).left+window.scrollX+g.width,top:g.bottom+window.scrollY,chevronFace:Nn.t4.None}),o.createElement(Qa.tx,null,p&&o.createElement(Qa.R$,{onClick:e=>u(e),label:(0,c._t)("timeline|mab|view_in_room"),iconClassName:"mx_ThreadPanel_viewInRoom"}),n&&o.createElement(Qa.R$,{onClick:e=>m(e),label:(0,c._t)("timeline|mab|copy_link_thread"),iconClassName:"mx_ThreadPanel_copyLinkToThread"}))));var g};const gR=({parent:e,onFileDrop:t,room:n})=>{const[i,r]=(0,o.useState)({dragging:!1,counter:0}),s=(0,Jo.U)(n,e=>e.maySendMessage(n.client.getUserId()));return(0,o.useEffect)(()=>{if(!s||!e||e.ondrop)return;const n=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&r(t=>({counter:t.counter+1,dragging:!(!e.dataTransfer.types.includes("Files")&&!e.dataTransfer.types.includes("application/x-moz-file"))||t.dragging}))},i=e=>{e.stopPropagation(),e.preventDefault(),r(e=>({counter:e.counter-1,dragging:!(e.counter<=1)&&e.dragging}))},o=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy"))},a=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(t(e.dataTransfer),r(e=>({dragging:!1,counter:e.counter-1})))};return null==e||e.addEventListener("drop",a),null==e||e.addEventListener("dragover",o),null==e||e.addEventListener("dragenter",n),null==e||e.addEventListener("dragleave",i),()=>{null==e||e.removeEventListener("drop",a),null==e||e.removeEventListener("dragover",o),null==e||e.removeEventListener("dragenter",n),null==e||e.removeEventListener("dragleave",i)}},[e,t,s]),s&&i.dragging?o.createElement("div",{className:"mx_FileDropTarget"},o.createElement("img",{src:"img/upload-big.103528a.svg",className:"mx_FileDropTarget_image",alt:""}),(0,c._t)("room|drop_file_prompt")):null};var vR,fR,_R=n("./src/dispatcher/payloads/ComposerInsertPayload.ts");function yR(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function bR(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?yR(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):yR(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}class ER extends o.Component{constructor(e){var t;super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"layoutWatcherRef",void 0),(0,S.A)(this,"timelinePanel",(0,o.createRef)()),(0,S.A)(this,"card",(0,o.createRef)()),(0,S.A)(this,"eventId",void 0),(0,S.A)(this,"onAction",e=>{switch(e.phase==cg.n.ThreadView&&e.event&&this.setupThread(e.event),e.action){case W.r.ComposerInsert:if(e.composerType)break;if(e.timelineRenderingType!==kn.Ae.Thread)break;x.A.dispatch(bR(bR({},e),{},{composerType:this.state.editState?_R.D.Edit:_R.D.Send}));break;case W.r.EditEvent:if(e.timelineRenderingType!==kn.Ae.Thread)return;if(e.event&&!e.event.getThread())return;this.setState({editState:e.event?new cR(e.event):void 0},()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))});break;case"reply_to_event":e.context===kn.Ae.Thread&&this.setState({replyToEvent:e.event})}}),(0,S.A)(this,"setupThread",e=>{const t=e.getId();let n=this.props.room.getThread(t);if(!n){const i=[];null===e.status&&i.push(e),n=this.props.room.createThread(t,e,i,!0)}this.updateThread(n)}),(0,S.A)(this,"onNewThread",e=>{e.id===this.props.mxEvent.getId()&&this.setupThread(this.props.mxEvent)}),(0,S.A)(this,"updateThreadRelation",()=>{this.setState({lastReply:this.threadLastReply})}),(0,S.A)(this,"updateThread",e=>{this.state.thread!==e&&(this.setupThreadListeners(e,this.state.thread),e&&this.setState({thread:e,lastReply:this.threadLastReply},async()=>this.postThreadUpdate(e)))}),(0,S.A)(this,"resetJumpToEvent",e=>{var t,n;this.props.initialEvent&&this.props.initialEventScrollIntoView&&e===(null===(t=this.props.initialEvent)||void 0===t?void 0:t.getId())&&x.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId,event_id:null===(n=this.props.initialEvent)||void 0===n?void 0:n.getId(),highlighted:this.props.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0})}),(0,S.A)(this,"onMeasurement",e=>{this.setState({narrow:e})}),(0,S.A)(this,"onKeyDown",e=>{let t=!1;if((0,uo.zM)().getRoomAction(e)===Ei.bY.UploadFile)x.A.dispatch({action:"upload_file",context:kn.Ae.Thread},!0),t=!0;t&&(e.stopPropagation(),e.preventDefault())}),(0,S.A)(this,"onFileDrop",e=>{const t=this.props.mxEvent.getRoomId();t?yS.Ay.sharedInstance().sendContentListToRoom(Array.from(e.files),t,this.threadRelation,f.J.safeGet(),kn.Ae.Thread):console.warn("Unknwon roomId for event",this.props.mxEvent)}),(0,S.A)(this,"renderThreadViewHeader",()=>o.createElement("div",{className:"mx_BaseCard_header_title"},o.createElement(uC.A,{size:"4",className:"mx_BaseCard_header_title_heading"},(0,c._t)("common|thread")),o.createElement(pR,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}))),this.setEventId(this.props.mxEvent);const n=null!==(t=this.props.room.getThread(this.eventId))&&void 0!==t?t:void 0;this.state={layout:O.A.getValue("layout"),narrow:!1,thread:n,lastReply:null==n?void 0:n.lastReply(e=>e.isRelation(i.THREAD_RELATION_TYPE.name)&&!e.status)}}componentDidMount(){this.setupThreadListeners(this.state.thread),this.layoutWatcherRef=O.A.watchSetting("layout",null,(...[,,,e])=>this.setState({layout:e})),this.state.thread&&this.postThreadUpdate(this.state.thread),this.setupThread(this.props.mxEvent),this.dispatcherRef=x.A.register(this.onAction),this.props.room.on(i.ThreadEvent.New,this.onNewThread)}componentWillUnmount(){var e;x.A.unregister(this.dispatcherRef);const t=this.props.mxEvent.getRoomId();O.A.unwatchSetting(this.layoutWatcherRef);const n=as.M.instance.roomViewStore.getRoomId()!==t;this.props.initialEvent&&!n&&x.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId,metricsTrigger:void 0}),x.A.dispatch({action:W.r.ViewThread,thread_id:null}),null===(e=this.state.thread)||void 0===e||e.off(i.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(i.RoomEvent.LocalEchoUpdated,this.updateThreadRelation),this.props.room.removeListener(i.ThreadEvent.New,this.onNewThread)}componentDidUpdate(e){e.mxEvent!==this.props.mxEvent&&(this.setEventId(this.props.mxEvent),this.setupThread(this.props.mxEvent)),e.room!==this.props.room&&lg.A.instance.setCard({phase:cg.n.RoomSummary})}setEventId(e){if(!e.getId())throw new Error("Got thread event without id");this.eventId=e.getId()}get threadLastReply(){var e,t;return null!==(e=null===(t=this.state.thread)||void 0===t?void 0:t.lastReply(e=>e.isRelation(i.THREAD_RELATION_TYPE.name)&&!e.status))&&void 0!==e?e:void 0}async postThreadUpdate(e){var t,n;x.A.dispatch({action:W.r.ViewThread,thread_id:e.id}),e.emit(i.ThreadEvent.ViewThread),this.updateThreadRelation(),null===(t=this.timelinePanel.current)||void 0===t||t.refreshTimeline(null===(n=this.props.initialEvent)||void 0===n?void 0:n.getId())}setupThreadListeners(e,t){var n;t&&(null===(n=this.state.thread)||void 0===n||n.off(i.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.off(i.RoomEvent.LocalEchoUpdated,this.updateThreadRelation));e&&(e.on(i.ThreadEvent.NewReply,this.updateThreadRelation),this.props.room.on(i.RoomEvent.LocalEchoUpdated,this.updateThreadRelation))}get threadRelation(){var e,t,n,r;const o={rel_type:i.THREAD_RELATION_TYPE.name,event_id:null===(e=this.state.thread)||void 0===e?void 0:e.id,is_falling_back:!0},s=null!==(t=null===(n=this.state.lastReply)||void 0===n?void 0:n.getId())&&void 0!==t?t:null===(r=this.state.thread)||void 0===r?void 0:r.id;return s&&(o["m.in_reply_to"]={event_id:s}),o}render(){var e,t,n,i;const r=this.props.isInitialEventHighlighted?null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId():void 0,a=this.threadRelation;let l;var c;this.state.thread?(this.props.initialEvent&&this.props.initialEvent.getRoomId()!==this.state.thread.roomId&&s.vF.warn("ThreadView attempting to render TimelinePanel with mismatched initialEvent",this.state.thread.roomId,this.props.initialEvent.getRoomId(),this.props.initialEvent.getId()),l=o.createElement(o.Fragment,null,o.createElement(gR,{parent:this.card.current,onFileDrop:this.onFileDrop,room:this.props.room}),o.createElement(Sk,{key:this.state.thread.id,ref:this.timelinePanel,showReadReceipts:this.context.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!0,sendReadReceiptOnLoad:!0,timelineSet:this.state.thread.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===Zt.P.Bubble?Zt.P.Bubble:Zt.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(c=this.props.initialEvent)||void 0===c?void 0:c.getId(),highlightedEventId:r,eventScrollIntoView:this.props.initialEventScrollIntoView,onEventScrolledIntoView:this.resetJumpToEvent}))):l=o.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.createElement(le.A,null));return o.createElement(yr.yw,(0,tn.A)({},this.context,{timelineRenderingType:kn.Ae.Thread,threadId:null===(t=this.state.thread)||void 0===t?void 0:t.id,liveTimeline:null===(n=this.state)||void 0===n||null===(n=n.thread)||void 0===n||null===(n=n.timelineSet)||void 0===n?void 0:n.getLiveTimeline(),narrow:this.state.narrow}),o.createElement(KS.A,{className:me()("mx_ThreadView mx_ThreadPanel",{mx_ThreadView_narrow:this.state.narrow}),onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderThreadViewHeader(),ref:this.card,onKeyDown:this.onKeyDown,onBack:e=>{Si.A.trackInteraction("WebThreadViewBackButton",e)}},o.createElement(xk,{sensor:this.card,onMeasurement:this.onMeasurement}),o.createElement("div",{className:"mx_ThreadView_timelinePanelWrapper"},l),yS.Ay.sharedInstance().getCurrentUploads(a).length>0&&o.createElement(mR,{room:this.props.room,relation:a}),(null===(i=this.state.thread)||void 0===i?void 0:i.timelineSet)&&o.createElement(lR,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,relation:a,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}function wR(){return wR=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},wR.apply(null,arguments)}(0,S.A)(ER,"contextType",kn.Ay);var SR=function(e,t){return o.createElement("svg",wR({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0,ref:t},e),vR||(vR=o.createElement("path",{stroke:"#656D77",strokeLinecap:"round",strokeWidth:1.5,d:"M1.75 2h12.5M1.75 6h12.5M1.75 10h6.5"})),fR||(fR=o.createElement("path",{stroke:"#656D77",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"m6.172 13 2.121 2.121 5.657-5.657"})))},xR=(0,o.forwardRef)(SR);var AR=n("./src/accessibility/context_menu/ContextMenuButton.tsx");let CR=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});const kR=({label:e,description:t,onClick:n,isSelected:i})=>o.createElement(Nn.sH,{active:i,className:"mx_ThreadPanel_Header_FilterOptionItem",onClick:n},o.createElement("span",null,e),o.createElement("span",null,t)),RR=({filterOption:e,setFilterOption:t})=>{const n=(0,ce.nH)(),i=(0,yr.ME)("room"),[r,a,l,d]=(0,Nn.EF)(),u=[{label:(0,c._t)("threads|all_threads"),description:(0,c._t)("threads|all_threads_description"),key:CR.All},{label:(0,c._t)("threads|my_threads"),description:(0,c._t)("threads|my_threads_description"),key:CR.My}],m=u.find(t=>t.key===e),h=u.map(e=>o.createElement(kR,{key:e.key,label:e.label,description:e.description,onClick:()=>{t(e.key),d()},isSelected:e===m})),p=r?o.createElement(Nn.Ay,{top:108,right:33,onFinished:d,chevronFace:Nn.t4.Top,wrapperClassName:"mx_BaseCard_header_title"},h):null,g=o.useCallback(e=>{Si.A.trackInteraction("WebThreadsMarkAllReadButton",e),i.room?(0,dr.G9)(i.room,n).catch(e=>{s.vF.error("Failed to mark all threads read",e)}):s.vF.error("No room in context to mark all threads read")},[i.room,n]);return o.createElement("div",{className:"mx_ThreadPanelHeader"},o.createElement(rn.m,{label:(0,c._t)("threads|mark_all_read")},o.createElement(rg.K,{onClick:g,size:"28px"},o.createElement(xR,{height:20,width:20}))),o.createElement("div",{className:"mx_ThreadPanel_vertical_separator"}),o.createElement(AR.V,{className:"mx_ThreadPanel_dropdown",ref:a,isExpanded:r,onClick:e=>{l(),Si.A.trackInteraction("WebRightPanelThreadPanelFilterDropdown",e)}},`${(0,c._t)("threads|show_thread_filter")} ${null==m?void 0:m.label}`),p)},IR=({roomId:e,onClose:t,permalinkCreator:n})=>{var r,s,a;const l=(0,o.useContext)(ce.Ay),d=(0,o.useContext)(kn.Ay),u=(0,o.useRef)(null),m=(0,o.useRef)(null),h=(0,o.useRef)(null),[p,g]=(0,o.useState)(CR.All),[v,f]=(0,o.useState)(null),[_,y]=(0,o.useState)(!1),b=p===CR.My?null==v?void 0:v.threadsTimelineSets[1]:null==v?void 0:v.threadsTimelineSets[0],E=Boolean(null==v||null===(r=v.threadsTimelineSets)||void 0===r||null===(r=r[0])||void 0===r||null===(r=r.getLiveTimeline())||void 0===r||null===(r=r.getEvents())||void 0===r?void 0:r.length);return(0,o.useEffect)(()=>{const t=l.getRoom(e);null==t||t.createThreadsTimelineSets().then(()=>t.fetchRoomThreads()).then(()=>{g(CR.All),f(t)})},[l,e]),(0,o.useEffect)(()=>{var e;b&&!i.Thread.hasServerSideSupport&&(null===(e=u.current)||void 0===e||e.refreshTimeline())},[b,u]),o.createElement(yr.yw,(0,tn.A)({},d,{timelineRenderingType:kn.Ae.ThreadsList,showHiddenEvents:!0,narrow:_}),o.createElement(KS.A,{header:(0,c._t)("common|threads"),id:"thread-panel",className:"mx_ThreadPanel",ariaLabelledBy:"thread-panel-tab",role:"tabpanel",onClose:t,withoutScrollContainer:!0,ref:m,closeButtonRef:h},E&&o.createElement(RR,{filterOption:p,setFilterOption:g}),o.createElement(xk,{sensor:m,onMeasurement:y}),b?o.createElement(Sk,{key:p+":"+(null!==(s=null===(a=b.getFilter())||void 0===a?void 0:a.filterId)&&void 0!==s?s:e),ref:u,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:b,showUrlPreview:!1,empty:o.createElement(Ak,{Icon:Bn.A,title:(0,c._t)("threads|empty_title"),description:(0,c._t)("threads|empty_description",{replyInThread:(0,c._t)("action|reply_in_thread")})}),alwaysShowTimestamps:!0,layout:Zt.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!1,className:"mx_RoomView_messagePanel",membersLoaded:!0,permalinkCreator:n,disableGrouping:!0}):o.createElement("div",{className:"mx_AutoHideScrollbar"},o.createElement(le.A,null))))};function TR(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12 3c7 0 7 7 7 7v6l1.293 1.293c.63.63.184 1.707-.707 1.707H4.414c-.89 0-1.337-1.077-.707-1.707L5 16v-6s0-7 7-7m5 7.01v-.022l-.009-.146a7 7 0 0 0-.073-.607 6.6 6.6 0 0 0-.582-1.84c-.319-.638-.766-1.215-1.398-1.637C14.318 5.344 13.4 5 12 5s-2.317.344-2.937.758c-.633.422-1.08.999-1.4 1.636a6.6 6.6 0 0 0-.58 1.841A7 7 0 0 0 7 9.988v6.84L6.828 17h10.344L17 16.828zM12 22a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2"})})}TR.displayName="NotificationsIcon";const PR=(0,o.forwardRef)(TR);class NR extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"card",o.createRef()),(0,S.A)(this,"onMeasurement",e=>{this.setState({narrow:e})}),this.state={narrow:!1}}render(){const e=o.createElement(Ak,{Icon:PR,title:(0,c._t)("notif_panel|empty_heading"),description:(0,c._t)("notif_panel|empty_description")});let t;const n=f.J.safeGet().getNotifTimelineSet();return n?t=o.createElement(Sk,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:n,showUrlPreview:!1,empty:e,alwaysShowTimestamps:!0,layout:Zt.P.Group}):(s.vF.error("No notifTimelineSet available!"),t=o.createElement(le.A,null)),o.createElement(yr.yw,(0,tn.A)({},this.context,{timelineRenderingType:kn.Ae.Notification,narrow:this.state.narrow}),o.createElement(KS.A,{header:(0,c._t)("notifications|enable_prompt_toast_title"),className:"mx_ThreadPanel",onClose:this.props.onClose,withoutScrollContainer:!0},o.createElement(xk,{sensor:this.card,onMeasurement:this.onMeasurement}),t))}}(0,S.A)(NR,"contextType",kn.Ay);var DR=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/visibility-on.js");function MR(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M14.597 5.708a1.004 1.004 0 0 1 0-1.416.996.996 0 0 1 1.412 0l4.699 4.714c.39.391.39 1.025 0 1.416l-4.7 4.714a.996.996 0 0 1-1.411 0 1.004 1.004 0 0 1 0-1.416l3.043-3.053H8.487c-1.888 0-3.485 1.604-3.485 3.666C5.002 16.396 6.599 18 8.487 18h2.093a1 1 0 1 1 0 2H8.487c-3.067 0-5.485-2.575-5.485-5.667S5.42 8.667 8.487 8.667h9.059z"})})}MR.displayName="ForwardIcon";const OR=(0,o.forwardRef)(MR);var FR=n("./src/components/views/messages/MessageEvent.tsx"),LR=n("./src/events/forward/getForwardableEvent.ts"),UR=(n("./src/events/location/getShareableLocationEvent.ts"),n("./src/components/views/dialogs/ConfirmRedactDialog.tsx"));function BR({event:e,room:t,permalinkCreator:n}){var i,r;const s=e.getSender();if(!s)throw new Error("Pinned event unexpectedly has no sender");const a=Boolean(e.threadRootId),l=!e.isThreadRoot&&a;return o.createElement("div",{className:"mx_PinnedEventTile",role:"listitem"},o.createElement("div",null,o.createElement(bn.A,{className:"mx_PinnedEventTile_senderAvatar",member:e.sender,size:"32px",fallbackUserId:s})),o.createElement("div",{className:"mx_PinnedEventTile_wrapper"},o.createElement("div",{className:"mx_PinnedEventTile_top"},o.createElement(rn.m,{label:(null===(i=e.sender)||void 0===i?void 0:i.name)||s},o.createElement("span",{className:me()("mx_PinnedEventTile_sender",(0,sn.yJ)(s))},(null===(r=e.sender)||void 0===r?void 0:r.name)||s)),o.createElement(VR,{event:e,room:t,permalinkCreator:n})),o.createElement(FR.A,{mxEvent:e,maxImageHeight:150,permalinkCreator:n,replacingEventId:e.replacingEventId()}),l&&o.createElement("div",{className:"mx_PinnedEventTile_thread"},o.createElement(Bn.A,null),(0,c._t)("right_panel|pinned_messages|reply_thread",{},{link:n=>o.createElement("button",{type:"button",onClick:()=>{if(!e.threadRootId)return;const n=t.findEventById(e.threadRootId);n&&x.A.dispatch({action:W.r.ShowThread,rootEvent:n,push:!0})}},n)}))))}function VR({event:e,room:t,permalinkCreator:n}){var r;const[s,a]=(0,o.useState)(!1),l=(0,ce.nH)(),d=(0,o.useCallback)(()=>{Si.A.trackInteraction("PinnedMessageListViewTimeline"),x.A.dispatch({action:W.r.ViewRoom,event_id:e.getId(),highlighted:!0,room_id:e.getRoomId(),metricsTrigger:void 0})},[e]),u=(0,Jo.U)(t,()=>wi.A.canUnpin(l,e)),m=(0,o.useCallback)(async()=>{await wi.A.pinOrUnpinEvent(l,e),Si.A.trackPinUnpinMessage("Unpin","MessagePinningList")},[e,l]),h=(0,gn.qe)(e)&&(0,LR.e)(e,l),p=(0,o.useCallback)(()=>{h&&x.A.dispatch({action:W.r.OpenForwardDialog,event:h,permalinkCreator:n})},[h,n]),g=(null===(r=t.getLiveTimeline().getState(i.EventTimeline.FORWARDS))||void 0===r?void 0:r.maySendRedactionForEvent(e,l.getSafeUserId()))&&e.getType()!==i.EventType.RoomServerAcl&&e.getType()!==i.EventType.RoomEncryption,v=(0,o.useCallback)(()=>(0,UR.Q)({mxEvent:e}),[e]);return o.createElement(ng.W,{open:s,onOpenChange:a,showTitle:!1,title:(0,c._t)("right_panel|pinned_messages|menu"),side:"right",align:"start",trigger:o.createElement(rg.K,{size:"24px","aria-label":(0,c._t)("right_panel|pinned_messages|menu")},o.createElement(Un,null))},o.createElement(ig.D,{Icon:DR.A,label:(0,c._t)("right_panel|pinned_messages|view"),onSelect:d}),u&&o.createElement(ig.D,{Icon:jn,label:(0,c._t)("action|unpin"),onSelect:m}),h&&o.createElement(ig.D,{Icon:OR,label:(0,c._t)("action|forward"),onSelect:p}),g&&o.createElement(o.Fragment,null,o.createElement(sf.w,null),o.createElement(ig.D,{kind:"critical",Icon:Wn.A,label:(0,c._t)("action|delete"),onSelect:v})))}function jR({matrixClient:e,roomId:t,onFinished:n}){return o.createElement(X.A,{hasCancel:!0,title:(0,c._t)("right_panel|pinned_messages|unpin_all|title"),titleClass:"mx_UnpinAllDialog_title",className:"mx_UnpinAllDialog",onFinished:n,fixedWidth:!1},o.createElement(og.E,{as:"span"},(0,c._t)("right_panel|pinned_messages|unpin_all|content")),o.createElement("div",{className:"mx_UnpinAllDialog_buttons"},o.createElement(Ae.$,{destructive:!0,onClick:async()=>{try{await wi.A.unpinAllEvents(e,t),Si.A.trackPinUnpinMessage("Unpin","UnpinAll")}catch(e){s.vF.error("Failed to unpin all events:",e)}n()}},(0,c._t)("action|continue")),o.createElement(Ae.$,{kind:"tertiary",onClick:n},(0,c._t)("action|cancel"))))}function zR({room:e,onClose:t,permalinkCreator:n}){const r=(0,ce.nH)(),s=(0,o.useContext)(kn.Ay),a=GA(e),l=(e=>{const[t,n]=(0,o.useState)(new Set),r=(0,o.useCallback)(t=>{t&&t.getType()!==zA.M||n(KA(e))},[e]);return(0,lr.YK)(e,i.RoomEvent.AccountData,r),(0,o.useEffect)(()=>(n(KA(e)),()=>{n(new Set)}),[e]),t})(e),d=$A(e,a);let u;return(0,o.useEffect)(()=>{if(!r||r.isGuest())return;a.filter(e=>!l.has(e)).length>0&&r.setRoomAccountData(e.roomId,zA.M,{event_ids:a})},[r,e.roomId,a,l]),u=a.length?null!=d&&d.length?o.createElement(HR,{events:(0,ie.Bo)(d),room:e,permalinkCreator:n}):o.createElement(le.A,null):o.createElement(Ak,{Icon:Hn,title:(0,c._t)("right_panel|pinned_messages|empty_title"),description:(0,c._t)("right_panel|pinned_messages|empty_description",{pinAction:(0,c._t)("action|pin")})}),o.createElement(KS.A,{header:(0,c._t)("right_panel|pinned_messages|header",{count:a.length}),className:"mx_PinnedMessagesCard",onClose:t},o.createElement(yr.yw,(0,tn.A)({},s,{timelineRenderingType:kn.Ae.Pinned}),u))}function HR({events:e,room:t,permalinkCreator:n}){const i=(0,ce.nH)(),r=(0,Jo.U)(t,()=>wi.A.userHasPinOrUnpinPermission(i,t)),s=(0,o.useCallback)(async()=>{R.Ay.createDialog(jR,{roomId:t.roomId,matrixClient:i})},[t,i]);return o.createElement(o.Fragment,null,o.createElement("div",{className:me()("mx_PinnedMessagesCard_wrapper",{mx_PinnedMessagesCard_wrapper_unpin_all:r}),role:"list"},e.map((i,r)=>o.createElement(o.Fragment,null,o.createElement(BR,{key:i.getId(),event:i,permalinkCreator:n,room:t}),e.length-1!==r&&o.createElement(sf.w,{key:`separator-${i.getId()}`,className:"mx_PinnedMessagesCard_Separator"})))),r&&o.createElement("div",{className:"mx_PinnedMessagesCard_unpin"},o.createElement(Ae.$,{kind:"tertiary",onClick:s},(0,c._t)("right_panel|pinned_messages|unpin_all|button"))))}const WR=e=>{const t=me()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let n;return e.numUnreadMessages&&(n=o.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),o.createElement("div",{className:t},o.createElement(ae.A,{className:"mx_JumpToBottomButton_scrollDown",title:(0,c._t)("room|jump_to_bottom_button"),onClick:e.onScrollToBottomClick}),n)};class GR extends o.Component{constructor(e){super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"layoutWatcherRef",void 0),(0,S.A)(this,"timelinePanel",o.createRef()),(0,S.A)(this,"card",o.createRef()),(0,S.A)(this,"readReceiptsSettingWatcher",void 0),(0,S.A)(this,"onRoomViewStoreUpdate",async e=>{const t={initialEventId:as.M.instance.roomViewStore.getInitialEventId(),isInitialEventHighlighted:as.M.instance.roomViewStore.isInitialEventHighlighted(),replyToEvent:as.M.instance.roomViewStore.getQuotingEvent()};this.setState(t)}),(0,S.A)(this,"onAction",e=>{if(e.action===W.r.EditEvent)this.setState({editState:e.event?new cR(e.event):void 0},()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))})}),(0,S.A)(this,"onScroll",()=>{const e=this.timelinePanel.current;e&&(e.isAtEndOfLiveTimeline()?this.setState({atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.state.initialEventId&&this.state.isInitialEventHighlighted&&x.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))}),(0,S.A)(this,"onMeasurement",e=>{this.setState({narrow:e})}),(0,S.A)(this,"jumpToLiveTimeline",()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?x.A.dispatch({action:W.r.ViewRoom,room_id:this.props.room.roomId}):(null===(e=this.timelinePanel.current)||void 0===e||e.jumpToLiveTimeline(),x.A.fire(W.r.FocusSendMessageComposer))}),this.state={showReadReceipts:O.A.getValue("showReadReceipts",e.room.roomId),layout:O.A.getValue("layout"),atEndOfLiveTimeline:!0,narrow:!1}}componentDidMount(){as.M.instance.roomViewStore.addListener(ha.H,this.onRoomViewStoreUpdate),this.dispatcherRef=x.A.register(this.onAction),this.readReceiptsSettingWatcher=O.A.watchSetting("showReadReceipts",null,(...[,,,e])=>this.setState({showReadReceipts:e})),this.layoutWatcherRef=O.A.watchSetting("layout",null,(...[,,,e])=>this.setState({layout:e}))}componentWillUnmount(){as.M.instance.roomViewStore.removeListener(ha.H,this.onRoomViewStoreUpdate),O.A.unwatchSetting(this.readReceiptsSettingWatcher),O.A.unwatchSetting(this.layoutWatcherRef),x.A.unregister(this.dispatcherRef)}render(){var e,t;const n=this.state.isInitialEventHighlighted?this.state.initialEventId:void 0;let r;this.state.atEndOfLiveTimeline||(r=o.createElement(WR,{highlight:this.props.room.getUnreadNotificationCount(i.NotificationCountType.Highlight)>0,onScrollToBottomClick:this.jumpToLiveTimeline}));const s=yS.Ay.sharedInstance().getCurrentUploads(this.props.composerRelation).length>0,a=this.props.room.getMyMembership()===Xt.O.Join;return o.createElement(yr.yw,(0,tn.A)({},this.context,{timelineRenderingType:null!==(e=this.props.timelineRenderingType)&&void 0!==e?e:this.context.timelineRenderingType,liveTimeline:null===(t=this.props.timelineSet)||void 0===t?void 0:t.getLiveTimeline(),narrow:this.state.narrow}),o.createElement(KS.A,{className:this.props.classNames,onClose:this.props.onClose,withoutScrollContainer:!0,header:(0,c._t)("right_panel|video_room_chat|title"),ref:this.card},o.createElement(xk,{sensor:this.card,onMeasurement:this.onMeasurement}),o.createElement("div",{className:"mx_TimelineCard_timeline"},r,o.createElement(Sk,{ref:this.timelinePanel,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!1,sendReadReceiptOnLoad:!0,timelineSet:this.props.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===Zt.P.Bubble?Zt.P.Bubble:Zt.P.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:this.state.initialEventId,resizeNotifier:this.props.resizeNotifier,highlightedEventId:n,onScroll:this.onScroll})),s&&o.createElement(mR,{room:this.props.room,relation:this.props.composerRelation}),a&&o.createElement(lR,{room:this.props.room,relation:this.props.composerRelation,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}}(0,S.A)(GR,"contextType",kn.Ay);var KR=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/plus.js");const qR=({app:e,room:t})=>{const n=iC.A.getWidgetName(e),[i,r]=(0,o.useState)();(0,o.useEffect)(()=>{r(iC.A.canUserModifyWidgets(t.client,t.roomId))},[t.client,t.roomId]);const s=YC.aK.instance.isInContainer(t,e,YC.mc.Top),a=s?()=>{YC.aK.instance.moveToContainer(t,e,YC.mc.Right)}:()=>{YC.aK.instance.moveToContainer(t,e,YC.mc.Top)},[l,d,u,m]=(0,Nn.EF)();let h;if(l){var p,g,v;const t=null===(p=d.current)||void 0===p?void 0:p.getBoundingClientRect(),n=null!==(g=null==t?void 0:t.right)&&void 0!==g?g:0,i=null!==(v=null==t?void 0:t.top)&&void 0!==v?v:0;h=o.createElement(ak,{chevronFace:Nn.t4.None,right:Ja.A.instance.windowWidth-n,bottom:Ja.A.instance.windowHeight-i,onFinished:m,app:e})}const f=!s&&!YC.aK.instance.canAddToContainer(t,YC.mc.Top);let _;_=f?(0,c._t)("right_panel|pinned_messages|limits",{count:YC.yQ}):s?(0,c._t)("action|unpin"):(0,c._t)("action|pin");const y=YC.aK.instance.isInContainer(t,e,YC.mc.Center);let b="";s?b=(0,c._t)("widget|unpin_to_view_right_panel"):y&&(b=(0,c._t)("widget|close_to_view_right_panel"));const E=me()("mx_BaseCard_Button mx_ExtensionsCard_Button",{mx_ExtensionsCard_Button_pinned:s});return o.createElement("div",{className:E,ref:d},o.createElement(ae.A,{className:"mx_ExtensionsCard_icon_app",onClick:()=>{lg.A.instance.pushCard({phase:cg.n.Widget,state:{widgetId:e.id}})},title:s||y?b:void 0,disabled:s||y},o.createElement(ck,{app:e,size:"24px"}),o.createElement(og.E,{size:"md",weight:"medium",className:"mx_lineClamp"},n)),i&&o.createElement(Nn.oW,{className:"mx_ExtensionsCard_app_options",isExpanded:l,onClick:u,title:(0,c._t)("common|options")}),o.createElement(ae.A,{className:"mx_ExtensionsCard_app_pinToggle",onClick:a,title:_,disabled:f}),h)},$R=({room:e,onClose:t})=>{const n=(0,iC.X)(e),i=(0,o.useMemo)(()=>n.filter(e=>void 0!==e.eventId),[n]);let r;if(i.length<1)r=o.createElement(Ak,{Icon:BS,title:(0,c._t)("right_panel|extensions_empty_title"),description:(0,c._t)("right_panel|extensions_empty_description",{addIntegrations:(0,c._t)("right_panel|add_integrations")})});else{let t=null;YC.aK.instance.canCopyLayoutToRoom(e)&&(t=o.createElement(wS.N,{onClick:()=>YC.aK.instance.copyLayoutToRoom(e)},(0,c._t)("widget|set_room_layout"))),r=o.createElement(o.Fragment,null,o.createElement(sf.w,null),i.map(t=>o.createElement(qR,{key:t.id,app:t,room:e})),t)}return o.createElement(KS.A,{header:(0,c._t)("right_panel|extensions_button"),className:"mx_ExtensionsCard",onClose:t},(0,Ya.g)(It.C.AddIntegrations)&&o.createElement(Ae.$,{size:"sm",onClick:()=>{const t=U.J.sharedInstance();var n;t.hasManager()?null===(n=t.getPrimaryManager())||void 0===n||n.open(e):t.openNoManagerDialog()},kind:"secondary",Icon:KR.A},(0,c._t)("right_panel|add_integrations")),r)};function JR(e){var t,n;const i=null!==(t=an.A.getDisplayUserIdentifier(e.userId,{roomId:e.roomId}))&&void 0!==t?t:e.userId,r=e.getMxcAvatarUrl(),o=null!==(n=r&&(0,Vi.mediaFromMxc)(r).getThumbnailOfSourceHttp(96,96,"crop"))&&void 0!==n?n:void 0,s=e.user;let a;return s&&(a=s.presence||void 0),{member:{roomId:e.roomId,userId:e.userId,displayUserId:i,name:e.name,rawDisplayName:e.rawDisplayName,disambiguate:e.disambiguate,avatarThumbnailUrl:o,powerLevel:e.powerLevel,lastModifiedTime:e.getLastModifiedTime(),presenceState:a,isInvite:e.membership===Xt.O.Invite}}}const YR="SEPARATOR";function XR(e){const t=(0,ce.nH)(),n=(0,o.useMemo)(()=>t.getRoom(e),[e,t]);if(!n)throw new Error(`Room with id ${e} does not exist!`);const r=(0,o.useContext)(as.A),[s,a]=(0,o.useState)(new Map),[l,c]=(0,o.useState)(!0),[d,u]=(0,o.useState)(0),[m,h]=(0,o.useState)(0),p=(0,o.useMemo)(()=>(0,Li.throttle)(async t=>{const{joined:i,invited:o}=await r.memberListStore.loadMemberList(e,t),s=function(e,t){return e.currentState.getStateEvents("m.room.third_party_invite").filter(function(n){var i;return!!(0,da.Qo)(n)&&(!(t&&(null===(i=n.getContent().display_name)||void 0===i||!i.includes(t)))&&!e.currentState.getInviteForThreePidToken(n.getStateKey()))}).map(e=>({threePidInvite:{event:e}}))}(n,t),l=new Map;for(const e of i){const t=JR(e);l.set(e.userId,t)}i.length>0&&(o.length>0||s.length>0)&&l.set(YR,YR);for(const e of o){const t=JR(e);l.set(e.userId,t)}for(const e of s){const t=e.threePidInvite.event.getContent().display_name;l.set(t,e)}a(l),h(i.length+o.length+s.length),t||u(l.size)},500,{leading:!0,trailing:!0}),[r.memberListStore,e,n]),g=(0,o.useMemo)(()=>r.memberListStore.isPresenceEnabled(),[r.memberListStore]),v=(0,o.useCallback)(()=>!!n&&kx(n),[n]),[f,_]=(0,o.useState)(v()),y=(0,o.useCallback)(()=>(null==n?void 0:n.getMyMembership())===Xt.O.Join&&(0,Ya.g)(It.C.InviteUsers),[n]),[b,E]=(0,o.useState)(y());return(0,lr.YK)(t,i.RoomStateEvent.Events,t=>{if(t.getRoomId()===e&&t.getType()===i.EventType.RoomThirdPartyInvite){p();const e=v();_(e)}}),(0,lr.YK)(t,i.RoomStateEvent.Update,t=>{t.roomId===e&&p()}),(0,lr.YK)(t,i.RoomMemberEvent.Name,(t,n)=>{n.roomId===e&&p()}),(0,lr.YK)(t,i.ClientEvent.Room,t=>{t.roomId===e&&p()}),(0,lr.YK)(t,i.RoomEvent.MyMembership,(t,n,i)=>{if(t.roomId===e&&n===Xt.O.Join&&i!==Xt.O.Join){p();const e=y();E(e)}}),(0,lr.YK)(t,i.UserEvent.Presence,(e,t)=>{s.has(t.userId)&&p()}),(0,lr.YK)(t,i.UserEvent.CurrentlyActive,(e,t)=>{s.has(t.userId)&&p()}),(0,o.useEffect)(()=>{(async()=>{await p(),c(!1)})()},[p]),{members:Array.from(s.values()),memberCount:m,search:p,shouldShowInvite:b,isPresenceEnabled:g,isLoading:l,onInviteButtonClick:e=>{Si.A.trackInteraction("WebRightPanelMemberListInviteButton",e),e.preventDefault(),JA(n)},shouldShowSearch:d>=20,canInvite:f}}let QR=function(e){return e.Creator="creator",e.Admin="admin",e.Moderator="moderator",e}({});const ZR={[QR.Creator]:(0,c.AO)("power_level|creator"),[QR.Admin]:(0,c.AO)("power_level|admin"),[QR.Moderator]:(0,c.AO)("power_level|moderator")};var eI=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/verified.js");const tI=({status:e})=>{const t=Pk.g[e],n=t?(0,c._t)(t):"",i=function(e){switch(e){case qS.z.Normal:return;case qS.z.Verified:return o.createElement(eI.A,{height:"16px",width:"16px",className:"mx_E2EIconView_verified"});case qS.z.Warning:return o.createElement(Te.A,{height:"16px",width:"16px",className:"mx_E2EIconView_warning"})}}(e);return i?o.createElement(rn.m,{label:n},o.createElement("div",{className:"mx_E2EIconView"},i)):null},nI=new Ui.qr("busy","org.matrix.msc3026.busy");const iI=({className:e,presenceState:t})=>{const n=me()("mx_PresenceIconView",e);return o.createElement("div",{className:n},function(e){switch(e){case"online":return o.createElement($f,{height:"8px",width:"8px",className:"mx_PresenceIconView_online"});case"offline":return o.createElement(Yf,{height:"8px",width:"8px",className:"mx_PresenceIconView_offline"});case"unavailable":case"io.element.unreachable":return o.createElement($f,{height:"8px",width:"8px",className:"mx_PresenceIconView_unavailable"});case nI.name:case nI.altName:return o.createElement(Qf,{height:"8px",width:"8px",className:"mx_PresenceIconView_dnd"});default:throw new Error(`Presence state "${e}" is unknown.`)}}(t))};function rI(e){let t;e.userLabel&&(t=o.createElement("div",{className:"mx_MemberTileView_userLabel"},e.userLabel));const n=(0,o.useRef)(null);return(0,o.useEffect)(()=>{var t;e.focused&&(null===(t=n.current)||void 0===t||t.focus({preventScroll:!0,focusVisible:!0}))},[e.focused]),o.createElement("div",null,o.createElement(ae.A,{ref:n,className:"mx_MemberTileView",onClick:e.onClick,onFocus:e.onFocus,"aria-label":null==e?void 0:e.ariaLabel,tabIndex:e.tabIndex,role:"option","aria-posinset":e.memberIndex+1,"aria-setsize":e.memberCount},o.createElement("div",{"aria-hidden":!0,className:"mx_MemberTileView_left"},o.createElement("div",{className:"mx_MemberTileView_avatar"},e.avatarJsx," ",e.presenceJsx),o.createElement("div",{className:"mx_MemberTileView_name"},e.nameJsx)),o.createElement("div",{"aria-hidden":!0,className:"mx_MemberTileView_right"},t,e.iconJsx)))}function oI(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M10 12q-1.65 0-2.825-1.175T6 8t1.175-2.825T10 4t2.825 1.175T14 8t-1.175 2.825T10 12m-8 6v-.8q0-.85.438-1.562.437-.713 1.162-1.088a14.8 14.8 0 0 1 3.15-1.163A13.8 13.8 0 0 1 10 13q1.65 0 3.25.387 1.6.388 3.15 1.163.724.375 1.163 1.087Q18 16.35 18 17.2v.8q0 .824-.587 1.413A1.93 1.93 0 0 1 16 20H4q-.824 0-1.412-.587A1.93 1.93 0 0 1 2 18m15-7h2v2q0 .424.288.713.287.287.712.287.424 0 .712-.287A.97.97 0 0 0 21 13v-2h2q.424 0 .712-.287A.97.97 0 0 0 24 10a.97.97 0 0 0-.288-.713A.97.97 0 0 0 23 9h-2V7a.97.97 0 0 0-.288-.713A.97.97 0 0 0 20 6a.97.97 0 0 0-.712.287A.97.97 0 0 0 19 7v2h-2a.97.97 0 0 0-.712.287A.97.97 0 0 0 16 10q0 .424.288.713.287.287.712.287"})})}oI.displayName="UserAddSolidIcon";const sI=(0,o.forwardRef)(oI);function aI({isThreePid:e}){const t=e?Df:sI;return o.createElement(Fe.s,{align:"center",className:"mx_InvitedIconView"},o.createElement(t,{height:"16px",width:"16px"}))}function lI(e){const t=function(e){const[t,n]=(0,o.useState)();(0,o.useEffect)(()=>{const t=f.J.safeGet(),r=async()=>{var i;const{userId:r}=e.member,o=r===t.getUserId(),s=await(null===(i=t.getCrypto())||void 0===i?void 0:i.getUserVerificationStatus(r));if(null==s||!s.isCrossSigningVerified())return void n(null!=s&&s.wasCrossSigningVerified()?qS.z.Warning:qS.z.Normal);const a=await(0,Tt.a)(t,r),l=await(0,ie.rm)(a,async e=>{var n;const i=await(null===(n=t.getCrypto())||void 0===n?void 0:n.getDeviceVerificationStatus(r,e));return!i||(o?!i.crossSigningVerified:!i.isVerified())});n(l?qS.z.Warning:qS.z.Verified)},o=n=>{if(n.getType()!==i.EventType.RoomEncryption)return;const{roomId:s}=e.member;n.getRoomId()===s&&(t.removeListener(i.RoomStateEvent.Events,o),r())},s=(t,n)=>{t===e.member.userId&&r()},{roomId:a}=e.member;return a&&(t.isRoomEncrypted(a)?(t.on(V.cr.UserTrustStatusChanged,s),r()):t.on(i.RoomStateEvent.Events,o)),()=>{t&&(t.removeListener(i.RoomStateEvent.Events,o),t.removeListener(V.cr.UserTrustStatusChanged,s))}},[e.member]);const r=e.member,s=e.member.name,a=new Map([[1/0,QR.Creator],[100,QR.Admin],[50,QR.Moderator]]);let l,d=e.member.powerLevel;for(const[t]of a)if(e.member.powerLevel>=t){d=t;break}const u=a.get(d);return u&&(l=(0,c._t)(ZR[u])),e.member.isInvite&&(l=(0,c._t)("member_list|invited_label")),{member:r,name:s,onClick:()=>{x.A.dispatch({action:W.r.ViewUser,member:e.member,push:!0})},e2eStatus:t,showPresence:e.showPresence,userLabel:l}}(e),n=t.member,r=o.createElement(Xp.A,{size:"32px",name:n.name,idName:n.userId,title:n.displayUserId,url:n.avatarThumbnailUrl,altText:(0,c._t)("common|user_avatar")}),s=t.name,a=o.createElement(ln,{withTooltip:!0,member:n,fallbackName:s||""}),l=n.presenceState;let d,u;return t.showPresence&&l&&(d=o.createElement(iI,{presenceState:l})),t.e2eStatus&&(u=o.createElement(tI,{status:t.e2eStatus})),n.isInvite&&(u=o.createElement(aI,{isThreePid:!1})),o.createElement(rI,{onClick:t.onClick,onFocus:e.onFocus,avatarJsx:r,presenceJsx:d,nameJsx:a,userLabel:t.userLabel,ariaLabel:s,iconJsx:u,focused:e.focused,tabIndex:e.tabIndex,memberIndex:e.index-(n.isInvite?1:0),memberCount:e.memberCount})}function cI(e){const t=function(e){const t=e.threePidInvite;return{name:t.event.getContent().display_name,onClick:()=>{x.A.dispatch({action:W.r.View3pidInvite,event:t.event})},userLabel:(0,c._t)("member_list|invited_label")}}(e),n=o.createElement(Xp.A,{name:t.name,size:"32px","aria-hidden":"true"}),i=o.createElement(aI,{isThreePid:!0}),r=t.name;return o.createElement(rI,{nameJsx:r,avatarJsx:n,onClick:t.onClick,memberIndex:e.memberIndex,memberCount:e.memberCount,ariaLabel:r,userLabel:t.userLabel,iconJsx:i,focused:e.focused,tabIndex:e.tabIndex,onFocus:e.onFocus})}const dI=({canInvite:e,children:t})=>{const n=e?(0,c._t)("action|invite"):(0,c._t)("member_list|invite_button_no_perms_tooltip");return o.createElement(rn.m,{description:n},t)},uI=({vm:e})=>{const t=e.shouldShowInvite,n=e.shouldShowSearch,i=!e.canInvite;return t?n?o.createElement(dI,{canInvite:e.canInvite},o.createElement(Ae.$,{className:"mx_MemberListHeaderView_invite_small",kind:"secondary",onClick:e.onInviteButtonClick,size:"sm",iconOnly:!0,Icon:Hg.A,disabled:i,"aria-label":(0,c._t)("action|invite"),type:"button"})):o.createElement(dI,{canInvite:e.canInvite},o.createElement(Ae.$,{kind:"secondary",size:"sm",Icon:Hg.A,className:"mx_MemberListHeaderView_invite_large",disabled:!e.canInvite,onClick:e.onInviteButtonClick,type:"button"},(0,c._t)("action|invite"))):null};const mI=e=>{const t=e.vm;let n;return n=t.shouldShowSearch?o.createElement(Fe.s,{justify:"center",className:"mx_MemberListHeaderView_container"},o.createElement(MS,{className:"mx_MemberListHeaderView_search mx_no_textinput",name:"searchMembers",placeholder:(0,c._t)("member_list|filter_placeholder"),onChange:e=>t.search(e.target.value)}),o.createElement(uI,{vm:t})):!t.shouldShowSearch&&t.shouldShowInvite?o.createElement(Fe.s,{justify:"center",className:"mx_MemberListHeaderView_container"},o.createElement(uI,{vm:t})):null,o.createElement(Fe.s,{className:"mx_MemberListHeaderView",as:"header",align:"center",justify:"space-between",direction:"column"},!t.isLoading&&n,o.createElement(og.E,{as:"div",size:"sm",weight:"semibold",className:"mx_MemberListHeaderView_label"},function(e){return e.isLoading?o.createElement(Fe.s,{align:"center",gap:"8px"},o.createElement(Ce.Z,null)," ",(0,c._t)("common|loading")):0===e.memberCount?(0,c._t)("member_list|no_matches"):(0,c._t)("member_list|count",{count:e.memberCount})}(t)))},hI=e=>{const t=XR(e.roomId),{isPresenceEnabled:n,memberCount:i}=t,r=(0,o.useCallback)(e=>e===YR?"separator":e.member?`member-${e.member.userId}`:`threePidInvite-${e.threePidInvite.event.getContent().public_key}`,[]),s=(0,o.useCallback)((e,t,s,a)=>{const l=r(t)===s.tabIndexKey,c=l&&s.focused;return t===YR?o.createElement("hr",{className:"mx_MemberListView_separator"}):t.member?o.createElement(lI,{member:t.member,showPresence:n,focused:c,tabIndex:l?0:-1,index:e,memberCount:i,onFocus:a}):o.createElement(cI,{threePidInvite:t.threePidInvite,focused:c,tabIndex:l?0:-1,memberIndex:e-1,memberCount:i,onFocus:a})},[n,r,i]),a=(0,o.useCallback)(e=>e!==YR,[]);return o.createElement(KS.A,{id:"memberlist-panel",className:"mx_MemberListView",ariaLabelledBy:"memberlist-panel-tab",role:"tabpanel",header:(0,c._t)("common|people"),onClose:e.onClose},o.createElement(Fe.s,{align:"stretch",direction:"column",className:"mx_MemberListView_container"},o.createElement(AS.b,{onSubmit:e=>e.preventDefault()},o.createElement(mI,{vm:t})),o.createElement(Jw,{items:t.members,getItemComponent:s,getItemKey:r,isItemFocusable:a,role:"listbox","aria-label":(0,c._t)("member_list|list_title")})))};function pI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}class gI extends o.Component{constructor(e){super(e),(0,S.A)(this,"ref",o.createRef()),(0,S.A)(this,"delayedUpdate",(0,Li.throttle)(()=>{this.forceUpdate()},500,{leading:!0,trailing:!0})),(0,S.A)(this,"onRoomStateMember",(e,t,n)=>{var i;this.props.room&&n.roomId===this.props.room.roomId&&(this.state.phase===cg.n.MemberList||this.state.phase===cg.n.MemberInfo&&n.userId===(null===(i=this.state.cardState)||void 0===i||null===(i=i.member)||void 0===i?void 0:i.userId))&&this.delayedUpdate()}),(0,S.A)(this,"onRightPanelStoreUpdate",()=>{const e=this.state.phase,t=gI.getDerivedStateFromProps(this.props);var n;(this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pI(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pI(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},t)),e!==t.phase)&&(null===(n=this.ref.current)||void 0===n||n.focus())}),(0,S.A)(this,"onClose",()=>{var e,t;if(null!==(e=this.props.overwriteCard)&&void 0!==e&&null!==(e=e.state)&&void 0!==e&&e.member)x.A.dispatch({action:W.r.ViewHomePage});else if(this.state.phase===cg.n.EncryptionPanel&&null!==(t=this.state.cardState)&&void 0!==t&&null!==(t=t.verificationRequest)&&void 0!==t&&t.pending)this.state.cardState.verificationRequest.cancel();else{var n,i;lg.A.instance.togglePanel(null!==(n=null===(i=this.props.room)||void 0===i?void 0:i.roomId)&&void 0!==n?n:null)}}),this.state=gI.getDerivedStateFromProps(e)}componentDidMount(){var e;this.context.on(i.RoomStateEvent.Members,this.onRoomStateMember),lg.A.instance.on(ha.H,this.onRightPanelStoreUpdate),null===(e=this.ref.current)||void 0===e||e.focus()}componentWillUnmount(){var e;null===(e=this.context)||void 0===e||e.removeListener(i.RoomStateEvent.Members,this.onRoomStateMember),lg.A.instance.off(ha.H,this.onRightPanelStoreUpdate)}static getDerivedStateFromProps(e){var t,n,i;let r;return e.room&&(r=lg.A.instance.currentCardForRoom(e.room.roomId)),{cardState:null===(t=r)||void 0===t?void 0:t.state,phase:null!==(n=null===(i=r)||void 0===i?void 0:i.phase)&&void 0!==n?n:void 0}}render(){var e,t,n,r,s;let a=o.createElement("div",null);const l=null===(e=this.props.room)||void 0===e?void 0:e.roomId,d=null!==(t=null===(n=this.props.overwriteCard)||void 0===n?void 0:n.phase)&&void 0!==t?t:this.state.phase,u=null!==(r=null===(s=this.props.overwriteCard)||void 0===s?void 0:s.state)&&void 0!==r?r:this.state.cardState;switch(d){case cg.n.MemberList:l&&(a=o.createElement(hI,{roomId:l,onClose:this.onClose}));break;case cg.n.MemberInfo:case cg.n.EncryptionPanel:if(null!=u&&u.member){var m;const e=u.member instanceof i.RoomMember?u.member:void 0;a=o.createElement(gk.Ay,{user:u.member,room:null!==(m=this.context.getRoom(null==e?void 0:e.roomId))&&void 0!==m?m:this.props.room,key:null!=l?l:u.member.userId,onClose:this.onClose,phase:d,verificationRequest:u.verificationRequest,verificationRequestPromise:u.verificationRequestPromise})}break;case cg.n.ThreePidMemberInfo:null!=u&&u.memberInfoEvent&&(a=o.createElement(vk,{event:u.memberInfoEvent,key:l,onClose:this.onClose}));break;case cg.n.NotificationPanel:a=o.createElement(NR,{onClose:this.onClose});break;case cg.n.PinnedMessages:this.props.room&&(a=o.createElement(zR,{room:this.props.room,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case cg.n.Timeline:this.props.room&&(a=o.createElement(GR,{classNames:"mx_ThreadPanel mx_TimelineCard",room:this.props.room,timelineSet:this.props.room.getUnfilteredTimelineSet(),resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case cg.n.FilePanel:l&&(a=o.createElement(kk,{roomId:l,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose}));break;case cg.n.ThreadView:this.props.room&&null!=u&&u.threadHeadEvent&&(a=o.createElement(ER,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,mxEvent:u.threadHeadEvent,initialEvent:u.initialEvent,isInitialEventHighlighted:u.isInitialEventHighlighted,initialEventScrollIntoView:u.initialEventScrollIntoView,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus}));break;case cg.n.ThreadPanel:this.props.room&&(a=o.createElement(IR,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator}));break;case cg.n.RoomSummary:this.props.room&&(a=o.createElement(nC,{room:this.props.room,permalinkCreator:this.props.permalinkCreator,onSearchChange:this.props.onSearchChange,onSearchCancel:this.props.onSearchCancel,searchTerm:this.props.searchTerm,focusRoomSearch:null==u?void 0:u.focusRoomSearch}));break;case cg.n.Extensions:this.props.room&&(a=o.createElement($R,{room:this.props.room,onClose:this.onClose}));break;case cg.n.Widget:this.props.room&&null!=u&&u.widgetId&&(a=o.createElement(pk,{room:this.props.room,widgetId:u.widgetId,onClose:this.onClose}))}return o.createElement("aside",{"aria-label":(0,c._t)("right_panel|title"),ref:this.ref,className:"mx_RightPanel",id:"mx_RightPanel",tabIndex:-1},a)}}(0,S.A)(gI,"contextType",ce.Ay);class vI{constructor(){(0,S.A)(this,"scrollStateMap",new Map)}getScrollState(e){return this.scrollStateMap.get(e)}setScrollState(e,t){null===t?this.scrollStateMap.delete(e):this.scrollStateMap.set(e,t)}}void 0===window.mxRoomScrollStateStore&&(window.mxRoomScrollStateStore=new vI);const fI=window.mxRoomScrollStateStore;var _I=n("./src/stores/WidgetEchoStore.ts"),yI=n("./node_modules/@matrix-org/react-sdk-module-api/lib/lifecycles/RoomViewLifecycle.js"),bI=n("./src/IdentityAuthClient.tsx");class EI extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"onViewClick",()=>{this.setState({hidden:!1})}),this.state={hidden:!0}}render(){const e=me()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return o.createElement("div",{className:e},o.createElement("div",{className:"mx_InviteReason_reason"},this.props.htmlReason?(0,ji.bk)(this.props.htmlReason):this.props.reason),o.createElement(ae.A,{kind:"link_inline",className:"mx_InviteReason_view",onClick:this.onViewClick},(0,c._t)("common|view_message")))}}var wI=n("./res/img/element-icons/ask-to-join.svg"),SI=n("./src/modules/Api.ts");function xI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function AI(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xI(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xI(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var CI=function(e){return e.NotLoggedIn="NotLoggedIn",e.Joining="Joining",e.Loading="Loading",e.Rejecting="Rejecting",e.Kicked="Kicked",e.Banned="Banned",e.OtherThreePIDError="OtherThreePIDError",e.InvitedEmailNotFoundInAccount="InvitedEmailNotFoundInAccount",e.InvitedEmailNoIdentityServer="InvitedEmailNoIdentityServer",e.InvitedEmailMismatch="InvitedEmailMismatch",e.Invite="Invite",e.ViewingRoom="ViewingRoom",e.RoomNotFound="RoomNotFound",e.OtherError="OtherError",e.PromptAskToJoin="PromptAskToJoin",e.Knocked="Knocked",e.RequestDenied="requestDenied",e}(CI||{});class kI extends o.Component{constructor(e){super(e),(0,S.A)(this,"onLoginClick",()=>{x.A.dispatch({action:"start_login",screenAfterLogin:this.makeScreenAfterLogin()})}),(0,S.A)(this,"onRegisterClick",()=>{x.A.dispatch({action:"start_registration",screenAfterLogin:this.makeScreenAfterLogin()})}),(0,S.A)(this,"onChangeReason",e=>{this.setState({reason:e.target.value})}),this.state={busy:!1}}componentDidMount(){this.checkInvitedEmail()}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this.checkInvitedEmail()}async checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await f.J.safeGet().getThreePids();if(this.setState({accountEmails:e.threepids.filter(e=>"email"===e.medium).map(e=>e.address)}),!f.J.safeGet().getIdentityServerUrl())return void this.setState({busy:!1});const t=new bI.A,n=await t.getAccessToken(),i=await f.J.safeGet().lookupThreePid("email",this.props.invitedEmail,n);if(!("mxid"in i))throw new c.P7("room|error_3pid_invite_email_lookup");this.setState({invitedEmailMxid:i.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}getMessageCase(){if(f.J.safeGet().isGuest())return CI.NotLoggedIn;const e=this.getMyMember();if(e){var t;const n=null===(t=e.events.member)||void 0===t?void 0:t.getPrevContent().membership;if(e.isKicked())return n===Xt.O.Knock?CI.RequestDenied:this.props.promptAskToJoin?CI.PromptAskToJoin:CI.Kicked;if(e.membership===Xt.O.Ban)return CI.Banned}if(this.props.joining)return CI.Joining;if(this.props.rejecting)return CI.Rejecting;if(this.props.loading||this.state.busy)return CI.Loading;if(this.props.knocked)return CI.Knocked;if(this.props.canAskToJoinAndMembershipIsLeave||this.props.promptAskToJoin)return CI.PromptAskToJoin;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return CI.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return CI.InvitedEmailNotFoundInAccount;if(!f.J.safeGet().getIdentityServerUrl())return CI.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=f.J.safeGet().getUserId())return CI.InvitedEmailMismatch}return CI.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?CI.RoomNotFound:CI.OtherError:CI.ViewingRoom}getKickOrBanInfo(){var e,t,n,i;const r=this.getMyMember();if(!r)return{};const o=null===(e=r.events.member)||void 0===e?void 0:e.getSender(),s=o?null===(t=this.props.room)||void 0===t?void 0:t.currentState.getMember(o):void 0;return{memberName:null!==(n=null==s?void 0:s.name)&&void 0!==n?n:o,reason:null===(i=r.events.member)||void 0===i?void 0:i.getContent().reason}}joinRule(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t||null===(t=t.currentState.getStateEvents(i.EventType.RoomJoinRules,""))||void 0===t?void 0:t.getContent().join_rule)&&void 0!==e?e:null}getMyMember(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t?void 0:t.getMember(f.J.safeGet().getSafeUserId()))&&void 0!==e?e:null}getInviteMember(){var e;const{room:t}=this.props;if(!t)return null;const n=f.J.safeGet().getSafeUserId(),i=t.currentState.getMember(n);if(!i)return null;const r=null===(e=i.events.member)||void 0===e?void 0:e.getSender();return r?t.currentState.getMember(r):null}isDMInvite(){var e;const t=this.getMyMember();if(!t)return!1;const n=null===(e=t.events.member)||void 0===e?void 0:e.getContent();return(null==n?void 0:n.membership)===Xt.O.Invite&&n.is_direct}makeScreenAfterLogin(){var e,t,n,i,r,o;return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:null!==(e=null===(t=this.props.oobData)||void 0===t?void 0:t.name)&&void 0!==e?e:null,room_avatar_url:null!==(n=null===(i=this.props.oobData)||void 0===i?void 0:i.avatarUrl)&&void 0!==n?n:null,inviter_name:null!==(r=null===(o=this.props.oobData)||void 0===o?void 0:o.inviterName)&&void 0!==r?r:null}}}render(){var e,t,n,r,s,a;const l=d.Ay.get().brand,u=null!==(e=null!==(t=null===(n=this.props.room)||void 0===n?void 0:n.name)&&void 0!==t?t:this.props.roomAlias)&&void 0!==e?e:"",m=null!==(r=null===(s=this.props.room)||void 0===s?void 0:s.isSpaceRoom())&&void 0!==r?r:(null===(a=this.props.oobData)||void 0===a?void 0:a.roomType)===i.RoomType.Space;let h,p,g,v,y,b,E,w,S,x,A=!1;const C=[],k=this.getMessageCase();switch(k){case CI.Joining:var R;h=null!==(R=this.props.oobData)&&void 0!==R&&R.roomType||m?m?(0,c._t)("room|joining_space"):(0,c._t)("room|joining_room"):(0,c._t)("room|joining"),A=!0;break;case CI.Loading:h=(0,c._t)("common|loading"),A=!0;break;case CI.Rejecting:h=(0,c._t)("room|rejecting"),A=!0;break;case CI.NotLoggedIn:{const e={canJoin:!1};this.props.roomId&&_.r.instance.invoke(yI.J.PreviewRoomNotLoggedIn,e,this.props.roomId),e.canJoin?(h=(0,c._t)("room|join_title"),y=(0,c._t)("action|join"),v=()=>{_.r.instance.invoke(yI.J.JoinFromRoomPreview,this.props.roomId)}):(h=(0,c._t)("room|join_title_account"),O.A.getValue(It.f.Registration)&&(y=(0,c._t)("room|join_button_account"),v=this.onRegisterClick),E=(0,c._t)("action|sign_in"),b=this.onLoginClick),this.props.previewLoading&&(x=o.createElement("div",null,o.createElement(le.A,{w:20,h:20}),(0,c._t)("room|loading_preview")));break}case CI.Kicked:{const{memberName:e,reason:t}=this.getKickOrBanInfo();h=u?(0,c._t)("room|kicked_from_room_by",{memberName:e,roomName:u}):(0,c._t)("room|kicked_by",{memberName:e}),p=t?(0,c._t)("room|kick_reason",{reason:t}):void 0,y=m?(0,c._t)("room|forget_space"):(0,c._t)("room|forget_room"),v=this.props.onForgetClick,this.joinRule()!==i.JoinRule.Invite&&(E=y,b=v,y=(0,c._t)("room|rejoin_button"),v=this.props.onJoinClick);break}case CI.RequestDenied:h=(0,c._t)("room|knock_denied_title"),p=(0,c._t)("room|knock_denied_subtitle"),y=m?(0,c._t)("room|forget_space"):(0,c._t)("room|forget_room"),v=this.props.onForgetClick;break;case CI.Banned:{const{memberName:e,reason:t}=this.getKickOrBanInfo();h=u?(0,c._t)("room|banned_from_room_by",{memberName:e,roomName:u}):(0,c._t)("room|banned_by",{memberName:e}),p=t?(0,c._t)("room|kick_reason",{reason:t}):void 0,y=m?(0,c._t)("room|forget_space"):(0,c._t)("room|forget_room"),v=this.props.onForgetClick;break}case CI.OtherThreePIDError:{var I;h=u?(0,c._t)("room|3pid_invite_error_title_room",{roomName:u}):(0,c._t)("room|3pid_invite_error_title");const e=this.joinRule(),t=(0,c._t)("room|3pid_invite_error_description",{errcode:(null===(I=this.state.threePidFetchError)||void 0===I?void 0:I.errcode)||(0,c._t)("error|unknown_error_code")});switch(e){case"invite":p=[(0,c._t)("room|3pid_invite_error_invite_subtitle"),t],y=(0,c._t)("room|3pid_invite_error_invite_action"),v=this.props.onJoinClick;break;case"public":p=(0,c._t)("room|3pid_invite_error_public_subtitle"),y=(0,c._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;default:p=t,y=(0,c._t)("room|3pid_invite_error_invite_action"),v=this.props.onJoinClick}break}case CI.InvitedEmailNotFoundInAccount:h=u?(0,c._t)("room|3pid_invite_email_not_found_account_room",{roomName:u,email:this.props.invitedEmail}):(0,c._t)("room|3pid_invite_email_not_found_account",{email:this.props.invitedEmail}),p=(0,c._t)("room|link_email_to_receive_3pid_invite",{brand:l}),y=(0,c._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case CI.InvitedEmailNoIdentityServer:h=u?(0,c._t)("room|invite_sent_to_email_room",{roomName:u,email:this.props.invitedEmail}):(0,c._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),p=(0,c._t)("room|3pid_invite_no_is_subtitle",{brand:l}),y=(0,c._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case CI.InvitedEmailMismatch:h=u?(0,c._t)("room|invite_sent_to_email_room",{roomName:u,email:this.props.invitedEmail}):(0,c._t)("room|invite_sent_to_email",{email:this.props.invitedEmail}),p=(0,c._t)("room|invite_email_mismatch_suggestion",{brand:l}),y=(0,c._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case CI.Invite:{var T,P,N;const e=this.isDMInvite(),t=o.createElement(Tn.A,{room:this.props.room,oobData:this.props.oobData}),n=this.getInviteMember(),i=o.createElement("span",{className:"mx_RoomPreviewBar_inviter"},null!==(T=null==n?void 0:n.rawDisplayName)&&void 0!==T?T:this.props.inviterName),r=o.createElement(o.Fragment,null,e?(0,c._t)("room|dm_invite_subtitle",{},{userName:i}):(0,c._t)("room|invite_subtitle",{},{userName:i}),n&&o.createElement(o.Fragment,null,o.createElement("br",null),o.createElement("span",{className:"mx_RoomPreviewBar_inviter_mxid"},n.userId)));var D;if(e)h=(0,c._t)("room|dm_invite_title",{user:null!==(D=null==n?void 0:n.name)&&void 0!==D?D:this.props.inviterName}),y=(0,c._t)("room|dm_invite_action");else h=(0,c._t)("room|invite_title",{roomName:u}),y=(0,c._t)("action|accept");p=[t,r];const s=f.J.safeGet().getSafeUserId(),a=null===(P=this.props.room)||void 0===P?void 0:P.currentState.getMember(s),l=null==a||null===(N=a.events.member)||void 0===N?void 0:N.getContent();null!=l&&l.reason&&(g=o.createElement(EI,{reason:l.reason,htmlReason:l["io.element.html_reason"]})),v=this.props.onJoinClick,E=(0,c._t)("action|decline"),b=this.props.onDeclineClick,S=(0,c._t)("action|decline_and_block"),w=this.props.onDeclineAndBlockClick;break}case CI.ViewingRoom:h=this.props.canPreview?(0,c._t)("room|peek_join_prompt",{roomName:u}):u?(0,c._t)("room|no_peek_join_prompt",{roomName:u}):(0,c._t)("room|no_peek_no_name_join_prompt"),y=(0,c._t)("room|join_the_discussion"),v=this.props.onJoinClick;break;case CI.RoomNotFound:h=u?(0,c._t)("room|not_found_title_name",{roomName:u}):(0,c._t)("room|not_found_title"),p=(0,c._t)("room|not_found_subtitle");break;case CI.OtherError:var M;h=u?(0,c._t)("room|inaccessible_name",{roomName:u}):(0,c._t)("room|inaccessible"),p=[(0,c._t)("room|inaccessible_subtitle_1"),(0,c._t)("room|inaccessible_subtitle_2",{errcode:String(null===(M=this.props.error)||void 0===M?void 0:M.errcode)},{issueLink:e=>o.createElement("a",{href:d.Ay.get().feedback.new_issue_url,target:"_blank",rel:"noreferrer noopener"},e)})];break;case CI.PromptAskToJoin:var F;h=u?(0,c._t)("room|knock_prompt_name",{roomName:u}):(0,c._t)("room|knock_prompt");p=[o.createElement(Tn.A,{room:this.props.room,oobData:this.props.oobData}),(0,c._t)("room|knock_subtitle")],g=o.createElement(wo.A,{autoFocus:!0,className:"mx_RoomPreviewBar_fullWidth",element:"textarea",onChange:this.onChangeReason,placeholder:(0,c._t)("room|knock_message_field_placeholder"),type:"text",value:null!==(F=this.state.reason)&&void 0!==F?F:""}),v=()=>this.props.onSubmitAskToJoin&&this.props.onSubmitAskToJoin(this.state.reason),y=(0,c._t)("room|knock_send_action");break;case CI.Knocked:h=(0,c._t)("room|knock_sent"),p=[o.createElement(o.Fragment,null,o.createElement(wI.I,{className:"mx_Icon mx_Icon_16 mx_RoomPreviewBar_icon"}),(0,c._t)("room|knock_sent_subtitle"))],b=this.props.onCancelAskToJoin,E=(0,c._t)("room|knock_cancel_action")}let L,U,B,V,j;p&&(Array.isArray(p)||(p=[p]),L=p.map((e,t)=>o.createElement("p",{key:`subTitle${t}`},e))),U=A?o.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},o.createElement(le.A,null),h):o.createElement("h3",null,h),v&&(B=o.createElement(ae.A,{kind:"primary",onClick:v},y)),b&&(V=o.createElement(ae.A,{kind:"secondary",onClick:b},E)),w&&(j=o.createElement(Ae.$,{destructive:!0,kind:"tertiary",onClick:w},S));const z=this.props.canPreview,H=me()("mx_RoomPreviewBar",`mx_RoomPreviewBar_${k}`,{mx_RoomPreviewBar_panel:z,mx_RoomPreviewBar_dialog:!z}),W=z?o.createElement(o.Fragment,null,j,V,C,B):o.createElement(o.Fragment,null,B,C,V,j);return o.createElement("div",{role:"complementary",className:H},o.createElement("div",{className:"mx_RoomPreviewBar_message"},U,L),g,o.createElement("div",{className:me()("mx_RoomPreviewBar_actions",{mx_RoomPreviewBar_fullWidth:k===CI.PromptAskToJoin})},W),o.createElement("div",{className:"mx_RoomPreviewBar_footer"},x))}}(0,S.A)(kI,"defaultProps",{onJoinClick(){}});const RI=e=>{const t=SI.A.customComponents.roomPreviewBarRenderer;var n,i,r,s;return t?t(AI(AI({},e),{},{roomId:null!==(n=null===(i=e.room)||void 0===i?void 0:i.roomId)&&void 0!==n?n:e.roomId,roomAlias:null!==(r=null===(s=e.room)||void 0===s?void 0:s.getCanonicalAlias())&&void 0!==r?r:e.roomAlias}),e=>o.createElement(kI,e)):o.createElement(kI,e)},II=(e,t=250)=>{const[n,r]=(0,o.useState)(e.getJoinedMembers()),s=(0,o.useMemo)(()=>(0,Li.throttle)(()=>{r(e.getJoinedMembers())},t,{leading:!0,trailing:!0}),[e,t]);return(0,lr.YK)(e.currentState,i.RoomStateEvent.Members,s),n},TI=(e,{throttleWait:t}={throttleWait:250})=>{const[n,r]=(0,o.useState)(e.getJoinedMemberCount()),s=(0,o.useMemo)(()=>(0,Li.throttle)(()=>{r(e.getJoinedMemberCount())},t,{leading:!0,trailing:!0}),[e,t]);return(0,lr.YK)(e.currentState,i.RoomStateEvent.Members,s),(0,lr.YK)(e,i.RoomEvent.Summary,s),n},PI=e=>{const[t,n]=(0,o.useState)(e.getMyMembership());return(0,lr.YK)(e,i.RoomEvent.MyMembership,()=>{n(e.getMyMembership())}),t};var NI=n("./src/components/views/elements/FacePile.tsx");const DI=["room","onlyKnownUsers","numShown"],MI=5,OI=e=>{var t;return!(null===(t=k.A.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)},FI=e=>{let{room:t,onlyKnownUsers:n=!0,numShown:i=MI}=e,r=(0,v.A)(e,DI);const s=(0,o.useContext)(ce.Ay),a=t.getMyMembership()===Xt.O.Join;let l=II(t);const d=l.length,u=[e=>e.getMxcAvatarUrl()?0:1];n?l=l.filter(OI):u.unshift(e=>OI(e)?0:1);const m=(0,Li.sortBy)(l.filter(e=>e.userId!==s.getUserId()),u).slice(0,i);if(m.length<1)return null;const h=m.map(e=>e.name).reverse().join(", ");return o.createElement(NI.A,(0,tn.A)({members:m,size:"28px",overflow:l.length>i,tooltipLabel:r.onClick?(0,c._t)("room|face_pile_tooltip_label",{count:d}):(0,c._t)("common|n_members",{count:d}),tooltipShortcut:a?(0,c._t)("room|face_pile_tooltip_shortcut_joined",{commaSeparatedMembers:h}):(0,c._t)("room|face_pile_tooltip_shortcut",{commaSeparatedMembers:h})},r),n&&o.createElement("span",{className:"mx_FacePile_summary"},(0,c._t)("room|face_pile_summary",{count:l.length})))},LI=({room:e})=>{const t=(0,mr.e)(async()=>{if(e.getMyMembership()!==Xt.O.Invite)return null;try{return await e.client.getRoomSummary(e.roomId)}catch{return null}},[e]),n=(0,Jo.U)(e,e=>e.getJoinRule()),r=PI(e),s=TI(e);let a,l,d;if((0,Cx.j)(e)?(a="mx_RoomInfoLine_video",l=(0,c._t)("common|video_room")):n===i.JoinRule.Public?(a="mx_RoomInfoLine_public",l=e.isSpaceRoom()?(0,c._t)("common|public_space"):(0,c._t)("common|public_room")):(a="mx_RoomInfoLine_private",l=e.isSpaceRoom()?(0,c._t)("common|private_space"):(0,c._t)("common|private_room")),r===Xt.O.Invite&&t)d=o.createElement("span",{className:"mx_RoomInfoLine_members"},(0,c._t)("common|n_members",{count:t.num_joined_members}));else if(s&&void 0!==t){const e=()=>lg.A.instance.setCard({phase:cg.n.MemberList});d=o.createElement(ae.A,{kind:"link",className:"mx_RoomInfoLine_members",onClick:e},(0,c._t)("common|n_members",{count:s}))}return o.createElement("div",{className:`mx_RoomInfoLine ${a}`},l,d)},UI=({room:e,onJoinButtonClicked:t,onRejectButtonClicked:n})=>{const r=(0,o.useContext)(ce.Ay),s=(0,Cx.j)(e),a=PI(e);(0,Lo.F)(x.A,t=>{t.action===W.r.JoinRoomError&&t.roomId===e.roomId&&d(!1)});const[l,d]=(0,o.useState)(!1),u=(0,Jo.U)(e,e=>e.getJoinRule()),m=(0,iv.Cs)(a)===iv._T.Leave&&u!==i.JoinRule.Public,h=()=>x.A.dispatch({action:W.r.ViewUserSettings,initialTabId:We.v.Labs});let p,g,v=null;if(a===Xt.O.Join)p=o.createElement(ae.A,{kind:"danger_outline",onClick:()=>{x.A.dispatch({action:"leave_room",room_id:e.roomId})}},(0,c._t)("action|leave"));else if(a===Xt.O.Invite){var f;const i=null===(f=e.getMember(r.getUserId()))||void 0===f||null===(f=f.events.member)||void 0===f?void 0:f.getSender();if(i){const t=e.getMember(i);v=o.createElement("div",{className:"mx_RoomPreviewCard_inviter"},o.createElement(bn.A,{member:t,fallbackUserId:i,size:"32px"}),o.createElement("div",null,o.createElement("div",{className:"mx_RoomPreviewCard_inviter_name"},(0,c._t)("room|invites_you_text",{},{inviter:()=>o.createElement("strong",null,(null==t?void 0:t.name)||i)})),t?o.createElement("div",{className:"mx_RoomPreviewCard_inviter_mxid"},i):null))}p=o.createElement(o.Fragment,null,o.createElement(ae.A,{kind:"primary_outline",onClick:()=>{d(!0),n()}},(0,c._t)("action|decline")),o.createElement(ae.A,{kind:"primary",onClick:()=>{d(!0),t()}},(0,c._t)("action|accept")))}else p=o.createElement(ae.A,{kind:"primary",onClick:()=>{t(),r.isGuest()||d(!0)},disabled:m},(0,c._t)("action|join"));return l&&(p=o.createElement(tl.A,null)),g=s?o.createElement(o.Fragment,null,o.createElement(Tn.A,{room:e,size:"50px",viewAvatarOnClick:!0}),o.createElement("div",{className:"mx_RoomPreviewCard_video"}),o.createElement(Xa.s,{onClick:h,tooltipTitle:(0,c._t)("labs|video_rooms_beta")})):e.isSpaceRoom()?o.createElement(Tn.A,{room:e,size:"80px",viewAvatarOnClick:!0}):o.createElement(Tn.A,{room:e,size:"50px",viewAvatarOnClick:!0}),o.createElement("div",{className:"mx_RoomPreviewCard"},v,o.createElement("div",{className:"mx_RoomPreviewCard_avatar"},g),o.createElement("h1",{className:"mx_RoomPreviewCard_name"},o.createElement(To,{room:e})),o.createElement(LI,{room:e}),o.createElement(eC,{room:e,className:"mx_RoomPreviewCard_topic"}),"public"===e.getJoinRule()&&o.createElement(FI,{room:e}),m?o.createElement("div",{className:"mx_RoomPreviewCard_notice"},(0,c._t)("room|join_failed_needs_invite",{roomName:e.name})):null,o.createElement("div",{className:"mx_RoomPreviewCard_joinButtons"},p))};var BI=n("./src/components/views/dialogs/RoomUpgradeDialog.tsx");class VI extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"onStateEvents",e=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const t=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:t&&t.getContent().replacement_room})}),(0,S.A)(this,"onUpgradeClick",()=>{R.Ay.createDialog(BI.A,{room:this.props.room})});const t=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.state={upgraded:null==t?void 0:t.getContent().replacement_room}}componentDidMount(){this.context.on(i.RoomStateEvent.Events,this.onStateEvents)}componentWillUnmount(){this.context.removeListener(i.RoomStateEvent.Events,this.onStateEvents)}render(){let e=o.createElement("div",null,o.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.createElement("p",null,(0,c._t)("room|upgrade_warning_bar")),o.createElement("p",null,(0,c._t)("room_settings|advanced|room_upgrade_warning",{},{b:e=>o.createElement("strong",null,e),i:e=>o.createElement("i",null,e)}))),o.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},o.createElement(ae.A,{onClick:this.onUpgradeClick},(0,c._t)("room_settings|advanced|room_upgrade_button"))));return this.state.upgraded&&(e=o.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.createElement("p",null,(0,c._t)("room|upgrade_warning_bar_upgraded")))),o.createElement("div",{className:"mx_RoomUpgradeWarningBar"},o.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},o.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},(0,c._t)("room|upgrade_warning_bar_unstable",{},{roomVersion:()=>o.createElement("code",null,this.props.room.getVersion()),i:e=>o.createElement("i",null,e)})),e,o.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},(0,c._t)("room|upgrade_warning_bar_admins"))))}}(0,S.A)(VI,"contextType",ce.Ay);var jI=function(e){return e.CloseScalar="close_scalar",e.GetWidgets="get_widgets",e.SetWidget="set_widget",e.JoinRulesState="join_rules_state",e.SetPlumbingState="set_plumbing_state",e.GetMembershipCount="get_membership_count",e.GetRoomEncryptionState="get_room_enc_state",e.CanSendEvent="can_send_event",e.MembershipState="membership_state",e.invite="invite",e.Kick="kick",e.BotOptions="bot_options",e.SetBotOptions="set_bot_options",e.SetBotPower="set_bot_power",e.GetOpenIdToken="get_open_id_token",e.SendEvent="send_event",e.ReadEvents="read_events",e}(jI||{});function zI(e,t){const n=(0,Dn.ZV)(e.data);n.response=t,e.source.postMessage(n,e.origin)}function HI(e,t,n){s.vF.error("Action:"+e.data.action+" failed with message: "+t);const i=(0,Dn.ZV)(e.data);i.response={error:{message:t}},n&&(i.response.error._error=n),e.source.postMessage(i,e.origin)}function WI(e,t){const n=f.J.safeGet(),i=e.data.widget_id;let r=e.data.type;const o=e.data.url,s=e.data.name,a=e.data.data,l=e.data.avatar_url,d=e.data.userWidget;if(i&&void 0!==o){if(null!==o){if(void 0!==s&&"string"!=typeof s)return void HI(e,(0,c._t)("scalar|error_create"),new Error("Optional field 'name' must be a string."));if(void 0!==a&&!(a instanceof Object))return void HI(e,(0,c._t)("scalar|error_create"),new Error("Optional field 'data' must be an Object."));if(void 0!==l&&"string"!=typeof l)return void HI(e,(0,c._t)("scalar|error_create"),new Error("Optional field 'avatar_url' must be a string."));if("string"!=typeof r)return void HI(e,(0,c._t)("scalar|error_create"),new Error("Field 'type' must be a string."));if("string"!=typeof o)return void HI(e,(0,c._t)("scalar|error_create"),new Error("Field 'url' must be a string or null."))}if(r=yC.x.fromString(r),d)iC.A.setUserWidget(n,i,r,o,s,a).then(()=>{zI(e,{success:!0}),x.A.dispatch({action:"user_widget_updated"})}).catch(t=>{HI(e,(0,c._t)("scalar|error_create"),t)});else{if(!t)return void HI(e,(0,c._t)("scalar|error_missing_room_id"));iC.A.setRoomWidget(n,t,i,r,o,s,a,l).then(()=>{zI(e,{success:!0})},t=>{HI(e,(0,c._t)("scalar|error_send_request"),t)})}}else HI(e,(0,c._t)("scalar|error_create"),new Error("Missing required widget fields."))}function GI(e,t){const n=f.J.get();if(!n)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));let i=[];if(t){const r=n.getRoom(t);if(!r)return void HI(e,(0,c._t)("scalar|error_room_unknown"));i=iC.A.getRoomWidgets(r).map(e=>e.event)}const r=iC.A.getUserWidgetsArray(n);i=i.concat(r),zI(e,i)}function KI(e,t,n,i){const r=f.J.get();if(!r)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));const o=r.getRoom(t);if(!o)return void HI(e,(0,c._t)("scalar|error_room_unknown"));const s=o.currentState.getStateEvents(n,i);zI(e,s?s.getContent():null)}const qI=function(e){let t,n;e.origin||(e.origin=e.originalEvent.origin);try{var i;$I||($I=null===(i=U.J.sharedInstance().getPrimaryManager())||void 0===i?void 0:i.uiUrl),t=new URL($I)}catch{return}try{n=new URL(e.origin)}catch{return}if(t.origin!==n.origin||!e.data.action||e.data.api)return;if(e.data.action===jI.CloseScalar)return x.A.dispatch({action:jI.CloseScalar}),void zI(e,null);const r=e.data.room_id,o=e.data.user_id;if(!r)return e.data.action===jI.GetWidgets?void GI(e,null):e.data.action===jI.SetWidget?void WI(e,null):e.data.action===jI.GetOpenIdToken?void async function(e){try{zI(e,await f.J.safeGet().getOpenIdToken())}catch(t){s.vF.warn("Unable to fetch openId token.",t),HI(e,"Unable to fetch openId token.")}}(e):void HI(e,(0,c._t)("scalar|error_missing_room_id_request"));if(r===as.M.instance.roomViewStore.getRoomId())if(e.data.action!==jI.GetWidgets)if(e.data.action!==jI.SetWidget)if(e.data.action!==jI.JoinRulesState)if(e.data.action!==jI.SetPlumbingState)if(e.data.action!==jI.GetMembershipCount)if(e.data.action!==jI.GetRoomEncryptionState)if(e.data.action!==jI.CanSendEvent)if(e.data.action!==jI.SendEvent)if(e.data.action!==jI.ReadEvents)if(o)switch(e.data.action){case jI.MembershipState:!function(e,t,n){s.vF.log(`membership_state of ${n} in room ${t} requested.`),KI(e,t,"m.room.member",n)}(e,r,o);break;case jI.invite:!function(e,t,n){s.vF.log(`Received request to invite ${n} into room ${t}`);const i=f.J.get();if(!i)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));const r=i.getRoom(t);if(r){const t=r.getMember(n);if(t&&[Xt.O.Join,Xt.O.Invite].includes(t.membership))return void zI(e,{success:!0})}i.invite(t,n).then(function(){zI(e,{success:!0})},function(t){HI(e,(0,c._t)("widget|error_need_invite_permission"),t)})}(e,r,o);break;case jI.Kick:!function(e,t,n){s.vF.log(`Received request to kick ${n} from room ${t}`);const i=f.J.get();if(!i)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));const r=i.getRoom(t);if(r){const t=r.getMember(n);if(!t||(0,iv.Cs)(t.membership)===iv._T.Leave)return void zI(e,{success:!0})}const o=e.data.reason;i.kick(t,n,o).then(()=>{zI(e,{success:!0})}).catch(t=>{HI(e,(0,c._t)("widget|error_need_kick_permission"),t)})}(e,r,o);break;case jI.BotOptions:!function(e,t,n){s.vF.log(`bot_options of ${n} in room ${t} requested.`),KI(e,t,"m.room.bot.options","_"+n)}(e,r,o);break;case jI.SetBotOptions:!function(e,t,n){s.vF.log(`Received request to set options for bot ${n} in room ${t}`);const i=f.J.get();i?i.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+n).then(()=>{zI(e,{success:!0})},t=>{HI(e,t.message?t.message:(0,c._t)("scalar|error_send_request"),t)}):HI(e,(0,c._t)("widget|error_need_to_be_logged_in"))}(e,r,o);break;case jI.SetBotPower:!async function(e,t,n,i,r){if(!(Number.isInteger(i)&&i>=0))return void HI(e,(0,c._t)("scalar|error_power_level_invalid"));s.vF.log(`Received request to set power level to ${i} for bot ${n} in room ${t}.`);const o=f.J.get();if(o)try{const s=await o.getStateEvent(t,"m.room.power_levels","");var a,l,d;if(!0===r)if((null!==(a=null!==(l=null===(d=s.users)||void 0===d?void 0:d[n])&&void 0!==l?l:s.users_default)&&void 0!==a?a:0)>=i)return zI(e,{success:!0});return await o.setPowerLevel(t,n,i),zI(e,{success:!0})}catch(t){var u;const n=t instanceof Error?t:void 0;HI(e,null!==(u=null==n?void 0:n.message)&&void 0!==u?u:(0,c._t)("scalar|error_send_request"),n)}else HI(e,(0,c._t)("widget|error_need_to_be_logged_in"))}(e,r,o,e.data.level,e.data.ignoreIfGreater);break;default:s.vF.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else HI(e,(0,c._t)("scalar|error_missing_user_id_request"));else!async function(e,t){const n=e.data.type,i=e.data.state_key,r=e.data.limit;if("string"!=typeof n)return void HI(e,(0,c._t)("scalar|failed_read_event"),new Error("Invalid 'type' in request"));if(!["m.room.power_levels","m.room.encryption","m.room.member","m.room.name","m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(n))return void HI(e,(0,c._t)("scalar|failed_read_event"),new Error("Disallowed 'type' in request"));let o;if(void 0!==r){if("number"!=typeof r||r<0)return void HI(e,(0,c._t)("scalar|failed_read_event"),new Error("Invalid 'limit' in request"));o=Math.min(r,Number.MAX_SAFE_INTEGER)}else o=Number.MAX_SAFE_INTEGER;const s=f.J.get();if(!s)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));const a=s.getRoom(t);if(a){if(void 0!==i){if("string"!=typeof i&&!0!==i)return void HI(e,(0,c._t)("scalar|failed_read_event"),new Error("Invalid 'state_key' in request"));const t=!0===i?void 0:i;let r=[];return r=r.concat(a.currentState.getStateEvents(n,t)||[]),r=r.slice(0,o),void zI(e,{events:r.map(e=>e.getEffectiveEvent())})}HI(e,(0,c._t)("scalar|failed_read_event"),new Error("Reading message events is not implemented"))}else HI(e,(0,c._t)("scalar|error_room_unknown"))}(e,r);else!async function(e,t){const n=e.data.type,i=e.data.state_key,r=e.data.content;if("string"!=typeof n)return void HI(e,(0,c._t)("scalar|failed_send_event"),new Error("Invalid 'type' in request"));if(!["m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(n))return void HI(e,(0,c._t)("scalar|failed_send_event"),new Error("Disallowed 'type' in request"));if(!r||"object"!=typeof r)return void HI(e,(0,c._t)("scalar|failed_send_event"),new Error("Invalid 'content' in request"));const o=f.J.get();if(!o)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));if(o.getRoom(t))if(void 0!==i)try{zI(e,{room_id:t,event_id:(await o.sendStateEvent(t,n,r,i)).event_id})}catch(t){return void HI(e,(0,c._t)("scalar|failed_send_event"),t)}else HI(e,(0,c._t)("scalar|failed_send_event"),new Error("Sending message events is not implemented"));else HI(e,(0,c._t)("scalar|error_room_unknown"))}(e,r);else!function(e,t){const n=""+e.data.event_type,i=Boolean(e.data.is_state),r=f.J.get();if(!r)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));const o=r.getRoom(t);if(!o)return void HI(e,(0,c._t)("scalar|error_room_unknown"));if(o.getMyMembership()!==Xt.O.Join)return void HI(e,(0,c._t)("scalar|error_membership"));const s=r.credentials.userId;let a;a=i?o.currentState.maySendStateEvent(n,s):o.currentState.maySendEvent(n,s),a?zI(e,!0):HI(e,(0,c._t)("scalar|error_permission"))}(e,r);else!async function(e,t){var n;const i=f.J.get();if(!i)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));if(!i.getRoom(t))return void HI(e,(0,c._t)("scalar|error_room_unknown"));zI(e,Boolean(await(null===(n=i.getCrypto())||void 0===n?void 0:n.isEncryptionEnabledInRoom(t))))}(e,r);else!function(e,t){const n=f.J.get();if(!n)return void HI(e,(0,c._t)("widget|error_need_to_be_logged_in"));const i=n.getRoom(t);if(!i)return void HI(e,(0,c._t)("scalar|error_room_unknown"));zI(e,i.getJoinedMemberCount())}(e,r);else!function(e,t,n){if("string"!=typeof n)throw new Error("Plumbing state status should be a string");s.vF.log(`Received request to set plumbing state to status "${n}" in room ${t}`);const i=f.J.get();i?i.sendStateEvent(t,"m.room.plumbing",{status:n}).then(()=>{zI(e,{success:!0})},t=>{HI(e,t.message?t.message:(0,c._t)("scalar|error_send_request"),t)}):HI(e,(0,c._t)("widget|error_need_to_be_logged_in"))}(e,r,e.data.status);else!function(e,t){s.vF.log(`join_rules of ${t} requested.`),KI(e,t,"m.room.join_rules","")}(e,r);else WI(e,r);else GI(e,r);else HI(e,(0,c._t)("scalar|error_room_not_visible",{roomId:r}))};let $I,JI=0;class YI extends Fa{start(e){this.vertical?e.style.minHeight="":e.style.minWidth=""}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const n=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=n,e.style.height=n}else{const n=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=n,e.style.width=n}}}class XI extends Ua{static createSizer(e,t,n){return new YI(e,t,n)}}var QI=n("./src/shared-components/utils/numbers.ts");class ZI extends o.Component{constructor(e){super(e),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"resizeContainer",void 0),(0,S.A)(this,"resizer",void 0),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"onIsResizing",e=>{this.setState({resizingVertical:e}),e||this.relaxResizer()}),(0,S.A)(this,"collectResizer",e=>{this.resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this.resizeContainer=e,this.loadResizerPreferences()}),(0,S.A)(this,"getAppsHash",e=>e.map(e=>e.id).join("~")),(0,S.A)(this,"relaxResizer",()=>{const e=this.resizer.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())}),(0,S.A)(this,"loadResizerPreferences",()=>{const e=YC.aK.instance.getResizerDistributions(this.props.room,YC.mc.Top);if(this.state.apps&&this.topApps().length-1===e.length)e.forEach((e,t)=>{const n=this.resizer.forHandleAt(t);n&&(n.size=e,n.finish())});else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach(e=>e.item.clearSize()),e.forEach(e=>e.start()),e.forEach(e=>e.finish())}}),(0,S.A)(this,"onAction",e=>{const t=this.props.room.roomId+"_hide_widget_drawer";if("appsDrawer"===e.action)e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")}),(0,S.A)(this,"getApps",()=>({[YC.mc.Top]:YC.aK.instance.getContainerWidgets(this.props.room,YC.mc.Top),[YC.mc.Center]:YC.aK.instance.getContainerWidgets(this.props.room,YC.mc.Center)})),(0,S.A)(this,"topApps",()=>this.state.apps[YC.mc.Top]),(0,S.A)(this,"centerApps",()=>this.state.apps[YC.mc.Center]),(0,S.A)(this,"updateApps",()=>{this.unmounted||this.setState({apps:this.getApps()})}),this.state={apps:this.getApps(),resizingVertical:!1,resizingHorizontal:!1,resizing:!1},this.resizer=this.createResizer()}componentDidMount(){this.unmounted=!1,this.props.resizeNotifier.on("isResizing",this.onIsResizing),0===JI&&window.addEventListener("message",qI,!1),JI+=1,YC.aK.instance.on(YC.aK.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef=x.A.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,function(){if(JI-=1,0===JI&&window.removeEventListener("message",qI),JI<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");s.vF.error(e)}}(),YC.aK.instance.off(YC.aK.emissionForRoom(this.props.room),this.updateApps),x.A.unregister(this.dispatcherRef),this.resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}createResizer(){const e=new ja(null,XI,{onResizeStart:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.add("mx_AppsDrawer--resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{var e;null===(e=this.resizeContainer)||void 0===e||e.classList.remove("mx_AppsDrawer--resizing"),YC.aK.instance.setResizerDistributions(this.props.room,YC.mc.Top,this.topApps().slice(1).map((e,t)=>this.resizer.forHandleAt(t).size)),this.setState({resizingHorizontal:!1})}});return e.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),e}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this.updateApps():this.getAppsHash(this.topApps())!==this.getAppsHash(t.apps[YC.mc.Top])&&this.loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}render(){if(!this.props.showApps)return o.createElement("div",null);const e=this.centerApps().length>0,t=(e?this.centerApps():this.topApps()).map((e,t,n)=>o.createElement(hk,{key:e.id,app:e,fullWidth:n.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:iC.A.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0}));if(0===t.length)return o.createElement("div",null);let n;0===t.length&&_I.A.roomHasPendingWidgets(this.props.room.roomId,iC.A.getRoomWidgets(this.props.room))&&(n=o.createElement(le.A,null));const i=me()({mx_AppsDrawer:!0,"mx_AppsDrawer--maximised":e,"mx_AppsDrawer--resizing":this.state.resizing,"mx_AppsDrawer--2apps":2===t.length,"mx_AppsDrawer--3apps":3===t.length}),r=o.createElement("div",{className:"mx_AppsContainer",ref:this.collectResizer},t.map((e,n)=>n<1?e:o.createElement(o.Fragment,{key:e.key},o.createElement(Ma,{reverse:n>t.length/2}),e)));let s;return s=e?r:o.createElement(eT,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight-50,className:"mx_AppsDrawer_resizer",handleWrapperClass:"mx_AppsDrawer_resizer_container",handleClass:"mx_AppsDrawer_resizer_container_handle",resizeNotifier:this.props.resizeNotifier},r),o.createElement("div",{role:this.props.role,className:i},s,n)}}(0,S.A)(ZI,"defaultProps",{showApps:!0});const eT=({room:e,minHeight:t,maxHeight:n,className:i,handleWrapperClass:r,handleClass:s,resizeNotifier:a,children:l})=>{let c=YC.aK.instance.getContainerHeight(e,YC.mc.Top);var u;(t||(t=100),n||(n=Ja.A.instance.windowHeight/4*3),c)?(c=(0,QI.qE)(c,0,100),c=(0,QI.yj)(c/100,t,n)):c=null!==(u=d.Ay.get().default_widget_container_height)&&void 0!==u?u:280;return o.createElement(bS.c,{size:{height:Math.min(c,n),width:void 0},minHeight:t,maxHeight:n,onResizeStart:()=>{a.startResizing()},onResize:()=>{a.notifyTimelineHeightChanged()},onResizeStop:(i,r,o,s)=>{let l=c+s.height;l=100*(0,QI.s5)(l,t,n),YC.aK.instance.setContainerHeight(e,YC.mc.Top,l),a.stopResizing()},className:i,handleWrapperClass:r,handleClasses:{bottom:s},enable:{bottom:!0}},l)};var tT=n("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts");class nT extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"element",void 0),(0,S.A)(this,"setElementRef",e=>{var t;e?(this.element=e,e.addEventListener("resize",this.onResize)):null===(t=this.element)||void 0===t||t.removeEventListener("resize",this.onResize)}),(0,S.A)(this,"onNewStream",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}),this.playMedia()}),(0,S.A)(this,"onMuteStateChanged",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})}),(0,S.A)(this,"onResize",e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)}),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.updateFeed(null,this.props.feed),this.playMedia()}componentWillUnmount(){this.updateFeed(this.props.feed,null)}componentDidUpdate(e,t){this.updateFeed(e.feed,this.props.feed),t.videoMuted===this.state.videoMuted&&e.feed.stream===this.props.feed.stream||this.playMedia()}static getDerivedStateFromProps(e){return{audioMuted:e.feed.isAudioMuted(),videoMuted:e.feed.isVideoMuted()}}updateFeed(e,t){e!==t&&(e&&(this.props.feed.removeListener(pS.BL.NewStream,this.onNewStream),this.props.feed.removeListener(pS.BL.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===tT.h.Usermedia&&this.props.feed.measureVolumeActivity(!1),this.stopMedia()),t&&(this.props.feed.addListener(pS.BL.NewStream,this.onNewStream),this.props.feed.addListener(pS.BL.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===tT.h.Usermedia&&this.props.feed.measureVolumeActivity(!0),this.playMedia()))}async playMedia(){const e=this.element;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.play()}catch(e){s.vF.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element;e&&(e.pause(),e.removeAttribute("src"))}render(){const{pipMode:e,primary:t,secondary:n,feed:i}=this.props,r=me()("mx_VideoFeed",{mx_VideoFeed_primary:t,mx_VideoFeed_secondary:n,mx_VideoFeed_voice:this.state.videoMuted}),s=me()("mx_VideoFeed_mic",{mx_VideoFeed_mic_muted:this.state.audioMuted,mx_VideoFeed_mic_unmuted:!this.state.audioMuted});let a,l;if(i.purpose===tT.h.Screenshare||e||(a=o.createElement("div",{className:s})),this.state.videoMuted){var c;const n=jt.Ay.instance.roomIdForCall(this.props.call),i=null!==(c=n?f.J.safeGet().getRoom(n):void 0)&&void 0!==c?c:void 0;let r;e&&t?r="76px":e&&!t?r="16px":!e&&t&&(r="160px"),l=o.createElement(Tn.A,{room:i,size:r})}else{const e=me()("mx_VideoFeed_video",{mx_VideoFeed_video_mirror:this.props.feed.isLocal()&&this.props.feed.purpose===tT.h.Usermedia&&O.A.getValue("VideoView.flipVideoHorizontally")});l=o.createElement("video",{className:e,ref:this.setElementRef})}return o.createElement("div",{className:r},a,l)}}class iT extends o.Component{render(){const e=this.props.feeds.map(e=>o.createElement(nT,{key:e.stream.id,feed:e,call:this.props.call,primary:!1,pipMode:this.props.pipMode})),t=me()("mx_LegacyCallViewSidebar",{mx_LegacyCallViewSidebar_pipMode:this.props.pipMode});return o.createElement("div",{className:t},e)}}const rT=({onExpand:e,onPin:t,onMaximize:n})=>o.createElement("div",{className:"mx_LegacyCallViewHeader_controls"},n&&o.createElement(ae.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_fullscreen",onClick:n,title:(0,c._t)("voip|maximise")}),t&&o.createElement(ae.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_pin",onClick:t,title:(0,c._t)("action|pin")}),e&&o.createElement(ae.A,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_expand",onClick:e,title:(0,c._t)("voip|expand")})),oT=({callRoom:e})=>o.createElement("span",{className:"mx_LegacyCallViewHeader_secondaryCallInfo"},o.createElement(Tn.A,{room:e,size:"16px"}),o.createElement("span",{className:"mx_LegacyCallView_secondaryCall_roomName"},(0,c._t)("voip|on_hold",{name:e.name}))),sT=({pipMode:e=!1,callRooms:t,onPipMouseDown:n,onExpand:i,onPin:r,onMaximize:s})=>{const[a,l]=t,d=a.name;return e?o.createElement("div",{className:"mx_LegacyCallViewHeader mx_LegacyCallViewHeader_pip",onMouseDown:n},o.createElement(Tn.A,{room:a,size:"32px"}),o.createElement("div",{className:"mx_LegacyCallViewHeader_callInfo"},o.createElement("div",{className:"mx_LegacyCallViewHeader_roomName"},d),l&&o.createElement(oT,{callRoom:l})),o.createElement(rT,{onExpand:i,onPin:r,onMaximize:s})):o.createElement("div",{className:"mx_LegacyCallViewHeader"},o.createElement("div",{className:"mx_LegacyCallViewHeader_icon"}),o.createElement("span",{className:"mx_LegacyCallViewHeader_text"},(0,c._t)("action|call")),o.createElement(rT,{onMaximize:s}))};class aT extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"onHoldClick",()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()}),(0,S.A)(this,"onUnholdClick",()=>{jt.Ay.instance.setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()}),(0,S.A)(this,"onTransferClick",()=>{jt.Ay.instance.showTransferDialog(this.props.call),this.props.onFinished()})}render(){const e=this.props.call.isRemoteOnHold()?(0,c._t)("action|resume"):(0,c._t)("action|hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let n;return this.props.call.opponentCanBeTransferred()&&(n=o.createElement(Nn.Dr,{className:"mx_LegacyCallContextMenu_item",onClick:this.onTransferClick},(0,c._t)("action|transfer"))),o.createElement(Nn.Ay,this.props,o.createElement(Nn.Dr,{className:"mx_LegacyCallContextMenu_item",onClick:t},e),n)}}var lT=n("./src/components/views/voip/DialPad.tsx");class cT extends o.Component{constructor(e){super(e),(0,S.A)(this,"numberEntryFieldRef",(0,o.createRef)()),(0,S.A)(this,"onDigitPress",(e,t)=>{var n;(this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())}),(0,S.A)(this,"onCancelClick",()=>{this.props.onFinished()}),(0,S.A)(this,"onKeyDown",e=>{"Backspace"!==e.code&&"Delete"!==e.code||e.preventDefault()}),(0,S.A)(this,"onChange",e=>{this.setState({value:e.target.value})}),this.state={value:""}}render(){return o.createElement(Nn.Ay,this.props,o.createElement("div",{className:"mx_DialPadContextMenuWrapper"},o.createElement("div",null,o.createElement(ae.A,{className:"mx_DialPadContextMenu_cancel",onClick:this.onCancelClick})),o.createElement("div",{className:"mx_DialPadContextMenu_header"},o.createElement(wo.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onKeyDown:this.onKeyDown,onChange:this.onChange})),o.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},o.createElement(lT.Ay,{onDigitPress:this.onDigitPress,hasDial:!1}))))}}const dT=["deviceKinds"],uT={[Da.cm.AudioInput]:(0,c.AO)("voip|input_devices"),[Da.cm.AudioOutput]:(0,c.AO)("voip|output_devices"),[Da.cm.VideoInput]:(0,c.AO)("common|cameras")},mT=({label:e,selected:t,onClick:n})=>o.createElement(Qa.h6,{iconClassName:"mx_DeviceContextMenu_device_icon",label:e,active:t,onClick:n}),hT=({deviceKind:e})=>{const[t,n]=(0,o.useState)([]),[i,r]=(0,o.useState)(Da.Ay.getDevice(e));(0,o.useEffect)(()=>{(async()=>{var t,i;n(null!==(t=null===(i=await Da.Ay.getDevices())||void 0===i?void 0:i[e])&&void 0!==t?t:[])})()},[e]);return o.createElement(Qa.tx,{label:(0,c._t)(uT[e])},t.map(({label:t,deviceId:n})=>o.createElement(mT,{key:n,label:t,selected:i===n,onClick:()=>(t=>{Da.Ay.instance.setDevice(t,e),r(t)})(n)})))},pT=e=>{let{deviceKinds:t}=e,n=(0,v.A)(e,dT);return o.createElement(Qa.Ay,(0,tn.A)({compact:!0,className:"mx_DeviceContextMenu"},n),t.map(e=>o.createElement(hT,{key:e,deviceKind:e})))},gT=["children","state","className","onLabel","offLabel","forceHide","onHover","ref"],vT=["state","deviceKinds"],fT=e=>{let{children:t,state:n,className:i,onLabel:r,offLabel:s,forceHide:a,onHover:l,ref:c}=e,d=(0,v.A)(e,gT);const u=me()("mx_LegacyCallViewButtons_button",i,{mx_LegacyCallViewButtons_button_on:n,mx_LegacyCallViewButtons_button_off:!n}),m=a?void 0:n?r:s;return o.createElement(ae.A,(0,tn.A)({ref:c,className:u,title:m,placement:"top",onTooltipOpenChange:l},d),t)},_T=e=>{let{state:t,deviceKinds:n}=e,i=(0,v.A)(e,vT);const[r,s,a,l]=(0,Nn.EF)(),[c,d]=(0,o.useState)(!1),u=me()("mx_LegacyCallViewButtons_button","mx_LegacyCallViewButtons_dropdownButton",{mx_LegacyCallViewButtons_dropdownButton_collapsed:!r});return o.createElement(fT,(0,tn.A)({ref:s,forceHide:r||c,state:t},i),o.createElement(fT,{className:u,onClick:e=>{e.stopPropagation(),a()},onHover:e=>d(e),state:t}),r&&s.current&&o.createElement(pT,(0,tn.A)({},(0,Nn.Gi)(s.current.getBoundingClientRect()),{onFinished:l,deviceKinds:n})))};class yT extends o.Component{constructor(e){super(e),(0,S.A)(this,"dialpadButton",(0,o.createRef)()),(0,S.A)(this,"contextMenuButton",(0,o.createRef)()),(0,S.A)(this,"controlsHideTimer",null),(0,S.A)(this,"onControlsHideTimer",()=>{this.state.hoveringControls||this.state.showDialpad||this.state.showMoreMenu||(this.controlsHideTimer=null,this.setState({visible:!1}))}),(0,S.A)(this,"onMouseEnter",()=>{this.setState({hoveringControls:!0})}),(0,S.A)(this,"onMouseLeave",()=>{this.setState({hoveringControls:!1})}),(0,S.A)(this,"onDialpadClick",()=>{this.state.showDialpad?this.setState({showDialpad:!1}):(this.setState({showDialpad:!0}),this.showControls())}),(0,S.A)(this,"onMoreClick",()=>{this.setState({showMoreMenu:!0}),this.showControls()}),(0,S.A)(this,"closeDialpad",()=>{this.setState({showDialpad:!1})}),(0,S.A)(this,"closeContextMenu",()=>{this.setState({showMoreMenu:!1})}),this.state={showDialpad:!1,hoveringControls:!1,showMoreMenu:!1,visible:!0}}componentDidMount(){this.showControls()}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.visible||this.setState({visible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,2e3))}render(){const e=me()("mx_LegacyCallViewButtons",{mx_LegacyCallViewButtons_hidden:!this.state.visible});let t,n;return this.state.showDialpad&&this.dialpadButton.current&&(t=o.createElement(cT,(0,tn.A)({},(0,Nn.t$)(this.dialpadButton.current.getBoundingClientRect(),Nn.t4.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&this.contextMenuButton.current&&(n=o.createElement(aT,(0,tn.A)({},(0,Nn.t$)(this.contextMenuButton.current.getBoundingClientRect(),Nn.t4.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeContextMenu,call:this.props.call}))),o.createElement("div",{className:e,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},t,n,this.props.buttonsVisibility.dialpad&&o.createElement(Nn.oW,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_dialpad",ref:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad,title:(0,c._t)("voip|dialpad"),placement:"top"}),o.createElement(_T,{state:!this.props.buttonsState.micMuted,className:"mx_LegacyCallViewButtons_button_mic",onLabel:(0,c._t)("voip|disable_microphone"),offLabel:(0,c._t)("voip|enable_microphone"),onClick:this.props.handlers.onMicMuteClick,deviceKinds:[Da.cm.AudioInput,Da.cm.AudioOutput]}),this.props.buttonsVisibility.vidMute&&o.createElement(_T,{state:!this.props.buttonsState.vidMuted,className:"mx_LegacyCallViewButtons_button_vid",onLabel:(0,c._t)("voip|disable_camera"),offLabel:(0,c._t)("voip|enable_camera"),onClick:this.props.handlers.onVidMuteClick,deviceKinds:[Da.cm.VideoInput]}),this.props.buttonsVisibility.screensharing&&o.createElement(fT,{state:this.props.buttonsState.screensharing,className:"mx_LegacyCallViewButtons_button_screensharing",onLabel:(0,c._t)("voip|stop_screenshare"),offLabel:(0,c._t)("voip|start_screenshare"),onClick:this.props.handlers.onScreenshareClick}),this.props.buttonsVisibility.sidebar&&o.createElement(fT,{state:this.props.buttonsState.sidebarShown,className:"mx_LegacyCallViewButtons_button_sidebar",onLabel:(0,c._t)("voip|hide_sidebar_button"),offLabel:(0,c._t)("voip|show_sidebar_button"),onClick:this.props.handlers.onToggleSidebarClick}),this.props.buttonsVisibility.contextMenu&&o.createElement(Nn.oW,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_more",onClick:this.onMoreClick,ref:this.contextMenuButton,isExpanded:this.state.showMoreMenu,title:(0,c._t)("voip|more_button"),placement:"top"}),o.createElement(ae.A,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_hangup",onClick:this.props.handlers.onHangupClick,title:(0,c._t)("voip|hangup"),placement:"top"}))}}function bT(){return document.fullscreenElement}function ET(){document.exitFullscreen()}class wT extends o.Component{constructor(e){super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"contentWrapperRef",(0,o.createRef)()),(0,S.A)(this,"buttonsRef",(0,o.createRef)()),(0,S.A)(this,"onAction",e=>{if("video_fullscreen"===e.action){if(!this.contentWrapperRef.current)return;e.fullscreen?this.contentWrapperRef.current.requestFullscreen():bT()&&ET()}}),(0,S.A)(this,"onCallState",e=>{this.setState({callState:e})}),(0,S.A)(this,"onFeedsChanged",e=>{const{primary:t,secondary:n,sidebar:i}=wT.getOrderedFeeds(e);this.setState({primaryFeed:t,secondaryFeed:n,sidebarFeeds:i,micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted()})}),(0,S.A)(this,"onCallLocalHoldUnhold",()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})}),(0,S.A)(this,"onCallRemoteHoldUnhold",()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})}),(0,S.A)(this,"onMouseMove",()=>{var e;null===(e=this.buttonsRef.current)||void 0===e||e.showControls()}),(0,S.A)(this,"onMaximizeClick",()=>{x.A.dispatch({action:"video_fullscreen",fullscreen:!0})}),(0,S.A)(this,"onMicMuteClick",async()=>{const e=!this.state.micMuted;this.setState({micMuted:await this.props.call.setMicrophoneMuted(e)})}),(0,S.A)(this,"onVidMuteClick",async()=>{const e=!this.state.vidMuted;this.setState({vidMuted:await this.props.call.setLocalVideoMuted(e)})}),(0,S.A)(this,"onScreenshareClick",async()=>{let e;e=this.state.screensharing?await this.props.call.setScreensharingEnabled(!1):await this.props.call.setScreensharingEnabled(!0),this.setState({sidebarShown:!0,screensharing:e})}),(0,S.A)(this,"onNativeKeyDown",e=>{var t,n;let i=!1;switch((0,uo.zM)().getCallAction(e)){case Ei.bY.ToggleMicInCall:this.onMicMuteClick(),null===(t=this.buttonsRef.current)||void 0===t||t.showControls(),i=!0;break;case Ei.bY.ToggleWebcamInCall:this.onVidMuteClick(),null===(n=this.buttonsRef.current)||void 0===n||n.showControls(),i=!0}i&&(e.stopPropagation(),e.preventDefault())}),(0,S.A)(this,"onCallResumeClick",()=>{const e=jt.Ay.instance.roomIdForCall(this.props.call);e&&jt.Ay.instance.setActiveCallRoomId(e)}),(0,S.A)(this,"onTransferClick",()=>{const e=jt.Ay.instance.getTransfereeForCallId(this.props.call.callId);e&&this.props.call.transferToCall(e)}),(0,S.A)(this,"onHangupClick",()=>{const e=jt.Ay.instance.roomIdForCall(this.props.call);e&&jt.Ay.instance.hangupOrReject(e)}),(0,S.A)(this,"onToggleSidebar",()=>{this.setState({sidebarShown:!this.state.sidebarShown})});const{primary:t,secondary:n,sidebar:i}=wT.getOrderedFeeds(this.props.call.getFeeds());this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),screensharing:this.props.call.isScreensharing(),callState:this.props.call.state,primaryFeed:t,secondaryFeed:n,sidebarFeeds:i,sidebarShown:!0}}componentDidMount(){this.updateCallListeners(null,this.props.call),this.dispatcherRef=x.A.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){bT()&&ET(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),x.A.unregister(this.dispatcherRef)}static getDerivedStateFromProps(e){const{primary:t,secondary:n,sidebar:i}=wT.getOrderedFeeds(e.call.getFeeds());return{primaryFeed:t,secondaryFeed:n,sidebarFeeds:i}}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(nn.$E.State,this.onCallState),e.removeListener(nn.$E.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(nn.$E.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(nn.$E.FeedsChanged,this.onFeedsChanged)),t&&(t.on(nn.$E.State,this.onCallState),t.on(nn.$E.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(nn.$E.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(nn.$E.FeedsChanged,this.onFeedsChanged)))}static getOrderedFeeds(e){if(e.length<=2)return{primary:e.find(e=>!e.isLocal()),secondary:e.find(e=>e.isLocal()),sidebar:[]};let t;const n=e.filter(e=>e.purpose===tT.h.Screenshare);t=n.find(e=>!e.isLocal())||n[0],t||(t=e.find(e=>!e.isLocal()));const i=[...e];return t&&i.splice(i.indexOf(t),1),i.sort((e,t)=>e.isLocal()&&!t.isLocal()?-1:!e.isLocal()&&t.isLocal()?1:0),{primary:t,sidebar:i}}renderCallControls(){const{call:e,pipMode:t}=this.props,{callState:n,micMuted:i,vidMuted:r,screensharing:s,sidebarShown:a,secondaryFeed:l,sidebarFeeds:c}=this.state,d=e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack,u=(e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack)&&e.state===nn.iP.Connected,m=l&&!l.isVideoMuted()||c.length>0,h=n===nn.iP.Connected,p=n===nn.iP.Connected&&e.opponentSupportsDTMF();return o.createElement(yT,{ref:this.buttonsRef,call:e,pipMode:t,handlers:{onToggleSidebarClick:this.onToggleSidebar,onScreenshareClick:this.onScreenshareClick,onHangupClick:this.onHangupClick,onMicMuteClick:this.onMicMuteClick,onVidMuteClick:this.onVidMuteClick},buttonsState:{micMuted:i,vidMuted:r,sidebarShown:a,screensharing:s},buttonsVisibility:{vidMute:d,screensharing:u,sidebar:m,contextMenu:h,dialpad:p}})}renderToast(){var e;const{call:t}=this.props;if(!t.getFeeds().some(e=>e.purpose===tT.h.Screenshare))return null;const n=t.isScreensharing(),{primaryFeed:i,sidebarShown:r}=this.state,s=null==i||null===(e=i.getMember())||void 0===e?void 0:e.name;if(!s)return null;let a=n?(0,c._t)("voip|you_are_presenting"):(0,c._t)("voip|user_is_presenting",{sharerName:s});return r||(a+="  "+(t.isLocalVideoMuted()?(0,c._t)("voip|camera_disabled"):(0,c._t)("voip|camera_enabled"))),o.createElement("div",{className:"mx_LegacyCallView_toast"},a)}renderContent(){var e;const{pipMode:t,call:n,onResize:i}=this.props,{isLocalOnHold:r,isRemoteOnHold:s,sidebarShown:a,primaryFeed:l,secondaryFeed:d,sidebarFeeds:u}=this.state,m=jt.Ay.instance.roomIdForCall(n),h=null!==(e=m?f.J.safeGet().getRoom(m):void 0)&&void 0!==e?e:void 0,p=t?"76px":"160px",g=jt.Ay.instance.getTransfereeForCallId(n.callId),v=r||s;let _;if(a&&d&&!d.isVideoMuted()&&(_=o.createElement(nT,{feed:d,call:n,pipMode:t,onResize:i,secondary:!0})),g||v){const e=me()("mx_LegacyCallView_content",{mx_LegacyCallView_content_hold:v}),t=(0,en._V)(n.getOpponentMember(),1024,1024,"crop");let i;if(g){const e=f.J.safeGet(),t=jt.Ay.instance.roomIdForCall(n),r=t?e.getRoom(t):null,s=r?r.name:(0,c._t)("voip|unknown_person"),a=jt.Ay.instance.roomIdForCall(g),l=a?e.getRoom(a):null,d=l?l.name:(0,c._t)("voip|unknown_person");i=o.createElement("div",{className:"mx_LegacyCallView_status"},(0,c._t)("voip|consulting",{transferTarget:s,transferee:d},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.onTransferClick},e)}))}else{let e;if(s)e=(0,c._t)(jt.Ay.instance.hasAnyUnheldCall()?(0,c.AO)("voip|call_held_switch"):(0,c.AO)("voip|call_held_resume"),{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.onCallResumeClick},e)});else if(r){var y;e=(0,c._t)("voip|call_held",{peerName:null===(y=n.getOpponentMember())||void 0===y?void 0:y.name})}i=o.createElement("div",{className:"mx_LegacyCallView_status"},e)}return o.createElement("div",{className:e,onMouseMove:this.onMouseMove},o.createElement("div",{className:"mx_LegacyCallView_holdBackground",style:{backgroundImage:"url("+t+")"}}),i)}return n.noIncomingFeeds()?o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement("div",{className:"mx_LegacyCallView_avatarsContainer"},o.createElement("div",{className:"mx_LegacyCallView_avatarContainer",style:{width:p,height:p}},o.createElement(Tn.A,{room:h,size:p}))),o.createElement("div",{className:"mx_LegacyCallView_status"},(0,c._t)("voip|connecting")),_):t?o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement(nT,{feed:l,call:n,pipMode:t,onResize:i,primary:!0})):d?o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement(nT,{feed:l,call:n,pipMode:t,onResize:i,primary:!0}),_):o.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.createElement(nT,{feed:l,call:n,pipMode:t,onResize:i,primary:!0}),a&&o.createElement(iT,{feeds:u,call:n,pipMode:Boolean(t)}))}render(){const{call:e,secondaryCall:t,pipMode:n,showApps:i,onMouseDownOnHeader:r}=this.props,{sidebarShown:s,sidebarFeeds:a}=this.state,l=f.J.safeGet(),c=jt.Ay.instance.roomIdForCall(e),d=jt.Ay.instance.roomIdForCall(t),u=c?l.getRoom(c):null;if(!u)return null;const m=d?l.getRoom(d):null,h=me()({mx_LegacyCallView:!0,mx_LegacyCallView_pip:n,mx_LegacyCallView_large:!n,mx_LegacyCallView_sidebar:s&&0!==a.length&&!n,mx_LegacyCallView_belowWidget:i});return o.createElement("div",{className:h},o.createElement(sT,{onPipMouseDown:r,pipMode:n,callRooms:[u,m],onMaximize:this.onMaximizeClick}),o.createElement("div",{className:"mx_LegacyCallView_content_wrapper",ref:this.contentWrapperRef},this.renderToast(),this.renderContent(),this.renderCallControls()))}}class ST extends o.Component{constructor(e){super(e),(0,S.A)(this,"updateCall",()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})}),(0,S.A)(this,"onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),(0,S.A)(this,"onResize",()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),(0,S.A)(this,"onResizeStop",()=>{this.props.resizeNotifier.stopResizing()}),this.state={call:this.getCall()}}componentDidMount(){jt.Ay.instance.addListener(jt.uv.CallState,this.updateCall),jt.Ay.instance.addListener(jt.uv.CallChangeRoom,this.updateCall)}componentWillUnmount(){jt.Ay.instance.removeListener(jt.uv.CallState,this.updateCall),jt.Ay.instance.removeListener(jt.uv.CallChangeRoom,this.updateCall)}getCall(){const e=jt.Ay.instance.getCallForRoom(this.props.roomId);return e&&[nn.iP.Ended,nn.iP.Ringing].includes(e.state)?null:e}render(){return this.state.call?o.createElement("div",{className:"mx_LegacyCallViewForRoom"},o.createElement(bS.c,{minHeight:380,maxHeight:"80vh",enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_LegacyCallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_LegacyCallViewForRoom_ResizeHandle"}},o.createElement(wT,{call:this.state.call,pipMode:!1,showApps:this.props.showApps}))):null}}class xT extends o.Component{shouldComponentUpdate(e){return(0,Dn.No)(this.props,e)}render(){const e=o.createElement(ST,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,showApps:this.props.showApps});let t;return O.A.getValue(It.f.Widgets)&&(t=o.createElement(ZI,{room:this.props.room,userId:this.props.userId,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier})),o.createElement(Cr.A,{role:"region",className:"mx_AuxPanel"},this.props.children,t,e)}}(0,S.A)(xT,"defaultProps",{showApps:!0});const AT=["children"];function CT(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function kT(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?CT(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CT(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const RT=e=>{let{children:t}=e,n=(0,v.A)(e,AT);return(0,$.jsx)(og.E,kT(kT({},n),{},{children:t}))};function IT(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"m20.958 16.374.039 3.527q0 .427-.33.756-.33.33-.756.33a16 16 0 0 1-6.57-1.105 16.2 16.2 0 0 1-5.563-3.663 16.1 16.1 0 0 1-3.653-5.573 16.3 16.3 0 0 1-1.115-6.56q0-.427.33-.757T4.095 3l3.528.039a1.07 1.07 0 0 1 1.085.93l.543 3.954q.039.271-.039.504a1.1 1.1 0 0 1-.271.426l-1.64 1.64q.505 1.008 1.154 1.909c.433.6 1.444 1.696 1.444 1.696s1.095 1.01 1.696 1.444q.9.65 1.909 1.153l1.64-1.64q.193-.193.426-.27t.504-.04l3.954.543q.406.059.668.359t.262.727"})})}IT.displayName="VoiceCallSolidIcon";const TT=(0,o.forwardRef)(IT);var PT=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/close.js");function NT(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12 17q.424 0 .713-.288A.97.97 0 0 0 13 16v-4a.97.97 0 0 0-.287-.713A.97.97 0 0 0 12 11a.97.97 0 0 0-.713.287A.97.97 0 0 0 11 12v4q0 .424.287.712.288.288.713.288m0-8q.424 0 .713-.287A.97.97 0 0 0 13 8a.97.97 0 0 0-.287-.713A.97.97 0 0 0 12 7a.97.97 0 0 0-.713.287A.97.97 0 0 0 11 8q0 .424.287.713Q11.576 9 12 9m0 13a9.7 9.7 0 0 1-3.9-.788 10.1 10.1 0 0 1-3.175-2.137q-1.35-1.35-2.137-3.175A9.7 9.7 0 0 1 2 12q0-2.075.788-3.9a10.1 10.1 0 0 1 2.137-3.175q1.35-1.35 3.175-2.137A9.7 9.7 0 0 1 12 2q2.075 0 3.9.788a10.1 10.1 0 0 1 3.175 2.137q1.35 1.35 2.137 3.175A9.7 9.7 0 0 1 22 12a9.7 9.7 0 0 1-.788 3.9 10.1 10.1 0 0 1-2.137 3.175q-1.35 1.35-3.175 2.137A9.7 9.7 0 0 1 12 22"})})}NT.displayName="InfoSolidIcon";const DT=(0,o.forwardRef)(NT),MT=(e,t="")=>(null==e?void 0:e.name)||t;var OT=n("./src/models/Call.ts");const FT=async(e,t,n,i)=>{const{analyticsName:r}=VT(n);Si.A.trackInteraction(r),n==BT.LegacyCall||n==BT.JitsiCall?await jt.Ay.instance.placeCall(e.roomId,t):n==BT.ElementCall&&x.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,view_call:!0,skipLobby:i,metricsTrigger:void 0})};var LT=n("./src/widgets/ManagedHybrid.ts"),UT=n("./src/stores/CallStore.ts");let BT=function(e){return e[e.ElementCall=0]="ElementCall",e[e.JitsiCall=1]="JitsiCall",e[e.LegacyCall=2]="LegacyCall",e}({});const VT=e=>{switch(e){case BT.ElementCall:return{label:(0,c._t)("voip|element_call"),analyticsName:"WebVoipOptionElementCall",children:o.createElement(Xa.s,null)};case BT.JitsiCall:return{label:(0,c._t)("voip|jitsi_call"),analyticsName:"WebVoipOptionJitsi"};case BT.LegacyCall:return{label:(0,c._t)("voip|legacy_call"),analyticsName:"WebVoipOptionLegacy"}}};var jT=function(e){return e[e.NoCall=0]="NoCall",e[e.NoPermission=1]="NoPermission",e[e.Unpinned=2]="Unpinned",e[e.Ongoing=3]="Ongoing",e[e.NotJoined=4]="NotJoined",e}(jT||{});function zT(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M2.95 16.3 1.5 21.25a.94.94 0 0 0 .25 1 .94.94 0 0 0 1 .25l4.95-1.45a10.2 10.2 0 0 0 2.1.712Q10.875 22 12 22a9.7 9.7 0 0 0 3.9-.788 10.1 10.1 0 0 0 3.175-2.137q1.35-1.35 2.137-3.175A9.7 9.7 0 0 0 22 12a9.7 9.7 0 0 0-.788-3.9 10.1 10.1 0 0 0-2.137-3.175q-1.35-1.35-3.175-2.137A9.7 9.7 0 0 0 12 2a9.7 9.7 0 0 0-3.9.788 10.1 10.1 0 0 0-3.175 2.137Q3.575 6.275 2.788 8.1A9.7 9.7 0 0 0 2 12q0 1.125.238 2.2.237 1.076.712 2.1"})})}zT.displayName="ChatSolidIcon";const HT=(0,o.forwardRef)(zT);var WT=n("./src/components/views/rooms/RoomHeader/toggle/useToggled.tsx");function GT({Icon:e,phase:t}){const n=(0,WT.K)(t),i=me()({mx_RoomHeader_toggled:n});return o.createElement(e,{className:i})}const KT=({room:e})=>{const t=(0,o.useContext)(as.A),n=t.roomNotificationStateStore.getRoomState(e),i=(0,lr.dF)(n,Gv.ce.Update,()=>null==n?void 0:n.level),r=!!i&&[fp.S.Activity,fp.S.Notification,fp.S.Highlight].includes(i);return o.createElement(rn.m,{label:(0,c._t)("right_panel|video_room_chat|title")},o.createElement(rg.K,{"aria-label":(0,c._t)("right_panel|video_room_chat|title"),onClick:e=>{e.stopPropagation(),t.rightPanelStore.showOrHidePhase(cg.n.Timeline)},indicator:r?"default":void 0},o.createElement(GT,{Icon:HT,phase:cg.n.Timeline})))},qT=({room:e})=>{const[t,n]=(0,o.useState)(!1),r=(0,lr.DY)(e,i.RoomStateEvent.Update,(0,o.useCallback)(()=>e.getMembersWithMembership(Xt.O.Knock),[e])),s=r.length;if(e.getJoinRule()!==i.JoinRule.Knock||0===s)return null;const a=e.client,l=a.getUserId()||"",d=e.canInvite(l),u=e.getMember(l),m=e.getLiveTimeline().getState(i.EventTimeline.FORWARDS),h=!(!u||!m)&&m.hasSufficientPowerLevelFor("kick",u.powerLevel);if(!d&&!h)return null;const p=e=>{R.Ay.createDialog(Ht.A,{title:e.name,description:e.message})},g=()=>x.A.dispatch({action:"open_room_settings",room_id:e.roomId,initial_tab_id:Yt.e.People});let v=o.createElement(ae.A,{className:"mx_RoomKnocksBar_action",kind:"primary",onClick:g,title:(0,c._t)("action|view")},(0,c._t)("action|view")),f=(0,sn.ki)(r.map(e=>e.name),3,!0),_=null;var y;1===s&&(v=o.createElement(o.Fragment,null,o.createElement(ae.A,{className:"mx_RoomKnocksBar_action",disabled:!h||t,kind:"icon_primary_outline",onClick:()=>(t=>{n(!0),a.kick(e.roomId,t).catch(p).finally(()=>n(!1))})(r[0].userId),title:(0,c._t)("action|deny")},o.createElement(PT.A,{width:18,height:18})),o.createElement(ae.A,{className:"mx_RoomKnocksBar_action",disabled:!d||t,kind:"icon_primary",onClick:()=>(t=>{n(!0),a.invite(e.roomId,t).catch(p).finally(()=>n(!1))})(r[0].userId),title:(0,c._t)("action|approve")},o.createElement(ke.A,{width:18,height:18}))),f=`${r[0].name} (${r[0].userId})`,_=(null===(y=r[0].events.member)||void 0===y?void 0:y.getContent().reason)&&o.createElement(ae.A,{className:"mx_RoomKnocksBar_link",element:"a",kind:"link_inline",onClick:g},(0,c._t)("action|view_message")));return o.createElement("div",{className:"mx_RoomKnocksBar"},r.slice(0,2).map(e=>o.createElement(bn.A,{className:"mx_RoomKnocksBar_avatar",key:e.userId,member:e,size:"32px"})),o.createElement("div",{className:"mx_RoomKnocksBar_content"},o.createElement(uC.A,{size:"4"},(0,c._t)("room|header|n_people_asking_to_join",{count:s})),o.createElement("p",{className:"mx_RoomKnocksBar_paragraph"},f,_)),v)},$T=({room:e})=>{const{canInviteGuests:t,guestSpaUrl:n,isRoomJoinable:r,canInvite:a}=(e=>{const t=(0,o.useMemo)(()=>d.Ay.get("element_call").guest_spa_url,[]),{joinRule:n,canInvite:r,canChangeJoinRule:s}=(0,Jo.U)(e,t=>({joinRule:e.getJoinRule(),canInvite:e.canInvite(e.myUserId),canChangeJoinRule:t.maySendStateEvent(i.EventType.RoomJoinRules,e.myUserId)})),a=(0,o.useMemo)(()=>n===i.JoinRule.Public||n===i.JoinRule.Knock&&r,[r,n]);return{canInviteGuests:(0,o.useMemo)(()=>(s||a)&&void 0!==t,[s,a,t]),guestSpaUrl:t,isRoomJoinable:()=>{const t=e.getJoinRule();return t===i.JoinRule.Public||t===i.JoinRule.Knock&&e.canInvite(e.myUserId)},canInvite:r}})(e),l=(0,o.useCallback)(()=>{if(!r())throw new Error("Cannot create link for room that users can not join without invite.");if(!n)throw new Error("No guest SPA url for external links provided.");const t=new URL(n);t.pathname="/room/",t.searchParams.set("roomId",e.roomId),e.hasEncryptionStateEvent()&&t.searchParams.set("perParticipantE2EE","true");for(const n of(0,on.Ex)(e))t.searchParams.set("viaServers",n);return t.hash="/"+e.name+t.search,t.search="",s.vF.info("Generated element call external url:",t),t},[n,r,e]),u=(0,o.useCallback)(()=>{try{const e=l();R.Ay.createDialog(BA.G,{target:e,customTitle:(0,c._t)("share|share_call"),subtitle:(0,c._t)("share|share_call_subtitle")})}catch(e){s.vF.error("Could not generate call link.",e)}},[l]),m=(0,o.useCallback)(()=>{r()?u():R.Ay.createDialog(JT,{room:e,canInvite:a}).finished.then(()=>{r()&&u()})},[r,u,e,a]);return o.createElement(o.Fragment,null,t&&o.createElement(rn.m,{label:(0,c._t)("voip|get_call_link")},o.createElement(rg.K,{onClick:m},o.createElement(Or.A,null))))},JT=({onFinished:e,room:t,canInvite:n})=>{const r=O.A.getValue("feature_ask_to_join"),[a,l]=o.useState(void 0),d=(0,o.useCallback)(async n=>{void 0===a&&(l(n),await t.client.sendStateEvent(t.roomId,i.EventType.RoomJoinRules,{join_rule:n},""),setTimeout(()=>e(),1e3))},[a,e,t.client,t.roomId]);return o.createElement(X.A,{title:(0,c._t)("update_room_access_modal|title"),onFinished:e,className:"mx_JoinRuleDialog"},o.createElement("p",null,(0,c._t)("update_room_access_modal|description",{},{b:e=>o.createElement("strong",null,e)})),o.createElement("p",null,(0,c._t)("update_room_access_modal|revert_access_description",{},{b:e=>o.createElement("strong",null,e)})),o.createElement($o.A,{recommendedOption:i.JoinRule.Knock,room:t,disabledOptions:new Set([i.JoinRule.Invite,i.JoinRule.Private,i.JoinRule.Restricted]),hiddenOptions:new Set([i.JoinRule.Restricted].concat(r&&n?[]:[i.JoinRule.Knock])),beforeChange:async e=>(await d(e).catch(()=>!1),!0),closeSettingsFn:()=>{},onError:e=>s.vF.error("Could not generate change access level:",e)}),o.createElement("p",null,(0,c._t)("update_room_access_modal|dont_change_description")),o.createElement("div",{className:"mx_JoinRuleDialogButtons"},o.createElement(Ae.$,{kind:"tertiary",className:"mx_Dialog_nonDialogButton",onClick:()=>{void 0===a&&e()}},(0,c._t)("update_room_access_modal|no_change"))))};var YT=n("./src/contexts/CurrentRightPanelPhaseContext.tsx"),XT=n("./src/utils/votingPowerSnapshot.ts"),QT=n("./src/utils/DAOMnemonicWallet.ts");function ZT(e){return Ci.Ay.instance.getParents(e.roomId).some(t=>{const n=e.client.getRoom(t.roomId);return n&&"GOV"===n.name})}function eP({room:e,additionalButtons:t,oobData:n}){const r=(0,ce.nH)(),s=function(e,t){let n=(0,c._t)("common|unnamed_room");t&&t.name&&(n=t.name);const[r,s]=(0,o.useState)(MT(e,n));return(0,lr.YK)(e,i.RoomEvent.Name,()=>{s(MT(e,n))}),(0,o.useEffect)(()=>{s(MT(e,n))},[e,n]),r}(e),a=(0,Jo.U)(e,e=>e.getJoinRule()),l=(0,Jo.U)(e,e=>{var t;const n=e.getStateEvents("m.room.topic","");return null==n||null===(t=n.getContent())||void 0===t?void 0:t.topic}),u=function(e){var t;const n=e.currentState.getStateEvents("m.room.topic","");return((null==n||null===(t=n.getContent())||void 0===t?void 0:t.topic)||"").includes("Kudos Value:")}(e),m=u?function(e){if(!e)return null;const t=e.match(/Kudos Value:\s*(.+?)(?:\n|$)/);return t?t[1].trim():null}(l):null,h=ZT(e),p=function(e){const[t,n]=o.useState(null);return o.useEffect(()=>{ZT(e)?(async()=>{try{const t=await(0,XT.n2)(e.client,e.roomId);if(t){const e=QT.y.getInstance().getAllDAOWallets();if(e.length>0){const i=e[0].address,r=(0,XT.Vc)(t,i);n(r)}}}catch(e){console.error("Failed to load voting power:",e),n(null)}})():n(null)},[e.roomId]),t}(e),g=II(e,2500),v=TI(e,{throttleWait:2500}),{voiceCallDisabledReason:f,voiceCallClick:_,videoCallDisabledReason:y,videoCallClick:b,toggleCallMaximized:E,isViewingCall:w,isConnectedToCall:S,hasActiveCallSession:A,callOptions:C,showVoiceCallButton:k,showVideoCallButton:R}=(e=>{var t,n;const i=(0,Qt.ny)("feature_group_calls"),r=(0,Qt.ti)(It.f.Widgets),s=(0,Qt.ti)(It.f.Voip),a=(0,o.useMemo)(()=>d.Ay.get("element_call").use_exclusively,[]),l=(0,lr.dF)(jt.Ay.instance,jt.uv.CallsChanged,()=>null!==jt.Ay.instance.getCallForRoom(e.roomId)),u=(0,iC.X)(e),m=(0,o.useMemo)(()=>u.find(e=>yC.x.JITSI.matches(e.type)),[u]),h=!!m,p=(0,o.useMemo)(()=>u.find(LT.ec),[u]),g=!!p,v=(0,Wv.Gc)(e.roomId),f=(0,Wv.jd)(v)===OT.KN.Connected,_=null!==v,y=(0,Wv.q0)(v)>0,b=(0,lr.dF)(as.M.instance.roomViewStore,ha.H,()=>as.M.instance.roomViewStore.isViewingCall()||(0,Cx.j)(e)),E=TI(e),[w,S]=(0,Jo.U)(e,()=>[e.currentState.mayClientSendStateEvent("im.vector.modular.widgets",e.client),e.currentState.mayClientSendStateEvent(fn.Vj.name,e.client)]),A=(0,o.useMemo)(()=>{const e=[];return E<=2?e.push(BT.LegacyCall):(w||h)&&e.push(BT.JitsiCall),i&&((_||S)&&e.push(BT.ElementCall),a&&!h)||_&&yC.x.CALL.matches(v.widget.type)?[BT.ElementCall]:e},[E,w,h,i,_,S,a,null==v?void 0:v.widget.type]);let C;var k;(A.includes(BT.JitsiCall)||A.includes(BT.LegacyCall))&&(C=null!=m?m:p),C=A.includes(BT.ElementCall)?null==v?void 0:v.widget:null!==(k=null==v?void 0:v.widget)&&void 0!==k?k:m;const R=(0,o.useCallback)(()=>{T(YC.aK.instance.canAddToContainer(e,YC.mc.Top)),N(!!C&&YC.aK.instance.isInContainer(e,C,YC.mc.Top))},[e,C]);(0,lr.ml)(YC.aK.instance,YC.aK.emissionForRoom(e),R),(0,o.useEffect)(()=>{R()},[e,m,v,R]);const[I,T]=(0,o.useState)(!1),[P,N]=(0,o.useState)(!1),D=!yC.x.CALL.matches(null!==(t=null===(n=C)||void 0===n?void 0:n.type)&&void 0!==t?t:"")&&I&&!P,M=(0,lr.dF)(UT.e.instance,UT.s.ConnectedCalls,()=>Array.from(UT.e.instance.connectedCalls)),O=(0,o.useMemo)(()=>M.find(t=>t.roomId!=e.roomId)?jT.Ongoing:_&&(h||g)?D?jT.Unpinned:jT.Ongoing:l?jT.Ongoing:A.includes(BT.LegacyCall)||S||w?jT.NoCall:jT.NoPermission,[A,M,_,h,l,g,S,w,D,e.roomId]),F=(0,o.useCallback)((t,n)=>{var i;null==t||t.stopPropagation(),C&&D?YC.aK.instance.moveToContainer(e,C,YC.mc.Top):FT(e,nn.JG.Voice,n,null!==(i=null==t?void 0:t.shiftKey)&&void 0!==i&&i)},[D,e,C]),L=(0,o.useCallback)((t,n)=>{var i;null==t||t.stopPropagation(),C&&D?YC.aK.instance.moveToContainer(e,C,YC.mc.Top):FT(e,nn.JG.Video,n,null!==(i=null==t?void 0:t.shiftKey)&&void 0!==i&&i)},[C,D,e]);let U,B;switch(O){case jT.NoPermission:U=(0,c._t)("voip|disabled_no_perms_start_voice_call"),B=(0,c._t)("voip|disabled_no_perms_start_video_call");break;case jT.Ongoing:U=(0,c._t)("voip|disabled_ongoing_call"),B=(0,c._t)("voip|disabled_ongoing_call");break;case jT.Unpinned:case jT.NotJoined:case jT.NoCall:U=null,B=null}const V=(0,o.useCallback)(()=>{x.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:void 0,view_call:!b})},[b,e.roomId]);let j=(0,LT.dq)(e)||!A.includes(BT.LegacyCall),z=!1;return(E>2&&!r||!s)&&(j=!0,z=!0),{voiceCallDisabledReason:U,voiceCallClick:F,videoCallDisabledReason:B,videoCallClick:L,toggleCallMaximized:V,isViewingCall:b,isConnectedToCall:f,hasActiveCallSession:y,callOptions:A,showVoiceCallButton:!j,showVideoCallButton:!z}})(e),I=(0,Qt.ny)("feature_group_calls"),T=(0,o.useMemo)(()=>d.Ay.get("element_call").use_exclusively&&I,[I]),P=(e=>{const[t,n]=(0,o.useState)(fp.S.None),r=(0,o.useCallback)(()=>{switch(null==e?void 0:e.threadsAggregateNotificationType){case i.NotificationCountType.Highlight:return void n(fp.S.Highlight);case i.NotificationCountType.Total:return void n(fp.S.Notification)}(0,dg.Nb)(e)?n(fp.S.Activity):n(fp.S.None)},[e]);return(0,lr.ml)(e,i.RoomEvent.UnreadNotifications,r),(0,lr.ml)(e,i.RoomEvent.Receipt,r),(0,lr.ml)(e,i.RoomEvent.Timeline,r),(0,lr.ml)(e,i.RoomEvent.Redaction,r),(0,lr.ml)(e,i.RoomEvent.LocalEchoUpdated,r),(0,lr.ml)(e,i.RoomEvent.MyMembership,r),(0,lr.ml)(e,i.ThreadEvent.New,r),(0,lr.ml)(e,i.ThreadEvent.Update,r),(0,o.useEffect)(()=>{r()},[r]),t})(e),N=(()=>{const[e,t]=(0,o.useState)(xp.n.instance.globalState);return(0,lr.ml)(xp.n.instance,xp.N,e=>{t(e)}),e})(),D=!!(0,Zf.rT)(e),M=function(e,t){const[n,r]=(0,o.useState)(null),s=(0,o.useMemo)(()=>(0,Li.throttle)(()=>{e.getCrypto()&&(0,qS.G)(e,t).then(e=>{r(e)})},250,{leading:!0,trailing:!0}),[e,t]);return(0,o.useEffect)(s,[s]),(0,lr.YK)(t,i.RoomStateEvent.Members,s),(0,lr.YK)(e,V.cr.UserTrustStatusChanged,s),(0,lr.YK)(e,V.cr.DevicesUpdated,s),n}(r,e),O=(0,Qt.ny)("feature_notifications"),F=(0,Qt.ny)("feature_ask_to_join"),L=(0,o.useCallback)(e=>b(e,C[0]),[C,b]),U=o.createElement(rn.m,{label:w?(0,c._t)("voip|minimise_call"):(0,c._t)("voip|maximise_call")},o.createElement(rg.K,{onClick:E},o.createElement(Tp.A,null))),B=o.createElement(rn.m,{label:null!=y?y:(0,c._t)("voip|video_call")},o.createElement(Ae.$,{size:"sm",onClick:L,Icon:Tp.A,className:"mx_RoomHeader_join_button",disabled:!!y,color:"primary","aria-label":null!=y?y:(0,c._t)("action|join")},(0,c._t)("action|join"))),j=o.createElement(rn.m,{label:null!=y?y:(0,c._t)("voip|video_call")},o.createElement(Tp.A,null)),[z,H]=(0,o.useState)(!1),G=(0,o.useCallback)(e=>{y||H(e)},[y]),K=o.createElement(o.Fragment,null,C.length>1?o.createElement(ng.W,{open:z,onOpenChange:G,title:(0,c._t)("voip|video_call_using"),trigger:o.createElement(rg.K,{disabled:!!y,"aria-label":null!=y?y:(0,c._t)("voip|video_call")},j),side:"left",align:"start"},C.map(e=>{const{label:t,children:n}=VT(e);return o.createElement(ig.D,{key:e,label:t,"aria-label":t,children:n,className:"mx_RoomHeader_videoCallOption",onClick:t=>{H(!1),b(t,e)},Icon:Tp.A,onSelect:()=>{}})})):o.createElement(rg.K,{disabled:!!y,"aria-label":null!=y?y:(0,c._t)("voip|video_call"),onClick:L},j));let q=o.createElement(rn.m,{label:null!=f?f:(0,c._t)("voip|voice_call")},o.createElement(rg.K,{disabled:!!f||w||S,"aria-label":null!=f?f:(0,c._t)("voip|voice_call"),onClick:e=>_(e,C[0])},o.createElement(TT,null)));const $=o.createElement(rn.m,{label:(0,c._t)("voip|close_lobby")},o.createElement(rg.K,{onClick:E},o.createElement(PT.A,null)));let J=K;S?J=U:w&&(J=$),R||(J=void 0),k||(q=void 0);const Y=(0,yr.ME)("mainSplitContentType"),X=(0,Cx.j)(e),Q=X||Y.mainSplitContentType===kn.DZ.MaximisedWidget||Y.mainSplitContentType===kn.DZ.Call;return o.createElement(o.Fragment,null,o.createElement(YT.L,{roomId:e.roomId},o.createElement(Fe.s,{as:"header",align:"center",gap:"var(--cpd-space-3x)",className:"mx_RoomHeader light-panel"},o.createElement(Zf.Ay,{room:e,size:"8px"},o.createElement(Tn.A,{room:e,size:"40px",oobData:n,onClick:()=>{x.A.dispatch({action:"open_room_settings",initial_tab_id:Yt.e.General})},tabIndex:-1,"aria-label":(0,c._t)("room|header_avatar_open_settings_label")})),o.createElement("button",{"aria-label":(0,c._t)("right_panel|room_summary_card|title"),tabIndex:0,onClick:()=>lg.A.instance.showOrHidePhase(cg.n.RoomSummary),className:"mx_RoomHeader_infoWrapper"},o.createElement(QS,{flex:"1",className:"mx_RoomHeader_info"},o.createElement(RT,{as:"div",size:"lg",weight:"semibold",dir:"auto",role:"heading","aria-level":1,className:"mx_RoomHeader_heading"},o.createElement("span",{className:"mx_RoomHeader_truncated mx_lineClamp"},s),!D&&a===i.JoinRule.Public&&o.createElement(rn.m,{label:(0,c._t)("common|public_room"),placement:"right"},o.createElement(Kf,{width:"16px",height:"16px",className:"mx_RoomHeader_icon",color:"var(--cpd-color-icon-info-primary)","aria-label":(0,c._t)("common|public_room")})),D&&M===qS.z.Verified&&o.createElement(rn.m,{label:(0,c._t)("common|verified"),placement:"right"},o.createElement(eI.A,{width:"16px",height:"16px",className:"mx_RoomHeader_icon mx_Verified","aria-label":(0,c._t)("common|verified")})),D&&M===qS.z.Warning&&o.createElement(rn.m,{label:(0,c._t)("room|header_untrusted_label"),placement:"right"},o.createElement(Te.A,{width:"16px",height:"16px",className:"mx_RoomHeader_icon mx_Untrusted","aria-label":(0,c._t)("room|header_untrusted_label")}))),m&&o.createElement(RT,{as:"div",size:"sm",className:"mx_RoomHeader_contributionValue",style:{color:"var(--cpd-color-text-secondary)",marginTop:"2px"}},"Kudos Value: ",m,"B"),h&&null!==p&&o.createElement(RT,{as:"div",size:"sm",className:"mx_RoomHeader_votingPower",style:{color:"var(--cpd-color-text-secondary)",marginTop:"2px"}},"My Voting Power: ",p))),null==t?void 0:t.map(e=>{const t=e.label();return o.createElement(rn.m,{label:t,key:e.id},o.createElement(rg.K,{"aria-label":t,onClick:t=>{t.stopPropagation(),e.onClick()}},"function"==typeof e.icon?e.icon():e.icon))}),w&&o.createElement($T,{room:e}),!A||S||w?o.createElement(o.Fragment,null,!X&&J,!T&&!X&&q):B,Q&&o.createElement(KT,{room:e}),o.createElement(rn.m,{label:(0,c._t)("common|threads")},o.createElement(rg.K,{indicator:(0,dr.W7)(P),onClick:e=>{e.stopPropagation(),lg.A.instance.showOrHidePhase(cg.n.ThreadPanel),Si.A.trackInteraction("WebRoomHeaderButtonsThreadsButton",e)},"aria-label":(0,c._t)("common|threads")},o.createElement(GT,{Icon:ar,phase:cg.n.ThreadPanel}))),O&&o.createElement(rn.m,{label:(0,c._t)("notifications|enable_prompt_toast_title")},o.createElement(rg.K,{indicator:(0,dr.W7)(N.level),onClick:e=>{e.stopPropagation(),lg.A.instance.showOrHidePhase(cg.n.NotificationPanel)},"aria-label":(0,c._t)("notifications|enable_prompt_toast_title")},o.createElement(GT,{Icon:ff,phase:cg.n.NotificationPanel}))),o.createElement(rn.m,{label:(0,c._t)("right_panel|room_summary_card|title")},o.createElement(rg.K,{onClick:e=>{e.stopPropagation(),lg.A.instance.showOrHidePhase(cg.n.RoomSummary)},"aria-label":(0,c._t)("right_panel|room_summary_card|title")},o.createElement(GT,{Icon:DT,phase:cg.n.RoomSummary}))),!D&&o.createElement(RT,{as:"div",size:"sm",weight:"medium"},o.createElement(NI.A,{className:"mx_RoomHeader_members",members:g.slice(0,3),size:"20px",overflow:!1,viewUserOnClick:!1,tooltipLabel:(0,c._t)("room|header_face_pile_tooltip"),onClick:e=>{lg.A.instance.showOrHidePhase(cg.n.MemberList),e.stopPropagation()},"aria-label":(0,c._t)("common|n_members",{count:v})},(0,sn.B4)(v)))),F&&o.createElement(qT,{room:e})))}const tP=({roomWidth:e})=>{const t=(0,o.useRef)(null),i=(0,o.useRef)(new Map);return(0,o.useEffect)(()=>{const e=()=>{var e;t.current&&(null===(e=t.current)||void 0===e?void 0:e.height)!==Ja.A.instance.windowHeight&&(t.current.height=Ja.A.instance.windowHeight)},r=x.A.register(e=>{const r="effects.",o=function(e){if(!e)return!1;const t=Date.now(),n=e.getTs();return t-n>nP}(e.event);if(t.current&&e.action.startsWith(r)&&!o){(async e=>{if(!e)return null;let t=i.current.get(e)||null;if(null===t){var r;const o=null===(r=RC.y.find(t=>t.command===e))||void 0===r?void 0:r.options;try{const{default:r}=await n("./src/effects lazy recursive ^\\.\\/.*$ referencedExports: default")(`./${e}`);t=new r(o),i.current.set(e,t)}catch(t){s.vF.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.slice(8)).then(e=>null==e?void 0:e.start(t.current))}}),o=t.current;o&&(o.height=Ja.A.instance.windowHeight),Ja.A.instance.on(Ja.x.Resize,e);const a=i.current;return()=>{x.A.unregister(r),Ja.A.instance.off(Ja.x.Resize,e);for(const e in a){const t=a.get(e);t&&t.isRunning&&t.stop()}}},[]),o.createElement("canvas",{ref:t,width:e,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0},"aria-hidden":!0})},nP=1728e5;const iP=({room:e,resizing:t,call:n,skipLobby:i,role:r,onClose:s})=>{const a=(0,o.useContext)(ce.Ay);(0,lr.YK)(n,OT.$E.Close,s),(0,o.useEffect)(()=>{n.clean()},[n]),(0,o.useEffect)(()=>{var e,t;null!==(t=(e=n.widget).data)&&void 0!==t||(e.data={}),n.widget.data.skipLobby=i},[n.widget,i]);const l=(0,o.useCallback)(async()=>{const e=[...UT.e.instance.connectedCalls].filter(e=>as.M.instance.roomViewStore.getRoomId()!==e.roomId);await Promise.all(e.map(async e=>await e.disconnect()))},[]);return o.createElement("div",{className:"mx_CallView",role:r},o.createElement(hk,{app:n.widget,room:e,userId:a.credentials.userId,creatorUserId:n.widget.creatorUserId,waitForIframeLoad:n.widget.waitForIframeLoad,showMenubar:!1,pointerEvents:t?"none":void 0,stickyPromise:l}))},rP=({room:e,resizing:t,skipLobby:n,role:i,onClose:r})=>{const s=(0,Wv.Gc)(e.roomId);return s&&o.createElement(iP,{room:e,resizing:t,call:s,skipLobby:n,role:i,onClose:r})};var oP=n("./src/toasts/DesktopNotificationsToast.ts"),sP=n("./src/email.ts");const aP=(e,t)=>{const[n,i]=(0,o.useState)(()=>Array.isArray(t)?t:new Array(e).fill(t));return[n,(e,t)=>i(n=>{const i=[...n];return i[e]=t,i})]};var lP=n("./src/components/views/spaces/SpacePublicShare.tsx"),cP=n("./node_modules/matrix-js-sdk/src/@types/event.ts");class dP{constructor(e,t,n,i=!1){(0,S.A)(this,"viaMap",new Map),(0,S.A)(this,"backRefs",new Map),(0,S.A)(this,"roomMap",new Map),(0,S.A)(this,"loadRequest",void 0),(0,S.A)(this,"nextBatch",void 0),(0,S.A)(this,"_rooms",void 0),(0,S.A)(this,"serverSupportError",void 0),this.root=e,this.pageSize=t,this.maxDepth=n,this.suggestedOnly=i}get noSupport(){return!!this.serverSupportError}get canLoadMore(){return!!this.serverSupportError||!!this.nextBatch||!this._rooms}get loading(){return!!this.loadRequest}get rooms(){return this._rooms}async load(e=this.pageSize){if(this.loadRequest)return this.loadRequest.then(e=>e.rooms);let t;this.loadRequest=this.root.client.getRoomHierarchy(this.root.roomId,e,this.maxDepth,this.suggestedOnly,this.nextBatch);try{({rooms:t,next_batch:this.nextBatch}=await this.loadRequest)}catch(e){if("M_UNRECOGNIZED"!==e.errcode)throw e;return this.serverSupportError=e,[]}finally{this.loadRequest=void 0}return this._rooms?this._rooms=this._rooms.concat(t):this._rooms=t,t.forEach(e=>{this.roomMap.set(e.room_id,e),e.children_state.forEach(t=>{if(t.type!==cP.Bx.SpaceChild)return;const n=t.state_key;if(this.backRefs.has(n)||this.backRefs.set(n,[]),this.backRefs.get(n).push(e.room_id),Array.isArray(t.content.via)){this.viaMap.has(n)||this.viaMap.set(n,new Set);const e=this.viaMap.get(n);t.content.via.forEach(t=>e.add(t))}})}),t}getRelation(e,t){var n;return null===(n=this.roomMap.get(e))||void 0===n?void 0:n.children_state.find(e=>e.state_key===t)}isSuggested(e,t){var n;return null===(n=this.getRelation(e,t))||void 0===n?void 0:n.content.suggested}removeRelation(e,t){const n=this.backRefs.get(t);1===(null==n?void 0:n.length)?this.backRefs.delete(t):null!=n&&n.length&&this.backRefs.set(t,n.filter(t=>t!==e));const i=this.roomMap.get(e);i&&(i.children_state=i.children_state.filter(e=>e.state_key!==t))}}var uP=n("./src/components/views/elements/InfoTooltip.tsx"),mP=n("./src/utils/RoomUpgrade.ts"),hP=n("./src/components/views/rooms/PollStatusIndicator.tsx");function pP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function gP(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pP(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pP(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const vP=({room:e,suggested:t,selected:n,hasPermissions:r,onToggleClick:s,onViewRoomClick:a,onJoinRoomClick:l,numChildRooms:d,children:u})=>{var m,h,p;const g=(0,o.useContext)(ce.Ay),v=(0,lr.DY)(g,i.ClientEvent.Room,()=>{const t=null==g?void 0:g.getRoom(e.room_id);return(null==t?void 0:t.getMyMembership())===Xt.O.Join?t:void 0}),f=(0,lr.DY)(v,i.RoomEvent.Name,e=>null==e?void 0:e.name),_=v&&"DCA"===v.name?"DCA":f||e.name||e.canonical_alias||(null===(m=e.aliases)||void 0===m?void 0:m[0])||(e.room_type===i.RoomType.Space?(0,c._t)("common|unnamed_space"):(0,c._t)("common|unnamed_room")),y=v&&"GOV"===v.name,[b,E]=(0,Go.X)(!y),[w,S,x,A]=(0,mi.A9)(),[C,k]=(0,o.useState)(!1),R=(0,o.useId)(),I=e=>{e.preventDefault(),e.stopPropagation(),a()},T=async t=>{k(!0),t.preventDefault(),t.stopPropagation();try{await l(),await(0,mP.R)(g,e.room_id)}finally{k(!1)}};let P,N,D;P=C?o.createElement(ae.A,{disabled:!0,onClick:T,kind:"primary_outline",onFocus:w,tabIndex:S?0:-1,title:(0,c._t)("space|joining_space")},o.createElement(le.A,{w:24,h:24})):v||e.join_rule===i.JoinRule.Knock?o.createElement(ae.A,{onClick:I,kind:"primary_outline",onFocus:w,tabIndex:S?0:-1},(0,c._t)("action|view")):o.createElement(ae.A,{onClick:T,kind:"primary",onFocus:w,tabIndex:S?0:-1},(0,c._t)("action|join")),s&&(N=r?o.createElement(Io.A,{role:"presentation","aria-labelledby":R,checked:!!n,tabIndex:-1}):o.createElement(SC.A,{tooltip:(0,c._t)("space|user_lacks_permission"),onClick:e=>{e.stopPropagation()}},o.createElement(Io.A,{role:"presentation","aria-labelledby":R,disabled:!0,tabIndex:-1}))),D=v?o.createElement(Tn.A,{room:v,size:"20px"}):o.createElement(Xp.A,{name:_,idName:e.room_id,url:e.avatar_url?(0,Vi.mediaFromMxc)(e.avatar_url).getSquareThumbnailHttp(20):null,size:"20px"});let M,O,F,L,U,B=(0,c._t)("common|n_members",{count:null!==(h=e.num_joined_members)&&void 0!==h?h:0});if(void 0!==d&&(B+="  "+(0,c._t)("common|n_rooms",{count:d})),v){const e=jo(v);M=(0,ji.sH)(null==e?void 0:e.text,null==e?void 0:e.html)}else M=e.topic;M&&(O=o.createElement(ji.XZ,{options:{attributes:{onClick(e){e.stopPropagation()}}}},"  ",M)),v&&(F=o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_joined"},(0,c._t)("common|joined"))),!t||v&&!r||(L=o.createElement(uP.A,{tooltip:(0,c._t)("space|suggested_tooltip")},(0,c._t)("space|suggested"))),v&&null!==(p=v.name)&&void 0!==p&&p.includes("Proposal #")&&(U=o.createElement(hP.A,{room:v,className:"mx_SpaceHierarchy_pollStatus"}));const V=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_item"},o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_avatar"},D),o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_name"},o.createElement("span",{id:R},_),F,L),o.createElement("div",{className:"mx_SpaceHierarchy_roomTile_info"},B,O)),o.createElement("div",{className:"mx_SpaceHierarchy_actions"},U,P,N));let j,z,H;if(u){if(j=o.createElement("div",{className:me()("mx_SpaceHierarchy_subspace_toggle",{mx_SpaceHierarchy_subspace_toggle_shown:b}),onClick:e=>{e.stopPropagation(),E()}}),b){const e=e=>{var t;if((0,uo.zM)().getAccessibilityAction(e)===Ei.bY.ArrowLeft)e.preventDefault(),e.stopPropagation(),null===(t=A.current)||void 0===t||t.focus()};z=o.createElement("div",{className:"mx_SpaceHierarchy_subspace_children",onKeyDown:e,role:"group"},u)}H=e=>{let t=!1;switch((0,uo.zM)().getAccessibilityAction(e)){case Ei.bY.ArrowLeft:b&&(t=!0,E());break;case Ei.bY.ArrowRight:if(t=!0,b){var n,i;const e=null===(n=A.current)||void 0===n?void 0:n.nextElementSibling;null==e||null===(i=e.querySelector(".mx_SpaceHierarchy_roomTile"))||void 0===i||i.focus()}else E()}t&&(e.preventDefault(),e.stopPropagation())}}const W=r&&s;return o.createElement("li",{className:"mx_SpaceHierarchy_roomTileWrapper",role:"treeitem","aria-selected":n,"aria-labelledby":R,"aria-expanded":u?b:void 0},o.createElement(ae.A,{className:me()("mx_SpaceHierarchy_roomTile",{mx_SpaceHierarchy_subspace:e.room_type===i.RoomType.Space,mx_SpaceHierarchy_joining:C}),onClick:W?s:I,onKeyDown:H,ref:x,onFocus:w,tabIndex:S?0:-1},V,j),z)},fP=(e,t,n,i)=>{var r,o;const s=t.roomMap.get(n);if(e.isGuest()&&!(null!=s&&s.world_readable||null!=s&&s.guest_can_join))return void x.A.dispatch({action:"require_registration"});const a=(0,ua.iW)(null!==(r=null==s?void 0:s.canonical_alias)&&void 0!==r?r:"",null!==(o=null==s?void 0:s.aliases)&&void 0!==o?o:[])||void 0;x.A.dispatch({action:W.r.ViewRoom,should_peek:!0,room_alias:a,room_id:n,via_servers:Array.from(t.viaMap.get(n)||[]),oob_data:{avatarUrl:null==s?void 0:s.avatar_url,name:(null==s?void 0:s.name)||a||(0,c._t)("common|unnamed_room"),roomType:i},metricsTrigger:"RoomDirectory"})},_P=async(e,t,n)=>{if(e.isGuest())x.A.dispatch({action:"require_registration"});else{try{await e.joinRoom(n,{viaServers:Array.from(t.viaMap.get(n)||[])})}catch(e){throw e instanceof i.MatrixError?as.M.instance.roomViewStore.showJoinRoomError(e,n):(s.vF.warn("Got a non-MatrixError while joining room",e),as.M.instance.roomViewStore.showJoinRoomError(new i.MatrixError({error:(0,c._t)("error|unknown")}),n)),e}x.A.dispatch({action:W.r.JoinRoomReady,roomId:n,metricsTrigger:"SpaceHierarchy"})}},yP=({root:e,roomSet:t,hierarchy:n,parents:r,selectedMap:s,onViewRoomClick:a,onJoinRoomClick:l,onToggleClick:c})=>{const d=(0,o.useContext)(ce.Ay),u=d.getRoom(e.room_id),m=null==u?void 0:u.currentState.maySendStateEvent(i.EventType.SpaceChild,d.getSafeUserId()),h=(0,Li.sortBy)(e.children_state,e=>(0,Ci.tK)(e.content.order,e.origin_server_ts,e.state_key)),[p,g]=h.reduce((e,r)=>{const o=n.roomMap.get(r.state_key);return o&&t.has(o)&&e[o.room_type===i.RoomType.Space?0:1].push(((e,t,n)=>{const r=e.getRoomUpgradeHistory(t.room_id,!0,O.A.getValue("feature_dynamic_room_predecessors"));let o=null;for(let e=r.length-1;e>=0;--e)if(n.roomMap.get(r[e].roomId)){o=r[e];break}var s,a,l,c,d;return o?gP(gP({},t),{},{room_id:o.roomId,room_type:o.getType(),name:o.name,topic:null===(s=o.currentState.getStateEvents(i.EventType.RoomTopic,""))||void 0===s?void 0:s.getContent().topic,avatar_url:null!==(a=o.getMxcAvatarUrl())&&void 0!==a?a:void 0,canonical_alias:null!==(l=o.getCanonicalAlias())&&void 0!==l?l:void 0,aliases:o.getAltAliases(),world_readable:(null===(c=o.currentState.getStateEvents(i.EventType.RoomHistoryVisibility,""))||void 0===c?void 0:c.getContent().history_visibility)===i.HistoryVisibility.WorldReadable,guest_can_join:(null===(d=o.currentState.getStateEvents(i.EventType.RoomGuestAccess,""))||void 0===d?void 0:d.getContent().guest_access)===i.GuestAccess.CanJoin,num_joined_members:o.getJoinedMemberCount()}):t})(d,o,n)),e},[[],[]]);p.sort((e,t)=>{const n="GOV"===e.name||"DCA"===e.name,i="GOV"===t.name||"DCA"===t.name;if(n&&!i)return-1;if(!n&&i)return 1;if(n&&i){if("GOV"===e.name&&"DCA"===t.name)return-1;if("DCA"===e.name&&"GOV"===t.name)return 1}return 0});const v=new Set(r).add(e.room_id),f=p.filter(e=>!v.has(e.room_id)),_=f.filter(e=>"GOV"===e.name||"DCA"===e.name),y=f.filter(e=>"GOV"!==e.name&&"DCA"!==e.name),b=(0,Li.uniqBy)(g,"room_id");return o.createElement(o.Fragment,null,_.map(r=>{var d;return o.createElement(vP,{key:r.room_id,room:r,numChildRooms:r.children_state.filter(e=>{const i=n.roomMap.get(e.state_key);return i&&t.has(i)&&!i.room_type}).length,suggested:n.isSuggested(e.room_id,r.room_id),selected:null==s||null===(d=s.get(e.room_id))||void 0===d?void 0:d.has(r.room_id),onViewRoomClick:()=>a(r.room_id,i.RoomType.Space),onJoinRoomClick:()=>l(r.room_id,v),hasPermissions:m,onToggleClick:c?()=>c(e.room_id,r.room_id):void 0},o.createElement(yP,{root:r,roomSet:t,hierarchy:n,parents:v,selectedMap:s,onViewRoomClick:a,onJoinRoomClick:l,onToggleClick:c}))}),b.map(t=>{var i;return o.createElement(vP,{key:t.room_id,room:t,suggested:n.isSuggested(e.room_id,t.room_id),selected:null==s||null===(i=s.get(e.room_id))||void 0===i?void 0:i.has(t.room_id),onViewRoomClick:()=>a(t.room_id,t.room_type),onJoinRoomClick:()=>l(t.room_id,v),hasPermissions:m,onToggleClick:c?()=>c(e.room_id,t.room_id):void 0})}),y.map(r=>{var d;return o.createElement(vP,{key:r.room_id,room:r,numChildRooms:r.children_state.filter(e=>{const i=n.roomMap.get(e.state_key);return i&&t.has(i)&&!i.room_type}).length,suggested:n.isSuggested(e.room_id,r.room_id),selected:null==s||null===(d=s.get(e.room_id))||void 0===d?void 0:d.has(r.room_id),onViewRoomClick:()=>a(r.room_id,i.RoomType.Space),onJoinRoomClick:()=>l(r.room_id,v),hasPermissions:m,onToggleClick:c?()=>c(e.room_id,r.room_id):void 0},o.createElement(yP,{root:r,roomSet:t,hierarchy:n,parents:v,selectedMap:s,onViewRoomClick:a,onJoinRoomClick:l,onToggleClick:c}))}))},bP=({hierarchy:e,selected:t,setSelected:n,setError:r})=>{const s=(0,o.useContext)(ce.Ay),[a,l]=(0,o.useState)(!1),[d,u]=(0,o.useState)(!1),m=Array.from(t.keys()).flatMap(e=>[...t.get(e).values()].map(t=>[e,t])),h=m.every(([t,n])=>e.isSuggested(t,n)),p=!m.length||a||d;let g=(0,c._t)("common|saving");d||(g=h?(0,c._t)("space|unmark_suggested"):(0,c._t)("space|mark_suggested"));const v=m.length?void 0:(0,c._t)("space|select_room_below");return o.createElement(o.Fragment,null,o.createElement(ae.A,{onClick:async()=>{l(!0);try{const t=s.getSafeUserId();for(const[n,r]of m){await s.sendStateEvent(n,i.EventType.SpaceChild,{},r);const o=s.getRoom(r),a=null==o?void 0:o.currentState.getStateEvents(i.EventType.SpaceParent,n);null!=o&&o.currentState.maySendStateEvent(i.EventType.SpaceParent,t)&&Array.isArray(null==a?void 0:a.getContent().via)&&await s.sendStateEvent(r,i.EventType.SpaceParent,{},n),e.removeRelation(n,r)}}catch{r((0,c._t)("space|failed_remove_rooms"))}l(!1),n(new Map)},kind:"danger_outline",disabled:p,"aria-label":a?(0,c._t)("redact|ongoing"):(0,c._t)("action|remove"),title:v,placement:"top"},a?(0,c._t)("redact|ongoing"):(0,c._t)("action|remove")),o.createElement(ae.A,{onClick:async()=>{u(!0);try{for(const[n,r]of m){var t;const o=!h,a=null===(t=e.getRelation(n,r))||void 0===t?void 0:t.content;if(!a||a.suggested===o)continue;const l=gP(gP({},a),{},{suggested:!h});await s.sendStateEvent(n,i.EventType.SpaceChild,l,r),a.suggested=l.suggested}}catch{r("Failed to update some suggestions. Try again later")}u(!1),n(new Map)},kind:"primary_outline",disabled:p,"aria-label":g,title:v,placement:"top"},g))},EP=({space:e,initialText:t="",showRoom:n,additionalButtons:r})=>{const s=(0,o.useContext)(ce.Ay),[a,l]=(0,o.useState)(t),[d,u]=(0,o.useState)(new Map),{loading:m,rooms:h,hierarchy:p,loadMore:g,error:v}=(e=>{const[t,n]=(0,o.useState)([]),[i,r]=(0,o.useState)(),[s,a]=(0,o.useState)(),l=(0,o.useCallback)(()=>{a(void 0);const t=new dP(e,20);t.load().then(()=>{var i;e===t.root&&n(null!==(i=t.rooms)&&void 0!==i?i:[])},a),r(t)},[e]);(0,o.useEffect)(l,[l]),(0,Lo.F)(x.A,e=>{e.action===W.r.UpdateSpaceHierarchy&&(n([]),l())});const c=(0,o.useCallback)(async e=>{var t;!i||i.loading||!i.canLoadMore||i.noSupport||s||(await i.load(e).catch(a),n(null!==(t=i.rooms)&&void 0!==t?t:[]))},[s,i]);return(null==i?void 0:i.root)!==e?{loading:!0,loadMore:c}:{loading:i.loading,rooms:t,hierarchy:i,loadMore:c,error:s}})(e),f=(0,o.useMemo)(()=>{if(null==h||!h.length||!p)return new Set;const e=a.toLowerCase().trim();if(!e)return new Set(h);const t=h.filter(t=>{var n,i;return(null===(n=t.name)||void 0===n?void 0:n.toLowerCase().includes(e))||(null===(i=t.topic)||void 0===i?void 0:i.toLowerCase().includes(e))}),n=new Set,i=[...t.map(e=>e.room_id)];for(;i.length;){var r;const e=i.pop();n.add(e),null===(r=p.backRefs.get(e))||void 0===r||r.forEach(e=>{n.has(e)||i.push(e)})}return new Set(h.filter(e=>n.has(e.room_id)))},[h,p,a]),[_,y]=(0,o.useState)("");let b=_;!_&&v&&(b=(0,c._t)("space|failed_load_rooms"));const E=(e=>{const t=t=>{t[0].isIntersecting&&e()},n=(0,o.useRef)(void 0);return e=>{n.current?n.current.disconnect():e&&(n.current=new IntersectionObserver(t,{root:e.parentElement,rootMargin:"0px 0px 600px 0px"})),n.current&&e&&n.current.observe(e)}})(g);if(!m&&p.noSupport)return o.createElement("p",null,(0,c._t)("space|incompatible_server_hierarchy"));const w=(e,t)=>{if(y(""),!d.has(e))return void u(new Map(d.set(e,new Set([t]))));const n=d.get(e);n.has(t)?(n.delete(t),u(new Map(d.set(e,new Set(n))))):u(new Map(d.set(e,new Set([...n,t]))))};return o.createElement(mi.Se,{onKeyDown:(e,t)=>{var n;(0,uo.zM)().getAccessibilityAction(e)===Ei.bY.ArrowDown&&e.currentTarget.classList.contains("mx_SpaceHierarchy_search")&&(null===(n=t.nodes[0])||void 0===n||n.focus())},handleHomeEnd:!0,handleUpDown:!0},({onKeyDownHandler:g})=>{let v;if(p&&(!m||null!=h&&h.length)){const t=(null==e?void 0:e.getMyMembership())===Xt.O.Join&&e.currentState.maySendStateEvent(i.EventType.SpaceChild,s.getSafeUserId()),l=p.roomMap.get(e.roomId);let m,h;f.size&&l?m=o.createElement(o.Fragment,null,o.createElement(yP,{root:l,roomSet:f,hierarchy:p,parents:new Set,selectedMap:d,onToggleClick:t?w:void 0,onViewRoomClick:(e,t)=>n(s,p,e,t),onJoinRoomClick:async(e,t)=>{for(const e of t){var n;(null===(n=s.getRoom(e))||void 0===n?void 0:n.getMyMembership())!==Xt.O.Join&&await _P(s,p,e)}await _P(s,p,e)}})):p.canLoadMore||(m=o.createElement("div",{className:"mx_SpaceHierarchy_noResults"},o.createElement("h3",null,(0,c._t)("common|no_results_found")),o.createElement("div",null,(0,c._t)("space|no_search_result_hint")))),p.canLoadMore&&(h=o.createElement("div",{ref:E},o.createElement(le.A,null))),v=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_SpaceHierarchy_listHeader"},o.createElement("h4",{className:"mx_SpaceHierarchy_listHeader_header"},a.trim()?(0,c._t)("space|title_when_query_available"):(0,c._t)("space|title_when_query_unavailable")),o.createElement("div",{className:"mx_SpaceHierarchy_listHeader_buttons"},r,t&&o.createElement(bP,{hierarchy:p,selected:d,setSelected:u,setError:y}))),b&&o.createElement("div",{className:"mx_SpaceHierarchy_error"},b),o.createElement("ul",{className:"mx_SpaceHierarchy_list",onKeyDown:g,role:"tree","aria-label":(0,c._t)("common|space")},m),h)}else v=o.createElement(le.A,null);return o.createElement(o.Fragment,null,o.createElement(eo.A,{className:"mx_SpaceHierarchy_search mx_textinput_icon mx_textinput_search",placeholder:(0,c._t)("space|search_placeholder"),onSearch:l,autoFocus:!0,initialValue:t,onKeyDown:g}),v)})},wP=({space:e})=>{const[t,i]=(0,o.useState)(null),[r,s]=(0,o.useState)(!1),[a,l]=(0,o.useState)(""),[c,d]=(0,o.useState)(!1),[u,m]=(0,o.useState)(null),h=QT.y.getInstance(),p=e.roomId,g=e.name,v=(0,o.useCallback)(e=>{console.log(` DAOWalletSection: Wallet update received for ${g}`,e);if(e.find(e=>e.daoId===p)){const e=h.getDAOWallet(p);console.log(` DAOWalletSection: Updated wallet data for ${g}:`,e),console.log(` DAOWalletSection: Current balance: ${null==e?void 0:e.balance}B`),i(null),setTimeout(()=>{i(e),console.log(` DAOWalletSection: State updated for ${g}`)},10)}else console.log(` DAOWalletSection: No wallet found for ${g}`),i(null)},[p,g,h]);(0,o.useEffect)(()=>{const e=h.getDAOWallet(p);if(e)i(e);else{const e=h.getAllDAOWallets();if(e.length>0){const t=h.getDAOWallet(e[0].daoId);t&&h.createDAOWalletFromMnemonic(p,g,"B",1,t.mnemonic).then(e=>{i(e),console.log(`Auto-connected wallet to ${g}`)}).catch(e=>{console.warn(`Failed to auto-connect wallet to ${g}:`,e)})}}return h.addListener(v),()=>h.removeListener(v)},[p,g,h,v]);const _=(0,o.useCallback)(async()=>{d(!0),m(null);try{const e=await h.createDAOWallet(p,g);i(e);f.J.safeGet();const t=Ci.Ay.instance.spacePanelSpaces.filter(e=>e.name&&e.roomId.startsWith("!")&&e.roomId!==p);for(const n of t)try{await h.createDAOWalletFromMnemonic(n.roomId,n.name,"B",1,e.mnemonic)}catch(e){console.warn(`Failed to create wallet for ${n.name}:`,e)}const n=`Mnemonic: ${e.mnemonic}\nAddress: ${e.address}`;R.Ay.createDialog(zp.A,{title:"Wallet Created Successfully",description:o.createElement("div",null,o.createElement("p",null,o.createElement("strong",null,"MyWallet has been created!")),o.createElement("p",null,"You can use the same wallet across all DAOs."),o.createElement("div",{style:{backgroundColor:"#f5f5f5",padding:"15px",borderRadius:"4px",fontFamily:"monospace",wordBreak:"break-all",margin:"10px 0",fontSize:"12px",lineHeight:"1.4"}},o.createElement("div",null,o.createElement("strong",null,"Wallet Address:")," ",e.address),o.createElement("div",null,o.createElement("strong",null,"Mnemonic:")," ",e.mnemonic)),o.createElement("div",{style:{marginTop:"15px"}},o.createElement(ae.A,{kind:"primary",onClick:()=>{navigator.clipboard.writeText(n);const e=document.activeElement,t=e.textContent;e.textContent="Copied!",setTimeout(()=>{e.textContent=t},1e3)},style:{fontSize:"14px",padding:"8px 16px"}},"Copy All Information")),o.createElement("p",null,o.createElement("em",null,"Please keep your mnemonic phrase in a safe place."))),button:"OK"}),ki.n.getInstance().initialize()}catch(e){m(e instanceof Error?e.message:"Failed to create wallet")}finally{d(!1)}},[h,p,g]),y=(0,o.useCallback)(async()=>{if(a.trim()){d(!0),m(null);try{if(!h.validateMnemonicPhrase(a.trim()))throw new Error("Invalid mnemonic phrase");const e=await h.createDAOWalletFromMnemonic(p,g,"B",1,a.trim());i(e);f.J.safeGet();const t=Ci.Ay.instance.spacePanelSpaces.filter(e=>e.name&&e.roomId.startsWith("!")&&e.roomId!==p);for(const e of t)try{await h.createDAOWalletFromMnemonic(e.roomId,e.name,"B",1,a.trim())}catch(t){console.warn(`Failed to restore wallet for ${e.name}:`,t)}R.Ay.createDialog(zp.A,{title:"  ",description:o.createElement("div",null,o.createElement("p",null,o.createElement("strong",null," !")),o.createElement("p",null," DAO     ."),o.createElement("p",null," : ",o.createElement("code",null,e.address)),o.createElement("p",null," : ",o.createElement("strong",null,e.balance,"B")),e.balance>0&&o.createElement("p",null,o.createElement("em",null,"      ."))),button:""}),ki.n.getInstance().initialize(),s(!1),l("")}catch(e){m(e instanceof Error?e.message:"Failed to restore wallet")}finally{d(!1)}}else m("Please enter a mnemonic phrase")},[h,p,g,a]),b=(0,o.useCallback)(()=>{try{if(!t)throw new Error("Wallet information not found");const e=`DAO: ${p}\nName: ${g}\nMnemonic: ${t.mnemonic}\nAddress: ${t.address}\n\n`,n=new Blob([e],{type:"text/plain; charset=utf-8"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=`${g}-wallet-${(new Date).toISOString().split("T")[0]}.txt`,r.click(),URL.revokeObjectURL(i)}catch(e){m(e instanceof Error?e.message:"Failed to export wallet")}},[t,p,g]),E=(0,o.useCallback)(async()=>{if(!t)return;const i=await n.e(934).then(n.bind(n,"./src/components/views/dialogs/QRCodeDialog.tsx"));R.Ay.createDialog(i.default,{address:t.address,daoName:g,space:e})},[t,g,e]),w=(0,o.useCallback)(()=>{if(!t)return;if(confirm("Are you sure you want to delete your wallet?\n\nAll DAO wallets will be deleted and can only be recovered with your mnemonic phrase."))try{h.getAllDAOWallets().forEach(e=>{h.deleteDAOWallet(e.daoId)}),i(null),R.Ay.createDialog(zp.A,{title:"Wallet Deleted Successfully",description:"All DAO wallets have been deleted. You can recover them anytime with your mnemonic phrase.",button:""})}catch(e){console.error("Failed to delete wallets:",e),R.Ay.createDialog(zp.A,{title:"Deletion Failed",description:"An error occurred while deleting the wallet.",button:""})}},[t,h]),S=(0,o.useCallback)(async()=>{if(!t)return;console.log(` Opening send dialog for ${g}`);const e=await n.e(9175).then(n.bind(n,"./src/components/views/dialogs/SendTokenDialog.tsx"));R.Ay.createDialog(e.default,{daoId:p,daoName:g,senderAddress:t.address,maxBalance:t.balance,currency:t.currency})},[t,p,g]),x=(0,o.useCallback)(async()=>{if(!t)return;console.log(` Opening transaction history for ${g}`);const e=await n.e(2656).then(n.bind(n,"./src/components/views/dialogs/TransactionHistoryDialog.tsx"));R.Ay.createDialog(e.default,{daoId:p,daoName:g,walletAddress:t.address})},[t,p,g]);return t?o.createElement("div",{className:"mx_DAOWalletSection"},o.createElement("div",{className:"mx_DAOWalletSection_header"},o.createElement("h3",null,"Balance: ",g," DAO")),o.createElement("div",{className:"mx_DAOWalletSection_walletInfo"},o.createElement("div",{className:"mx_DAOWalletSection_address"},o.createElement("span",{className:"mx_DAOWalletSection_label"},"Address"),o.createElement("div",{className:"mx_DAOWalletSection_addressRow"},o.createElement("div",{className:"mx_DAOWalletSection_addressValue"},t.address),o.createElement("a",{href:"#",className:"mx_DAOWalletSection_copyLink",onClick:e=>{e.preventDefault(),navigator.clipboard.writeText(t.address);const n=e.currentTarget,i=n.textContent;n.textContent="Copied!",setTimeout(()=>{n.textContent=i},1e3)}},"Copy"))),o.createElement("div",{className:"mx_DAOWalletSection_balance"},o.createElement("span",{className:"mx_DAOWalletSection_label"},"Balance"),o.createElement("div",{className:"mx_DAOWalletSection_balanceValue"},(A=t.balance,(new Intl.NumberFormat).format(A))," ",t.currency)),o.createElement("div",{className:"mx_DAOWalletSection_actions"},o.createElement("a",{href:"#",className:"mx_DAOWalletSection_actionLink",onClick:e=>{e.preventDefault(),b()}},"Backup"),o.createElement("a",{href:"#",className:"mx_DAOWalletSection_actionLink mx_DAOWalletSection_deleteLink",onClick:e=>{e.preventDefault(),w()}},"Delete"),o.createElement("a",{href:"#",className:"mx_DAOWalletSection_actionLink",onClick:e=>{e.preventDefault(),E()}},"QR"),o.createElement(ae.A,{kind:"secondary",className:"mx_DAOWalletSection_historyButton",onClick:x,style:{marginLeft:"auto",marginRight:"8px"}},"History"),o.createElement(ae.A,{kind:"primary",className:"mx_DAOWalletSection_sendButton",onClick:S},"Send")))):o.createElement("div",{className:"mx_DAOWalletSection"},o.createElement("div",{className:"mx_DAOWalletSection_header"},o.createElement("h3",null,"DAO Wallet"),o.createElement("p",null,"Create or restore your dedicated DAO wallet")),u&&o.createElement("div",{className:"mx_DAOWalletSection_error"},u),r?o.createElement("div",{className:"mx_DAOWalletSection_restore"},o.createElement(wo.A,{label:"Mnemonic Phrase (12 words)",placeholder:"word1 word2 word3 ...",value:a,onChange:e=>l(e.target.value),type:"text"}),o.createElement("div",{className:"mx_DAOWalletSection_restoreActions"},o.createElement(ae.A,{kind:"primary",onClick:y,disabled:c||!a.trim()},c?o.createElement(le.A,{w:16,h:16}):"Restore"),o.createElement(ae.A,{kind:"secondary",onClick:()=>{s(!1),l(""),m(null)},disabled:c},"Cancel"))):o.createElement("div",{className:"mx_DAOWalletSection_actions"},o.createElement(ae.A,{kind:"primary",onClick:_,disabled:c,className:"mx_DAOWalletSection_createButton"},c?o.createElement(le.A,{w:16,h:16}):"Create New Wallet"),o.createElement(ae.A,{kind:"secondary",onClick:()=>s(!0),disabled:c,className:"mx_DAOWalletSection_restoreButton"},"Restore Existing Wallet")));var A};var SP=function(e){return e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms",e}(SP||{});const xP=({space:e})=>{var t;const[n,r,s,a]=(0,Nn.EF)(),l=(0,Ya.g)(It.C.CreateRooms),d=((0,Ya.g)(It.C.CreateSpaces),(0,Qt.ny)("feature_video_rooms")),u=(0,Qt.ny)("feature_element_call_video_rooms"),m="GOV"===e.name||(null===(t=e.getCanonicalAlias())||void 0===t?void 0:t.includes("gov"))||e.roomId.includes("gov");let h=null;if(n){const t=r.current.getBoundingClientRect();h=o.createElement(Qa.Ay,{left:t.left+window.scrollX+0,top:t.bottom+window.scrollY+8,chevronFace:Nn.t4.None,onFinished:a,className:"mx_RoomTile_contextMenu",compact:!0},o.createElement(Qa.tx,{first:!0},l&&o.createElement(o.Fragment,null,o.createElement(Qa.R$,{label:m?"New agenda":(0,c._t)("action|new_room"),iconClassName:"mx_LegacyRoomList_iconNewRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),a(),Si.A.trackInteraction("WebSpaceHomeCreateRoomButton",t),await(0,ss.PT)(e)&&x.A.fire(W.r.UpdateSpaceHierarchy)}}),d&&o.createElement(Qa.R$,{label:(0,c._t)("action|new_video_room"),iconClassName:"mx_LegacyRoomList_iconNewVideoRoom",onClick:async t=>{t.preventDefault(),t.stopPropagation(),a(),await(0,ss.PT)(e,u?i.RoomType.UnstableCall:i.RoomType.ElementVideo)&&x.A.fire(W.r.UpdateSpaceHierarchy)}},o.createElement(Xa.s,null)))))}return o.createElement(o.Fragment,null,o.createElement(Nn.VJ,{kind:"primary",ref:r,onClick:s,isExpanded:n,label:(0,c._t)("action|add")},(0,c._t)("action|add")),h)},AP=({space:e})=>{var t;const n=(0,o.useContext)(ce.Ay),r=PI(e),s=n.getSafeUserId(),a=(e=>{const t=Ci.Ay.instance.getChildren(e.roomId).filter(e=>e.isSpaceRoom()),n=t.some(e=>"GOV"===e.name),i=t.some(e=>"DCA"===e.name);return n&&i})(e),l=a?(e=>{const t=Ci.Ay.instance.getChildren(e.roomId).filter(e=>e.isSpaceRoom());return{gov:t.find(e=>"GOV"===e.name),dca:t.find(e=>"DCA"===e.name)}})(e):{},d=(0,o.useCallback)(()=>{var t;return lg.A.instance.isOpenForRoom(e.roomId)&&(null===(t=lg.A.instance.currentCardForRoom(e.roomId))||void 0===t?void 0:t.phase)===cg.n.MemberList},[e.roomId]),u=(0,lr.dF)(lg.A.instance,ha.H,d);let m;(0,ss.MI)(e)&&(0,Ya.g)(It.C.InviteUsers)&&(m=o.createElement(ae.A,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{(0,ss.Lo)(e)}},(0,c._t)("action|invite")));let h,p;r===Xt.O.Join&&e.currentState.maySendStateEvent(i.EventType.SpaceChild,s)&&(h=o.createElement(xP,{space:e})),(0,ss.Kv)(e)&&(p=o.createElement(ae.A,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{(0,ss.hL)(e)},title:(0,c._t)("common|settings"),placement:"bottom"}));return o.createElement("div",{className:"mx_SpaceRoomView_landing"},o.createElement("div",{className:"mx_SpaceRoomView_landing_header"},o.createElement(Tn.A,{room:e,size:"80px",viewAvatarOnClick:!0,type:"square"})),o.createElement("div",{className:"mx_SpaceRoomView_landing_name"},o.createElement(To,{room:e},e=>{const t={name:()=>o.createElement("h1",null,e)};return(0,c._t)("space|landing_welcome",{},t)}),a&&o.createElement("div",{className:"mx_SpaceRoomView_landing_address"},e.getCanonicalAlias()||`#${null===(t=e.name)||void 0===t?void 0:t.toLowerCase().replace(/\s+/g,"-")}:${n.getDomain()}`)),o.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar"},o.createElement(LI,{room:e}),o.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar_interactive"},o.createElement(FI,{room:e,onlyKnownUsers:!1,numShown:7,onClick:u?void 0:()=>{lg.A.instance.setCard({phase:cg.n.MemberList})}}),m,p)),o.createElement(eC,{room:e,className:"mx_SpaceRoomView_landing_topic"}),a&&o.createElement(wP,{space:e}),a&&o.createElement("div",{className:"mx_SpaceRoomView_landing_daoButtons"},l.gov&&o.createElement(ae.A,{className:"mx_SpaceRoomView_landing_daoButton mx_SpaceRoomView_landing_daoButton_gov",onClick:()=>x.A.dispatch({action:W.r.ViewRoom,room_id:l.gov.roomId,metricsTrigger:"SpaceLanding"})},o.createElement("div",{className:"mx_SpaceRoomView_landing_daoButton_title"},"GOV"),o.createElement("div",{className:"mx_SpaceRoomView_landing_daoButton_description"},"Contribution-weighted Governance")),l.dca&&o.createElement(ae.A,{className:"mx_SpaceRoomView_landing_daoButton mx_SpaceRoomView_landing_daoButton_dca",onClick:()=>x.A.dispatch({action:W.r.ViewRoom,room_id:l.dca.roomId,metricsTrigger:"SpaceLanding"})},o.createElement("div",{className:"mx_SpaceRoomView_landing_daoButton_title"},"DCA"),o.createElement("div",{className:"mx_SpaceRoomView_landing_daoButton_description"},"Development through Contribution Activities"))),o.createElement(EP,{space:e,showRoom:fP,additionalButtons:h}))},CP=({space:e,title:t,description:n,onFinished:r})=>{const[a,l]=(0,o.useState)(!1),[d,u]=(0,o.useState)(""),m=[(0,c._t)("common|general"),(0,c._t)("common|random"),(0,c._t)("common|support")],[h,p]=aP(3,[(0,c._t)("common|general"),(0,c._t)("common|random"),""]),g=new Array(3).fill(0).map((e,t)=>{const n="roomName"+t;return o.createElement(wo.A,{key:n,name:n,type:"text",label:(0,c._t)("common|room_name"),placeholder:m[t],value:h[t],onChange:e=>p(t,e.target.value),autoFocus:2===t,disabled:a,autoComplete:"off"})}),v=async t=>{if(t.preventDefault(),!a){u(""),l(!0);try{var n;const t=e.getJoinRule()===i.JoinRule.Public,o=h.map(e=>e.trim()).filter(Boolean),s=await Promise.all(o.map(n=>(0,yo.Ay)(e.client,{createOpts:{preset:t?i.Preset.PublicChat:i.Preset.PrivateChat,name:n},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:e,joinRule:t?void 0:i.JoinRule.Restricted,suggested:!0})));r(null!==(n=s[0])&&void 0!==n?n:void 0)}catch(e){s.vF.error("Failed to create initial space rooms",e),u((0,c._t)("create_space|failed_create_initial_rooms"))}l(!1)}};let f=e=>{e.preventDefault(),r()},_=(0,c._t)("create_space|skip_action");return h.some(e=>e.trim())&&(f=v,_=a?(0,c._t)("create_space|creating_rooms"):(0,c._t)("action|continue")),o.createElement("div",null,o.createElement("h1",null,t),o.createElement("div",{className:"mx_SpaceRoomView_description"},n),d&&o.createElement("div",{className:"mx_SpaceRoomView_errorText"},d),o.createElement("form",{onSubmit:f,id:"mx_SpaceSetupFirstRooms"},g),o.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.createElement(ae.A,{kind:"primary",disabled:a,onClick:f,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:_})))},kP=({space:e,onFinished:t})=>o.createElement("div",null,o.createElement("h1",null,(0,c._t)("create_space|add_existing_rooms_heading")),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,c._t)("create_space|add_existing_rooms_description")),o.createElement(os.sS,{space:e,emptySelectionButton:o.createElement(ae.A,{kind:"primary",onClick:t},(0,c._t)("create_space|skip_action")),filterPlaceholder:(0,c._t)("space|room_filter_placeholder"),onFinished:t,roomsRenderer:os.FM,dmsRenderer:os.nZ})),RP=({justCreatedOpts:e,space:t,onFinished:n,firstRoomId:i})=>{var r;return o.createElement("div",{className:"mx_SpaceRoomView_publicShare"},o.createElement("h1",null,(0,c._t)("create_space|share_heading",{name:(null==e||null===(r=e.createOpts)||void 0===r?void 0:r.name)||t.name})),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,c._t)("create_space|share_description")),o.createElement(lP.A,{space:t}),o.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.createElement(ae.A,{kind:"primary",onClick:n},i?(0,c._t)("create_space|done_action_first_room"):(0,c._t)("create_space|done_action"))))},IP=({space:e,justCreatedOpts:t,onFinished:n})=>{var i;return o.createElement("div",{className:"mx_SpaceRoomView_privateScope"},o.createElement("h1",null,(0,c._t)("create_space|private_personal_heading")),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,c._t)("create_space|private_personal_description",{name:(null==t||null===(i=t.createOpts)||void 0===i?void 0:i.name)||e.name})),o.createElement(ae.A,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{n(!1)}},(0,c._t)("create_space|personal_space"),o.createElement("div",null,(0,c._t)("create_space|personal_space_description"))),o.createElement(ae.A,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{n(!0)}},(0,c._t)("create_space|private_space"),o.createElement("div",null,(0,c._t)("create_space|private_space_description"))))},TP=(0,Mx.A)({rules:[{key:"email",test:({value:e})=>!e||sP.X(e),invalid:()=>(0,c._t)("auth|email_field_label_invalid")}]}),PP=({space:e,onFinished:t})=>{const[n,i]=(0,o.useState)(!1),[r,a]=(0,o.useState)(""),l=[(0,o.useRef)(null),(0,o.useRef)(null),(0,o.useRef)(null)],[d,u]=aP(3,""),m=new Array(3).fill(0).map((e,t)=>{const i="emailAddress"+t;return o.createElement(wo.A,{key:i,name:i,type:"text",label:(0,c._t)("common|email_address"),placeholder:(0,c._t)("auth|email_field_label"),value:d[t],onChange:e=>u(t,e.target.value),ref:l[t],onValidate:TP,autoFocus:0===t,disabled:n})}),h=async r=>{if(r.preventDefault(),n)return;a("");for(const e of l){var o;if(!1===await(null===(o=e.current)||void 0===o?void 0:o.validate({allowEmpty:!0})))return e.current.focus(),void e.current.validate({allowEmpty:!0,focused:!0})}i(!0);const u=d.map(e=>e.trim()).filter(Boolean);try{const n=await(0,da.wq)(e.client,e.roomId,u),i=Object.keys(n.states).filter(e=>"error"===n.states[e]);i.length>0?(s.vF.log("Failed to invite users to space: ",n),a((0,c._t)("create_space|failed_invite_users",{csvUsers:i.join(", ")}))):t()}catch(e){s.vF.error("Failed to invite users to space: ",e),a((0,c._t)("invite|error_invite"))}i(!1)};let p=e=>{e.preventDefault(),t()},g=(0,c._t)("create_space|skip_action");return d.some(e=>e.trim())&&(p=h,g=n?(0,c._t)("create_space|inviting_users"):(0,c._t)("action|continue")),o.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},o.createElement("h1",null,(0,c._t)("create_space|invite_teammates_heading")),o.createElement("div",{className:"mx_SpaceRoomView_description"},(0,c._t)("create_space|invite_teammates_description")),r&&o.createElement("div",{className:"mx_SpaceRoomView_errorText"},r),o.createElement("form",{onSubmit:p,id:"mx_SpaceSetupPrivateInvite"},m),o.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},o.createElement(ae.A,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>(0,da._7)(e.roomId)},(0,c._t)("create_space|invite_teammates_by_username"))),o.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.createElement(ae.A,{kind:"primary",disabled:n,onClick:p,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:g})))};class NP extends o.PureComponent{constructor(e,t){var n;super(e,t),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"onMyMembership",(e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})}),(0,S.A)(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:lg.A.instance.isOpenForRoom(this.props.space.roomId)})}),(0,S.A)(this,"onAction",e=>{e.action!==W.r.ViewRoom||e.room_id!==this.props.space.roomId||this.setState({phase:SP.Landing})}),(0,S.A)(this,"goToFirstRoom",async()=>{this.state.firstRoomId?x.A.dispatch({action:W.r.ViewRoom,room_id:this.state.firstRoomId,metricsTrigger:void 0}):this.setState({phase:SP.Landing})});let r=SP.Landing;const o=null===(n=this.props.space.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===n?void 0:n.getSender();var s;this.props.justCreatedOpts&&t.getSafeUserId()===o&&(r=(null===(s=this.props.justCreatedOpts.createOpts)||void 0===s?void 0:s.preset)===i.Preset.PublicChat?SP.PublicCreateRooms:SP.PrivateScope);this.state={phase:r,showRightPanel:lg.A.instance.isOpenForRoom(this.props.space.roomId),myMembership:this.props.space.getMyMembership()}}componentDidMount(){this.dispatcherRef=x.A.register(this.onAction),lg.A.instance.on(ha.H,this.onRightPanelStoreUpdate),this.context.on(i.RoomEvent.MyMembership,this.onMyMembership)}componentWillUnmount(){x.A.unregister(this.dispatcherRef),lg.A.instance.off(ha.H,this.onRightPanelStoreUpdate),this.context.off(i.RoomEvent.MyMembership,this.onMyMembership)}renderBody(){var e;switch(this.state.phase){case SP.Landing:return this.state.myMembership===Xt.O.Join?o.createElement(AP,{space:this.props.space}):o.createElement(UI,{room:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case SP.PublicCreateRooms:return o.createElement(CP,{space:this.props.space,title:(0,c._t)("create_space|setup_rooms_community_heading",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(e=e.createOpts)||void 0===e?void 0:e.name)||this.props.space.name}),description:o.createElement(o.Fragment,null,(0,c._t)("create_space|setup_rooms_community_description"),o.createElement("br",null),(0,c._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:SP.PublicShare,firstRoomId:e})});case SP.PublicShare:return o.createElement(RP,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,firstRoomId:this.state.firstRoomId});case SP.PrivateScope:return o.createElement(IP,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?SP.PrivateCreateRooms:SP.PrivateExistingRooms})}});case SP.PrivateInvite:return o.createElement(PP,{space:this.props.space,onFinished:()=>this.setState({phase:SP.Landing})});case SP.PrivateCreateRooms:return o.createElement(CP,{space:this.props.space,title:(0,c._t)("create_space|setup_rooms_private_heading"),description:o.createElement(o.Fragment,null,(0,c._t)("create_space|setup_rooms_private_description"),o.createElement("br",null),(0,c._t)("create_space|setup_rooms_description")),onFinished:e=>this.setState({phase:SP.PrivateInvite,firstRoomId:e})});case SP.PrivateExistingRooms:return o.createElement(kP,{space:this.props.space,onFinished:()=>this.setState({phase:SP.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===SP.Landing?o.createElement(gI,{room:this.props.space,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator}):void 0;return o.createElement("main",{className:"mx_SpaceRoomView"},o.createElement(tA.A,null,o.createElement(ES,{panel:e,resizeNotifier:this.props.resizeNotifier,analyticsRoomType:"space"},this.renderBody())))}}(0,S.A)(NP,"contextType",ce.Ay);var DP=n("./src/components/structures/RoomStatusBar.tsx");class MP extends o.PureComponent{render(){return o.createElement("div",{className:"mx_TopUnreadMessagesBar"},o.createElement(ae.A,{className:"mx_TopUnreadMessagesBar_scrollUp",title:(0,c._t)("room|jump_read_marker"),onClick:this.props.onScrollUpClick}),o.createElement(ae.A,{className:"mx_TopUnreadMessagesBar_markAsRead",title:(0,c._t)("notifications|mark_all_read"),onClick:this.props.onCloseClick}))}}var OP=n("./src/utils/direct-messages.ts"),FP=n("./src/components/views/messages/EncryptionEvent.tsx"),LP=n("./src/components/structures/RoomStatusBarUnsentMessages.tsx");const UP=({text:e})=>o.createElement("div",{className:"mx_LargeLoader"},o.createElement(le.A,{w:45,h:45}),o.createElement("div",{className:"mx_LargeLoader_text"},e));class BP extends o.Component{constructor(e){super(e),(0,S.A)(this,"callEventGroupers",new Map),this.buildLegacyCallEventGroupers(this.props.timeline)}buildLegacyCallEventGroupers(e){this.callEventGroupers=(0,yk.fN)(this.callEventGroupers,e)}render(){const e=this.props.timeline,t=e[this.props.ourEventsIndexes[0]],n=t.getId(),i=t.getTs(),r=[o.createElement(Zx.A,{key:i+"-search",roomId:t.getRoomId(),ts:i})],s=O.A.getValue("layout"),a=O.A.getValue("showTwelveHourTimestamps"),l=O.A.getValue("alwaysShowTimestamps"),c=f.J.safeGet();for(let t=0;t<e.length;t++){var d;const i=e[t];let h;const p=!this.props.ourEventsIndexes.includes(t);if(p||(h=this.props.searchHighlights),(0,vn.bN)(i,c,null===(d=this.context)||void 0===d?void 0:d.showHiddenEvents)){var u;const d=e[t-1],g=d&&!(0,gt.fq)(d.getDate()||void 0,i.getDate()||void 0)&&AA(d,i,c,null===(u=this.context)||void 0===u?void 0:u.showHiddenEvents,kn.Ae.Search);let v=!0;const f=e[t+1];if(f){var m;v=(0,gt.fq)(i.getDate()||void 0,f.getDate()||void 0)||i.getSender()!==f.getSender()||!AA(i,f,c,null===(m=this.context)||void 0===m?void 0:m.showHiddenEvents,kn.Ae.Search)}r.push(o.createElement($r,{key:`${n}+${t}`,mxEvent:i,layout:s,contextual:p,highlights:h,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,isTwelveHour:a,alwaysShowTimestamps:l,lastInSection:v,continuation:g,callEventGrouper:this.callEventGroupers.get(i.getContent().call_id)}))}}return o.createElement("li",{"data-scroll-tokens":n},o.createElement("ol",null,r))}}(0,S.A)(BP,"contextType",kn.Ay);var VP=n("./src/Typeguards.ts");async function jP(e,t,n,r){const o={limit:10};void 0!==n&&(o.rooms=[n]);const s={search_categories:{room_events:{search_term:t,filter:o,order_by:i.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await e.search({body:s},r),query:s}}async function zP(e,t,n,i){const r=await jP(e,t,n,i),o={abortSignal:i,_query:r.query,results:[],highlights:[]};return e.processRoomEventsSearch(o,r.response)}function HP(e,t){const n=e.result,i=t.result;return n.origin_server_ts>i.origin_server_ts?-1:n.origin_server_ts<i.origin_server_ts?1:0}async function WP(e,t,n=!0){const i=y.A.get(),r={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(r.room_id=t);const o=await i.search(r);if(!o)throw new Error("Local search failed");r.next_batch=o.next_batch;return{response:o,query:r}}function GP(e,t){try{const n=e[e.length-1].result,i=t[t.length-1].result;return n.origin_server_ts<=i.origin_server_ts?-1:1}catch{return 0}}function KP(e,t,n,i){const r=n.concat(i).sort(HP);t.results=r.slice(0,10),e.cachedEvents=r.slice(10)}function qP(e,t,n){var i;const r=function(e,t,n){var i;const r={},o=null!==(i=e.cachedEvents)&&void 0!==i?i:[];let s=e.oldestEventFrom;var a,l,c,d;if(r.highlights=e.highlights,t&&n&&n.results)GP(null!==(a=t.results)&&void 0!==a?a:[],n.results)<0&&(s="local"),KP(e,r,null!==(l=t.results)&&void 0!==l?l:[],n.results),r.highlights=(null!==(c=t.highlights)&&void 0!==c?c:[]).concat(null!==(d=n.highlights)&&void 0!==d?d:[]);else if(t){var u,m;GP(null!==(u=t.results)&&void 0!==u?u:[],o)<0&&(s="local"),KP(e,r,null!==(m=t.results)&&void 0!==m?m:[],o)}else n&&n.results?(GP(n.results,o)<0&&(s="server"),KP(e,r,n.results,o)):(r.results=o,e.cachedEvents=[]);return e.oldestEventFrom=s,r}(e,t,n);if(e.count)r.count=e.count;else{var o,s;const e=null!==(o=null==t?void 0:t.count)&&void 0!==o?o:0,i=null!==(s=null==n?void 0:n.count)&&void 0!==s?s:0;r.count=e+i}return t&&(0,VP.E)(e.seshatQuery)&&(e.seshatQuery.next_batch=t.next_batch),n&&(e.serverSideNextBatch=n.next_batch),null!==(i=e.seshatQuery)&&void 0!==i&&i.next_batch?r.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(r.next_batch=e.serverSideNextBatch),!r.next_batch&&(0,VP.E)(e.cachedEvents)&&e.cachedEvents.length>0&&(r.next_batch="cached"),r}function $P(e=[]){for(const t of e){const e=t.context.getTimeline();for(const t of e){const e=t.event;e.curve25519Key&&(t.makeEncrypted(i.EventType.RoomMessageEncrypted,{algorithm:e.algorithm},e.curve25519Key,e.ed25519Key),t.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain,delete e.curve25519Key,delete e.ed25519Key,delete e.algorithm,delete e.forwardingCurve25519KeyChain)}}}async function JP(e,t,n,i){let r;var o;void 0!==n?r=await(null===(o=e.getCrypto())||void 0===o?void 0:o.isEncryptionEnabledInRoom(n))?async function(e,t,n){const i={results:[],highlights:[]};if(""===t)return i;const r=await WP(t,n);i.seshatQuery=r.query;const o={search_categories:{room_events:r.response}},s=e.processRoomEventsSearch(i,o);return $P(s.results),s}(e,t,n):zP(e,t,n,i):r=async function(e,t,n){const i=jP(e,t,void 0,n),r=WP(t);await Promise.all([i,r]);const o=await r,s=await i,a=s.query,l=s.response,c=o.query,d=o.response,u={seshatQuery:c,_query:a,serverSideNextBatch:l.search_categories.room_events.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},m={search_categories:{room_events:qP(u,d,l.search_categories.room_events)}},h=e.processRoomEventsSearch(u,m);return $P(h.results),h}(e,t,i);return r}function YP(e,t){const n=t.seshatQuery,i=t._query;if(n){if(i){const n=async function(e,t){var n;const i=y.A.get(),r=t.seshatQuery,o=t.oldestEventFrom;let s,a;if(null==r||!r.next_batch||t.serverSideNextBatch&&"server"!==o||(s=await i.search(r)),t.serverSideNextBatch&&("local"===o||null==r||!r.next_batch)){const n={body:t._query,next_batch:t.serverSideNextBatch};a=await e.search(n)}const l={search_categories:{room_events:qP(t,s,null===(n=a)||void 0===n?void 0:n.search_categories.room_events)}},c=t.results?t.results.length:0,d=e.processRoomEventsSearch(t,l),u=d.results.length-c;return $P(d.results.slice(Math.max(d.results.length-u,0))),t.pendingRequest=void 0,d}(e,t);return t.pendingRequest=n,n}{const n=async function(e,t){var n,i;const r=y.A.get();if(!t.seshatQuery)throw new Error("localSearchProcess must be called first");const o=await r.search(t.seshatQuery);if(!o)throw new Error("Local search pagination failed");t.seshatQuery.next_batch=o.next_batch;const s=null!==(n=null===(i=o.results)||void 0===i?void 0:i.length)&&void 0!==n?n:0,a={search_categories:{room_events:o}},l=e.processRoomEventsSearch(t,a);return $P(l.results.slice(Math.max(l.results.length-s,0))),t.pendingRequest=void 0,l}(e,t);return t.pendingRequest=n,n}}return e.backPaginateRoomEventsSearch(t)}let XP=function(e){return e.Room="Room",e.All="All",e}({});function QP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}let ZP=function(e){};const eN=({term:e,scope:t,promise:n,abortController:r,resizeNotifier:a,className:l,onUpdate:d,inProgress:u,ref:m})=>{const h=(0,o.useContext)(ce.Ay),p=(0,yr.ME)("showHiddenEvents"),[g,v]=(0,o.useState)(null),[f,_]=(0,o.useState)(null),b=(0,o.useRef)(!1),E=(0,o.useMemo)(()=>new Map,[]),w=(0,o.useRef)(null);(0,o.useEffect)(()=>()=>{E.forEach(e=>e.stop()),E.clear()},[E]);const x=(0,o.useCallback)(t=>(d(!0,null,null),t.then(async t=>{if(ZP("search complete"),b.current)return s.vF.error("Discarding stale search results"),!1;let n=t.highlights;n.includes(e)||(n=n.concat(e)),n=n.sort(function(e,t){return t.length-e.length});for(const e of t.results)for(const t of e.context.getTimeline()){if(!t.getServerAggregatedRelation(i.THREAD_RELATION_TYPE.name)||t.getThread())continue;const e=h.getRoom(t.getRoomId()),n=null==e?void 0:e.findThreadForEvent(t);n?t.setThread(n):null==e||e.createThread(t.getId(),t,[],!0)}return v(n),_(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?QP(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):QP(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},t)),d(!1,t,null),!1},e=>b.current?(s.vF.error("Discarding stale search results"),!1):(s.vF.error("Search failed",e),d(!1,null,e),!1))),[h,e,d]);if((0,o.useEffect)(()=>(b.current=!1,x(n),()=>{b.current=!0,null==r||r.abort()}),[]),null===f)return o.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"});const A=[];var C;(u&&A.push(o.createElement("li",{key:"search-spinner"},o.createElement(le.A,null))),f.next_batch)||(null!=f&&null!==(C=f.results)&&void 0!==C&&C.length?A.push(o.createElement("li",{key:"search-top-marker"},o.createElement("h2",{className:"mx_RoomView_topMarker"},(0,c._t)("no_more_results")))):A.push(o.createElement("li",{key:"search-top-marker"},o.createElement("h2",{className:"mx_RoomView_topMarker"},(0,c._t)("common|no_results")))));let k,R=[],I=[];for(let e=((null==f||null===(T=f.results)||void 0===T?void 0:T.length)||0)-1;e>=0;e--){var T;const n=f.results[e],i=n.context.getEvent(),r=i.getRoomId(),a=h.getRoom(r);if(!a){s.vF.log("Hiding search result from an unknown room",r);continue}if(!(0,vn.bN)(i,h,p.showHiddenEvents))continue;t===XP.All&&r!==k&&(A.push(o.createElement("li",{key:i.getId()+"-room"},o.createElement("h2",null,(0,c._t)("common|room"),": ",a.name))),k=r);const l="#/room/"+r+"/"+i.getId(),d=n.context.getTimeline(),u=e>0?f.results[e-1].context.getTimeline():[];if(e>0&&d[d.length-1].getId()==u[0].getId()){if(0==R.length){for(let e=0==R.length?0:1;e<n.context.getTimeline().length;e++)R.push(d[e]);I.push(n.context.getOurEventIndex())}for(let e=1;e<u.length;e++)R.push(u[e]);I.push(I[I.length-1]+f.results[e-1].context.getOurEventIndex()+1);continue}0==R.length&&(R=n.context.getTimeline(),I=[],I.push(n.context.getOurEventIndex()));let m=E.get(r);m||(m=new on.pE(a),m.start(),E.set(r,m)),A.push(o.createElement(BP,{key:i.getId(),timeline:R,ourEventsIndexes:I,searchHighlights:null!=g?g:[],resultLink:l,permalinkCreator:m})),I=[],R=[]}return o.createElement(Qx.A,{ref:e=>{"function"==typeof m?m(e):m&&(m.current=e),w.current=e},className:"mx_RoomView_searchResultsPanel "+l,onFillRequest:async e=>{if(!e)return!1;if(!f.next_batch)return ZP("no more search results"),!1;ZP("requesting more search results");const t=function(e,t){const n=y.A.get();return t.pendingRequest?t.pendingRequest:null===n?e.backPaginateRoomEventsSearch(t):YP(e,t)}(h,f);return x(t)},resizeNotifier:a},o.createElement("li",{className:"mx_RoomView_scrollheader"}),A)},tN=({roomView:e,resizeNotifier:t,inviteEvent:n})=>{const i=(0,yr.ME)("room"),r=d.Ay.get().brand;return o.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.createElement(tA.A,null,o.createElement(eP,{room:i.room}),o.createElement("main",{className:"mx_RoomView_body",ref:e},o.createElement("div",{className:"mx_RoomView_timeline"},o.createElement(Qx.A,{className:"mx_RoomView_messagePanel",resizeNotifier:t},o.createElement(oA.A,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:(0,c._t)("room|waiting_for_join_title",{brand:r}),subtitle:(0,c._t)("room|waiting_for_join_subtitle",{brand:r})}),o.createElement(wA,null),o.createElement(qr,{mxEvent:n}))))))},nN=({searchInfo:e,isRoomEncrypted:t,onSearchScopeChange:n,onCancelClick:i})=>{var r;const s=null!==(r=null==e?void 0:e.scope)&&void 0!==r?r:XP.Room;return o.createElement(o.Fragment,null,o.createElement(Si.Z,{screenName:"RoomSearch"}),o.createElement("div",{className:"mx_RoomSearchAuxPanel"},o.createElement("div",{className:"mx_RoomSearchAuxPanel_summary"},o.createElement(Lg.A,{width:"24px",height:"24px"}),o.createElement("div",{className:"mx_RoomSearchAuxPanel_summary_text"},void 0!==(null==e?void 0:e.count)?(0,c._t)("room|search|summary",{count:e.count},{query:()=>o.createElement("strong",null,e.term)}):void 0!==(null==e?void 0:e.error)?null==e?void 0:e.error.message:o.createElement(tl.A,null),o.createElement(_k,{kind:fk.Search,isRoomEncrypted:t,showLogo:!1}))),o.createElement("div",{className:"mx_RoomSearchAuxPanel_buttons"},o.createElement(wS.N,{onClick:()=>n(s===XP.Room?XP.All:XP.Room),kind:"primary"},s===XP.All?(0,c._t)("room|search|this_room_button"):(0,c._t)("room|search|all_rooms_button")),o.createElement(rg.K,{onClick:i,destructive:!0,tooltip:(0,c._t)("action|cancel"),"aria-label":(0,c._t)("action|cancel")},o.createElement(PT.A,{width:"20px",height:"20px"})))))};function iN({room:e,permalinkCreator:t,resizeNotifier:n}){const i=GA(e),r=$A(e,i),s=r.length,a=1===s,[l,d]=(0,o.useState)(s-1);(0,o.useEffect)(()=>{d(()=>s-1)},[s]);const u=r[l];if(function(e,t){const n=(0,o.useRef)(null);(0,o.useEffect)(()=>{(n.current&&!e||!n.current&&e)&&t.notifyTimelineHeightChanged(),n.current=e},[e,t])}(u,n),!u)return null;const m=u.isRedacted()||u.isDecryptionFailure();return o.createElement("div",{className:"mx_PinnedMessageBanner","data-single-message":a,"aria-label":(0,c._t)("room|pinned_message_banner|description")},o.createElement("button",{"aria-label":(0,c._t)("room|pinned_message_banner|go_to_message"),type:"button",className:"mx_PinnedMessageBanner_main",onClick:()=>{Si.A.trackInteraction("PinnedMessageBannerClick"),x.A.dispatch({action:W.r.ViewRoom,event_id:u.getId(),highlighted:!0,room_id:e.roomId,metricsTrigger:void 0}),d(e=>-1===--e?s-1:e)}},o.createElement("div",{className:"mx_PinnedMessageBanner_content"},o.createElement(oN,{count:s,currentIndex:l}),o.createElement(zr,{width:"20px",height:"20px",className:"mx_PinnedMessageBanner_PinIcon"}),!a&&o.createElement("div",{className:"mx_PinnedMessageBanner_title"},(0,c._t)("room|pinned_message_banner|title",{index:l+1,length:s},{bold:e=>o.createElement("span",{className:"mx_PinnedMessageBanner_title_counter"},e)})),o.createElement(gr,{mxEvent:u,className:"mx_PinnedMessageBanner_message"}),m&&o.createElement("div",{className:"mx_PinnedMessageBanner_redactedMessage"},o.createElement(FR.A,{mxEvent:u,maxImageHeight:20,permalinkCreator:t,replacingEventId:u.replacingEventId()})))),!a&&o.createElement(lN,{room:e}))}const rN=3;function oN({count:e,currentIndex:t}){const n=Math.min(e,rN),i=t%n,r=Math.ceil(e/n),s=t>=(r-1)*rN,a=n-(r*n-e);return o.createElement("div",{className:"mx_PinnedMessageBanner_Indicators"},Array.from({length:n}).map((e,t)=>o.createElement(sN,{key:t,active:t===i,hidden:s&&a<=t})))}function sN({active:e,hidden:t}){return o.createElement("div",{className:me()("mx_PinnedMessageBanner_Indicator",{"mx_PinnedMessageBanner_Indicator--active":e,"mx_PinnedMessageBanner_Indicator--hidden":t})})}function aN(e){return lg.A.instance.isOpenForRoom(e)?lg.A.instance.currentCard.phase:null}function lN({room:e}){const[t,n]=(0,o.useState)(aN(e.roomId));(0,lr.ml)(lg.A.instance,ha.H,()=>n(aN(e.roomId)));const i=t===cg.n.PinnedMessages;return o.createElement(Ae.$,{className:"mx_PinnedMessageBanner_actions",kind:"tertiary",onClick:()=>{i?Si.A.trackInteraction("PinnedMessageBannerCloseListButton"):Si.A.trackInteraction("PinnedMessageBannerViewAllButton"),lg.A.instance.showOrHidePhase(cg.n.PinnedMessages)}},i?(0,c._t)("room|pinned_message_banner|button_close_list"):(0,c._t)("room|pinned_message_banner|button_view_all"))}const cN=({onFinished:e,roomName:t})=>{const[n,i]=(0,o.useState)(!1),[r,s]=(0,o.useState)(!1),[a,l]=(0,o.useState)(""),d=(0,o.useCallback)(e=>l(e.target.value),[l]),u=(0,o.useCallback)(()=>e(!1,!1,!1),[e]),m=(0,o.useCallback)(()=>e(!0,r,!!n&&a),[e,r,n,a]);return o.createElement(X.A,{className:"mx_DeclineAndBlockInviteDialog",onFinished:u,title:(0,c._t)("decline_invitation_dialog|title"),contentId:"mx_Dialog_content"},o.createElement(AS.b,null,o.createElement("p",null,(0,c._t)("decline_invitation_dialog|confirm",{roomName:t})),o.createElement(Ko.A,{label:(0,c._t)("report_content|ignore_user"),onChange:s,caption:(0,c._t)("decline_invitation_dialog|ignore_user_help"),value:r}),o.createElement(Ko.A,{label:(0,c._t)("action|report_room"),onChange:i,caption:(0,c._t)("decline_invitation_dialog|report_room_description"),value:n}),o.createElement(IS.D,{name:"report-reason","aria-disabled":!n},o.createElement(TS.J,{htmlFor:"mx_DeclineAndBlockInviteDialog_reason"},(0,c._t)("room_settings|permissions|ban_reason")),o.createElement("textarea",{id:"mx_DeclineAndBlockInviteDialog_reason",className:"mx_RoomReportTextArea",placeholder:(0,c._t)("decline_invitation_dialog|reason_description"),rows:5,onChange:d,value:n?a:"",disabled:!n})),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|decline_invite"),primaryButtonClass:"danger",cancelButton:(0,c._t)("action|cancel"),onPrimaryButtonClick:m,onCancel:u})))},dN=["upgradeRecommendation"],uN=["upgradeRecommendation"];function mN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function hN(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?mN(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):mN(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}let pN=function(e){};const gN="sandbox"in document.createElement("iframe");function vN(e){const t=(0,yr.ME)("room").room,n=e.localRoom.currentState.getStateEvents(i.EventType.RoomEncryption)[0];let r;n&&(r=o.createElement(FP.A,{mxEvent:n}));const s=()=>{t.state=bA.cd.NEW,x.A.dispatch({action:"local_room_event",roomId:t.roomId})};let a=null,l=null;if(t.isError){const e=o.createElement(ae.A,{onClick:s,className:"mx_RoomStatusBar_unsentRetry"},(0,c._t)("action|retry"));a=o.createElement(LP.E,{title:(0,c._t)("room|status_bar|some_messages_not_sent"),notificationState:Mn.d.RED_EXCLAMATION,buttons:e})}else l=o.createElement(lR,{room:e.localRoom,resizeNotifier:e.resizeNotifier,permalinkCreator:e.permalinkCreator});return o.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.createElement(tA.A,null,o.createElement(eP,{room:t}),o.createElement("main",{className:"mx_RoomView_body",ref:e.roomView,"aria-label":(0,c._t)("room|room_content")},o.createElement(gR,{parent:e.roomView.current,onFileDrop:e.onFileDrop,room:t}),o.createElement("div",{className:"mx_RoomView_timeline"},o.createElement(Qx.A,{className:"mx_RoomView_messagePanel",resizeNotifier:e.resizeNotifier},r,o.createElement(wA,null))),a,l)))}function fN(e){const t=(0,c._t)("room|creating_room_text",{names:e.names});return o.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.createElement(tA.A,null,o.createElement(eP,{room:e.localRoom}),o.createElement("div",{className:"mx_RoomView_body"},o.createElement(UP,{text:t}))))}class _N extends o.Component{constructor(e,t){var n;if(super(e,t),(0,S.A)(this,"askToJoinEnabled",void 0),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"settingWatchers",[]),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"permalinkCreators",{}),(0,S.A)(this,"inviter",void 0),(0,S.A)(this,"roomView",(0,o.createRef)()),(0,S.A)(this,"searchResultsPanel",(0,o.createRef)()),(0,S.A)(this,"messagePanel",null),(0,S.A)(this,"roomViewBody",(0,o.createRef)()),(0,S.A)(this,"onIsResizing",e=>{this.setState({resizing:e})}),(0,S.A)(this,"onWidgetStoreUpdate",()=>{this.state.room&&(this.checkWidgets(this.state.room),this.doMaybeRemoveOwnJitsiWidget())}),(0,S.A)(this,"onWidgetEchoStoreUpdate",()=>{this.state.room&&this.checkWidgets(this.state.room)}),(0,S.A)(this,"onWidgetLayoutChange",()=>{this.state.room&&(x.A.dispatch({action:"appsDrawer",show:!0}),this.context.widgetLayoutStore.hasMaximisedWidget(this.state.room)&&this.context.rightPanelStore.setCard({phase:cg.n.Timeline}),this.checkWidgets(this.state.room))}),(0,S.A)(this,"checkWidgets",e=>{this.setState({hasPinnedWidgets:this.context.widgetLayoutStore.hasPinnedWidgets(e),mainSplitContentType:this.getMainSplitContentType(e),showApps:this.shouldShowApps(e)})}),(0,S.A)(this,"getMainSplitContentType",e=>this.context.roomViewStore.isViewingCall()||(0,Cx.j)(e)?kn.DZ.Call:this.context.widgetLayoutStore.hasMaximisedWidget(e)?kn.DZ.MaximisedWidget:kn.DZ.Timeline),(0,S.A)(this,"onRoomViewStoreUpdate",async e=>{var t,n,i,r,o,a,l,c;if(this.unmounted)return;const d=null!==(t=this.context.roomViewStore.getRoomLoadError())&&void 0!==t?t:void 0;if(!e&&!d&&this.state.roomId!==this.context.roomViewStore.getRoomId())return;const u=null!==(n=this.context.roomViewStore.getRoomId())&&void 0!==n?n:null,m=null!==(i=null===(r=this.context.client)||void 0===r?void 0:r.getRoom(null!=u?u:void 0))&&void 0!==i?i:void 0,h={roomId:null!=u?u:void 0,roomAlias:null!==(o=this.context.roomViewStore.getRoomAlias())&&void 0!==o?o:void 0,roomLoading:this.context.roomViewStore.isRoomLoading(),roomLoadError:d,joining:this.context.roomViewStore.isJoining(),replyToEvent:null!==(a=this.context.roomViewStore.getQuotingEvent())&&void 0!==a?a:void 0,shouldPeek:this.state.matrixClientIsReady&&this.context.roomViewStore.shouldPeek(),showReadReceipts:O.A.getValue("showReadReceipts",u),showRedactions:O.A.getValue("showRedactions",u),showJoinLeaves:O.A.getValue("showJoinLeaves",u),showAvatarChanges:O.A.getValue("showAvatarChanges",u),showDisplaynameChanges:O.A.getValue("showDisplaynameChanges",u),wasContextSwitch:this.context.roomViewStore.getWasContextSwitch(),mainSplitContentType:m?this.getMainSplitContentType(m):void 0,initialEventId:void 0,showRightPanel:!!u&&this.context.rightPanelStore.isOpenForRoom(u),promptAskToJoin:this.context.roomViewStore.promptAskToJoin(),viewRoomOpts:this.context.roomViewStore.getViewRoomOpts()};var p;this.state.mainSplitContentType!==kn.DZ.Timeline&&h.mainSplitContentType===kn.DZ.Timeline&&this.context.rightPanelStore.isOpen&&this.context.rightPanelStore.currentCard.phase===cg.n.Timeline&&this.context.rightPanelStore.roomPhaseHistory.some(e=>e.phase===cg.n.Timeline)&&(this.context.rightPanelStore.setCard({phase:cg.n.RoomSummary}),this.context.rightPanelStore.togglePanel(null!==(p=this.state.roomId)&&void 0!==p?p:null),h.showRightPanel=!1);const g=null!==(l=this.context.roomViewStore.getInitialEventId())&&void 0!==l?l:this.state.initialEventId;if(g){var v,f;let e=null==m?void 0:m.findEventById(g);var _;if(!e&&this.context.client&&u)e=null!==(_=await(0,gn.$I)(this.context.client,u,g))&&void 0!==_?_:void 0;h.initialEventPixelOffset=void 0;const t=null===(v=e)||void 0===v?void 0:v.getThread();null==t||!t.rootEvent||null!==(f=e)&&void 0!==f&&f.isThreadRoot?(h.initialEventId=g,h.isInitialEventHighlighted=this.context.roomViewStore.isInitialEventHighlighted(),h.initialEventScrollIntoView=this.context.roomViewStore.initialEventScrollIntoView()):x.A.dispatch({action:W.r.ShowThread,rootEvent:t.rootEvent,initialEvent:e,highlighted:this.context.roomViewStore.isInitialEventHighlighted(),scroll_into_view:this.context.roomViewStore.initialEventScrollIntoView()})}var y,b;(this.settingWatchers=this.settingWatchers.concat([O.A.watchSetting("showReadReceipts",u,(...[,,,e])=>this.setState({showReadReceipts:e})),O.A.watchSetting("showRedactions",u,(...[,,,e])=>this.setState({showRedactions:e})),O.A.watchSetting("showJoinLeaves",u,(...[,,,e])=>this.setState({showJoinLeaves:e})),O.A.watchSetting("showAvatarChanges",u,(...[,,,e])=>this.setState({showAvatarChanges:e})),O.A.watchSetting("showDisplaynameChanges",u,(...[,,,e])=>this.setState({showDisplaynameChanges:e}))]),e||!this.state.shouldPeek||h.shouldPeek)||(null===(y=this.context.client)||void 0===y||y.stopPeeking());if(s.vF.log("RVS update:",h.roomId,h.roomAlias,"loading?",h.roomLoading,"joining?",h.joining,"initial?",e,"shouldPeek?",h.shouldPeek),e&&(h.room=this.context.client.getRoom(h.roomId)||void 0,h.isRoomEncrypted=null,h.room&&(h.showApps=this.shouldShowApps(h.room),this.onRoomLoaded(h.room))),void 0===this.state.roomId&&void 0!==h.roomId&&!h.initialEventId&&h.roomId){const e=fI.getScrollState(h.roomId);e&&(h.initialEventId=e.focussedEvent,h.initialEventPixelOffset=e.pixelOffset)}this.state.timelineRenderingType===kn.Ae.Search&&this.state.initialEventId!==h.initialEventId&&(h.timelineRenderingType=kn.Ae.Room,null===(b=this.state.search)||void 0===b||null===(b=b.abortController)||void 0===b||b.abort(),h.search=void 0);this.setState(h),e&&this.setupRoom(h.room,h.roomId,!!h.joining,!!h.shouldPeek);const E=await this.getIsRoomEncrypted(h.roomId);this.setState(hN({isRoomEncrypted:E},E&&h.roomId&&{e2eStatus:null!==(c=_N.e2eStatusCache.get(h.roomId))&&void 0!==c?c:qS.z.Warning}))}),(0,S.A)(this,"onCallClose",()=>{x.A.dispatch({action:W.r.ViewRoom,room_id:this.state.roomId,view_call:!1,metricsTrigger:void 0},!0)}),(0,S.A)(this,"getRoomId",()=>{var e,t;return null!==(e=null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&void 0!==e?e:this.state.roomId}),(0,S.A)(this,"onRightPanelStoreUpdate",()=>{const{roomId:e}=this.state;this.setState({showRightPanel:!!e&&this.context.rightPanelStore.isOpenForRoom(e)})}),(0,S.A)(this,"onPageUnload",e=>yS.Ay.sharedInstance().getCurrentUploads().length>0?e.returnValue=(0,c._t)("quit_warning|file_upload_in_progress"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=(0,c._t)("quit_warning|call_in_progress"):void 0),(0,S.A)(this,"onReactKeyDown",e=>{var t;let n=!1;switch((0,uo.zM)().getRoomAction(e)){case Ei.bY.DismissReadMarker:null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker(),this.jumpToLiveTimeline(),n=!0;break;case Ei.bY.JumpToOldestUnread:this.jumpToReadMarker(),n=!0;break;case Ei.bY.UploadFile:x.A.dispatch({action:"upload_file",context:kn.Ae.Room},!0),n=!0}n&&(e.stopPropagation(),e.preventDefault())}),(0,S.A)(this,"onCallState",e=>{if(!e)return;const t=this.getCallForRoom();this.setState({callState:null==t?void 0:t.state})}),(0,S.A)(this,"onAction",async e=>{var t;if(this.context.client)switch(e.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(e.data.content.url,e.data.content.info,e.data.description||e.data.name,e.data.threadId);break;case"picture_snapshot":{const t=this.getRoomId();(0,VP.E)(t)&&yS.Ay.sharedInstance().sendContentListToRoom([e.file],t,void 0,this.context.client);break}case"notifier_enabled":case W.r.UploadStarted:case W.r.UploadFinished:case W.r.UploadCanceled:this.forceUpdate();break;case"appsDrawer":this.setState({showApps:e.show});break;case"reply_to_event":!this.unmounted&&this.state.search&&(null===(t=e.event)||void 0===t?void 0:t.getRoomId())===this.state.roomId&&e.context===kn.Ae.Search&&this.onCancelSearchClick();break;case"MatrixActions.sync":if(!this.state.matrixClientIsReady){var n;const e=Boolean(null===(n=this.context.client)||void 0===n?void 0:n.isInitialSyncComplete());this.setState({matrixClientIsReady:e},()=>{e&&this.onRoomViewStoreUpdate(!0)})}break;case"local_room_event":this.onLocalRoomEvent(e.roomId);break;case W.r.EditEvent:{if(e.timelineRenderingType!==this.state.timelineRenderingType)return;if(e.event&&e.event.getRoomId()!==this.state.roomId)return void x.A.dispatch({action:W.r.ViewRoom,room_id:e.event.getRoomId(),metricsTrigger:void 0,deferred_action:e});const t=e.event?new cR(e.event):void 0;this.setState({editState:t,search:void 0},()=>{var t;e.event&&(null===(t=this.messagePanel)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))});break}case W.r.ComposerInsert:{if(e.composerType)break;let t=e.timelineRenderingType;if(t===kn.Ae.Thread)break;this.state.timelineRenderingType===kn.Ae.Search&&e.timelineRenderingType===kn.Ae.Search&&(await this.onCancelSearchClick(),t=kn.Ae.Room),x.A.dispatch(hN(hN({},e),{},{timelineRenderingType:t,composerType:this.state.editState?_R.D.Edit:_R.D.Send}));break}case W.r.FocusAComposer:x.A.dispatch(hN(hN({},e),{},{action:this.state.editState?W.r.FocusEditMessageComposer:W.r.FocusSendMessageComposer}));break;case"scroll_to_bottom":var i;if(e.timelineRenderingType===kn.Ae.Room)null===(i=this.messagePanel)||void 0===i||i.jumpToLiveTimeline();break;case W.r.ViewUser:e.member?e.push?lg.A.instance.pushCard({phase:cg.n.MemberInfo,state:{member:e.member}}):lg.A.instance.setCards([{phase:cg.n.RoomSummary},{phase:cg.n.MemberList},{phase:cg.n.MemberInfo,state:{member:e.member}}]):lg.A.instance.showOrHidePhase(cg.n.MemberList);break;case W.r.View3pidInvite:((e,t)=>{e.event?t.pushCard({phase:cg.n.ThreePidMemberInfo,state:{memberInfoEvent:e.event}}):t.showOrHidePhase(cg.n.MemberList)})(e,lg.A.instance);break;case W.r.FocusMessageSearch:e.initialText&&this.onSearch(e.initialText)}}),(0,S.A)(this,"onRoomTimeline",(e,t,n,i,r)=>{var o;this.unmounted||t&&t.roomId===(null===(o=this.state.room)||void 0===o?void 0:o.roomId)&&r.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&(this.updateE2EStatus(t),this.updatePreviewUrlVisibility(t)),!n&&null!=r&&r.liveEvent&&(this.state.joining||(e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e),this.context.client&&e.getSender()!==this.context.client.getSafeUserId()&&(!this.state.search&&this.state.atEndOfLiveTimeline||(0,fS.A)(e,this.state)||this.setState(e=>({numUnreadMessages:e.numUnreadMessages+1}))))))}),(0,S.A)(this,"onEventDecrypted",e=>{this.state.room&&this.state.matrixClientIsReady&&e.getRoomId()===this.state.room.roomId&&(e.isDecryptionFailure()||this.handleEffects(e))}),(0,S.A)(this,"handleEffects",e=>{if(!this.state.room)return;this.context.roomNotificationStateStore.getRoomState(this.state.room).isUnread&&RC.y.forEach(t=>{((0,IC._)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&(e.isRelation(i.THREAD_RELATION_TYPE.name)||x.A.dispatch({action:`effects.${t.command}`,event:e}))})}),(0,S.A)(this,"onRoomName",e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()}),(0,S.A)(this,"onKeyBackupStatus",()=>{this.forceUpdate()}),(0,S.A)(this,"canResetTimeline",()=>!this.messagePanel||this.messagePanel.canResetTimeline()),(0,S.A)(this,"onRoomLoaded",e=>{this.unmounted||(this.inviter=this.getInviterFromRoom(e),this.context.widgetLayoutStore.on(YC.aK.emissionForRoom(e),this.onWidgetLayoutChange),this.calculatePeekRules(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updatePermissions(e),this.checkWidgets(e),this.updateRoomEncrypted(e),this.getMainSplitContentType(e)!==kn.DZ.Timeline&&this.context.roomNotificationStateStore.getRoomState(e).isUnread&&this.context.rightPanelStore.setCard({phase:cg.n.Timeline},!0,e.roomId),this.setState({tombstone:this.getRoomTombstone(e),liveTimeline:e.getLiveTimeline()}),x.A.dispatch({action:W.r.RoomLoaded}))}),(0,S.A)(this,"onRoomTimelineReset",e=>{var t;e&&e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&e.getLiveTimeline()!==this.state.liveTimeline&&(s.vF.log(`Live timeline of ${e.roomId} was reset`),this.setState({liveTimeline:e.getLiveTimeline()}))}),(0,S.A)(this,"onRoom",e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&this.context.widgetLayoutStore.off(YC.aK.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},()=>{this.onRoomLoaded(e)}))}),(0,S.A)(this,"onUserVerificationChanged",e=>{const t=this.state.room;t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)}),(0,S.A)(this,"onCrossSigningKeysChanged",()=>{const e=this.state.room;e&&this.updateE2EStatus(e)}),(0,S.A)(this,"onUrlPreviewsEnabledChange",()=>{this.state.room&&this.updatePreviewUrlVisibility(this.state.room)}),(0,S.A)(this,"onRoomStateEvents",async(e,t)=>{if(this.state.room&&this.state.room.roomId===t.roomId&&this.context.client)switch(e.getType()){case i.EventType.RoomTombstone:this.setState({tombstone:this.getRoomTombstone()});break;case i.EventType.RoomEncryption:await this.updateRoomEncrypted();break;default:this.updatePermissions(this.state.room)}}),(0,S.A)(this,"onRoomStateUpdate",e=>{var t;e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&this.updateRoomMembers()}),(0,S.A)(this,"onMyMembership",e=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))}),(0,S.A)(this,"updateRoomMembers",(0,Li.throttle)(()=>{this.state.room&&(this.updateDMState(),this.updateE2EStatus(this.state.room))},500,{leading:!0,trailing:!0})),(0,S.A)(this,"onInviteClick",()=>{x.A.dispatch({action:"view_invite",roomId:this.getRoomId()})}),(0,S.A)(this,"onJoinButtonClicked",()=>{var e;null!==(e=this.context.client)&&void 0!==e&&e.isGuest()?(x.A.dispatch({action:W.r.DoAfterSyncPrepared,deferred_action:{action:W.r.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}}),x.A.dispatch({action:"require_registration"})):Promise.resolve().then(()=>{var e;const t=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl,n=this.getRoomId();var i;(0,VP.E)(n)&&x.A.dispatch({action:W.r.JoinRoom,roomId:n,opts:{inviteSignUrl:t},metricsTrigger:(null===(i=this.state.room)||void 0===i?void 0:i.getMyMembership())===Xt.O.Invite?"Invite":"RoomPreview",canAskToJoin:this.state.canAskToJoin});return Promise.resolve()})}),(0,S.A)(this,"onMessageListScroll",()=>{var e;null!==(e=this.messagePanel)&&void 0!==e&&e.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()}),(0,S.A)(this,"resetJumpToEvent",e=>{this.state.initialEventId&&this.state.initialEventScrollIntoView&&this.state.initialEventId===e&&(pN("Removing scroll_into_view flag from initial event"),x.A.dispatch({action:W.r.ViewRoom,room_id:this.getRoomId(),event_id:this.state.initialEventId,highlighted:this.state.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))}),(0,S.A)(this,"onSearch",(e,t=XP.Room)=>{const n=t===XP.Room?this.getRoomId():void 0;pN("sending search request");const i=new AbortController,r=function(e,t,n,i){return null===y.A.get()?zP(e,t,n,i):JP(e,t,n,i)}(this.context.client,e,n,i.signal);this.setState({timelineRenderingType:kn.Ae.Search,search:{searchId:(new Date).getTime(),roomId:n,term:e,scope:t,promise:r,abortController:i}})}),(0,S.A)(this,"onSearchScopeChange",e=>{var t,n;this.onSearch(null!==(t=null===(n=this.state.search)||void 0===n?void 0:n.term)&&void 0!==t?t:"",e)}),(0,S.A)(this,"onSearchUpdate",(e,t,n)=>{this.setState({search:hN(hN({},this.state.search),{},{count:null==t?void 0:t.count,error:null!=n?n:void 0,inProgress:e})})}),(0,S.A)(this,"onForgetClick",()=>{x.A.dispatch({action:"forget_room",room_id:this.getRoomId()})}),(0,S.A)(this,"onDeclineAndBlockButtonClicked",async()=>{if(!this.state.room||!this.context.client)return;const[e,t,n]=await R.Ay.createDialog(cN,{roomName:this.state.room.name}).finished;if(!e)return;this.setState({rejecting:!0});const i=[];if(t){const e=async()=>{const e=this.context.client.getSafeUserId();if(!this.inviter||this.inviter===e)throw new yN("Cannot determine which user to ignore since the member event has changed.");const t=this.context.client.getIgnoredUsers();t.push(this.inviter),await this.context.client.setIgnoredUsers(t)};i.push(e())}!1!==n&&i.push(this.context.client.reportRoom(this.state.room.roomId,n)),i.push(this.context.client.leave(this.state.room.roomId));try{await Promise.all(i),x.A.dispatch({action:W.r.ViewHomePage}),this.setState({rejecting:!1})}catch(e){s.vF.error(`Failed to reject invite: ${e}`);let t="";t=e instanceof yN?(0,c._t)("room|failed_determine_user"):e instanceof Error?e.message:JSON.stringify(e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})}}),(0,S.A)(this,"onDeclineButtonClicked",async()=>{if(this.state.room&&this.context.client)try{this.setState({rejecting:!0}),await this.context.client.leave(this.state.room.roomId),x.A.dispatch({action:W.r.ViewHomePage}),this.setState({rejecting:!1})}catch(e){s.vF.error(`Failed to reject invite: ${e}`);const t=e instanceof Error?e.message:JSON.stringify(e);R.Ay.createDialog(Ht.A,{title:(0,c._t)("room|failed_reject_invite"),description:t}),this.setState({rejecting:!1})}}),(0,S.A)(this,"onRejectThreepidInviteButtonClicked",()=>{x.A.fire(W.r.ViewRoomDirectory)}),(0,S.A)(this,"onSearchChange",(0,Li.debounce)(e=>{this.onSearch(e)},300)),(0,S.A)(this,"onCancelSearchClick",()=>new Promise(e=>{this.setState({timelineRenderingType:kn.Ae.Room,search:void 0},e)})),(0,S.A)(this,"jumpToLiveTimeline",()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?x.A.dispatch({action:W.r.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}):(null===(e=this.messagePanel)||void 0===e||e.jumpToLiveTimeline(),x.A.fire(W.r.FocusSendMessageComposer))}),(0,S.A)(this,"jumpToReadMarker",()=>{var e;null===(e=this.messagePanel)||void 0===e||e.jumpToReadMarker()}),(0,S.A)(this,"forgetReadMarker",e=>{var t;e.stopPropagation(),null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker()}),(0,S.A)(this,"updateTopUnreadMessagesBar",()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})}),(0,S.A)(this,"onStatusBarVisible",()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})}),(0,S.A)(this,"onStatusBarHidden",()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})}),(0,S.A)(this,"handleScrollKey",e=>{var t;let n;this.searchResultsPanel.current?n=this.searchResultsPanel.current:this.messagePanel&&(n=this.messagePanel),null===(t=n)||void 0===t||t.handleScrollKey(e)}),(0,S.A)(this,"gatherTimelinePanelRef",e=>{this.messagePanel=e}),(0,S.A)(this,"onHiddenHighlightsClick",()=>{const e=this.getOldRoom();e&&x.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,metricsTrigger:"Predecessor"})}),(0,S.A)(this,"onFileDrop",async e=>{const t=this.getRoomId();t&&this.context.client&&await yS.Ay.sharedInstance().sendContentListToRoom(Array.from(e.files),t,void 0,this.context.client,kn.Ae.Room)}),(0,S.A)(this,"onMeasurement",e=>{this.setState({narrow:e})}),(0,S.A)(this,"onSubmitAskToJoin",e=>{const t=this.getRoomId();(0,VP.E)(t)&&x.A.dispatch({action:W.r.SubmitAskToJoin,roomId:t,opts:{reason:e}})}),(0,S.A)(this,"onCancelAskToJoin",()=>{const e=this.getRoomId();(0,VP.E)(e)&&x.A.dispatch({action:W.r.CancelAskToJoin,roomId:e})}),this.askToJoinEnabled=O.A.getValue("feature_ask_to_join"),!t.client)throw new Error("Unable to create RoomView without MatrixClient");const r=t.client.hasLazyLoadMembersEnabled();this.state={roomId:void 0,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!r,numUnreadMessages:0,callState:void 0,canPeek:!1,canSelfRedact:!1,showApps:!1,isPeeking:!1,showRightPanel:!1,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSendMessages:!1,resizing:!1,layout:O.A.getValue("layout"),lowBandwidth:O.A.getValue("lowBandwidth"),alwaysShowTimestamps:O.A.getValue("alwaysShowTimestamps"),showTwelveHourTimestamps:O.A.getValue("showTwelveHourTimestamps"),userTimezone:_S.dB(),readMarkerInViewThresholdMs:O.A.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:O.A.getValue("readMarkerOutOfViewThresholdMs"),showHiddenEvents:O.A.getValue("showHiddenEventsInTimeline"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:null===(n=t.client)||void 0===n?void 0:n.isInitialSyncComplete(),mainSplitContentType:kn.DZ.Timeline,timelineRenderingType:kn.Ae.Room,liveTimeline:void 0,narrow:!1,msc3946ProcessDynamicPredecessor:O.A.getValue("feature_dynamic_room_predecessors"),canAskToJoin:this.askToJoinEnabled,promptAskToJoin:!1,viewRoomOpts:{buttons:[]},isRoomEncrypted:null}}doMaybeRemoveOwnJitsiWidget(){if(!this.state.roomId||!this.state.room||!this.context.client)return;const e=this.context.widgetStore.getApps(this.state.roomId).filter(e=>e.eventId&&yC.x.JITSI.matches(e.type));if(e.length<2)return;const t=this.context.client.getSafeUserId(),n=e.find(e=>e.creatorUserId===t);if(!n)return;const i=this.state.room.findEventById(n.eventId);if(!i)return;const r=i.getTs();if(!r)return;const o=e.reduce((e,t)=>{var i;if(t.eventId===n.eventId)return e;const r=(null===(i=this.state.room.findEventById(t.eventId))||void 0===i?void 0:i.getTs())||0;return Math.max(e,r)},0);o&&r>o&&r-o<3e4&&iC.A.setRoomWidget(this.context.client,this.state.roomId,n.id)}getPermalinkCreatorForRoom(){const{room:e,roomId:t}=this.state;if(void 0===e){if((0,VP.E)(t)){const e=new on.pE(null,t);return this.permalinkCreators[t]=e,e}throw new Error("Cannot get a permalink creator without a roomId")}return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new on.pE(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,n,r){var o;if(!n&&t)if(!e&&r)s.vF.info(`Attempting to peek into room ${t}`),this.setState({peekLoading:!0,isPeeking:!0}),null===(o=this.context.client)||void 0===o||o.peekInRoom(t).then(e=>{this.unmounted||(this.setState({room:e,peekLoading:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===i.JoinRule.Knock}),this.onRoomLoaded(e))}).catch(e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}});else if(e){var a;null===(a=this.context.client)||void 0===a||a.stopPeeking(),this.setState({isPeeking:!1,canAskToJoin:this.askToJoinEnabled&&e.getJoinRule()===i.JoinRule.Knock})}}shouldShowApps(e){if(!gN||!e)return!1;const t=e.roomId+"_hide_widget_drawer",n=localStorage.getItem(t),i=!n||"false"===n,r=this.context.widgetLayoutStore.getContainerWidgets(e,YC.mc.Top);return i&&r.length>0}componentDidMount(){this.unmounted=!1,this.dispatcherRef=x.A.register(this.onAction),this.context.client&&(this.context.client.on(i.ClientEvent.Room,this.onRoom),this.context.client.on(i.RoomEvent.Timeline,this.onRoomTimeline),this.context.client.on(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),this.context.client.on(i.RoomEvent.Name,this.onRoomName),this.context.client.on(i.RoomStateEvent.Events,this.onRoomStateEvents),this.context.client.on(i.RoomStateEvent.Update,this.onRoomStateUpdate),this.context.client.on(i.RoomEvent.MyMembership,this.onMyMembership),this.context.client.on(V.cr.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.on(V.cr.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.on(V.cr.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.on(i.MatrixEventEvent.Decrypted,this.onEventDecrypted)),this.context.roomViewStore.on(ha.H,this.onRoomViewStoreUpdate),this.context.rightPanelStore.on(ha.H,this.onRightPanelStoreUpdate),_I.A.on(ha.H,this.onWidgetEchoStoreUpdate),this.context.widgetStore.on(ha.H,this.onWidgetStoreUpdate),this.props.resizeNotifier.on("isResizing",this.onIsResizing),this.settingWatchers=[O.A.watchSetting("layout",null,(...[,,,e])=>this.setState({layout:e})),O.A.watchSetting("lowBandwidth",null,(...[,,,e])=>this.setState({lowBandwidth:e})),O.A.watchSetting("alwaysShowTimestamps",null,(...[,,,e])=>this.setState({alwaysShowTimestamps:e})),O.A.watchSetting("showTwelveHourTimestamps",null,(...[,,,e])=>this.setState({showTwelveHourTimestamps:e})),O.A.watchSetting(_S.cd,null,(...[,,,e])=>this.setState({userTimezone:e})),O.A.watchSetting("readMarkerInViewThresholdMs",null,(...[,,,e])=>this.setState({readMarkerInViewThresholdMs:e})),O.A.watchSetting("readMarkerOutOfViewThresholdMs",null,(...[,,,e])=>this.setState({readMarkerOutOfViewThresholdMs:e})),O.A.watchSetting("showHiddenEventsInTimeline",null,(...[,,,e])=>this.setState({showHiddenEvents:e})),O.A.watchSetting("urlPreviewsEnabled",null,this.onUrlPreviewsEnabledChange),O.A.watchSetting("urlPreviewsEnabled_e2ee",null,this.onUrlPreviewsEnabledChange),O.A.watchSetting("feature_dynamic_room_predecessors",null,(...[,,,e])=>this.setState({msc3946ProcessDynamicPredecessor:e}))],this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=null==e?void 0:e.state;this.setState({callState:t}),this.context.legacyCallHandler.on(jt.uv.CallState,this.onCallState),window.addEventListener("beforeunload",this.onPageUnload)}shouldComponentUpdate(e,t){const n=(0,Dn.No)(this.props,e),i=this.state,{upgradeRecommendation:r}=i,o=(0,v.A)(i,dN),{upgradeRecommendation:s}=t,a=(0,v.A)(t,uN),l=(null==s?void 0:s.needsUpgrade)!==(null==r?void 0:r.needsUpgrade)||(0,Dn.No)(o,a);return n||l}componentDidUpdate(){this.messagePanel&&void 0===this.state.atEndOfLiveTimeline&&this.setState({atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()})}componentWillUnmount(){var e,t;(this.unmounted=!0,this.context.legacyCallHandler.removeListener(jt.uv.CallState,this.onCallState),this.state.roomId&&fI.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek)&&(null===(e=this.context.client)||void 0===e||e.stopPeeking());this.stopAllPermalinkCreators(),x.A.unregister(this.dispatcherRef),this.context.client&&(this.context.client.removeListener(i.ClientEvent.Room,this.onRoom),this.context.client.removeListener(i.RoomEvent.Timeline,this.onRoomTimeline),this.context.client.removeListener(i.RoomEvent.TimelineReset,this.onRoomTimelineReset),this.context.client.removeListener(i.RoomEvent.Name,this.onRoomName),this.context.client.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents),this.context.client.removeListener(i.RoomEvent.MyMembership,this.onMyMembership),this.context.client.removeListener(i.RoomStateEvent.Update,this.onRoomStateUpdate),this.context.client.removeListener(V.cr.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.removeListener(V.cr.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.removeListener(V.cr.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.removeListener(i.MatrixEventEvent.Decrypted,this.onEventDecrypted)),window.removeEventListener("beforeunload",this.onPageUnload),this.context.roomViewStore.off(ha.H,this.onRoomViewStoreUpdate),this.context.rightPanelStore.off(ha.H,this.onRightPanelStoreUpdate),_I.A.removeListener(ha.H,this.onWidgetEchoStoreUpdate),this.context.widgetStore.removeListener(ha.H,this.onWidgetStoreUpdate),this.props.resizeNotifier.off("isResizing",this.onIsResizing),this.state.room&&this.context.widgetLayoutStore.off(YC.aK.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.context.legacyCallHandler.off(jt.uv.CallState,this.onCallState),this.updateRoomMembers.cancel();for(const e of this.settingWatchers)O.A.unwatchSetting(e);this.viewsLocalRoom&&this.state.room&&(null===(t=this.context.client)||void 0===t||t.store.removeRoom(this.state.room.roomId))}onLocalRoomEvent(e){this.context.client&&this.state.room&&e===this.state.room.roomId&&(0,OP.Cp)(this.context.client,this.state.room)}getRoomTombstone(e=this.state.room){var t;return null!==(t=null==e?void 0:e.currentState.getStateEvents(i.EventType.RoomTombstone,""))&&void 0!==t?t:void 0}async getIsRoomEncrypted(e=this.state.roomId){var t;const n=null===(t=this.context.client)||void 0===t?void 0:t.getCrypto();return!(!n||!e)&&await n.isEncryptionEnabledInRoom(e)}async calculateRecommendedVersion(e){const t=await e.getRecommendedVersion();this.unmounted||this.setState({upgradeRecommendation:t})}async loadMembersIfJoined(e){var t;if(null!==(t=this.context.client)&&void 0!==t&&t.hasLazyLoadMembersEnabled()&&e&&e.getMyMembership()===Xt.O.Join)try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const n=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;s.vF.error(n),s.vF.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents(i.EventType.RoomHistoryVisibility,"");this.setState({canPeek:(null==t?void 0:t.getContent().history_visibility)===i.HistoryVisibility.WorldReadable})}updatePreviewUrlVisibility(e){this.setState(({isRoomEncrypted:t})=>({showUrlPreview:this.getPreviewUrlVisibility(e,t)}))}getPreviewUrlVisibility({roomId:e},t){const n=t?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";return O.A.getValue(n,e)}async updateE2EStatus(e){if(!this.context.client||!this.state.isRoomEncrypted)return;const t=await this.cacheAndGetE2EStatus(e,this.context.client);this.unmounted||this.setState({e2eStatus:t})}async cacheAndGetE2EStatus(e,t){let n=_N.e2eStatusCache.get(e.roomId);return n&&this.setState({e2eStatus:n}),n=await(0,qS.G)(t,e),_N.e2eStatusCache.set(e.roomId,n),n}async updateRoomEncrypted(e=this.state.room){if(!e||!this.context.client)return;const t=await this.getIsRoomEncrypted(e.roomId),n=t?await this.cacheAndGetE2EStatus(e,this.context.client):null;this.setState(hN({isRoomEncrypted:t,showUrlPreview:this.getPreviewUrlVisibility(e,t)},n&&{e2eStatus:n}))}updatePermissions(e){if(e&&this.context.client){const t=this.context.client.getSafeUserId(),n=e.getMyMembership()===Xt.O.Join&&e.currentState.maySendEvent(i.EventType.Reaction,t),r=e.maySendMessage(),o=e.currentState.maySendEvent(i.EventType.RoomRedaction,t);this.setState({canReact:n,canSendMessages:r,canSelfRedact:o})}}checkDesktopNotifications(){if(!this.state.room)return;this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&E.default.shouldShowPrompt()&&(0,oP.P)(!0)}updateDMState(){const e=this.state.room;if((null==e?void 0:e.getMyMembership())!=Xt.O.Join)return;const t=null==e?void 0:e.getDMInviter();t&&ua.FZ(e.client,e.roomId,t)}injectSticker(e,t,n,i){const r=this.getRoomId();this.context.client&&r&&(this.context.client.isGuest()?x.A.dispatch({action:"require_registration"}):yS.Ay.sharedInstance().sendStickerContentToRoom(e,r,i,t,n,this.context.client).then(void 0,e=>{e.name}))}getInviterFromRoom(e){var t;const n=null===(t=this.context.client)||void 0===t?void 0:t.getSafeUserId();if(!n)return;const i=e.getMember(n),r=null==i?void 0:i.events.member,o=null==r?void 0:r.getSender();return(null==r?void 0:r.getContent().membership)===Xt.O.Invite?o:void 0}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?this.context.legacyCallHandler.getCallForRoom(this.state.room.roomId):null}getOldRoom(){var e,t;const{roomId:n}=(null===(e=this.state.room)||void 0===e?void 0:e.findPredecessor(this.state.msc3946ProcessDynamicPredecessor))||{};return(null===(t=this.context.client)||void 0===t?void 0:t.getRoom(n))||null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount(i.NotificationCountType.Highlight):0}get messagePanelClassNames(){return me()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.layout===Zt.P.IRC})}get viewsLocalRoom(){return(0,Pr.F)(this.state.room)}get permalinkCreator(){return this.getPermalinkCreatorForRoom()}renderLocalRoomCreateLoader(e){var t;if(!this.state.room||null===(t=this.context)||void 0===t||!t.client)return null;const n=this.state.room.getDefaultRoomName(this.context.client.getSafeUserId());return o.createElement(yr.yw,this.state,o.createElement(fN,{localRoom:e,names:n,resizeNotifier:this.props.resizeNotifier,mainSplitContentType:this.state.mainSplitContentType}))}renderLocalRoomView(e){return o.createElement(yr.yw,this.state,o.createElement(vN,{localRoom:e,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,roomView:this.roomView,onFileDrop:this.onFileDrop,mainSplitContentType:this.state.mainSplitContentType}))}renderWaitingForThirdPartyRoomView(e){return o.createElement(yr.yw,this.state,o.createElement(tN,{resizeNotifier:this.props.resizeNotifier,roomView:this.roomView,inviteEvent:e}))}render(){var e,t,n;if(!this.context.client)return null;const{isRoomEncrypted:r}=this.state,s=null===r;if(this.state.room instanceof bA.Np)return this.state.room.state===bA.cd.CREATING?this.renderLocalRoomCreateLoader(this.state.room):this.renderLocalRoomView(this.state.room);if(this.state.room){const{shouldEncrypt:e,inviteEvent:t}=EA(this.state.room);if(e)return this.renderWaitingForThirdPartyRoomView(t)}if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return o.createElement("div",{className:"mx_RoomView"},o.createElement(tA.A,null,o.createElement(RI,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData,roomId:this.state.roomId})))}{var a,l;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(a=this.props.threepidInvite)||void 0===a?void 0:a.toEmail,n=this.state.roomAlias;return o.createElement("div",{className:"mx_RoomView"},o.createElement(tA.A,null,o.createElement(RI,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onDeclineClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:n,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,signUrl:null===(l=this.props.threepidInvite)||void 0===l?void 0:l.signUrl,roomId:this.state.roomId,promptAskToJoin:this.state.promptAskToJoin,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin})))}}const d=this.state.room.getMyMembership();if((0,Cx.j)(this.state.room)&&d!==Xt.O.Join)return o.createElement(tA.A,null,o.createElement("div",{className:"mx_MainSplit"},o.createElement(UI,{room:this.state.room,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.onDeclineButtonClicked})),";");if(d===Xt.O.Invite&&!this.state.room.isSpaceRoom()){if(this.state.joining||this.state.rejecting)return o.createElement(tA.A,null,o.createElement(RI,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting,roomId:this.state.roomId}));{const e=this.context.client.getSafeUserId(),t=this.state.room.getMember(e),n=t?t.events.member:null;let i=(0,c._t)("room|inviter_unknown");var u,m;if(n)i=null!==(u=null===(m=n.sender)||void 0===m?void 0:m.name)&&void 0!==u?u:n.getSender();return o.createElement("div",{className:"mx_RoomView"},o.createElement(tA.A,null,o.createElement(RI,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onDeclineClick:this.onDeclineButtonClicked,onDeclineAndBlockClick:this.onDeclineAndBlockButtonClicked,promptRejectionOptions:!0,inviterName:i,canPreview:!1,joining:this.state.joining,room:this.state.room,roomId:this.state.roomId})))}}if(this.state.canAskToJoin&&[Xt.O.Knock,Xt.O.Leave].includes(d))return o.createElement("div",{className:"mx_RoomView"},o.createElement(tA.A,null,o.createElement(RI,{onJoinClick:this.onJoinButtonClicked,room:this.state.room,canAskToJoinAndMembershipIsLeave:d===Xt.O.Leave,promptAskToJoin:this.state.promptAskToJoin,knocked:d===Xt.O.Knock,onSubmitAskToJoin:this.onSubmitAskToJoin,onCancelAskToJoin:this.onCancelAskToJoin,onForgetClick:this.onForgetClick})));let h,p=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(p=e)}let g=!0;yS.Ay.sharedInstance().getCurrentUploads().length>0?h=o.createElement(mR,{room:this.state.room}):this.state.search||(g=this.state.statusBarVisible,h=o.createElement(DP.A,{room:this.state.room,isPeeking:d!==Xt.O.Join,onInviteClick:this.onInviteClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden}));const v=me()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:g}),f=h&&o.createElement("div",{role:"region",className:v,"aria-label":(0,c._t)("a11y|room_status_bar")},o.createElement("div",{className:"mx_RoomView_statusAreaBox"},o.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),h)),_=this.state.upgradeRecommendation,y=_&&_.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.client.getSafeUserId()),b=this.getHiddenHighlightCount();let E,w;if(this.state.timelineRenderingType===kn.Ae.Search)s||(E=o.createElement(nN,{searchInfo:this.state.search,onCancelClick:this.onCancelSearchClick,onSearchScopeChange:this.onSearchScopeChange,isRoomEncrypted:r}));else if(y)E=o.createElement(VI,{room:this.state.room});else if(d!==Xt.O.Join){var S,x;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(S=this.props.threepidInvite)||void 0===S?void 0:S.toEmail;if(w=o.createElement(RI,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onDeclineClick:this.onRejectThreepidInviteButtonClicked,promptRejectionOptions:!0,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room,roomId:this.state.roomId}),!(this.state.canPeek||null!==(x=this.state.room)&&void 0!==x&&x.isSpaceRoom()))return o.createElement("div",{className:"mx_RoomView"},w)}else b>0&&(E=o.createElement(ae.A,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},(0,c._t)("room|unread_notifications_predecessor",{count:b})));if(null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom()&&!this.props.forceTimeline)return o.createElement(NP,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onDeclineButtonClicked});const A=o.createElement(xT,{room:this.state.room,userId:this.context.client.getSafeUserId(),showApps:this.state.showApps,resizeNotifier:this.props.resizeNotifier},E),C=o.createElement(iN,{room:this.state.room,permalinkCreator:this.permalinkCreator,resizeNotifier:this.props.resizeNotifier});let k;let R;!s&&d===Xt.O.Join&&!this.state.search&&(k=o.createElement(lR,{room:this.state.room,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.permalinkCreator}));let I,T,P,N,D=!1;this.state.search&&(R=o.createElement(eN,{key:this.state.search.searchId,ref:this.searchResultsPanel,term:this.state.search.term,scope:this.state.search.scope,promise:this.state.search.promise,abortController:this.state.search.abortController,inProgress:!!this.state.search.inProgress,resizeNotifier:this.props.resizeNotifier,className:this.messagePanelClassNames,onUpdate:this.onSearchUpdate}),D=!0),this.state.isInitialEventHighlighted&&(I=this.state.initialEventId),s||(T=o.createElement(Sk,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:D,highlightedEventId:I,eventId:this.state.initialEventId,eventScrollIntoView:this.state.initialEventScrollIntoView,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onEventScrolledIntoView:this.resetJumpToEvent,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:this.messagePanelClassNames,membersLoaded:this.state.membersLoaded,permalinkCreator:this.permalinkCreator,resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,editState:this.state.editState})),this.state.showTopUnreadMessagesBar&&!this.state.search&&(P=o.createElement(MP,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})),!1!==this.state.atEndOfLiveTimeline||this.state.search||(N=o.createElement(WR,{highlight:this.state.room.getUnreadNotificationCount(i.NotificationCountType.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline}));const M=!s&&this.state.room&&this.state.showRightPanel?o.createElement(gI,{room:this.state.room,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,e2eStatus:this.state.e2eStatus,onSearchChange:this.onSearchChange,onSearchCancel:this.onCancelSearchClick,searchTerm:null!==(t=null===(n=this.state.search)||void 0===n?void 0:n.term)&&void 0!==t?t:""}):void 0,F=me()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts});let{mainSplitContentType:L}=this.state;this.state.search&&(L=kn.DZ.Timeline);const U=me()("mx_RoomView",{mx_RoomView_inCall:Boolean(p),mx_RoomView_immersive:L!==kn.DZ.Timeline}),B=O.A.getValue("showChatEffects");let V,j;switch(L){case kn.DZ.Timeline:j="mx_MainSplit_timeline",V=o.createElement(o.Fragment,null,o.createElement(xk,{sensor:this.roomViewBody,onMeasurement:this.onMeasurement}),A,C,o.createElement("main",{className:F},o.createElement(gR,{parent:this.roomView.current,onFileDrop:this.onFileDrop,room:this.state.room}),P,N,T,R),f,w,k);break;case kn.DZ.MaximisedWidget:j="mx_MainSplit_maximisedWidget",V=o.createElement(o.Fragment,null,o.createElement(ZI,{room:this.state.room,userId:this.context.client.getSafeUserId(),resizeNotifier:this.props.resizeNotifier,showApps:!0,role:"main"}),w);break;case kn.DZ.Call:var z;j="mx_MainSplit_call",V=o.createElement(o.Fragment,null,o.createElement(rP,{room:this.state.room,resizing:this.state.resizing,skipLobby:null!==(z=this.context.roomViewStore.skipCallLobby())&&void 0!==z&&z,role:"main",onClose:this.onCallClose}),w)}const H=me()("mx_RoomView_body",j);let W,G,K="other_room";return this.state.mainSplitContentType!==kn.DZ.Timeline&&(W="wide",G=420,K=this.state.mainSplitContentType===kn.DZ.Call?"video_room":"maximised_widget"),o.createElement(yr.yw,this.state,o.createElement("div",{className:U,ref:this.roomView,onKeyDown:this.onReactKeyDown},B&&this.roomView.current&&o.createElement(tP,{roomWidth:this.roomView.current.offsetWidth}),o.createElement(tA.A,null,o.createElement(ES,{panel:M,resizeNotifier:this.props.resizeNotifier,sizeKey:W,defaultSize:G,analyticsRoomType:K},o.createElement("div",{className:H,ref:this.roomViewBody,"data-layout":this.state.layout},o.createElement(eP,{room:this.state.room,additionalButtons:this.state.viewRoomOpts.buttons}),V)))))}}(0,S.A)(_N,"e2eStatusCache",new Map),(0,S.A)(_N,"contextType",as.A);class yN extends Error{constructor(...e){super(...e),(0,S.A)(this,"name","CannotDetermineUserError")}}class bN extends o.Component{constructor(e){super(e),(0,S.A)(this,"onToastStoreUpdate",()=>{this.setState({toasts:L.A.sharedInstance().getToasts(),countSeen:L.A.sharedInstance().getCountSeen()})}),this.state={toasts:L.A.sharedInstance().getToasts(),countSeen:L.A.sharedInstance().getCountSeen()}}componentDidMount(){L.A.sharedInstance().on("update",this.onToastStoreUpdate),this.onToastStoreUpdate()}componentWillUnmount(){L.A.sharedInstance().removeListener("update",this.onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let n,i;if(0!==e){const r=this.state.toasts[0],{title:s,icon:a,key:l,component:c,className:d,bodyClassName:u,props:m}=r,h=me()("mx_Toast_body",u),p=me()("mx_Toast_toast",d,{mx_Toast_hasIcon:a,[`mx_Toast_icon_${a}`]:a}),g=Object.assign({},m,{key:l,toastKey:l}),v=o.createElement(c,g);let f,_;(s&&t||this.state.countSeen>0)&&(f=` (${this.state.countSeen+1}/${this.state.countSeen+e})`),s&&(_=o.createElement("div",{className:"mx_Toast_title"},o.createElement(og.E,{size:"lg",weight:"semibold",as:"h2"},s),o.createElement("span",{className:"mx_Toast_title_countIndicator"},f))),n=o.createElement("div",{className:p},_,o.createElement("div",{className:h},v)),i=me()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return n?o.createElement("div",{className:i,role:"alert"},n):null}}class EN extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"onAction",e=>{"client_started"===e.action&&this.forceUpdate()}),this.state={page:""}}translate(e){return ca()((0,c._t)(e))}async fetchEmbed(){let e;try{e=await fetch(this.props.url,{method:"GET"})}catch(e){if(this.unmounted)return;return s.vF.warn(`Error loading page: ${e}`),void this.setState({page:(0,c._t)("cant_load_page")})}if(this.unmounted)return;if(!e.ok)return s.vF.warn(`Error loading page: ${e.status}`),void this.setState({page:(0,c._t)("cant_load_page")});let t=(await e.text()).replace(/_t\(['"]([\s\S]*?)['"]\)/gm,(e,t)=>this.translate(t));this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach(e=>{t=t.split(e).join(this.props.replaceMap[e])}),this.setState({page:t})}componentDidMount(){this.unmounted=!1,this.props.url&&(this.fetchEmbed(),this.dispatcherRef=x.A.register(this.onAction))}componentWillUnmount(){this.unmounted=!0,x.A.unregister(this.dispatcherRef)}render(){const e=this.context||f.J.get(),t=!e||e.isGuest(),n=this.props.className,i=me()(n,{[`${n}_guest`]:t,[`${n}_loggedIn`]:!!e}),r=o.createElement("div",{className:`${n}_body`,dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?o.createElement(Cr.A,{className:i},r):o.createElement("div",{className:i},r)}}(0,S.A)(EN,"contextType",ce.Ay);const wN=e=>{Si.A.trackInteraction("WebHomeCreateChatButton",e),x.A.dispatch({action:W.r.CreateChat})},SN=e=>{Si.A.trackInteraction("WebHomeExploreRoomsButton",e),x.A.fire(W.r.ViewRoomDirectory)},xN=e=>{Si.A.trackInteraction("WebHomeCreateRoomButton",e),x.A.dispatch({action:W.r.CreateRoom})},AN=e=>{var t;return{displayName:Yp.V.instance.displayName||e,avatarUrl:null!==(t=Yp.V.instance.getHttpAvatarUrl(parseInt(fA,10)))&&void 0!==t?t:void 0}},CN=()=>{const e=(0,o.useContext)(ce.Ay),t=e.getUserId(),[n,i]=(0,o.useState)(AN(t));return(0,lr.ml)(Yp.V.instance,ha.H,()=>{i(AN(t))}),o.createElement("div",null,o.createElement(_A,{hasAvatar:!!n.avatarUrl,hasAvatarLabel:(0,c._t)("onboarding|has_avatar_label"),noAvatarLabel:(0,c._t)("onboarding|no_avatar_label"),setAvatarUrl:t=>e.setAvatarUrl(t),isUserAvatar:!0,onClick:e=>Si.A.trackInteraction("WebHomeMiniAvatarUploadButton",e)},o.createElement(Xp.A,{idName:t,name:n.displayName,url:n.avatarUrl,size:fA})),o.createElement("h1",null,(0,c._3)("onboarding|welcome_user",{name:n.displayName})),o.createElement("h2",null,(0,c._3)("onboarding|welcome_detail")))},kN=({justRegistered:e=!1})=>{const t=(0,ce.nH)(),n=d.Ay.get(),i=Jp(n,t);if(i)return o.createElement(EN,{className:"mx_HomePage",url:i,scrollbar:!0});let r;if(e||!Yp.V.instance.getHttpAvatarUrl(parseInt(fA,10)))r=o.createElement(CN,null);else{var s;const e=d.Ay.getObject("branding"),t=null!==(s=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==s?s:"themes/element/img/logos/element-logo.svg";r=o.createElement(o.Fragment,null,o.createElement("img",{src:t,alt:n.brand}),o.createElement("h1",null,(0,c._3)("onboarding|intro_welcome",{appName:n.brand})),o.createElement("h2",null,(0,c._3)("onboarding|intro_byline")))}return o.createElement(Cr.A,{className:"mx_HomePage mx_HomePage_default",element:"main"},o.createElement("div",{className:"mx_HomePage_default_wrapper"},r,o.createElement("div",{className:"mx_HomePage_default_buttons"},o.createElement(ae.A,{onClick:wN,className:"mx_HomePage_button_sendDm"},(0,c._3)("onboarding|send_dm")),o.createElement(ae.A,{onClick:SN,className:"mx_HomePage_button_explore"},(0,c._3)("onboarding|explore_rooms")),o.createElement(ae.A,{onClick:xN,className:"mx_HomePage_button_createGroup"},(0,c._3)("onboarding|create_room")))))};class RN extends o.Component{constructor(e){super(e),this.state={loading:!0}}componentDidMount(){this.props.userId&&this.loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this.loadProfileInfo()}async loadProfileInfo(){let e;this.setState({loading:!0});try{e=await this.context.getProfileInfo(this.props.userId)}catch(e){return R.Ay.createDialog(Ht.A,{title:(0,c._t)("error_dialog|error_loading_user_profile"),description:e instanceof Error?e.message:(0,c._t)("invite|failed_generic")}),void this.setState({loading:!1})}const t=new i.MatrixEvent({type:"m.room.member",content:e}),n=new i.RoomMember("",this.props.userId);n.setMembershipEvent(t),this.setState({member:n,loading:!1})}render(){if(this.state.loading)return o.createElement(le.A,null);if(this.state.member){const e=o.createElement(gI,{overwriteCard:{phase:cg.n.MemberInfo,state:{member:this.state.member}},resizeNotifier:this.props.resizeNotifier});return o.createElement(ES,{panel:e,resizeNotifier:this.props.resizeNotifier,defaultSize:420,analyticsRoomType:"user_profile"},o.createElement(kN,null))}return o.createElement("div",null)}}(0,S.A)(RN,"contextType",ce.Ay);const IN=({backgroundImage:e,blurMultiplier:t})=>{if(!e)return null;const n={};if(t){const e=getComputedStyle(document.documentElement).getPropertyValue("--lp-background-blur").replace("px",""),i=parseInt(e,10);isNaN(i)||(n.filter=`blur(${i*t}px)`)}return o.createElement("div",{className:"mx_BackdropPanel"},o.createElement("img",{role:"presentation",alt:"",style:n,className:"mx_BackdropPanel--image",src:e}))};var TN=n("./src/stores/OwnBeaconStore.ts"),PN=n("./res/img/location/live-location.svg");const NN=({isMinimized:e})=>{const t=(0,lr.dF)(TN.g.instance,TN.q.MonitoringLivePosition,()=>TN.g.instance.isMonitoringLiveLocation),n=(0,lr.dF)(TN.g.instance,TN.q.LocationPublishError,()=>TN.g.instance.getLiveBeaconIdsWithLocationPublishError()),i=(0,lr.dF)(TN.g.instance,TN.q.BeaconUpdateError,()=>TN.g.instance.getLiveBeaconIds().filter(e=>TN.g.instance.beaconUpdateErrors.has(e))),r=(0,lr.dF)(TN.g.instance,TN.q.LivenessChange,()=>TN.g.instance.getLiveBeaconIds()),s=!!n.length,a=!!i.length;if(((e,t)=>{(0,o.useEffect)(()=>{const n=()=>{"visible"===document.visibilityState&&e.forEach(e=>{var n;return null===(n=t.get(e))||void 0===n?void 0:n.monitorLiveness()})};return e.length&&document.addEventListener("visibilitychange",n),()=>{document.removeEventListener("visibilitychange",n)}},[e,t])})(r,TN.g.instance.beacons),!t)return null;const l=((e,t,n)=>{var i,r;const o=null!==(i=null!==(r=null==t?void 0:t[0])&&void 0!==r?r:null==n?void 0:n[0])&&void 0!==i?i:null==e?void 0:e[0];if(!o)return;return TN.g.instance.getBeaconById(o)})(r,i,n),d=l?e=>{x.A.dispatch({action:W.r.ViewRoom,room_id:l.roomId,metricsTrigger:void 0,event_id:l.beaconInfoId,scroll_into_view:!0,highlighted:!0})}:null,u=((e,t)=>e?(0,c._t)("location_sharing|error_stopping_live_location"):t?(0,c._t)("location_sharing|error_sharing_live_location"):(0,c._t)("location_sharing|live_location_active"))(a,s);return o.createElement(ae.A,{className:me()("mx_LeftPanelLiveShareWarning",{mx_LeftPanelLiveShareWarning__minimized:e,mx_LeftPanelLiveShareWarning__error:s||a}),title:e?u:void 0,onClick:d},e?o.createElement(PN.I,{height:10}):u)};function DN(e,t,n){return(1-(n=(0,Li.clamp)(n,0,1)))*e+n*t}const MN=58,ON=58,FN=76,LN=8;class UN extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"callViewWrapper",(0,o.createRef)()),(0,S.A)(this,"initX",0),(0,S.A)(this,"initY",0),(0,S.A)(this,"desiredTranslationX",Ja.A.instance.windowWidth-LN-336),(0,S.A)(this,"desiredTranslationY",Ja.A.instance.windowHeight-ON-232),(0,S.A)(this,"translationX",this.desiredTranslationX),(0,S.A)(this,"translationY",this.desiredTranslationY),(0,S.A)(this,"mouseHeld",!1),(0,S.A)(this,"scheduledUpdate",new Bk.L(()=>this.animationCallback(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),(0,S.A)(this,"startingPositionX",0),(0,S.A)(this,"startingPositionY",0),(0,S.A)(this,"_moving",!1),(0,S.A)(this,"animationCallback",()=>{var e,t;if(!this.moving&&Math.abs(this.translationX-this.desiredTranslationX)<=1&&Math.abs(this.translationY-this.desiredTranslationY)<=1)this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY,this.setStyle();else{const e=this.moving?.2:.1;this.translationX=DN(this.translationX,this.desiredTranslationX,e),this.translationY=DN(this.translationY,this.desiredTranslationY,e),this.setStyle(),this.scheduledUpdate.mark()}null===(e=(t=this.props).onMove)||void 0===e||e.call(t)}),(0,S.A)(this,"setStyle",()=>{this.callViewWrapper.current&&(this.callViewWrapper.current.style.transform=`translateX(${this.translationX}px) translateY(${this.translationY}px)`)}),(0,S.A)(this,"onResize",()=>{this.snap(!1)}),(0,S.A)(this,"snap",(e=!1)=>{var t,n;const i=this.desiredTranslationX,r=this.desiredTranslationY,o=Ja.A.instance.windowWidth-((null===(t=this.callViewWrapper.current)||void 0===t?void 0:t.clientWidth)||336),s=Ja.A.instance.windowHeight-((null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientHeight)||232);i>=o/2&&r>=s/2?(this.desiredTranslationX=o-LN,this.desiredTranslationY=s-ON):i>=o/2&&r<=s/2?(this.desiredTranslationX=o-LN,this.desiredTranslationY=MN):i<=o/2&&r>=s/2?(this.desiredTranslationX=FN,this.desiredTranslationY=s-ON):(this.desiredTranslationX=FN,this.desiredTranslationY=MN),e||(this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY),this.scheduledUpdate.mark()}),(0,S.A)(this,"onStartMoving",e=>{e.preventDefault(),e.stopPropagation(),this.mouseHeld=!0,this.startingPositionX=e.clientX,this.startingPositionY=e.clientY}),(0,S.A)(this,"onMoving",e=>{this.mouseHeld&&(Math.abs(this.startingPositionX-e.clientX)<5&&Math.abs(this.startingPositionY-e.clientY)<5||(e.preventDefault(),e.stopPropagation(),this.moving||(this.moving=!0,this.initX=e.pageX-this.desiredTranslationX,this.initY=e.pageY-this.desiredTranslationY,this.scheduledUpdate.mark()),this.setTranslation(e.pageX-this.initX,e.pageY-this.initY)))}),(0,S.A)(this,"onEndMoving",e=>{this.mouseHeld&&(e.preventDefault(),e.stopPropagation(),this.mouseHeld=!1,setTimeout(()=>this.moving=!1),this.snap(!0))}),(0,S.A)(this,"onClickCapture",e=>{this.moving&&(e.preventDefault(),e.stopPropagation())})}get moving(){return this._moving}set moving(e){this._moving=e}componentDidMount(){document.addEventListener("mousemove",this.onMoving),document.addEventListener("mouseup",this.onEndMoving),Ja.A.instance.on(Ja.x.Resize,this.onResize),this.snap()}componentWillUnmount(){document.removeEventListener("mousemove",this.onMoving),document.removeEventListener("mouseup",this.onEndMoving),Ja.A.instance.off(Ja.x.Resize,this.onResize)}componentDidUpdate(e){e.children!==this.props.children&&this.snap(!0)}setTranslation(e,t){var n,i;const r=(null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientWidth)||336,o=(null===(i=this.callViewWrapper.current)||void 0===i?void 0:i.clientHeight)||232;e+r>=Ja.A.instance.windowWidth?this.desiredTranslationX=Ja.A.instance.windowWidth-r:this.desiredTranslationX=e<=0?0:e,t+o>=Ja.A.instance.windowHeight?this.desiredTranslationY=Ja.A.instance.windowHeight-o:this.desiredTranslationY=t<=0?0:t}render(){const e={transform:`translateX(${this.translationX}px) translateY(${this.translationY}px)`},t=this.props.children.map(e=>e({onStartMoving:this.onStartMoving,onResize:this.onResize}));return o.createElement("aside",{className:this.props.className,style:e,ref:this.callViewWrapper,onClickCapture:this.onClickCapture,onDoubleClick:this.props.onDoubleClick},t)}}function BN(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M12.207 5.293a1 1 0 0 1 0 1.414L7.914 11H18.5a1 1 0 1 1 0 2H7.914l4.293 4.293a1 1 0 0 1-1.414 1.414l-6-6a1 1 0 0 1 0-1.414l6-6a1 1 0 0 1 1.414 0"})})}BN.displayName="ArrowLeftIcon";const VN=(0,o.forwardRef)(BN);class jN extends o.Component{constructor(e,t){super(e,t),(0,S.A)(this,"room",void 0),this.room=t.getRoom(this.props.persistentRoomId)}render(){const e=WC.Ay.instance.get(this.props.persistentWidgetId,this.props.persistentRoomId);return e?o.createElement(hk,{key:e.id,app:e,fullWidth:!0,room:this.room,userId:this.context.getSafeUserId(),creatorUserId:e.creatorUserId,widgetPageTitle:iC.A.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,miniMode:!0,showMenubar:!1,pointerEvents:this.props.pointerEvents,movePersistedElement:this.props.movePersistedElement,overlay:this.props.children}):null}}var zN,HN;function WN(){return WN=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},WN.apply(null,arguments)}(0,S.A)(jN,"contextType",ce.Ay);var GN=function(e,t){return o.createElement("svg",WN({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0,ref:t},e),zN||(zN=o.createElement("path",{fill:"currentColor",d:"M8.027 15.961c1.141 1.232 3.888 3.365 4.637 3.803l.151.09c1.143.679 4.722 2.807 7.33.815 2.021-1.542 1.364-3.278.684-3.794-.466-.362-1.838-1.36-3.128-2.26-1.268-.883-1.974-.175-2.452.303l-.026.026-.96.961c-.246.245-.618.156-.974-.125a26 26 0 0 1-2.692-2.385l-.004-.004c-.47-.47-1.4-1.4-2.373-2.68-.28-.356-.37-.728-.125-.973l.96-.961.027-.026c.478-.478 1.186-1.184.303-2.452-.9-1.29-1.898-2.662-2.26-3.128-.516-.68-2.252-1.337-3.794.684-1.992 2.608.136 6.187.815 7.33l.09.151c.438.75 2.56 3.484 3.791 4.625"})),HN||(HN=o.createElement("path",{fill:"currentColor",d:"M20.697 3.078a.64.64 0 0 0 0-.893.615.615 0 0 0-.88 0L17 5.045l-2.817-2.86a.615.615 0 0 0-.88 0 .64.64 0 0 0 0 .893l2.817 2.86-2.938 2.984a.64.64 0 0 0 0 .893.615.615 0 0 0 .88 0L17 6.832l2.938 2.983a.615.615 0 0 0 .88 0 .64.64 0 0 0 0-.893L17.88 5.939z"})))},KN=(0,o.forwardRef)(GN);const qN=({widgetId:e,room:t,viewingRoom:n,onStartMoving:r,movePersistedElement:s})=>{const a=(0,o.useMemo)(()=>WC.Ay.instance.getApps(t.roomId).find(t=>t.id===e),[t,e]),l=(0,lr.DY)(t,i.RoomEvent.Name,(0,o.useCallback)(()=>t.name,[t])),d=(0,Wv.Jf)(e,t.roomId),u=(0,o.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),null!==d?x.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,view_call:!0,metricsTrigger:"WebFloatingCallWindow"}):n?YC.aK.instance.moveToContainer(t,a,YC.mc.Center):x.A.dispatch({action:W.r.ViewRoom,room_id:t.roomId,metricsTrigger:"WebFloatingCallWindow"})},[t,d,a,n]),m=(0,o.useCallback)(e=>{var t;(e.preventDefault(),e.stopPropagation(),null!==d)?d.disconnect().catch(e=>console.error("Failed to leave call",e)):null===(t=MC.c.instance.getMessagingForUid(iC.A.getWidgetUid(a)))||void 0===t||t.transport.send(OC.k.HangupCall,{}).catch(e=>console.error("Failed to leave Jitsi",e))},[d,a]);return o.createElement("div",{className:"mx_WidgetPip",onMouseDown:r,onClick:u},o.createElement(jN,{persistentWidgetId:e,persistentRoomId:t.roomId,pointerEvents:"none",movePersistedElement:s},o.createElement("div",{onMouseDown:r,className:"mx_WidgetPip_overlay"},o.createElement(ui.A,{className:"mx_WidgetPip_header"},o.createElement(mi.k,{onClick:u,className:"mx_WidgetPip_backButton","aria-label":(0,c._t)("action|back")},o.createElement(VN,{className:"mx_Icon mx_Icon_16"}),l)),(null!==d||yC.x.JITSI.matches(null==a?void 0:a.type))&&o.createElement(ui.A,{className:"mx_WidgetPip_footer"},o.createElement(mi.k,{onClick:m,title:(0,c._t)("action|leave"),"aria-label":(0,c._t)("action|leave"),placement:"top"},o.createElement(KN,{className:"mx_Icon mx_Icon_24"}))))))},$N=[nn.iP.Connected,nn.iP.InviteSent,nn.iP.Connecting,nn.iP.CreateAnswer,nn.iP.CreateOffer,nn.iP.WaitLocalMedia];function JN(e){if(!e)return[null,[]];const t=jt.Ay.instance.getAllActiveCallsForPip(e);let n=null,i=[];for(const e of t)$N.includes(e.state)&&(e.isRemoteOnHold()||null!==n?i.push(e):n=e);return null===n&&i.length>0&&(n=i[0],i=i.slice(1)),i.length>1&&s.vF.log("Found more than 1 secondary call! Other calls will not be shown."),[n,i]}class YN extends o.Component{constructor(e){super(e),(0,S.A)(this,"onMove",()=>{var e,t;return null===(e=(t=this.props.movePersistedElement).current)||void 0===e?void 0:e.call(t)}),(0,S.A)(this,"onRoomViewStoreUpdate",()=>{var e,t;const n=as.M.instance.roomViewStore.getRoomId(),i=this.state.viewedRoomId;if(n===i)return;const r=null===(e=f.J.get())||void 0===e?void 0:e.getRoom(i);r&&YC.aK.instance.off(YC.aK.emissionForRoom(r),this.updateCalls);const o=null===(t=f.J.get())||void 0===t?void 0:t.getRoom(n||void 0);if(o&&YC.aK.instance.on(YC.aK.emissionForRoom(o),this.updateCalls),!n)return;const[s,a]=JN(n);this.setState({viewedRoomId:n,primaryCall:s,secondaryCall:a[0]}),this.updateShowWidgetInPip()}),(0,S.A)(this,"onWidgetPersistence",()=>{this.updateShowWidgetInPip()}),(0,S.A)(this,"onWidgetDockChanges",()=>{this.updateShowWidgetInPip()}),(0,S.A)(this,"updateCalls",()=>{if(!this.state.viewedRoomId)return;const[e,t]=JN(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]}),this.updateShowWidgetInPip()}),(0,S.A)(this,"onCallRemoteHold",()=>{if(!this.state.viewedRoomId)return;const[e,t]=JN(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]})}),(0,S.A)(this,"onDoubleClick",()=>{var e;const t=null===(e=this.state.primaryCall)||void 0===e?void 0:e.roomId;var n;(null!=t?t:this.state.persistentRoomId)&&x.A.dispatch({action:W.r.ViewRoom,room_id:null!==(n=null!=t?t:this.state.persistentRoomId)&&void 0!==n?n:void 0,metricsTrigger:"WebFloatingCallWindow"})});const t=as.M.instance.roomViewStore.getRoomId(),[n,i]=JN(t);this.state={viewedRoomId:t||void 0,primaryCall:n||null,secondaryCall:i[0],persistentWidgetId:I.A.instance.getPersistentWidgetId(),persistentRoomId:I.A.instance.getPersistentRoomId(),showWidgetInPip:!1}}componentDidMount(){jt.Ay.instance.addListener(jt.uv.CallChangeRoom,this.updateCalls),jt.Ay.instance.addListener(jt.uv.CallState,this.updateCalls),as.M.instance.roomViewStore.addListener(ha.H,this.onRoomViewStoreUpdate),f.J.safeGet().on(nn.$E.RemoteHoldUnhold,this.onCallRemoteHold);const e=f.J.safeGet().getRoom(this.state.viewedRoomId);e&&YC.aK.instance.on(YC.aK.emissionForRoom(e),this.updateCalls),I.A.instance.on(I.y.Persistence,this.onWidgetPersistence),I.A.instance.on(I.y.Dock,this.onWidgetDockChanges),I.A.instance.on(I.y.Undock,this.onWidgetDockChanges)}componentWillUnmount(){jt.Ay.instance.removeListener(jt.uv.CallChangeRoom,this.updateCalls),jt.Ay.instance.removeListener(jt.uv.CallState,this.updateCalls);const e=f.J.get();null==e||e.removeListener(nn.$E.RemoteHoldUnhold,this.onCallRemoteHold),as.M.instance.roomViewStore.removeListener(ha.H,this.onRoomViewStoreUpdate);const t=null==e?void 0:e.getRoom(this.state.viewedRoomId);t&&YC.aK.instance.off(YC.aK.emissionForRoom(t),this.updateCalls),I.A.instance.off(I.y.Persistence,this.onWidgetPersistence),I.A.instance.off(I.y.Dock,this.onWidgetDockChanges),I.A.instance.off(I.y.Undock,this.onWidgetDockChanges)}updateShowWidgetInPip(){const e=I.A.instance.getPersistentWidgetId(),t=I.A.instance.getPersistentRoomId();let n=!1,i=!1;e&&t&&f.J.safeGet().getRoom(t)&&(i=!I.A.instance.isDocked(e,t),n=this.state.viewedRoomId!==t);const r=n||i;this.setState({showWidgetInPip:r,persistentWidgetId:e,persistentRoomId:t})}render(){const e=!0,t=[];if(this.state.primaryCall){const n=this.state.primaryCall;t.push(({onStartMoving:t,onResize:i})=>o.createElement(wT,{key:"call-view",onMouseDownOnHeader:t,call:n,secondaryCall:this.state.secondaryCall,pipMode:e,onResize:i}))}return this.state.showWidgetInPip&&this.state.persistentWidgetId&&t.push(({onStartMoving:e})=>{var t;return o.createElement(qN,{key:"widget-pip",widgetId:this.state.persistentWidgetId,room:f.J.safeGet().getRoom(null!==(t=this.state.persistentRoomId)&&void 0!==t?t:void 0),viewingRoom:this.state.viewedRoomId===this.state.persistentRoomId,onStartMoving:e,movePersistedElement:this.props.movePersistedElement})}),t.length?o.createElement(UN,{className:"mx_LegacyCallPreview",draggable:e,onDoubleClick:this.onDoubleClick,onMove:this.onMove},t):null}}const XN=()=>{const e=(0,o.useRef)(null);return o.createElement(YN,{movePersistedElement:e})};class QN{static encodeActions(e){const t=e.notify,n=e.sound,r=e.highlight;if(t){const e=[i.PushRuleActionName.Notify];return n&&e.push({set_tweak:"sound",value:n}),r?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[i.PushRuleActionName.DontNotify]}static decodeActions(e){let t,n=!1,r=!1;for(const o of e)if(o===i.PushRuleActionName.Notify)n=!0;else if(o===i.PushRuleActionName.DontNotify)n=!1;else{if("object"!=typeof o)return null;if("sound"===o.set_tweak)t=o.value;else{if("highlight"!==o.set_tweak)return null;r=o.value}}void 0===r&&(r=!0);const o={notify:n,highlight:r};return void 0!==t&&(o.sound=t),o}}const ZN=QN.encodeActions;class eD{}(0,S.A)(eD,"ACTION_NOTIFY",ZN({notify:!0})),(0,S.A)(eD,"ACTION_NOTIFY_DEFAULT_SOUND",ZN({notify:!0,sound:"default"})),(0,S.A)(eD,"ACTION_NOTIFY_RING_SOUND",ZN({notify:!0,sound:"ring"})),(0,S.A)(eD,"ACTION_HIGHLIGHT",ZN({notify:!0,highlight:!0})),(0,S.A)(eD,"ACTION_HIGHLIGHT_DEFAULT_SOUND",ZN({notify:!0,sound:"default",highlight:!0})),(0,S.A)(eD,"ACTION_DONT_NOTIFY",ZN({notify:!1})),(0,S.A)(eD,"ACTION_DISABLED",void 0);let tD=function(e){return e.Off="off",e.On="on",e.Loud="loud",e}({});class nD{static actionsFor(e){return e===tD.On?eD.ACTION_NOTIFY:e===tD.Loud?eD.ACTION_HIGHLIGHT_DEFAULT_SOUND:[]}static contentRuleVectorStateKind(e){const t=QN.decodeActions(e.actions);if(!t)return null;let n=0;t.sound&&n++,t.highlight&&n++;let i=null;switch(n){case 0:i=tD.On;break;case 2:i=tD.Loud}return i}}(0,S.A)(nD,"OFF",tD.Off),(0,S.A)(nD,"ON",tD.On),(0,S.A)(nD,"LOUD",tD.Loud),(0,S.A)(nD,"states",tD);class iD{constructor(e){(0,S.A)(this,"description",void 0),(0,S.A)(this,"vectorStateToActions",void 0),(0,S.A)(this,"syncedRuleIds",void 0),this.description=e.description,this.vectorStateToActions=e.vectorStateToActions,this.syncedRuleIds=e.syncedRuleIds}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const n of Object.values(nD.states)){const i=this.vectorStateToActions[n];if(i){if(t&&JSON.stringify(QN.decodeActions(e.actions))===JSON.stringify(QN.decodeActions(i)))return n}else if(!t)return n}s.vF.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: ${JSON.stringify(this.vectorStateToActions)}`)}}const rD={".m.rule.contains_display_name":new iD({description:(0,c.AO)("settings|notifications|rule_contains_display_name"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_HIGHLIGHT_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DISABLED}}),".m.rule.contains_user_name":new iD({description:(0,c.AO)("settings|notifications|rule_contains_user_name"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_HIGHLIGHT_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DISABLED},syncedRuleIds:[i.RuleId.IsUserMention]}),".m.rule.roomnotif":new iD({description:(0,c.AO)("settings|notifications|rule_roomnotif"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_HIGHLIGHT,[tD.Off]:eD.ACTION_DISABLED},syncedRuleIds:[i.RuleId.IsRoomMention]}),".m.rule.room_one_to_one":new iD({description:(0,c.AO)("settings|notifications|rule_room_one_to_one"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_NOTIFY_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DONT_NOTIFY},syncedRuleIds:[i.RuleId.PollStartOneToOne,i.RuleId.PollStartOneToOneUnstable,i.RuleId.PollEndOneToOne,i.RuleId.PollEndOneToOneUnstable]}),".m.rule.encrypted_room_one_to_one":new iD({description:(0,c.AO)("settings|notifications|rule_encrypted_room_one_to_one"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_NOTIFY_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DONT_NOTIFY}}),".m.rule.message":new iD({description:(0,c.AO)("settings|notifications|rule_message"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_NOTIFY_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DONT_NOTIFY},syncedRuleIds:[i.RuleId.PollStart,i.RuleId.PollStartUnstable,i.RuleId.PollEnd,i.RuleId.PollEndUnstable]}),".m.rule.encrypted":new iD({description:(0,c.AO)("settings|notifications|rule_encrypted"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_NOTIFY_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new iD({description:(0,c.AO)("settings|notifications|rule_invite_for_me"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_NOTIFY_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DISABLED}}),".m.rule.call":new iD({description:(0,c.AO)("settings|notifications|rule_call"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_NOTIFY_RING_SOUND,[tD.Off]:eD.ACTION_DISABLED}}),".m.rule.suppress_notices":new iD({description:(0,c.AO)("settings|notifications|rule_suppress_notices"),vectorStateToActions:{[tD.On]:eD.ACTION_DISABLED,[tD.Loud]:eD.ACTION_NOTIFY_DEFAULT_SOUND,[tD.Off]:eD.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new iD({description:(0,c.AO)("settings|notifications|rule_tombstone"),vectorStateToActions:{[tD.On]:eD.ACTION_NOTIFY,[tD.Loud]:eD.ACTION_HIGHLIGHT,[tD.Off]:eD.ACTION_DISABLED}})};class oD{static parseContentRules(e){const t=oD.categoriseContentRules(e);return t.loud.length?{vectorState:tD.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:tD.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:tD.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:tD.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:tD.On,rules:[],externalRules:t.other}}static categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const n in e.global)for(let r=0;r<Object.keys(e.global[n]).length;++r){const o=e.global[n][r];if("."!==o.rule_id[0]&&n===i.PushRuleKind.ContentSpecific)switch(o.kind=n,nD.contentRuleVectorStateKind(o)){case tD.On:o.enabled?t.on.push(o):t.on_but_disabled.push(o);break;case tD.Loud:o.enabled?t.loud.push(o):t.loud_but_disabled.push(o);break;default:t.other.push(o)}}return t}}const sD=async(e,t,n,i)=>{i?(await e.setPushRuleActions("global",n,t,i),await e.setPushRuleEnabled("global",n,t,!0)):await e.setPushRuleEnabled("global",n,t,!1)},aD=async(e,t,n)=>{const i=null==t?void 0:t.map(t=>e.pushProcessor.getPushRuleAndKindById(t)).filter(e=>Boolean(e));if(null!=i&&i.length)for(const{kind:t,rule:r}of i)await sD(e,r.rule_id,t,n)};function lD(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function cD(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?lD(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):lD(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const dD=e=>e?cD(cD({},e.rule),{},{kind:e.kind}):void 0,uD=async(e,t)=>{(null==e?void 0:e.getType())===i.EventType.PushRules&&Object.entries(rD).forEach(async([e,n])=>{try{await(async(e,t,n)=>{var i;const r=dD(e.pushProcessor.getPushRuleAndKindById(t));if(!r)return;const o=null===(i=n.syncedRuleIds)||void 0===i?void 0:i.map(t=>dD(e.pushProcessor.getPushRuleAndKindById(t))).filter(e=>Boolean(e));if(null==o||!o.length)return;const s=n.ruleToVectorState(r),a=o.filter(e=>e.enabled!==r.enabled||n.ruleToVectorState(e)!==s);a.length&&await aD(e,a.map(({rule_id:e})=>e),r.enabled?r.actions:void 0)})(t,e,n)}catch(t){s.vF.error(`Failed to fully synchronise push rules for ${e}`,t)}})};var mD=n("./src/contexts/LocalDeviceVerificationStateContext.ts");function hD(e){const t=function(e){const[t,n]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{const t=e.getUserId();if(!t)return;const i=e.getCrypto();null==i||i.getUserVerificationStatus(t).then(e=>n(e.isCrossSigningVerified()),e=>s.vF.error("Error fetching verification status",e))},[e]),(0,lr.ml)(e,V.cr.UserTrustStatusChanged,(t,i)=>{t===e.getUserId()&&n(i.isCrossSigningVerified())}),t}(e.client);return o.createElement(ce.Ay.Provider,{value:e.client},o.createElement(mD.f.Provider,{value:t},e.children))}function pD(e){return e.closest("input, textarea, select, [contenteditable=true]")}class gD extends o.Component{constructor(e){super(e),(0,S.A)(this,"_matrixClient",void 0),(0,S.A)(this,"_roomView",void 0),(0,S.A)(this,"_resizeContainer",void 0),(0,S.A)(this,"resizeHandler",void 0),(0,S.A)(this,"layoutWatcherRef",void 0),(0,S.A)(this,"compactLayoutWatcherRef",void 0),(0,S.A)(this,"backgroundImageWatcherRef",void 0),(0,S.A)(this,"timezoneProfileUpdateRef",void 0),(0,S.A)(this,"resizer",void 0),(0,S.A)(this,"onTimezoneUpdate",async()=>{if(!O.A.getValue("userTimezonePublish")){try{await this._matrixClient.deleteExtendedProfileProperty("us.cloke.msc4175.tz")}catch(e){console.warn("Failed to delete timezone from user profile",e)}return}const e=O.A.getValue("userTimezone")||Intl.DateTimeFormat().resolvedOptions().timeZone;if(e&&"string"==typeof e)try{await this._matrixClient.setExtendedProfileProperty("us.cloke.msc4175.tz",e)}catch(e){console.warn("Failed to update user profile with current timezone",e)}}),(0,S.A)(this,"onCallState",()=>{const e=jt.Ay.instance.getAllActiveCalls();e!==this.state.activeCalls&&this.setState({activeCalls:e})}),(0,S.A)(this,"refreshBackgroundImage",async()=>{let e=O.A.getValue("RoomList.backgroundImage");e=e?(0,Vi.mediaFromMxc)(e).srcHttp:Yp.V.instance.getHttpAvatarUrl(),this.setState({backgroundImage:null!=e?e:void 0})}),(0,S.A)(this,"canResetTimelineInRoom",e=>!this._roomView.current||this._roomView.current.canResetTimeline()),(0,S.A)(this,"onAccountData",e=>{"m.ignored_user_list"===e.getType()&&x.A.dispatch({action:"ignore_state_changed"}),uD(e,this._matrixClient)}),(0,S.A)(this,"onCompactLayoutChanged",()=>{this.setState({useCompactLayout:O.A.getValue("useCompactLayout")})}),(0,S.A)(this,"onSync",(e,t,n)=>{var r,o;const s=null===(r=this.state.syncErrorData)||void 0===r||null===(r=r.error)||void 0===r?void 0:r.errcode,a=null==n||null===(o=n.error)||void 0===o?void 0:o.errcode;e===t&&s===a||(this.setState({syncErrorData:e===i.SyncState.Error?n:void 0}),t===i.SyncState.Prepared&&e===i.SyncState.Syncing?this.updateServerNoticeEvents():this.calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))}),(0,S.A)(this,"onRoomStateEvents",e=>{const t=Pg.Ay.instance.orderedLists[za.DefaultTagID.ServerNotice];null!=t&&t.some(t=>t.roomId===e.getRoomId())&&this.updateServerNoticeEvents()}),(0,S.A)(this,"onUsageLimitDismissed",()=>{this.setState({usageLimitDismissed:!0})}),(0,S.A)(this,"updateServerNoticeEvents",async()=>{const e=Pg.Ay.instance.orderedLists[za.DefaultTagID.ServerNotice];if(!e)return;const t=[];let n=0;for(const i of e){const e=i.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;n=e.getTs();const r=e.getContent().pinned.slice(0,2);for(const e of r){const n=await this._matrixClient.getEventTimeline(i.getUnfilteredTimelineSet(),e),r=null==n?void 0:n.getEvents().find(t=>t.getId()===e);r&&t.push(r)}}if(n&&this.state.usageLimitEventTs&&this.state.usageLimitEventTs>n)return;const i=t.find(e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type),r=null==i?void 0:i.getContent();this.calculateServerLimitToast(this.state.syncErrorData,r),this.setState({usageLimitEventContent:r,usageLimitEventTs:n,usageLimitDismissed:!1})}),(0,S.A)(this,"onPaste",e=>{const t=pD(e.target);if(t!==document.activeElement)if(null!=t&&t.focus)t.focus();else{var n;const e=!(null===(n=document.activeElement)||void 0===n||!n.closest(".mx_ThreadView"));x.A.dispatch({action:W.r.FocusSendMessageComposer,context:e?kn.Ae.Thread:kn.Ae.Room},!0)}}),(0,S.A)(this,"onReactKeyDown",e=>{this.onKeyDown(e)}),(0,S.A)(this,"onNativeKeyDown",e=>{e.target===document.body&&this.onKeyDown(e)}),(0,S.A)(this,"onKeyDown",e=>{var t,n,i;let r=!1;switch((0,uo.zM)().getRoomAction(e)){case Ei.bY.ScrollUp:case Ei.bY.ScrollDown:case Ei.bY.JumpToFirstMessage:case Ei.bY.JumpToLatestMessage:this.onScrollKeyPressed(e),r=!0;break;case Ei.bY.SearchInRoom:x.A.fire(W.r.FocusMessageSearch),r=!0}if(r)return e.stopPropagation(),void e.preventDefault();const o=(0,uo.zM)().getNavigationAction(e);switch(o){case Ei.bY.NextLandmark:case Ei.bY.PreviousLandmark:gg.r.findAndFocusNextLandmark(gg.H.MESSAGE_COMPOSER_OR_HOME,o===Ei.bY.PreviousLandmark),r=!0;break;case Ei.bY.FilterRooms:x.A.fire(W.r.OpenSpotlight),r=!0;break;case Ei.bY.ToggleUserMenu:x.A.fire(W.r.ToggleUserMenu),r=!0;break;case Ei.bY.ShowKeyboardSettings:x.A.dispatch({action:W.r.ViewUserSettings,initialTabId:We.v.Keyboard}),r=!0;break;case Ei.bY.GoToHome:if(r=!0,R.Ay.hasDialogs())return;x.A.dispatch({action:W.r.ViewHomePage});break;case Ei.bY.ToggleSpacePanel:x.A.fire(W.r.ToggleSpacePanel),r=!0;break;case Ei.bY.ToggleRoomSidePanel:"room_view"===this.props.page_type&&(lg.A.instance.togglePanel(null),r=!0);break;case Ei.bY.SelectPrevRoom:x.A.dispatch({action:W.r.ViewRoomDelta,delta:-1,unread:!1}),r=!0;break;case Ei.bY.SelectNextRoom:x.A.dispatch({action:W.r.ViewRoomDelta,delta:1,unread:!1}),r=!0;break;case Ei.bY.SelectPrevUnreadRoom:x.A.dispatch({action:W.r.ViewRoomDelta,delta:-1,unread:!0});break;case Ei.bY.SelectNextUnreadRoom:x.A.dispatch({action:W.r.ViewRoomDelta,delta:1,unread:!0});break;case Ei.bY.PreviousVisitedRoomOrSpace:null===(t=l.A.get())||void 0===t||t.navigateForwardBack(!0),r=!0;break;case Ei.bY.NextVisitedRoomOrSpace:null===(n=l.A.get())||void 0===n||n.navigateForwardBack(!1),r=!0}if(!r){switch((0,uo.zM)().getLabsAction(e)){case Ei.bY.ToggleHiddenEventVisibility:{const e=O.A.getValueAt(F.p.DEVICE,"showHiddenEventsInTimeline",void 0,!1);O.A.setValue("showHiddenEventsInTimeline",null,F.p.DEVICE,!e),r=!0;break}}}if(!r&&null!==(i=l.A.get())&&void 0!==i&&i.overrideBrowserShortcuts()&&e.code.startsWith("Digit")&&"Digit0"!==e.code&&(0,bi.Et)(e)&&(x.A.dispatch({action:W.r.SwitchSpace,num:parseInt(e.code.slice(5),10)}),r=!0),r)return e.stopPropagation(),void e.preventDefault();if(!(e.key===bi.Uz.ALT||e.key===bi.Uz.CONTROL||e.key===bi.Uz.META||e.key===bi.Uz.SHIFT)&&!e.ctrlKey&&!e.metaKey){const t=e.target!==document.body&&(e.key===bi.Uz.SPACE||e.key===bi.Uz.ENTER),n=1===e.key.length||"Dead"===e.key;if(!t&&n&&!pD(e.target)){var s;const t=!(null===(s=document.activeElement)||void 0===s||!s.closest(".mx_ThreadView"));x.A.dispatch({action:W.r.FocusSendMessageComposer,context:t?kn.Ae.Thread:kn.Ae.Room},!0),e.stopPropagation()}}}),(0,S.A)(this,"onScrollKeyPressed",e=>{var t;null===(t=this._roomView.current)||void 0===t||t.handleScrollKey(e)}),this.state={syncErrorData:void 0,useCompactLayout:O.A.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:jt.Ay.instance.getAllActiveCalls()},this._matrixClient=this.props.matrixClient,Da.Ay.loadDevices(),this._roomView=o.createRef(),this._resizeContainer=o.createRef(),this.resizeHandler=o.createRef()}componentDidMount(){var e;document.addEventListener("keydown",this.onNativeKeyDown,!1),jt.Ay.instance.addListener(jt.uv.CallState,this.onCallState),this.updateServerNoticeEvents(),this._matrixClient.on(i.ClientEvent.AccountData,this.onAccountData),uD(this._matrixClient.getAccountData(i.EventType.PushRules),this._matrixClient),this._matrixClient.on(i.ClientEvent.Sync,this.onSync),this.onSync(this._matrixClient.getSyncState(),null,null!==(e=this._matrixClient.getSyncStateData())&&void 0!==e?e:void 0),this._matrixClient.on(i.RoomStateEvent.Events,this.onRoomStateEvents),this.layoutWatcherRef=O.A.watchSetting("layout",null,this.onCompactLayoutChanged),this.compactLayoutWatcherRef=O.A.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.backgroundImageWatcherRef=O.A.watchSetting("RoomList.backgroundImage",null,this.refreshBackgroundImage),this.timezoneProfileUpdateRef=[O.A.watchSetting("userTimezonePublish",null,this.onTimezoneUpdate),O.A.watchSetting("userTimezone",null,this.onTimezoneUpdate)],this.resizer=this.createResizer(),this.resizer.attach(),Yp.V.instance.on(ha.H,this.refreshBackgroundImage),this.loadResizerPreferences(),this.refreshBackgroundImage()}componentWillUnmount(){var e,t;document.removeEventListener("keydown",this.onNativeKeyDown,!1),jt.Ay.instance.removeListener(jt.uv.CallState,this.onCallState),this._matrixClient.removeListener(i.ClientEvent.AccountData,this.onAccountData),this._matrixClient.removeListener(i.ClientEvent.Sync,this.onSync),this._matrixClient.removeListener(i.RoomStateEvent.Events,this.onRoomStateEvents),Yp.V.instance.off(ha.H,this.refreshBackgroundImage),O.A.unwatchSetting(this.layoutWatcherRef),O.A.unwatchSetting(this.compactLayoutWatcherRef),O.A.unwatchSetting(this.backgroundImageWatcherRef),null===(e=this.timezoneProfileUpdateRef)||void 0===e||e.forEach(e=>O.A.unwatchSetting(e)),null===(t=this.resizer)||void 0===t||t.detach()}createResizer(){var e;let t,n;const i=O.A.getValue("feature_new_room_list"),r={toggleSize:i?224:156,onCollapsed:e=>{i||(n=e,e?(x.A.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):x.A.dispatch({action:"show_left_panel"}))},onResized:e=>{t=e,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{!i&&n||window.localStorage.setItem("mx_lhs_size",""+t),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>!i&&e.classList.contains("mx_LeftPanel_minimized"),handler:null!==(e=this.resizeHandler.current)&&void 0!==e?e:void 0},o=new ja(this._resizeContainer.current,Va,r);return o.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle--vertical",reverse:"mx_ResizeHandle_reverse"}),o}loadResizerPreferences(){var e;const t=O.A.getValue("feature_new_room_list");let n=parseInt(window.localStorage.getItem("mx_lhs_size"),10);(isNaN(n)||t&&n<224)&&(n=350),null===(e=this.resizer)||void 0===e||null===(e=e.forHandleWithId("lp-resizer"))||void 0===e||e.resize(n)}calculateServerLimitToast(e,t){var n;const i="M_RESOURCE_LIMIT_EXCEEDED"===(null==e||null===(n=e.error)||void 0===n?void 0:n.errcode);i&&(t=(null==e?void 0:e.error).data),t&&this.state.usageLimitDismissed?((e,t,n)=>{const i=(0,cs.AB)(e,n,{monthly_active_user:(0,c.AO)("error|mau"),hs_blocked:(0,c.AO)("error|hs_blocked"),"":(0,c.AO)("error|resource_limits")}),r=(0,cs.AB)(e,n,{"":(0,c.AO)("error|admin_contact_short")});L.A.sharedInstance().addOrReplaceToast({key:Ha,title:(0,c._t)("common|warning"),props:{description:o.createElement(o.Fragment,null,i," ",r),primaryLabel:(0,c._t)("action|ok"),onPrimaryClick:()=>{Wa(),t&&t()}},component:H.A,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):Wa()}render(){let e;switch(this.props.page_type){case Ca.A.RoomView:e=o.createElement(_N,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts,forceTimeline:this.props.forceTimeline});break;case Ca.A.HomePage:e=o.createElement(kN,{justRegistered:this.props.justRegistered});break;case Ca.A.UserView:this.props.currentUserId&&(e=o.createElement(RN,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier}))}const t=me()({mx_MatrixChat_wrapper:!0,mx_MatrixChat_useCompactLayout:this.state.useCompactLayout}),n=me()({mx_MatrixChat:!0,"mx_MatrixChat--with-avatar":this.state.backgroundImage}),i=O.A.getValue("feature_new_room_list"),r=me()({mx_LeftPanel_wrapper:!0,mx_LeftPanel_newRoomList:i}),s=this.state.activeCalls.map(e=>o.createElement(vS,{call:e,key:e.callId})),a=!i&&this.props.collapseLhs;return o.createElement(hD,{client:this._matrixClient},o.createElement("div",{onPaste:this.onPaste,onKeyDown:this.onReactKeyDown,className:t,"aria-hidden":this.props.hideToSRUsers},o.createElement(bN,null),o.createElement("div",{className:n},o.createElement("div",{className:"mx_LeftPanel_outerWrapper"},o.createElement(NN,{isMinimized:a||!1}),o.createElement("div",{className:r},!i&&o.createElement(IN,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),o.createElement(Cg,null),!i&&o.createElement(IN,{backgroundImage:this.state.backgroundImage}),o.createElement("div",{className:"mx_LeftPanel_wrapper--user",ref:this._resizeContainer,"data-collapsed":!!a||void 0},o.createElement(uS,{pageType:this.props.page_type,isMinimized:a||!1,resizeNotifier:this.props.resizeNotifier})))),o.createElement(Ma,{passRef:this.resizeHandler,id:"lp-resizer"}),o.createElement("div",{className:"mx_RoomView_wrapper"},e))),o.createElement(XN,null),o.createElement(hS,null),s)}}(0,S.A)(gD,"displayName","LoggedInView");const vD=gD;function fD(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}let _D=function(e){return e[e.Primary=0]="Primary",e[e.Cancel=1]="Cancel",e}({});const yD=({onFinished:e,analyticsOwner:t,privacyPolicyUrl:n,primaryButton:i,cancelButton:r,hasCancel:s})=>{const a=n?o.createElement("span",null,(0,c._t)("analytics|privacy_policy",{},{PrivacyPolicyUrl:e=>o.createElement(Hp.A,{href:n,rel:"norefferer noopener",target:"_blank"},e)})):"";return o.createElement(X.A,{className:"mx_AnalyticsLearnMoreDialog",contentId:"mx_AnalyticsLearnMore",title:(0,c._t)("analytics|enable_prompt",{analyticsOwner:t}),onFinished:e},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("div",{className:"mx_AnalyticsLearnMore_image_holder"}),o.createElement("div",{className:"mx_AnalyticsLearnMore_copy"},(0,c._t)("analytics|pseudonymous_usage_data",{analyticsOwner:t})),o.createElement("ul",{className:"mx_AnalyticsLearnMore_bullets"},o.createElement("li",null,(0,c._t)("analytics|bullet_1",{},{Bold:e=>o.createElement("strong",null,e)})),o.createElement("li",null,(0,c._t)("analytics|bullet_2",{},{Bold:e=>o.createElement("strong",null,e)})),o.createElement("li",null,(0,c._t)("analytics|disable_prompt"))),a),o.createElement(Kt.A,{primaryButton:i,cancelButton:r,onPrimaryButtonClick:()=>e(_D.Primary),onCancel:()=>e(_D.Cancel),hasCancel:s}))},bD=e=>{var t;const n=d.Ay.get("privacy_policy_url"),i=null!==(t=d.Ay.get("analytics_owner"))&&void 0!==t?t:d.Ay.get("brand");return R.Ay.createDialog(yD,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?fD(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fD(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({privacyPolicyUrl:n,analyticsOwner:i},e),"mx_AnalyticsLearnMoreDialog_wrapper")},ED=()=>{x.A.dispatch({action:W.r.PseudonymousAnalyticsAccept})},wD=()=>{x.A.dispatch({action:W.r.PseudonymousAnalyticsReject})},SD=()=>{const{finished:e}=bD({primaryButton:(0,c._t)("action|enable")});e.then(([e])=>{e===_D.Primary&&ED()})},xD=()=>{const{finished:e}=bD({primaryButton:(0,c._t)("analytics|accept_button"),cancelButton:(0,c._t)("action|stop")});e.then(([e])=>{e===_D.Primary?ED():e===_D.Cancel&&wD()})},AD="analytics";const CD=()=>{var e;const t=O.A.getValue("analyticsOptIn",null,!0);let n;if(t)n={description:(0,c._t)("analytics|consent_migration"),primaryLabel:(0,c._t)("analytics|accept_button"),onPrimaryClick:ED,secondaryLabel:(0,c._t)("action|learn_more"),onSecondaryClick:xD};else{if(null!=t)return;{const e=e=>o.createElement(ae.A,{kind:"link_inline",onClick:SD},e);n={description:(0,c._t)("analytics|learn_more",{},{LearnMoreLink:e}),primaryLabel:(0,c._t)("action|yes"),onPrimaryClick:ED,secondaryLabel:(0,c._t)("action|no"),onSecondaryClick:wD}}}const i=null!==(e=d.Ay.get("analytics_owner"))&&void 0!==e?e:d.Ay.get().brand;L.A.sharedInstance().addOrReplaceToast({key:AD,title:(0,c._t)("analytics|enable_prompt",{analyticsOwner:i}),props:n,component:H.A,className:"mx_AnalyticsToast",priority:10})},kD=()=>{L.A.sharedInstance().dismissToast(AD)};var RD=n("./src/components/views/elements/DialPadBackspaceButton.tsx");class ID extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"numberEntryFieldRef",(0,o.createRef)()),(0,S.A)(this,"onCancelClick",()=>{this.props.onFinished(!1)}),(0,S.A)(this,"onChange",e=>{this.setState({value:e.target.value})}),(0,S.A)(this,"onFormSubmit",e=>{e.preventDefault(),this.onDialPress()}),(0,S.A)(this,"onDigitPress",(e,t)=>{var n;(this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())}),(0,S.A)(this,"onDeletePress",e=>{var t;0!==this.state.value.length&&(this.setState({value:this.state.value.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))}),(0,S.A)(this,"onDialPress",async()=>{jt.Ay.instance.dialNumber(this.state.value),this.props.onFinished(!0)}),this.state={value:""}}render(){const e=o.createElement(RD.A,{onBackspacePress:this.onDeletePress});let t;return t=0!==this.state.value.length?o.createElement(wo.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange,postfixComponent:e}):o.createElement(wo.A,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}),o.createElement("div",{className:"mx_DialPadModal"},o.createElement("div",null,o.createElement(ae.A,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),o.createElement("div",{className:"mx_DialPadModal_header"},o.createElement("form",{onSubmit:this.onFormSubmit},t)),o.createElement("div",{className:"mx_DialPadModal_dialPad"},o.createElement(lT.Ay,{hasDial:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}}const TD=()=>{window.location.href="mobile_guide/"},PD=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",DD()},ND="mobileguide",DD=()=>{L.A.sharedInstance().dismissToast(ND)},MD="_toast-container_xzz4o_8",OD=["children","className"];function FD(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function LD(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?FD(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):FD(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const UD=(0,o.forwardRef)(function(e,t){let{children:n,className:i}=e,r=(0,v.A)(e,OD);const o=ue(MD,i);return(0,$.jsx)("div",LD(LD({},r),{},{className:o,ref:t,children:n}))});function BD(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M3.5 20q-.625 0-1.062-.437A1.45 1.45 0 0 1 2 18.5q0-.625.438-1.062A1.45 1.45 0 0 1 3.5 17H4V6q0-.824.588-1.412A1.93 1.93 0 0 1 6 4h14q.424 0 .712.287Q21 4.576 21 5t-.288.713A.97.97 0 0 1 20 6H6v11h4.5q.624 0 1.063.438.437.437.437 1.062t-.437 1.063A1.45 1.45 0 0 1 10.5 20zM15 20a.97.97 0 0 1-.713-.288A.97.97 0 0 1 14 19V9q0-.424.287-.713A.97.97 0 0 1 15 8h6q.424 0 .712.287Q22 8.576 22 9v10q0 .424-.288.712A.97.97 0 0 1 21 20zm1-3h4v-7h-4z"})})}BD.displayName="DevicesIcon";const VD=(0,o.forwardRef)(BD);function jD(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M5.188 8v2h2V8zm3.875 0v2h2V8zm3.875 0v2h2V8zm3.875 0v2h2V8zM5.188 11.531v2h2v-2zm3.875 0v2h2v-2zm3.875 0v2h2v-2zm3.875 0v2h2v-2zM9 15a1 1 0 1 0 0 2h6a1 1 0 1 0 0-2z"}),(0,$.jsx)("path",{fillRule:"evenodd",d:"M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm2 0h16v12H4z",clipRule:"evenodd"})]})}jD.displayName="KeyboardIcon";const zD=(0,o.forwardRef)(jD);function HD(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{fillRule:"evenodd",d:"M18 3a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4zm-8 2h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-8zM8 19H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2z",clipRule:"evenodd"})})}HD.displayName="SidebarIcon";const WD=(0,o.forwardRef)(HD);function GD(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M6 12a1 1 0 1 0-2 0 8 8 0 0 0 7 7.938V21a1 1 0 1 0 2 0v-1.062A8 8 0 0 0 20 12a1 1 0 1 0-2 0 6 6 0 0 1-12 0"}),(0,$.jsx)("path",{fillRule:"evenodd",d:"M14 12V6a2 2 0 1 0-4 0v6a2 2 0 1 0 4 0M12 2a4 4 0 0 0-4 4v6a4 4 0 0 0 8 0V6a4 4 0 0 0-4-4",clipRule:"evenodd"})]})}GD.displayName="MicOnIcon";const KD=(0,o.forwardRef)(GD);function qD(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M6 22q-.824 0-1.412-.587A1.93 1.93 0 0 1 4 20V10q0-.825.588-1.412A1.93 1.93 0 0 1 6 8h1V6q0-2.075 1.463-3.537Q9.926 1 12 1q2.075 0 3.537 1.463Q17 3.925 17 6v2h1q.824 0 1.413.588Q20 9.175 20 10v10q0 .824-.587 1.413A1.93 1.93 0 0 1 18 22zm0-2h12V10H6zM9 8h6V6q0-1.25-.875-2.125A2.9 2.9 0 0 0 12 3q-1.25 0-2.125.875A2.9 2.9 0 0 0 9 6z"})})}qD.displayName="LockIcon";const $D=(0,o.forwardRef)(qD);function JD(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M12 5a1 1 0 0 1-1-1V3a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1m-7.071-.071a1 1 0 0 1 1.414 0l.707.707A1 1 0 0 1 5.636 7.05l-.707-.707a1 1 0 0 1 0-1.414"}),(0,$.jsx)("path",{fillRule:"evenodd",d:"M15.734 15.325C15.316 15.795 15 16.371 15 17v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2c0-.63-.316-1.205-.734-1.675a5 5 0 1 1 7.468 0m-1.493-1.33a3 3 0 1 0-4.482 0c.433.486.894 1.166 1.112 2.005h2.258c.218-.84.679-1.52 1.112-2.005M13 18h-2v1h2z",clipRule:"evenodd"}),(0,$.jsx)("path",{d:"M2 12a1 1 0 0 1 1-1h1a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1m18-1a1 1 0 1 0 0 2h1a1 1 0 1 0 0-2zm-3.05-5.364a1 1 0 0 0 1.414 1.414l.707-.707a1 1 0 0 0-1.414-1.414z"})]})}JD.displayName="LabsIcon";const YD=(0,o.forwardRef)(JD);var XD=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/block.js"),QD=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/EditInPlace/EditInPlace.js");function ZD(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"m10.6 13.8-2.15-2.15a.95.95 0 0 0-.7-.275.95.95 0 0 0-.7.275.95.95 0 0 0-.275.7q0 .425.275.7L9.9 15.9q.3.3.7.3t.7-.3l5.65-5.65a.95.95 0 0 0 .275-.7.95.95 0 0 0-.275-.7.95.95 0 0 0-.7-.275.95.95 0 0 0-.7.275zM12 22a9.7 9.7 0 0 1-3.9-.788 10.1 10.1 0 0 1-3.175-2.137q-1.35-1.35-2.137-3.175A9.7 9.7 0 0 1 2 12q0-2.075.788-3.9a10.1 10.1 0 0 1 2.137-3.175q1.35-1.35 3.175-2.137A9.7 9.7 0 0 1 12 2q2.075 0 3.9.788a10.1 10.1 0 0 1 3.175 2.137q1.35 1.35 2.137 3.175A9.7 9.7 0 0 1 22 12a9.7 9.7 0 0 1-.788 3.9 10.1 10.1 0 0 1-2.137 3.175q-1.35 1.35-3.175 2.137A9.7 9.7 0 0 1 12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4 6.325 6.325 4 12t2.325 5.675T12 20"})})}ZD.displayName="CheckCircleIcon";const eM=(0,o.forwardRef)(ZD),tM={alert:"_alert_zx76t_10",content:"_content_zx76t_37","text-content":"_text-content_zx76t_44",icon:"_icon_zx76t_48",actions:"_actions_zx76t_64"},nM=["type","title","children","className","actions","onClose"];function iM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function rM(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?iM(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iM(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const oM=e=>{let{type:t,title:n,children:i,className:r,actions:s,onClose:a}=e,l=(0,v.A)(e,nM);const c=ue(tM.alert,r),d=(0,o.useCallback)(e=>{switch(t){case"critical":return(0,$.jsx)(Te.A,rM({},e));case"info":return(0,$.jsx)(Ie,rM({},e));case"success":return(0,$.jsx)(eM,rM({},e))}},[t]);return(0,$.jsxs)("div",rM(rM({},l),{},{className:c,"data-type":t,children:[d({width:24,height:24,className:tM.icon,"aria-hidden":!0}),(0,$.jsxs)("div",{className:tM.content,children:[(0,$.jsxs)("div",{className:tM["text-content"],children:[(0,$.jsx)(og.E,{size:"md",weight:"semibold",children:n}),(0,$.jsx)(og.E,{size:"sm",weight:"regular",children:i})]}),s&&(0,$.jsx)("div",{className:tM.actions,children:s})]}),a&&(0,$.jsx)(rg.K,{onClick:a,"aria-label":"Close",role:"button",className:tM.close,children:(0,$.jsx)(PT.A,{})})]}))};function sM(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M9 12.031q0-.424.288-.712A.97.97 0 0 1 10 11.03h7.15l-1.875-1.875a.96.96 0 0 1-.3-.7q0-.4.325-.725a.93.93 0 0 1 .712-.287.98.98 0 0 1 .688.287l3.6 3.6q.15.15.212.325.063.175.063.375 0 .201-.062.375a.9.9 0 0 1-.213.325l-3.6 3.6q-.3.3-.712.288a.98.98 0 0 1-.688-.288 1.02 1.02 0 0 1-.312-.712.93.93 0 0 1 .287-.713l1.875-1.875H10a.97.97 0 0 1-.712-.287A.97.97 0 0 1 9 12.03m-6-7q0-.824.588-1.412A1.93 1.93 0 0 1 5 3.03h6q.424 0 .713.288.287.287.287.712t-.287.713A.97.97 0 0 1 11 5.03H5v14h6q.424 0 .713.288.287.287.287.712t-.287.713a.97.97 0 0 1-.713.287H5q-.824 0-1.412-.587A1.93 1.93 0 0 1 3 19.03z"})})}sM.displayName="SignOutIcon";const aM=(0,o.forwardRef)(sM),lM=(0,o.createContext)(null);lM.displayName="ToastContext";class cM{constructor(){(0,S.A)(this,"currentToast",void 0),(0,S.A)(this,"updateCallback",void 0),(0,S.A)(this,"idSeq",0)}setCallback(e){this.updateCallback=e}displayToast(e){var t;const n=++this.idSeq;this.currentToast={id:n,contents:e},null===(t=this.updateCallback)||void 0===t||t.call(this);return()=>{var e,t;(null===(e=this.currentToast)||void 0===e?void 0:e.id)===n&&(this.currentToast=void 0,null===(t=this.updateCallback)||void 0===t||t.call(this))}}getActiveToast(){var e;return null===(e=this.currentToast)||void 0===e?void 0:e.contents}}var dM=n("./src/components/views/elements/CopyableText.tsx");const uM=({children:e})=>o.createElement(o.Fragment,null,o.createElement(tl.A,null),e),mM=({username:e})=>{const t=(0,o.useId)();return o.createElement("div",{className:"mx_UserProfileSettings_profile_controls_userId"},o.createElement("div",{className:"mx_UserProfileSettings_profile_controls_userId_label",id:t},(0,c._t)("settings|general|username")),o.createElement(dM.A,{getTextToCopy:()=>e,"aria-labelledby":t},e))},hM=({externalAccountManagementUrl:e})=>o.createElement(ae.A,{onClick:null,element:"a",kind:"primary",target:"_blank",rel:"noreferrer noopener",href:e},o.createElement(Ke.A,{className:"mx_UserProfileSettings_accountmanageIcon",width:"24",height:"24"}),(0,c._t)("settings|general|oidc_manage_button")),pM=()=>{const e=(0,ce.nH)(),t=(0,o.useCallback)(async()=>{await Kp(e)?R.Ay.createDialog(qp):x.A.dispatch({action:"logout"})},[e]);return o.createElement(ae.A,{onClick:t,kind:"danger_outline"},o.createElement(aM,{className:"mx_UserProfileSettings_accountmanageIcon",width:"24",height:"24"}),(0,c._t)("action|sign_out"))},gM=({externalAccountManagementUrl:e,canSetDisplayName:t,canSetAvatar:n})=>{var i,r;const[a,l]=(0,o.useState)(Yp.V.instance.avatarMxc),[d,u]=(0,o.useState)(null!==(i=Yp.V.instance.displayName)&&void 0!==i?i:""),[m,h]=(0,o.useState)(!1),[p,g]=(0,o.useState)(),[v,f]=(0,o.useState)(!1),_=(0,o.useContext)(lM),y=(0,ce.nH)();(0,o.useEffect)(()=>{(async()=>{try{const e=await y.getMediaConfig();g(e["m.upload.size"])}catch(e){s.vF.warn("Failed to get media config",e)}})()},[y]);const b=(0,o.useCallback)(async()=>{const e=_.displayToast(o.createElement(uM,null,(0,c._t)("settings|general|avatar_remove_progress")));try{await y.setAvatarUrl(""),l("")}finally{e()}},[_,y]),E=(0,o.useCallback)(async e=>{Si.A.trackInteraction("WebProfileSettingsAvatarUploadButton"),s.vF.log(`Uploading new avatar, ${e.name} of type ${e.type}, (${e.size}) bytes`);const t=_.displayToast(o.createElement(uM,null,(0,c._t)("settings|general|avatar_save_progress")));try{h(!1);const{content_uri:t}=await y.uploadContent(e);await y.setAvatarUrl(t),l(t)}catch{h(!0)}finally{t()}},[_,y]),w=(0,o.useCallback)(e=>{u(e.target.value)},[]),S=(0,o.useCallback)(()=>{var e;u(null!==(e=Yp.V.instance.displayName)&&void 0!==e?e:"")},[]),x=(0,o.useCallback)(async()=>{try{f(!1),await y.setDisplayName(d)}catch(e){throw f(!0),e}},[d,y]),A=(0,o.useMemo)(()=>an.A.getDisplayUserIdentifier(y.getSafeUserId(),{withDisplayName:!0}),[y]),C=!t||!n;return o.createElement("div",{className:"mx_UserProfileSettings"},o.createElement("h2",null,(0,c._t)("common|profile")),o.createElement("div",null,C?(0,c._t)("settings|general|profile_subtitle_oidc"):(0,c._t)("settings|general|profile_subtitle")),o.createElement("div",{className:"mx_UserProfileSettings_profile"},o.createElement(vA.A,{avatar:null!=a?a:void 0,avatarAltText:(0,c._t)("common|user_avatar"),onChange:E,removeAvatar:a?b:void 0,placeholderName:d,placeholderId:null!==(r=y.getUserId())&&void 0!==r?r:"",disabled:!n}),o.createElement(QD.d,{className:"mx_UserProfileSettings_profile_displayName",label:(0,c._t)("settings|general|display_name"),value:d,saveButtonLabel:(0,c._t)("common|save"),cancelButtonLabel:(0,c._t)("common|cancel"),savedLabel:(0,c._t)("common|saved"),savingLabel:(0,c._t)("common|updating"),onChange:w,onCancel:S,onSave:x,disabled:!t},v&&o.createElement(VA.Kw,null,(0,c._t)("settings|general|display_name_error")))),m&&o.createElement(oM,{title:(0,c._t)("settings|general|avatar_upload_error_title"),type:"critical"},void 0===p?(0,c._t)("settings|general|avatar_upload_error_text_generic"):(0,c._t)("settings|general|avatar_upload_error_text",{size:(0,sn.z3)(p)})),A&&o.createElement(mM,{username:A}),o.createElement(Fe.s,{gap:"var(--cpd-space-4x)",className:"mx_UserProfileSettings_profile_buttons"},e&&o.createElement(hM,{externalAccountManagementUrl:e}),o.createElement(pM,null)))};var vM=n("./src/components/structures/InteractiveAuth.tsx");class fM extends o.Component{constructor(e){super(e),(0,S.A)(this,"onStagePhaseChange",(e,t)=>{const n={[Ne.av.PHASE_PREAUTH]:{body:(0,c._t)("settings|general|deactivate_confirm_body_sso"),continueText:(0,c._t)("auth|sso"),continueKind:"danger"},[Ne.av.PHASE_POSTAUTH]:{body:(0,c._t)("settings|general|deactivate_confirm_body"),continueText:(0,c._t)("settings|general|deactivate_confirm_continue"),continueKind:"danger"}},i={[Ne.av.LOGIN_TYPE]:n,[Ne.av.UNSTABLE_LOGIN_TYPE]:n}[e];let r,o,s;if(i){const e=i[t];e&&(e.body&&(r=e.body),e.continueText&&(o=e.continueText),e.continueKind&&(s=e.continueKind))}this.setState({bodyText:r,continueText:o,continueKind:s})}),(0,S.A)(this,"onUIAuthFinished",async(e,t)=>{e||(t!==vM.R?(s.vF.error("Error during UI Auth:",{result:t}),this.setState({errStr:(0,c._t)("settings|general|error_deactivate_communication")})):this.onCancel())}),(0,S.A)(this,"onUIAuthComplete",e=>{f.J.safeGet().deactivateAccount(null!=e?e:void 0,this.state.shouldErase).then(e=>{x.A.fire(W.r.TriggerLogout),this.props.onFinished(!0)}).catch(e=>{s.vF.error(e),this.setState({errStr:(0,c._t)("settings|general|error_deactivate_communication")})})}),(0,S.A)(this,"onEraseFieldChange",e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)}),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0}}componentDidMount(){this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){f.J.safeGet().deactivateAccount(void 0,e).then(e=>{s.vF.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:(0,c._t)("settings|general|error_deactivate_no_auth")})}).catch(e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:(0,c._t)("settings|general|error_deactivate_invalid_auth")})})}render(){let e;this.state.errStr&&(e=o.createElement("div",{className:"error"},this.state.errStr));let t=o.createElement("div",null,(0,c._t)("common|loading"));return this.state.authData&&this.state.authEnabled&&(t=o.createElement("div",null,this.state.bodyText,o.createElement(vM.A,{matrixClient:f.J.safeGet(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),o.createElement(X.A,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:(0,c._t)("settings|general|deactivate_section"),screenName:"DeactivateAccount"},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("p",null,(0,c._t)("settings|general|deactivate_confirm_content")),o.createElement("ul",null,o.createElement("li",null,(0,c._t)("settings|general|deactivate_confirm_content_1")),o.createElement("li",null,(0,c._t)("settings|general|deactivate_confirm_content_2")),o.createElement("li",null,(0,c._t)("settings|general|deactivate_confirm_content_3")),o.createElement("li",null,(0,c._t)("settings|general|deactivate_confirm_content_4")),o.createElement("li",null,(0,c._t)("settings|general|deactivate_confirm_content_5"))),o.createElement("p",null,(0,c._t)("settings|general|deactivate_confirm_content_6")),o.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},o.createElement("p",null,o.createElement(Io.A,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},(0,c._t)("settings|general|deactivate_confirm_erase_label"))),e,t)))}}var _M=n("./src/components/views/auth/PassphraseField.tsx");const yM=/^[0-9 -.]+$/;const bM=127462-"A".charCodeAt(0),EM=/^[A-Z]{2}$/,wM=[{iso2:"GB",prefix:"44"},{iso2:"US",prefix:"1"},{iso2:"AF",prefix:"93"},{iso2:"AX",prefix:"358"},{iso2:"AL",prefix:"355"},{iso2:"DZ",prefix:"213"},{iso2:"AS",prefix:"1"},{iso2:"AD",prefix:"376"},{iso2:"AO",prefix:"244"},{iso2:"AI",prefix:"1"},{iso2:"AQ",prefix:"672"},{iso2:"AG",prefix:"1"},{iso2:"AR",prefix:"54"},{iso2:"AM",prefix:"374"},{iso2:"AW",prefix:"297"},{iso2:"AU",prefix:"61"},{iso2:"AT",prefix:"43"},{iso2:"AZ",prefix:"994"},{iso2:"BS",prefix:"1"},{iso2:"BH",prefix:"973"},{iso2:"BD",prefix:"880"},{iso2:"BB",prefix:"1"},{iso2:"BY",prefix:"375"},{iso2:"BE",prefix:"32"},{iso2:"BZ",prefix:"501"},{iso2:"BJ",prefix:"229"},{iso2:"BM",prefix:"1"},{iso2:"BT",prefix:"975"},{iso2:"BO",prefix:"591"},{iso2:"BA",prefix:"387"},{iso2:"BW",prefix:"267"},{iso2:"BV",prefix:"47"},{iso2:"BR",prefix:"55"},{iso2:"IO",prefix:"246"},{iso2:"VG",prefix:"1"},{iso2:"BN",prefix:"673"},{iso2:"BG",prefix:"359"},{iso2:"BF",prefix:"226"},{iso2:"BI",prefix:"257"},{iso2:"KH",prefix:"855"},{iso2:"CM",prefix:"237"},{iso2:"CA",prefix:"1"},{iso2:"CV",prefix:"238"},{iso2:"BQ",prefix:"599"},{iso2:"KY",prefix:"1"},{iso2:"CF",prefix:"236"},{iso2:"TD",prefix:"235"},{iso2:"CL",prefix:"56"},{iso2:"CN",prefix:"86"},{iso2:"CX",prefix:"61"},{iso2:"CC",prefix:"61"},{iso2:"CO",prefix:"57"},{iso2:"KM",prefix:"269"},{iso2:"CG",prefix:"242"},{iso2:"CD",prefix:"243"},{iso2:"CK",prefix:"682"},{iso2:"CR",prefix:"506"},{iso2:"HR",prefix:"385"},{iso2:"CU",prefix:"53"},{iso2:"CW",prefix:"599"},{iso2:"CY",prefix:"357"},{iso2:"CZ",prefix:"420"},{iso2:"CI",prefix:"225"},{iso2:"DK",prefix:"45"},{iso2:"DJ",prefix:"253"},{iso2:"DM",prefix:"1"},{iso2:"DO",prefix:"1"},{iso2:"EC",prefix:"593"},{iso2:"EG",prefix:"20"},{iso2:"SV",prefix:"503"},{iso2:"GQ",prefix:"240"},{iso2:"ER",prefix:"291"},{iso2:"EE",prefix:"372"},{iso2:"ET",prefix:"251"},{iso2:"FK",prefix:"500"},{iso2:"FO",prefix:"298"},{iso2:"FJ",prefix:"679"},{iso2:"FI",prefix:"358"},{iso2:"FR",prefix:"33"},{iso2:"GF",prefix:"594"},{iso2:"PF",prefix:"689"},{iso2:"TF",prefix:"262"},{iso2:"GA",prefix:"241"},{iso2:"GM",prefix:"220"},{iso2:"GE",prefix:"995"},{iso2:"DE",prefix:"49"},{iso2:"GH",prefix:"233"},{iso2:"GI",prefix:"350"},{iso2:"GR",prefix:"30"},{iso2:"GL",prefix:"299"},{iso2:"GD",prefix:"1"},{iso2:"GP",prefix:"590"},{iso2:"GU",prefix:"1"},{iso2:"GT",prefix:"502"},{iso2:"GG",prefix:"44"},{iso2:"GN",prefix:"224"},{iso2:"GW",prefix:"245"},{iso2:"GY",prefix:"592"},{iso2:"HT",prefix:"509"},{iso2:"HM",prefix:"672"},{iso2:"HN",prefix:"504"},{iso2:"HK",prefix:"852"},{iso2:"HU",prefix:"36"},{iso2:"IS",prefix:"354"},{iso2:"IN",prefix:"91"},{iso2:"ID",prefix:"62"},{iso2:"IR",prefix:"98"},{iso2:"IQ",prefix:"964"},{iso2:"IE",prefix:"353"},{iso2:"IM",prefix:"44"},{iso2:"IL",prefix:"972"},{iso2:"IT",prefix:"39"},{iso2:"JM",prefix:"1"},{iso2:"JP",prefix:"81"},{iso2:"JE",prefix:"44"},{iso2:"JO",prefix:"962"},{iso2:"KZ",prefix:"7"},{iso2:"KE",prefix:"254"},{iso2:"KI",prefix:"686"},{iso2:"XK",prefix:"383"},{iso2:"KW",prefix:"965"},{iso2:"KG",prefix:"996"},{iso2:"LA",prefix:"856"},{iso2:"LV",prefix:"371"},{iso2:"LB",prefix:"961"},{iso2:"LS",prefix:"266"},{iso2:"LR",prefix:"231"},{iso2:"LY",prefix:"218"},{iso2:"LI",prefix:"423"},{iso2:"LT",prefix:"370"},{iso2:"LU",prefix:"352"},{iso2:"MO",prefix:"853"},{iso2:"MK",prefix:"389"},{iso2:"MG",prefix:"261"},{iso2:"MW",prefix:"265"},{iso2:"MY",prefix:"60"},{iso2:"MV",prefix:"960"},{iso2:"ML",prefix:"223"},{iso2:"MT",prefix:"356"},{iso2:"MH",prefix:"692"},{iso2:"MQ",prefix:"596"},{iso2:"MR",prefix:"222"},{iso2:"MU",prefix:"230"},{iso2:"YT",prefix:"262"},{iso2:"MX",prefix:"52"},{iso2:"FM",prefix:"691"},{iso2:"MD",prefix:"373"},{iso2:"MC",prefix:"377"},{iso2:"MN",prefix:"976"},{iso2:"ME",prefix:"382"},{iso2:"MS",prefix:"1"},{iso2:"MA",prefix:"212"},{iso2:"MZ",prefix:"258"},{iso2:"MM",prefix:"95"},{iso2:"NA",prefix:"264"},{iso2:"NR",prefix:"674"},{iso2:"NP",prefix:"977"},{iso2:"NL",prefix:"31"},{iso2:"NC",prefix:"687"},{iso2:"NZ",prefix:"64"},{iso2:"NI",prefix:"505"},{iso2:"NE",prefix:"227"},{iso2:"NG",prefix:"234"},{iso2:"NU",prefix:"683"},{iso2:"NF",prefix:"672"},{iso2:"KP",prefix:"850"},{iso2:"MP",prefix:"1"},{iso2:"NO",prefix:"47"},{iso2:"OM",prefix:"968"},{iso2:"PK",prefix:"92"},{iso2:"PW",prefix:"680"},{iso2:"PS",prefix:"970"},{iso2:"PA",prefix:"507"},{iso2:"PG",prefix:"675"},{iso2:"PY",prefix:"595"},{iso2:"PE",prefix:"51"},{iso2:"PH",prefix:"63"},{iso2:"PN",prefix:"870"},{iso2:"PL",prefix:"48"},{iso2:"PT",prefix:"351"},{iso2:"PR",prefix:"1"},{iso2:"QA",prefix:"974"},{iso2:"RO",prefix:"40"},{iso2:"RU",prefix:"7"},{iso2:"RW",prefix:"250"},{iso2:"RE",prefix:"262"},{iso2:"WS",prefix:"685"},{iso2:"SM",prefix:"378"},{iso2:"SA",prefix:"966"},{iso2:"SN",prefix:"221"},{iso2:"RS",prefix:"381 p"},{iso2:"SC",prefix:"248"},{iso2:"SL",prefix:"232"},{iso2:"SG",prefix:"65"},{iso2:"SX",prefix:"1"},{iso2:"SK",prefix:"421"},{iso2:"SI",prefix:"386"},{iso2:"SB",prefix:"677"},{iso2:"SO",prefix:"252"},{iso2:"ZA",prefix:"27"},{iso2:"GS",prefix:"500"},{iso2:"KR",prefix:"82"},{iso2:"SS",prefix:"211"},{iso2:"ES",prefix:"34"},{iso2:"LK",prefix:"94"},{iso2:"BL",prefix:"590"},{iso2:"SH",prefix:"290 n"},{iso2:"KN",prefix:"1"},{iso2:"LC",prefix:"1"},{iso2:"MF",prefix:"590"},{iso2:"PM",prefix:"508"},{iso2:"VC",prefix:"1"},{iso2:"SD",prefix:"249"},{iso2:"SR",prefix:"597"},{iso2:"SJ",prefix:"47"},{iso2:"SZ",prefix:"268"},{iso2:"SE",prefix:"46"},{iso2:"CH",prefix:"41"},{iso2:"SY",prefix:"963"},{iso2:"ST",prefix:"239"},{iso2:"TW",prefix:"886"},{iso2:"TJ",prefix:"992"},{iso2:"TZ",prefix:"255"},{iso2:"TH",prefix:"66"},{iso2:"TL",prefix:"670"},{iso2:"TG",prefix:"228"},{iso2:"TK",prefix:"690"},{iso2:"TO",prefix:"676"},{iso2:"TT",prefix:"1"},{iso2:"TN",prefix:"216"},{iso2:"TR",prefix:"90"},{iso2:"TM",prefix:"993"},{iso2:"TC",prefix:"1"},{iso2:"TV",prefix:"688"},{iso2:"VI",prefix:"1"},{iso2:"UG",prefix:"256"},{iso2:"UA",prefix:"380"},{iso2:"AE",prefix:"971"},{iso2:"UY",prefix:"598"},{iso2:"UZ",prefix:"998"},{iso2:"VU",prefix:"678"},{iso2:"VA",prefix:"39"},{iso2:"VE",prefix:"58"},{iso2:"VN",prefix:"84"},{iso2:"WF",prefix:"681"},{iso2:"EH",prefix:"212"},{iso2:"YE",prefix:"967"},{iso2:"ZM",prefix:"260"},{iso2:"ZW",prefix:"263"}];class SM extends o.PureComponent{constructor(...e){super(...e),(0,S.A)(this,"validate",(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)(this.props.labelRequired)},{key:"email",test:({value:e})=>!e||sP.X(e),invalid:()=>(0,c._t)(this.props.labelInvalid)}]})),(0,S.A)(this,"onValidate",async e=>{let t=this.validate;this.props.validationRules&&(t=this.props.validationRules);const n=await t(e);return this.props.onValidate&&this.props.onValidate(n),n})}render(){return o.createElement(wo.A,{id:this.props.id,ref:this.props.fieldRef,type:"text",label:(0,c._t)(this.props.label),value:this.props.value,autoFocus:this.props.autoFocus,onChange:this.props.onChange,onValidate:this.onValidate,tooltipAlignment:this.props.tooltipAlignment})}}(0,S.A)(SM,"defaultProps",{label:(0,c.AO)("auth|email_field_label"),labelRequired:(0,c.AO)("auth|email_field_label_required"),labelInvalid:(0,c.AO)("auth|email_field_label_invalid")});const xM=SM,AM=({onFinished:e})=>{const[t,n]=(0,o.useState)(""),i=(0,o.useRef)(null),r=async n=>{if(n.preventDefault(),i.current){if(t){if(!await i.current.validate({}))return i.current.focus(),void i.current.validate({focused:!0})}e(!0,t)}};return o.createElement(X.A,{title:(0,c._t)("auth|registration|continue_without_email_title"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>e(!1),fixedWidth:!1},o.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},o.createElement("p",null,(0,c._t)("auth|registration|continue_without_email_description",{},{b:e=>o.createElement("strong",null,e)})),o.createElement("form",{onSubmit:r},o.createElement(xM,{fieldRef:i,autoFocus:!0,label:(0,c.AO)("auth|registration|continue_without_email_field_label"),value:t,onChange:e=>{const t=e.target;n(t.value)}}))),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|continue"),onPrimaryButtonClick:r,hasCancel:!1}))};function CM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}class kM extends o.Component{constructor(e){super(e),(0,S.A)(this,"defaultCountry",void 0),(0,S.A)(this,"countries",void 0),(0,S.A)(this,"countryMap",void 0),(0,S.A)(this,"onSearchChange",e=>{this.setState({searchQuery:e})}),(0,S.A)(this,"onOptionChange",e=>{this.props.onOptionChange(this.countryMap.get(e))}),(0,S.A)(this,"getShortOption",e=>{if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+this.countryMap.get(e).prefix),o.createElement("span",{className:"mx_CountryDropdown_shortOption"},this.flagImgForIso2(e),t)});const t=new Intl.DisplayNames([(0,c.mf)()],{type:"region"});let n;this.countries=wM.map(e=>{var n;return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?CM(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CM(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({name:null!==(n=t.of(e.iso2))&&void 0!==n?n:e.iso2},e)}),this.countryMap=new Map(this.countries.map(e=>[e.iso2,e]));const i=d.Ay.get("default_country_code");if(i){const e=this.countries.find(e=>e.iso2===i.toUpperCase());e&&(n=e)}if(!n)try{var r,s,a;const e=new Intl.Locale(null!==(r=navigator.language)&&void 0!==r?r:navigator.languages[0]),i=null!==(s=null!==(a=e.region)&&void 0!==a?a:e.language)&&void 0!==s?s:e.baseName,o=t.of(i).toUpperCase();n=this.countries.find(e=>e.iso2===i.toUpperCase()||e.name.toUpperCase()===o)}catch(e){console.warn("Failed to detect default locale",e)}this.defaultCountry=null!=n?n:this.countries[0],this.state={searchQuery:""}}componentDidMount(){this.props.value||this.props.onOptionChange(this.defaultCountry)}flagImgForIso2(e){return o.createElement("div",{className:"mx_Dropdown_option_emoji"},(t=e,EM.test(t)?String.fromCodePoint(...t.split("").map(e=>bM+e.charCodeAt(0))):""));var t}render(){let e;if(this.state.searchQuery){if(e=this.countries.filter(e=>function(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e)}(this.state.searchQuery,e)),2==this.state.searchQuery.length&&this.countryMap.has(this.state.searchQuery.toUpperCase())){const t=this.countryMap.get(this.state.searchQuery.toUpperCase());e=e.filter(e=>e.iso2!=t.iso2),e.unshift(t)}}else e=this.countries;const t=e.map(e=>o.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this.flagImgForIso2(e.iso2),e.name," (+",e.prefix,")")),n=this.props.value||this.defaultCountry.iso2;return o.createElement(Fp.A,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this.onOptionChange,onSearchChange:this.onSearchChange,menuWidth:298,getShortOption:this.getShortOption,value:n,searchEnabled:!0,disabled:this.props.disabled,label:(0,c._t)("auth|country_dropdown"),autoComplete:"tel-country-code"},t)}}var RM=n("./src/components/views/auth/PassphraseConfirmField.tsx");let IM,TM,PM,NM,DM;var MM=function(e){return e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm",e}(MM||{}),OM=function(e){return e[e.Unknown=0]="Unknown",e[e.Available=1]="Available",e[e.Unavailable=2]="Unavailable",e[e.Error=3]="Error",e[e.Invalid=4]="Invalid",e}(OM||{});IM=MM.Email,TM=MM.Password,PM=MM.PasswordConfirm,NM=MM.Username,DM=MM.PhoneNumber;class FM extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,IM,null),(0,S.A)(this,TM,null),(0,S.A)(this,PM,null),(0,S.A)(this,NM,null),(0,S.A)(this,DM,null),(0,S.A)(this,"onSubmit",async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);{const{finished:t}=R.Ay.createDialog(AM);t.then(async([t,n])=>{t&&void 0!==n&&this.setState({email:n},()=>this.doSubmit(e))})}}else this.doSubmit(e)}),(0,S.A)(this,"onEmailChange",e=>{this.setState({email:e.target.value.trim()})}),(0,S.A)(this,"onEmailValidate",e=>{this.markFieldValid(MM.Email,!!e.valid)}),(0,S.A)(this,"validateEmailRules",(0,Mx.A)({description:()=>(0,c._t)("auth|reset_password_email_field_description"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.email.identity")||!!e},invalid:()=>(0,c._t)("auth|reset_password_email_field_required_invalid")},{key:"email",test:({value:e})=>!e||sP.X(e),invalid:()=>(0,c._t)("auth|email_field_label_invalid")}]})),(0,S.A)(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),(0,S.A)(this,"onPasswordValidate",e=>{this.markFieldValid(MM.Password,!!e.valid)}),(0,S.A)(this,"onPasswordConfirmChange",e=>{this.setState({passwordConfirm:e.target.value})}),(0,S.A)(this,"onPasswordConfirmValidate",e=>{this.markFieldValid(MM.PasswordConfirm,!!e.valid)}),(0,S.A)(this,"onPhoneCountryChange",e=>{this.setState({phoneCountry:e.iso2})}),(0,S.A)(this,"onPhoneNumberChange",e=>{this.setState({phoneNumber:e.target.value})}),(0,S.A)(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(MM.PhoneNumber,!!t.valid),t}),(0,S.A)(this,"validatePhoneNumberRules",(0,Mx.A)({description:()=>(0,c._t)("auth|msisdn_field_description"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.msisdn")||!!e},invalid:()=>(0,c._t)("auth|registration_msisdn_field_required_invalid")},{key:"email",test:({value:e})=>{return!e||(t=e,yM.test(t));var t},invalid:()=>(0,c._t)("auth|msisdn_field_number_invalid")}]})),(0,S.A)(this,"onUsernameChange",e=>{this.setState({username:e.target.value})}),(0,S.A)(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(MM.Username,!!t.valid),t}),(0,S.A)(this,"validateUsernameRules",(0,Mx.A)({description:(e,t)=>t.every(({key:e,valid:t})=>"available"===e||t)?null:(0,c._t)("auth|registration_username_validation"),hideDescriptionIfValid:!0,async deriveData({value:e}){if(!e)return OM.Unknown;try{return await this.props.matrixClient.isUsernameAvailable(e)?OM.Available:OM.Unavailable}catch(e){return e instanceof i.MatrixError&&"M_INVALID_USERNAME"===e.errcode?OM.Invalid:OM.Error}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("auth|username_field_required_invalid")},{key:"safeLocalpart",test:({value:e},t)=>(!e||Ra.test(e))&&t!==OM.Invalid,invalid:()=>(0,c._t)("room_settings|general|alias_field_safe_localpart_invalid")},{key:"available",final:!0,test:async({value:e},t)=>!e||t===OM.Available,invalid:e=>e===OM.Error?(0,c._t)("auth|registration_username_unable_check"):(0,c._t)("auth|registration_username_in_use")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||""}}doSubmit(e){z.Vo.instance.setAuthenticationType("Password");const t=this.state.email.trim(),n=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});n&&(e.target.disabled=!0,n.finally(function(){e.target.disabled=!1}))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[MM.Username,MM.Password,MM.PasswordConfirm,MM.Email,MM.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}authStepIsRequired(e){return this.props.flows.every(t=>t.stages.includes(e))}authStepIsUsed(e){return this.props.flows.some(t=>t.stages.includes(e))}showEmail(){return!(d.Ay.get().disable_3pid_login||!this.authStepIsUsed("m.login.email.identity"))}showPhoneNumber(){return!(d.Ay.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}tooltipAlignment(){if(this.props.mobileRegister)return"bottom"}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?(0,c.AO)("auth|email_field_label"):(0,c.AO)("auth|registration|continue_without_email_field_label");return o.createElement(xM,{fieldRef:e=>{this[MM.Email]=e},label:e,value:this.state.email,validationRules:this.validateEmailRules.bind(this),onChange:this.onEmailChange,onValidate:this.onEmailValidate,tooltipAlignment:this.tooltipAlignment()})}renderPassword(){return o.createElement(_M.A,{id:"mx_RegistrationForm_password",fieldRef:e=>{this[MM.Password]=e},minScore:3,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate,userInputs:[this.state.username],tooltipAlignment:this.tooltipAlignment()})}renderPasswordConfirm(){return o.createElement(RM.A,{id:"mx_RegistrationForm_passwordConfirm",fieldRef:e=>{this[MM.PasswordConfirm]=e},autoComplete:"new-password",value:this.state.passwordConfirm,password:this.state.password,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate,tooltipAlignment:this.tooltipAlignment()})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=this.authStepIsRequired("m.login.msisdn")?(0,c._t)("auth|phone_label"):(0,c._t)("auth|phone_optional_label"),t=o.createElement(kM,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return o.createElement(wo.A,{ref:e=>{this[MM.PhoneNumber]=e},type:"text",label:e,value:this.state.phoneNumber,prefixComponent:t,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return o.createElement(wo.A,{id:"mx_RegistrationForm_username",ref:e=>{this[MM.Username]=e},type:"text",autoFocus:!0,label:(0,c._t)("common|username"),placeholder:(0,c._t)("common|username"),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate,tooltipAlignment:this.tooltipAlignment(),autoCorrect:"off",autoCapitalize:"none"})}render(){const e=o.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,c._t)("action|register"),disabled:!this.props.canSubmit});let t,n;return this.showEmail()&&(t=this.showPhoneNumber()?o.createElement("div",null,(0,c._t)("auth|email_help_text")," ",(0,c._t)("auth|email_phone_discovery_text")):o.createElement("div",null,(0,c._t)("auth|email_help_text")," ",(0,c._t)("auth|email_discovery_text"))),n=this.props.mobileRegister?o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword()),o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPasswordConfirm())):o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),o.createElement("div",null,o.createElement("form",{onSubmit:this.onSubmit},o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),n,o.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),t,e))}}function LM(e){const t=e.getIdentityServerUrl(!0);if(!t)throw new c.P7("settings|general|identity_server_not_set");return t}(0,S.A)(FM,"defaultProps",{onValidationChange:s.vF.error,canSubmit:!0});class UM{constructor(e){(0,S.A)(this,"sessionId",void 0),(0,S.A)(this,"submitUrl",void 0),(0,S.A)(this,"bind",!1),(0,S.A)(this,"clientSecret",void 0),(0,S.A)(this,"makeAddThreepidOnlyRequest",e=>this.matrixClient.addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:null!=e?e:void 0})),this.matrixClient=e,this.clientSecret=e.generateClientSecret()}async addEmailAddress(e){try{const t=await this.matrixClient.requestAdd3pidEmailToken(e,this.clientSecret,1);return this.sessionId=t.sid,t}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new c.P7("settings|general|email_address_in_use",{cause:e});if(e instanceof i.MatrixError&&"M_THREEPID_MEDIUM_NOT_SUPPORTED"===e.errcode)throw new c.P7("settings|general|email_adding_unsupported_by_hs",{cause:e});throw e}}async bindEmailAddress(e){var t;this.bind=!0;const n=new bI.A,r=null!==(t=await n.getAccessToken())&&void 0!==t?t:void 0;try{const t=await this.matrixClient.requestEmailToken(e,this.clientSecret,1,void 0,r);return this.sessionId=t.sid,t}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new c.P7("settings|general|email_address_in_use",{cause:e});throw e}}async addMsisdn(e,t){try{const n=await this.matrixClient.requestAdd3pidMsisdnToken(e,t,this.clientSecret,1);return this.sessionId=n.sid,this.submitUrl=n.submit_url,n}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new c.P7("settings|general|msisdn_in_use",{cause:e});if(e instanceof i.MatrixError&&"M_THREEPID_MEDIUM_NOT_SUPPORTED"===e.errcode)throw new c.P7("settings|general|msisdn_adding_unsupported_by_hs",{cause:e});if(e instanceof i.MatrixError&&"M_INVALID_PARAM"===e.errcode)throw new c.P7("settings|general|invalid_phone_number",{cause:e});throw e}}async bindMsisdn(e,t){var n;this.bind=!0;const r=new bI.A,o=null!==(n=await r.getAccessToken())&&void 0!==n?n:void 0;try{const n=await this.matrixClient.requestMsisdnToken(e,t,this.clientSecret,1,void 0,o);return this.sessionId=n.sid,n}catch(e){if(e instanceof i.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new c.P7("settings|general|msisdn_in_use",{cause:e});throw e}}async checkEmailLinkClicked(){try{if(this.bind){const e=new bI.A,t=await e.getAccessToken();if(!t)throw new c.P7("settings|general|identity_server_no_token");await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:LM(this.matrixClient),id_access_token:t})}else try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(t){var e;if(!(t instanceof i.MatrixError&&401===t.httpStatus&&null!==(e=t.data)&&void 0!==e&&e.flows))throw t;const n={[Ne.av.PHASE_PREAUTH]:{title:(0,c._t)("auth|uia|sso_title"),body:(0,c._t)("auth|uia|sso_body"),continueText:(0,c._t)("auth|sso"),continueKind:"primary"},[Ne.av.PHASE_POSTAUTH]:{title:(0,c._t)("settings|general|confirm_adding_email_title"),body:(0,c._t)("settings|general|confirm_adding_email_body"),continueText:(0,c._t)("action|confirm"),continueKind:"primary"}},{finished:r}=R.Ay.createDialog(De.A,{title:(0,c._t)("settings|general|add_email_dialog_title"),matrixClient:this.matrixClient,authData:t.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Ne.av.LOGIN_TYPE]:n,[Ne.av.UNSTABLE_LOGIN_TYPE]:n}});return r}}catch(e){if(e instanceof i.HTTPError&&401===e.httpStatus)throw new c.P7("settings|general|add_email_failed_verification",{cause:e});throw e}return[]}async haveMsisdnToken(e){const t=new bI.A;if(this.submitUrl)await this.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind)throw new c.P7("settings|general|add_msisdn_misconfigured");await this.matrixClient.submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(this.bind)return await this.matrixClient.bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:LM(this.matrixClient),id_access_token:await t.getAccessToken()}),[!0];try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(e){var n;if(!(e instanceof i.MatrixError&&401===e.httpStatus&&null!==(n=e.data)&&void 0!==n&&n.flows))throw e;const t={[Ne.av.PHASE_PREAUTH]:{title:(0,c._t)("auth|uia|sso_title"),body:(0,c._t)("settings|general|add_msisdn_confirm_sso_button"),continueText:(0,c._t)("auth|sso"),continueKind:"primary"},[Ne.av.PHASE_POSTAUTH]:{title:(0,c._t)("settings|general|add_msisdn_confirm_button"),body:(0,c._t)("settings|general|add_msisdn_confirm_body"),continueText:(0,c._t)("action|confirm"),continueKind:"primary"}},{finished:r}=R.Ay.createDialog(De.A,{title:(0,c._t)("settings|general|add_msisdn_dialog_title"),matrixClient:this.matrixClient,authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Ne.av.LOGIN_TYPE]:t,[Ne.av.UNSTABLE_LOGIN_TYPE]:t}});return r}}}var BM=function(e){return e.Display="display",e.Edit="edit",e}(BM||{});class VM extends o.Component{constructor(e){super(e),(0,S.A)(this,"value",""),(0,S.A)(this,"placeholder",!1),(0,S.A)(this,"editableDiv",(0,o.createRef)()),(0,S.A)(this,"showPlaceholder",e=>{this.editableDiv.current&&(e?(this.editableDiv.current.textContent=this.props.placeholder,this.editableDiv.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this.editableDiv.current.textContent=this.value,this.editableDiv.current.setAttribute("class",this.props.className),this.placeholder=!1))}),(0,S.A)(this,"cancelEdit",()=>{var e;this.setState({phase:BM.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),null===(e=this.editableDiv.current)||void 0===e||e.blur()}),(0,S.A)(this,"onValueChanged",e=>{var t,n;null===(t=(n=this.props).onValueChanged)||void 0===t||t.call(n,this.value,e)}),(0,S.A)(this,"onKeyDown",e=>{this.placeholder&&this.showPlaceholder(!1);if((0,uo.zM)().getAccessibilityAction(e)===Ei.bY.Enter)e.stopPropagation(),e.preventDefault()}),(0,S.A)(this,"onKeyUp",e=>{if(e.target.textContent){if(!this.placeholder){var t;this.value=null!==(t=e.target.textContent)&&void 0!==t?t:""}}else this.showPlaceholder(!0);switch((0,uo.zM)().getAccessibilityAction(e)){case Ei.bY.Escape:this.cancelEdit();break;case Ei.bY.Enter:this.onFinish(e)}}),(0,S.A)(this,"onClickDiv",()=>{this.props.editable&&this.setState({phase:BM.Edit})}),(0,S.A)(this,"onFocus",e=>{const t=e.target.childNodes[0];if(t){const n=document.createRange();n.setStart(t,0),n.setEnd(t,e.target.childNodes.length);const i=window.getSelection();i.removeAllRanges(),i.addRange(n)}}),(0,S.A)(this,"onFinish",(e,t=!1)=>{const n=this,i=(0,uo.zM)().getAccessibilityAction(e)===Ei.bY.Enter||t;this.setState({phase:BM.Display},()=>{this.value!==this.props.initialValue&&n.onValueChanged(i)})}),(0,S.A)(this,"onBlur",e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)}),this.state={phase:BM.Display}}componentDidUpdate(e){e.initialValue!==this.props.initialValue&&(this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:n,label:i,labelClassName:r}=this.props;let s;return s=!t||this.state.phase===BM.Display&&(i||r)&&!this.value?o.createElement("div",{className:e+" "+r,onClick:this.onClickDiv},i||n):o.createElement("div",{ref:this.editableDiv,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),s}}(0,S.A)(VM,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class jM extends o.Component{constructor(e){super(e),(0,S.A)(this,"addThreepid",void 0),(0,S.A)(this,"onEmailAddressChanged",e=>{this.setState({emailAddress:e})}),(0,S.A)(this,"onSubmit",()=>{const e=this.state.emailAddress;sP.X(e)?(this.addThreepid=new UM(f.J.safeGet()),this.addThreepid.addEmailAddress(e).then(()=>{const{finished:e}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("auth|set_email|verification_pending_title"),description:(0,c._t)("auth|set_email|verification_pending_description"),button:(0,c._t)("action|continue")});e.then(([e])=>this.onEmailDialogFinished(e))},t=>{this.setState({emailBusy:!1}),s.vF.error("Unable to add email address "+e+" "+t),R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|general|error_add_email"),description:(0,Ht.$)(t,(0,c._t)("invite|failed_generic"))})}),this.setState({emailBusy:!0})):R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|general|error_invalid_email"),description:(0,c._t)("settings|general|error_invalid_email_detail")})}),(0,S.A)(this,"onCancelled",()=>{this.props.onFinished(!1)}),(0,S.A)(this,"onEmailDialogFinished",e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})}),this.state={emailAddress:"",emailBusy:!1}}verifyEmailAddress(){var e;null===(e=this.addThreepid)||void 0===e||e.checkEmailLinkClicked().then(()=>{this.props.onFinished(!0)},e=>{this.setState({emailBusy:!1});let t=e;if(e instanceof c.P7&&(t=e.cause),t instanceof i.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode){const e=(0,c._t)("settings|general|error_email_verification")+" "+(0,c._t)("auth|set_email|verification_pending_description"),{finished:t}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("auth|set_email|verification_pending_title"),description:e,button:(0,c._t)("action|continue")});t.then(([e])=>this.onEmailDialogFinished(e))}else s.vF.error("Unable to verify email address: "+e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|general|error_email_verification"),description:(0,Ht.$)(e,(0,c._t)("invite|failed_generic"))})})}render(){const e=this.state.emailBusy?o.createElement(le.A,null):o.createElement(VM,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",placeholder:(0,c._t)("common|email_address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return o.createElement(X.A,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},o.createElement("div",{className:"mx_Dialog_content"},o.createElement("p",{id:"mx_Dialog_content"},(0,c._t)("auth|set_email|description")),e),o.createElement("div",{className:"mx_Dialog_buttons"},o.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:(0,c._t)("action|continue"),onClick:this.onSubmit}),o.createElement("input",{type:"submit",value:(0,c._t)("action|skip"),onClick:this.onCancelled})))}}const zM="field_old_password",HM="field_new_password",WM="field_new_password_confirm";var GM=function(e){return e.Edit="edit",e.Uploading="uploading",e.Error="error",e}(GM||{});class KM extends o.Component{constructor(e){super(e),(0,S.A)(this,zM,null),(0,S.A)(this,HM,null),(0,S.A)(this,WM,null),(0,S.A)(this,"onChangeOldPassword",e=>{this.setState({oldPassword:e.target.value})}),(0,S.A)(this,"onOldPasswordValidate",async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid(zM,t.valid),t}),(0,S.A)(this,"validateOldPasswordRules",(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("auth|change_password_empty")}]})),(0,S.A)(this,"onChangeNewPassword",e=>{this.setState({newPassword:e.target.value})}),(0,S.A)(this,"onNewPasswordValidate",e=>{this.markFieldValid(HM,e.valid)}),(0,S.A)(this,"onChangeNewPasswordConfirm",e=>{this.setState({newPasswordConfirm:e.target.value})}),(0,S.A)(this,"onNewPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid(WM,t.valid),t}),(0,S.A)(this,"validatePasswordConfirmRules",(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("auth|change_password_confirm_label")},{key:"match",test({value:e}){return!e||e===this.state.newPassword},invalid:()=>(0,c._t)("auth|change_password_confirm_invalid")}]})),(0,S.A)(this,"onClickChange",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return;const t=this.state.oldPassword,n=this.state.newPassword,i=this.state.newPasswordConfirm;try{return this.checkPassword(t,n,i),this.onChangePassword(t,n)}catch(e){e instanceof Error?this.props.onError(e):this.props.onError(new c.P7("auth|change_password_error",{error:String(e),cause:void 0}))}}),this.state={fieldValid:{},phase:GM.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}}async onChangePassword(e,t){const n=f.J.safeGet();this.changePassword(n,e,t)}changePassword(e,t,n){const i={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},password:t};this.setState({phase:GM.Uploading}),e.setPassword(i,n,!1).then(()=>{if(this.props.shouldAskForEmail)return this.optionallySetEmail().then(e=>{this.props.onFinished({didSetEmail:e})});this.props.onFinished({})},e=>{e instanceof Error?this.props.onError(e):this.props.onError(new c.P7("auth|change_password_error",{error:String(e),cause:void 0}))}).finally(()=>{this.setState({phase:GM.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})})}checkPassword(e,t,n){if(t!==n)throw new c.P7("auth|change_password_mismatch");if(!t||0===t.length)throw new c.P7("auth|change_password_empty")}optionallySetEmail(){return R.Ay.createDialog(jM,{title:(0,c._t)("auth|set_email_prompt")}).finished.then(([e])=>!!e)}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[zM,HM,WM];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case GM.Edit:return o.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},o.createElement("div",{className:e},o.createElement(wo.A,{ref:e=>{this[zM]=e},type:"password",label:(0,c._t)("auth|change_password_current_label"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),o.createElement("div",{className:e},o.createElement(_M.A,{fieldRef:e=>{this[HM]=e},type:"password",label:(0,c.AO)("auth|change_password_new_label"),minScore:3,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),o.createElement("div",{className:e},o.createElement(wo.A,{ref:e=>{this[WM]=e},type:"password",label:(0,c._t)("auth|change_password_confirm_label"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),o.createElement(ae.A,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||(0,c._t)("auth|change_password_action")));case GM.Uploading:return o.createElement("div",{className:"mx_Dialog_content"},o.createElement(le.A,null))}}}(0,S.A)(KM,"defaultProps",{onFinished(){},onError(){},confirm:!0});const qM=({mode:e,threepid:t,onChange:n,disabled:r})=>{const[a,l]=(0,o.useState)(!1),d=(0,ce.nH)(),u=(0,o.useRef)(void 0),[m,h]=(0,o.useState)(!1),[p,g]=(0,o.useState)(!1),[v,f]=(0,o.useState)(""),_=(0,o.useCallback)(e=>{e.stopPropagation(),e.preventDefault(),l(!0)},[]),y=(0,o.useCallback)(e=>{e.stopPropagation(),e.preventDefault(),l(!1)},[]),b=(0,o.useCallback)(e=>{e.stopPropagation(),e.preventDefault(),d.deleteThreePid(t.medium,t.address).then(()=>n(t)).catch(e=>{var t;s.vF.error("Unable to remove contact information: "+e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|general|error_remove_3pid"),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:(0,c._t)("invite|failed_generic")})})},[d,t,n]),E=(0,o.useCallback)(async({bind:e,label:r,errorTitle:o})=>{try{e?(u.current=new UM(d),g(!0),t.medium===i.ThreepidMedium.Email?await u.current.bindEmailAddress(t.address):await u.current.bindMsisdn(null,`+${t.address}`),g(!1),h(!0)):(await d.unbindThreePid(t.medium,t.address),n(t))}catch(e){s.vF.error(`changeBinding: Unable to ${r} email address ${t.address}`,e),h(!1),g(!1),u.current=void 0,R.Ay.createDialog(Ht.A,{title:o,description:(0,Ht.$)(e,(0,c._t)("invite|failed_generic"))})}},[d,t,n]),w=(0,o.useCallback)(e=>{e.stopPropagation(),e.preventDefault(),E({bind:!1,label:"revoke",errorTitle:"email"===t.medium?(0,c._t)("settings|general|error_revoke_email_discovery"):(0,c._t)("settings|general|error_revoke_msisdn_discovery")}).then()},[E,t.medium]),S=(0,o.useCallback)(e=>{e.stopPropagation(),e.preventDefault(),E({bind:!0,label:"share",errorTitle:"email"===t.medium?(0,c._t)("settings|general|error_share_email_discovery"):(0,c._t)("settings|general|error_share_msisdn_discovery")}).then()},[E,t.medium]),x=(0,o.useCallback)(async e=>{e.stopPropagation(),e.preventDefault(),g(!0);try{var r,o;if(t.medium===i.ThreepidMedium.Email)await(null===(r=u.current)||void 0===r?void 0:r.checkEmailLinkClicked());else await(null===(o=u.current)||void 0===o?void 0:o.haveMsisdnToken(v));h(!1),n(t),u.current=void 0}catch(e){s.vF.error("Unable to verify threepid:",e);let n=e;e instanceof c.P7&&(n=e.cause),n instanceof i.MatrixError&&"M_THREEPID_AUTH_FAILED"===n.errcode?R.Ay.createDialog(Ht.A,{title:"email"===t.medium?(0,c._t)("settings|general|email_not_verified"):(0,c._t)("settings|general|error_msisdn_verification"),description:"email"===t.medium?(0,c._t)("settings|general|email_verification_instructions"):(0,Ht.$)(e,(0,c._t)("invite|failed_generic"))}):(s.vF.error("Unable to verify email address: "+e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|general|error_email_verification"),description:(0,Ht.$)(e,(0,c._t)("invite|failed_generic"))}))}finally{g(!1)}},[v,n,t]),A=(0,o.useCallback)(e=>{f(e.target.value)},[]);return a?o.createElement("div",{className:"mx_AddRemoveThreepids_existing"},o.createElement("span",{className:"mx_AddRemoveThreepids_existing_promptText"},t.medium===i.ThreepidMedium.Email?(0,c._t)("settings|general|remove_email_prompt",{email:t.address}):(0,c._t)("settings|general|remove_msisdn_prompt",{phone:t.address})),o.createElement(ae.A,{onClick:b,kind:"danger_sm",className:"mx_AddRemoveThreepids_existing_button"},(0,c._t)("action|remove")),o.createElement(ae.A,{onClick:y,kind:"link_sm",className:"mx_AddRemoveThreepids_existing_button"},(0,c._t)("action|cancel"))):m?t.medium===i.ThreepidMedium.Email?o.createElement("div",{className:"mx_EmailAddressesPhoneNumbers_verify"},o.createElement("span",{className:"mx_EmailAddressesPhoneNumbers_verify_instructions"},(0,c._t)("settings|general|discovery_email_verification_instructions")),o.createElement(ae.A,{className:"mx_EmailAddressesPhoneNumbers_existing_button",kind:"primary_sm",onClick:x,disabled:p},(0,c._t)("action|complete"))):o.createElement("div",{className:"mx_EmailAddressesPhoneNumbers_verify"},o.createElement("span",{className:"mx_EmailAddressesPhoneNumbers_verify_instructions"},(0,c._t)("settings|general|msisdn_verification_instructions")),o.createElement("form",{onSubmit:x,autoComplete:"off",noValidate:!0},o.createElement(wo.A,{type:"text",label:(0,c._t)("settings|general|msisdn_verification_field_label"),autoComplete:"off",disabled:p,value:v,onChange:A}))):o.createElement("div",{className:"mx_AddRemoveThreepids_existing"},o.createElement("span",{className:"mx_AddRemoveThreepids_existing_address"},t.address),o.createElement(ae.A,{onClick:"hs"===e?_:t.bound?w:S,kind:"hs"===e||t.bound?"danger_sm":"primary_sm",disabled:r},"hs"===e?(0,c._t)("action|remove"):t.bound?(0,c._t)("action|revoke"):(0,c._t)("action|share")))};const $M=({medium:e,disabled:t,onChange:n})=>{const r=(0,o.useRef)(void 0),[a,l]=(0,o.useState)(""),[d,u]=(0,o.useState)(""),[m,h]=(0,o.useState)(""),[p,g]=(0,o.useState)(!1),[v,f]=(0,o.useState)(!1),[_,y]=(0,o.useState)(""),b=(0,ce.nH)(),E=(0,o.useCallback)(e=>{u(e.iso2)},[]),w=(0,o.useCallback)(t=>{var o,a;if(t.stopPropagation(),t.preventDefault(),!r.current)return;f(!0);("email"===e?null===(o=r.current)||void 0===o?void 0:o.checkEmailLinkClicked():null===(a=r.current)||void 0===a?void 0:a.haveMsisdnToken(m)).then(([e])=>{e&&(r.current=void 0,g(!1),l(""),n()),f(!1)}).catch(t=>{s.vF.error("Unable to verify 3pid: ",t),f(!1);let n=t;t instanceof c.P7&&(n=t.cause),n instanceof i.MatrixError&&"M_THREEPID_AUTH_FAILED"===n.errcode?R.Ay.createDialog(Ht.A,{title:"email"===e?(0,c._t)("settings|general|email_not_verified"):(0,c._t)("settings|general|error_msisdn_verification"),description:(0,c._t)("settings|general|email_verification_instructions")}):R.Ay.createDialog(Ht.A,{title:"email"==e?(0,c._t)("settings|general|error_email_verification"):(0,c._t)("settings|general|error_msisdn_verification"),description:(0,Ht.$)(t,(0,c._t)("invite|failed_generic"))})})},[n,e,m]),S=(0,o.useCallback)(e=>{l(e.target.value)},[]),x=(0,o.useCallback)(t=>{if(t.stopPropagation(),t.preventDefault(),!a)return;if("email"===e&&!(0,sP.X)(a))return void R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|general|error_invalid_email"),description:(0,c._t)("settings|general|error_invalid_email_detail")});r.current=new UM(b),g(!0),f(!0);("email"===e?r.current.addEmailAddress(a):r.current.addMsisdn(d,a)).then(e=>{f(!1),function(e){return void 0!==e.msisdn}(e)&&y(e.msisdn)}).catch(t=>{s.vF.error(`Unable to add threepid ${a}`,t),g(!1),f(!1),r.current=void 0,R.Ay.createDialog(Ht.A,{title:"email"===e?(0,c._t)("settings|general|error_add_email"):(0,c._t)("common|error"),description:(0,Ht.$)(t,(0,c._t)("invite|failed_generic"))})})},[b,d,a,e]),A=(0,o.useCallback)(e=>{h(e.target.value)},[]);if(p&&"email"===e)return o.createElement("div",null,o.createElement("div",null,(0,c._t)("settings|general|add_email_instructions")),o.createElement(ae.A,{onClick:w,kind:"primary",disabled:v},(0,c._t)("action|continue")));if(p)return o.createElement("div",null,o.createElement("div",null,(0,c._t)("settings|general|add_msisdn_instructions",{msisdn:_}),o.createElement("br",null)),o.createElement("form",{onSubmit:w,autoComplete:"off",noValidate:!0},o.createElement(wo.A,{type:"text",label:(0,c._t)("settings|general|msisdn_verification_field_label"),autoComplete:"off",disabled:t||v,value:m,onChange:A}),o.createElement(ae.A,{onClick:w,kind:"primary",disabled:t||v||0===m.length},(0,c._t)("action|continue"))));const C="msisdn"===e?o.createElement(kM,{onOptionChange:E,className:"mx_PhoneNumbers_country",value:d,disabled:p,isSmall:!0,showPrefix:!0}):void 0;return o.createElement("form",{onSubmit:x,autoComplete:"off",noValidate:!0},o.createElement(wo.A,{type:"text",label:"email"===e?(0,c._t)("settings|general|email_address_label"):(0,c._t)("settings|general|msisdn_label"),autoComplete:"email"===e?"email":"tel-national",disabled:t||p,value:a,onChange:S,prefixComponent:C}),o.createElement(ae.A,{onClick:x,kind:"primary",disabled:t},(0,c._t)("action|add")))},JM=({mode:e,medium:t,threepids:n,disabled:i,onChange:r,isLoading:s})=>{if(s)return o.createElement(tl.A,null);const a=n.map(t=>o.createElement(qM,{mode:e,threepid:t,onChange:r,key:t.address,disabled:i}));return o.createElement(o.Fragment,null,a,"hs"===e&&o.createElement($M,{medium:t,disabled:i,onChange:r}))},YM=({error:e,loadingState:t,children:n})=>"loading"===t?o.createElement(tl.A,null):"error"===t?o.createElement(oM,{type:"critical",title:(0,c._t)("common|error")},e):o.createElement(o.Fragment,null,n),XM=({canMake3pidChanges:e})=>{const[t,n]=(0,o.useState)(),[r,s]=(0,o.useState)(),[a,l]=(0,o.useState)("loading"),d=(0,ce.nH)(),u=(0,o.useCallback)(async()=>{try{const e=await d.getThreePids();n(e.threepids.filter(e=>e.medium===i.ThreepidMedium.Email)),s(e.threepids.filter(e=>e.medium===i.ThreepidMedium.Phone)),l("loaded")}catch{l("error")}},[d]);(0,o.useEffect)(()=>{u().then()},[u]);const m=(0,o.useCallback)(()=>{u().then()},[u]),h=(0,o.useCallback)(()=>{u().then()},[u]);return O.A.getValue(It.f.ThirdPartyID)?o.createElement("div",null,o.createElement("h2",null,(0,c._t)("settings|general|personal_info")),o.createElement(Mo.P,{heading:(0,c._t)("settings|general|emails_heading"),stretchContent:!0},o.createElement(YM,{error:(0,c._t)("settings|general|unable_to_load_emails"),loadingState:a},o.createElement(JM,{mode:"hs",medium:i.ThreepidMedium.Email,threepids:t,onChange:m,disabled:!e,isLoading:"loading"===a}))),o.createElement(Mo.P,{heading:(0,c._t)("settings|general|msisdns_heading"),stretchContent:!0},o.createElement(YM,{error:(0,c._t)("settings|general|unable_to_load_msisdns"),loadingState:a},o.createElement(JM,{mode:"hs",medium:i.ThreepidMedium.Phone,threepids:r,onChange:h,disabled:!e,isLoading:"loading"===a})))):null},QM=({canChangePassword:e,onPasswordChangeError:t,onPasswordChanged:n})=>e?o.createElement(o.Fragment,null,o.createElement(Mo.P,{heading:(0,c._t)("settings|general|account_section"),stretchContent:!0},o.createElement(Mo.s,null,(0,c._t)("settings|general|password_change_section")),o.createElement(KM,{rowClassName:"",buttonKind:"primary",onError:t,onFinished:n}))):o.createElement(o.Fragment,null),ZM=({onDeactivateClicked:e})=>o.createElement(Do.X,{heading:(0,c._t)("settings|general|deactivate_section")},o.createElement(Mo.P,{heading:(0,c._t)("settings|general|account_management_section"),description:(0,c._t)("settings|general|deactivate_warning")},o.createElement(ae.A,{onClick:e,kind:"danger"},(0,c._t)("settings|general|deactivate_section")))),eO=({closeSettingsFn:e})=>{const[t,n]=o.useState(),[r,a]=o.useState(!1),[l,d]=o.useState(!1),[u,m]=o.useState(!1),[h,p]=o.useState(!1),g=(0,ce.nH)(),v=(0,o.useContext)(as.A);(0,o.useEffect)(()=>{(async e=>{const t=null!==(e=await g.getCapabilities())&&void 0!==e?e:{},i=t["m.change_password"],r=!i||!1!==i.enabled;await v.oidcClientStore.readyPromise;const o=v.oidcClientStore.accountManagementEndpoint,s=!t["m.3pid_changes"]||!0===t["m.3pid_changes"].enabled,l=!t["m.set_displayname"]||!0===t["m.set_displayname"].enabled,c=!t["m.set_avatar_url"]||!0===t["m.set_avatar_url"].enabled;a(s),d(l),m(c),n(o),p(r)})()},[g,v.oidcClientStore]);const f=(0,o.useCallback)(e=>{s.vF.error("Failed to change password: "+e);let t=e;e instanceof c.P7&&e.cause instanceof Error&&(t=e.cause);const n=(0,Ht.$)(e,(0,c._t)("settings|general|error_password_change_unknown",{stringifiedError:String(e)}));let r=n;t instanceof i.HTTPError&&403===t.httpStatus?r=(0,c._t)("settings|general|error_password_change_403"):t instanceof i.HTTPError&&(r=(0,c._t)("settings|general|error_password_change_http",{errorMessage:n,httpStatus:t.httpStatus})),R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|general|error_password_change_title"),description:r})},[]),_=(0,o.useCallback)(()=>{const e=(0,c._t)("settings|general|password_change_success");R.Ay.createDialog(Ht.A,{title:(0,c._t)("common|success"),description:e})},[]),y=(0,o.useCallback)(()=>{const{finished:t}=R.Ay.createDialog(fM);t.then(([t])=>{t&&e()})},[e]);let b;const E=Boolean(t);return O.A.getValue(It.f.Deactivate)&&!E&&(b=o.createElement(ZM,{onDeactivateClicked:y})),o.createElement(No.A,null,o.createElement(Do.X,null,o.createElement(gM,{externalAccountManagementUrl:t,canSetDisplayName:l,canSetAvatar:u}),(!E||r)&&o.createElement(XM,{canMake3pidChanges:r}),o.createElement(QM,{canChangePassword:h,onPasswordChanged:_,onPasswordChangeError:f})),b)};var tO=n("./src/components/views/elements/SettingsFlag.tsx"),nO=n("./src/utils/maps.ts");const iO=()=>d.Ay.get("show_labs_settings")||O.A.getValue("developerMode");class rO extends o.Component{constructor(e){super(e),(0,S.A)(this,"labs",void 0),(0,S.A)(this,"betas",void 0);const t=O.A.getFeatureSettingNames(),[n,i]=t.reduce((e,t)=>(e[O.A.getBetaInfo(t)?1:0].push(t),e),[[],[]]);this.labs=n,this.betas=i,iO()||(this.labs=[])}render(){let e,t;if(this.betas.length&&(e=o.createElement(o.Fragment,null,this.betas.map(e=>o.createElement(Xa.A,{key:e,featureId:e})))),this.labs.length){const e=new nO.h;this.labs.forEach(t=>{e.getOrCreate(O.A.getLabGroup(t),[]).push(o.createElement(tO.A,{level:F.p.DEVICE,name:t,key:t}))}),e.getOrCreate(yx.$q.Experimental,[]).push(o.createElement(tO.A,{key:"lowBandwidth",name:"lowBandwidth",level:F.p.DEVICE})),e.getOrCreate(yx.$q.Analytics,[]).push(o.createElement(tO.A,{key:"automaticErrorReporting",name:"automaticErrorReporting",level:F.p.DEVICE}),o.createElement(tO.A,{key:"automaticDecryptionErrorReporting",name:"automaticDecryptionErrorReporting",level:F.p.DEVICE})),t=o.createElement(o.Fragment,null,(0,Li.sortBy)(Array.from(e.entries()),"0").map(([e,t])=>o.createElement(Mo.P,{key:e,heading:(0,c._t)(yx.B2[e])},t)))}return o.createElement(No.A,null,o.createElement(Do.X,{heading:(0,c._t)("labs|beta_section")},o.createElement(Mo.s,null,(0,c._t)("labs|beta_description",{brand:d.Ay.get("brand")})),e),t&&o.createElement(Do.X,{heading:(0,c._t)("labs|experimental_section")},o.createElement(Mo.s,null,(0,c._t)("labs|experimental_description",{},{a:e=>o.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),t))}}var oO=n("./node_modules/@vector-im/compound-web/dist/components/Form/InlineField.js");class sO extends o.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent({message:e}){const t={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:i.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:i.MsgType.Text,body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},n=new i.MatrixEvent(t);return n.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:(...e)=>en.r4({avatarUrl:this.props.avatarUrl},32,32,"crop"),getMxcAvatarUrl:()=>this.props.avatarUrl},n}render(){const e=me()(this.props.className,{mx_IRCLayout:this.props.layout==Zt.P.IRC,mx_EventTilePreview_loader:!this.props.userId});if(!this.props.userId)return o.createElement("div",{className:e},o.createElement(le.A,null));const t=this.fakeEvent(this.state);return o.createElement("div",{className:e,role:"presentation"},o.createElement($r,{mxEvent:t,layout:this.props.layout,as:"div",hideTimestamp:!0,inhibitInteraction:!0}))}}function aO(){return o.createElement(Mo.P,{heading:(0,c._t)("common|message_layout"),legacy:!1},o.createElement(lO,null),o.createElement(dO,null))}function lO(){return o.createElement(AS.b,{className:"mx_LayoutSwitcher_LayoutSelector",onChange:async e=>{const t=new FormData(e.currentTarget).get("layout");await O.A.setValue("layout",null,F.p.DEVICE,t)}},o.createElement(cO,{layout:Zt.P.Group,label:(0,c._t)("common|modern")}),o.createElement(cO,{layout:Zt.P.Bubble,label:(0,c._t)("settings|appearance|layout_bubbles")}),o.createElement(cO,{layout:Zt.P.IRC,label:(0,c._t)("settings|appearance|layout_irc")}))}function cO({layout:e,label:t}){const n=(0,Qt.ti)("layout"),i=function(){const e=(0,ce.nH)(),t=e.getSafeUserId(),[n,i]=(0,o.useState)({userId:t});return(0,o.useEffect)(()=>{(async()=>{const n=await e.getProfileInfo(t);i({userId:t,displayName:n.displayname,avatarUrl:n.avatar_url})})()},[t,e,i]),n}();return o.createElement(IS.D,{name:"layout",className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio"},o.createElement(TS.J,{"aria-label":t},o.createElement("div",{className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_inline"},o.createElement(Pv.b,{name:"layout",value:e,defaultChecked:n===e}),o.createElement("span",null,t)),o.createElement("hr",{className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_separator"}),o.createElement(sO,(0,tn.A)({message:(0,c._t)("common|preview_message"),layout:e,className:"mxLayoutSwitcher_LayoutSelector_LayoutRadio_EventTilePreview"},i))))}function dO(){const e=(0,Qt.ti)("useCompactLayout"),t=(0,Qt.ti)("layout");return o.createElement(AS.b,{onChange:async e=>{const t="on"===new FormData(e.currentTarget).get("compactLayout");await O.A.setValue("useCompactLayout",null,F.p.DEVICE,t)}},o.createElement(oO.I,{name:"compactLayout",control:o.createElement(rf,{disabled:t!==Zt.P.Group,name:"compactLayout",defaultChecked:e})},o.createElement(TS.J,null,(0,c._t)("settings|appearance|compact_layout")),o.createElement(VA.po,null,(0,c._t)("settings|appearance|compact_layout_description"))))}class uO extends o.Component{constructor(e){super(e),(0,S.A)(this,"MESSAGE_PREVIEW_TEXT",(0,c._t)("common|preview_message")),(0,S.A)(this,"sizes",[9,10,11,12,13,14,15,16,17,18,20,22,24,26,28,30,32,34,36]),(0,S.A)(this,"layoutWatcherRef",void 0),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"onFontSizeChanged",async e=>{const t=parseInt(e,10)||0;this.setState({fontSizeDelta:t}),await O.A.setValue("fontSizeDelta",null,F.p.DEVICE,t)}),(0,S.A)(this,"computeDeltaFontSize",e=>e-this.state.browserFontSize),this.state={fontSizeDelta:O.A.getValue("fontSizeDelta",null),browserFontSize:Pa.g.getBrowserDefaultFontSize(),useCustomFontSize:O.A.getValue("useCustomFontSize"),layout:O.A.getValue("layout")}}async componentDidMount(){this.unmounted=!1;const e=f.J.safeGet(),t=e.getSafeUserId(),n=await e.getProfileInfo(t);this.layoutWatcherRef=O.A.watchSetting("layout",null,()=>{const e=O.A.getValue("layout");this.state.layout!==e&&this.setState({layout:e})}),this.unmounted||this.setState({userId:t,displayName:n.displayname,avatarUrl:n.avatar_url})}componentWillUnmount(){this.unmounted=!0,O.A.unwatchSetting(this.layoutWatcherRef)}render(){return o.createElement(Mo.P,{heading:(0,c._t)("settings|appearance|font_size"),stretchContent:!0},o.createElement(wo.A,{element:"select",className:"mx_FontScalingPanel_Dropdown",label:(0,c._t)("settings|appearance|font_size"),value:this.state.fontSizeDelta.toString(),onChange:e=>this.onFontSizeChanged(e.target.value)},this.sizes.map(e=>o.createElement("option",{key:e,value:this.computeDeltaFontSize(e)},e===this.state.browserFontSize?(0,c._t)("settings|appearance|font_size_default",{fontSize:e}):e))),o.createElement(sO,{className:"mx_FontScalingPanel_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:this.state.layout,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}))}}function mO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function hO(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?mO(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):mO(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function pO(){const e=Lp(),t=(0,o.useMemo)(()=>new Ta.A,[]),n=(0,Qt.ti)("feature_custom_themes");return o.createElement(Mo.P,{heading:(0,c._t)("common|theme"),legacy:!1},t.isSystemThemeSupported()&&o.createElement(gO,{systemThemeActivated:e.systemThemeActivated}),o.createElement(vO,{theme:e.theme,disabled:e.systemThemeActivated}),n&&o.createElement(fO,{theme:e.theme}))}function gO({systemThemeActivated:e}){return o.createElement(AS.b,{onChange:async e=>{const t="on"===new FormData(e.currentTarget).get("systemTheme");await O.A.setValue("use_system_theme",null,F.p.DEVICE,t),x.A.dispatch({action:W.r.RecheckTheme})}},o.createElement(oO.I,{name:"systemTheme",control:o.createElement(rf,{name:"systemTheme",defaultChecked:e})},o.createElement(TS.J,null,O.A.getDisplayName("use_system_theme"))))}function vO({theme:e,disabled:t}){const n=function(){const e=(0,Qt.ti)("custom_themes");return(0,o.useMemo)(()=>{const t=(e||[]).reduce((e,t)=>e.set(t.name,t),new Map),n=(0,Op.E0)(),i=n.filter(e=>!t.has(e.name)),r=n.filter(e=>t.has(e.name)),o=function(){const e=(0,Op.TJ)("light");if(e)return{name:(0,c._t)("settings|appearance|high_contrast"),id:e}}();o&&i.push(o);return i.concat(r).map(e=>{const n=t.get(e.name),i=(n?n.is_dark:e.id.includes("dark"))||!1;return hO(hO({},e),{},{isDark:i})})},[e])}();return o.createElement(AS.b,{className:"mx_ThemeChoicePanel_ThemeSelectors",onChange:async t=>{const n=new FormData(t.currentTarget).get("themeSelector");n&&e!==n&&(O.A.setValue("theme",null,F.p.DEVICE,n).catch(()=>{x.A.dispatch({action:W.r.RecheckTheme})}),x.A.dispatch({action:W.r.RecheckTheme,forceTheme:n}))}},n.map(n=>{const i=e===n.id;return o.createElement(oO.I,{className:me()("mx_ThemeChoicePanel_themeSelector",{mx_ThemeChoicePanel_themeSelector_enabled:!t&&e===n.id,mx_ThemeChoicePanel_themeSelector_disabled:t,"cpd-theme-light":!n.isDark,"cpd-theme-dark":n.isDark}),name:"themeSelector",key:n.id,control:o.createElement(Pv.b,{name:"themeSelector",checked:!t&&i,disabled:t,value:n.id})},o.createElement(TS.J,{className:"mx_ThemeChoicePanel_themeSelector_Label"},n.name))}))}function fO({theme:e}){const[t,n]=(0,o.useState)(""),[i,r]=(0,o.useState)(),a=(0,o.useCallback)(()=>{r(void 0),n("")},[r,n]);return o.createElement("div",{className:"mx_ThemeChoicePanel_CustomTheme"},o.createElement(QD.d,{className:"mx_ThemeChoicePanel_CustomTheme_EditInPlace",label:(0,c._t)("settings|appearance|custom_theme_add"),cancelButtonLabel:(0,c._t)("action|cancel"),saveButtonLabel:(0,c._t)("settings|appearance|custom_theme_add"),savingLabel:(0,c._t)("settings|appearance|custom_theme_downloading"),value:t,onChange:e=>{r(void 0),n(e.target.value)},onSave:async()=>{if(!t)return;const e=O.A.getValue("custom_themes").map(e=>e)||[];try{const n=await fetch(t),i=await n.json();if(!i||"string"!=typeof i.name||"object"!=typeof i.colors)return void r((0,c._t)("settings|appearance|custom_theme_invalid"));if(Boolean(e.find(e=>e.name===i.name)))return void a();e.push(i)}catch(e){return s.vF.error(e),void r((0,c._t)("settings|appearance|custom_theme_error_downloading"))}a(),await O.A.setValue("custom_themes",null,F.p.ACCOUNT,e)},onCancel:a},o.createElement(VA.po,null,(0,c._t)("settings|appearance|custom_theme_help")),i&&o.createElement(VA.Kw,null,i)),o.createElement(_O,{theme:e}))}function _O({theme:e}){const t=(0,Qt.ti)("custom_themes")||[];return o.createElement("ul",{className:"mx_ThemeChoicePanel_CustomThemeList"},t.map(t=>o.createElement("li",{key:t.name,className:"mx_ThemeChoicePanel_CustomThemeList_theme","aria-label":t.name},o.createElement("span",{className:"mx_ThemeChoicePanel_CustomThemeList_name"},t.name),o.createElement(rg.K,{destructive:!0,"aria-label":(0,c._t)("action|delete"),tooltip:(0,c._t)("action|delete"),onClick:async()=>{const n=(O.A.getValue("custom_themes").map(e=>e)||[]).filter(e=>e.name!==t.name);await O.A.setValue("custom_themes",null,F.p.ACCOUNT,n),e===`custom-${t.name}`&&(await O.A.setValue("theme",null,F.p.DEVICE,null),x.A.dispatch({action:W.r.RecheckTheme}))}},o.createElement(Wn.A,null)))))}var yO=n("./src/settings/enums/ImageSize.ts");class bO extends o.Component{constructor(e){super(e),(0,S.A)(this,"onSizeChange",e=>{const t=e.target.value;this.setState({size:t}),O.A.setValue("Images.size",null,F.p.ACCOUNT,t)}),this.state={size:O.A.getValue("Images.size")}}render(){return o.createElement(Mo.P,{heading:(0,c._t)("settings|appearance|timeline_image_size")},o.createElement("div",{className:"mx_ImageSizePanel_radios"},o.createElement("label",null,o.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeDefault"}),o.createElement(Eo.A,{name:"image_size",value:yO.h.Normal,checked:this.state.size===yO.h.Normal,onChange:this.onSizeChange},(0,c._t)("settings|appearance|image_size_default"))),o.createElement("label",null,o.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeLarge"}),o.createElement(Eo.A,{name:"image_size",value:yO.h.Large,checked:this.state.size===yO.h.Large,onChange:this.onSizeChange},(0,c._t)("settings|appearance|image_size_large")))))}}class EO extends o.Component{constructor(e){super(e),this.state={useBundledEmojiFont:O.A.getValue("useBundledEmojiFont"),useSystemFont:O.A.getValue("useSystemFont"),systemFont:O.A.getValue("systemFont"),showAdvanced:!1}}renderAdvancedSection(){if(!O.A.getValue(It.f.AdvancedSettings))return null;const e=d.Ay.get().brand,t=o.createElement(ae.A,{kind:"link",onClick:()=>this.setState({showAdvanced:!this.state.showAdvanced}),"aria-expanded":this.state.showAdvanced},this.state.showAdvanced?(0,c._t)("action|hide_advanced"):(0,c._t)("action|show_advanced"));let n;if(this.state.showAdvanced){const t=(0,c._t)("settings|appearance|custom_font_description",{brand:e});n=o.createElement(o.Fragment,null,o.createElement(tO.A,{name:"useCompactLayout",level:F.p.DEVICE,useCheckbox:!0}),o.createElement(tO.A,{name:"useBundledEmojiFont",level:F.p.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useBundledEmojiFont:e})}),o.createElement(tO.A,{name:"useSystemFont",level:F.p.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),o.createElement(wo.A,{className:"mx_AppearanceUserSettingsTab_checkboxControlledField",label:O.A.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),O.A.setValue("systemFont",null,F.p.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont}))}return o.createElement(Mo.P,null,t,n)}render(){return o.createElement(No.A,null,o.createElement(Do.X,null,o.createElement(pO,null),o.createElement(aO,null),o.createElement(uO,null),this.renderAdvancedSection(),o.createElement(bO,null)))}}class wO extends o.PureComponent{render(){return o.createElement(X.A,{hasCancel:!0,onFinished:this.props.onFinished.bind(null,!1),title:(0,c._t)("seshat|reset_title")},o.createElement("div",null,o.createElement("p",null,(0,c._t)("seshat|reset_description"),o.createElement("br",null),(0,c._t)("seshat|reset_explainer"))),o.createElement(Kt.A,{primaryButton:(0,c._t)("seshat|reset_button"),onPrimaryButtonClick:this.props.onFinished.bind(null,!0),primaryButtonClass:"danger",cancelButton:(0,c._t)("action|cancel"),onCancel:this.props.onFinished.bind(null,!1)}))}}class SO extends o.Component{constructor(e){super(e),(0,S.A)(this,"updateCurrentRoom",async()=>{const e=y.A.get(),t=await(null==e?void 0:e.getStats().catch(()=>{}));t&&this.setState({eventIndexSize:t.size,roomCount:t.roomCount})}),(0,S.A)(this,"onManage",async()=>{R.Ay.createDialog((0,o.lazy)(()=>n.e(797).then(n.bind(n,"./src/async-components/views/dialogs/eventindex/ManageEventIndexDialog.tsx"))),{onFinished:()=>{}},void 0,!1,!0)}),(0,S.A)(this,"onEnable",async()=>{var e,t;this.setState({enabling:!0}),await y.A.initEventIndex(),await(null===(e=y.A.get())||void 0===e?void 0:e.addInitialCheckpoints()),null===(t=y.A.get())||void 0===t||t.startCrawler(),await O.A.setValue("enableEventIndexing",null,F.p.DEVICE,!0),await this.updateState()}),(0,S.A)(this,"confirmEventStoreReset",()=>{const{finished:e,close:t}=R.Ay.createDialog(wO);e.then(async([e])=>{e&&(await O.A.setValue("enableEventIndexing",null,F.p.DEVICE,!1),await y.A.deleteEventIndex(),await this.onEnable(),t())})}),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:O.A.getValueAt(F.p.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=y.A.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}componentDidMount(){this.updateState()}async updateState(){const e=y.A.get(),t=O.A.getValueAt(F.p.DEVICE,"enableEventIndexing");let n=0,i=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);const t=await e.getStats().catch(()=>{});t&&(n=t.size,i=t.roomCount)}this.setState({enabling:!1,eventIndexSize:n,roomCount:i,eventIndexingEnabled:t})}render(){let e;const t=d.Ay.get().brand;if(null!==y.A.get())e=o.createElement(o.Fragment,null,o.createElement(Mo.s,null,(0,c._t)("settings|security|message_search_enabled",{size:(0,sn.z3)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:(0,sn.Zl)(this.state.roomCount)})),o.createElement(ae.A,{kind:"primary",onClick:this.onManage},(0,c._t)("action|manage")));else if(!this.state.eventIndexingEnabled&&y.A.supportIsInstalled())e=o.createElement(o.Fragment,null,o.createElement(Mo.s,null,(0,c._t)("settings|security|message_search_disabled")),o.createElement("div",null,o.createElement(ae.A,{kind:"primary",disabled:this.state.enabling,onClick:this.onEnable},(0,c._t)("action|enable")),this.state.enabling?o.createElement(tl.A,null):o.createElement("div",null)));else if(y.A.platformHasSupport()&&!y.A.supportIsInstalled()){const n="https://github.com/vector-im/element-desktop/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=o.createElement(Mo.s,null,(0,c._t)("settings|security|message_search_unsupported",{brand:t},{nativeLink:e=>o.createElement(Hp.A,{href:n,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=y.A.platformHasSupport()?o.createElement(o.Fragment,null,o.createElement(Mo.s,null,this.state.enabling?o.createElement(tl.A,null):(0,c._t)("settings|security|message_search_failed")),y.A.error?o.createElement(Mo.s,null,o.createElement("details",null,o.createElement("summary",null,(0,c._t)("common|advanced")),o.createElement("code",null,y.A.error instanceof Error?y.A.error.message:(0,c._t)("error|unknown")),o.createElement("p",null,o.createElement(ae.A,{key:"delete",kind:"danger",onClick:this.confirmEventStoreReset},(0,c._t)("action|reset"))))):void 0):o.createElement(Mo.s,null,(0,c._t)("settings|security|message_search_unsupported_web",{brand:t},{desktopLink:e=>o.createElement(Hp.A,{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}}function xO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function AO(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xO(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xO(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const CO=(e,t)=>{const{name:n,version:i,url:r}=Rt(e,t.device_id);return{appName:n,appVersion:i,url:r}};let kO=function(e){return e.Unsupported="Unsupported",e.Default="Default",e}({});const RO=()=>{var e;const t=(0,o.useContext)(as.A).client,n=t.getDeviceId(),r=t.getSafeUserId(),[a,l]=(0,o.useState)({}),[d,u]=(0,o.useState)(void 0),[m,h]=(0,o.useState)([]),[p,g]=(0,o.useState)(new Map),[v,f]=(0,o.useState)(!0),[_,y]=(0,o.useState)(!0),[b,E]=(0,o.useState)();(0,o.useEffect)(()=>{t.doesServerSupportUnstableFeature("org.matrix.msc3881").then(e=>{y(e)})},[t]);const w=(0,o.useCallback)(async()=>{f(!0);try{var e,n;const o=await async function(e){const{devices:t}=await e.getDevices(),n={};for(const r of t)n[r.device_id]=AO(AO(AO({},r),{},{isVerified:await rt(e,r.device_id)},CO(e,r)),(0,st.y)(r[i.UNSTABLE_MSC3852_LAST_SEEN_UA.name]));return n}(t);l(o);const{pushers:s}=await t.getPushers();h(s);const a=new Map;Object.keys(o).forEach(e=>{const n=`${i.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${e}`,r=t.getAccountData(n);r&&a.set(e,r.getContent())}),g(a);const c=t.getUserId(),d=null===(e=await(null===(n=t.getCrypto())||void 0===n?void 0:n.getUserDeviceInfo([c])))||void 0===e?void 0:e.get(c),m=[];for(const e of null!==(r=null==d?void 0:d.values())&&void 0!==r?r:[]){var r;e.dehydrated&&m.push(e.deviceId)}u(1==m.length?m[0]:void 0),f(!1)}catch(e){404==e.httpStatus?E(kO.Unsupported):(s.vF.error("Error loading sessions:",e),E(kO.Default)),f(!1)}},[t]);(0,o.useEffect)(()=>{w()},[w]),(0,o.useEffect)(()=>{const e=Object.keys(a);e.length&&((e,t)=>{Array.from(t.store.accountData.values()).forEach(n=>{if(!n.getType().startsWith(xt))return;const[,i]=n.getType().split(xt);i&&!e.includes(i)&&t.deleteAccountData(n.getType())})})(e,t)},[a,t]),(0,lr.ml)(t,V.cr.DevicesUpdated,e=>{e.includes(r)&&w()}),(0,lr.ml)(t,i.ClientEvent.AccountData,e=>{const t=e.getType();if(t.startsWith(i.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name)){const n=new Map(p),i=t.slice(t.lastIndexOf(".")+1);n.set(i,e.getContent()),g(n)}});const S=!(null===(e=a[n])||void 0===e||!e.isVerified)&&r?async e=>await t.getCrypto().requestDeviceVerification(r,e):void 0,x=(0,o.useCallback)(async(e,n)=>{const i=a[e];if(n!==(null==i?void 0:i.display_name))try{await t.setDeviceDetails(e,{display_name:n}),await w()}catch(e){throw s.vF.error("Error setting device name",e),new Error((0,c._t)("settings|sessions|error_set_name"))}},[t,a,w]),A=(0,o.useCallback)(async(e,n)=>{try{const r=m.find(t=>t[i.PUSHER_DEVICE_ID.name]===e);r?await t.setPusher(AO(AO({},r),{},{[i.PUSHER_ENABLED.name]:n})):p.has(e)&&await t.setLocalNotificationSettings(e,{is_silenced:!n})}catch(e){throw s.vF.error("Error setting pusher state",e),new Error((0,c._t)("settings|sessions|error_pusher_state"))}finally{await w()}},[t,m,p,w]);return{devices:a,dehydratedDeviceId:d,pushers:m,localNotificationSettings:p,currentDeviceId:n,isLoadingDeviceList:v,error:b,requestDeviceVerification:S,refreshDevices:w,saveDeviceName:x,setPushNotifications:A,supportsMSC3881:_}};async function IO(e,t){const n=e.getUserId();let{threepids:r}=await e.getThreePids();if(t&&(r=r.filter(e=>e.medium===t)),r.length>0&&e.getIdentityServerUrl())try{const i=new bI.A,o=await i.getAccessToken({check:!1});if(!o)throw new Error("No identity access token found");const s=r.map(({medium:e,address:t})=>[e,t]),a=await e.bulkLookupThreePids(s,o);for(const[e,i,o]of a.threepids){if(o!==n)continue;if(t&&e!==t)continue;const s=r.find(t=>t.medium===e&&t.address===i);s&&(s.bound=!0)}}catch(e){if(!(e instanceof i.MatrixError)||"M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return r}var TO=n("./src/utils/IdentityServerUtils.ts");class PO extends o.Component{constructor(e){super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"onAction",e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:f.J.safeGet().getIdentityServerUrl()})}),(0,S.A)(this,"onIdentityServerChanged",e=>{const t=e.target.value;this.setState({idServer:t,error:void 0})}),(0,S.A)(this,"saveIdServer",e=>{f.J.safeGet().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:void 0,currentClientIdServer:e,idServer:e})}),(0,S.A)(this,"checkIdServer",async e=>{e.preventDefault();const{idServer:t,currentClientIdServer:n}=this.state;this.setState({busy:!0,checking:!0,error:void 0});const i=(0,mC.qe)(t);let r=await async function(e){if("https:"!==(0,mC.Dl)(e).protocol)return(0,c._t)("identity_server|url_not_https");try{const t=await fetch(e+"/_matrix/identity/v2");return t.ok?null:t.status<200||t.status>=300?(0,c._t)("identity_server|error_invalid",{code:t.status}):(0,c._t)("identity_server|error_connection")}catch{return(0,c._t)("identity_server|error_connection")}}(i);if(!r)try{this.setState({checking:!1});const e=new bI.A(i);await e.getAccessToken();let r=!0;if(!await(0,TO.mn)(f.J.safeGet(),i)){const[e]=await this.showNoTermsWarning();r=!!e}if(r&&n&&i!==n){const[e]=await this.showServerChangeWarning({title:(0,c._t)("identity_server|change"),unboundMessage:(0,c._t)("identity_server|change_prompt",{},{current:e=>o.createElement("strong",null,(0,mC.FO)(n)),new:e=>o.createElement("strong",null,(0,mC.FO)(t))}),button:(0,c._t)("action|continue")});r=!!e}r&&this.saveIdServer(i)}catch(e){s.vF.error(e),r=(0,c._t)("identity_server|error_invalid_or_terms")}this.setState({busy:!1,checking:!1,error:null!=r?r:void 0,currentClientIdServer:f.J.safeGet().getIdentityServerUrl()})}),(0,S.A)(this,"onDisconnectClicked",async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this.showServerChangeWarning({title:(0,c._t)("identity_server|disconnect"),unboundMessage:(0,c._t)("identity_server|disconnect_server",{},{idserver:e=>o.createElement("strong",null,(0,mC.FO)(this.state.currentClientIdServer))}),button:(0,c._t)("action|disconnect")});e&&this.disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}}),(0,S.A)(this,"disconnectIdServer",()=>{f.J.safeGet().setAccountData("m.identity_server",{base_url:null});let e="";(0,TO.iR)()&&(e=(0,mC.FO)((0,TO.iR)())),this.setState({busy:!1,error:void 0,currentClientIdServer:f.J.safeGet().getIdentityServerUrl(),idServer:e})}),(0,S.A)(this,"onInputCancel",()=>this.setState(e=>{var t;return{idServer:null!==(t=e.currentClientIdServer)&&void 0!==t?t:""}})),(0,S.A)(this,"onClearServerErrors",()=>this.setState({error:void 0}));let t="";!f.J.safeGet().getIdentityServerUrl()&&(0,TO.iR)()&&(t=(0,mC.FO)((0,TO.iR)()));const n=f.J.safeGet().getIdentityServerUrl();this.state={defaultIdServer:t,currentClientIdServer:n,idServer:null!=n?n:"",busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=x.A.register(this.onAction)}componentWillUnmount(){x.A.unregister(this.dispatcherRef)}showNoTermsWarning(){const{finished:e}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("terms|identity_server_no_terms_title"),description:o.createElement("div",null,o.createElement("strong",{className:"warning"},(0,c._t)("identity_server|no_terms")),o.createElement("span",null,"",(0,c._t)("terms|identity_server_no_terms_description_2"))),button:(0,c._t)("action|continue")});return e}async showServerChangeWarning({title:e,unboundMessage:t,button:n}){const{currentClientIdServer:i}=this.state;let r=[],a=!0;try{r=await(0,HA.wR)(IO(f.J.safeGet()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){a=!1,s.vF.warn(`Unable to reach identity server at ${i} to check for 3PIDs during IS change flow`),s.vF.warn(e)}const l=r.filter(e=>e.bound);let d,u=!1;const m={idserver:e=>o.createElement("strong",null,(0,mC.FO)(i)),b:e=>o.createElement("strong",null,e)};a?l.length?(d=o.createElement("div",null,o.createElement("p",null,(0,c._t)("identity_server|disconnect_personal_data_warning_1",{},m)),o.createElement("p",null,(0,c._t)("identity_server|disconnect_personal_data_warning_2"))),u=!0,n=(0,c._t)("identity_server|disconnect_anyway")):d=t:(d=o.createElement("div",null,o.createElement("p",null,(0,c._t)("identity_server|disconnect_offline_warning",{},m)),o.createElement("p",null,(0,c._t)("identity_server|suggestions")),o.createElement("ul",null,o.createElement("li",null,(0,c._t)("identity_server|suggestions_1")),o.createElement("li",null,(0,c._t)("identity_server|suggestions_2",{},{idserver:m.idserver})),o.createElement("li",null,(0,c._t)("identity_server|suggestions_3")))),u=!0,n=(0,c._t)("identity_server|disconnect_anyway"));const{finished:h}=R.Ay.createDialog(Wt.A,{title:e,description:d,button:n,cancelButton:(0,c._t)("action|go_back"),danger:u});return h}render(){const e=this.state.currentClientIdServer;let t,n,i;if(e?(t=(0,c._t)("identity_server|url",{server:(0,mC.FO)(e)}),n=(0,c._t)("identity_server|description_connected",{},{server:()=>o.createElement("strong",null,(0,mC.FO)(e))}),this.props.missingTerms&&(n=(0,c._t)("identity_server|change_server_prompt",{},{server:()=>o.createElement("strong",null,(0,mC.FO)(e))}))):(t=(0,c._t)("common|identity_server"),n=(0,c._t)("identity_server|description_disconnected")),e){let e=(0,c._t)("action|disconnect"),t=(0,c._t)("identity_server|disconnect_warning");this.props.missingTerms&&(t=(0,c._t)("identity_server|description_optional"),e=(0,c._t)("identity_server|do_not_use")),this.state.disconnectBusy&&(e=o.createElement(tl.A,null)),i=o.createElement(o.Fragment,null,o.createElement(Mo.s,null,t),o.createElement(ae.A,{onClick:this.onDisconnectClicked,kind:"danger_sm"},e))}return o.createElement(Yo.A,{legend:t,description:n},o.createElement(QD.d,{className:"mx_IdentityServerPicker",cancelButtonLabel:(0,c._t)("action|reset"),disabled:!!this.state.busy,label:(0,c._t)("identity_server|url_field_label"),onCancel:this.onInputCancel,onChange:this.onIdentityServerChanged,onClearServerErrors:this.onClearServerErrors,onSave:this.checkIdServer,placeholder:this.state.defaultIdServer,saveButtonLabel:(0,c._t)("action|change"),savedLabel:this.state.error?void 0:(0,c._t)("identity_server|changed"),savingLabel:(0,c._t)("identity_server|checking"),serverInvalid:!!this.state.error,value:this.state.idServer},this.state.error&&o.createElement(VA.Kw,null,this.state.error)),i)}}var NO=n("./src/Terms.ts");class DO extends o.Component{constructor(e){super(e),(0,S.A)(this,"togglePolicy",e=>{const t=(0,Dn.ZV)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})}),(0,S.A)(this,"onContinue",()=>{!!this.state.policies.some(e=>!e.checked)||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map(e=>e.url)))}),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const n=Object.values(t.policies);for(const t of n){const n=(0,NO.S$)(t);if(!n)continue;const i={checked:!1,url:n.url,name:n.name};e.push(i)}}this.setState({policies:e})}renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const n=this.state.policies[t],i=(0,c._t)("terms|inline_intro_text",{},{policyLink:()=>o.createElement("a",{href:n.url,rel:"noreferrer noopener",target:"_blank"},n.name,o.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(o.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},o.createElement("div",null,i),o.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},o.createElement(Io.A,{onChange:()=>this.togglePolicy(t),checked:n.checked},(0,c._t)("action|accept")))))}return e}render(){const e=!!this.state.policies.some(e=>!e.checked);return o.createElement("div",null,this.props.introElement,this.renderCheckboxes(),o.createElement(ae.A,{onClick:this.onContinue,disabled:e||this.state.busy,kind:"primary_sm"},(0,c._t)("action|continue")))}}const MO=()=>{const e=(0,ce.nH)(),[t,n]=(0,o.useState)(!0),[r,a]=(0,o.useState)([]),[l,d]=(0,o.useState)([]),[u,m]=(0,o.useState)((0,mC.FO)(e.getIdentityServerUrl())),[h,p]=(0,o.useState)({policiesAndServices:null,agreedUrls:null,resolve:null}),[g,v]=(0,o.useState)(!1),f=(0,o.useCallback)(async()=>{n(!0);const t=await IO(e);a(t.filter(e=>e.medium===i.ThreepidMedium.Email)),d(t.filter(e=>e.medium===i.ThreepidMedium.Phone)),n(!1)},[e]);if((0,Lo.F)(x.A,(0,o.useCallback)(t=>{"id_server_changed"===t.action&&(m((0,mC.FO)(e.getIdentityServerUrl())),f().then())},[e,f])),(0,o.useEffect)(()=>{(async()=>{try{await f();const t=e.getIdentityServerUrl();if(!t)return;const n=new bI.A;try{const r=await n.getAccessToken({check:!1});await(0,NO.gw)(e,[new NO.kl(i.SERVICE_TYPES.IS,t,r)],(e,n,i)=>new Promise(i=>{m((0,mC.FO)(t)),v(!0),p({policiesAndServices:e,agreedUrls:n,resolve:i})})),v(!1)}catch(e){s.vF.warn(`Unable to reach identity server at ${t} to check for terms in Settings`),s.vF.warn(e)}}catch{}})()},[e,f]),!O.A.getValue(It.f.ThirdPartyID))return null;if(g&&h.policiesAndServices){const e=o.createElement(oM,{type:"info",title:(0,c._t)("settings|general|discovery_needs_terms_title")},(0,c._t)("settings|general|discovery_needs_terms",{serverName:u}));return o.createElement(o.Fragment,null,o.createElement(DO,{policiesAndServicePairs:h.policiesAndServices,agreedUrls:h.agreedUrls,onFinished:h.resolve,introElement:e}),o.createElement(PO,{missingTerms:!0}))}let _;return u&&(_=o.createElement(o.Fragment,null,o.createElement(Mo.P,{heading:(0,c._t)("settings|general|emails_heading"),description:0===r.length?(0,c._t)("settings|general|discovery_email_empty"):void 0,stretchContent:!0},o.createElement(JM,{mode:"is",medium:i.ThreepidMedium.Email,threepids:r,onChange:f,disabled:g,isLoading:t})),o.createElement(Mo.P,{heading:(0,c._t)("settings|general|msisdns_heading"),description:0===l.length?(0,c._t)("settings|general|discovery_msisdn_empty"):void 0,stretchContent:!0},o.createElement(JM,{mode:"is",medium:i.ThreepidMedium.Phone,threepids:l,onChange:f,disabled:g,isLoading:t})))),o.createElement(Mo.P,{heading:(0,c._t)("settings|discovery|title"),stretchContent:!0},_,o.createElement(PO,{missingTerms:!1}))};class OO extends o.Component{constructor(e){super(e),(0,S.A)(this,"onProvisioningToggled",()=>{const e=this.state.provisioningEnabled;O.A.setValue("integrationProvisioning",null,F.p.ACCOUNT,!e).catch(t=>{s.vF.error("Error changing integration manager provisioning"),s.vF.error(t),this.setState({provisioningEnabled:e})}),this.setState({provisioningEnabled:!e})});const t=U.J.sharedInstance().getPrimaryManager();this.state={currentManager:t,provisioningEnabled:O.A.getValue("integrationProvisioning")}}render(){const e=this.state.currentManager;let t,n;return e?(t=`(${e.name})`,n=(0,c._t)("integration_manager|use_im_default",{serverName:e.name},{b:e=>o.createElement("strong",null,e)})):n=(0,c._t)("integration_manager|use_im"),O.A.getValue(It.f.Widgets)?o.createElement("div",{className:"mx_SetIntegrationManager"},o.createElement("div",{className:"mx_SettingsFlag"},o.createElement("div",{className:"mx_SetIntegrationManager_heading_manager"},o.createElement(uC.A,{size:"3"},(0,c._t)("integration_manager|manage_title")),o.createElement(uC.A,{size:"4"},t))),o.createElement(Mo.s,null,n),o.createElement(Mo.s,null,(0,c._t)("integration_manager|explainer")),o.createElement(AS.b,null,o.createElement(oO.I,{name:"enable_im",control:o.createElement(nf,{role:"switch",id:"mx_SetIntegrationManager_Toggle",checked:this.state.provisioningEnabled,onChange:this.onProvisioningToggled})},o.createElement(TS.J,{htmlFor:"mx_SetIntegrationManager_Toggle"},(0,c._t)("integration_manager|toggle_label"))))):null}}const FO=()=>{const{dehydratedDeviceId:e}=RO();return e?o.createElement(Mo.P,{heading:(0,c._t)("common|secure_backup")},o.createElement("div",{className:"mx_SettingsSubsection_content"},o.createElement("div",{className:"mx_SettingsFlag_label"},(0,c._t)("settings|security|dehydrated_device_enabled")),o.createElement("div",{className:"mx_SettingsSubsection_text"},(0,c._t)("settings|security|dehydrated_device_description")))):null};class LO extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"onUnignoreClicked",()=>{this.props.onUnignored(this.props.userId)})}render(){const e=`mx_SecurityUserSettingsTab_ignoredUser_${this.props.userId}`;return o.createElement("li",{className:"mx_SecurityUserSettingsTab_ignoredUser","aria-label":this.props.userId},o.createElement(ae.A,{onClick:this.onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},(0,c._t)("action|unignore")),o.createElement("span",{id:e},this.props.userId))}}class UO extends o.Component{constructor(e){super(e),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"onAction",({action:e})=>{if("ignore_state_changed"===e){const e=f.J.safeGet().getIgnoredUsers(),t=this.state.waitingUnignored.filter(t=>e.includes(t));this.setState({ignoredUserIds:e,waitingUnignored:t})}}),(0,S.A)(this,"onMyMembership",(e,t)=>{e.isSpaceRoom()||(t===Xt.O.Invite?this.addInvitedRoom(e):this.state.invitedRoomIds.has(e.roomId)&&this.removeInvitedRoom(e.roomId))}),(0,S.A)(this,"addInvitedRoom",e=>{this.setState(({invitedRoomIds:t})=>({invitedRoomIds:new Set(t).add(e.roomId)}))}),(0,S.A)(this,"removeInvitedRoom",e=>{this.setState(({invitedRoomIds:t})=>{const n=new Set(t);return n.delete(e),{invitedRoomIds:n}})}),(0,S.A)(this,"onUserUnignored",async e=>{const{ignoredUserIds:t,waitingUnignored:n}=this.state,i=t.filter(e=>!n.includes(e)),r=i.indexOf(e);-1!==r&&(i.splice(r,1),this.setState(({waitingUnignored:t})=>({waitingUnignored:[...t,e]})),f.J.safeGet().setIgnoredUsers(i))}),(0,S.A)(this,"getInvitedRooms",()=>f.J.safeGet().getRooms().filter(e=>e.hasMembershipState(f.J.safeGet().getUserId(),Xt.O.Invite))),(0,S.A)(this,"manageInvites",async e=>{this.setState({managingInvites:!0});const t=Array.from(this.state.invitedRoomIds),n=f.J.safeGet(),i=e?n.joinRoom.bind(n):n.leave.bind(n);for(let e=0;e<t.length;e++){const n=t[e];await i(n).then(()=>{this.removeInvitedRoom(n)},async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await(0,_a.yy)(t.retry_after_ms||2500),e--):s.vF.warn(t)})}this.setState({managingInvites:!1})}),(0,S.A)(this,"onAcceptAllInvitesClicked",()=>{this.manageInvites(!0)}),(0,S.A)(this,"onRejectAllInvitesClicked",()=>{this.manageInvites(!1)});const t=new Set(this.getInvitedRooms().map(e=>e.roomId));this.state={ignoredUserIds:f.J.safeGet().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomIds:t}}componentDidMount(){this.dispatcherRef=x.A.register(this.onAction),f.J.safeGet().on(i.RoomEvent.MyMembership,this.onMyMembership),f.J.safeGet().getVersions().then(e=>this.setState({versions:e}))}componentWillUnmount(){x.A.unregister(this.dispatcherRef),f.J.safeGet().removeListener(i.RoomEvent.MyMembership,this.onMyMembership)}renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state;return null!=t&&t.length?o.createElement(Mo.P,{id:"mx_SecurityUserSettingsTab_ignoredUsersHeading",heading:(0,c._t)("settings|security|ignore_users_section")},o.createElement(Mo.s,null,o.createElement("ul",{"aria-label":(0,c._t)("settings|security|ignore_users_section"),className:"mx_SecurityUserSettingsTab_ignoredUsers"},t.map(t=>o.createElement(LO,{userId:t,onUnignored:this.onUserUnignored,key:t,inProgress:e.includes(t)}))))):o.createElement(Mo.P,{heading:(0,c._t)("settings|security|ignore_users_section")},o.createElement(Mo.s,null,(0,c._t)("settings|security|ignore_users_empty")))}renderManageInvites(){const{invitedRoomIds:e}=this.state;return 0===e.size?null:o.createElement(Mo.P,{heading:(0,c._t)("settings|security|bulk_options_section")},o.createElement("div",{className:"mx_SecurityUserSettingsTab_bulkOptions"},o.createElement(ae.A,{onClick:this.onAcceptAllInvitesClicked,kind:"primary_outline",disabled:this.state.managingInvites},(0,c._t)("settings|security|bulk_options_accept_all_invites",{invitedRooms:e.size})),o.createElement(ae.A,{onClick:this.onRejectAllInvitesClicked,kind:"danger_outline",disabled:this.state.managingInvites},(0,c._t)("settings|security|bulk_options_reject_all_invites",{invitedRooms:e.size})),this.state.managingInvites?o.createElement(tl.A,null):o.createElement("div",null)))}render(){const e=o.createElement(FO,null),t=o.createElement(Mo.P,{heading:(0,c._t)("settings|security|message_search_section")},o.createElement(SO,null));let n,i,r;if((0,yA.u)(f.J.safeGet())||(n=o.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},(0,c._t)("settings|security|e2ee_default_disabled_warning"))),z.Vo.instance.isEnabled()){const e=()=>{bD({primaryButton:(0,c._t)("action|ok"),hasCancel:!1})};i=o.createElement(o.Fragment,null,o.createElement(Mo.P,{heading:(0,c._t)("common|analytics"),description:(0,c._t)("settings|security|analytics_description")},o.createElement(ae.A,{kind:"link",onClick:e},(0,c._t)("action|learn_more")),z.Vo.instance.isEnabled()&&o.createElement(tO.A,{name:"pseudonymousAnalyticsOptIn",level:F.p.ACCOUNT})),o.createElement(Mo.P,{heading:(0,c._t)("settings|sessions|title")},o.createElement(tO.A,{name:"deviceClientInformationOptIn",level:F.p.ACCOUNT})))}if(O.A.getValue(It.f.AdvancedSettings)){const e=this.renderIgnoredUsers(),t=this.renderManageInvites();(e||t)&&(r=o.createElement(Do.X,{heading:(0,c._t)("common|advanced")},e,t))}return o.createElement(No.A,null,n,o.createElement(OO,null),o.createElement(Do.X,{heading:(0,c._t)("settings|security|encryption_section")},e,t),o.createElement(Do.X,{heading:(0,c._t)("common|privacy")},o.createElement(MO,null),i),r)}}const BO=["icon","label","onDeleteClick","disabled"],VO=e=>{let{icon:t,label:n,onDeleteClick:i,disabled:r=!1}=e,s=(0,v.A)(e,BO);return o.createElement("div",(0,tn.A)({className:"mx_Tag"},s),null==t?void 0:t(),n,i&&o.createElement(ae.A,{"aria-label":"Remove",className:"mx_Tag_delete",onClick:i,disabled:r},o.createElement(PT.A,null)))};class jO extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"onInputChange",e=>{this.setState({newTag:e.target.value})}),(0,S.A)(this,"onAdd",e=>{e.preventDefault(),this.state.newTag&&(this.props.onAdd(this.state.newTag),this.setState({newTag:""}))}),this.state={newTag:""}}onRemove(e){this.props.onRemove(e)}render(){return o.createElement("div",{className:me()("mx_TagComposer",{mx_TagComposer_disabled:this.props.disabled})},o.createElement("form",{className:"mx_TagComposer_input",onSubmit:this.onAdd},o.createElement(wo.A,{id:this.props.id?this.props.id+"_field":void 0,value:this.state.newTag,onChange:this.onInputChange,label:this.props.label||(0,c._t)("notifications|keyword"),placeholder:this.props.placeholder||(0,c._t)("notifications|keyword_new"),disabled:this.props.disabled,autoComplete:"off"}),o.createElement(ae.A,{onClick:this.onAdd,kind:"primary",disabled:this.props.disabled},(0,c._t)("action|add"))),o.createElement("div",{className:"mx_TagComposer_tags",role:"list"},this.props.tags.map((e,t)=>o.createElement(VO,{label:e,key:e,onDeleteClick:this.onRemove.bind(this,e),disabled:this.props.disabled,role:"listitem"}))))}}var zO=n("./src/components/views/typography/Caption.tsx"),HO=n("./src/components/views/settings/shared/SettingsSubsectionHeading.tsx");function WO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function GO(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?WO(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):WO(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var KO=function(e){return e.Loading="loading",e.Ready="ready",e.Persisting="persisting",e.Error="error",e.SavingError="savingError",e}(KO||{}),qO=function(e){return e.Master="master",e.VectorGlobal="vector_global",e.VectorMentions="vector_mentions",e.VectorOther="vector_other",e.Other="other",e}(qO||{});const $O="_keywords",JO=qO.VectorMentions,YO=[i.RuleId.DM,i.RuleId.EncryptedDM,i.RuleId.Message,i.RuleId.EncryptedMessage,i.RuleId.ContainsDisplayName,i.RuleId.ContainsUserName,i.RuleId.AtRoomNotification,i.RuleId.InviteToSelf,i.RuleId.IncomingCall,i.RuleId.SuppressNotices,i.RuleId.Tombstone],XO=[tD.Off,tD.On,tD.Loud],QO=(e,t,n)=>{var i;if(null===(i=n.syncedRuleIds)||void 0===i||!i.length)return;const r=n.syncedRuleIds.reduce((t,i)=>{if(t===tD.Loud)return t;const r=((e,t)=>{for(const n in t){const i=t[n].find(t=>t.rule_id===e);if(i)return i}})(i,e);if(r){const e=n.ruleToVectorState(r);if(e&&XO.indexOf(e)>XO.indexOf(t))return e}return t},n.ruleToVectorState(t));return r},ZO=()=>o.createElement("div",null,o.createElement(tO.A,{name:"Notifications.showbold",level:F.p.DEVICE}),o.createElement(tO.A,{name:"Notifications.tac_only_notifications",level:F.p.DEVICE}));class eF extends o.PureComponent{constructor(e){var t;super(e),(0,S.A)(this,"settingWatchers",[]),(0,S.A)(this,"onMasterRuleChanged",async e=>{this.setState({phase:KO.Persisting});const t=this.state.masterPushRule;try{await f.J.safeGet().setPushRuleEnabled("global",t.kind,t.rule_id,!e),await this.refreshFromServer()}catch(e){this.setState({phase:KO.Error}),s.vF.error("Error updating master push rule:",e),this.showSaveError()}}),(0,S.A)(this,"setSavingError",e=>{this.setState(({ruleIdsWithError:t})=>({phase:KO.SavingError,ruleIdsWithError:GO(GO({},t),{},{[e]:!0})}))}),(0,S.A)(this,"updateDeviceNotifications",async e=>{await O.A.setValue("deviceNotificationsEnabled",null,F.p.DEVICE,e)}),(0,S.A)(this,"onEmailNotificationsChanged",async(e,t)=>{this.setState({phase:KO.Persisting});try{if(t)await f.J.safeGet().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:{brand:d.Ay.get().brand},append:!0});else{var n;const t=null===(n=this.state.pushers)||void 0===n?void 0:n.find(t=>"email"===t.kind&&t.pushkey===e);t&&await f.J.safeGet().removePusher(t.pushkey,t.app_id)}await this.refreshFromServer()}catch(e){this.setState({phase:KO.Error}),s.vF.error("Error updating email pusher:",e),this.showSaveError()}}),(0,S.A)(this,"onDesktopNotificationsChanged",async e=>{await O.A.setValue("notificationsEnabled",null,F.p.DEVICE,e)}),(0,S.A)(this,"onDesktopShowBodyChanged",async e=>{await O.A.setValue("notificationBodyEnabled",null,F.p.DEVICE,e)}),(0,S.A)(this,"onAudioNotificationsChanged",async e=>{await O.A.setValue("audioNotificationsEnabled",null,F.p.DEVICE,e)}),(0,S.A)(this,"onRadioChecked",async(e,t)=>{this.setState(({ruleIdsWithError:t})=>({phase:KO.Persisting,ruleIdsWithError:GO(GO({},t),{},{[e.ruleId]:!1})}));try{const n=f.J.safeGet();if(e.ruleId===$O){if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");for(const e of this.state.vectorKeywordRuleInfo.rules){let i,r;t===tD.On?(1!==e.actions.length&&(r=nD.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===tD.Off&&(i=!0)):t===tD.Loud?(3!==e.actions.length&&(r=nD.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===tD.Off&&(i=!0)):i=!1,r&&await n.setPushRuleActions("global",e.kind,e.rule_id,r),void 0!==i&&await n.setPushRuleEnabled("global",e.kind,e.rule_id,i)}}else{const i=rD[e.ruleId],r=i.vectorStateToActions[t];if(!e.rule)throw new Error("Cannot update rule: push rule data is incomplete.");await sD(n,e.rule.rule_id,e.rule.kind,r),await aD(n,i.syncedRuleIds,r)}await this.refreshFromServer()}catch(t){this.setSavingError(e.ruleId),s.vF.error("Error updating push rule:",t)}}),(0,S.A)(this,"onClearNotificationsClicked",async()=>{try{this.setState({clearingNotifications:!0});const e=f.J.safeGet();await(0,dr.XC)(e)}finally{this.setState({clearingNotifications:!1})}}),(0,S.A)(this,"onKeywordAdd",e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,Dn.ZV)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:KO.Persisting,vectorKeywordRuleInfo:GO(GO({},this.state.vectorKeywordRuleInfo),{},{rules:[...this.state.vectorKeywordRuleInfo.rules,{pattern:e}]})},async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map(e=>e.pattern),t)})}),(0,S.A)(this,"onKeywordRemove",e=>{if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");const t=(0,Dn.ZV)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:KO.Persisting,vectorKeywordRuleInfo:GO(GO({},this.state.vectorKeywordRuleInfo),{},{rules:this.state.vectorKeywordRuleInfo.rules.filter(t=>t.pattern!==e)})},async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map(e=>e.pattern),t)})}),this.state={phase:KO.Loading,deviceNotificationsEnabled:null===(t=O.A.getValue("deviceNotificationsEnabled"))||void 0===t||t,desktopNotifications:O.A.getValue("notificationsEnabled"),desktopShowBody:O.A.getValue("notificationBodyEnabled"),audioNotifications:O.A.getValue("audioNotificationsEnabled"),clearingNotifications:!1,ruleIdsWithError:{}}}get isInhibited(){var e;return!(null===(e=this.state.masterPushRule)||void 0===e||!e.enabled)}componentDidMount(){this.settingWatchers=[O.A.watchSetting("notificationsEnabled",null,(...[,,,,e])=>this.setState({desktopNotifications:e})),O.A.watchSetting("deviceNotificationsEnabled",null,(...[,,,,e])=>{this.setState({deviceNotificationsEnabled:e})}),O.A.watchSetting("notificationBodyEnabled",null,(...[,,,,e])=>this.setState({desktopShowBody:e})),O.A.watchSetting("audioNotificationsEnabled",null,(...[,,,,e])=>this.setState({audioNotifications:e}))],this.refreshFromServer(),this.refreshFromAccountData()}componentWillUnmount(){this.settingWatchers.forEach(e=>O.A.unwatchSetting(e))}componentDidUpdate(e,t){this.state.deviceNotificationsEnabled!==t.deviceNotificationsEnabled&&this.persistLocalNotificationSettings(this.state.deviceNotificationsEnabled)}async refreshFromServer(){try{const e=(await Promise.all([this.refreshRules(),this.refreshPushers(),this.refreshThreepids()])).reduce((e,t)=>Object.assign(t,e),{});this.setState(GO(GO({},e),{},{phase:KO.Ready}))}catch(e){s.vF.error("Error setting up notifications for settings: ",e),this.setState({phase:KO.Error})}}async refreshFromAccountData(){const e=f.J.safeGet(),t=e.getAccountData((0,dr.uG)(e.deviceId));if(t){const e=!t.getContent().is_silenced;await this.updateDeviceNotifications(e)}}persistLocalNotificationSettings(e){const t=f.J.safeGet();return t.setAccountData((0,dr.uG)(t.deviceId),{is_silenced:!e})}async refreshRules(){const e=await f.J.safeGet().getPushRules(),t={[i.RuleId.Master]:qO.Master,[i.RuleId.DM]:qO.VectorGlobal,[i.RuleId.EncryptedDM]:qO.VectorGlobal,[i.RuleId.Message]:qO.VectorGlobal,[i.RuleId.EncryptedMessage]:qO.VectorGlobal,[i.RuleId.ContainsDisplayName]:qO.VectorMentions,[i.RuleId.ContainsUserName]:qO.VectorMentions,[i.RuleId.AtRoomNotification]:qO.VectorMentions,[i.RuleId.InviteToSelf]:qO.VectorOther,[i.RuleId.IncomingCall]:qO.VectorOther,[i.RuleId.SuppressNotices]:qO.VectorOther,[i.RuleId.Tombstone]:qO.VectorOther},n={[qO.Master]:[],[qO.VectorGlobal]:[],[qO.VectorMentions]:[],[qO.VectorOther]:[],[qO.Other]:[]};for(const i in e.global){const o=i;for(const i of e.global[o]){var r;const e=Object.assign(i,{kind:o}),s=null!==(r=t[e.rule_id])&&void 0!==r?r:qO.Other;"."===e.rule_id[0]&&n[s].push(e)}}const o={};if(!(n.master.length>0))throw new Error("Failed to locate a master push rule");o.masterPushRule=n.master[0],o.vectorKeywordRuleInfo=oD.parseContentRules(e),o.vectorPushRules={};const s=[qO.VectorGlobal,qO.VectorMentions,qO.VectorOther];for(const e of s){o.vectorPushRules[e]=[];for(const t of n[e]){const i=rD[t.rule_id],r=i.ruleToVectorState(t);o.vectorPushRules[e].push({ruleId:t.rule_id,rule:t,vectorState:r,syncedVectorState:QO(n,t,i),description:(0,c._t)(i.description)})}o.vectorPushRules[e].sort((e,t)=>{let n=YO.indexOf(e.ruleId),i=YO.indexOf(t.ruleId);return n<0&&(n=YO.length),i<0&&(i=YO.length),n-i}),e===JO&&o.vectorPushRules[e].push({ruleId:$O,description:(0,c._t)("settings|notifications|messages_containing_keywords"),vectorState:o.vectorKeywordRuleInfo.vectorState})}return o}refreshPushers(){return f.J.safeGet().getPushers()}refreshThreepids(){return f.J.safeGet().getThreePids()}showSaveError(){R.Ay.createDialog(Ht.A,{title:(0,c._t)("settings|notifications|error_saving"),description:(0,c._t)("settings|notifications|error_saving_detail")})}async setKeywords(e,t){try{const n=(0,ie.Bo)(Array.from(new Set(e))),r=(0,ie.Bo)(Array.from(new Set(t.map(e=>e.pattern)))),o=(0,ie.ZQ)(r,n);for(const e of o.removed)for(const n of t.filter(t=>t.pattern===e))await f.J.safeGet().deletePushRule("global",n.kind,n.rule_id);let s=this.state.vectorKeywordRuleInfo.vectorState;if(s===tD.Off){const e=t.length?nD.contentRuleVectorStateKind(t[0]):void 0;s=null!=e?e:tD.On}const a=i.PushRuleKind.ContentSpecific;for(const e of o.added)await f.J.safeGet().addPushRule("global",a,e,{actions:nD.actionsFor(s),pattern:e}),s===tD.Off&&await f.J.safeGet().setPushRuleEnabled("global",a,e,!1);await this.refreshFromServer()}catch(e){this.setState({phase:KO.Error}),s.vF.error("Error updating keyword push rules:",e),this.showSaveError()}}renderTopSection(){const e=o.createElement(Ko.A,{value:!this.isInhibited,label:(0,c._t)("settings|notifications|enable_notifications_account"),caption:(0,c._t)("settings|notifications|enable_notifications_account_detail"),onChange:this.onMasterRuleChanged,disabled:this.state.phase===KO.Persisting});if(this.isInhibited)return e;const t=(this.state.threepids||[]).filter(e=>e.medium===i.ThreepidMedium.Email).map(e=>{var t;return o.createElement(Ko.A,{key:e.address,value:!(null===(t=this.state.pushers)||void 0===t||!t.some(t=>"email"===t.kind&&t.pushkey===e.address)),label:(0,c._t)("settings|notifications|enable_email_notifications",{email:e.address}),onChange:this.onEmailNotificationsChanged.bind(this,e.address),disabled:this.state.phase===KO.Persisting})});return o.createElement(Mo.P,null,e,o.createElement(Ko.A,{value:this.state.deviceNotificationsEnabled,label:(0,c._t)("settings|notifications|enable_notifications_device"),onChange:e=>this.updateDeviceNotifications(e),disabled:this.state.phase===KO.Persisting}),this.state.deviceNotificationsEnabled&&o.createElement(o.Fragment,null,o.createElement(Ko.A,{value:this.state.desktopNotifications,onChange:this.onDesktopNotificationsChanged,label:(0,c._t)("settings|notifications|enable_desktop_notifications_session"),disabled:this.state.phase===KO.Persisting}),o.createElement(Ko.A,{value:this.state.desktopShowBody,onChange:this.onDesktopShowBodyChanged,label:(0,c._t)("settings|notifications|show_message_desktop_notification"),disabled:this.state.phase===KO.Persisting}),o.createElement(Ko.A,{value:this.state.audioNotifications,onChange:this.onAudioNotificationsChanged,label:(0,c._t)("settings|notifications|enable_audible_notifications_session"),disabled:this.state.phase===KO.Persisting})),t)}renderCategory(e){var t;if(this.isInhibited)return null;let n;if(e===qO.VectorMentions){var i;const e=(0,ie.Bo)((null===(i=this.state.vectorKeywordRuleInfo)||void 0===i?void 0:i.rules.map(e=>e.pattern))||[]);n=o.createElement(jO,{tags:e,onAdd:this.onKeywordAdd,onRemove:this.onKeywordRemove,disabled:this.state.phase===KO.Persisting,label:(0,c._t)("notifications|keyword"),placeholder:(0,c._t)("notifications|keyword_new")})}const r={[tD.On]:(0,c._t)("common|on"),[tD.Off]:(0,c._t)("common|off"),[tD.Loud]:(0,c._t)("settings|notifications|noisy")},s=(e,t)=>{var n;return o.createElement(Eo.A,{key:e.ruleId+t,name:e.ruleId,checked:(null!==(n=e.syncedVectorState)&&void 0!==n?n:e.vectorState)===t,onChange:this.onRadioChecked.bind(this,e,t),disabled:this.state.phase===KO.Persisting,"aria-label":r[t]})},a=null===(t=this.state.vectorPushRules)||void 0===t||null===(t=t[e])||void 0===t?void 0:t.map(t=>o.createElement("fieldset",{key:e+t.ruleId,className:"mx_UserNotifSettings_gridRowContainer"},o.createElement("legend",{className:"mx_UserNotifSettings_gridRowLabel"},t.description),s(t,tD.Off),s(t,tD.On),s(t,tD.Loud),this.state.ruleIdsWithError[t.ruleId]&&o.createElement("div",{className:"mx_UserNotifSettings_gridRowError"},o.createElement(zO.H,{isError:!0},(0,c._t)("settings|notifications|error_updating")))));let l;switch(e){case qO.VectorGlobal:l=(0,c._t)("notifications|class_global");break;case qO.VectorMentions:l=(0,c._t)("notifications|mentions_keywords");break;case qO.VectorOther:l=(0,c._t)("notifications|class_other");break;default:throw new Error("Developer error: Unnamed notifications section: "+e)}return o.createElement("div",null,o.createElement("div",{className:"mx_UserNotifSettings_grid"},o.createElement(HO.r,{heading:l}),o.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[tD.Off]),o.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[tD.On]),o.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[tD.Loud]),a),n)}renderTargets(){var e;if(this.isInhibited)return null;const t=null===(e=this.state.pushers)||void 0===e?void 0:e.map(e=>o.createElement("tr",{key:e.kind+e.pushkey},o.createElement("td",null,e.app_display_name),o.createElement("td",null,e.device_display_name)));return null!=t&&t.length?o.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.createElement("div",null,(0,c._t)("settings|notifications|push_targets")),o.createElement("table",null,o.createElement("tbody",null,t))):null}render(){if(this.state.phase===KO.Loading)return o.createElement(le.A,null);if(this.state.phase===KO.Error)return o.createElement("p",null,(0,c._t)("settings|notifications|error_loading"));let e;return f.J.safeGet().getRooms().some(e=>(0,dg.GN)(e,!0))&&(e=o.createElement(ae.A,{onClick:this.onClearNotificationsClicked,disabled:this.state.clearingNotifications,kind:"danger",className:"mx_UserNotifSettings_clearNotifsButton"},(0,c._t)("notifications|mark_all_read"))),o.createElement(o.Fragment,null,this.renderTopSection(),this.renderCategory(qO.VectorGlobal),this.renderCategory(qO.VectorMentions),this.renderCategory(qO.VectorOther),this.renderTargets(),o.createElement(ZO,null),e)}}function tF(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function nF(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tF(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tF(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function iF(e){const t=new Map;for(const r of Object.values(i.PushRuleKind))for(const i of null!==(n=e.global[r])&&void 0!==n?n:[]){var n;i.rule_id.startsWith(".")&&t.set(i.rule_id,nF(nF({},i),{},{kind:r}))}return t}function rF(e,t,n){var r,o;const s={updated:[],added:[],deleted:[]},a=iF(e),l=function(e,t){const n=new Map;n.set(i.RuleId.Master,{rule_id:i.RuleId.Master,kind:i.PushRuleKind.Override,enabled:e.globalMute}),n.set(i.RuleId.EncryptedMessage,{rule_id:i.RuleId.EncryptedMessage,kind:i.PushRuleKind.Underride,enabled:!0,actions:QN.encodeActions({notify:e.defaultLevels.room===Ef.dC.AllMessages,highlight:!1})}),n.set(i.RuleId.Message,{rule_id:i.RuleId.Message,kind:i.PushRuleKind.Underride,enabled:!0,actions:QN.encodeActions({notify:e.defaultLevels.room===Ef.dC.AllMessages,highlight:!1})}),n.set(i.RuleId.EncryptedDM,{rule_id:i.RuleId.EncryptedDM,kind:i.PushRuleKind.Underride,enabled:!0,actions:QN.encodeActions({notify:e.defaultLevels.dm===Ef.dC.AllMessages,highlight:!1,sound:e.sound.people})}),n.set(i.RuleId.DM,{rule_id:i.RuleId.DM,kind:i.PushRuleKind.Underride,enabled:!0,actions:QN.encodeActions({notify:e.defaultLevels.dm===Ef.dC.AllMessages,highlight:!1,sound:e.sound.people})}),n.set(i.RuleId.SuppressNotices,{rule_id:i.RuleId.SuppressNotices,kind:i.PushRuleKind.Override,enabled:!e.activity.bot_notices,actions:eD.ACTION_DONT_NOTIFY}),n.set(i.RuleId.InviteToSelf,{rule_id:i.RuleId.InviteToSelf,kind:i.PushRuleKind.Override,enabled:e.activity.invite,actions:QN.encodeActions({notify:!0,highlight:!1,sound:e.sound.people})}),n.set(i.RuleId.MemberEvent,{rule_id:i.RuleId.MemberEvent,kind:i.PushRuleKind.Override,enabled:!0,actions:e.activity.status_event?eD.ACTION_NOTIFY:eD.ACTION_DONT_NOTIFY});const r=QN.encodeActions({notify:!0,sound:e.sound.mentions,highlight:!0}),o=e.mentions.user?r:eD.ACTION_DONT_NOTIFY;t&&n.set(i.RuleId.IsUserMention,{rule_id:i.RuleId.IsUserMention,kind:i.PushRuleKind.Override,enabled:!0,actions:o}),n.set(i.RuleId.ContainsDisplayName,{rule_id:i.RuleId.ContainsDisplayName,kind:i.PushRuleKind.Override,enabled:!0,actions:o}),n.set(i.RuleId.ContainsUserName,{rule_id:i.RuleId.ContainsUserName,kind:i.PushRuleKind.ContentSpecific,enabled:!0,actions:o});const s=e.mentions.room?eD.ACTION_NOTIFY:eD.ACTION_DONT_NOTIFY;return t&&n.set(i.RuleId.IsRoomMention,{rule_id:i.RuleId.IsRoomMention,kind:i.PushRuleKind.Override,enabled:!0,actions:s}),n.set(i.RuleId.AtRoomNotification,{rule_id:i.RuleId.AtRoomNotification,kind:i.PushRuleKind.Override,enabled:!0,actions:s}),n.set(i.RuleId.Tombstone,{rule_id:i.RuleId.Tombstone,kind:i.PushRuleKind.Override,enabled:e.activity.status_event,actions:eD.ACTION_HIGHLIGHT}),n.set(i.RuleId.IncomingCall,{rule_id:i.RuleId.IncomingCall,kind:i.PushRuleKind.Underride,enabled:!0,actions:QN.encodeActions({notify:!0,sound:e.sound.calls})}),n}(t,n);for(const e of l.values()){const t=a.get(e.rule_id);let n=!1;if(void 0===t)n=!0;else if(void 0!==e.enabled&&e.enabled!==t.enabled)n=!0;else if(void 0!==e.actions){const i=QN.decodeActions(t.actions),r=QN.decodeActions(e.actions);null===i||null===r?n=!0:(0,_a.ky)(r,i)||(n=!0)}n&&s.updated.push(e)}const c=QN.encodeActions({notify:!0,sound:t.sound.mentions,highlight:!0}),d=null!==(r=null===(o=e.global.content)||void 0===o?void 0:o.filter(e=>!e.rule_id.startsWith(".")))&&void 0!==r?r:[],u=new Set(t.keywords);for(const e of d){if(u.has(e.pattern)){let n=!1;if(e.enabled!==t.mentions.keywords)n=!0;else if(void 0!==e.actions){const t=QN.decodeActions(e.actions),i=QN.decodeActions(c);null===t||null===i?n=!0:(0,_a.ky)(i,t)||(n=!0)}n&&s.updated.push({rule_id:e.rule_id,kind:i.PushRuleKind.ContentSpecific,enabled:t.mentions.keywords,actions:c})}else s.deleted.push({rule_id:e.rule_id,kind:i.PushRuleKind.ContentSpecific});u.delete(e.pattern)}for(const e of u)s.added.push({rule_id:e,kind:i.PushRuleKind.ContentSpecific,default:!1,enabled:t.mentions.keywords,pattern:e,actions:c});return s}function oF(e){if(0===e.length)return!0;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=QN.decodeActions(t.actions);if(null!==e&&e.notify)return!0}return!1}function sF(e){if(0===e.length)return!1;for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=QN.decodeActions(t.actions);if(null!==e&&!e.notify&&!0!==e.highlight&&void 0===e.sound)return!0}return!1}function aF(e){for(const t of e){if(null==t||!1===t||!t.enabled)continue;const e=QN.decodeActions(t.actions);if(null!==e&&e.notify&&void 0!==e.sound)return e.sound}}function lF(e){const t=function(){const e=(0,o.useRef)(null);return(0,o.useCallback)(t=>{let n;return n=null===e.current?t():e.current.then(t),e.current=n,n},[])}(),n=(0,o.useMemo)(()=>e.supportsIntentionalMentions(),[e]),r=(0,o.useRef)(null),[s,a]=(0,o.useState)(null),[l,c]=(0,o.useState)(!1),d=(0,o.useCallback)(async()=>{const t=await e.getPushRules(),o=function(e,t){var n,r,o,s;const a=iF(e),l=null!==(n=null===(r=e.global.content)||void 0===r?void 0:r.filter(e=>!e.rule_id.startsWith(".")))&&void 0!==n?n:[],c=[a.get(i.RuleId.DM),a.get(i.RuleId.EncryptedDM)],d=[a.get(i.RuleId.Message),a.get(i.RuleId.EncryptedMessage)];return{globalMute:null!==(o=null===(s=a.get(i.RuleId.Master))||void 0===s?void 0:s.enabled)&&void 0!==o&&o,defaultLevels:{room:oF(d)?Ef.dC.AllMessages:Ef.dC.MentionsOnly,dm:oF(c)?Ef.dC.AllMessages:Ef.dC.MentionsOnly},sound:{calls:aF([a.get(i.RuleId.IncomingCall)]),mentions:aF([t&&a.get(i.RuleId.IsUserMention),a.get(i.RuleId.ContainsUserName),a.get(i.RuleId.ContainsDisplayName),...l]),people:aF(c)},activity:{bot_notices:!sF([a.get(i.RuleId.SuppressNotices)]),invite:oF([a.get(i.RuleId.InviteToSelf)]),status_event:oF([a.get(i.RuleId.MemberEvent),a.get(i.RuleId.Tombstone)])},mentions:{user:oF([t&&a.get(i.RuleId.IsUserMention),a.get(i.RuleId.ContainsUserName),a.get(i.RuleId.ContainsDisplayName)]),room:oF([t&&a.get(i.RuleId.IsRoomMention),a.get(i.RuleId.AtRoomNotification)]),keywords:oF(l)},keywords:l.map(e=>e.pattern)}}(t,n),s=rF(t,o,n);r.current=t,c(s.updated.length>0||s.added.length>0||s.deleted.length>0),a(o)},[e,n]);(0,o.useEffect)(()=>{t(d).catch(e=>console.error(e))},[e,t,d]);const u=(0,o.useCallback)(i=>{a(i),t(async()=>{if(null!==r.current){const t=rF(r.current,i,n);await async function(e,t){await Promise.all(t.deleted.map(t=>e.deletePushRule("global",t.kind,t.rule_id))),await Promise.all(t.added.map(t=>e.addPushRule("global",t.kind,t.rule_id,t))),await Promise.all(t.updated.map(async t=>{void 0!==t.enabled&&await e.setPushRuleEnabled("global",t.kind,t.rule_id,t.enabled),void 0!==t.actions&&await e.setPushRuleActions("global",t.kind,t.rule_id,t.actions)}))}(e,t),await d()}}).catch(e=>console.error(e))},[t,n,e,d]);return{model:s,hasPendingChanges:l,reconcile:u}}const cF={globalMute:!1,defaultLevels:{room:Ef.dC.AllMessages,dm:Ef.dC.AllMessages},sound:{people:"default",mentions:"default",calls:"ring"},activity:{invite:!0,status_event:!1,bot_notices:!0},mentions:{user:!0,room:!0,keywords:!0},keywords:[]};function dF({children:e,icon:t,action:n,onAction:i}){return o.createElement("div",{className:"mx_SettingsBanner"},t,o.createElement("div",{className:"mx_SettingsBanner_content"},e),n&&o.createElement(ae.A,{kind:"primary_outline",onClick:null!=i?i:null},n))}function uF(e,t,n){const[i,r]=(0,o.useState)(n),s=(0,o.useCallback)(()=>{let t=!1;return e().then(e=>{t||r(e)}).catch(e=>console.error(e)),()=>{t=!0}},t);return(0,o.useEffect)(s,[s]),[i,s]}const mF=["children"],hF=e=>{let{children:t}=e,n=(0,v.A)(e,mF);return o.createElement("div",(0,tn.A)({},n,{className:"mx_SettingsIndent"}),t)};function pF(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function gF(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pF(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pF(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function vF(e){return o.createElement(ae.A,{kind:"link_inline",onClick:()=>{x.A.dispatch({action:W.r.ViewUserSettings,initialTabId:We.v.Account})}},e)}function fF(){const e=(0,o.useMemo)(()=>({kind:"email",app_id:"m.email",app_display_name:(0,c._t)("notifications|email_pusher_app_display_name"),lang:navigator.language,data:{brand:d.Ay.get().brand}}),[]),t=(0,ce.nH)(),[n,r]=function(e){return uF(()=>e.getPushers().then(e=>e.pushers),[e],[])}(t),[s,a]=function(e){return uF(()=>e.getThreePids().then(e=>e.threepids),[e],[])}(t),l=(0,o.useCallback)((i,o)=>{if(o)t.setPusher(gF(gF({},e),{},{pushkey:i,device_display_name:i,append:!0})).catch(e=>console.error(e));else{const e=n.find(e=>"email"===e.kind&&e.pushkey===i);e&&t.removePusher(e.pushkey,e.app_id).catch(e=>console.error(e))}a(),r()},[e,t,n,r,a]),u=n.filter(e=>"email"!==e.kind);return o.createElement(o.Fragment,null,o.createElement(Mo.P,{className:"mx_NotificationPusherSettings",heading:(0,c._t)("settings|notifications|email_section")},o.createElement(Mo.s,{className:"mx_NotificationPusherSettings_description"},(0,c._t)("settings|notifications|email_description")),o.createElement("div",{className:"mx_SettingsSubsection_description mx_NotificationPusherSettings_detail"},o.createElement(Mo.s,null,(0,c._t)("settings|notifications|email_select",{},{button:vF}))),o.createElement(hF,null,s.filter(e=>e.medium===i.ThreepidMedium.Email).map(e=>o.createElement(So.A,{key:e.address,label:e.address,value:void 0!==n.find(t=>t.pushkey===e.address),onChange:t=>l(e.address,t)})))),u.length>0&&o.createElement(Mo.P,{heading:(0,c._t)("settings|notifications|push_targets")},o.createElement("ul",null,n.filter(e=>"email"!==e.kind).map(e=>o.createElement("li",{key:e.pushkey},e.device_display_name||e.app_display_name)))))}function _F(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function yF(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_F(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_F(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var bF=function(e){return e.AllMessages="all_messages",e.PeopleMentionsKeywords="people_mentions_keywords",e.MentionsKeywords="mentions_keywords",e}(bF||{});function EF(e){return o.createElement("strong",null,e)}function wF(e){return o.createElement(Hp.A,{href:"https://element.io/help#settings2"},e)}function SF(){var e;const t=(0,ce.nH)(),n=(0,Qt.ti)("notificationsEnabled"),i=(0,Qt.ti)("notificationBodyEnabled"),r=(0,Qt.ti)("audioNotificationsEnabled"),{model:s,hasPendingChanges:a,reconcile:l}=lF(t),d=null===s||a,u=null!=s?s:cF,[m,h]=(0,o.useState)(!1),p=(0,ce.nH)().getRooms().some(e=>e.getUnreadNotificationCount()>0),g=[{value:bF.AllMessages,label:(0,c._t)("notifications|all_messages")},{value:bF.PeopleMentionsKeywords,label:(0,c._t)("settings|notifications|people_mentions_keywords")},{value:bF.MentionsKeywords,label:(0,c._t)("settings|notifications|mentions_keywords_only")}];return o.createElement("div",{className:"mx_NotificationSettings2"},a&&null!==s&&o.createElement(dF,{icon:o.createElement("img",{src:"img/element-icons/new-and-improved.a92f516.svg",alt:"",width:12}),action:(0,c._t)("action|proceed"),onAction:()=>l(s)},(0,c._t)("settings|notifications|labs_notice_prompt",{},{strong:EF,a:wF})),o.createElement(Do.X,null,o.createElement("div",{className:"mx_SettingsSubsection_content mx_NotificationSettings2_flags"},o.createElement(Ko.A,{label:(0,c._t)("settings|notifications|enable_notifications_account"),value:!u.globalMute,disabled:d,onChange:e=>{l(yF(yF({},s),{},{globalMute:!e}))}}),o.createElement(Ko.A,{label:(0,c._t)("settings|notifications|enable_desktop_notifications_session"),value:n,onChange:e=>O.A.setValue("notificationsEnabled",null,F.p.DEVICE,e)}),o.createElement(Ko.A,{label:(0,c._t)("settings|notifications|desktop_notification_message_preview"),value:i,onChange:e=>O.A.setValue("notificationBodyEnabled",null,F.p.DEVICE,e)}),o.createElement(Ko.A,{label:(0,c._t)("settings|notifications|enable_audible_notifications_session"),value:r,onChange:e=>O.A.setValue("audioNotificationsEnabled",null,F.p.DEVICE,e)})),o.createElement(Mo.P,{heading:(0,c._t)("settings|notifications|default_setting_section"),description:(0,c._t)("settings|notifications|default_setting_description")},o.createElement(Tx.A,{name:"defaultNotificationLevel",value:(v=u.defaultLevels,v.room===Ef.dC.AllMessages?bF.AllMessages:v.dm===Ef.dC.AllMessages?bF.PeopleMentionsKeywords:bF.MentionsKeywords),disabled:d,definitions:g,onChange:e=>{l(yF(yF({},s),{},{defaultLevels:yF(yF({},s.defaultLevels),{},{dm:e!==bF.MentionsKeywords?Ef.dC.AllMessages:Ef.dC.MentionsOnly,room:e===bF.AllMessages?Ef.dC.AllMessages:Ef.dC.MentionsOnly})}))}})),o.createElement(Mo.P,{heading:(0,c._t)("settings|notifications|play_sound_for_section"),description:(0,c._t)("settings|notifications|play_sound_for_description")},o.createElement(So.A,{label:(0,c._t)("common|people"),value:void 0!==u.sound.people,disabled:d||u.defaultLevels.dm===Ef.dC.MentionsOnly,onChange:e=>{l(yF(yF({},s),{},{sound:yF(yF({},s.sound),{},{people:e?"default":void 0})}))}}),o.createElement(So.A,{label:(0,c._t)("settings|notifications|mentions_keywords"),value:void 0!==u.sound.mentions,disabled:d,onChange:e=>{l(yF(yF({},s),{},{sound:yF(yF({},s.sound),{},{mentions:e?"default":void 0})}))}}),o.createElement(So.A,{label:(0,c._t)("settings|notifications|voip"),value:void 0!==u.sound.calls,disabled:d,onChange:e=>{l(yF(yF({},s),{},{sound:yF(yF({},s.sound),{},{calls:e?"ring":void 0})}))}})),o.createElement(Mo.P,{heading:(0,c._t)("settings|notifications|other_section")},o.createElement(So.A,{label:(0,c._t)("settings|notifications|invites"),value:u.activity.invite,disabled:d,onChange:e=>{l(yF(yF({},s),{},{activity:yF(yF({},s.activity),{},{invite:e})}))}}),o.createElement(So.A,{label:(0,c._t)("settings|notifications|room_activity"),value:u.activity.status_event,disabled:d,onChange:e=>{l(yF(yF({},s),{},{activity:yF(yF({},s.activity),{},{status_event:e})}))}}),o.createElement(So.A,{label:(0,c._t)("settings|notifications|notices"),value:u.activity.bot_notices,disabled:d,onChange:e=>{l(yF(yF({},s),{},{activity:yF(yF({},s.activity),{},{bot_notices:e})}))}})),o.createElement(Mo.P,{heading:(0,c._t)("settings|notifications|mentions_keywords"),description:(0,c._t)("settings|notifications|keywords",{},{badge:o.createElement(Nr.V,{symbol:"1",count:1,level:fp.S.Notification})})},o.createElement(So.A,{label:(0,c._t)("settings|notifications|notify_at_room"),value:u.mentions.room,disabled:d,onChange:e=>{l(yF(yF({},s),{},{mentions:yF(yF({},s.mentions),{},{room:e})}))}}),o.createElement(So.A,{label:(0,c._t)("settings|notifications|notify_mention",{mxid:t.getUserId()}),value:u.mentions.user,disabled:d,onChange:e=>{l(yF(yF({},s),{},{mentions:yF(yF({},s.mentions),{},{user:e})}))}}),o.createElement(So.A,{label:(0,c._t)("settings|notifications|notify_keyword"),byline:(0,c._t)("settings|notifications|keywords_prompt"),value:u.mentions.keywords,disabled:d,onChange:e=>{l(yF(yF({},s),{},{mentions:yF(yF({},s.mentions),{},{keywords:e})}))}}),o.createElement(jO,{id:"mx_NotificationSettings2_Keywords",tags:null!==(e=null==s?void 0:s.keywords)&&void 0!==e?e:[],disabled:d,onAdd:e=>{l(yF(yF({},s),{},{keywords:[e,...s.keywords]}))},onRemove:e=>{l(yF(yF({},s),{},{keywords:s.keywords.filter(t=>t!==e)}))},label:(0,c._t)("notifications|keyword"),placeholder:(0,c._t)("notifications|keyword_new")}),o.createElement(tO.A,{name:"Notifications.showbold",level:F.p.DEVICE}),o.createElement(tO.A,{name:"Notifications.tac_only_notifications",level:F.p.DEVICE})),o.createElement(fF,null),o.createElement(Mo.P,{heading:(0,c._t)("settings|notifications|quick_actions_section")},p&&o.createElement(ae.A,{kind:"primary_outline",disabled:m,onClick:async()=>{h(!0),await(0,dr.XC)(t),h(!1)}},(0,c._t)("settings|notifications|quick_actions_mark_all_read")),o.createElement(ae.A,{kind:"danger_outline",disabled:null===s,onClick:()=>{l(cF)}},(0,c._t)("settings|notifications|quick_actions_reset")))));var v}class xF extends o.Component{render(){const e=O.A.getValue(yx.O5.NotificationSettings2);return o.createElement(No.A,null,e?o.createElement(SF,null):o.createElement(Do.X,null,o.createElement(eF,null)))}}class AF extends o.Component{constructor(e){super(e),(0,S.A)(this,"onSearchChange",e=>{this.setState({searchQuery:e})}),this.state={searchQuery:"",langs:null}}componentDidMount(){if(c.om().then(e=>{e.sort(function(e,t){return e.labelInTargetLanguage<t.labelInTargetLanguage?-1:e.labelInTargetLanguage>t.labelInTargetLanguage?1:0}),this.setState({langs:e})}).catch(()=>{this.setState({langs:[{value:"en",label:"English",labelInTargetLanguage:"English"}]})}),!this.props.value){const e=c.mf();this.props.onOptionChange(e)}}render(){if(null===this.state.langs)return o.createElement(le.A,null);let e;e=this.state.searchQuery?this.state.langs.filter(e=>{return t=this.state.searchQuery,!!(n=e).labelInTargetLanguage.toUpperCase().includes(t.toUpperCase())||!!n.label.toUpperCase().includes(t.toUpperCase())||n.value.toUpperCase()===t.toUpperCase();var t,n}):this.state.langs;const t=e.map(e=>o.createElement("div",{key:e.value},e.labelInTargetLanguage));return o.createElement(Fp.A,{id:"mx_LanguageDropdown",className:me()("mx_LanguageDropdown",this.props.className),onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:this.props.value,label:(0,c._t)("language_dropdown_label"),disabled:this.props.disabled},t)}}class CF extends o.Component{constructor(e){super(e),this.onSearchChange=this.onSearchChange.bind(this),this.state={searchQuery:""}}componentDidMount(){const e=l.A.get();if(e){var t;const n=new Intl.DisplayNames([(0,c.mf)()],{type:"language",style:"short"});null===(t=e.getAvailableSpellCheckLanguages())||void 0===t||t.then(e=>{e.sort(function(e,t){return e<t?-1:e>t?1:0});const t=[];e.forEach(e=>{t.push({label:n.of(e),value:e})}),this.setState({languages:t})}).catch(e=>{this.setState({languages:[{value:"en",label:n.of("en")}]})})}}onSearchChange(e){this.setState({searchQuery:e})}render(){if(!this.state.languages)return o.createElement(le.A,null);let e;e=this.state.searchQuery?this.state.languages.filter(e=>{return t=this.state.searchQuery,!!(n=e).label.toUpperCase().includes(t.toUpperCase())||n.value.toUpperCase()===t.toUpperCase();var t,n}):this.state.languages;const t=e.map(e=>o.createElement("div",{key:e.value},e.label));return o.createElement(Fp.A,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:this.props.value,label:(0,c._t)("language_dropdown_label"),placeholder:(0,c._t)("settings|general|spell_check_locale_placeholder")},t)}}class kF extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"onRemove",e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language)))}render(){var e;return o.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},o.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},null!==(e=this.props.label)&&void 0!==e?e:this.props.language),o.createElement(ae.A,{onClick:this.onRemove,kind:"danger_sm"},(0,c._t)("action|remove")))}}class RF extends o.Component{constructor(e){super(e),(0,S.A)(this,"onRemoved",e=>{const t=this.props.languages.filter(t=>t!==e);this.props.onLanguagesChange(t)}),(0,S.A)(this,"onAddClick",e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;this.setState({newLanguage:""}),t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))}),(0,S.A)(this,"onNewLanguageChange",e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})}),this.state={newLanguage:""}}render(){const e=new Intl.DisplayNames([(0,c.mf)()],{type:"language",style:"short"}),t=this.props.languages.map(t=>o.createElement(kF,{language:t,label:e.of(t),onRemoved:this.onRemoved,key:t})),n=o.createElement(ae.A,{onClick:this.onAddClick,kind:"primary"},(0,c._t)("action|add"));return o.createElement(o.Fragment,null,t,o.createElement("form",{onSubmit:this.onAddClick,noValidate:!0},o.createElement(CF,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this.onNewLanguageChange}),n))}}var IF=n("./src/components/views/settings/tabs/user/MediaPreviewAccountSettings.tsx");const TF=()=>{const e=(0,Qt.ti)("inviteRules"),t=O.A.disabledMessage("inviteRules"),[n,i]=(0,o.useState)(!1),r=(0,o.useCallback)(async e=>{try{i(!0),await O.A.setValue("inviteRules",null,F.p.ACCOUNT,{allBlocked:!e})}catch(e){s.vF.error("Unable to set invite rules",e)}finally{i(!1)}},[]);return o.createElement(AS.b,{className:"mx_MediaPreviewAccountSetting_Form"},o.createElement(Ko.A,{className:"mx_MediaPreviewAccountSetting_ToggleSwitch",label:(0,c._t)("settings|invite_controls|default_label"),value:!e.allBlocked,onChange:r,tooltip:t,disabled:!!t||n}))},PF=()=>{const[e,t]=(0,o.useState)((0,c.UK)()),n=(0,o.useCallback)(n=>{if(e===n)return;O.A.setValue("language",null,F.p.DEVICE,n),t(n);const i=l.A.get();i&&(i.setLanguage([n]),i.reload())},[e]);return o.createElement("div",{className:"mx_SettingsSubsection_dropdown"},(0,c._t)("settings|general|application_language"),o.createElement(AF,{onOptionChange:n,value:e}),o.createElement("div",{className:"mx_PreferencesUserSettingsTab_section_hint"},(0,c._t)("settings|general|application_language_reload_hint")))},NF=()=>{var e;const[t,n]=(0,o.useState)(),[i,r]=(0,o.useState)();(0,o.useEffect)(()=>{(async()=>{const e=l.A.get(),[t,i]=await Promise.all([null==e?void 0:e.getSpellCheckEnabled(),null==e?void 0:e.getSpellCheckLanguages()]);n(t),r(i||void 0)})()},[]);const s=(0,o.useCallback)(e=>{var t;n(e),null===(t=l.A.get())||void 0===t||t.setSpellCheckEnabled(e)},[]),a=(0,o.useCallback)(e=>{var t;r(e),null===(t=l.A.get())||void 0===t||t.setSpellCheckLanguages(e)},[]);return null!==(e=l.A.get())&&void 0!==e&&e.supportsSpellCheckSettings()?o.createElement(o.Fragment,null,o.createElement(Ko.A,{label:(0,c._t)("settings|general|allow_spellcheck"),value:Boolean(t),onChange:s}),t&&void 0!==i&&!bi.vL&&o.createElement(RF,{languages:i,onLanguagesChange:a})):null};class DF extends o.Component{constructor(e){super(e),(0,S.A)(this,"onTimezoneChange",e=>{this.setState({timezone:e}),_S.nY(e)}),(0,S.A)(this,"onTimezoneSearchChange",e=>{const t=e.toLowerCase(),n=t?_S.QG().filter(e=>e.toLowerCase().includes(t)):_S.QG();this.setState({timezones:n,timezoneSearch:t})}),(0,S.A)(this,"onAutocompleteDelayChange",e=>{this.setState({autocompleteDelay:e.target.value}),O.A.setValue("autocompleteDelay",null,F.p.DEVICE,e.target.value)}),(0,S.A)(this,"onReadMarkerInViewThresholdMs",e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),O.A.setValue("readMarkerInViewThresholdMs",null,F.p.DEVICE,e.target.value)}),(0,S.A)(this,"onReadMarkerOutOfViewThresholdMs",e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),O.A.setValue("readMarkerOutOfViewThresholdMs",null,F.p.DEVICE,e.target.value)}),(0,S.A)(this,"onKeyboardShortcutsClicked",()=>{x.A.dispatch({action:W.r.ViewUserSettings,initialTabId:We.v.Keyboard})}),this.state={timezone:_S.dB(),timezones:_S.QG(),timezoneSearch:void 0,autocompleteDelay:O.A.getValueAt(F.p.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:O.A.getValueAt(F.p.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:O.A.getValueAt(F.p.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}renderGroup(e,t=F.p.ACCOUNT){return o.createElement(o.Fragment,null,e.map(e=>o.createElement(tO.A,{key:e,name:e,level:t})))}render(){const e=(0,c._t)("settings|preferences|default_timezone",{timezone:_S.cf()}),t=O.A.getValue("feature_new_room_list"),n=this.state.timezones.map(e=>o.createElement("div",{key:e},e));return n.unshift(o.createElement("div",{key:""},e)),o.createElement(No.A,null,o.createElement(Do.X,null,o.createElement(Mo.P,{heading:(0,c._t)("settings|general|language_section")},o.createElement(PF,null),o.createElement(NF,null)),o.createElement(Mo.P,{heading:(0,c._t)("settings|preferences|room_list_heading")},this.renderGroup(DF.ROOM_LIST_SETTINGS),t&&o.createElement(tO.A,{name:"RoomList.showMessagePreview",level:F.p.DEVICE})),o.createElement(Mo.P,{heading:(0,c._t)("common|spaces")},this.renderGroup(DF.SPACES_SETTINGS,F.p.ACCOUNT)),o.createElement(Mo.P,{heading:(0,c._t)("settings|preferences|keyboard_heading"),description:(0,c._t)("settings|preferences|keyboard_view_shortcuts_button",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.onKeyboardShortcutsClicked},e)})},this.renderGroup(DF.KEYBINDINGS_SETTINGS)),o.createElement(Mo.P,{heading:(0,c._t)("settings|preferences|time_heading")},o.createElement("div",{className:"mx_SettingsSubsection_dropdown"},(0,c._t)("settings|preferences|user_timezone"),o.createElement(Fp.A,{id:"mx_dropdownUserTimezone",className:"mx_dropdownUserTimezone",searchEnabled:!0,value:this.state.timezone,label:(0,c._t)("settings|preferences|user_timezone"),placeholder:e,onOptionChange:this.onTimezoneChange,onSearchChange:this.onTimezoneSearchChange},n)),this.renderGroup(DF.TIME_SETTINGS),o.createElement(tO.A,{name:"userTimezonePublish",level:F.p.DEVICE})),o.createElement(Mo.P,{heading:(0,c._t)("common|presence"),description:(0,c._t)("settings|preferences|presence_description")},this.renderGroup(DF.PRESENCE_SETTINGS)),o.createElement(Mo.P,{heading:(0,c._t)("settings|preferences|composer_heading")},this.renderGroup(DF.COMPOSER_SETTINGS)),o.createElement(Mo.P,{heading:(0,c._t)("settings|preferences|code_blocks_heading")},this.renderGroup(DF.CODE_BLOCKS_SETTINGS)),o.createElement(Mo.P,{heading:(0,c._t)("settings|preferences|media_heading")},this.renderGroup(DF.IMAGES_AND_VIDEOS_SETTINGS)),o.createElement(Mo.P,{heading:(0,c._t)("common|timeline")},this.renderGroup(DF.TIMELINE_SETTINGS)),o.createElement(Mo.P,{heading:(0,c._t)("common|moderation_and_safety"),legacy:!1},o.createElement(IF.H,null),o.createElement(TF,null)),o.createElement(Mo.P,{heading:(0,c._t)("settings|preferences|room_directory_heading")},this.renderGroup(DF.ROOM_DIRECTORY_SETTINGS)),o.createElement(Mo.P,{heading:(0,c._t)("common|general"),stretchContent:!0},this.renderGroup(DF.GENERAL_SETTINGS),o.createElement(tO.A,{name:"Electron.showTrayIcon",level:F.p.PLATFORM,hideIfCannotSet:!0}),o.createElement(tO.A,{name:"Electron.enableHardwareAcceleration",level:F.p.PLATFORM,hideIfCannotSet:!0,label:(0,c._t)("settings|preferences|Electron.enableHardwareAcceleration",{appName:d.Ay.get().brand})}),o.createElement(tO.A,{name:"Electron.enableContentProtection",level:F.p.PLATFORM,hideIfCannotSet:!0,label:(0,c._t)("settings|preferences|Electron.enableContentProtection")}),o.createElement(tO.A,{name:"Electron.alwaysShowMenuBar",level:F.p.PLATFORM,hideIfCannotSet:!0}),o.createElement(tO.A,{name:"Electron.autoLaunch",level:F.p.PLATFORM,hideIfCannotSet:!0}),o.createElement(tO.A,{name:"Electron.warnBeforeExit",level:F.p.PLATFORM,hideIfCannotSet:!0}),o.createElement(wo.A,{label:(0,c._t)("settings|preferences|autocomplete_delay"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),o.createElement(wo.A,{label:(0,c._t)("settings|preferences|rm_lifetime"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),o.createElement(wo.A,{label:(0,c._t)("settings|preferences|rm_lifetime_offscreen"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs}))))}}(0,S.A)(DF,"ROOM_LIST_SETTINGS",["breadcrumbs"]),(0,S.A)(DF,"SPACES_SETTINGS",["Spaces.allRoomsInHome"]),(0,S.A)(DF,"KEYBINDINGS_SETTINGS",["ctrlFForSearch"]),(0,S.A)(DF,"PRESENCE_SETTINGS",["sendReadReceipts","sendTypingNotifications"]),(0,S.A)(DF,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.useMarkdown","MessageComposerInput.suggestEmoji","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.surroundWith","MessageComposerInput.showStickersButton","MessageComposerInput.insertTrailingColon"]),(0,S.A)(DF,"TIME_SETTINGS",["showTwelveHourTimestamps","alwaysShowTimestamps"]),(0,S.A)(DF,"CODE_BLOCKS_SETTINGS",["enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers"]),(0,S.A)(DF,"IMAGES_AND_VIDEOS_SETTINGS",["urlPreviewsEnabled","autoplayGifs","autoplayVideo"]),(0,S.A)(DF,"TIMELINE_SETTINGS",["showTypingNotifications","showRedactions","showReadReceipts","showJoinLeaves","showDisplaynameChanges","showChatEffects","showAvatarChanges","Pill.shouldShowPillAvatar","TextualBody.enableBigEmoji","scrollToBottomOnMessageSent","useOnlyCurrentProfiles"]),(0,S.A)(DF,"ROOM_DIRECTORY_SETTINGS",["SpotlightSearch.showNsfwPublicRooms"]),(0,S.A)(DF,"GENERAL_SETTINGS",["promptBeforeInviteUnknownUsers"]);const MF=e=>{switch(e){case Da.cm.AudioOutput:return Da.Ay.getAudioOutput();case Da.cm.AudioInput:return Da.Ay.getAudioInput();case Da.cm.VideoInput:return Da.Ay.getVideoInput()}};class OF extends o.Component{constructor(e){super(e),(0,S.A)(this,"refreshMediaDevices",async e=>{var t;this.setState({mediaDevices:null!==(t=await Da.Ay.getDevices())&&void 0!==t?t:null,[Da.cm.AudioOutput]:MF(Da.cm.AudioOutput),[Da.cm.AudioInput]:MF(Da.cm.AudioInput),[Da.cm.VideoInput]:MF(Da.cm.VideoInput)}),e&&e.getTracks().forEach(e=>e.stop())}),(0,S.A)(this,"requestMediaPermissions",async()=>{const e=await(async(e=!0)=>{let t,n;try{t=await navigator.mediaDevices.getUserMedia({audio:!0,video:e})}catch(i){if(e&&"NotFoundError"===i.name)try{t=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){n=e}else n=i}if(n){s.vF.log("Failed to list userMedia devices",n);const e=d.Ay.get().brand;R.Ay.createDialog(Ht.A,{title:(0,c._t)("voip|no_media_perms_title"),description:(0,c._t)("voip|no_media_perms_description",{brand:e})})}return t})();e&&await this.refreshMediaDevices(e)}),(0,S.A)(this,"setDevice",async(e,t)=>{this.setState({[t]:e});try{await Da.Ay.instance.setDevice(e,t)}catch{s.vF.error(`Failed to set device ${t}: ${e}`),this.setState({[t]:MF(t)})}}),(0,S.A)(this,"changeWebRtcMethod",e=>{this.context.setForceTURN(!e)}),this.state={mediaDevices:null,[Da.cm.AudioOutput]:null,[Da.cm.AudioInput]:null,[Da.cm.VideoInput]:null,audioAutoGainControl:Da.Ay.getAudioAutoGainControl(),audioEchoCancellation:Da.Ay.getAudioEchoCancellation(),audioNoiseSuppression:Da.Ay.getAudioNoiseSuppression()}}async componentDidMount(){await Da.Ay.hasAnyLabeledDevices()&&await this.refreshMediaDevices()}renderDeviceOptions(e,t){return e.map(e=>o.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label))}renderDropdown(e,t){var n;const i=null===(n=this.state.mediaDevices)||void 0===n?void 0:n[e].slice(0);if(null==i||!i.length)return null;const r=Da.Ay.getDefaultDevice(i);return o.createElement(wo.A,{element:"select",label:t,value:this.state[e]||r,onChange:t=>this.setDevice(t.target.value,e)},this.renderDeviceOptions(i,e))}render(){let e,t,n,i;return this.state.mediaDevices?this.state.mediaDevices&&(t=this.renderDropdown(Da.cm.AudioOutput,(0,c._t)("settings|voip|audio_output"))||o.createElement("p",null,(0,c._t)("settings|voip|audio_output_empty")),n=this.renderDropdown(Da.cm.AudioInput,(0,c._t)("common|microphone"))||o.createElement("p",null,(0,c._t)("settings|voip|audio_input_empty")),i=this.renderDropdown(Da.cm.VideoInput,(0,c._t)("common|camera"))||o.createElement("p",null,(0,c._t)("settings|voip|video_input_empty"))):e=o.createElement("div",null,o.createElement("p",null,(0,c._t)("settings|voip|missing_permissions_prompt")),o.createElement(ae.A,{onClick:this.requestMediaPermissions,kind:"primary"},(0,c._t)("settings|voip|request_permissions"))),o.createElement(No.A,null,o.createElement(Do.X,null,e,o.createElement(Mo.P,{heading:(0,c._t)("settings|voip|voice_section"),stretchContent:!0},t,n,o.createElement(Ko.A,{value:this.state.audioAutoGainControl,onChange:async e=>{await Da.Ay.setAudioAutoGainControl(e),this.setState({audioAutoGainControl:Da.Ay.getAudioAutoGainControl()})},label:(0,c._t)("settings|voip|voice_agc")})),o.createElement(Mo.P,{heading:(0,c._t)("settings|voip|video_section"),stretchContent:!0},i,o.createElement(tO.A,{name:"VideoView.flipVideoHorizontally",level:F.p.ACCOUNT}))),o.createElement(Do.X,{heading:(0,c._t)("common|advanced")},o.createElement(Mo.P,{heading:(0,c._t)("settings|voip|voice_processing")},o.createElement(Ko.A,{value:this.state.audioNoiseSuppression,onChange:async e=>{await Da.Ay.setAudioNoiseSuppression(e),this.setState({audioNoiseSuppression:Da.Ay.getAudioNoiseSuppression()})},label:(0,c._t)("settings|voip|noise_suppression")}),o.createElement(Ko.A,{value:this.state.audioEchoCancellation,onChange:async e=>{await Da.Ay.setAudioEchoCancellation(e),this.setState({audioEchoCancellation:Da.Ay.getAudioEchoCancellation()})},label:(0,c._t)("settings|voip|echo_cancellation")})),o.createElement(Mo.P,{heading:(0,c._t)("settings|voip|connection_section")},o.createElement(tO.A,{name:"webRtcAllowPeerToPeer",level:F.p.DEVICE,onChange:this.changeWebRtcMethod}),o.createElement(tO.A,{name:"fallbackICEServerAllowed",label:(0,c._t)("settings|voip|enable_fallback_ice_server",{server:new URL(nn.ZB).pathname}),level:F.p.DEVICE,hideIfCannotSet:!0}))))}}(0,S.A)(OF,"contextType",ce.Ay);const FF=["action"];function LF(){var e;null===(e=l.A.get())||void 0===e||e.installUpdate()}const UF=[Ft.Kn.Ready,Ft.Kn.Error,Ft.Kn.NotAvailable],BF=()=>{const[e,t]=(0,o.useState)(null);(0,Lo.F)(x.A,e=>{let{action:n}=e,i=(0,v.A)(e,FF);n===W.r.CheckUpdates&&t(i)});const n=!!e&&!UF.includes(e.status);let i;return e&&(i=o.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case Ft.Kn.Error:return(0,c._t)("update|error_encountered",{errorDetail:t});case Ft.Kn.Checking:return(0,c._t)("update|checking");case Ft.Kn.NotAvailable:return(0,c._t)("update|no_update");case Ft.Kn.Downloading:return(0,c._t)("update|downloading");case Ft.Kn.Ready:return(0,c._t)("update|new_version_available",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:LF},e)})}}(e.status,e.detail),n&&o.createElement(tl.A,null))),o.createElement(o.Fragment,null,o.createElement(ae.A,{onClick:()=>{var e;t(null),null===(e=l.A.get())||void 0===e||e.startUpdateCheck()},kind:"primary_outline",disabled:n},(0,c._t)("update|check_action")),i)};class VF extends o.Component{constructor(e){super(e),(0,S.A)(this,"onClearCacheAndReload",()=>{l.A.get()&&(s.vF.log("Clear cache & reload clicked"),this.context.stopClient(),this.context.store.deleteAllData().then(()=>{var e;null===(e=l.A.get())||void 0===e||e.reload()}))}),(0,S.A)(this,"onBugReport",()=>{R.Ay.createDialog(Gt.A,{})}),(0,S.A)(this,"getVersionTextToCopy",()=>{const{appVersion:e,cryptoVersion:t}=this.getVersionInfo();return`${e}\n${t}`}),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){var e,t;null===(e=l.A.get())||void 0===e||e.getAppVersion().then(e=>this.setState({appVersion:e})).catch(e=>{s.vF.error("Error getting vector version: ",e)}),null===(t=l.A.get())||void 0===t||t.canSelfUpdate().then(e=>this.setState({canUpdate:e})).catch(e=>{s.vF.error("Error getting self updatability: ",e)})}getVersionInfo(){var e,t;const n=d.Ay.get().brand,i=this.state.appVersion||"unknown",r=null!==(e=null===(t=this.context.getCrypto())||void 0===t?void 0:t.getVersion())&&void 0!==e?e:"<not-enabled>";return{appVersion:`${(0,c._t)("setting|help_about|brand_version",{brand:n})} ${i}`,cryptoVersion:`${(0,c._t)("setting|help_about|crypto_version")} ${r}`}}renderLegal(){const e=d.Ay.get().terms_and_conditions_links;if(!e)return null;const t=[];for(const n of e)t.push(o.createElement("div",{key:n.url},o.createElement(Hp.A,{href:n.url},n.text)));return o.createElement(Mo.P,{heading:(0,c._t)("common|legal")},o.createElement(Mo.s,null,t))}renderCredits(){return o.createElement(Mo.P,{heading:(0,c._t)("common|credits")},o.createElement(Mo.s,null,o.createElement("ul",null,o.createElement("li",null,(0,c._t)("credits|default_cover_photo",{},{photo:e=>o.createElement(Hp.A,{href:"themes/element/img/backgrounds/lake.jpg",rel:"noreferrer noopener",target:"_blank"},e),author:e=>o.createElement(Hp.A,{href:"https://www.flickr.com/golan"},e),terms:e=>o.createElement(Hp.A,{href:"https://creativecommons.org/licenses/by-sa/4.0/",rel:"noreferrer noopener",target:"_blank"},e)})),o.createElement("li",null,(0,c._t)("credits|twemoji_colr",{},{colr:e=>o.createElement(Hp.A,{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},e),author:e=>o.createElement(Hp.A,{href:"https://mozilla.org"},e),terms:e=>o.createElement(Hp.A,{href:"https://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},e)})),o.createElement("li",null,(0,c._t)("credits|twemoji",{},{twemoji:e=>o.createElement(Hp.A,{href:"https://twemoji.twitter.com/"},e),author:e=>o.createElement(Hp.A,{href:"https://twemoji.twitter.com/"},e),terms:e=>o.createElement(Hp.A,{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},e)})))))}render(){const e=d.Ay.get().brand,t=(0,c._t)("setting|help_about|help_link",{brand:e},{a:e=>o.createElement(Hp.A,{href:d.Ay.get("help_url")},e)});let n,i;this.state.canUpdate&&(n=o.createElement(BF,null)),d.Ay.get().bug_report_endpoint_url&&(i=o.createElement(Mo.P,{heading:(0,c._t)("bug_reporting|title"),description:o.createElement(o.Fragment,null,o.createElement(Mo.s,null,(0,c._t)("bug_reporting|introduction")),(0,c._t)("bug_reporting|description"))},o.createElement(ae.A,{onClick:this.onBugReport,kind:"primary_outline"},(0,c._t)("bug_reporting|submit_debug_logs")),o.createElement(Mo.s,null,(0,c._t)("bug_reporting|matrix_security_issue",{},{a:e=>o.createElement(Hp.A,{href:"https://matrix.org/security-disclosure-policy/"},e)}))));const{appVersion:r,cryptoVersion:s}=this.getVersionInfo();return o.createElement(No.A,null,o.createElement(Do.X,null,i,o.createElement(Mo.P,{heading:(0,c._t)("common|faq"),description:t}),o.createElement(Mo.P,{heading:(0,c._t)("setting|help_about|versions")},o.createElement(Mo.s,null,o.createElement(dM.A,{getTextToCopy:this.getVersionTextToCopy},r,o.createElement("br",null),s,o.createElement("br",null)),n)),this.renderLegal(),this.renderCredits(),o.createElement(Mo.P,{heading:(0,c._t)("common|advanced")},o.createElement(Mo.s,null,(0,c._t)("setting|help_about|homeserver",{homeserverUrl:this.context.getHomeserverUrl()},{code:e=>o.createElement("code",null,e)})),this.context.getIdentityServerUrl()&&o.createElement(Mo.s,null,(0,c._t)("setting|help_about|identity_server",{identityServerUrl:this.context.getIdentityServerUrl()},{code:e=>o.createElement("code",null,e)})),o.createElement(Mo.s,null,o.createElement("details",null,o.createElement("summary",{className:"mx_HelpUserSettingsTab_accessTokenDetails"},(0,c._t)("common|access_token")),o.createElement("strong",null,(0,c._t)("setting|help_about|access_token_detail")),o.createElement(dM.A,{getTextToCopy:()=>this.context.getAccessToken()},this.context.getAccessToken()))),o.createElement(ae.A,{onClick:this.onClearCacheAndReload,kind:"danger_outline"},(0,c._t)("setting|help_about|clear_cache_reload")))))}}(0,S.A)(VF,"contextType",ce.Ay);var jF=n("./src/mjolnir/BanList.ts");class zF extends o.Component{constructor(e){super(e),(0,S.A)(this,"onPersonalRuleChanged",e=>{this.setState({newPersonalRule:e.target.value})}),(0,S.A)(this,"onNewListChanged",e=>{this.setState({newList:e.target.value})}),(0,S.A)(this,"onAddPersonalRule",async e=>{e.preventDefault(),e.stopPropagation();let t=jF.fy;this.state.newPersonalRule.startsWith("@")&&(t=jF.ZZ),this.setState({busy:!0});try{const e=await B.u.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,(0,c._t)("labs_mjolnir|ban_reason")),this.setState({newPersonalRule:""})}catch(e){s.vF.error(e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("labs_mjolnir|error_adding_ignore"),description:(0,c._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}}),(0,S.A)(this,"onSubscribeList",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await f.J.safeGet().joinRoom(this.state.newList);await B.u.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){s.vF.error(e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("labs_mjolnir|error_adding_list_title"),description:(0,c._t)("labs_mjolnir|error_adding_list_description")})}finally{this.setState({busy:!1})}}),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=B.u.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){s.vF.error(e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("labs_mjolnir|error_removing_ignore"),description:(0,c._t)("labs_mjolnir|something_went_wrong")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await B.u.sharedInstance().unsubscribeFromList(e.roomId),await f.J.safeGet().leave(e.roomId)}catch(e){s.vF.error(e),R.Ay.createDialog(Ht.A,{title:(0,c._t)("labs_mjolnir|error_removing_list_title"),description:(0,c._t)("labs_mjolnir|error_removing_list_description")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=f.J.safeGet().getRoom(e.roomId),n=t?t.name:e.roomId,i=e=>{if(0===e.length)return o.createElement("i",null,(0,c._t)("labs_mjolnir|rules_empty"));const t=[];for(const n of e)t.push(o.createElement("li",{key:n.kind+n.entity},o.createElement("code",null,n.entity)));return o.createElement("ul",null,t)};R.Ay.createDialog(Wt.A,{title:(0,c._t)("labs_mjolnir|rules_title",{roomName:n}),description:o.createElement("div",null,o.createElement("h3",null,(0,c._t)("labs_mjolnir|rules_server")),i(e.serverRules),o.createElement("h3",null,(0,c._t)("labs_mjolnir|rules_user")),i(e.userRules)),button:(0,c._t)("action|close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=B.u.sharedInstance().getPersonalList(),t=e?[...e.userRules,...e.serverRules]:[];if(!e||t.length<=0)return o.createElement("i",null,(0,c._t)("labs_mjolnir|personal_empty"));const n=[];for(const e of t)n.push(o.createElement("li",{key:e.entity,className:"mx_MjolnirUserSettingsTab_listItem"},o.createElement(ae.A,{kind:"danger_sm",onClick:()=>this.removePersonalRule(e),disabled:this.state.busy},(0,c._t)("action|remove")),"",o.createElement("code",null,e.entity)));return o.createElement("div",null,o.createElement("p",null,(0,c._t)("labs_mjolnir|personal_section")),o.createElement("ul",null,n))}renderSubscribedBanLists(){const e=B.u.sharedInstance().getPersonalList(),t=B.u.sharedInstance().lists.filter(t=>!e||e.roomId!==t.roomId);if(!t||t.length<=0)return o.createElement("i",null,(0,c._t)("labs_mjolnir|no_lists"));const n=[];for(const e of t){const t=f.J.safeGet().getRoom(e.roomId),i=t?o.createElement("span",null,t.name," (",o.createElement("code",null,e.roomId),")"):o.createElement("code",null,"list.roomId");n.push(o.createElement("li",{key:e.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},o.createElement(ae.A,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(e),disabled:this.state.busy},(0,c._t)("action|unsubscribe")),"",o.createElement(ae.A,{kind:"primary_sm",onClick:()=>this.viewListRules(e),disabled:this.state.busy},(0,c._t)("labs_mjolnir|view_rules")),"",i))}return o.createElement("div",null,o.createElement("p",null,(0,c._t)("labs_mjolnir|lists")),o.createElement("ul",null,n))}render(){const e=d.Ay.get().brand;return o.createElement(No.A,null,o.createElement(Do.X,null,o.createElement(Mo.s,null,o.createElement("strong",{className:"warning"},(0,c._t)("labs_mjolnir|advanced_warning")),o.createElement("p",null,(0,c._t)("labs_mjolnir|explainer_1",{brand:e},{code:e=>o.createElement("code",null,e)})),o.createElement("p",null,(0,c._t)("labs_mjolnir|explainer_2"))),o.createElement(Mo.P,{heading:(0,c._t)("labs_mjolnir|personal_heading"),description:(0,c._t)("labs_mjolnir|personal_description",{myBanList:(0,c._t)("labs_mjolnir|room_name")})},this.renderPersonalBanListRules(),o.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},o.createElement(wo.A,{type:"text",label:(0,c._t)("labs_mjolnir|personal_new_label"),placeholder:(0,c._t)("labs_mjolnir|personal_new_placeholder"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),o.createElement(ae.A,{kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},(0,c._t)("action|ignore")))),o.createElement(Mo.P,{heading:(0,c._t)("labs_mjolnir|lists_heading"),description:o.createElement(o.Fragment,null,o.createElement("strong",{className:"warning"},(0,c._t)("labs_mjolnir|lists_description_1")),"",o.createElement("span",null,(0,c._t)("labs_mjolnir|lists_description_2")))},this.renderSubscribedBanLists(),o.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},o.createElement(wo.A,{type:"text",label:(0,c._t)("labs_mjolnir|lists_new_label"),value:this.state.newList,onChange:this.onNewListChanged}),o.createElement(ae.A,{kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},(0,c._t)("action|subscribe"))))))}}var HF=n("./src/accessibility/KeyboardShortcutUtils.ts");const WF=Object.entries(Ei.R6).filter(([e])=>e!==Ei.md.LABS||iO()),GF=({name:e})=>{const t=(0,HF.Lt)(e),n=(0,HF.Tz)(e);return t&&n?o.createElement("li",{className:"mx_KeyboardShortcut_shortcutRow"},t,o.createElement(vg.S,{value:n})):null},KF=({categoryName:e,category:t})=>t.categoryLabel?o.createElement(Mo.P,{heading:(0,c._t)(t.categoryLabel),key:e},o.createElement("ul",{className:"mx_KeyboardShortcut_shortcutList"},t.settingNames.map(e=>o.createElement(GF,{key:e,name:e})))):null,qF=()=>o.createElement(No.A,null,o.createElement(Do.X,null,WF.map(([e,t])=>o.createElement(KF,{key:e,categoryName:e,category:t})))),$F=["value","options","selectedLabel","className"],JF=(e,t)=>n=>{const i=e.find(({id:e})=>e===n);return i?t?`${t}: ${i.label}`:i.label:null},YF=e=>{let{value:t,options:n,selectedLabel:i,className:r}=e,s=(0,v.A)(e,$F);return o.createElement(Fp.A,(0,tn.A)({},s,{value:t,className:me()("mx_FilterDropdown",r),getShortOption:JF(n,i)}),n.map(({id:e,label:n,description:i})=>o.createElement("div",{className:"mx_FilterDropdown_option",key:e},e===t&&o.createElement(ke.A,{className:"mx_FilterDropdown_optionSelectedIcon"}),o.createElement("span",{className:"mx_FilterDropdown_optionLabel"},n),!!i&&o.createElement("span",{className:"mx_FilterDropdown_optionDescription"},i))))};var XF=n("./src/components/views/elements/ToggleSwitch.tsx");const QF=["title","description"],ZF=e=>{let{title:t,description:n}=e,i=(0,v.A)(e,QF);return o.createElement(ae.A,(0,tn.A)({},i,{kind:"link_inline",onClick:()=>{R.Ay.createDialog(zp.A,{title:t,description:n,button:(0,c._t)("action|got_it"),hasCloseButton:!0})},className:"mx_LearnMore_button"}),(0,c._t)("action|learn_more"))},eL=({device:e,saveDeviceName:t,stopEditing:n})=>{const[i,r]=(0,o.useState)(e.display_name||""),[s,a]=(0,o.useState)(!1),[l,d]=(0,o.useState)(null);(0,o.useEffect)(()=>{r(e.display_name||"")},[e.display_name]);const u=async e=>{a(!0),d(null),e.preventDefault();try{await t(i),n()}catch{d((0,c._t)("settings|sessions|error_set_name")),a(!1)}},m=`device-rename-${e.device_id}`,h=`device-rename-description-${e.device_id}`;return o.createElement("form",{"aria-disabled":s,className:"mx_DeviceDetailHeading_renameForm",onSubmit:u,method:"post"},o.createElement("p",{id:m,className:"mx_DeviceDetailHeading_renameFormHeading"},(0,c._t)("settings|sessions|rename_form_heading")),o.createElement("div",null,o.createElement(wo.A,{type:"text",value:i,autoComplete:"off",onChange:e=>r(e.target.value),autoFocus:!0,disabled:s,"aria-labelledby":m,"aria-describedby":h,className:"mx_DeviceDetailHeading_renameFormInput",maxLength:100}),o.createElement(zO.H,{id:h},(0,c._t)("settings|sessions|rename_form_caption"),o.createElement(ZF,{title:(0,c._t)("settings|sessions|rename_form_learn_more"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("settings|sessions|rename_form_learn_more_description_1")),o.createElement("p",null,(0,c._t)("settings|sessions|rename_form_learn_more_description_2")))}),!!l&&o.createElement("span",{className:"mx_DeviceDetailHeading_renameFormError"},l))),o.createElement("div",{className:"mx_DeviceDetailHeading_renameFormButtons"},o.createElement(ae.A,{onClick:u,kind:"primary",disabled:s},(0,c._t)("action|save")),o.createElement(ae.A,{onClick:n,kind:"secondary",disabled:s},(0,c._t)("action|cancel")),s&&o.createElement(le.A,{w:16,h:16})))},tL=({device:e,saveDeviceName:t})=>{const[n,i]=(0,o.useState)(!1);return n?o.createElement(eL,{device:e,saveDeviceName:t,stopEditing:()=>i(!1)}):o.createElement("div",{className:"mx_DeviceDetailHeading"},o.createElement(uC.A,{size:"4"},e.display_name||e.device_id),o.createElement(ae.A,{kind:"link_inline",onClick:()=>i(!0),className:"mx_DeviceDetailHeading_renameCta"},(0,c._t)("action|rename")))};var nL;function iL(){return iL=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},iL.apply(null,arguments)}var rL=function(e,t){return o.createElement("svg",iL({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0,ref:t},e),nL||(nL=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 3.05v6.22C2 15.63 9 17 9 17s7-1.37 7-7.73V3.05L9 1zm9.94 2.47c.19-.18.49-.17.67.02.16.18.16.45.02.63l-4.22 5.11-.03.04c-.28.34-.79.39-1.13.11a.3.3 0 0 1-.077-.067l-.023-.023-1.81-2.08c-.2-.24-.18-.6.06-.8.2-.18.49-.18.7-.04l1.57 1.1z",clipRule:"evenodd"})))},oL=(0,o.forwardRef)(rL);var sL=n("./res/img/e2e/warning.svg");const aL={[dt.Inactive]:ct,[dt.Verified]:oL,[dt.Unverified]:sL.I,[dt.Unverifiable]:sL.I},lL=({variation:e})=>{const t=aL[e];return o.createElement("div",{className:me()("mx_DeviceSecurityCard_icon",e)},o.createElement(t,{height:16,width:16}))},cL=({variation:e,heading:t,description:n,children:i})=>o.createElement("div",{className:"mx_DeviceSecurityCard"},o.createElement(lL,{variation:e}),o.createElement("div",{className:"mx_DeviceSecurityCard_content"},o.createElement("p",{className:"mx_DeviceSecurityCard_heading"},t),o.createElement("p",{className:"mx_DeviceSecurityCard_description"},n),!!i&&o.createElement("div",{className:"mx_DeviceSecurityCard_actions"},i))),dL={[dt.Verified]:{title:(0,c._t)("settings|sessions|verified_sessions"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("settings|sessions|verified_sessions_explainer_1")),o.createElement("p",null,(0,c._t)("settings|sessions|verified_sessions_explainer_2")))},[dt.Unverified]:{title:(0,c._t)("settings|sessions|unverified_sessions"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("settings|sessions|unverified_sessions_explainer_1")),o.createElement("p",null,(0,c._t)("settings|sessions|unverified_sessions_explainer_2")))},[dt.Unverifiable]:{title:(0,c._t)("settings|sessions|unverified_session"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("settings|sessions|unverified_session_explainer_1")),o.createElement("p",null,(0,c._t)("settings|sessions|unverified_session_explainer_2")),o.createElement("p",null,(0,c._t)("settings|sessions|unverified_session_explainer_3")))},[dt.Inactive]:{title:(0,c._t)("settings|sessions|inactive_sessions"),description:o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("settings|sessions|inactive_sessions_explainer_1")),o.createElement("p",null,(0,c._t)("settings|sessions|inactive_sessions_explainer_2")))}},uL=({variation:e})=>{const{title:t,description:n}=dL[e];return o.createElement(ZF,{title:t,description:n})},mL=({device:e,isCurrentDevice:t,onVerifyDevice:n})=>{const i=((e,t)=>{if(e.isVerified){const e=t?(0,c._t)("settings|sessions|device_verified_description_current"):(0,c._t)("settings|sessions|device_verified_description");return{variation:dt.Verified,heading:(0,c._t)("settings|sessions|verified_session"),description:o.createElement(o.Fragment,null,e,o.createElement(uL,{variation:dt.Verified}))}}if(null===e.isVerified)return{variation:dt.Unverified,heading:(0,c._t)("settings|sessions|unverified_session"),description:o.createElement(o.Fragment,null,(0,c._t)("settings|sessions|unverified_session_explainer_1"),o.createElement(uL,{variation:dt.Unverifiable}))};const n=t?(0,c._t)("settings|sessions|device_unverified_description_current"):(0,c._t)("settings|sessions|device_unverified_description");return{variation:dt.Unverified,heading:(0,c._t)("settings|sessions|unverified_session"),description:o.createElement(o.Fragment,null,n,o.createElement(uL,{variation:dt.Unverified}))}})(e,t);return o.createElement(cL,i,!1===e.isVerified&&!!n&&o.createElement(ae.A,{kind:"primary",onClick:n},(0,c._t)("settings|sessions|verify_session")))};var hL=function(e){return e.Profile="org.matrix.profile",e.SessionsList="org.matrix.sessions_list",e.SessionView="org.matrix.session_view",e.SessionEnd="org.matrix.session_end",e.AccountDeactivate="org.matrix.account_deactivate",e.CrossSigningReset="org.matrix.cross_signing_reset",e}(hL||{});const pL=(e,t)=>{const n=((e,t)=>{const n=new URL(e);return n.searchParams.set("action",t),n})(e,hL.SessionView);return n.searchParams.set("device_id",t),n.toString()};function gL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function vL(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?gL(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gL(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function fL(e,t){return e?!!e[i.PUSHER_ENABLED.name]:!t||!t.is_silenced}function _L(e,t,n){return!t&&!(!e||n)}const yL=({device:e,pusher:t,localNotificationSettings:n,isSigningOut:i,onVerifyDevice:r,onSignOutDevice:s,saveDeviceName:a,setPushNotifications:l,supportsMSC3881:d,className:u,isCurrentDevice:m,delegatedAuthAccountUrl:h})=>{const p=[{id:"session",values:[{label:(0,c._t)("settings|sessions|session_id"),value:e.device_id},{label:(0,c._t)("settings|sessions|last_activity"),value:e.last_seen_ts&&(0,gt.Yq)(new Date(e.last_seen_ts))}]},{id:"application",heading:(0,c._t)("common|application"),values:[{label:(0,c._t)("common|name"),value:e.appName},{label:(0,c._t)("common|version"),value:e.appVersion},{label:(0,c._t)("settings|sessions|url"),value:e.url}]},{id:"device",heading:(0,c._t)("common|device"),values:[{label:(0,c._t)("common|model"),value:e.deviceModel},{label:(0,c._t)("settings|sessions|os"),value:e.deviceOperatingSystem},{label:(0,c._t)("settings|sessions|browser"),value:e.client},{label:(0,c._t)("settings|sessions|ip"),value:e.last_seen_ip}]}].map(e=>vL(vL({},e),{},{values:e.values.filter(e=>!!e.value)})).filter(e=>e.values.length),g=!!t||!!n;return o.createElement("div",{className:me()("mx_DeviceDetails",u)},o.createElement("section",{className:"mx_DeviceDetails_section"},o.createElement(tL,{device:e,saveDeviceName:a}),o.createElement(mL,{device:e,onVerifyDevice:r,isCurrentDevice:m})),!h&&o.createElement("section",{className:"mx_DeviceDetails_section"},o.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,c._t)("settings|sessions|details_heading")),p.map(({heading:e,values:t,id:n},i)=>o.createElement("table",{className:"mx_DeviceDetails_metadataTable",key:i},e&&o.createElement("thead",null,o.createElement("tr",null,o.createElement("th",null,e))),o.createElement("tbody",null,t.map(({label:e,value:t})=>o.createElement("tr",{key:e},o.createElement("td",{className:"mxDeviceDetails_metadataLabel"},e),o.createElement("td",{className:"mxDeviceDetails_metadataValue"},t))))))),g&&o.createElement("section",{className:"mx_DeviceDetails_section mx_DeviceDetails_pushNotifications"},o.createElement(XF.A,{checked:fL(t,n),disabled:_L(t,n,d),onChange:t=>null==l?void 0:l(e.device_id,t),title:(0,c._t)("settings|sessions|push_toggle")}),o.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},(0,c._t)("settings|sessions|push_heading"),o.createElement("small",{className:"mx_DeviceDetails_sectionSubheading"},(0,c._t)("settings|sessions|push_subheading")))),o.createElement("section",{className:"mx_DeviceDetails_section"},h&&!m?o.createElement(ae.A,{element:"a",onClick:null,kind:"link_inline",href:pL(h,e.device_id),target:"_blank"},o.createElement("span",{className:"mx_DeviceDetails_signOutButtonContent"},(0,c._t)("settings|sessions|manage"))):o.createElement(ae.A,{onClick:s,kind:"danger_inline",disabled:i},o.createElement("span",{className:"mx_DeviceDetails_signOutButtonContent"},(0,c._t)("settings|sessions|sign_out"),i&&o.createElement(le.A,{w:16,h:16})))))},bL=["isExpanded"],EL=e=>{let{isExpanded:t}=e,n=(0,v.A)(e,bL);const i=t?(0,c._t)("settings|sessions|hide_details"):(0,c._t)("settings|sessions|show_details");return o.createElement(ae.A,(0,tn.A)({},n,{"aria-label":i,title:i,kind:"icon",className:me()("mx_DeviceExpandDetailsButton",{mx_DeviceExpandDetailsButton_expanded:t})}),o.createElement(Gg,{className:"mx_DeviceExpandDetailsButton_icon"}))};var wL;function SL(){return SL=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},SL.apply(null,arguments)}var xL=function(e,t){return o.createElement("svg",SL({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 22 23",role:"presentation","aria-hidden":!0,ref:t},e),wL||(wL=o.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M11 22.5c6.075 0 11-4.925 11-11S17.075.5 11 .5 0 5.425 0 11.5s4.925 11 11 11m0-4.24a1.375 1.375 0 1 0 0-2.75 1.375 1.375 0 0 0 0 2.75M9.09 9.429A1.91 1.91 0 0 1 11 7.518c1.048 0 1.91.862 1.91 1.91 0 .485-.208.659-1.026 1.224-.363.25-.86.598-1.246 1.108-.415.546-.67 1.227-.67 2.093h2.063c0-.424.113-.666.25-.846.164-.217.402-.4.775-.659l.124-.084c.676-.46 1.792-1.219 1.792-2.836A3.98 3.98 0 0 0 11 5.456a3.97 3.97 0 0 0-3.973 3.972z",clipRule:"evenodd"})))},AL=(0,o.forwardRef)(xL);var CL;function kL(){return kL=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},kL.apply(null,arguments)}var RL=function(e,t){return o.createElement("svg",kL({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 22 19",role:"presentation","aria-hidden":!0,ref:t},e),CL||(CL=o.createElement("path",{fill:"currentColor",d:"M3 15.5q-.824 0-1.412-.587A1.93 1.93 0 0 1 1 13.5v-11q0-.825.588-1.413A1.93 1.93 0 0 1 3 .5h16q.825 0 1.413.587Q21 1.675 21 2.5v11q0 .825-.587 1.413A1.93 1.93 0 0 1 19 15.5zm0-2h16v-11H3zm-2 5a.97.97 0 0 1-.712-.288A.97.97 0 0 1 0 17.5q0-.424.288-.712A.97.97 0 0 1 1 16.5h20q.424 0 .712.288A.97.97 0 0 1 22 17.5q0 .424-.288.712A.97.97 0 0 1 21 18.5zm2-5v-11z"})))},IL=(0,o.forwardRef)(RL);var TL;function PL(){return PL=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},PL.apply(null,arguments)}var NL=function(e,t){return o.createElement("svg",PL({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 17",role:"presentation","aria-hidden":!0,ref:t},e),TL||(TL=o.createElement("path",{fill:"currentColor",d:"M18 16.5H2q-.824 0-1.412-.587A1.93 1.93 0 0 1 0 14.5v-12q0-.825.588-1.412A1.92 1.92 0 0 1 2 .5h16q.825 0 1.413.588Q20 1.675 20 2.5v12q0 .825-.587 1.413A1.93 1.93 0 0 1 18 16.5M2 4.5v10h16v-10z"})))},DL=(0,o.forwardRef)(NL);var ML;function OL(){return OL=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},OL.apply(null,arguments)}var FL=function(e,t){return o.createElement("svg",OL({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 14 23",role:"presentation","aria-hidden":!0,ref:t},e),ML||(ML=o.createElement("path",{fill:"currentColor",d:"M12 .51 2 .5c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-18c0-1.1-.9-1.99-2-1.99m0 17.99H2v-14h10z"})))},LL=(0,o.forwardRef)(FL);const UL={[st.b.Desktop]:IL,[st.b.Mobile]:LL,[st.b.Web]:DL,[st.b.Unknown]:AL},BL={[st.b.Desktop]:(0,c.AO)("settings|sessions|desktop_session"),[st.b.Mobile]:(0,c.AO)("settings|sessions|mobile_session"),[st.b.Web]:(0,c.AO)("settings|sessions|web_session"),[st.b.Unknown]:(0,c.AO)("settings|sessions|unknown_session")},VL=({isVerified:e,isSelected:t,deviceType:n})=>{const i=UL[n]||UL[st.b.Unknown],r=(0,c._t)(BL[n]||BL[st.b.Unknown]);return o.createElement("div",{className:me()("mx_DeviceTypeIcon",{mx_DeviceTypeIcon_selected:t})},o.createElement("div",{className:"mx_DeviceTypeIcon_deviceIconWrapper"},o.createElement(i,{className:"mx_DeviceTypeIcon_deviceIcon",role:"img","aria-label":r})),e?o.createElement(oL,{className:me()("mx_DeviceTypeIcon_verificationIcon","verified"),role:"img","aria-label":(0,c._t)("common|verified")}):o.createElement(sL.I,{className:me()("mx_DeviceTypeIcon_verificationIcon","unverified"),role:"img","aria-label":(0,c._t)("common|unverified")}))};var jL=n("./src/utils/NativeEventUtils.ts");const zL=({device:e})=>o.createElement(uC.A,{size:"4"},e.display_name||e.device_id),HL=({device:e,children:t,isSelected:n,onClick:i})=>o.createElement("div",{className:me()("mx_DeviceTile",{mx_DeviceTile_interactive:!!i}),onClick:i},o.createElement(VL,{isVerified:e.isVerified,isSelected:n,deviceType:e.deviceType}),o.createElement("div",{className:"mx_DeviceTile_info"},o.createElement(zL,{device:e}),o.createElement("div",{className:"mx_DeviceTile_metadata"},o.createElement(_t,{device:e}))),o.createElement("div",{className:"mx_DeviceTile_actions",onClick:(0,jL.Z)(()=>{})},t)),WL=({children:e,device:t,isSelected:n,onSelect:i,onClick:r})=>o.createElement("div",{className:"mx_SelectableDeviceTile"},o.createElement(Io.A,{checked:n,onChange:i,className:"mx_SelectableDeviceTile_checkbox",id:`device-tile-checkbox-${t.device_id}`},o.createElement(HL,{device:t,onClick:r,isSelected:n},e))),GL=["selectedDeviceCount","isAllSelected","isSelectDisabled","toggleSelectAll","children"],KL=e=>{let{selectedDeviceCount:t,isAllSelected:n,isSelectDisabled:i,toggleSelectAll:r,children:s}=e,a=(0,v.A)(e,GL);const l=n?(0,c._t)("common|deselect_all"):(0,c._t)("common|select_all");return o.createElement("div",(0,tn.A)({className:"mx_FilteredDeviceListHeader"},a),!i&&o.createElement(rn.m,{label:l,placement:"top",isTriggerInteractive:!1},o.createElement(Io.A,{checked:n,onChange:r,id:"device-select-all-checkbox","aria-label":l})),o.createElement("span",{className:"mx_FilteredDeviceListHeader_label"},t>0?(0,c._t)("settings|sessions|n_sessions_selected",{count:t}):(0,c._t)("settings|sessions|title")),s)},qL=(e,t)=>t.includes(e),$L=(e,t)=>(t.last_seen_ts||0)-(e.last_seen_ts||0)||(e.display_name||e.device_id).localeCompare(t.display_name||t.device_id),JL="ALL",YL=({filter:e})=>{if((e=>!!e&&[dt.Inactive,dt.Unverified,dt.Verified].includes(e))(e)){const t={[dt.Verified]:{title:(0,c._t)("settings|sessions|verified_sessions"),description:(0,c._t)("settings|sessions|verified_sessions_list_description")},[dt.Unverified]:{title:(0,c._t)("settings|sessions|unverified_sessions"),description:(0,c._t)("settings|sessions|unverified_sessions_list_description")},[dt.Unverifiable]:{title:(0,c._t)("settings|sessions|unverified_session"),description:(0,c._t)("settings|sessions|unverified_session_explainer_1")},[dt.Inactive]:{title:(0,c._t)("settings|sessions|inactive_sessions"),description:(0,c._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:90})}},{title:n,description:i}=t[e];return o.createElement("div",{className:"mx_FilteredDeviceList_securityCard"},o.createElement(cL,{variation:e,heading:n,description:o.createElement("span",null,i,o.createElement(uL,{variation:e}))}))}return null},XL=({filter:e,clearFilter:t})=>o.createElement("div",{className:"mx_FilteredDeviceList_noResults"},(e=>{switch(e){case dt.Verified:return(0,c._t)("settings|sessions|no_verified_sessions");case dt.Unverified:return(0,c._t)("settings|sessions|no_unverified_sessions");case dt.Inactive:return(0,c._t)("settings|sessions|no_inactive_sessions");default:return(0,c._t)("settings|sessions|no_sessions")}})(e),!!e&&o.createElement(o.Fragment,null,"",o.createElement(ae.A,{kind:"link_inline",onClick:t},(0,c._t)("action|show_all")))),QL=({device:e,pusher:t,localNotificationSettings:n,isExpanded:i,isSigningOut:r,isSelected:s,onDeviceExpandToggle:a,onSignOutDevice:l,saveDeviceName:c,onRequestDeviceVerification:d,setPushNotifications:u,toggleSelected:m,supportsMSC3881:h,isSelectDisabled:p,delegatedAuthAccountUrl:g})=>{const v=o.createElement(o.Fragment,null,r&&o.createElement(le.A,{w:16,h:16}),o.createElement(EL,{isExpanded:i,onClick:a}));return o.createElement("li",{className:"mx_FilteredDeviceList_listItem"},p?o.createElement(HL,{device:e,onClick:a},v):o.createElement(WL,{isSelected:s,onSelect:m,onClick:a,device:e},v),i&&o.createElement(yL,{device:e,pusher:t,localNotificationSettings:n,isSigningOut:r,onVerifyDevice:d,onSignOutDevice:l,saveDeviceName:c,setPushNotifications:u,supportsMSC3881:h,className:"mx_FilteredDeviceList_deviceDetails",delegatedAuthAccountUrl:g}))},ZL=({devices:e,pushers:t,localNotificationSettings:n,filter:r,expandedDeviceIds:s,signingOutDeviceIds:a,selectedDeviceIds:l,onFilterChange:d,onDeviceExpandToggle:u,saveDeviceName:m,onSignOutDevices:h,onRequestDeviceVerification:p,setPushNotifications:g,setSelectedDeviceIds:v,supportsMSC3881:f,delegatedAuthAccountUrl:_,ref:y})=>{const b=((e,t)=>pt(Object.values(e),t?[t]:[]).sort($L))(e,r);function E(e){return t.find(t=>t[i.PUSHER_DEVICE_ID.name]===e.device_id)}const w=[{id:JL,label:(0,c._t)("settings|sessions|filter_all")},{id:dt.Verified,label:(0,c._t)("common|verified"),description:(0,c._t)("settings|sessions|filter_verified_description")},{id:dt.Unverified,label:(0,c._t)("common|unverified"),description:(0,c._t)("settings|sessions|filter_unverified_description")},{id:dt.Inactive,label:(0,c._t)("settings|sessions|filter_inactive"),description:(0,c._t)("settings|sessions|filter_inactive_description",{inactiveAgeDays:90})}],S=l.length>=b.length,x=!!a.length;return o.createElement("div",{className:"mx_FilteredDeviceList",ref:y},o.createElement(KL,{selectedDeviceCount:l.length,isAllSelected:S,toggleSelectAll:()=>{v(S?[]:b.map(e=>e.device_id))},isSelectDisabled:!!_},l.length?o.createElement(o.Fragment,null,o.createElement(ae.A,{kind:"danger_inline",disabled:x,onClick:()=>h(l),className:"mx_FilteredDeviceList_headerButton"},x&&o.createElement(le.A,{w:16,h:16}),(0,c._t)("action|sign_out")),o.createElement(ae.A,{kind:"content_inline",disabled:x,onClick:()=>v([]),className:"mx_FilteredDeviceList_headerButton"},(0,c._t)("action|cancel"))):o.createElement(YF,{id:"device-list-filter",label:(0,c._t)("settings|sessions|filter_label"),value:r||JL,onOptionChange:e=>{d(e===JL?void 0:e)},options:w,selectedLabel:(0,c._t)("action|show")})),b.length?o.createElement(YL,{filter:r}):o.createElement(XL,{filter:r,clearFilter:()=>d(void 0)}),o.createElement("ol",{className:"mx_FilteredDeviceList_list"},b.map(e=>o.createElement(QL,{key:e.device_id,device:e,pusher:E(e),localNotificationSettings:n.get(e.device_id),isExpanded:s.includes(e.device_id),isSigningOut:a.includes(e.device_id),isSelected:qL(e.device_id,l),isSelectDisabled:!!_,onDeviceExpandToggle:()=>u(e.device_id),onSignOutDevice:()=>h([e.device_id]),saveDeviceName:t=>m(e.device_id,t),onRequestDeviceVerification:p?()=>p(e.device_id):void 0,setPushNotifications:g,toggleSelected:()=>{return t=e.device_id,void(qL(t,l)?v(l.filter(e=>e!==t)):v([...l,t]));var t},supportsMSC3881:f,delegatedAuthAccountUrl:_}))))},eU=["options","title"],tU=e=>{let{options:t,title:n}=e,i=(0,v.A)(e,eU);const[r,s,a,l]=(0,Nn.EF)();return o.createElement(o.Fragment,null,o.createElement(Nn.VJ,(0,tn.A)({},i,{onClick:a,title:n,isExpanded:r,ref:s}),o.createElement(Un,{className:"mx_KebabContextMenu_icon"})),r&&o.createElement(Qa.Ay,(0,tn.A)({onFinished:l,compact:!0,rightAligned:!0,closeOnInteraction:!0},{left:(c=s.current.getBoundingClientRect()).left+window.scrollX+c.width,top:c.bottom+window.scrollY,chevronFace:Nn.t4.None}),o.createElement(Qa.tx,null,t)));var c},nU=({onSignOutCurrentDevice:e,signOutAllOtherSessions:t,otherSessionsCount:n,disabled:i})=>{const r=[o.createElement(Qa.R$,{key:"sign-out",label:(0,c._t)("action|sign_out"),onClick:e,isDestructive:!0}),...t?[o.createElement(Qa.R$,{key:"sign-out-all-others",label:(0,c._t)("settings|sessions|sign_out_all_other_sessions",{otherSessionsCount:n}),onClick:t,isDestructive:!0})]:[]];return o.createElement(HO.r,{heading:(0,c._t)("settings|sessions|current_session")},o.createElement(tU,{disabled:i,title:(0,c._t)("common|options"),options:r}))},iU=({device:e,isLoading:t,isSigningOut:n,localNotificationSettings:i,otherSessionsCount:r,setPushNotifications:s,onVerifyCurrentDevice:a,onSignOutCurrentDevice:l,signOutAllOtherSessions:c,saveDeviceName:d,delegatedAuthAccountUrl:u})=>{const[m,h]=(0,o.useState)(!1);return o.createElement(Mo.P,{heading:o.createElement(nU,{onSignOutCurrentDevice:l,signOutAllOtherSessions:c,otherSessionsCount:r,disabled:t||!e||n})},t&&!e&&o.createElement(le.A,null),!!e&&o.createElement(o.Fragment,null,o.createElement(HL,{device:e,onClick:()=>h(!m)},o.createElement(EL,{isExpanded:m,onClick:()=>h(!m)})),m?o.createElement(yL,{device:e,localNotificationSettings:i,setPushNotifications:s,isSigningOut:n,onVerifyDevice:a,onSignOutDevice:l,saveDeviceName:d,className:"mx_CurrentDeviceSection_deviceDetails",delegatedAuthAccountUrl:u,isCurrentDevice:!0}):o.createElement(o.Fragment,null,o.createElement("br",null),o.createElement(mL,{device:e,onVerifyDevice:a,isCurrentDevice:!0}))))},rU=({devices:e,currentDeviceId:t,goToFilteredList:n})=>{const i=Object.values(e),r=pt(i,[dt.Unverified]).filter(e=>e.device_id!==t).length,s=pt(i,[dt.Inactive]).length;if(!(r|s))return null;return o.createElement(Mo.P,{heading:(0,c._t)("settings|sessions|security_recommendations"),description:(0,c._t)("settings|sessions|security_recommendations_description")},!!r&&o.createElement(cL,{variation:dt.Unverified,heading:(0,c._t)("settings|sessions|unverified_sessions"),description:o.createElement(o.Fragment,null,(0,c._t)("settings|sessions|unverified_sessions_list_description"),o.createElement(uL,{variation:dt.Unverified}))},o.createElement(ae.A,{kind:"link_inline",onClick:()=>n(dt.Unverified)},(0,c._t)("action|view_all")+` (${r})`)),!!s&&o.createElement(o.Fragment,null,!!r&&o.createElement("div",{className:"mx_SecurityRecommendations_spacing"}),o.createElement(cL,{variation:dt.Inactive,heading:(0,c._t)("settings|sessions|inactive_sessions"),description:o.createElement(o.Fragment,null,(0,c._t)("settings|sessions|inactive_sessions_list_description",{inactiveAgeDays:90}),o.createElement(uL,{variation:dt.Inactive}))},o.createElement(ae.A,{kind:"link_inline",onClick:()=>n(dt.Inactive)},(0,c._t)("action|view_all")+` (${s})`))))},oU=(e,t)=>async n=>e.deleteMultipleDevices(t,null!=n?n:void 0);var sU=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/qr-code.js");const aU=({onShowQr:e,versions:t,oidcClientConfig:n,isCrossSigningReady:r})=>{const s=function(e,t,n,r){var o,s;const a=!(null==r||null===(o=r.unstable_features)||void 0===o||!o["org.matrix.msc4108"]);return!!(null==n?void 0:n.grant_types_supported.includes(i.DEVICE_CODE_SCOPE))&&a&&!(null===(s=e.getCrypto())||void 0===s||!s.exportSecretsBundle)&&t}((0,ce.nH)(),!!r,n,t);return o.createElement(Mo.P,{heading:(0,c._t)("settings|sessions|sign_in_with_qr")},o.createElement("div",{className:"mx_LoginWithQRSection"},o.createElement("p",{className:"mx_SettingsTab_subsectionText"},(0,c._t)("settings|sessions|sign_in_with_qr_description")),o.createElement(ae.A,{onClick:e,kind:"primary",disabled:!s},o.createElement(sU.A,{height:20,width:20}),(0,c._t)("settings|sessions|sign_in_with_qr_button")),!s&&o.createElement(og.E,{size:"sm"},(0,c._t)("settings|sessions|sign_in_with_qr_unsupported"))))};var lU=n("./src/components/views/auth/LoginWithQR-types.ts");const cU=({otherSessionsCount:e,disabled:t,signOutAllOtherSessions:n})=>{const i=(0,ie.Bo)([n?o.createElement(Qa.R$,{key:"sign-out-all-others",label:(0,c._t)("settings|sessions|sign_out_n_sessions",{count:e}),onClick:n,isDestructive:!0}):null]);return o.createElement(HO.r,{heading:(0,c._t)("settings|sessions|other_sessions_heading")},!!i.length&&o.createElement(tU,{disabled:t,title:(0,c._t)("common|options"),options:i}))};function dU(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}const uU=(0,o.lazy)(()=>Promise.all([n.e(3380),n.e(8901)]).then(n.bind(n,"./src/components/views/auth/LoginWithQR.tsx"))),mU=(e,t,n)=>{const[r,a]=(0,o.useState)([]);return{onSignOutCurrentDevice:()=>{R.Ay.createDialog(qp,{},void 0,!1,!0)},onSignOutOtherDevices:async r=>{if(!r.length)return;if(!await(async e=>{const{finished:t}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("action|sign_out"),description:o.createElement("div",null,o.createElement("p",null,(0,c._t)("settings|sessions|sign_out_confirm_description",{count:e}))),cancelButton:(0,c._t)("action|cancel"),button:(0,c._t)("action|sign_out")}),[n]=await t;return!!n})(r.length))return;let l=!1;try{if(a(e=>[...e,...r]),n){const[e]=r,t=pL(n,e);window.open(t,"_blank")}else{const t=Promise.withResolvers();await(async(e,t,n)=>{if(t.length)try{await oU(e,t)(null),await n(!0)}catch(o){var r;if(!(o instanceof i.MatrixError&&401===o.httpStatus&&null!==(r=o.data)&&void 0!==r&&r.flows))throw o;const s=t.length,a={[Ne.av.PHASE_PREAUTH]:{title:(0,c._t)("auth|uia|sso_title"),body:(0,c._t)("settings|sessions|confirm_sign_out_sso",{count:s}),continueText:(0,c._t)("auth|sso"),continueKind:"primary"},[Ne.av.PHASE_POSTAUTH]:{title:(0,c._t)("settings|sessions|confirm_sign_out",{count:s}),body:(0,c._t)("settings|sessions|confirm_sign_out_body",{count:s}),continueText:(0,c._t)("settings|sessions|confirm_sign_out_continue",{count:s}),continueKind:"danger"}},{finished:l}=R.Ay.createDialog(De.A,{title:(0,c._t)("common|authentication"),matrixClient:e,authData:o.data,makeRequest:oU(e,t),aestheticsForStagePhases:{[Ne.av.LOGIN_TYPE]:a,[Ne.av.UNSTABLE_LOGIN_TYPE]:a}});l.then(([e])=>n(e))}})(e,r,async e=>{t.resolve(!!e)}),l=await t.promise}}catch(e){s.vF.error("Error deleting sessions",e)}finally{l&&await t(),a(e=>e.filter(e=>!r.includes(e)))}},signingOutDeviceIds:r}},hU=({showMsc4108QrCode:e})=>{var t;const{devices:n,dehydratedDeviceId:i,pushers:r,localNotificationSettings:a,currentDeviceId:l,isLoadingDeviceList:d,requestDeviceVerification:u,refreshDevices:m,saveDeviceName:h,setPushNotifications:p,supportsMSC3881:g}=RO(),[f,_]=(0,o.useState)(),[y,b]=(0,o.useState)([]),[E,w]=(0,o.useState)([]),S=(0,o.useRef)(null),x=(0,o.useRef)(void 0),A=(0,o.useContext)(as.A),C=A.client,k=(0,mr.e)(async()=>(await A.oidcClientStore.readyPromise,A.oidcClientStore.accountManagementEndpoint),[A.oidcClientStore]),I=!!k,T=null==C?void 0:C.getUserId(),P=T&&(null==C?void 0:C.getUser(T))||void 0,N=(0,mr.e)(()=>C.getVersions(),[C]),D=(0,mr.e)(async()=>{try{return await(null==C?void 0:C.getAuthMetadata())}catch(e){s.vF.error("Failed to discover OIDC metadata",e)}},[C]),M=(0,mr.e)(async()=>{var e,t;return null!==(e=null===(t=C.getCrypto())||void 0===t?void 0:t.isCrossSigningReady())&&void 0!==e&&e},[C]),{[l]:O}=n,F=(0,v.A)(n,[l].map(dU));i&&null!==(t=F[i])&&void 0!==t&&t.isVerified&&delete F[i];const L=Object.keys(F).length,U=L>0,B=(0,o.useCallback)(e=>{if(!u)return;const t=u(e),{finished:n}=R.Ay.createDialog(Z,{verificationRequestPromise:t,member:P});n.then(async()=>{(await t).cancel(),await m()})},[u,m,P]),{onSignOutCurrentDevice:V,onSignOutOtherDevices:j,signingOutDeviceIds:z}=mU(C,async()=>{await m(),w([])},k);(0,o.useEffect)(()=>()=>{clearTimeout(x.current)},[x]),(0,o.useEffect)(()=>{w([])},[f,w]);const H=U&&!I?()=>{j(Object.keys(F))}:void 0,[W,G]=(0,o.useState)(e?lU.Kt.Show:null),K=(0,o.useCallback)(()=>{G(null)},[G]),q=(0,o.useCallback)(()=>{G(lU.Kt.Show)},[G]);return W?o.createElement(o.Suspense,{fallback:o.createElement(le.A,null)},o.createElement(uU,{mode:W,onFinished:K,client:C})):o.createElement(No.A,null,o.createElement(Do.X,null,o.createElement(aU,{onShowQr:q,versions:N,oidcClientConfig:D,isCrossSigningReady:M}),o.createElement(rU,{devices:n,goToFilteredList:e=>{_(e),clearTimeout(x.current),x.current=window.setTimeout(()=>{var e;return null===(e=S.current)||void 0===e?void 0:e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})})},currentDeviceId:l}),o.createElement(iU,{device:O,localNotificationSettings:a.get(l),setPushNotifications:p,isSigningOut:z.includes(l),isLoading:d,saveDeviceName:e=>h(l,e),onVerifyCurrentDevice:()=>{const{finished:e}=R.Ay.createDialog(He);e.then(m)},onSignOutCurrentDevice:V,signOutAllOtherSessions:H,otherSessionsCount:L,delegatedAuthAccountUrl:k}),U&&o.createElement(Mo.P,{heading:o.createElement(cU,{otherSessionsCount:L,signOutAllOtherSessions:H,disabled:!!z.length}),description:(0,c._t)("settings|sessions|best_security_note"),stretchContent:!0},o.createElement(ZL,{devices:F,pushers:r,localNotificationSettings:a,filter:f,expandedDeviceIds:y,signingOutDeviceIds:z,selectedDeviceIds:E,setSelectedDeviceIds:w,onFilterChange:_,onDeviceExpandToggle:e=>{y.includes(e)?b(y.filter(t=>t!==e)):b([...y,e])},onRequestDeviceVerification:u?B:void 0,onSignOutDevices:j,saveDeviceName:h,setPushNotifications:p,ref:S,supportsMSC3881:g,delegatedAuthAccountUrl:k}))))};function pU(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M4 18q-.824 0-1.412-.587A1.93 1.93 0 0 1 2 16V5q0-.824.587-1.412A1.93 1.93 0 0 1 4 3h16q.824 0 1.413.587Q22 4.176 22 5v11q0 .824-.587 1.413A1.93 1.93 0 0 1 20 18zm0-2h16V5H4zm-2 5a.97.97 0 0 1-.712-.288A.97.97 0 0 1 1 20q0-.424.288-.712A.97.97 0 0 1 2 19h20q.424 0 .712.288.288.287.288.712 0 .424-.288.712A.97.97 0 0 1 22 21z"})})}pU.displayName="ComputerIcon";const gU=(0,o.forwardRef)(pU);var vU=n("./src/components/views/settings/SettingsHeader.tsx");function fU({onChangeRecoveryKeyClick:e}){const t=(0,ce.nH)(),n=(0,mr.e)(async()=>Boolean(await t.secretStorage.getDefaultKeyId())?"good":"missing_recovery_key",[t],"loading"),i="missing_recovery_key"===n;let r;switch(n){case"loading":r=o.createElement(Ce.Z,{"aria-label":(0,c._t)("common|loading")});break;case"missing_recovery_key":r=o.createElement(Ae.$,{size:"sm",kind:"primary",Icon:Y,onClick:()=>e(!0)},(0,c._t)("settings|encryption|recovery|set_up_recovery"));break;case"good":r=o.createElement(Ae.$,{size:"sm",kind:"secondary",Icon:Y,onClick:()=>e(!1)},(0,c._t)("settings|encryption|recovery|change_recovery_key"))}return o.createElement(Do.X,{legacy:!1,heading:o.createElement(vU.r,{hasRecommendedTag:i,label:(0,c._t)("settings|encryption|recovery|title")}),subHeading:(0,c._t)("settings|encryption|recovery|description")},r)}var _U=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-left.js");const yU="_breadcrumb_1xygz_8",bU="_pages_1xygz_17",EU="_last-page_1xygz_30",wU=["backLabel","onBackClick","pages","onPageClick","className"];function SU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function xU(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?SU(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):SU(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function AU(e){let{backLabel:t,onBackClick:n,pages:i,onPageClick:r,className:o}=e,s=(0,v.A)(e,wU);return(0,$.jsxs)("nav",xU(xU({className:ue(yU,o)},s),{},{children:[(0,$.jsx)(rg.K,{kind:"secondary",size:"28px","aria-label":t,onClick:n,children:(0,$.jsx)(_U.A,{})}),(0,$.jsx)("ol",{className:bU,children:i.map((e,t)=>(0,$.jsx)(CU,{page:e,isLastPage:t===i.length-1,onClick:()=>r(e,t)},t))})]}))}function CU({page:e,isLastPage:t,onClick:n}){return(0,$.jsx)("li",{children:t?(0,$.jsx)("span",{className:EU,"aria-current":"page",children:e}):(0,$.jsx)(wS.N,{size:"small",role:"button",onClick:n,onKeyDown:e=>{" "===e.key&&n()},tabIndex:0,children:e})})}var kU=n("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/Password/Password.js");function RU(e,t){return(0,$.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:[(0,$.jsx)("path",{d:"M14 5H5v9h1a1 1 0 1 1 0 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1a1 1 0 1 1-2 0z"}),(0,$.jsx)("path",{d:"M8 10a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-9a2 2 0 0 1-2-2zm2 0v9h9v-9z"})]})}RU.displayName="CopyIcon";const IU=(0,o.forwardRef)(RU);function TU(e,t){return(0,$.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 24 24",ref:t,...e,children:(0,$.jsx)("path",{d:"M10.475 16.9A5.86 5.86 0 0 1 7 18q-2.5 0-4.25-1.75T1 12t1.75-4.25T7 6q2.026 0 3.537 1.15Q12.05 8.3 12.65 10h7.95q.2 0 .387.075.189.075.338.225l1.025 1.025a1 1 0 0 1 .2.288q.075.162.075.362t-.062.375a1.1 1.1 0 0 1-.188.325l-2.25 2.575a.97.97 0 0 1-1.038.313 1 1 0 0 1-.337-.188L17 14l-1.3 1.3q-.15.15-.325.212a1.1 1.1 0 0 1-.375.063q-.2 0-.375-.062a.9.9 0 0 1-.325-.213L13 14h-.35a5.8 5.8 0 0 1-2.175 2.9m-4.887-3.487Q6.175 14 7 14q.824 0 1.412-.588Q9 12.826 9 12t-.588-1.412A1.93 1.93 0 0 0 7 10q-.824 0-1.412.588A1.93 1.93 0 0 0 5 12q0 .825.588 1.412"})})}TU.displayName="KeySolidIcon";const PU=(0,o.forwardRef)(TU);function NU({userHasRecoveryKey:e,onFinish:t,onCancelClick:n}){const i=(0,ce.nH)(),[r,s]=(0,o.useState)(e?"save_key_change_flow":"inform_user"),a=(0,mr.e)(()=>i.getCrypto().createRecoveryKeyFromPassphrase(),[]);if(!a)return null;let l;switch(r){case"inform_user":l=o.createElement(DU,{onContinueClick:()=>s("save_key_setup_flow"),onCancelClick:n});break;case"save_key_setup_flow":case"save_key_change_flow":l=o.createElement(MU,{recoveryKey:a.encodedPrivateKey,onConfirmClick:()=>s(e=>"save_key_change_flow"===e?"confirm_key_change_flow":"confirm_key_setup_flow"),onCancelClick:n});break;case"confirm_key_setup_flow":case"confirm_key_change_flow":l=o.createElement(OU,{recoveryKey:a.encodedPrivateKey,onCancelClick:n,onSubmit:async()=>{const e=i.getCrypto();if(!e)return t();try{await(0,ne.J6)(async()=>{await e.bootstrapSecretStorage({setupNewSecretStorage:!0,createSecretStorageKey:async()=>a}),await(0,re.p)(i,{createNewKey:!0})}),await i.setAccountData(Nt,{enabled:!0}),t()}catch(e){(0,cs.tx)("Failed to set up secret storage",e)}},submitButtonLabel:"confirm_key_setup_flow"===r?(0,c._t)("settings|encryption|recovery|set_up_recovery_confirm_button"):(0,c._t)("settings|encryption|recovery|change_recovery_confirm_button")})}const d=[(0,c._t)("settings|encryption|title"),e?(0,c._t)("settings|encryption|recovery|change_recovery_key"):(0,c._t)("settings|encryption|recovery|set_up_recovery")],u=function(e){switch(e){case"inform_user":return{title:(0,c._t)("settings|encryption|recovery|set_up_recovery"),description:(0,c._t)("settings|encryption|recovery|set_up_recovery_description",{changeRecoveryKeyButton:(0,c._t)("settings|encryption|recovery|change_recovery_key")})};case"save_key_setup_flow":return{title:(0,c._t)("settings|encryption|recovery|set_up_recovery_save_key_title"),description:(0,c._t)("settings|encryption|recovery|set_up_recovery_save_key_description")};case"save_key_change_flow":return{title:(0,c._t)("settings|encryption|recovery|change_recovery_key_title"),description:(0,c._t)("settings|encryption|recovery|change_recovery_key_description")};case"confirm_key_setup_flow":return{title:(0,c._t)("settings|encryption|recovery|set_up_recovery_confirm_title"),description:(0,c._t)("settings|encryption|recovery|set_up_recovery_confirm_description")};case"confirm_key_change_flow":return{title:(0,c._t)("settings|encryption|recovery|change_recovery_confirm_title"),description:(0,c._t)("settings|encryption|recovery|change_recovery_confirm_description")}}}(r);return o.createElement(o.Fragment,null,o.createElement(AU,{backLabel:(0,c._t)("action|back"),onBackClick:n,pages:d,onPageClick:n}),o.createElement(Pe.g,{Icon:PU,title:u.title,description:u.description,className:"mx_ChangeRecoveryKey"},l))}function DU({onContinueClick:e,onCancelClick:t}){return o.createElement(o.Fragment,null,o.createElement(og.E,{as:"span",weight:"medium",className:"mx_InformationPanel_description"},(0,c._t)("settings|encryption|recovery|set_up_recovery_secondary_description")),o.createElement(Oe.D,null,o.createElement(Ae.$,{onClick:e},(0,c._t)("action|continue")),o.createElement(Ae.$,{kind:"tertiary",onClick:t},(0,c._t)("action|cancel"))))}function MU({recoveryKey:e,onConfirmClick:t,onCancelClick:n}){return o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_KeyPanel"},o.createElement(og.E,{as:"span",weight:"medium"},(0,c._t)("settings|encryption|recovery|save_key_title")),o.createElement("div",null,o.createElement(og.E,{as:"span",className:"mx_KeyPanel_key"},e),o.createElement(og.E,{as:"span",size:"sm"},(0,c._t)("settings|encryption|recovery|save_key_description"))),o.createElement(rg.K,{"aria-label":(0,c._t)("action|copy"),size:"28px",onClick:()=>(0,$i.nC)(e)},o.createElement(IU,null))),o.createElement(Oe.D,null,o.createElement(Ae.$,{onClick:t},(0,c._t)("action|continue")),o.createElement(Ae.$,{kind:"tertiary",onClick:n},(0,c._t)("action|cancel"))))}function OU({onCancelClick:e,onSubmit:t,recoveryKey:n,submitButtonLabel:i}){const[r,s]=(0,o.useState)(),a=!1===r;return o.createElement(AS.b,{className:"mx_KeyForm",onSubmit:e=>{e.preventDefault(),t(e)},onChange:async e=>{e.preventDefault(),e.stopPropagation();const t=new FormData(e.currentTarget).get("recoveryKey");s(t.trim()===n)}},o.createElement(IS.D,{name:"recoveryKey",serverInvalid:a},o.createElement(TS.J,null,(0,c._t)("settings|encryption|recovery|enter_recovery_key")),o.createElement(kU.T,{required:!0,title:(0,c._t)("settings|encryption|recovery|enter_recovery_key"),className:"mx_KeyForm_password mx_no_textinput"}),a&&o.createElement(VA.Kw,null,(0,c._t)("settings|encryption|recovery|enter_key_error"))),o.createElement(Oe.D,null,o.createElement(Ae.$,{disabled:!r},i),o.createElement(Ae.$,{kind:"tertiary",onClick:e},(0,c._t)("action|cancel"))))}var FU=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/check-circle-solid.js");function LU({label:e,state:t,stateMessage:n}){return o.createElement("div",{className:"mx_SettingsSubheader"},e,o.createElement("span",{className:me()({mx_SettingsSubheader_success:"success"===t,mx_SettingsSubheader_error:"error"===t})},"success"===t?o.createElement(FU.A,{width:"20px",height:"20px"}):o.createElement(Te.A,{width:"20px",height:"20px"}),n))}var UU=n("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/share.js");function BU({onResetIdentityClick:e}){return o.createElement(Do.X,{heading:(0,c._t)("settings|encryption|advanced|title"),legacy:!1},o.createElement(VU,{onResetIdentityClick:e}),o.createElement(jU,null))}function VU({onResetIdentityClick:e}){const t=(0,ce.nH)(),i=(0,mr.e)(()=>t.getCrypto().getOwnDeviceKeys(),[t],null);return o.createElement("div",{className:"mx_EncryptionDetails"},o.createElement("div",{className:"mx_EncryptionDetails_session"},o.createElement("h3",{className:"mx_EncryptionDetails_session_title"},(0,c._t)("settings|encryption|advanced|details_title")),o.createElement("div",null,o.createElement("span",null,(0,c._t)("settings|encryption|advanced|session_id")),o.createElement("span",null,t.deviceId)),o.createElement("div",null,o.createElement("span",null,(0,c._t)("settings|encryption|advanced|session_key")),o.createElement("span",null,i?i.ed25519:o.createElement(Ce.Z,{"aria-label":(0,c._t)("common|loading")})))),o.createElement("div",{className:"mx_EncryptionDetails_buttons"},o.createElement(Ae.$,{size:"sm",kind:"secondary",Icon:UU.A,onClick:()=>R.Ay.createDialog((0,o.lazy)(()=>n.e(7692).then(n.bind(n,"./src/async-components/views/dialogs/security/ExportE2eKeysDialog.tsx"))),{matrixClient:t})},(0,c._t)("settings|encryption|advanced|export_keys")),o.createElement(Ae.$,{size:"sm",kind:"secondary",Icon:gi.A,onClick:()=>R.Ay.createDialog((0,o.lazy)(()=>n.e(7211).then(n.bind(n,"./src/async-components/views/dialogs/security/ImportE2eKeysDialog.tsx"))),{matrixClient:t})},(0,c._t)("settings|encryption|advanced|import_keys"))),o.createElement(Ae.$,{size:"sm",kind:"tertiary",destructive:!0,onClick:e},(0,c._t)("settings|encryption|advanced|reset_identity")))}function jU(){const e=(0,Qt.wL)(F.p.DEVICE,"blacklistUnverifiedDevices");return O.A.canSetValue("blacklistUnverifiedDevices",null,F.p.DEVICE)?o.createElement(AS.b,{className:"mx_OtherSettings",onChange:async e=>{const t="on"===new FormData(e.currentTarget).get("neverSendEncrypted");await O.A.setValue("blacklistUnverifiedDevices",null,F.p.DEVICE,t)}},o.createElement("h3",{className:"mx_OtherSettings_title"},(0,c._t)("settings|encryption|advanced|other_people_device_title")),o.createElement(oO.I,{name:"neverSendEncrypted",control:o.createElement(rf,{name:"neverSendEncrypted",defaultChecked:e})},o.createElement(TS.J,null,(0,c._t)("settings|encryption|advanced|other_people_device_label")),o.createElement(VA.po,null,(0,c._t)("settings|encryption|advanced|other_people_device_description")))):null}function zU({onCancelClick:e,onReset:t,variant:n}){return o.createElement(o.Fragment,null,o.createElement(AU,{backLabel:(0,c._t)("action|back"),onBackClick:e,pages:[(0,c._t)("settings|encryption|title"),(0,c._t)("settings|encryption|advanced|breadcrumb_page")],onPageClick:e}),o.createElement(Ue,{onReset:t,onCancelClick:e,variant:n}))}function HU({onForgotRecoveryKey:e,onFinish:t}){return o.createElement(Do.X,{legacy:!1,heading:(0,c._t)("settings|encryption|recovery|title"),subHeading:o.createElement(LU,{label:(0,c._t)("settings|encryption|recovery|description"),state:"error",stateMessage:(0,c._t)("settings|encryption|recovery|key_storage_warning")})},o.createElement("div",{className:"mx_RecoveryPanelOutOfSync"},o.createElement(Ae.$,{size:"sm",kind:"secondary",onClick:e},(0,c._t)("settings|encryption|recovery|forgot_recovery_key")),o.createElement(Ae.$,{size:"sm",kind:"primary",Icon:Y,onClick:async()=>{await(0,ne.cb)(),t()}},(0,c._t)("settings|encryption|recovery|enter_recovery_key"))))}function WU(){const[e,t]=(0,o.useState)(void 0),[n,i]=(0,o.useState)(!0),[r,a]=(0,o.useState)(void 0),l=(0,ce.nH)(),c=(0,o.useCallback)(async()=>{const e=l.getCrypto();if(!e)return void s.vF.error("Can't check key backup status: no crypto module available");const n=await e.getActiveSessionBackupVersion();t(null!==n)},[l]);(0,o.useEffect)(()=>{(async()=>{await c(),i(!1)})()},[c]);return{isEnabled:null!=r?r:e,setEnabled:(0,o.useCallback)(async e=>{a(e);try{Mt.sharedInstance().stop();const t=l.getCrypto();if(!t)return void s.vF.error("Can't change key backup status: no crypto module available");if(e){null===await t.checkKeyBackupAndEnable()&&(await t.resetKeyBackup(),await t.checkKeyBackupAndEnable()),await l.setAccountData(Pt,{disabled:!1})}else await t.disableKeyStorage(),await l.setAccountData(Pt,{disabled:!0});await c()}finally{a(void 0),Mt.sharedInstance().start(l)}},[a,c,l]),loading:n,busy:void 0!==r}}const GU=({onKeyStorageDisableClick:e})=>{const{isEnabled:t,setEnabled:n,loading:i,busy:r}=WU(),s=(0,o.useCallback)(t=>{t.currentTarget.checked?n(!0):e()},[n,e]);return i?o.createElement(Ce.Z,{"aria-label":(0,c._t)("common|loading")}):o.createElement(Do.X,{legacy:!1,heading:o.createElement(vU.r,{hasRecommendedTag:!1===t,label:(0,c._t)("settings|encryption|key_storage|title")}),subHeading:(0,c._t)("settings|encryption|key_storage|description",void 0,{a:e=>o.createElement("a",{href:"https://element.io/help#encryption5",target:"_blank",rel:"noreferrer noopener"},e)})},o.createElement(AS.b,{className:"mx_KeyStoragePanel_toggleRow"},o.createElement(oO.I,{name:"keyStorage",control:o.createElement(rf,{name:"keyStorage",checked:t,onChange:s})},o.createElement(TS.J,null,(0,c._t)("settings|encryption|key_storage|allow_key_storage"))),r&&o.createElement(Ce.Z,null)))};function KU({onFinish:e}){const{setEnabled:t}=WU(),[n,i]=(0,o.useState)(!1),r=(0,o.useCallback)(async()=>{i(!0);try{await t(!1)}finally{i(!1)}e()},[t,e]);return o.createElement(o.Fragment,null,o.createElement(AU,{backLabel:(0,c._t)("action|back"),onBackClick:e,pages:[(0,c._t)("settings|encryption|title"),(0,c._t)("settings|encryption|delete_key_storage|breadcrumb_page")],onPageClick:e}),o.createElement(Pe.g,{Icon:Te.A,destructive:!0,title:(0,c._t)("settings|encryption|delete_key_storage|title")},o.createElement(Le,null,(0,c._t)("settings|encryption|delete_key_storage|description"),o.createElement(ve,null,o.createElement(xe,{Icon:PT.A,destructive:!0},(0,c._t)("settings|encryption|delete_key_storage|list_first")),o.createElement(xe,{Icon:PT.A,destructive:!0},(0,c._t)("settings|encryption|delete_key_storage|list_second",{brand:d.Ay.get().brand})))),o.createElement(Oe.D,null,o.createElement(Ae.$,{destructive:!0,onClick:r,disabled:n},(0,c._t)("settings|encryption|delete_key_storage|confirm")),o.createElement(Ae.$,{kind:"tertiary",onClick:e},(0,c._t)("action|cancel")))))}function qU({initialState:e="loading"}){const[t,n]=(0,o.useState)(e),i=function(e,t){const n=(0,ce.nH)(),i=(0,o.useCallback)(async()=>{const e=n.getCrypto(),i=await e.isCrossSigningReady(),r=(await e.getCrossSigningStatus()).privateKeysCachedLocally,o=r.masterKey&&r.selfSigningKey&&r.userSigningKey,s=null!==await e.getActiveSessionBackupVersion();t(i&&s&&o?"main":i?s?"secrets_not_cached":"key_storage_disabled":"set_up_encryption")},[n,t]);return(0,o.useEffect)(()=>{"loading"===e&&i()},[i,e]),(0,lr.YK)(n,V.cr.KeyBackupStatus,()=>{i()}),i}(t,n);let r;switch(t){case"loading":r=o.createElement(Ce.Z,{"aria-label":(0,c._t)("common|loading")});break;case"set_up_encryption":r=o.createElement(JU,{onFinish:i});break;case"secrets_not_cached":r=o.createElement(HU,{onFinish:i,onForgotRecoveryKey:()=>n("reset_identity_forgot")});break;case"key_storage_disabled":case"main":r=o.createElement(o.Fragment,null,o.createElement(GU,{onKeyStorageDisableClick:()=>n("key_storage_delete")}),o.createElement(sf.w,{kind:"section"}),"main"===t&&o.createElement(o.Fragment,null,o.createElement(fU,{onChangeRecoveryKeyClick:e=>n(e?"set_recovery_key":"change_recovery_key")}),o.createElement(sf.w,{kind:"section"})),o.createElement(BU,{onResetIdentityClick:()=>n("reset_identity_compromised")}));break;case"change_recovery_key":case"set_recovery_key":r=o.createElement(NU,{userHasRecoveryKey:"change_recovery_key"===t,onCancelClick:()=>n("main"),onFinish:()=>n("main")});break;case"reset_identity_compromised":case"reset_identity_forgot":case"reset_identity_sync_failed":r=o.createElement(zU,{variant:$U(t),onCancelClick:i,onReset:i});break;case"key_storage_delete":r=o.createElement(KU,{onFinish:i})}return o.createElement(No.A,{className:"mx_EncryptionUserSettingsTab"},r)}function $U(e){switch(e){case"reset_identity_compromised":return"compromised";case"reset_identity_sync_failed":return"sync_failed";default:return"forgot"}}function JU({onFinish:e}){return o.createElement(Do.X,{legacy:!1,heading:(0,c._t)("settings|encryption|device_not_verified_title"),subHeading:o.createElement(LU,{stateMessage:(0,c._t)("settings|encryption|device_not_verified_description"),state:"error"})},o.createElement(Ae.$,{size:"sm",Icon:gU,onClick:()=>{const{finished:t}=R.Ay.createDialog(He);t.then(e)}},(0,c._t)("settings|encryption|device_not_verified_button")))}function YU(e){const t={strong:e=>o.createElement("span",{className:"mx_UserSettingsDialog_title_strong"},e)};switch(e){case We.v.Account:return(0,c._t)("settings|account|dialog_title",void 0,t);case We.v.SessionManager:return(0,c._t)("settings|sessions|dialog_title",void 0,t);case We.v.Appearance:return(0,c._t)("settings|appearance|dialog_title",void 0,t);case We.v.Notifications:return(0,c._t)("settings|notifications|dialog_title",void 0,t);case We.v.Preferences:return(0,c._t)("settings|preferences|dialog_title",void 0,t);case We.v.Keyboard:return(0,c._t)("settings|keyboard|dialog_title",void 0,t);case We.v.Sidebar:return(0,c._t)("settings|sidebar|dialog_title",void 0,t);case We.v.Voice:return(0,c._t)("settings|voip|dialog_title",void 0,t);case We.v.Security:return(0,c._t)("settings|security|dialog_title",void 0,t);case We.v.Encryption:return(0,c._t)("settings|encryption|dialog_title",void 0,t);case We.v.Labs:return(0,c._t)("settings|labs|dialog_title",void 0,t);case We.v.Mjolnir:return(0,c._t)("settings|labs_mjolnir|dialog_title",void 0,t);case We.v.Help:return(0,c._t)("setting|help_about|dialog_title",void 0,t)}}function XU(e){const t=(0,Qt.ti)(It.f.Voip),n=(0,Qt.ti)("feature_mjolnir"),[r,s]=(0,o.useState)(e.showMsc4108QrCode),[a,l]=(0,o.useState)(e.initialEncryptionState),d=(0,lr.H8)(e.sdkContext.client,i.ClientEvent.AccountData,async t=>{if(void 0===t||"m.secret_storage.default_key"===t.getType()){const t=e.sdkContext.client;return!!t&&!await t.secretStorage.getDefaultKeyId()}return new lr.E6},[],!1),u=()=>{const i=[];return i.push(new Ro.oz(We.v.Account,(0,c.AO)("settings|account|title"),o.createElement(jS,null),o.createElement(eO,{closeSettingsFn:e.onFinished}),"UserSettingsGeneral")),i.push(new Ro.oz(We.v.SessionManager,(0,c.AO)("settings|sessions|title"),o.createElement(VD,null),o.createElement(hU,{showMsc4108QrCode:r}),void 0)),i.push(new Ro.oz(We.v.Appearance,(0,c.AO)("common|appearance"),o.createElement(DR.A,null),o.createElement(EO,null),"UserSettingsAppearance")),i.push(new Ro.oz(We.v.Notifications,(0,c.AO)("notifications|enable_prompt_toast_title"),o.createElement(PR,null),o.createElement(xF,null),"UserSettingsNotifications")),i.push(new Ro.oz(We.v.Preferences,(0,c.AO)("common|preferences"),o.createElement(Xg,null),o.createElement(DF,{closeSettingsFn:e.onFinished}),"UserSettingsPreferences")),i.push(new Ro.oz(We.v.Keyboard,(0,c.AO)("settings|keyboard|title"),o.createElement(zD,null),o.createElement(qF,null),"UserSettingsKeyboard")),i.push(new Ro.oz(We.v.Sidebar,(0,c.AO)("settings|sidebar|title"),o.createElement(WD,null),o.createElement(Mp,null),"UserSettingsSidebar")),t&&i.push(new Ro.oz(We.v.Voice,(0,c.AO)("settings|voip|title"),o.createElement(KD,null),o.createElement(OF,null),"UserSettingsVoiceVideo")),i.push(new Ro.oz(We.v.Security,(0,c.AO)("room_settings|security|title"),o.createElement($D,null),o.createElement(UO,{closeSettingsFn:e.onFinished}),"UserSettingsSecurityPrivacy")),i.push(new Ro.oz(We.v.Encryption,(0,c.AO)("settings|encryption|title"),o.createElement(Y,null),o.createElement(qU,{initialState:a}),"UserSettingsEncryption",d?"mx_SettingsDialog_tabLabelsAlert":void 0)),(iO()||O.A.getFeatureSettingNames().some(e=>O.A.getBetaInfo(e)))&&i.push(new Ro.oz(We.v.Labs,(0,c.AO)("common|labs"),o.createElement(YD,null),o.createElement(rO,null),"UserSettingsLabs")),n&&i.push(new Ro.oz(We.v.Mjolnir,(0,c.AO)("labs_mjolnir|title"),o.createElement(XD.A,null),o.createElement(zF,null),"UserSettingMjolnir")),i.push(new Ro.oz(We.v.Help,(0,c.AO)("setting|help_about|title"),o.createElement(dC,null),o.createElement(VF,null),"UserSettingsHelpAbout")),i},[m,h]=(0,Ro.yz)(u(),We.v.Account,e.initialTabId),[p,g]=function(){const e=(0,o.useMemo)(()=>new cM,[]),[t,n]=(0,o.useState)(e.getActiveToast()),i=(0,o.useCallback)(()=>{n(e.getActiveToast())},[n,e]);return(0,o.useEffect)(()=>{e.setCallback(i)},[e,i]),[t,e]}();return o.createElement(as.A.Provider,{value:e.sdkContext},o.createElement(lM.Provider,{value:g},o.createElement(X.A,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:e.onFinished,title:YU(m),titleClass:"mx_UserSettingsDialog_title"},o.createElement("div",{className:"mx_SettingsDialog_content"},o.createElement(Ro.Ay,{tabs:u(),activeTabId:m,screenName:"UserSettings",onChange:e=>{h(e),s(!1),l(void 0)},responsive:!0})),o.createElement("div",{className:"mx_SettingsDialog_toastContainer"},p&&o.createElement(UD,null,p)))))}var QU=n("./src/components/views/dialogs/CreateRoomDialog.tsx");class ZU extends o.Component{render(){return o.createElement("div",null,o.createElement("h2",null,(0,c._t)("encryption|verification|complete_title")),o.createElement("p",null,(0,c._t)("encryption|verification|complete_description")),o.createElement("p",null,(0,c._t)("encryption|verification|explainer")),o.createElement(Kt.A,{onPrimaryButtonClick:this.props.onDone,primaryButton:(0,c._t)("encryption|verification|complete_action"),hasCancel:!1}))}}class eB extends o.Component{render(){return o.createElement("div",null,o.createElement("p",null,(0,c._t)("encryption|verification|other_party_cancelled")),o.createElement(Kt.A,{primaryButton:(0,c._t)("action|ok"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}var tB=n("./src/components/views/verification/VerificationShowSas.tsx");class nB extends o.Component{constructor(e){super(e),(0,S.A)(this,"showSasEvent",void 0),(0,S.A)(this,"onFinished",()=>{this.props.onFinished(3===this.state.phase)}),(0,S.A)(this,"onCancelClick",()=>{this.props.onFinished(3===this.state.phase)}),(0,S.A)(this,"onContinueClick",()=>{this.setState({phase:2}),this.props.verifier.verify().then(()=>{this.setState({phase:3})}).catch(e=>{s.vF.log("Verification failed",e)})}),(0,S.A)(this,"onVerifierShowSas",e=>{this.showSasEvent=e,this.setState({phase:1,sas:e.sas})}),(0,S.A)(this,"onVerifierCancel",()=>{this.setState({phase:4})}),(0,S.A)(this,"onSasMatchesClick",()=>{var e;null===(e=this.showSasEvent)||void 0===e||e.confirm(),this.setState({phase:2})}),(0,S.A)(this,"onVerifiedDoneClick",()=>{this.props.onFinished(!0)});let t=0;this.props.verifier.hasBeenCancelled&&(s.vF.log("Verifier was cancelled in the background."),t=4),this.showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null,sas:null}}componentDidMount(){this.props.verifier.on(V.Ji.ShowSas,this.onVerifierShowSas),this.props.verifier.on(V.Ji.Cancel,this.onVerifierCancel),this.fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel(new Error("User cancel")),this.props.verifier.removeListener(V.Ji.ShowSas,this.onVerifierShowSas)}async fetchOpponentProfile(){try{const e=await f.J.safeGet().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}renderPhaseStart(){const e=this.props.verifier.userId===f.J.safeGet().getUserId();let t;const n=this.state.opponentProfile;if(n){const e=n.avatar_url?(0,Vi.mediaFromMxc)(n.avatar_url).getSquareThumbnailHttp(48):null;t=o.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},o.createElement(Xp.A,{name:n.displayname,idName:this.props.verifier.userId,url:e,size:"48px"}),o.createElement("h2",null,n.displayname))}else t=this.state.opponentProfileError?o.createElement("div",null,o.createElement(Xp.A,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,size:"48px"}),o.createElement("h2",null,this.props.verifier.userId)):o.createElement(le.A,null);const i=[o.createElement("p",{key:"p1"},(0,c._t)("encryption|verification|incoming_sas_user_dialog_text_1")),o.createElement("p",{key:"p2"},(0,c._t)("encryption|verification|incoming_sas_user_dialog_text_2"))],r=[o.createElement("p",{key:"p1"},(0,c._t)("encryption|verification|incoming_sas_device_dialog_text_1")),o.createElement("p",{key:"p2"},(0,c._t)("encryption|verification|incoming_sas_device_dialog_text_2"))];return o.createElement("div",null,t,e?r:i,o.createElement(Kt.A,{primaryButton:(0,c._t)("action|continue"),hasCancel:!0,onPrimaryButtonClick:this.onContinueClick,onCancel:this.onCancelClick}))}renderPhaseShowSas(){return this.showSasEvent?o.createElement(tB.A,{sas:this.showSasEvent.sas,onCancel:this.onCancelClick,onDone:this.onSasMatchesClick,isSelf:this.props.verifier.userId===f.J.safeGet().getUserId(),inDialog:!0}):null}renderPhaseWaitForPartnerToConfirm(){return o.createElement("div",null,o.createElement(le.A,null),o.createElement("p",null,(0,c._t)("encryption|verification|incoming_sas_dialog_waiting")))}renderPhaseVerified(){return o.createElement(ZU,{onDone:this.onVerifiedDoneClick})}renderPhaseCancelled(){return o.createElement(eB,{onDone:this.onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this.renderPhaseStart();break;case 1:e=this.renderPhaseShowSas();break;case 2:e=this.renderPhaseWaitForPartnerToConfirm();break;case 3:e=this.renderPhaseVerified();break;case 4:e=this.renderPhaseCancelled()}return o.createElement(X.A,{title:(0,c._t)("encryption|verification|incoming_sas_dialog_title"),onFinished:this.onFinished,fixedWidth:!1},e)}}class iB extends o.PureComponent{render(){return o.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}const rB=()=>{var e;const t=d.Ay.getObject("branding"),n=null!==(e=null==t?void 0:t.get("auth_footer_links"))&&void 0!==e?e:[{text:"Element",url:"https://element.io"},{text:"GitHub",url:"https://github.com/brotherhood42/polarius-web"}],i=[];for(const e of n)i.push(o.createElement("a",{href:e.url,key:e.text,target:"_blank",rel:"noreferrer noopener"},e.text));return o.createElement("footer",{className:"mx_AuthFooter",role:"contentinfo"},i,o.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},(0,c._t)("powered_by_matrix")))};class oB extends o.PureComponent{static getWelcomeBackgroundUrl(){if(oB.welcomeBackgroundUrl)return oB.welcomeBackgroundUrl;const e=d.Ay.getObject("branding");oB.welcomeBackgroundUrl="themes/element/img/backgrounds/lake.jpg";const t=null==e?void 0:e.get("welcome_background_url");if(t)if(Array.isArray(t)){const e=Math.floor(Math.random()*t.length);oB.welcomeBackgroundUrl=t[e]}else oB.welcomeBackgroundUrl=t;return oB.welcomeBackgroundUrl}render(){const e={background:`center/cover fixed url(${oB.getWelcomeBackgroundUrl()})`},t={position:"absolute",top:0,right:0,bottom:0,left:0,filter:"blur(40px)",background:e.background};return o.createElement("div",{className:"mx_AuthPage",style:e},o.createElement("div",{className:"mx_AuthPage_modal",style:{position:"relative",background:"initial"}},o.createElement("div",{className:"mx_AuthPage_modalBlur",style:t}),o.createElement("div",{className:"mx_AuthPage_modalContent",style:{display:"flex",zIndex:1,background:"rgba(255, 255, 255, 0.59)",borderRadius:"8px"}},this.props.children)),o.createElement(rB,null))}}(0,S.A)(oB,"welcomeBackgroundUrl",void 0);class sB extends o.Component{constructor(e){super(e),(0,S.A)(this,"onStoreUpdate",()=>{const e=se.sharedInstance();this.setState({phase:e.phase,lostKeys:e.lostKeys()})}),(0,S.A)(this,"onSkipClick",()=>{se.sharedInstance().skip()});const t=se.sharedInstance();t.start(),this.state={phase:t.phase,lostKeys:t.lostKeys()}}componentDidMount(){se.sharedInstance().on("update",this.onStoreUpdate)}componentWillUnmount(){const e=se.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;let n,i;if(e===oe.Loading)return null;if(e===oe.Intro)t?(n=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,c._t)("encryption|verification|after_new_login|unable_to_verify")):(n=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,c._t)("encryption|verification|after_new_login|verify_this_device"));else if(e===oe.Done)n=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),i=(0,c._t)("encryption|verification|after_new_login|device_verified");else if(e===oe.ConfirmSkip)n=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,c._t)("common|are_you_sure");else if(e===oe.Busy)n=o.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=(0,c._t)("encryption|verification|after_new_login|verify_this_device");else if(e!==oe.Finished)throw new Error(`Unknown phase ${e}`);let r;return d.Ay.get("force_verification")||e!==oe.Intro||(r=o.createElement(ae.A,{onClick:this.onSkipClick,className:"mx_CompleteSecurity_skip","aria-label":(0,c._t)("encryption|verification|after_new_login|skip_verification")})),o.createElement(oB,null,o.createElement(iB,null,o.createElement("h1",{className:"mx_CompleteSecurity_header"},n,i,r),o.createElement("div",{className:"mx_CompleteSecurity_body"},o.createElement(je,{onFinished:this.props.onFinished}))))}}function aB(e){var t;(0,c.UK)()!==e&&(O.A.setValue("language",null,F.p.DEVICE,e),null===(t=l.A.get())||void 0===t||t.reload())}function lB({disabled:e}){return d.Ay.get("disable_login_language_selector")?o.createElement("div",null):o.createElement(AF,{className:"mx_AuthBody_language",onOptionChange:aB,value:(0,c.UK)(),disabled:e})}const cB=`<a href="https://matrix.org" target="_blank" rel="noreferrer noopener">\n    <img width="79" height="34" alt="Matrix" style="padding-left: 1px;vertical-align: middle" src="${n("./res/img/matrix.svg").A}"/>\n</a>`;class dB extends o.PureComponent{render(){const e=d.Ay.getObject("embedded_pages");let t;e&&(t=e.get("welcome_url"));const n={"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas",$matrixLogo:cB,"[matrix]":cB};if(!t){var i;const e=d.Ay.getObject("branding"),r=null!==(i=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==i?i:"themes/element/img/logos/element-logo.svg";n.$logoUrl=r,t="welcome.html"}return o.createElement(oB,null,o.createElement("div",{className:me()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!O.A.getValue(It.f.Registration)})},o.createElement(EN,{className:"mx_WelcomePage",url:t,replaceMap:n}),o.createElement(lB,null)))}}class uB{constructor(e,t){(0,S.A)(this,"client",void 0),(0,S.A)(this,"clientSecret",void 0),(0,S.A)(this,"password",""),(0,S.A)(this,"sessionId",""),(0,S.A)(this,"logoutDevices",!1),(0,S.A)(this,"sendAttempt",0),this.client=(0,i.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret()}requestResetToken(e){return this.sendAttempt++,this.client.requestPasswordEmailToken(e,this.clientSecret,this.sendAttempt).then(e=>(this.sessionId=e.sid,e),function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=(0,c._t)("auth|reset_password_email_not_found_title"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e})}setLogoutDevices(e){this.logoutDevices=e}async setNewPassword(e){this.password=e,await this.checkEmailLinkClicked()}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e},this.password,this.logoutDevices)}catch(e){throw 401===e.httpStatus?e.message=(0,c._t)("settings|general|add_email_failed_verification"):404===e.httpStatus?e.message=(0,c._t)("auth|reset_password_email_not_associated"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}class mB extends o.PureComponent{render(){var e;const t=d.Ay.getObject("branding"),n=null!==(e=null==t?void 0:t.get("auth_header_logo_url"))&&void 0!==e?e:"themes/element/img/logos/element-logo.svg";return o.createElement("aside",{className:"mx_AuthHeaderLogo"},o.createElement("img",{src:n,alt:"Element"}))}}class hB extends o.Component{render(){return o.createElement("div",{className:"mx_AuthHeader"},o.createElement(mB,null),o.createElement(lB,{disabled:this.props.disableLanguageSelector}))}}function pB({flex:e,className:t,children:n}){return o.createElement("main",{className:me()("mx_AuthBody",t,{mx_AuthBody_flex:e})},n)}var gB=n("./src/components/structures/ErrorMessage.tsx");const vB=({email:e,errorText:t,homeserver:n,loading:i,onInputChanged:r,onLoginClick:s,onSubmitForm:a})=>{const l=i?o.createElement(le.A,{w:16,h:16}):(0,c._t)("auth|forgot_password_send_email"),d=(0,o.useRef)(null);return o.createElement(o.Fragment,null,o.createElement(Df,{className:"mx_AuthBody_icon"}),o.createElement("h1",null,(0,c._t)("auth|enter_email_heading")),o.createElement("p",{className:"mx_AuthBody_text"},(0,c._t)("auth|enter_email_explainer",{homeserver:n},{b:e=>o.createElement("strong",null,e)})),o.createElement("form",{onSubmit:async e=>{var t,n,i;await(null===(t=d.current)||void 0===t?void 0:t.validate({allowEmpty:!1}))?a(e):(null===(n=d.current)||void 0===n||n.focus(),null===(i=d.current)||void 0===i||i.validate({allowEmpty:!1,focused:!0}))}},o.createElement("fieldset",{disabled:i},o.createElement("div",{className:"mx_AuthBody_fieldRow"},o.createElement(xM,{name:"reset_email",label:(0,c.AO)("common|email_address"),labelRequired:(0,c.AO)("auth|forgot_password_email_required"),labelInvalid:(0,c.AO)("auth|forgot_password_email_invalid"),value:e,autoFocus:!0,onChange:e=>r("email",e),fieldRef:d})),t&&o.createElement(gB.K,{message:t}),o.createElement("button",{type:"submit",className:"mx_Login_submit"},l),o.createElement("div",{className:"mx_AuthBody_button-container"},o.createElement(ae.A,{className:"mx_AuthBody_sign-in-instead-button",element:"button",kind:"link",onClick:e=>{e.preventDefault(),s()}},(0,c._t)("auth|sign_in_instead"))))))};var fB=n("./res/img/element-icons/email-prompt.svg");const _B=(e,t)=>{const n=(0,o.useRef)(void 0),[i,r]=(0,o.useState)(e);return(0,o.useEffect)(()=>()=>{clearTimeout(n.current)}),{toggle:()=>{r(!e),n.current=window.setTimeout(()=>r(e),t)},value:i}},yB=({email:e,errorText:t,onReEnterEmailClick:n,onSubmitForm:i,onResendClick:r})=>{const{toggle:s,value:a}=_B(!1,2500);return o.createElement(o.Fragment,null,o.createElement(fB.I,{className:"mx_AuthBody_emailPromptIcon--shifted"}),o.createElement("h1",null,(0,c._t)("auth|uia|email_auth_header")),o.createElement("div",{className:"mx_AuthBody_text"},o.createElement("p",null,(0,c._t)("auth|check_email_explainer",{email:e},{b:e=>o.createElement("strong",null,e)})),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,c._t)("auth|check_email_wrong_email_prompt")),o.createElement(ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:n},(0,c._t)("auth|check_email_wrong_email_button")))),t&&o.createElement(gB.K,{message:t}),o.createElement("input",{onClick:i,type:"button",className:"mx_Login_submit",value:(0,c._t)("action|next")}),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,c._t)("auth|check_email_resend_prompt")),o.createElement(rn.m,{description:(0,c._t)("auth|check_email_resend_tooltip"),placement:"top",open:a},o.createElement(ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await r(),s()}},o.createElement(Kn,{className:"mx_Icon mx_Icon_16"}),(0,c._t)("action|resend")))))},bB=({email:e,errorText:t,onCloseClick:n,onReEnterEmailClick:i,onResendClick:r})=>{const{toggle:s,value:a}=_B(!1,2500);return o.createElement(o.Fragment,null,o.createElement(fB.I,{className:"mx_AuthBody_emailPromptIcon"}),o.createElement("h1",null,(0,c._t)("auth|verify_email_heading")),o.createElement("p",null,(0,c._t)("auth|verify_email_explainer",{email:e},{b:e=>o.createElement("strong",null,e)})),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,c._t)("auth|check_email_resend_prompt")),o.createElement(rn.m,{description:(0,c._t)("auth|check_email_resend_tooltip"),placement:"top",open:a},o.createElement(ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await r(),s()}},o.createElement(Kn,{className:"mx_Icon mx_Icon_16"}),(0,c._t)("action|resend"))),t&&o.createElement(gB.K,{message:t})),o.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},(0,c._t)("auth|check_email_wrong_email_prompt")),o.createElement(ae.A,{className:"mx_AuthBody_resend-button",kind:"link",onClick:i},(0,c._t)("auth|check_email_wrong_email_button"))),o.createElement(ae.A,{onClick:n,className:"mx_Dialog_cancelButton","aria-label":(0,c._t)("dialog_close_label")}))};var EB=function(e){return e[e.EnterEmail=1]="EnterEmail",e[e.SendingEmail=2]="SendingEmail",e[e.EmailSent=3]="EmailSent",e[e.PasswordInput=4]="PasswordInput",e[e.ResettingPassword=5]="ResettingPassword",e[e.Done=6]="Done",e}(EB||{});class wB extends o.Component{constructor(e){super(e),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"reset",void 0),(0,S.A)(this,"fieldPassword",null),(0,S.A)(this,"fieldPasswordConfirm",null),(0,S.A)(this,"sendVerificationMail",async()=>{try{return await this.reset.requestResetToken(this.state.email),!0}catch(e){this.handleError(e)}return!1}),(0,S.A)(this,"onSubmitForm",async e=>{if(e.preventDefault(),[EB.SendingEmail,EB.ResettingPassword].includes(this.state.phase))return;this.setState({errorText:""});if(await this.checkServerLiveliness(this.props.serverConfig))switch(this.state.phase){case EB.EnterEmail:this.onPhaseEmailInputSubmit();break;case EB.EmailSent:this.onPhaseEmailSentSubmit();break;case EB.PasswordInput:this.onPhasePasswordInputSubmit()}}),(0,S.A)(this,"onInputChanged",(e,t)=>{let n=t.currentTarget.value;"email"===e&&(n=n.trim()),this.setState({[e]:n})}),this.state={phase:EB.EnterEmail,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverDeadError:"",logoutDevices:!1},this.reset=new uB(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.checkServerLiveliness(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}async checkServerLiveliness(e){try{if(await g.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.unmounted)return!1;this.setState({serverIsAlive:!0})}catch(e){if(this.unmounted)return!1;const{serverIsAlive:t,serverDeadError:n}=g.authComponentStateForError(e,"forgot_password");return this.setState({serverIsAlive:t,errorText:n}),t}return!0}async onPhaseEmailInputSubmit(){this.phase=EB.SendingEmail,await this.sendVerificationMail()?this.phase=EB.EmailSent:this.phase=EB.EnterEmail}handleError(e){if(429===(null==e?void 0:e.httpStatus)){var t;const n=parseInt(null==e||null===(t=e.data)||void 0===t?void 0:t.retry_after_ms,10),i=isNaN(n)?(0,c._t)("auth|reset_password|rate_limit_error"):(0,c._t)("auth|reset_password|rate_limit_error_with_time",{timeout:(0,gt.Xo)(n/1e3)});return void this.setState({errorText:i})}"ConnectionError"!==(null==e?void 0:e.name)?this.setState({errorText:e.message}):this.setState({errorText:(0,c._t)("cannot_reach_homeserver")+": "+(0,c._t)("cannot_reach_homeserver_detail")})}async onPhaseEmailSentSubmit(){this.setState({phase:EB.PasswordInput})}set phase(e){this.setState({phase:e})}async verifyFieldsBeforeSubmit(){const e=[this.fieldPassword,this.fieldPasswordConfirm],t=[];for(const n of e){if(!n)continue;await n.validate({allowEmpty:!1})||t.push(n)}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}async onPhasePasswordInputSubmit(){if(!await this.verifyFieldsBeforeSubmit())return;if(this.state.logoutDevices){if(!await this.renderConfirmLogoutDevicesDialog())return}this.phase=EB.ResettingPassword,this.reset.setLogoutDevices(this.state.logoutDevices);try{return await this.reset.setNewPassword(this.state.password),void this.setState({phase:EB.Done})}catch(e){if(401!==e.httpStatus)return void this.handleError(e)}const e=R.Ay.createDialog(bB,{email:this.state.email,errorText:this.state.errorText,onCloseClick:()=>{e.close(),this.setState({phase:EB.PasswordInput})},onReEnterEmailClick:()=>{e.close(),this.setState({phase:EB.EnterEmail})},onResendClick:this.sendVerificationMail},"mx_VerifyEMailDialog",!1,!1,{onBeforeClose:async e=>("backgroundClick"===e&&this.setState({phase:EB.PasswordInput}),!0)});for(;this.state.phase===EB.ResettingPassword;)try{await this.reset.setNewPassword(this.state.password),this.setState({phase:EB.Done}),e.close()}catch{await(0,_a.yy)(2e3)}}renderEnterEmail(){return o.createElement(vB,{email:this.state.email,errorText:this.state.errorText,homeserver:this.props.serverConfig.hsName,loading:this.state.phase===EB.SendingEmail,onInputChanged:this.onInputChanged,onLoginClick:this.props.onLoginClick,onSubmitForm:this.onSubmitForm})}async renderConfirmLogoutDevicesDialog(){const{finished:e}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("common|warning"),description:o.createElement("div",null,o.createElement("p",null,(0,c._t)("auth|reset_password|other_devices_logout_warning_1")),o.createElement("p",null,(0,c._t)("auth|reset_password|other_devices_logout_warning_2"))),button:(0,c._t)("action|continue")}),[t]=await e;return!!t}renderCheckEmail(){return o.createElement(yB,{email:this.state.email,errorText:this.state.errorText,onReEnterEmailClick:()=>this.setState({phase:EB.EnterEmail}),onResendClick:this.sendVerificationMail,onSubmitForm:this.onSubmitForm})}renderSetPassword(){const e=this.state.phase===EB.ResettingPassword?o.createElement(le.A,{w:16,h:16}):(0,c._t)("auth|reset_password_action");return o.createElement(o.Fragment,null,o.createElement(WS.A,{className:"mx_AuthBody_lockIcon"}),o.createElement("h1",null,(0,c._t)("auth|reset_password_title")),o.createElement("form",{onSubmit:this.onSubmitForm},o.createElement("fieldset",{disabled:this.state.phase===EB.ResettingPassword},o.createElement("div",{className:"mx_AuthBody_fieldRow"},o.createElement(_M.A,{name:"reset_password",type:"password",label:(0,c.AO)("auth|change_password_new_label"),value:this.state.password,minScore:3,fieldRef:e=>{this.fieldPassword=e},onChange:this.onInputChanged.bind(this,"password"),autoComplete:"new-password"}),o.createElement(RM.A,{name:"reset_password_confirm",label:(0,c.AO)("auth|reset_password|confirm_new_password"),labelRequired:(0,c.AO)("auth|reset_password|password_not_entered"),labelInvalid:(0,c.AO)("auth|reset_password|passwords_mismatch"),value:this.state.password2,password:this.state.password,fieldRef:e=>{this.fieldPasswordConfirm=e},onChange:this.onInputChanged.bind(this,"password2"),autoComplete:"new-password"})),o.createElement("div",{className:"mx_AuthBody_fieldRow"},o.createElement(Io.A,{onChange:()=>this.setState({logoutDevices:!this.state.logoutDevices}),checked:this.state.logoutDevices},(0,c._t)("auth|reset_password|sign_out_other_devices"))),this.state.errorText&&o.createElement(gB.K,{message:this.state.errorText}),o.createElement("button",{type:"submit",className:"mx_Login_submit"},e))))}renderDone(){return o.createElement(o.Fragment,null,o.createElement(ke.A,{className:"mx_Icon mx_Icon_32 mx_Icon_accent"}),o.createElement("h1",null,(0,c._t)("auth|reset_password|reset_successful")),this.state.logoutDevices?o.createElement("p",null,(0,c._t)("auth|reset_password|devices_logout_success")):null,o.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:(0,c._t)("auth|reset_password|return_to_login")}))}render(){let e;switch(this.state.phase){case EB.EnterEmail:case EB.SendingEmail:e=this.renderEnterEmail();break;case EB.EmailSent:e=this.renderCheckEmail();break;case EB.PasswordInput:case EB.ResettingPassword:e=this.renderSetPassword();break;case EB.Done:e=this.renderDone();break;default:return s.vF.warn(`unknown forgot password phase ${this.state.phase}`),void this.setState({phase:EB.EnterEmail})}return o.createElement(oB,null,o.createElement(hB,null),o.createElement(pB,{className:"mx_AuthBody_forgot-password"},e))}}class SB extends(te()){constructor(...e){super(...e),(0,S.A)(this,"status",void 0),(0,S.A)(this,"client",void 0),(0,S.A)(this,"onFinished",void 0)}static sharedInstance(){return window.mxInitialCryptoStore||(window.mxInitialCryptoStore=new SB),window.mxInitialCryptoStore}getStatus(){return this.status}startInitialCryptoSetup(e,t){this.client=e,this.onFinished=t,this.doSetup().catch(()=>s.vF.error("Initial crypto setup failed"))}retry(){return void 0!==this.client&&(this.doSetup().catch(()=>s.vF.error("Initial crypto setup failed")),!0)}reset(){this.client=void 0}async doSetup(){if(void 0===this.client)throw new Error("No setup is in progress");const e=this.client.getCrypto();if(!e)throw new Error("No crypto module found!");this.status="in_progress",this.emit("update");try{var t;await async function(e){const t=e.getCrypto();if(!t)throw new Error("No crypto API found!");await t.bootstrapCrossSigning({authUploadDeviceSigningKeys:t=>Me(e,t)})}(this.client);null===await e.checkKeyBackupAndEnable()&&await e.resetKeyBackup(),this.reset(),this.status="complete",this.emit("update"),null===(t=this.onFinished)||void 0===t||t.call(this,!0)}catch(e){s.vF.error("Error bootstrapping cross-signing",e),this.status="error",this.emit("update")}}}const xB=({onFinished:e})=>{const t=(0,o.useCallback)(()=>{SB.sharedInstance().retry()},[]),n=(0,o.useCallback)(()=>{e(!1)},[e]),i=(e=>{const[t,n]=(0,o.useState)(e.getStatus());return(0,o.useEffect)(()=>{const t=()=>{n(e.getStatus())};return e.on("update",t),()=>{e.off("update",t)}},[e]),t})(SB.sharedInstance());let r;return r="error"===i?o.createElement("div",null,o.createElement("p",null,(0,c._t)("encryption|unable_to_setup_keys_error")),o.createElement("div",{className:"mx_Dialog_buttons"},o.createElement(Kt.A,{primaryButton:(0,c._t)("action|retry"),onPrimaryButtonClick:t,onCancel:n}))):o.createElement("div",null,o.createElement(le.A,null)),o.createElement(X.A,{className:"mx_CreateCrossSigningDialog",onFinished:e,title:(0,c._t)("encryption|bootstrap_title"),hasCancel:!1,fixedWidth:!1},o.createElement("div",null,r))};class AB extends o.Component{render(){return o.createElement(oB,null,o.createElement(iB,null,o.createElement(xB,{onFinished:this.props.onFinished})))}}const CB=["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini","action","flow"],kB=e=>{let t,{matrixClient:r,loginType:s,fragmentAfterLogin:a,idp:d,primary:u,mini:m,action:h,flow:p}=e,g=(0,v.A)(e,CB);t=d?(0,c._t)("auth|continue_with_idp",{provider:d.name}):i.DELEGATED_OIDC_COMPATIBILITY.findIn(p)?(0,c._t)("action|continue"):(0,c._t)("auth|sign_in_with_sso");const f=()=>{var e,t;const n=(e=>{switch(e){case i.IdentityProviderBrand.Apple:return"Apple";case i.IdentityProviderBrand.Facebook:return"Facebook";case i.IdentityProviderBrand.Github:return"GitHub";case i.IdentityProviderBrand.Gitlab:return"GitLab";case i.IdentityProviderBrand.Google:return"Google";default:return"SSO"}})(null!==(e=null==d?void 0:d.brand)&&void 0!==e?e:"");z.Vo.instance.setAuthenticationType(n),null===(t=l.A.get())||void 0===t||t.startSingleSignOn(r,s,a,null==d?void 0:d.id,h)};let _,y;const b=null!=d&&d.brand?(e=>{switch(e){case i.IdentityProviderBrand.Apple:return n("./res/img/element-icons/brands/apple.svg").A;case i.IdentityProviderBrand.Facebook:return n("./res/img/element-icons/brands/facebook.svg").A;case i.IdentityProviderBrand.Github:return n("./res/img/element-icons/brands/github.svg").A;case i.IdentityProviderBrand.Gitlab:return n("./res/img/element-icons/brands/gitlab.svg").A;case i.IdentityProviderBrand.Google:return n("./res/img/element-icons/brands/google.svg").A;case i.IdentityProviderBrand.Twitter:return n("./res/img/element-icons/brands/twitter.svg").A;default:return null}})(d.brand):null;if(null!=d&&d.brand&&b){const e=d.brand.split(".").pop();y=`mx_SSOButton_brand_${e}`,_=o.createElement("img",{src:b,height:"24",width:"24",alt:e})}else if("string"==typeof(null==d?void 0:d.icon)&&d.icon.startsWith("mxc://")){var E;const e=null!==(E=(0,Vi.mediaFromMxc)(d.icon,r).getSquareThumbnailHttp(24))&&void 0!==E?E:void 0;_=o.createElement("img",{src:e,height:"24",width:"24",alt:d.name})}const w=y?{[y]:y}:void 0,S=me()("mx_SSOButton",{mx_SSOButton_mini:m,mx_SSOButton_default:!d,mx_SSOButton_primary:u},w);return m?o.createElement(ae.A,(0,tn.A)({},g,{title:t,className:S,onClick:f}),_):o.createElement(ae.A,(0,tn.A)({},g,{className:S,onClick:f}),_,t)},RB=({matrixClient:e,flow:t,loginType:n,fragmentAfterLogin:i,primary:r,action:s,disabled:a})=>{const l=t.identity_providers||[];if(l.length<2)return o.createElement("div",{className:"mx_SSOButtons"},o.createElement(kB,{matrixClient:e,loginType:n,fragmentAfterLogin:i,idp:l[0],primary:r,action:s,flow:t,disabled:a}));const c=Math.ceil(l.length/6),d=Math.ceil(l.length/c);return o.createElement("div",{className:"mx_SSOButtons"},(0,Li.chunk)(l,d).map(a=>o.createElement("div",{key:a[0].id,className:"mx_SSOButtons_row"},a.map(a=>o.createElement(kB,{key:a.id,matrixClient:e,loginType:n,fragmentAfterLogin:i,idp:a,mini:!0,primary:r,action:s,flow:t})))))};class IB extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"defaultServer",void 0),(0,S.A)(this,"fieldRef",(0,o.createRef)()),(0,S.A)(this,"validatedConf",void 0),(0,S.A)(this,"onDefaultChosen",()=>{this.setState({defaultChosen:!0})}),(0,S.A)(this,"onOtherChosen",()=>{this.setState({defaultChosen:!1})}),(0,S.A)(this,"onHomeserverChange",e=>{this.setState({otherHomeserver:e.target.value})}),(0,S.A)(this,"validate",(0,Mx.A)({deriveData:async({value:e})=>{let t=(null!=e?e:"").trim();if(!t.includes("://"))try{const e=await i.AutoDiscovery.findClientConfig(t);return this.validatedConf=await g.buildValidatedConfigFromDiscovery(t,e),{}}catch(e){s.vF.error(`Attempted ${t} as a server_name but it failed`,e)}t.includes("://")||(t="https://"+t);try{return this.validatedConf=await g.validateServerConfigWithStaticUrls(t),{}}catch(e){s.vF.error(e);if(g.authComponentStateForError(e).serverErrorIsFatal){let t=(0,c._t)("auth|server_picker_failed_validate_homeserver");return e instanceof c.P7&&e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await g.validateServerConfigWithStaticUrls(t,void 0,!0),{}}catch(e){return s.vF.error(e),{error:(0,c._t)("auth|server_picker_invalid_url")}}}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("auth|server_picker_required")},{key:"valid",test:async function({value:e},{error:t}){return!e||!t},invalid:function({error:e}){return null!=e?e:null}}]})),(0,S.A)(this,"onHomeserverValidate",e=>this.validate(e)),(0,S.A)(this,"onSubmit",async e=>{var t;if(e.preventDefault(),this.state.defaultChosen)return void this.props.onFinished(this.defaultServer);var n,i;if(!await(null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate({allowEmpty:!1})))return null===(n=this.fieldRef.current)||void 0===n||n.focus(),void(null===(i=this.fieldRef.current)||void 0===i||i.validate({allowEmpty:!1,focused:!0}));this.props.onFinished(this.validatedConf)});const t=d.Ay.get();this.defaultServer=t.validated_server_config;const{serverConfig:n}=this.props;let r="";n.isDefault||(r=n.isNameResolvable&&n.hsName?n.hsName:n.hsUrl),this.state={defaultChosen:n.isDefault,otherHomeserver:r}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=(0,c._t)("auth|server_picker_matrix.org"));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=o.createElement(SC.A,{className:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),o.createElement(X.A,{title:this.props.title||(0,c._t)("auth|server_picker_title"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},o.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},o.createElement("p",null,(0,c._t)("auth|server_picker_intro")," ",e),o.createElement(Eo.A,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),o.createElement(Eo.A,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen,childrenInLabel:!1,"aria-label":(0,c._t)("auth|server_picker_custom")},o.createElement(wo.A,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:(0,c._t)("auth|server_picker_custom"),onChange:this.onHomeserverChange,onFocus:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,autoFocus:!0,id:"mx_homeserverInput"})),o.createElement("p",null,(0,c._t)("auth|server_picker_explainer")),o.createElement(ae.A,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},(0,c._t)("action|continue")),o.createElement("h2",null,(0,c._t)("action|learn_more")),o.createElement(Hp.A,{href:"https://matrix.org/docs/matrix-concepts/elements-of-matrix/#homeserver",target:"_blank",rel:"noreferrer noopener"},(0,c._t)("auth|server_picker_learn_more"))))}}const TB=()=>{const e=d.Ay.get().brand;R.Ay.createDialog(zp.A,{title:(0,c._t)("auth|server_picker_title_default"),description:(0,c._t)("auth|server_picker_description",{brand:e}),button:(0,c._t)("action|dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")},PB=({title:e,dialogTitle:t,serverConfig:n,onServerConfigChange:i,disabled:r})=>{const s=d.Ay.get("disable_custom_urls");let a;if(!s&&i){const e=()=>{((e,t,n)=>{const{finished:i}=R.Ay.createDialog(IB,{title:e,serverConfig:t});i.then(([e])=>n(e))})(t,n,e=>{e&&i(e)})};a=o.createElement(ae.A,{className:"mx_ServerPicker_change",kind:"link",onClick:e,disabled:r},(0,c._t)("action|edit"))}let l,u=n.isNameResolvable?n.hsName:n.hsUrl;return n.hsNameIsDifferent&&(u=o.createElement(SC.A,{className:"mx_Login_underlinedServerName",tooltip:n.hsUrl},n.hsName)),"matrix.org"===n.hsName&&(l=o.createElement("span",{className:"mx_ServerPicker_desc"},(0,c._t)("auth|server_picker_description_matrix.org"))),o.createElement("div",{className:"mx_ServerPicker"},o.createElement("h2",null,e||(0,c._t)("common|homeserver")),s?null:o.createElement(ae.A,{className:"mx_ServerPicker_help",onClick:TB,"aria-label":(0,c._t)("common|help")}),o.createElement("span",{className:"mx_ServerPicker_server",title:"string"==typeof u?u:void 0},u),a,l)};var NB=n("./src/components/structures/auth/header/AuthHeaderContext.tsx");function DB({title:e,icon:t,serverPicker:n,children:i}){var r,s,a;const l=(0,o.useContext)(NB.h);if(!l)return o.createElement(o.Fragment,null);const c=null!==(r=l.state[0])&&void 0!==r?r:null;return o.createElement(o.Fragment,null,null!==(s=null==c?void 0:c.icon)&&void 0!==s?s:t,o.createElement("h1",null,null!==(a=null==c?void 0:c.title)&&void 0!==a?a:e),i,!0!==(null==c?void 0:c.hideServerPicker)&&n)}var MB=n("./src/components/structures/auth/header/AuthHeaderProvider.tsx");function OB(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}const FB=(...e)=>{O.A.getValue("debug_registration")&&s.vF.log.call(console,"Registration debuglog:",...e)};class LB extends o.Component{constructor(e){super(e),(0,S.A)(this,"loginLogic",void 0),(0,S.A)(this,"latestServerConfig",void 0),(0,S.A)(this,"unloadCallback",e=>{if(this.state.doingUIAuth)return e.preventDefault(),e.returnValue="",""}),(0,S.A)(this,"onFormSubmit",async e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})}),(0,S.A)(this,"requestEmailToken",(e,t,n,i)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");return this.state.matrixClient.requestRegisterEmailToken(e,t,n)}),(0,S.A)(this,"onUIAuthFinished",async(e,t)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");if(FB("Registration: ui authentication finished: ",{success:e,response:t}),!e){var n;let e=t.message||t.toString();if(t instanceof i.MatrixError&&"M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const n=(0,cs.AB)(t.data.limit_type,t.data.admin_contact,cs.Ch),i=(0,cs.AB)(t.data.limit_type,t.data.admin_contact,cs.aZ);e=o.createElement("div",null,o.createElement("p",null,n),o.createElement("p",null,i))}else if(null!==(n=t.flows)&&void 0!==n&&n.some(e=>e.stages.includes(i.AuthType.Msisdn))){var r;(null!==(r=t.flows)&&void 0!==r?r:[]).some(e=>e.stages.includes(i.AuthType.Msisdn))||(e=(0,c._t)("auth|unsupported_auth_msisdn"))}else t instanceof i.MatrixError&&"M_USER_IN_USE"===t.errcode?e=(0,c._t)("auth|username_in_use"):t instanceof i.MatrixError&&"M_THREEPID_IN_USE"===t.errcode&&(e=(0,c._t)("auth|3pid_in_use"));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}const a=t.user_id,l=t.access_token;if(!a||!l)throw new Error("Registration failed");f.J.setJustRegisteredUserId(a);const d={doingUIAuth:!1,registeredUsername:a,differentLoggedInUserId:void 0,completedNoSignin:!1,busy:!0},[u,m]=await Us();u&&!m&&u!==a&&(s.vF.log(`Found a session for ${u} but ${a} has just registered.`),d.differentLoggedInUserId=u);const h=Boolean(this.state.formVals.email),p=Boolean(l);if(FB("Registration: ui auth finished:",{hasEmail:h,hasAccessToken:p}),p&&!d.differentLoggedInUserId)if(this.props.mobileRegister){const e={user_id:a,home_server:this.state.matrixClient.getHomeserverUrl(),access_token:l,device_id:t.device_id},n=new CustomEvent("mobileregistrationresponse",{detail:e});window.dispatchEvent(n),d.busy=!1,d.completedNoSignin=!0}else await this.props.onLoggedIn({userId:a,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:l}),this.setupPushers();else d.busy=!1,d.completedNoSignin=!0;this.setState(d)}),(0,S.A)(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),(0,S.A)(this,"onGoToFormClicked",e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})}),(0,S.A)(this,"makeRegisterRequest",e=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");const t={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(t.auth=e),FB("Registration: sending registration request:",e),this.state.matrixClient.registerRequest(t)}),(0,S.A)(this,"onLoginClickWithCheck",async e=>{e.preventDefault();const t=await Ls({ignoreGuest:!0});return t||this.props.onLoginClick(),t}),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""};const{hsUrl:t,isUrl:n,delegatedAuthentication:r}=this.props.serverConfig;this.loginLogic=new T(t,n,null,{defaultDeviceDisplayName:"Element login check",delegatedAuthentication:r})}componentDidMount(){this.replaceClient(this.props.serverConfig),window.addEventListener("beforeunload",this.unloadCallback)}componentWillUnmount(){window.removeEventListener("beforeunload",this.unloadCallback)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(this.props.serverConfig)}async replaceClient(e){this.latestServerConfig=e;const{hsUrl:t,isUrl:n}=e;this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{if(await g.validateServerConfigWithStaticUrls(t,n),e!==this.latestServerConfig)return;this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(t){if(e!==this.latestServerConfig)return;if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?OB(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):OB(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({busy:!1},g.authComponentStateForError(t,"register"))),this.state.serverErrorIsFatal)return}const r=(0,i.createClient)({baseUrl:t,idBaseUrl:n});let o,a;this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(n),this.loginLogic.setDelegatedAuthentication(e.delegatedAuthentication);try{const t=await this.loginLogic.getFlows(!0);if(e!==this.latestServerConfig)return;o=t.find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type),a=t.find(e=>"oidcNativeFlow"===e.type)}catch(t){if(e!==this.latestServerConfig)return;s.vF.error("Failed to get login flows to check for SSO support",t)}if(await new Promise(e=>{this.setState(({flows:e})=>({matrixClient:r,ssoFlow:o,oidcNativeFlow:a,flows:a?[]:e,busy:!1}),e)}),!a)try{if(!this.state.doingUIAuth){if(await this.makeRegisterRequest(null),e!==this.latestServerConfig)return;s.vF.log("Expecting 401 from register request but got success!")}}catch(t){if(e!==this.latestServerConfig)return;t instanceof i.MatrixError&&401===t.httpStatus?this.setState({flows:t.data.flows}):t instanceof i.MatrixError&&(403===t.httpStatus||"M_FORBIDDEN"===t.errcode)?o?x.A.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:(0,c._t)("auth|registration_disabled"),flows:[]}):(s.vF.log("Unable to query for supported registration methods.",t),this.setState({errorText:(0,c._t)("auth|failed_query_registration_methods"),flows:[]}))}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=f.J.safeGet();return e.getPushers().then(t=>{const n=t.pushers;for(let t=0;t<n.length;++t)if("email"===n[t].kind){const i=n[t];i.data={brand:this.props.brand},e.setPusher(i).then(()=>{s.vF.log("Set email branding to "+this.props.brand)},e=>{s.vF.error("Couldn't set email branding: "+e)})}},e=>{s.vF.error("Couldn't get pushers: "+e)})}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){if(this.state.matrixClient&&this.state.doingUIAuth)return o.createElement(vM.A,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return o.createElement("div",{className:"mx_AuthBody_spinner"},o.createElement(le.A,null));if(this.state.matrixClient&&this.state.oidcNativeFlow)return o.createElement(ae.A,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await hs(this.props.serverConfig.delegatedAuthentication,this.state.oidcNativeFlow.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl,!0)}},(0,c._t)("action|continue"));if(this.state.matrixClient&&this.state.flows.length){let e;if(!this.props.mobileRegister&&this.state.ssoFlow){let t;(this.state.ssoFlow.identity_providers||[]).length>1&&(t=o.createElement("h2",{className:"mx_AuthBody_centered"},(0,c._t)("auth|continue_with_sso",{ssoButtons:""}).trim())),e=o.createElement(o.Fragment,null,t,o.createElement(RB,{matrixClient:this.loginLogic.createTemporaryClient(),flow:this.state.ssoFlow,loginType:"m.login.sso"===this.state.ssoFlow.type?"sso":"cas",fragmentAfterLogin:this.props.fragmentAfterLogin,action:i.SSOAction.REGISTER}),o.createElement("h2",{className:"mx_AuthBody_centered"},(0,c._t)("auth|sso_or_username_password",{ssoButtons:"",usernamePassword:""}).trim()))}return o.createElement(o.Fragment,null,e,o.createElement(FM,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,matrixClient:this.state.matrixClient,mobileRegister:this.props.mobileRegister}))}return null}render(){let e;const t=this.state.errorText;let n;if(t&&(e=o.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=me()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=o.createElement("div",{className:e},this.state.serverDeadError)}const i=o.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,c._t)("auth|sign_in_instead_prompt",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.onLoginClick},e)}));let r,s;if(this.state.doingUIAuth&&(r=o.createElement(ae.A,{kind:"link",className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked},(0,c._t)("action|go_back"))),this.state.completedNoSignin){let e;e=this.props.mobileRegister?void 0:this.state.differentLoggedInUserId?o.createElement("div",null,o.createElement("p",null,(0,c._t)("auth|account_clash",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),o.createElement("p",null,o.createElement(ae.A,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&x.A.dispatch({action:"view_welcome_page"})}},(0,c._t)("auth|account_clash_previous_account")))):o.createElement("h2",null,(0,c._t)("auth|log_in_new_account",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&x.A.dispatch({action:"view_home_page"})}},e)})),s=o.createElement("div",null,o.createElement("h1",null,(0,c._t)("auth|registration_successful")),e)}else s=this.props.mobileRegister?o.createElement(o.Fragment,null,o.createElement("h1",null,(0,c._t)("auth|mobile_create_account_title",{hsName:this.props.serverConfig.hsName})),e,n,this.renderRegisterComponent()):o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_Register_mainContent"},o.createElement(DB,{title:(0,c._t)("auth|create_account_title"),serverPicker:o.createElement(PB,{title:(0,c._t)("auth|server_picker_title_registration"),dialogTitle:(0,c._t)("auth|server_picker_dialog_title"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange})},e,n),this.renderRegisterComponent()),o.createElement("div",{className:"mx_Register_footerActions"},r,i));return this.props.mobileRegister?o.createElement("div",{className:"mx_MobileRegister_body"},s):o.createElement(oB,null,o.createElement(hB,null),o.createElement(MB.T,null,o.createElement(pB,{flex:!0},s)))}}let UB,BB,VB,jB;const zB=/^[0-9()\-\s]*$/;var HB=function(e){return e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_password",e}(HB||{});UB=HB.Email,BB=HB.Phone,VB=HB.MatrixId,jB=HB.Password;class WB extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,UB,null),(0,S.A)(this,BB,null),(0,S.A)(this,VB,null),(0,S.A)(this,jB,null),(0,S.A)(this,"onForgotPasswordClick",e=>{var t,n;e.preventDefault(),e.stopPropagation(),null===(t=(n=this.props).onForgotPasswordClick)||void 0===t||t.call(n)}),(0,S.A)(this,"onSubmitForm",async e=>{e.preventDefault();if(await this.verifyFieldsBeforeSubmit())switch(this.state.loginType){case HB.Email:case HB.MatrixId:this.props.onSubmit(this.props.username,void 0,void 0,this.state.password);break;case HB.Phone:this.props.onSubmit(void 0,this.props.phoneCountry,this.props.phoneNumber,this.state.password)}}),(0,S.A)(this,"onUsernameChanged",e=>{var t,n;null===(t=(n=this.props).onUsernameChanged)||void 0===t||t.call(n,e.target.value)}),(0,S.A)(this,"onUsernameBlur",e=>{var t,n;null===(t=(n=this.props).onUsernameBlur)||void 0===t||t.call(n,e.target.value)}),(0,S.A)(this,"onLoginTypeChange",e=>{var t,n;const i=e.target.value;this.setState({loginType:i}),null===(t=(n=this.props).onUsernameChanged)||void 0===t||t.call(n,"")}),(0,S.A)(this,"onPhoneCountryChanged",e=>{var t,n;null===(t=(n=this.props).onPhoneCountryChanged)||void 0===t||t.call(n,e.iso2)}),(0,S.A)(this,"onPhoneNumberChanged",e=>{var t,n;null===(t=(n=this.props).onPhoneNumberChanged)||void 0===t||t.call(n,e.target.value)}),(0,S.A)(this,"onPasswordChanged",e=>{this.setState({password:e.target.value})}),(0,S.A)(this,"validateUsernameRules",(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("auth|username_field_required_invalid")}]})),(0,S.A)(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(HB.MatrixId,t.valid),t}),(0,S.A)(this,"onEmailValidate",e=>{this.markFieldValid(HB.Email,e.valid)}),(0,S.A)(this,"validatePhoneNumberRules",(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("auth|msisdn_field_required_invalid")},{key:"number",test:({value:e})=>!e||zB.test(e),invalid:()=>(0,c._t)("auth|msisdn_field_number_invalid")}]})),(0,S.A)(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(HB.Password,t.valid),t}),(0,S.A)(this,"validatePasswordRules",(0,Mx.A)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>(0,c._t)("auth|password_field_label")}]})),(0,S.A)(this,"onPasswordValidate",async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(HB.Password,t.valid),t}),this.state={fieldValid:{},loginType:HB.MatrixId,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,HB.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const n=this.findFirstInvalidField(t);return!n||(n.focus(),n.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:n}=this.state;n[e]=t,this.setState({fieldValid:n})}renderLoginField(e,t){const n={error:!1};switch(e){case HB.Email:return n.error=this.props.loginIncorrect&&!this.props.username,o.createElement(xM,{id:"mx_LoginForm_email",className:me()(n),name:"username",autoComplete:"email",type:"email",key:"email_input",placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onEmailValidate,fieldRef:e=>{this[HB.Email]=e}});case HB.MatrixId:return n.error=this.props.loginIncorrect&&!this.props.username,o.createElement(wo.A,{id:"mx_LoginForm_username",className:me()(n),name:"username",autoComplete:"username",key:"username_input",type:"text",label:(0,c._t)("common|username"),placeholder:(0,c._t)("common|username"),value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>{this[HB.MatrixId]=e}});case HB.Phone:{n.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=o.createElement(kM,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return o.createElement(wo.A,{id:"mx_LoginForm_phone",className:me()(n),name:"phoneNumber",autoComplete:"tel-national",key:"phone_input",type:"text",label:(0,c._t)("auth|msisdn_field_label"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,disabled:this.props.busy,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>{this[HB.Password]=e}})}}}isLoginEmpty(){switch(this.state.loginType){case HB.Email:case HB.MatrixId:return!this.props.username;case HB.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=o.createElement(ae.A,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},(0,c._t)("auth|reset_password_button")));const t=me()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),n=!this.isLoginEmpty(),i=this.renderLoginField(this.state.loginType,!n);let r;return d.Ay.get().disable_3pid_login||(r=o.createElement("div",{className:"mx_Login_type_container"},o.createElement("label",{className:"mx_Login_type_label"},(0,c._t)("auth|identifier_label")),o.createElement(wo.A,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.busy},o.createElement("option",{key:HB.MatrixId,value:HB.MatrixId},(0,c._t)("common|username")),o.createElement("option",{key:HB.Email,value:HB.Email},(0,c._t)("common|email_address")),o.createElement("option",{key:HB.Password,value:HB.Password},(0,c._t)("auth|msisdn_field_label"))))),o.createElement("div",null,o.createElement("form",{onSubmit:this.onSubmitForm},r,i,o.createElement(wo.A,{id:"mx_LoginForm_password",className:t,autoComplete:"current-password",type:"password",name:"password",label:(0,c._t)("common|password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.busy,autoFocus:n,onValidate:this.onPasswordValidate,ref:e=>{this[HB.Password]=e}}),e,!this.props.busy&&o.createElement("input",{className:"mx_Login_submit",type:"submit",value:(0,c._t)("action|sign_in"),disabled:this.props.disableSubmit})))}}function GB(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function KB(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?GB(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):GB(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}(0,S.A)(WB,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1});class qB extends o.PureComponent{constructor(e){super(e),(0,S.A)(this,"unmounted",!1),(0,S.A)(this,"loginLogic",void 0),(0,S.A)(this,"stepRendererMap",void 0),(0,S.A)(this,"isBusy",()=>!!this.state.busy||!!this.props.busy),(0,S.A)(this,"onPasswordLogin",async(e,t,n,i)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await g.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const n=g.authComponentStateForError(t);this.setState(KB({busy:!1,busyLoggingIn:!1},n)),e=!n.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this.loginLogic.loginViaPassword(e,t,n,i).then(e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e)},t=>{if(this.unmounted)return;let n;n=400===t.httpStatus&&e&&e.indexOf("@")>0?(0,c._t)("auth|unsupported_auth_email"):(0,cs.Y0)(t,this.props.serverConfig),this.setState({busy:!1,busyLoggingIn:!1,errorText:n,loginIncorrect:401===t.httpStatus||403===t.httpStatus})})}),(0,S.A)(this,"onUsernameChanged",e=>{this.setState({username:e})}),(0,S.A)(this,"onUsernameBlur",async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await g.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){s.vF.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=(0,c._t)("auth|failed_homeserver_discovery");e instanceof c.P7&&e.translatedMessage&&(t=e.translatedMessage);let n=t,i={};g.isLivelinessError(e)&&(n=this.state.errorText,i=g.authComponentStateForError(e)),this.setState(KB({busy:!1,errorText:n},i))}}}),(0,S.A)(this,"onPhoneCountryChanged",e=>{this.setState({phoneCountry:e})}),(0,S.A)(this,"onPhoneNumberChanged",e=>{this.setState({phoneNumber:e})}),(0,S.A)(this,"onRegisterClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()}),(0,S.A)(this,"onTryRegisterClick",e=>{var t,n;const r=null===(t=this.state.flows)||void 0===t?void 0:t.find(e=>"m.login.password"===e.type),o=null===(n=this.state.flows)||void 0===n?void 0:n.find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type);if(o&&!r){var s;e.preventDefault(),e.stopPropagation();const t="m.login.sso"===o.type?"sso":"cas";null===(s=l.A.get())||void 0===s||s.startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin,void 0,i.SSOAction.REGISTER)}else this.onRegisterClick(e)}),(0,S.A)(this,"isSupportedFlow",e=>!!this.stepRendererMap[e.type]||(s.vF.log("Skipping flow",e,"due to unsupported login type",e.type),!1)),(0,S.A)(this,"renderPasswordStep",()=>o.createElement(WB,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn})),(0,S.A)(this,"renderOidcNativeStep",()=>{const e=this.state.flows.find(e=>"oidcNativeFlow"===e.type);return o.createElement(ae.A,{className:"mx_Login_fullWidthButton",kind:"primary",onClick:async()=>{await hs(this.props.serverConfig.delegatedAuthentication,e.clientId,this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}},(0,c._t)("action|continue"))}),(0,S.A)(this,"renderSsoStep",e=>{var t,n;const r=null===(t=this.state.flows)||void 0===t?void 0:t.find(t=>t.type==="m.login."+e);return o.createElement(RB,{matrixClient:this.loginLogic.createTemporaryClient(),flow:r,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!(null!==(n=this.state.flows)&&void 0!==n&&n.find(e=>"m.login.password"===e.type)),action:i.SSOAction.LOGIN,disabled:this.isBusy()})}),this.state={busy:!1,errorText:null,loginIncorrect:!1,canTryLogin:!0,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:"",phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso"),oidcNativeFlow:()=>this.renderOidcNativeStep()}}componentDidMount(){this.unmounted=!1,this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl&&e.serverConfig.delegatedAuthentication===this.props.serverConfig.delegatedAuthentication||this.initLoginLogic(this.props.serverConfig)}async checkServerLiveliness({hsUrl:e,isUrl:t}){try{const{warning:n}=await g.validateServerConfigWithStaticUrls(e,t);n?this.setState(KB(KB({},g.authComponentStateForError(n)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(KB({busy:!1},g.authComponentStateForError(e)))}}async initLoginLogic({hsUrl:e,isUrl:t}){let n=!1;this.props.serverConfig.isDefault&&e===this.props.serverConfig.hsUrl&&t===this.props.serverConfig.isUrl&&(n=!0);const i=n?this.props.fallbackHsUrl:null;this.setState({busy:!0,loginIncorrect:!1}),await this.checkServerLiveliness({hsUrl:e,isUrl:t});const r=new T(e,t,i,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,delegatedAuthentication:this.props.serverConfig.delegatedAuthentication});this.loginLogic=r,r.getFlows().then(e=>{const t=e.filter(this.isSupportedFlow);this.setState({flows:t}),0===t.length&&this.setState({errorText:(0,c._t)("auth|unsupported_auth")})},e=>{this.setState({errorText:(0,cs.Vp)(e,this.props.serverConfig),loginIncorrect:!1,canTryLogin:!1})}).finally(()=>{this.setState({busy:!1})})}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=(0,ie.Bo)(["oidcNativeFlow","m.login.password","m.login.sso"].map(e=>{var t;return null===(t=this.state.flows)||void 0===t?void 0:t.find(t=>t.type===e)}));return o.createElement(o.Fragment,null,e.map(e=>{const t=this.stepRendererMap[e.type];return o.createElement(o.Fragment,{key:e.type},t())}))}render(){const e=this.isBusy()&&!this.state.busyLoggingIn?o.createElement("div",{className:"mx_Login_loader"},o.createElement(le.A,null)):null,t=this.state.errorText;let n,i,r;if(t&&(n=o.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=me()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});i=o.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?r=o.createElement("div",{className:"mx_AuthBody_paddedFooter"},o.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},o.createElement(tl.A,{w:20,h:20}),this.props.isSyncing?(0,c._t)("auth|syncing"):(0,c._t)("auth|signing_in")),this.props.isSyncing&&o.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},(0,c._t)("auth|sync_footer_subtitle"))):O.A.getValue(It.f.Registration)&&(r=o.createElement("span",{className:"mx_AuthBody_changeFlow"},(0,c._t)("auth|create_account_prompt",{},{a:e=>o.createElement(ae.A,{kind:"link_inline",onClick:this.onTryRegisterClick},e)}))),o.createElement(oB,null,o.createElement(hB,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),o.createElement(pB,null,o.createElement("h1",null,(0,c._t)("action|sign_in"),e),n,i,o.createElement(PB,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange,disabled:this.isBusy()}),this.renderLoginComponentForFlows(),r))}}var $B=n("./src/utils/KeyVerificationStateObserver.ts");class JB extends o.PureComponent{constructor(e){var t;super(e),(0,S.A)(this,"intervalHandle",void 0),(0,S.A)(this,"checkRequestIsPending",()=>{const{request:e}=this.props;(0,V.Dy)(e)||L.A.sharedInstance().dismissToast(this.props.toastKey)}),(0,S.A)(this,"cancel",()=>{L.A.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){s.vF.error("Error while cancelling verification request",e)}}),(0,S.A)(this,"accept",async()=>{L.A.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=f.J.safeGet();try{if(e.roomId){var n;x.A.dispatch({action:W.r.ViewRoom,room_id:e.roomId,should_peek:!1,metricsTrigger:"VerificationRequest"});const i=null!==(n=t.getUser(e.otherUserId))&&void 0!==n?n:void 0;lg.A.instance.setCards([{phase:cg.n.RoomSummary},{phase:cg.n.MemberInfo,state:{member:i}},{phase:cg.n.EncryptionPanel,state:{verificationRequest:e,member:i}}],void 0,e.roomId)}else{const{finished:t}=R.Ay.createDialog(Z,{verificationRequest:e},void 0,!1,!0);t.then(()=>e.cancel())}await e.accept()}catch(e){s.vF.error("Failed to accept verification request",e)}}),this.state={counter:Math.ceil((null!==(t=e.request.timeout)&&void 0!==t?t:0)/1e3)}}async componentDidMount(){const{request:e}=this.props;e.timeout&&e.timeout>0&&(this.intervalHandle=window.setInterval(()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})},1e3)),e.on(V.FM.Change,this.checkRequestIsPending),this.checkRequestIsPending();const t=e.otherDeviceId;if(e.isSelfVerification&&t){const e=f.J.safeGet(),n=await e.getDevice(t);this.setState({ip:n.last_seen_ip,device:await(0,Tt.G)(e,e.getSafeUserId(),t)})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off(V.FM.Change,this.checkRequestIsPending)}render(){const{request:e}=this.props;let t,n;if(e.isSelfVerification)this.state.device&&(t=this.state.device.displayName,n=(0,c._t)("encryption|verification|request_toast_detail",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const n=f.J.safeGet(),i=e.otherUserId,r=e.roomId;if(t=r?(0,$B.M)(n,i,r):i,t===i){const e=n.getUser(i);e&&e.displayName&&(t=(0,c._t)("name_and_id",{name:e.displayName,userId:i}))}}const i=0===this.state.counter?(0,c._t)("action|ignore"):(0,c._t)("encryption|verification|request_toast_decline_counter",{counter:this.state.counter});return o.createElement(H.A,{description:t,detail:n,primaryLabel:e.isSelfVerification||!e.roomId?(0,c._t)("encryption|verification|request_toast_accept"):(0,c._t)("encryption|verification|request_toast_accept_user"),onPrimaryClick:this.accept,secondaryLabel:i,onSecondaryClick:this.cancel})}}let YB=function(e){return e.PAGE_CHANGE="mx_PageChange",e.LOGIN="mx_Login",e.REGISTER="mx_Register",e}({});class XB{constructor(){(0,S.A)(this,"START_PREFIX","start:"),(0,S.A)(this,"STOP_PREFIX","stop:"),(0,S.A)(this,"listeners",[]),(0,S.A)(this,"entries",[])}static get instance(){return XB._instance||(XB._instance=new XB),XB._instance}start(e,t){if(!this.supportsPerformanceApi())return;const n=this.buildKey(e,t);performance.getEntriesByName(this.START_PREFIX+n).length>0?s.vF.warn(`Recording already started for: ${e}`):performance.mark(this.START_PREFIX+n)}stop(e,t){if(!this.supportsPerformanceApi())return;const n=this.buildKey(e,t);if(0===performance.getEntriesByName(this.START_PREFIX+n).length)return void s.vF.warn(`No recording started for: ${e}`);performance.mark(this.STOP_PREFIX+n),performance.measure(n,this.START_PREFIX+n,this.STOP_PREFIX+n),this.clear(e,t);const i=performance.getEntriesByName(n).pop();return this.entries.push(i),this.listeners.forEach(e=>{this.shouldEmit(e,i)&&e.callback([i])}),i}clear(e,t){if(!this.supportsPerformanceApi())return;const n=this.buildKey(e,t);performance.clearMarks(this.START_PREFIX+n),performance.clearMarks(this.STOP_PREFIX+n)}getEntries({name:e,type:t}={}){return this.entries.filter(n=>{const i=!e||n.name===e,r=!t||n.entryType===t;return i&&r})}addPerformanceDataCallback(e,t=!1){if(this.listeners.push(e),t){const t=this.entries.filter(t=>this.shouldEmit(e,t));t.length>0&&e.callback(t)}}removePerformanceDataCallback(e){e?this.listeners.splice(this.listeners.findIndex(t=>t.callback===e),1):this.listeners=[]}supportsPerformanceApi(){return void 0!==performance&&void 0!==performance.mark}shouldEmit(e,t){return!e.entryNames||e.entryNames.includes(t.name)}buildKey(e,t){return`${e}${t?`:${t}`:""}`}}(0,S.A)(XB,"_instance",void 0),window.mxPerformanceMonitor=XB.instance,window.mxPerformanceEntryNames=YB;class QB extends o.Component{constructor(...e){super(...e),(0,S.A)(this,"onConfirm",()=>{this.props.onFinished(!0)}),(0,S.A)(this,"onDecline",()=>{this.props.onFinished(!1)})}render(){return o.createElement(X.A,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:(0,c._t)("auth|soft_logout|clear_data_title")},o.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},o.createElement("p",null,(0,c._t)("auth|soft_logout|clear_data_description"))),o.createElement(Kt.A,{primaryButton:(0,c._t)("auth|soft_logout|clear_data_button"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:(0,c._t)("action|cancel"),onCancel:this.onDecline}))}}var ZB=function(e){return e[e.Loading=0]="Loading",e[e.Password=1]="Password",e[e.CAS=2]="CAS",e[e.SSO=3]="SSO",e[e.PasswordWithSocialSignOn=4]="PasswordWithSocialSignOn",e[e.Unsupported=5]="Unsupported",e}(ZB||{});const eV={"m.login.password":ZB.Password,"m.login.cas":ZB.CAS,"m.login.sso":ZB.SSO};class tV extends o.Component{constructor(e){super(e),(0,S.A)(this,"onClearAll",()=>{const{finished:e}=R.Ay.createDialog(QB);e.then(([e])=>{e&&(s.vF.log("Clearing data from soft-logged-out session"),Zs(this.context.oidcClientStore))})}),(0,S.A)(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),(0,S.A)(this,"onForgotPassword",()=>{x.A.dispatch({action:"start_password_recovery"})}),(0,S.A)(this,"onPasswordLogin",async e=>{var t;e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const n=f.J.safeGet(),r=n.getHomeserverUrl(),o=n.getIdentityServerUrl(),a={identifier:{type:"m.id.user",user:n.getUserId()},password:this.state.password,device_id:null!==(t=n.getDeviceId())&&void 0!==t?t:void 0};let l;try{l=await N(r,o,"m.login.password",a)}catch(e){let t=(0,c._t)("auth|failed_soft_logout_homeserver");return e instanceof i.MatrixError&&"M_FORBIDDEN"===e.errcode&&(401===e.httpStatus||403===e.httpStatus)&&(t=(0,c._t)("auth|incorrect_password")),void this.setState({busy:!1,errorText:t})}$s(l).catch(e=>{s.vF.error(e),this.setState({busy:!1,errorText:(0,c._t)("auth|failed_soft_logout_auth")})})}),this.state={loginView:ZB.Loading,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){ta()?this.initLogin():x.A.dispatch({action:"start_login"})}async initLogin(){const e=this.props.realQueryParams;if(null==e?void 0:e.loginToken){this.setState({loginView:ZB.Loading});if(await this.trySsoLogin())return}const t=f.J.safeGet(),n=(await t.loginFlows()).flows,i=n.map(e=>eV[e.type]),r=i.includes(ZB.Password)&&i.includes(ZB.SSO),o=i.filter(e=>!!e)[0]||ZB.Unsupported,s=r?ZB.PasswordWithSocialSignOn:o;this.setState({flows:n,loginView:s})}async trySsoLogin(){var e;this.setState({busy:!0});const t=localStorage.getItem(Ft.FL);if(!t)return s.vF.error("Homeserver URL unknown for SSO login callback"),this.setState({busy:!1,loginView:ZB.Unsupported}),!1;const n=localStorage.getItem(Ft.U7)||f.J.safeGet().getIdentityServerUrl(),i={token:this.props.realQueryParams.loginToken,device_id:null!==(e=f.J.safeGet().getDeviceId())&&void 0!==e?e:void 0};let r;try{r=await N(t,n,"m.login.token",i)}catch(e){return s.vF.error(e),this.setState({busy:!1,loginView:ZB.Unsupported}),!1}return $s(r).then(()=>(this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted(),!0)).catch(e=>(s.vF.error(e),this.setState({busy:!1,loginView:ZB.Unsupported}),!1))}renderPasswordForm(e){let t;return this.state.errorText&&(t=o.createElement("span",{className:"mx_Login_error"},this.state.errorText)),o.createElement("form",{onSubmit:this.onPasswordLogin},e?o.createElement("p",null,e):null,t,o.createElement(wo.A,{type:"password",label:(0,c._t)("common|password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),o.createElement(ae.A,{onClick:this.onPasswordLogin,kind:"primary",disabled:this.state.busy},(0,c._t)("action|sign_in")),o.createElement(ae.A,{onClick:this.onForgotPassword,kind:"link"},(0,c._t)("auth|forgot_password_prompt")))}renderSsoForm(e){const t=this.state.loginView===ZB.CAS?"cas":"sso",n=this.state.flows.find(e=>e.type==="m.login."+t);return o.createElement("div",null,e?o.createElement("p",null,e):null,o.createElement(RB,{matrixClient:f.J.safeGet(),flow:n,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type),action:i.SSOAction.LOGIN}))}renderSignInSection(){return this.state.loginView===ZB.Loading?o.createElement(le.A,null):this.state.loginView===ZB.Password?this.renderPasswordForm((0,c._t)("auth|soft_logout_intro_password")):this.state.loginView===ZB.SSO||this.state.loginView===ZB.CAS?this.renderSsoForm((0,c._t)("auth|soft_logout_intro_sso")):this.state.loginView===ZB.PasswordWithSocialSignOn?o.createElement(o.Fragment,null,o.createElement("p",null,(0,c._t)("auth|soft_logout_intro_sso")),this.renderSsoForm(null),o.createElement("h2",{className:"mx_AuthBody_centered"},(0,c._t)("auth|sso_or_username_password",{ssoButtons:"",usernamePassword:""}).trim()),this.renderPasswordForm(null)):o.createElement("p",null,(0,c._t)("auth|soft_logout_intro_unsupported_auth"))}render(){return o.createElement(oB,null,o.createElement(hB,null),o.createElement(pB,null,o.createElement("h1",null,(0,c._t)("auth|soft_logout_heading")),o.createElement("h2",null,(0,c._t)("action|sign_in")),o.createElement("div",null,this.renderSignInSection()),o.createElement("h2",null,(0,c._t)("auth|soft_logout_subheading")),o.createElement("p",null,(0,c._t)("auth|soft_logout_warning")),o.createElement("div",null,o.createElement(ae.A,{onClick:this.onClearAll,kind:"danger"},(0,c._t)("auth|soft_logout|clear_data_button")))))}}(0,S.A)(tV,"contextType",as.A);var nV=n("./src/Views.ts");function iV(e,t,n){(0,o.useEffect)(()=>{let i=null;const r=()=>{i=null,t(...n)};if(!1!==e)return i=window.setTimeout(r,100),()=>{i&&clearTimeout(i)}},[e,t,n])}const rV=e=>{const t=(0,o.useRef)(null);return[(0,o.useCallback)(e=>{t.current=e},[]),(0,o.useCallback)((n,i)=>{t.current===n&&e(i)},[e])]},oV="ALL_ROOMS",sV="mx_last_room_directory_server",aV="mx_last_room_directory_instance";let lV;const cV="nsfw",dV=e=>{var t,n;return!(null!==(t=e.name)&&void 0!==t&&t.toLocaleLowerCase().includes(cV)||null!==(n=e.topic)&&void 0!==n&&n.toLocaleLowerCase().includes(cV))},uV=()=>{const[e,t]=(0,o.useState)([]),[n,i]=(0,o.useState)(void 0),[r,s]=(0,o.useState)(null),[a,l]=(0,o.useState)(!1),[c,u]=(0,o.useState)(!1),[m,h]=(0,o.useState)(),[p,g]=rV(t),v=(0,Qt.ti)("SpotlightSearch.showNsfwPublicRooms");const _=(0,o.useCallback)(async({limit:e=20,query:t,roomTypes:i})=>{const r={limit:e};(null==n?void 0:n.roomServer)!=f.J.safeGet().getDomain()&&(r.server=null==n?void 0:n.roomServer),(null==n?void 0:n.instanceId)===oV?r.include_all_networks=!0:null!=n&&n.instanceId&&(r.third_party_instance_id=n.instanceId),(t||i)&&(r.filter={generic_search_term:t,room_types:i&&await f.J.safeGet().doesServerSupportUnstableFeature("org.matrix.msc3827.stable")?Array.from(i):void 0}),p(r),u(!0),h(void 0);try{const{chunk:e}=await f.J.safeGet().publicRooms(r);return g(r,v?e:e.filter(dV)),!0}catch(e){return h(!(e instanceof Error)||e),console.error("Could not fetch public rooms for params",r,e),g(r,[]),!1}finally{u(!1)}},[n,p,g,v]);return(0,o.useEffect)(()=>{!async function(){if(f.J.get())if(lV)s(lV);else{const e=await f.J.safeGet().getThirdpartyProtocols();lV=e,s(e)}else l(!0)}()},[]),(0,o.useEffect)(()=>{var e,t,n;if(null===r)return;const o=f.J.safeGet().getDomain(),s=localStorage.getItem(sV),a=null!==(e=localStorage.getItem(aV))&&void 0!==e?e:void 0;let c,u=o;s&&(null!==(t=d.Ay.getObject("room_directory"))&&void 0!==t&&null!==(t=t.get("servers"))&&void 0!==t&&t.includes(s)||null!==(n=O.A.getValue("room_directory_servers"))&&void 0!==n&&n.includes(s))&&(u=s),u!==o||a!==oV&&!Object.values(r).some(e=>{e.instances.some(e=>e.instance_id===a)})||(c=a),l(!0),i({roomServer:u,instanceId:c})},[r]),(0,o.useEffect)(()=>{n&&(localStorage.setItem(sV,n.roomServer),n.instanceId?localStorage.setItem(aV,n.instanceId):localStorage.removeItem(aV))},[n]),{ready:a,loading:c,publicRooms:e,protocols:r,config:n,search:_,setConfig:function(e){if(!a)throw new Error("public room configuration not initialised yet");i(e)},error:m}};var mV=n("./src/utils/SortMembers.ts"),hV=n("./src/components/views/avatars/SearchResultAvatar.tsx"),pV=n("./src/accessibility/context_menu/MenuItemRadio.tsx");function gV({label:e,description:t,onClick:n,isSelected:i,adornment:r}){return o.createElement(pV.s,{active:i,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:n},o.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},o.createElement("span",null,e),o.createElement("span",null,t)),r)}function vV({label:e,description:t,adornment:n,children:i}){return o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--header"},o.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},o.createElement("span",null,e),o.createElement("span",null,t)),n),i)}function fV(e){return"options"in e}function _V(e,t){return t?t(e):e}function yV({value:e,onChange:t,options:n,selectedLabel:i,onOpen:r,onClose:s,toKey:a,className:l,AdditionalOptions:c}){const[d,u,m,h]=(0,Nn.EF)(),p=_V(e,a),g=n.flatMap(e=>fV(e)?[e,...e.options]:[e]).find(e=>_V(e.key,a)===p);let v;v=n&&fV(n[0])?o.createElement(o.Fragment,null,n.map(e=>o.createElement(vV,{key:_V(e.key,a),label:e.label,description:e.description,adornment:e.adornment},e.options.map(e=>o.createElement(gV,{key:_V(e.key,a),label:e.label,description:e.description,onClick:n=>{t(e.key),h(),null==s||s(n)},adornment:e.adornment,isSelected:_V(e.key,a)===p}))))):o.createElement(o.Fragment,null,n.map(e=>o.createElement(gV,{key:_V(e.key,a),label:e.label,description:e.description,onClick:n=>{t(e.key),h(),null==s||s(n)},adornment:e.adornment,isSelected:_V(e.key,a)===p})));const f=d&&u.current?o.createElement(Nn.Ay,(0,tn.A)({onFinished:h,chevronFace:Nn.t4.Top,wrapperClassName:me()("mx_GenericDropdownMenu_wrapper",l)},(0,Nn.qv)(u.current.getBoundingClientRect())),v,c&&o.createElement(c,{menuDisplayed:d,openMenu:m,closeMenu:h})):null;return o.createElement(o.Fragment,null,o.createElement(Nn.VJ,{className:"mx_GenericDropdownMenu_button",ref:u,isExpanded:d,onClick:e=>{m(),null==r||r(e)}},i(g)),f)}var bV=n("./src/components/views/dialogs/TextInputDialog.tsx");function EV(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}const wV=(0,Mx.A)({deriveData:async({value:e})=>{try{return await f.J.safeGet().publicRooms({limit:1,server:null!=e?e:void 0}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>(0,c._t)("spotlight|public_rooms|network_dropdown_required_invalid")},{key:"available",final:!0,test:async(e,{error:t})=>!t,valid:()=>(0,c._t)("spotlight|public_rooms|network_dropdown_available_valid"),invalid:({error:e})=>e instanceof i.MatrixError&&"M_FORBIDDEN"===e.errcode?(0,c._t)("spotlight|public_rooms|network_dropdown_available_invalid_forbidden"):(0,c._t)("spotlight|public_rooms|network_dropdown_available_invalid")}],memoize:!0});function SV(e,...t){for(const n of t)e.delete(n)}function xV(){var e,t;const[n,i]=function(e,t,n=null,i=!1){const[r,s]=(0,o.useState)(O.A.getValue(e,n,i)),a=(0,o.useCallback)(async i=>{s(i),O.A.setValue(e,n,t,i)},[t,n,e]);return(0,o.useEffect)(()=>{const t=O.A.watchSetting(e,n,()=>{s(O.A.getValue(e,n,i))});return()=>{O.A.unwatchSetting(t)}},[e,n,i]),[r,a]}("room_directory_servers",F.p.ACCOUNT),r=f.J.safeGet().getDomain(),s=new Set(null!==(e=null===(t=d.Ay.getObject("room_directory"))||void 0===t?void 0:t.get("servers"))&&void 0!==e?e:[]);SV(s,r);const a=new Set(n);return SV(a,r),SV(a,...s),{allServers:[r,...Array.from(s).sort(),...Array.from(a).sort()],homeServer:r,userDefinedServers:Array.from(a).sort(),setUserDefinedServers:i}}const AV=({protocols:e,config:t,setConfig:n})=>{const{allServers:i,homeServer:r,userDefinedServers:s,setUserDefinedServers:a}=xV(),l=i.map(t=>function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?EV(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):EV(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({key:{roomServer:t,instanceId:void 0},label:t,description:t===r?(0,c._t)("spotlight|public_rooms|network_dropdown_your_server_description"):null,options:[{key:{roomServer:t,instanceId:void 0},label:(0,c._t)("common|matrix")},...t===r&&e?Object.values(e).flatMap(e=>e.instances).map(e=>({key:{roomServer:t,instanceId:e.instance_id},label:e.desc})):[]]},s.includes(t)?{adornment:o.createElement(ae.A,{className:"mx_NetworkDropdown_removeServer",title:(0,c._t)("spotlight|public_rooms|network_dropdown_remove_server_adornment",{roomServer:t}),onClick:()=>a((0,Li.without)(s,t))})}:{})),d=(0,o.useCallback)(({closeMenu:e})=>o.createElement(o.Fragment,null,o.createElement("span",{className:"mx_GenericDropdownMenu_divider"}),o.createElement(pV.s,{active:!1,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:async()=>{e();const{finished:t}=R.Ay.createDialog(bV.A,{title:(0,c._t)("spotlight|public_rooms|network_dropdown_add_dialog_title"),description:(0,c._t)("spotlight|public_rooms|network_dropdown_add_dialog_description"),button:(0,c._t)("action|add"),hasCancel:!1,placeholder:(0,c._t)("spotlight|public_rooms|network_dropdown_add_dialog_placeholder"),validator:wV,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[r,o]=await t;r&&(i.includes(o)||(a([...s,o]),n({roomServer:o})))}},o.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},o.createElement("span",{className:"mx_NetworkDropdown_addServer"},(0,c._t)("spotlight|public_rooms|network_dropdown_add_server_option"))))),[i,n,a,s]);return o.createElement(yV,{className:"mx_NetworkDropdown_wrapper",value:t,toKey:e=>e?`${e.roomServer}-${e.instanceId}`:"null",options:l,onChange:e=>n(e),selectedLabel:e=>null!=e&&e.key?(0,c._t)("spotlight|public_rooms|network_dropdown_selected_label_instance",{server:e.key.roomServer,instance:e.key.instanceId?e.label:"Matrix"}):(0,c._t)("spotlight|public_rooms|network_dropdown_selected_label"),AdditionalOptions:d})},CV=["children","endAdornment","className"],kV=e=>{let{children:t,endAdornment:n,className:i}=e,r=(0,v.A)(e,CV);const[s,a,l]=(0,mi.A9)();return o.createElement(ae.A,(0,tn.A)({},r,{className:me()(i,"mx_SpotlightDialog_option"),onFocus:s,ref:l,tabIndex:-1,"aria-selected":a,role:"option",element:"li"}),t,o.createElement("div",{className:"mx_SpotlightDialog_option--endAdornment"},o.createElement("kbd",{className:"mx_SpotlightDialog_enterPrompt","aria-hidden":!0},""),n))};function RV({room:e,labelId:t,descriptionId:n,detailsId:i}){var r,s,a;let l=e.name||(0,ua.iW)(null!==(r=e.canonical_alias)&&void 0!==r?r:"",null!==(s=e.aliases)&&void 0!==s?s:[])||(0,c._t)("common|unnamed_room");l.length>80&&(l=`${l.substring(0,80)}...`);let d=e.topic||"";return d.length>800&&(d=`${d.substring(0,800)}...`),o.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomDetails"},o.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomHeader"},o.createElement("span",{id:t,className:"mx_SpotlightDialog_result_publicRoomName"},l),o.createElement("span",{id:n,className:"mx_SpotlightDialog_result_publicRoomAlias"},null!==(a=e.canonical_alias)&&void 0!==a?a:e.room_id)),o.createElement("div",{id:i,className:"mx_SpotlightDialog_result_publicRoomDescription"},o.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomMemberCount"},(0,c._t)("spotlight_dialog|count_of_members",{count:e.num_joined_members})),d&&o.createElement(o.Fragment,null,"",o.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomTopic",dangerouslySetInnerHTML:{__html:(0,ji.kz)(d)}}))))}var IV=n("./src/components/views/context_menus/RoomGeneralContextMenu.tsx"),TV=n("./src/components/views/context_menus/RoomNotificationContextMenu.tsx"),PV=n("./src/components/views/rooms/RoomTile.tsx");function NV({room:e}){const[t]=(0,wf.I)(e),[n,i]=(0,o.useState)(null),[r,s]=(0,o.useState)(null);let a,l;null!==n&&(a=e.isSpaceRoom()?o.createElement(el,(0,tn.A)({},(0,PV._)(n),{space:e,onFinished:()=>i(null)})):o.createElement(IV.e,(0,tn.A)({},(0,PV._)(n),{room:e,onFinished:()=>i(null)}))),null!==r&&(l=o.createElement(TV.f,(0,tn.A)({},(0,PV._)(r),{room:e,onFinished:()=>s(null)})));const d=me()("mx_SpotlightDialog_option--notifications",{mx_RoomNotificationContextMenu_iconBell:t===Ef.dC.AllMessages,mx_RoomNotificationContextMenu_iconBellDot:t===Ef.dC.AllMessagesLoud,mx_RoomNotificationContextMenu_iconBellMentions:t===Ef.dC.MentionsOnly,mx_RoomNotificationContextMenu_iconBellCrossed:t===Ef.dC.Mute});return o.createElement(o.Fragment,null,(0,Ya.g)(It.C.RoomOptionsMenu)&&o.createElement(Bi.o,{className:"mx_SpotlightDialog_option--menu",onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;i(t.getBoundingClientRect())},title:e.isSpaceRoom()?(0,c._t)("space|context_menu|options"):(0,c._t)("room|context_menu|title"),isExpanded:null!==n}),!e.isSpaceRoom()&&o.createElement(Bi.o,{className:d,onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;s(t.getBoundingClientRect())},title:(0,c._t)("room_list|notification_options"),isExpanded:null!==r}),a,l)}const DV=["inputRef","className"],MV=e=>{let{inputRef:t,className:n}=e,i=(0,v.A)(e,DV);const[r,s,a]=(0,mi.A9)(t);return o.createElement(ae.A,(0,tn.A)({},i,{className:me()(n,"mx_SpotlightDialog_option"),onFocus:r,ref:a,tabIndex:-1,"aria-selected":s,role:"option"}))};var OV=n("./src/components/views/dialogs/spotlight/Filter.ts");const FV=50,LV="24px";function UV(e){var t;return!0===(null==e||null===(t=e.id)||void 0===t?void 0:t.startsWith("mx_SpotlightDialog_button_recentlyViewed_"))}function BV(e){const t=new Set;return e===OV.d.PublicRooms&&t.add(null),e===OV.d.PublicSpaces&&t.add(i.RoomType.Space),t}var VV=function(e){return e[e.People=0]="People",e[e.Rooms=1]="Rooms",e[e.Spaces=2]="Spaces",e[e.Suggestions=3]="Suggestions",e[e.PublicRoomsAndSpaces=4]="PublicRoomsAndSpaces",e}(VV||{});function jV(e){switch(e){case OV.d.People:return(0,c._t)("common|people");case OV.d.PublicRooms:return(0,c._t)("spotlight_dialog|public_rooms_label");case OV.d.PublicSpaces:return(0,c._t)("spotlight_dialog|public_spaces_label")}}const zV=e=>!(null==e||!e.room),HV=e=>!(null==e||!e.publicRoom),WV=e=>!(null==e||!e.member),GV=e=>{var t,n,i,r,o;return{publicRoom:e,section:VV.PublicRoomsAndSpaces,filter:[OV.d.PublicRooms,OV.d.PublicSpaces],query:(0,ie.Bo)([e.room_id.toLowerCase(),null===(t=e.canonical_alias)||void 0===t?void 0:t.toLowerCase(),null===(n=e.name)||void 0===n?void 0:n.toLowerCase(),ca()(null!==(i=null===(r=e.topic)||void 0===r?void 0:r.toLowerCase())&&void 0!==i?i:"",{allowedTags:[]}),...(null===(o=e.aliases)||void 0===o?void 0:o.map(e=>e.toLowerCase()))||[]])}},KV=e=>{const t=f.J.safeGet().getUserId();if(k.A.shared().getUserIdForRoomId(e.roomId)){const n=e.getMembers().filter(e=>e.userId!==t),i=[...n.map(e=>e.name.toLowerCase()),...n.map(e=>e.userId.toLowerCase())].filter(Boolean);return{room:e,section:VV.People,filter:[OV.d.People],query:i}}return e.isSpaceRoom()?{room:e,section:VV.Spaces,filter:[]}:{room:e,section:VV.Rooms,filter:[]}},qV=(e,t)=>({alreadyFiltered:t,member:e,section:VV.Suggestions,filter:[OV.d.People],query:[e.userId.toLowerCase(),e.name.toLowerCase()].filter(Boolean)}),$V=new no.V7,JV=(e,t)=>t.hasMentions?(0,c._t)("a11y|n_unread_messages_mentions",{count:t.count}):t.hasUnreadCount?(0,c._t)("a11y|n_unread_messages",{count:t.count}):t.isUnread?(0,c._t)("a11y|unread_messages"):void 0,YV=e=>O.A.getValue("feature_ask_to_join")&&i.JoinRule.Knock===e,XV=({initialText:e="",initialFilter:t=null,onFinished:n})=>{var r;const s=(0,o.useRef)(null),a=(0,o.useRef)(null),l=f.J.safeGet(),d=(0,o.useContext)(mi.ui),[u,m]=(0,o.useState)(e),[h,p]=(()=>{const[e,t]=(0,o.useState)(()=>{const e=f.J.safeGet(),t=O.A.getValue("SpotlightSearch.recentSearches",null);return(0,ie.Bo)(t.map(t=>e.getRoom(t)))});return[e,()=>{O.A.setValue("SpotlightSearch.recentSearches",null,F.p.ACCOUNT,[]),t([])}]})(),[g,v]=(0,o.useState)(t),_=(0,o.useCallback)(e=>{var t,n,i;v(e),null===(t=s.current)||void 0===t||t.focus(),null===(n=a.current)||void 0===n||null===(i=n.scrollTo)||void 0===i||i.call(n,{top:0})},[]),y=(0,o.useMemo)(()=>{const e=(0,mV.nf)(l),t=(0,mV._5)(l);return(0,mV.j2)(e,t)},[l]),b=(0,Qt.ny)("feature_dynamic_room_predecessors"),E=(0,on.Ne)(l.getUserId()),[w,S]=(0,o.useState)(!1),A=(0,o.useMemo)(()=>u.trim(),[u]),[C,R]=(0,o.useState)(!0);(0,o.useEffect)(()=>{l.isVersionSupported("v1.4").then(e=>e||l.doesServerSupportUnstableFeature("org.matrix.msc3827.stable")).then(e=>{R(e)})},[l]);const{loading:I,publicRooms:T,protocols:P,config:N,setConfig:D,search:M,error:L}=uV(),{loading:U,users:B,search:V}=(()=>{const[e,t]=(0,o.useState)([]),[n,i]=(0,o.useState)(!1),[r,s]=rV(t);return{ready:!0,loading:n,users:e,search:(0,o.useCallback)(async({limit:e=20,query:n})=>{const o={limit:e,term:n};if(r(o),null==n||!n.length)return t([]),!0;try{i(!0);const{results:e}=await f.J.safeGet().searchUserDirectory(o);return s(o,e.map(e=>new OP.qv(e))),!0}catch(t){return console.error("Could not fetch user in user directory for params",{limit:e,term:n},t),s(o,[]),!1}finally{i(!1)}},[r,s])}})(),{loading:j,profile:H,search:G}=(()=>{const[e,t]=(0,o.useState)(null),[n,i]=(0,o.useState)(!1),[r,s]=rV(t);return{ready:!0,loading:n,profile:e,search:(0,o.useCallback)(async({query:e})=>{if(r(e),null==e||!e.length||!e.startsWith("@")||!e.includes(":"))return t(null),!0;i(!0);try{const t=await f.J.safeGet().getProfileInfo(e);return s(e,{user_id:e,avatar_url:t.avatar_url,display_name:t.displayname}),!0}catch(t){return console.error("Could not fetch profile info for params",{term:e},t),s(e,null),!1}finally{i(!1)}},[r,s])}})(),K=(0,o.useMemo)(()=>[{query:A,roomTypes:BV(g),limit:FV}],[A,g]);iV(g===OV.d.PublicRooms||g===OV.d.PublicSpaces,M,K),iV(g===OV.d.People,V,K),iV(g===OV.d.People,G,K);const q=(0,o.useMemo)(()=>{const e=((e,t)=>e.getVisibleRooms(t).filter(e=>!(0,Pr.F)(e)&&(e.getMyMembership()===Xt.O.Join||e.getMyMembership()==Xt.O.Invite)))(l,b),t=e.map(KV),n=[],i=t.reduce((e,t)=>{const n=k.A.shared().getUserIdForRoomId(t.room.roomId);return n?(t.room.getJoinedMemberCount()>2||e.set(n,t),e):e},new Map);function r(e,t){for(const r of e){if(i.has(r.userId)){const e=i.get(r.userId);t&&WV(e)&&!e.alreadyFiltered&&(e.alreadyFiltered=!0);continue}const e=qV(r,t);i.set(r.userId,e),n.push(e)}}return r(((e,t,n=!0)=>Object.values(e.filter(e=>!n||!k.A.shared().getUserIdForRoomId(e.roomId)).reduce((e,t)=>{for(const n of t.getJoinedMembers())e[n.userId]=n;return e},{})).filter(e=>e.userId!==t.getUserId()))(e,l),!1),r(B,!0),H&&r([new OP.qv(H)],!0),[...Ci.Ay.instance.enabledMetaSpaces.map(e=>({section:VV.Spaces,filter:[],avatar:o.createElement("div",{className:me()("mx_SpotlightDialog_metaspaceResult",`mx_SpotlightDialog_metaspaceResult_${e}`)}),name:(0,$a.Ff)(e,Ci.Ay.instance.allRoomsInHome),onClick(){Ci.Ay.instance.setActiveSpace(e)}})),...t,...n,...T.map(GV)].filter(e=>null===g||e.filter.includes(g))},[l,B,H,T,g,b]),$=(0,o.useMemo)(()=>{const e={[VV.People]:[],[VV.Rooms]:[],[VV.Spaces]:[],[VV.Suggestions]:[],[VV.PublicRoomsAndSpaces]:[]};if(A){const t=A.toLowerCase(),n=(0,_a.S8)(A);q.forEach(i=>{if(zV(i)){const e=k.A.shared().getUserIdForRoomId(i.room.roomId);var r,o,s;if(!B.some(t=>t.userId===e))if(!(null!==(r=i.room.normalizedName)&&void 0!==r&&r.includes(n)||null!==(o=i.room.getCanonicalAlias())&&void 0!==o&&o.toLowerCase().includes(t)||null!==(s=i.query)&&void 0!==s&&s.some(e=>e.includes(t))))return}else if(WV(i)){var a;if(!(i.alreadyFiltered||null!==(a=i.query)&&void 0!==a&&a.some(e=>e.includes(t))))return}else if(HV(i)){var l;if(null===(l=i.query)||void 0===l||!l.some(e=>e.includes(t)))return}else{var c;if(!(i.name.toLowerCase().includes(t)||null!==(c=i.query)&&void 0!==c&&c.some(e=>e.includes(t))))return}e[i.section].push(i)})}else g===OV.d.PublicRooms||g===OV.d.PublicSpaces?q.forEach(t=>{HV(t)&&e[t.section].push(t)}):g===OV.d.People&&q.forEach(t=>{WV(t)&&e[t.section].push(t)});const t=l.getSafeUserId();for(const n of Object.values(e))n.sort((e,n)=>zV(e)||zV(n)?zV(n)&&zV(e)?$V.getLastTs(n.room,t)-$V.getLastTs(e.room,t):-1:WV(e)||WV(n)?WV(n)&&WV(e)?y(e.member,n.member):-1:0);return e},[A,g,l,q,B,y]);((e,t,n)=>{(0,o.useEffect)(()=>{if(!t)return;const i=window.setTimeout(()=>{z.Vo.instance.trackEvent({eventName:"WebSearch",viaSpotlight:n,numResults:e,queryLength:t})},1e3);return()=>{clearTimeout(i)}},[e,t,n])})((0,Li.sum)(Object.values($).map(e=>e.length)),u.length,!0);const J=Ci.Ay.instance.activeSpaceRoom,[Y,Q]=((e,t)=>{var n;const[r,s]=(0,o.useState)([]),[a,l]=(0,o.useState)(),c=(0,o.useCallback)(()=>{l(e?new dP(e,50):void 0)},[e]);return(0,o.useEffect)(c,[c]),(0,o.useEffect)(()=>{if(!e||!a)return;let t=!1;return(async()=>{for(;null!=a&&a.canLoadMore&&!t&&e===a.root;)await a.load(),a.canLoadMore&&a.load(),s(a.rooms)})(),()=>{t=!0}},[e,a]),[(0,o.useMemo)(()=>{const e=t.trim(),n=e.toLowerCase(),o=(0,_a.S8)(e),s=f.J.safeGet();return null==r?void 0:r.filter(e=>{var t;return e.room_type!==i.RoomType.Space&&(null===(t=s.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())!==Xt.O.Join&&((0,_a.S8)(e.name||"").includes(o)||(e.canonical_alias||"").includes(n))})},[r,t]),null!==(n=null==a?void 0:a.loading)&&void 0!==n&&n]})(null!=J?J:void 0,u);(0,o.useEffect)(()=>{setTimeout(()=>{const e=d.state.nodes[0];var t;e&&(d.dispatch({type:mi.ZU.SetFocus,payload:{node:e}}),null==e||null===(t=e.scrollIntoView)||void 0===t||t.call(e,{block:"nearest"}))})},[$,g]);const Z=(e,t=!1,i=!1)=>{if(t){const t=new Set(O.A.getValue("SpotlightSearch.recentSearches",null).reverse());t.delete(e.roomId),t.add(e.roomId),O.A.setValue("SpotlightSearch.recentSearches",null,F.p.ACCOUNT,Array.from(t).reverse().slice(0,10))}x.A.dispatch({action:W.r.ViewRoom,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:i,room_id:e.roomId,room_alias:e.roomAlias,auto_join:e.autoJoin&&!YV(e.joinRule),should_peek:e.shouldPeek,via_servers:e.viaServers}),YV(e.joinRule)&&x.A.dispatch({action:W.r.PromptAskToJoin}),n()};let ee,te;if((A||g!==OV.d.PublicRooms&&g!==OV.d.PublicSpaces)&&(ee=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_otherSearches"},o.createElement("h4",{id:"mx_SpotlightDialog_section_otherSearches"},A?(0,c._t)("spotlight_dialog|heading_with_query",{query:u}):(0,c._t)("spotlight_dialog|heading_without_query")),o.createElement("div",null,g!==OV.d.PublicSpaces&&C&&o.createElement(kV,{id:"mx_SpotlightDialog_button_explorePublicSpaces",className:"mx_SpotlightDialog_explorePublicSpaces",onClick:()=>_(OV.d.PublicSpaces)},jV(OV.d.PublicSpaces)),g!==OV.d.PublicRooms&&o.createElement(kV,{id:"mx_SpotlightDialog_button_explorePublicRooms",className:"mx_SpotlightDialog_explorePublicRooms",onClick:()=>_(OV.d.PublicRooms)},jV(OV.d.PublicRooms)),g!==OV.d.People&&o.createElement(kV,{id:"mx_SpotlightDialog_button_startChat",className:"mx_SpotlightDialog_startChat",onClick:()=>_(OV.d.People)},jV(OV.d.People)),null===g&&o.createElement(kV,{id:"mx_SpotlightDialog_button_searchMessages",className:"mx_SpotlightDialog_searchMessages",onClick:()=>{x.A.dispatch({action:W.r.FocusMessageSearch,initialText:A}),n()}},(0,c._t)("spotlight_dialog|messages_label"))))),A||null!==g){const e=e=>{var t;if(zV(e)){const t=xp.n.instance.getRoomState(e.room),n=JV(e.room,t),i={"aria-label":n?`${e.room.name} ${n}`:e.room.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.room.roomId}_details`};return o.createElement(kV,(0,tn.A)({id:`mx_SpotlightDialog_button_result_${e.room.roomId}`,key:`${VV[e.section]}-${e.room.roomId}`,onClick:t=>{Z({roomId:e.room.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:o.createElement(NV,{room:e.room})},i),o.createElement(to.A,{room:e.room,size:LV,tooltipProps:{tabIndex:-1}}),e.room.name,o.createElement(On.A,{notification:t}),o.createElement(co,{id:`mx_SpotlightDialog_button_result_${e.room.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e.room}))}if(WV(e))return o.createElement(kV,{id:`mx_SpotlightDialog_button_result_${e.member.userId}`,key:`${VV[e.section]}-${e.member.userId}`,onClick:()=>{(0,OP.UZ)(l,[e.member]),n()},"aria-label":e.member instanceof i.RoomMember?e.member.rawDisplayName:e.member.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.member.userId}_details`},o.createElement(hV.N,{user:e.member,size:LV}),e.member instanceof i.RoomMember?e.member.rawDisplayName:e.member.name,o.createElement("div",{id:`mx_SpotlightDialog_button_result_${e.member.userId}_details`,className:"mx_SpotlightDialog_result_details"},e.member.userId));if(HV(e)){const t=l.getRoom(e.publicRoom.room_id),n=e.publicRoom.join_rule,i=(null==t?void 0:t.getMyMembership())===Xt.O.Join||e.publicRoom.world_readable&&!YV(n)||l.isGuest(),r=t=>{var i;t.stopPropagation();const{publicRoom:r}=e;Z({roomAlias:r.canonical_alias||(null===(i=r.aliases)||void 0===i?void 0:i[0]),roomId:r.room_id,autoJoin:!e.publicRoom.world_readable&&!l.isGuest(),shouldPeek:e.publicRoom.world_readable||l.isGuest(),viaServers:N?[N.roomServer]:void 0,joinRule:n},!0,"click"!==t.type)};let s;return s=i?(0,c._t)("action|view"):YV(n)?(0,c._t)("action|ask_to_join"):(0,c._t)("action|join"),o.createElement(kV,{id:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}`,className:"mx_SpotlightDialog_result_multiline",key:`${VV[e.section]}-${e.publicRoom.room_id}`,onClick:r,endAdornment:o.createElement(ae.A,{kind:i?"primary_outline":"primary",onClick:r,tabIndex:-1},s),"aria-labelledby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,"aria-describedby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,"aria-details":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`},o.createElement(Tn.A,{className:"mx_SearchResultAvatar",oobData:{roomId:e.publicRoom.room_id,name:e.publicRoom.name,avatarUrl:e.publicRoom.avatar_url,roomType:e.publicRoom.room_type},size:LV}),o.createElement(RV,{room:e.publicRoom,labelId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,descriptionId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,detailsId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`}))}return o.createElement(kV,{id:`mx_SpotlightDialog_button_result_${e.name}`,key:`${VV[e.section]}-${e.name}`,onClick:null!==(t=e.onClick)&&void 0!==t?t:null},e.avatar,e.name,e.description)};let t,r,s,a,d,u,m,h,p;if($[VV.People].length&&(t=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_people"},o.createElement("h4",{id:"mx_SpotlightDialog_section_people"},(0,c._t)("invite|recents_section")),o.createElement("div",null,$[VV.People].slice(0,FV).map(e)))),$[VV.Suggestions].length&&g===OV.d.People&&(r=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_suggestions"},o.createElement("h4",{id:"mx_SpotlightDialog_section_suggestions"},(0,c._t)("common|suggestions")),o.createElement("div",null,$[VV.Suggestions].slice(0,FV).map(e)))),$[VV.Rooms].length&&(s=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_rooms"},o.createElement("h4",{id:"mx_SpotlightDialog_section_rooms"},(0,c._t)("common|rooms")),o.createElement("div",null,$[VV.Rooms].slice(0,FV).map(e)))),$[VV.Spaces].length&&(a=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaces"},o.createElement("h4",{id:"mx_SpotlightDialog_section_spaces"},(0,c._t)("spotlight_dialog|spaces_title")),o.createElement("div",null,$[VV.Spaces].slice(0,FV).map(e)))),g===OV.d.PublicRooms||g===OV.d.PublicSpaces){let t;t=L?o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},g===OV.d.PublicRooms?(0,c._t)("spotlight_dialog|failed_querying_public_rooms"):(0,c._t)("spotlight_dialog|failed_querying_public_spaces")):$[VV.PublicRoomsAndSpaces].slice(0,FV).map(e),d=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_publicRooms"},o.createElement("div",{className:"mx_SpotlightDialog_sectionHeader"},o.createElement("h4",{id:"mx_SpotlightDialog_section_publicRooms"},(0,c._t)("common|suggestions")),o.createElement("div",{className:"mx_SpotlightDialog_options"},o.createElement(AV,{protocols:P,config:null!=N?N:null,setConfig:D}))),o.createElement("div",null,t))}Y.length&&J&&null===g&&(u=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaceRooms"},o.createElement("h4",{id:"mx_SpotlightDialog_section_spaceRooms"},(0,c._t)("spotlight_dialog|other_rooms_in_space",{spaceName:J.name})),o.createElement("div",null,Y.slice(0,FV).map(e=>o.createElement(kV,{id:`mx_SpotlightDialog_button_result_${e.room_id}`,key:e.room_id,onClick:t=>{Z({roomId:e.room_id},!0,"click"!==(null==t?void 0:t.type))}},o.createElement(Xp.A,{name:e.name,idName:e.room_id,url:e.avatar_url?(0,Vi.mediaFromMxc)(e.avatar_url).getSquareThumbnailHttp(parseInt(LV,10)):null,size:LV}),e.name||e.canonical_alias,e.name&&e.canonical_alias&&o.createElement("div",{className:"mx_SpotlightDialog_result_details"},e.canonical_alias))),Q&&o.createElement(le.A,null)))),!A.startsWith("#")||!A.includes(":")||(0,Na.M)(A)&&l.getRoom((0,Na.M)(A))||(m=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},o.createElement("div",null,o.createElement(kV,{id:"mx_SpotlightDialog_button_joinRoomAlias",className:"mx_SpotlightDialog_joinRoomAlias",onClick:e=>{x.A.dispatch({action:W.r.ViewRoom,room_alias:A,auto_join:!0,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:"click"!==(null==e?void 0:e.type)}),n()}},(0,c._t)("spotlight_dialog|join_button_text",{roomAddress:A}))))),g===OV.d.People?h=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},o.createElement("h4",null,(0,c._t)("spotlight_dialog|result_may_be_hidden_privacy_warning")),o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,c._t)("spotlight_dialog|cant_find_person_helpful_hint")),o.createElement(MV,{id:"mx_SpotlightDialog_button_inviteLink",className:"mx_SpotlightDialog_inviteLink",onClick:()=>{S(!0),(0,$i.nC)(E)},onTooltipOpenChange:e=>{e||S(!1)},title:w?(0,c._t)("common|copied"):(0,c._t)("action|copy")},o.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,c._t)("spotlight_dialog|copy_link_text")))):!A||g!==OV.d.PublicRooms&&g!==OV.d.PublicSpaces||(h=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},o.createElement("h4",null,(0,c._t)("spotlight_dialog|result_may_be_hidden_warning")),o.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},(0,c._t)("spotlight_dialog|cant_find_room_helpful_hint")),o.createElement(kV,{id:"mx_SpotlightDialog_button_createNewRoom",className:"mx_SpotlightDialog_createRoom",onClick:()=>x.A.dispatch({action:W.r.CreateRoom,public:!0,defaultName:(0,Li.capitalize)(A)})},o.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},(0,c._t)("spotlight_dialog|create_new_room_button"))))),g===OV.d.People&&(p=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_groupChat"},o.createElement("h4",{id:"mx_SpotlightDialog_section_groupChat"},(0,c._t)("spotlight_dialog|group_chat_section_title")),o.createElement(kV,{id:"mx_SpotlightDialog_button_startGroupChat",className:"mx_SpotlightDialog_startGroupChat",onClick:()=>(0,da.xZ)(A)},(0,c._t)("spotlight_dialog|start_group_chat_button")))),te=o.createElement(o.Fragment,null,t,r,s,a,u,d,m,h,ee,p)}else{let e;h.length&&(e=o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentSearches",role:"group",tabIndex:-1,"aria-labelledby":"mx_SpotlightDialog_section_recentSearches"},o.createElement("h4",null,o.createElement("span",{id:"mx_SpotlightDialog_section_recentSearches"},(0,c._t)("spotlight_dialog|recent_searches_section_title")),o.createElement(ae.A,{kind:"link",onClick:p},(0,c._t)("action|clear"))),o.createElement("div",null,h.map(e=>{const t=xp.n.instance.getRoomState(e),n=JV(0,t),i={"aria-label":n?`${e.name} ${n}`:e.name,"aria-describedby":`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`};return o.createElement(kV,(0,tn.A)({id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}`,key:e.roomId,onClick:t=>{Z({roomId:e.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:o.createElement(NV,{room:e})},i),o.createElement(to.A,{room:e,size:LV,tooltipProps:{tabIndex:-1}}),e.name,o.createElement(On.A,{notification:t}),o.createElement(co,{id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e}))})))),te=o.createElement(o.Fragment,null,o.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentlyViewed",role:"group","aria-labelledby":"mx_SpotlightDialog_section_recentlyViewed"},o.createElement("h4",{id:"mx_SpotlightDialog_section_recentlyViewed"},(0,c._t)("spotlight_dialog|recently_viewed_section_title")),o.createElement("div",null,Tg.Y.instance.rooms.filter(e=>e.roomId!==as.M.instance.roomViewStore.getRoomId()).map(e=>o.createElement(MV,{id:`mx_SpotlightDialog_button_recentlyViewed_${e.roomId}`,title:e.name,key:e.roomId,onClick:t=>{Z({roomId:e.roomId},!1,"click"!==t.type)}},o.createElement(to.A,{room:e,size:"32px",tooltipProps:{tabIndex:-1}}),e.name)))),e,ee)}const ne=null===(r=d.state.activeNode)||void 0===r?void 0:r.id;return o.createElement(o.Fragment,null,o.createElement("div",{id:"mx_SpotlightDialog_keyboardPrompt"},(0,c._t)("spotlight_dialog|keyboard_scroll_hint",{},{arrows:()=>o.createElement(o.Fragment,null,o.createElement("kbd",null,""),o.createElement("kbd",null,""),null!==!g&&!u&&o.createElement("kbd",null,""),null!==!g&&!u&&o.createElement("kbd",null,""))})),o.createElement(X.A,{className:"mx_SpotlightDialog",onFinished:n,hasCancel:!1,onKeyDown:e=>{if((0,uo.zM)().getNavigationAction(e)===Ei.bY.FilterRooms)e.stopPropagation(),e.preventDefault(),n();let t;const i=(0,uo.zM)().getAccessibilityAction(e);switch(i){case Ei.bY.Escape:e.stopPropagation(),e.preventDefault(),n();break;case Ei.bY.ArrowUp:case Ei.bY.ArrowDown:if(e.stopPropagation(),e.preventDefault(),d.state.activeNode&&d.state.nodes.length>0){let e=d.state.nodes;if(!u&&null!==!g){const t=UV(d.state.activeNode)?d.state.activeNode:e.find(UV);e=e.filter(e=>e===t||!UV(e))}const n=e.indexOf(d.state.activeNode);t=(0,mi.Ed)(e,n+(i===Ei.bY.ArrowUp?-1:1))}break;case Ei.bY.ArrowLeft:case Ei.bY.ArrowRight:if(!u&&null!==!g&&d.state.activeNode&&d.state.nodes.length>0&&UV(d.state.activeNode)){e.stopPropagation(),e.preventDefault();const n=d.state.nodes.filter(UV),r=n.indexOf(d.state.activeNode);t=(0,mi.Ed)(n,r+(i===Ei.bY.ArrowLeft?-1:1))}}var r;t&&(d.dispatch({type:mi.ZU.SetFocus,payload:{node:t}}),null===(r=t)||void 0===r||r.scrollIntoView({block:"nearest"}))},screenName:"UnifiedSearch","aria-label":(0,c._t)("spotlight_dialog|search_dialog")},o.createElement("div",{className:"mx_SpotlightDialog_searchBox mx_textinput"},null!==g&&o.createElement("div",{className:me()("mx_SpotlightDialog_filter",{mx_SpotlightDialog_filterPeople:g===OV.d.People,mx_SpotlightDialog_filterPublicRooms:g===OV.d.PublicRooms,mx_SpotlightDialog_filterPublicSpaces:g===OV.d.PublicSpaces})},o.createElement("span",null,jV(g)),o.createElement(ae.A,{tabIndex:-1,title:(0,c._t)("spotlight_dialog|remove_filter",{filter:jV(g)}),className:"mx_SpotlightDialog_filter--close",onClick:()=>_(null)})),o.createElement("input",{ref:s,autoFocus:!0,type:"text",autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:"false",placeholder:(0,c._t)("action|search"),value:u,onChange:e=>{const t=function(e){var t;const n=(0,on.$N)(e);return null!==(t=null==n?void 0:n.primaryEntityId)&&void 0!==t?t:e}(e.currentTarget.value);m(t)},onKeyDown:e=>{var t;switch((0,uo.zM)().getAccessibilityAction(e)){case Ei.bY.Backspace:u||null===g||(e.stopPropagation(),e.preventDefault(),_(null));break;case Ei.bY.Enter:e.stopPropagation(),e.preventDefault(),null===(t=d.state.activeNode)||void 0===t||t.click()}},"aria-owns":"mx_SpotlightDialog_content","aria-activedescendant":ne,"aria-label":(0,c._t)("action|search"),"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"}),(I||U||j)&&o.createElement(le.A,{w:24,h:24})),o.createElement("div",{ref:a,id:"mx_SpotlightDialog_content",role:"listbox","aria-activedescendant":ne,"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"},te)))},QV=e=>o.createElement(mi.Se,null,()=>o.createElement(XV,e));var ZV=n("./src/utils/dm/findDMForUser.ts"),ej=n("./src/utils/crypto/shouldForceDisableEncryption.ts");const tj="react_sdk_session_lock_ping",nj="react_sdk_session_lock_owner",ij="react_sdk_session_lock_claimant",rj=15e3;async function oj(e){const t=(0,ya.A)(),n=s.vF.getChild(`getSessionLock[${t}]`);let i=null;function r(){const e=window.localStorage.getItem(ij);if(e!==t)return n.warn(`Lock was claimed by ${e} while we were waiting for it: aborting startup`),-1;const i=window.localStorage.getItem(tj),r=window.localStorage.getItem(nj);if(null===i)return n.info("No other session has the lock: proceeding with startup"),0;const o=Date.now()-parseInt(i),s=rj-Math.max(o,0);return s<=0?(n.info(`Last ping (from ${r}) was ${o}ms ago: proceeding with startup`),0):(n.info(`Last ping (from ${r}) was ${o}ms ago, waiting ${s}ms`),s)}function o(){window.localStorage.setItem(nj,t),window.localStorage.setItem(tj,Date.now().toString())}function a(){null!==i&&(n.debug("page hide: clearing our claim"),window.clearInterval(i),window.localStorage.removeItem(tj),window.localStorage.removeItem(nj),i=null)}for(window.localStorage.setItem(ij,t);;){const t=r();if(0==t)break;if(t<0)return await e(),!1;let i;const o=new Promise(e=>{i=t=>{t.key!==tj&&t.key!==ij||e(t)}}),s=new Promise(e=>{setTimeout(e,t,void 0)});window.addEventListener("storage",i);const a=await Promise.race([s,o]);if(window.removeEventListener("storage",i),!(a instanceof StorageEvent)){n.info("Existing claim went stale: proceeding with startup");break}}return o(),i=window.setInterval(o,5e3),window.addEventListener("storage",function r(o){if(o.key===ij){const o=window.localStorage.getItem(ij);if(o===t)return;n.info(`Session ${o} is waiting for the lock`),window.removeEventListener("storage",r),async function(){await e(),null!==i&&window.clearInterval(i);window.localStorage.removeItem(tj),window.localStorage.removeItem(nj),i=null}().catch(e=>{n.error("Error releasing session lock",e)})}}),window.addEventListener("pagehide",a),window.addEventListener("unload",a),!0}const sj=["children","className"];function aj(e){let{children:t,className:n}=e,i=(0,v.A)(e,sj);const r=me()(n,"mx_SplashPage");return o.createElement("main",(0,tn.A)({},i,{className:r}),t)}function lj(){const e=d.Ay.get().brand;return o.createElement(aj,{className:"mx_SessionLockStolenView"},o.createElement("h1",null,(0,c._t)("error_app_open_in_another_tab_title",{brand:e})),o.createElement("h2",null,(0,c._t)("error_app_open_in_another_tab",{brand:e})))}function cj(e){const t=d.Ay.get().brand;return o.createElement("div",{className:"mx_ConfirmSessionLockTheftView"},o.createElement("div",{className:"mx_ConfirmSessionLockTheftView_body"},o.createElement("p",null,(0,c._t)("error_app_opened_in_another_window",{brand:t,label:(0,c._t)("action|continue")})),o.createElement(ae.A,{kind:"primary",onClick:e.onConfirm},(0,c._t)("action|continue"))))}function dj(e){const t=(0,lr.DY)(e.matrixClient,V.cr.LegacyCryptoStoreMigrationProgress,(e,t)=>({progress:null!=e?e:-1,totalSteps:null!=t?t:-1}));let n,i;return e.syncError&&(n=o.createElement("div",{className:"mx_LoginSplashView_syncError"},(0,cs.cQ)(e.syncError))),i=-1!==t.totalSteps?o.createElement("div",{className:"mx_LoginSplashView_migrationProgress"},o.createElement("p",null,(0,c._t)("migrating_crypto",{brand:d.Ay.get().brand})),o.createElement(dR.A,{value:t.progress,max:t.totalSteps})):o.createElement(le.A,null),o.createElement("div",{className:"mx_MatrixChat_splash"},n,i,o.createElement("div",{className:"mx_LoginSplashView_splashButtons"},o.createElement(ae.A,{kind:"link_inline",onClick:e.onLogoutClick},(0,c._t)("action|logout"))))}const uj="mx_draft_cleanup",mj=2592e6;function hj(){if(function(){try{const e=localStorage.getItem(uj);if(!e)return!0;const t=Number.parseInt(e||"",10);return!Number.isInteger(t)||Date.now()>t+mj}catch{return!0}}()){s.vF.debug("Cleaning up editor drafts..."),function(){for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(!t)continue;let n;if(t.startsWith(Zk.hE)&&(n=t.slice(Zk.hE.length).split("_$")[0]),t.startsWith(iR)&&(n=t.slice(17).split("_$")[0]),!n)continue;f.J.safeGet().getRoom(n)||(s.vF.debug(`Removing draft for unknown room with key ${t}`),localStorage.removeItem(t))}}();try{localStorage.setItem(uj,String(Date.now()))}catch(e){s.vF.error("Failed to persist draft cleanup key",e)}}}let pj=function(e){return e.Text="text",e.Html="html",e.Markdown="md",e}({});var gj=n("./src/Linkify.tsx");function vj(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function fj(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vj(Object(n),!0).forEach(function(t){(0,S.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vj(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const _j=["register","mobile_register","login","forgot_password","start_sso","start_cas","welcome"],yj=[W.r.ViewUserSettings,W.r.CreateChat,W.r.CreateRoom];class bj extends o.PureComponent{constructor(e){if(super(e),(0,S.A)(this,"firstSyncComplete",!1),(0,S.A)(this,"firstSyncPromise",void 0),(0,S.A)(this,"screenAfterLogin",void 0),(0,S.A)(this,"tokenLogin",void 0),(0,S.A)(this,"focusNext",void 0),(0,S.A)(this,"subTitleStatus",void 0),(0,S.A)(this,"prevWindowWidth",void 0),(0,S.A)(this,"loggedInView",(0,o.createRef)()),(0,S.A)(this,"dispatcherRef",void 0),(0,S.A)(this,"themeWatcher",void 0),(0,S.A)(this,"fontWatcher",void 0),(0,S.A)(this,"stores",void 0),(0,S.A)(this,"loadSessionAbortController",new AbortController),(0,S.A)(this,"startInitSession",()=>{this.initSession().catch(e=>{s.vF.error("Error initialising Matrix session",e)})}),(0,S.A)(this,"onWindowResized",()=>{this.warnInConsole()}),(0,S.A)(this,"warnInConsole",(0,Li.throttle)(()=>{const e="15px",t=(0,c._t)("console_wait"),i=(0,c._t)("console_scam_warning"),r=(0,c._t)("console_dev_note");n.g.mx_rage_logger.bypassRageshake("log",`%c${t}\n%c${i}\n%c${r}`,"font-size:50px; color:blue;",`font-size:${e}; color:red;`,`font-size:${e};`)},1e3)),(0,S.A)(this,"onAction",e=>{var t;if(this.state.view!==nV.A.LOCK_STOLEN){if(null!==(t=f.J.get())&&void 0!==t&&t.isGuest()&&yj.includes(e.action))return x.A.dispatch({action:W.r.DoAfterSyncPrepared,deferred_action:e}),void x.A.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(f.J.safeGet().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(f.J.safeGet().setIdentityServerUrl(void 0),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),x.A.dispatch({action:"id_server_changed"})}break;case"logout":jt.Ay.instance.hangupAllCalls(),Promise.all([...[...UT.e.instance.connectedCalls].map(e=>e.disconnect())]).finally(()=>Zs(this.stores.oidcClientStore));break;case"require_registration":!async function(e={}){const t=R.Ay.createDialog(Wt.A,{hasCancelButton:!0,quitOnly:!0,title:O.A.getValue(It.f.Registration)?(0,c._t)("auth|sign_in_or_register"):(0,c._t)("action|sign_in"),description:O.A.getValue(It.f.Registration)?(0,c._t)("auth|sign_in_or_register_description"):(0,c._t)("auth|sign_in_description"),button:(0,c._t)("action|sign_in"),extraButtons:O.A.getValue(It.f.Registration)?[o.createElement("button",{key:"register",onClick:()=>{t.close(),x.A.dispatch({action:"start_registration",screenAfterLogin:e.screen_after})}},(0,c._t)("auth|register_action"))]:[]});t.finished.then(([t])=>{t?x.A.dispatch({action:"start_login",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?x.A.dispatch({action:W.r.ViewHomePage}):e.go_welcome_on_cancel&&x.A.dispatch({action:"view_welcome_page"})})}(e);break;case"start_mobile_registration":this.startRegistration(e.params||{},!0);break;case"start_registration":if(ta()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(ta()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:nV.A.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":(0,yo.Ay)(f.J.safeGet(),{dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"copy_room":this.copyRoom(e.room_id);break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"MatrixActions.RoomState.events":{const t=e.event;t.getType()===i.EventType.RoomCanonicalAlias&&t.getRoomId()===this.state.currentRoomId&&this.viewRoom({action:W.r.ViewRoom,room_id:this.state.currentRoomId,metricsTrigger:void 0});break}case W.r.ViewRoom:{const t=this.viewRoom(e);e.deferred_action&&t.then(()=>{x.A.dispatch(e.deferred_action)});break}case W.r.ViewUserDeviceSettings:x.A.dispatch({action:W.r.ViewUserSettings,initialTabId:We.v.SessionManager});break;case W.r.ViewUserSettings:{const t=e;R.Ay.createDialog(XU,fj(fj({},e.props),{},{initialTabId:t.initialTabId,sdkContext:this.stores}),void 0,!1,!0),this.viewSomethingBehindModal();break}case W.r.CreateRoom:this.createRoom(e.public,e.defaultName,e.type),this.viewSomethingBehindModal();break;case W.r.ViewRoomDirectory:R.Ay.createDialog(QV,{initialText:e.initialText,initialFilter:OV.d.PublicRooms},"mx_SpotlightDialog_wrapper",!1,!0),this.viewSomethingBehindModal();break;case"view_welcome_page":this.viewWelcome();break;case W.r.ViewHomePage:this.viewHome(e.justRegistered);break;case W.r.Share:this.viewShare(e.format,e.msg);break;case W.r.ViewStartChatOrReuse:this.chatCreateOrReuse(e.user_id);break;case W.r.CreateChat:(0,da.xZ)(e.initialText||""),this.viewSomethingBehindModal();break;case"view_invite":{const t=f.J.safeGet().getRoom(e.roomId);null!=t&&t.isSpaceRoom()?(0,ss.Lo)(t):(0,da._7)(e.roomId);break}case"view_last_screen":this.showScreenAfterLogin();break;case"hide_left_panel":this.setState({collapseLhs:!0},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case"show_left_panel":this.setState({collapseLhs:!1},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case W.r.OpenDialPad:R.Ay.createDialog(ID,{},"mx_Dialog_dialPadWrapper");break;case W.r.OnLoggedIn:this.stores.client=f.J.safeGet(),this.tokenLogin||ta()||this.state.view===nV.A.LOGIN||this.state.view===nV.A.REGISTER||this.state.view===nV.A.COMPLETE_SECURITY||this.state.view===nV.A.E2E_SETUP||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case W.r.OnLoggedOut:this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},()=>{this.onWillStartClient()});break;case"client_started":this.onClientStarted().catch(e=>{s.vF.error("Exception in onClientStarted",e)});break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case W.r.PseudonymousAnalyticsAccept:kD(),O.A.setValue("pseudonymousAnalyticsOptIn",null,F.p.ACCOUNT,!0);break;case W.r.PseudonymousAnalyticsReject:kD(),O.A.setValue("pseudonymousAnalyticsOptIn",null,F.p.ACCOUNT,!1);break;case W.r.ShowThread:{const{rootEvent:t,initialEvent:n,highlighted:i,scrollIntoView:r,push:o}=e,s={phase:cg.n.ThreadView,state:{threadHeadEvent:t,initialEvent:n,isInitialEventHighlighted:i,initialEventScrollIntoView:r}};null!=o&&o?lg.A.instance.pushCard(s):lg.A.instance.setCards([{phase:cg.n.ThreadPanel},s]),x.A.dispatch({action:W.r.FocusSendMessageComposer,context:kn.Ae.Thread});break}case W.r.OpenSpotlight:R.Ay.createDialog(QV,{initialText:e.initialText,initialFilter:e.initialFilter},"mx_SpotlightDialog_wrapper",!1,!0)}}}),(0,S.A)(this,"handleResize",()=>{const e=1e3,t=Ja.A.instance.windowWidth;this.prevWindowWidth<e&&t>=e&&x.A.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=e&&t<e&&x.A.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=t,this.state.resizeNotifier.notifyWindowResized()}),(0,S.A)(this,"onRegisterClick",()=>{this.showScreen("register")}),(0,S.A)(this,"onLoginClick",()=>{this.showScreen("login")}),(0,S.A)(this,"onForgotPasswordClick",()=>{this.showScreen("forgot_password")}),(0,S.A)(this,"onRegisterFlowComplete",e=>this.onUserCompletedLoginFlow(e)),(0,S.A)(this,"onUpdateStatusIndicator",(e,t)=>{const n=e.numUnreadStates;l.A.get()&&(l.A.get().setErrorStatus(t===i.SyncState.Error),l.A.get().setNotificationCount(n)),this.subTitleStatus="",t===i.SyncState.Error&&(this.subTitleStatus+=`[${(0,c._t)("common|offline")}] `),n>0?this.subTitleStatus+=`[${n}]`:e.level>=fp.S.Activity&&(this.subTitleStatus+="*"),this.setPageSubtitle()}),(0,S.A)(this,"onServerConfigChange",e=>{this.setState({serverConfig:e})}),(0,S.A)(this,"onUserCompletedLoginFlow",async e=>{await qs(e),await this.postLoginSetup(),XB.instance.stop(YB.LOGIN),XB.instance.stop(YB.REGISTER)}),(0,S.A)(this,"onCompleteSecurityE2eSetupFinished",async()=>{if(await this.shouldForceVerification()){var e;if(!await(null===(e=f.J.safeGet().getCrypto())||void 0===e?void 0:e.isCrossSigningReady()))return}await this.onShowPostLoginScreen().catch(e=>{s.vF.error("Exception showing post-login screen",e)})}),this.stores=as.M.instance,this.stores.constructEagerStores(),this.state={view:nV.A.LOADING,collapseLhs:!1,currentRoomId:null,currentUserId:null,hideToSRUsers:!1,isMobileRegistration:!1,syncError:null,resizeNotifier:new Ia,ready:!1},d.Ay.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=Promise.withResolvers(),this.props.config.sync_timeline_limit&&(f.J.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring(5);Vt.instance.storeInvite(t,e)}}this.prevWindowWidth=Ja.A.instance.windowWidth||1e3,this.subTitleStatus=""}async initSession(){var e,t,n;if(!await oj(()=>this.onSessionLockStolen()))return;if(ta())return void Ls({abortSignal:this.loadSessionAbortController.signal});const i=await Bs(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin());if((null!==(e=this.props.realQueryParams)&&void 0!==e&&e.loginToken||null!==(t=this.props.realQueryParams)&&void 0!==t&&t.code||null!==(n=this.props.realQueryParams)&&void 0!==n&&n.state)&&this.props.onTokenLoginCompleted(),i)return this.tokenLogin=!0,await Ks({ignoreGuest:!0}),void await this.postLoginSetup();const r=this.screenAfterLogin?this.screenAfterLogin.screen:null;await this.loadSession()||null!==r&&_j.includes(r)&&this.showScreenAfterLogin()}async onSessionLockStolen(){await new Promise(e=>{this.setState({view:nV.A.LOCK_STOLEN},e)}),await async function(){Ms=!0,oa()}()}async postLoginSetup(){const e=f.J.safeGet(),t=Boolean(e.getCrypto());t||this.onLoggedIn();const n=[this.firstSyncPromise.promise];let i=!1;if(t&&n.push((async t=>{i=Boolean(await(null===(t=e.getCrypto())||void 0===t?void 0:t.userHasCrossSigningKeys()))})()),this.setState({pendingInitialSync:!0}),await Promise.all(n),t){if(i){0==_.r.instance.extensions.cryptoSetup.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:nV.A.COMPLETE_SECURITY})}else await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")&&!await(async e=>{const t=(0,ej.I)(e),n=e.getCrypto();return!n||t&&!await(0,ie.qM)(e.getRooms(),({roomId:e})=>n.isEncryptionEnabledInRoom(e))})(e)?(SB.sharedInstance().startInitialCryptoSetup(e,this.onCompleteSecurityE2eSetupFinished),this.setStateForNewView({view:nV.A.E2E_SETUP})):this.onLoggedIn();this.setState({pendingInitialSync:!1})}else this.setState({pendingInitialSync:!1})}setState(e,t){this.shouldTrackPageChange(this.state,fj(fj({},this.state),e))&&this.startPageChangeTimer(),super.setState(e,t)}componentDidMount(){Ja.A.instance.on(Ja.x.Resize,this.handleResize),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),xp.n.instance.on(xp.N,this.onUpdateStatusIndicator),this.dispatcherRef=x.A.register(this.onAction),this.themeWatcher=new Ta.A,this.fontWatcher=new Pa.g,this.themeWatcher.start(),this.themeWatcher.on(Ta.S.Change,Op.Yl),this.fontWatcher.start(),(0,Jt.ig)(d.Ay.get("sentry")),!function(){const e=s.vF.getChild("checkSessionLockFree"),t=window.localStorage.getItem(tj);if(null===t)return e.info("No other session has the lock"),!0;const n=window.localStorage.getItem(nj),i=Date.now()-parseInt(t);return rj-i<=0?(e.info(`Last ping (from ${n}) was ${i}ms ago: lock is free`),!0):(e.info(`Last ping (from ${n}) was ${i}ms ago: lock is taken`),!1)}()?setTimeout(()=>this.setState({view:nV.A.CONFIRM_LOCK_THEFT}),0):this.startInitSession(),window.addEventListener("resize",this.onWindowResized)}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();null!=e&&Si.A.instance.trackPageChange(this.state.view,this.state.page_type,e)}"composer"===this.focusNext?(x.A.fire(W.r.FocusSendMessageComposer),this.focusNext=void 0):"threadsPanel"===this.focusNext&&x.A.fire(W.r.FocusThreadsPanel)}componentWillUnmount(){var e,t,n;oa(),x.A.unregister(this.dispatcherRef),null===(e=this.themeWatcher)||void 0===e||e.off(Ta.S.Change,Op.Yl),null===(t=this.themeWatcher)||void 0===t||t.stop(),null===(n=this.fontWatcher)||void 0===n||n.stop(),Ja.A.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),window.removeEventListener("resize",this.onWindowResized)}getFallbackHsUrl(){var e;if(null!==(e=this.getServerProperties().serverConfig)&&void 0!==e&&e.isDefault)return this.props.config.fallback_hs_url}getServerProperties(){return{serverConfig:this.state.serverConfig||d.Ay.get("validated_server_config")}}loadSession(){return Promise.resolve().then(()=>Ls({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,abortSignal:this.loadSessionAbortController.signal})).then(e=>(e||(Vt.instance.pickBestInvite()&&O.A.getValue(It.f.Registration)?x.A.dispatch({action:"start_registration"}):x.A.dispatch({action:"view_welcome_page"})),e))}startPageChangeTimer(){XB.instance.start(YB.PAGE_CHANGE)}stopPageChangeTimer(){const e=XB.instance;e.stop(YB.PAGE_CHANGE);const t=e.getEntries({name:YB.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");this.setState(fj({currentUserId:void 0,justRegistered:!1},e))}setPage(e){this.setState({page_type:e})}async startRegistration(e,t){var n;if(!O.A.getValue(It.f.Registration)||t&&!O.A.getValue("Registration.mobileRegistrationHelper"))return void this.showScreen("welcome");const i={view:nV.A.REGISTER};if(t&&e.hs_url)try{const t=await g.validateServerConfigWithStaticUrls(e.hs_url);i.serverConfig=t}catch{s.vF.warn("Failed to load hs_url param:",e.hs_url)}else if(e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid){i.serverConfig=await g.validateServerConfigWithStaticUrls(e.hs_url,e.is_url);const t=d.Ay.get("validated_server_config");t&&t.hsUrl===i.serverConfig.hsUrl&&(i.serverConfig.hsName=t.hsName,i.serverConfig.hsNameIsDifferent=t.hsNameIsDifferent,i.serverConfig.isDefault=t.isDefault,i.serverConfig.isNameResolvable=t.isNameResolvable),i.register_client_secret=e.client_secret,i.register_session_id=e.session_id,i.register_id_sid=e.sid}i.isMobileRegistration=t,this.setStateForNewView(i),ka.A.isLogin=!0,null===(n=this.themeWatcher)||void 0===n||n.recheck(),this.notifyNewScreen(t?"mobile_register":"register")}async viewRoom(e){var t,n;this.focusNext=null!==(t=e.focusNext)&&void 0!==t?t:"composer",e.room_alias?s.vF.log(`Switching to room alias ${e.room_alias} at event ${e.event_id}`):s.vF.log(`Switching to room id ${e.room_id} at event ${e.event_id}`),this.firstSyncComplete||await this.firstSyncPromise.promise;let i=e.room_alias||e.room_id;const r=f.J.safeGet().getRoom(e.room_id);if(r){var o;r.decryptAllEvents();const e=ua.zQ(r);e&&(i=e,(0,Na.i)(e,r.roomId)),null===(o=localStorage)||void 0===o||o.setItem("mx_last_room_id",r.roomId)}let a="#"===i[0]&&e.room_id===this.state.currentRoomId;var l,c,d,u;((0,Pr.F)(this.state.currentRoomId)&&(a=!0),e.room_id===this.state.currentRoomId)&&(e.threepid_invite=null!==(l=e.threepid_invite)&&void 0!==l?l:this.state.threepidInvite,e.oob_data=null!==(c=e.oob_data)&&void 0!==c?c:this.state.roomOobData,e.forceTimeline=null!==(d=e.forceTimeline)&&void 0!==d?d:this.state.forceTimeline,e.justCreatedOpts=null!==(u=e.justCreatedOpts)&&void 0!==u?u:this.state.roomJustCreatedOpts);e.event_id&&e.highlighted&&(i+="/"+e.event_id),this.setState({view:nV.A.LOGGED_IN,currentRoomId:null!==(n=e.room_id)&&void 0!==n?n:null,page_type:Ca.A.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,forceTimeline:e.forceTimeline,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},()=>{var e;ka.A.isLogin=!1,null===(e=this.themeWatcher)||void 0===e||e.recheck(),this.notifyNewScreen("room/"+i,a)})}viewSomethingBehindModal(){this.state.view===nV.A.LOGGED_IN?this.state.currentRoomId||this.state.currentUserId||this.viewHome():this.viewWelcome()}viewWelcome(){var e;if(function(e){const t=new sa.Q(e).get("embedded_pages");return!!t&&!0===new sa.Q(t).get("login_for_welcome")}(d.Ay.get()))return this.viewLogin();this.setStateForNewView({view:nV.A.WELCOME}),this.notifyNewScreen("welcome"),ka.A.isLogin=!0,null===(e=this.themeWatcher)||void 0===e||e.recheck()}viewLogin(e){var t;this.setStateForNewView(fj({view:nV.A.LOGIN},e)),this.notifyNewScreen("login"),ka.A.isLogin=!0,null===(t=this.themeWatcher)||void 0===t||t.recheck()}viewHome(e=!1){var t;this.setStateForNewView({view:nV.A.LOGGED_IN,justRegistered:e,currentRoomId:null}),this.setPage(Ca.A.HomePage),this.notifyNewScreen("home"),ka.A.isLogin=!1,null===(t=this.themeWatcher)||void 0===t||t.recheck()}viewUser(e,t){this.firstSyncPromise.promise.then(()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(Ca.A.UserView)):this.chatCreateOrReuse(e)})}viewShare(e,t){this.firstSyncPromise.promise.then(()=>{let n;switch(this.notifyNewScreen("share"),e){case pj.Html:n={type:"m.room.message",content:{msgtype:i.MsgType.Text,body:(0,ji.hk)(t),format:"org.matrix.custom.html",formatted_body:ca()(t,gj.h4)},origin_server_ts:Date.now()};break;case pj.Markdown:{const e=new bo.A(t).toHTML({externalLinks:!0});n={type:"m.room.message",content:{msgtype:i.MsgType.Text,body:t,format:"org.matrix.custom.html",formatted_body:e},origin_server_ts:Date.now()};break}default:n={type:"m.room.message",content:{msgtype:i.MsgType.Text,body:t},origin_server_ts:Date.now()}}const r=new i.MatrixEvent(n);x.A.dispatch({action:W.r.OpenForwardDialog,event:r,permalinkCreator:null})})}async createRoom(e=!1,t,n){const i=R.Ay.createDialog(QU.A,{type:n,defaultPublic:e,defaultName:t}),[r,o]=await i.finished;r&&(0,yo.Ay)(f.J.safeGet(),o)}chatCreateOrReuse(e){if(f.J.safeGet().isGuest())return void x.A.dispatch({action:W.r.DoAfterSyncPrepared,deferred_action:{action:W.r.ViewStartChatOrReuse,user_id:e}});const t=f.J.safeGet(),n=(0,ZV.D)(t,e);n?x.A.dispatch({action:W.r.ViewRoom,room_id:n.roomId,metricsTrigger:"MessageUser"}):x.A.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=f.J.safeGet().getRoom(e),n=null==t?void 0:t.isSpaceRoom(),i=[];if(1===(null==t?void 0:t.currentState.getJoinedMemberCount()))return i.push(o.createElement("strong",{className:"warning",key:"only_member_warning"}," ",(0,c._t)("leave_room_dialog|last_person_warning"))),i;const r=null==t?void 0:t.currentState.getStateEvents("m.room.join_rules","");if(r){"public"!==r.getContent().join_rule&&i.push(o.createElement("strong",{className:"warning",key:"non_public_warning"}," ",n?(0,c._t)("leave_room_dialog|space_rejoin_warning"):(0,c._t)("leave_room_dialog|room_rejoin_warning")))}if(f.J.get()&&t&&(0,iv.GR)(t)){const e=t.getJoinedMembers().map(e=>e.powerLevel),n=Math.max(...e)>=100?(0,c._t)("leave_room_dialog|room_leave_admin_warning"):(0,c._t)("leave_room_dialog|room_leave_mod_warning");i.push(o.createElement("strong",{className:"warning",key:"last_admin_warning"}," ",n))}return i}leaveRoom(e){var t,n;const i=f.J.safeGet(),r=i.getRoom(e),s=this.leaveRoomWarnings(e),a=null==r?void 0:r.isSpaceRoom(),{finished:l}=R.Ay.createDialog(Wt.A,{title:a?(0,c._t)("space|leave_dialog_action"):(0,c._t)("action|leave_room"),description:o.createElement("span",null,a?(0,c._t)("leave_room_dialog|leave_space_question",{spaceName:null!==(t=null==r?void 0:r.name)&&void 0!==t?t:(0,c._t)("common|unnamed_space")}):(0,c._t)("leave_room_dialog|leave_room_question",{roomName:null!==(n=null==r?void 0:r.name)&&void 0!==n?n:(0,c._t)("common|unnamed_room")}),s),button:(0,c._t)("action|leave"),danger:s.length>0});l.then(async([t])=>{t&&(await(0,Vo.U)(i,e),x.A.dispatch({action:W.r.AfterLeaveRoom,room_id:e}))})}forgetRoom(e){const t=f.J.safeGet().getRoom(e);f.J.safeGet().forget(e).then(()=>{this.state.currentRoomId===e&&x.A.dispatch({action:W.r.ViewHomePage}),t&&(Pg.Ay.instance.manualRoomUpdate(t,za.w.RoomRemoved),x.A.dispatch({action:W.r.AfterForgetRoom,room:t}))}).catch(e=>{var t;const n=e.errcode||(0,c.AO)("error|unknown_error_code");R.Ay.createDialog(Ht.A,{title:(0,c._t)("error_dialog|forget_room_failed",{errCode:n}),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:(0,c._t)("invite|failed_generic")})})}async copyRoom(e){const t=(0,on.B4)(f.J.safeGet(),e);await(0,$i.nC)(t)||R.Ay.createDialog(Ht.A,{title:(0,c._t)("error_dialog|copy_room_link_failed|title"),description:(0,c._t)("error_dialog|copy_room_link_failed|description")})}async shouldForceVerification(){if(!d.Ay.get("force_verification"))return!1;if(!localStorage.getItem("must_verify_device"))return!1;const e=f.J.safeGet();if(e.isGuest())return!1;const t=e.getCrypto();return!await(null==t?void 0:t.isCrossSigningReady())}async onLoggedIn(){var e;ka.A.isLogin=!1,null===(e=this.themeWatcher)||void 0===e||e.recheck(),D.ng(),setTimeout(()=>{ki.n.getInstance().initialize()},2e3),await this.onShowPostLoginScreen()}async onShowPostLoginScreen(){var e;if(this.setStateForNewView({view:nV.A.LOGGED_IN}),null!==(e=this.screenAfterLogin)&&void 0!==e&&e.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0;else if(f.J.currentUserIsJustRegistered())if(f.J.setJustRegisteredUserId(null),Vt.instance.pickBestInvite()){const e=Vt.instance.pickBestInvite(),t=Vt.instance.translateToWireFormat(e);this.showScreen(`room/${e.roomId}`,t)}else x.A.dispatch({action:W.r.ViewHomePage,justRegistered:!0});else await this.shouldForceVerification()||this.showScreenAfterLogin();d.Ay.get("mobile_guide_toast")&&(()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent),n=d.Ay.get().brand;(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||L.A.sharedInstance().addOrReplaceToast({key:ND,title:(0,c._t)("mobile_guide|toast_title"),props:{description:(0,c._t)("mobile_guide|toast_description",{brand:n}),primaryLabel:(0,c._t)("mobile_guide|toast_accept"),onPrimaryClick:TD,secondaryLabel:(0,c._t)("action|dismiss"),onSecondaryClick:PD},component:H.A,priority:99}))})();const t=d.Ay.get("user_notice");if(t){const e="user_notice_"+t.title;t.show_once&&localStorage.getItem(e)||L.A.sharedInstance().addOrReplaceToast({key:e,title:t.title,props:{description:o.createElement(ji.XZ,null,t.description),primaryLabel:(0,c._t)("action|ok"),onPrimaryClick:()=>{L.A.sharedInstance().dismissToast(e),localStorage.setItem(e,"1")}},component:H.A,className:"mx_AnalyticsToast",priority:100})}}initPosthogAnalyticsToast(){null===O.A.getValue("pseudonymousAnalyticsOptIn")&&CD(),O.A.watchSetting("pseudonymousAnalyticsOptIn",null,(e,t,n,i,r)=>{null===r?CD():kD()})}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():f.J.safeGet().isGuest()?x.A.dispatch({action:"view_welcome_page"}):x.A.dispatch({action:W.r.ViewHomePage})}viewLastRoom(){var e;x.A.dispatch({action:W.r.ViewRoom,room_id:null!==(e=localStorage.getItem("mx_last_room_id"))&&void 0!==e?e:void 0,metricsTrigger:void 0})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle(),this.stores.onLoggedOut()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:nV.A.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){if(this.firstSyncComplete)this.firstSyncPromise=Promise.withResolvers();else{const e=Promise.withResolvers();this.firstSyncPromise.resolve(e.promise),this.firstSyncPromise=e}this.firstSyncComplete=!1;const e=f.J.safeGet();e.setCanResetTimelineCallback(e=>(s.vF.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e)))),e.on(i.ClientEvent.Sync,(e,t,n)=>{var r;e===i.SyncState.Error||e===i.SyncState.Reconnecting?this.setState({syncError:null!==(r=null==n?void 0:n.error)&&void 0!==r?r:null}):this.state.syncError&&this.setState({syncError:null});e!==i.SyncState.Syncing||t!==i.SyncState.Syncing?(s.vF.debug(`MatrixClient sync state => ${e}`),e===i.SyncState.Prepared&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),E.default.shouldShowPrompt()&&!f.J.userRegisteredWithinLastHours(24)&&(0,oP.P)(!1),x.A.fire(W.r.FocusSendMessageComposer))):hj()}),e.on(i.HttpApiEvent.SessionLoggedOut,e=>{var t;if(this.loadSessionAbortController.abort(e),this.loadSessionAbortController=new AbortController,!Qs){if(R.Ay.forceCloseAllModals(),401===e.httpStatus&&null!==(t=e.data)&&void 0!==t&&t.soft_logout)return s.vF.warn("Soft logout issued by server - avoiding data deletion"),void ea();x.A.dispatch({action:"logout"},!0),R.Ay.createDialog(Ht.A,{title:(0,c._t)("auth|session_logged_out_title"),description:(0,c._t)("auth|session_logged_out_description")})}}),e.on(i.HttpApiEvent.NoConsent,function(t,n){const{finished:i}=R.Ay.createDialog(Wt.A,{title:(0,c._t)("terms|tac_title"),description:o.createElement("div",null,o.createElement("p",null," ",(0,c._t)("terms|tac_description",{homeserverDomain:e.getDomain()}))),button:(0,c._t)("terms|tac_button"),cancelButton:(0,c._t)("action|dismiss")},void 0,!0);i.then(([e])=>{if(e){window.open(n,"_blank").opener=null}})}),tr.instance.start(e).catch(e=>s.vF.error("Unable to start DecryptionFailureTracker",e)),e.on(i.ClientEvent.Room,t=>{if(e.getCrypto()){const e=O.A.getValueAt(F.p.ROOM_DEVICE,"blacklistUnverifiedDevices",t.roomId,!0);t.setBlacklistUnverifiedDevices(e)}}),e.on(V.cr.KeyBackupFailed,async t=>{var i;let r,a=null;if(Boolean(e.getCrypto()&&null!==await(null===(i=e.getCrypto())||void 0===i?void 0:i.getActiveSessionBackupVersion())))r=!0;else try{var l,c;a=null!==(l=await(null===(c=e.getCrypto())||void 0===c?void 0:c.getKeyBackupInfo()))&&void 0!==l?l:null,null!==a&&(r=!0)}catch(e){return void s.vF.error("Saw key backup error but failed to check backup version!",e)}r?R.Ay.createDialog((0,o.lazy)(()=>n.e(234).then(n.bind(n,"./src/async-components/views/dialogs/security/NewRecoveryMethodDialog.tsx")))):R.Ay.createDialog((0,o.lazy)(()=>n.e(6762).then(n.bind(n,"./src/async-components/views/dialogs/security/RecoveryMethodRemovedDialog.tsx"))))}),e.on(V.cr.VerificationRequestReceived,e=>{e.verifier?R.Ay.createDialog(nB,{verifier:e.verifier},void 0,!1,!0):e.pending&&L.A.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.transactionId,title:(0,c._t)("encryption|verification_requested_toast_title"),icon:"verification",props:{request:e},component:JB,priority:90})})}async onClientStarted(){const e=f.J.safeGet(),t=await this.shouldForceVerification();[nV.A.COMPLETE_SECURITY,nV.A.E2E_SETUP].includes(this.state.view)||t&&this.setStateForNewView({view:nV.A.COMPLETE_SECURITY});const n=e.getCrypto();if(n){const e=O.A.getValueAt(F.p.DEVICE,"blacklistUnverifiedDevices");n.globalBlacklistUnverifiedDevices=e}z.Vo.instance.isEnabled()&&O.A.isLevelSupported(F.p.ACCOUNT)&&this.initPosthogAnalyticsToast(),this.setState({ready:!0})}showScreen(e,t){const n=f.J.get();if(!n||n.isGuest()||!_j.includes(e))if("register"===e)x.A.dispatch({action:"start_registration",params:t}),XB.instance.start(YB.REGISTER);else if("mobile_register"===e)x.A.dispatch({action:"start_mobile_registration",params:t});else if("login"===e)x.A.dispatch({action:"start_login",params:t}),XB.instance.start(YB.LOGIN);else if("forgot_password"===e)x.A.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)null!=n&&n.getUserId()&&!ta()?this.viewLastRoom():x.A.dispatch({action:"start_login",params:t});else if("new"===e)x.A.dispatch({action:W.r.CreateRoom});else if("dm"===e)x.A.dispatch({action:W.r.CreateChat});else if("share"===e)t&&void 0!==t.msg&&x.A.dispatch({action:W.r.Share,msg:t.msg,format:t.format}),this.state.currentRoomId||this.state.currentUserId||this.viewHome();else if("settings"===e)x.A.fire(W.r.ViewUserSettings);else if("welcome"===e)x.A.dispatch({action:"view_welcome_page"});else if("home"===e)x.A.dispatch({action:W.r.ViewHomePage});else if("directory"===e)x.A.fire(W.r.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){var r;let t=f.J.get();if(!t){const{hsUrl:e,isUrl:n}=this.getServerProperties().serverConfig;t=(0,i.createClient)({baseUrl:e,idBaseUrl:n})}const n="start_sso"===e?"sso":"cas";null===(r=l.A.get())||void 0===r||r.startSingleSignOn(t,n,this.getFragmentAfterLogin())}else if(0===e.indexOf("room/")){var o,a,c;const n=e.substring(5),i=n.indexOf(":")+1;let r=n.length;n.substring(i).indexOf("/")>-1&&(r=i+n.substring(i).indexOf("/"));const s=n.substring(0,r);let l,d=n.substring(r+1);if(d||(d=void 0),null!=t&&t.signurl&&null!=t&&t.email&&(l=Vt.instance.storeInvite(s,t)),!l){l=Vt.instance.getInvites().find(e=>e.roomId===s)}let u=[];null!=t&&t.via&&(u="string"==typeof t.via?[t.via]:t.via);const m={action:W.r.ViewRoom,event_id:d,via_servers:u,highlighted:Boolean(d),threepid_invite:l,oob_data:{name:null===(o=l)||void 0===o?void 0:o.roomName,avatarUrl:null===(a=l)||void 0===a?void 0:a.roomAvatarUrl,inviterName:null===(c=l)||void 0===c?void 0:c.inviterName},room_alias:void 0,room_id:void 0,metricsTrigger:void 0};"#"===s[0]?m.room_alias=s:m.room_id=s,x.A.dispatch(m)}else if(0===e.indexOf("user/")){const n=e.substring(5);x.A.dispatch({action:"view_user_info",userId:n,subAction:null==t?void 0:t.action})}else s.vF.info(`Ignoring showScreen for '${e}'`);else x.A.dispatch({action:W.r.ViewHomePage})}notifyNewScreen(e,t=!1){this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onLogoutClick(e){x.A.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){x.A.dispatch({action:"timeline_resize"})}onRegistered(e){return qs(e)}onSendEvent(e,t){const n=f.J.get();n&&n.sendEvent(e,t.getType(),t.getContent()).then(()=>{x.A.dispatch({action:"message_sent"})})}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=f.J.get(),n=null==t?void 0:t.getRoom(this.state.currentRoomId);n&&(e=`${this.subTitleStatus} | ${n.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${d.Ay.get().brand} ${e}`;document.title!==t&&(document.title=t)}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e=`/${t.screen}`),e}render(){const e=this.getFragmentAfterLogin();let t;if(this.state.view===nV.A.LOADING)t=o.createElement("div",{className:"mx_MatrixChat_splash"},o.createElement(le.A,null));else if(this.state.view===nV.A.CONFIRM_LOCK_THEFT)t=o.createElement(cj,{onConfirm:()=>{this.setState({view:nV.A.LOADING}),this.startInitSession()}});else if(this.state.view===nV.A.COMPLETE_SECURITY)t=o.createElement(sB,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===nV.A.E2E_SETUP)t=o.createElement(AB,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===nV.A.LOGGED_IN)t=this.state.ready&&this.state.page_type?o.createElement(vD,(0,tn.A)({},this.props,this.state,{ref:this.loggedInView,matrixClient:f.J.safeGet(),onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId})):o.createElement(dj,{matrixClient:f.J.safeGet(),onLogoutClick:this.onLogoutClick,syncError:this.state.syncError});else if(this.state.view===nV.A.WELCOME)t=o.createElement(dB,null);else if(this.state.view===nV.A.REGISTER&&O.A.getValue(It.f.Registration)){var n;const i=null===(n=Vt.instance.pickBestInvite())||void 0===n?void 0:n.toEmail;t=o.createElement(LB,(0,tn.A)({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:i,brand:this.props.config.brand,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e,mobileRegister:this.state.isMobileRegistration},this.getServerProperties()))}else if(this.state.view===nV.A.FORGOT_PASSWORD&&O.A.getValue(It.f.PasswordReset))t=o.createElement(wB,(0,tn.A)({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick},this.getServerProperties()));else if(this.state.view===nV.A.LOGIN){var i;const n=O.A.getValue(It.f.PasswordReset);t=o.createElement(qB,(0,tn.A)({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:n?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:null===(i=this.props.startingFragmentQueryParams)||void 0===i?void 0:i.defaultUsername},this.getServerProperties()))}else if(this.state.view===nV.A.SOFT_LOGOUT)t=o.createElement(tV,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e});else{if(this.state.view!==nV.A.LOCK_STOLEN)return s.vF.error(`Unknown view ${this.state.view}`),null;t=o.createElement(lj,null)}return o.createElement(tA.A,null,o.createElement(as.A.Provider,{value:this.stores},o.createElement(aa.B,null,t)))}}(0,S.A)(bj,"displayName","MatrixChat"),(0,S.A)(bj,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}});var Ej=n("./src/vector/url_utils.ts");let wj=null;function Sj(e){const t=(0,Ej._)(e);return{screen:t.location.substring(1),params:t.params}}function xj(){decodeURIComponent(window.location.hash)!==wj&&function(e){if(!window.matrixChat)return;s.vF.log("Routing URL ",e.href);const t=Sj(e);window.matrixChat.showScreen(t.screen,t.params)}(window.location)}function Aj(e,t=!1){s.vF.log("newscreen "+e);const n="#/"+e;wj=n,e.startsWith("room/")&&window.location.hash.includes("/$")===n.includes("/$")&&window.location.hash.startsWith(n)&&(t=!0),t?window.location.replace(n):window.location.assign(n)}const Cj="mx_screen_after_login";function kj(e){const t=Sj(e);(t.screen||t.params)&&function(e){null!=e&&e.screen&&sessionStorage.setItem(Cj,JSON.stringify(e))}(t);const n=function(){const e=sessionStorage.getItem(Cj);return e?JSON.parse(e):void 0}();return n}function Rj(){const e=new URL(window.location.href);e.searchParams.delete("no_universal_links"),e.searchParams.delete("loginToken"),e.searchParams.delete("state"),e.searchParams.delete("code"),s.vF.log(`Redirecting to ${e.href} to drop delegated authentication params from queryparams`),window.history.replaceState(null,"",e.href)}async function Ij(e,t){var n;window.addEventListener("hashchange",xj);const r=l.A.get(),u=(0,Ej.u)(window.location),m=window.location.protocol+"//"+window.location.host+window.location.pathname;s.vF.log("Vector starting at "+m),null==r||r.startUpdater();const h=await async function(){let e;try{s.vF.log("Verifying homeserver configuration");const t=d.Ay.get();let n=t.default_server_config;const r=t.default_server_name,o=t.default_hs_url,a=t.default_is_url,l=[n,r,o].filter(e=>!!e);if(o&&(n||r))throw new c.P7("error|invalid_configuration_mixed_server");if(l.length<1)throw new c.P7("error|invalid_configuration_no_server");let u;o&&(s.vF.log("Config uses a default_hs_url - constructing a default_server_config using this information"),s.vF.warn("DEPRECATED CONFIG OPTION: In the future, default_hs_url will not be accepted. Please use default_server_config instead."),n={"m.homeserver":{base_url:o}},a&&(n["m.identity_server"]={base_url:a})),!r&&n&&(s.vF.log("Config uses a default_server_config - validating object"),u=await i.AutoDiscovery.fromDiscoveryConfig(n)),r&&(s.vF.log("Config uses a default_server_name - doing .well-known lookup"),s.vF.warn("DEPRECATED CONFIG OPTION: In the future, default_server_name will not be accepted. Please use default_server_config instead."),u=await i.AutoDiscovery.findClientConfig(r),null===u["m.homeserver"].base_url&&n&&(s.vF.log("Finding base_url failed but a default_server_config was found - using it as a fallback"),u=await i.AutoDiscovery.fromDiscoveryConfig(n))),e=await g.buildValidatedConfigFromDiscovery(r,u,!0)}catch(t){const{hsUrl:n,isUrl:i,userId:r}=await Ws();if(!n||!r)throw t;s.vF.error(t),s.vF.warn("A session was found - suppressing config error and using the session's homeserver"),s.vF.log("Using pre-existing hsUrl and isUrl: ",{hsUrl:n,isUrl:i}),e=await g.validateServerConfigWithStaticUrls(n,i,!0)}return e.isDefault=!0,s.vF.log("Using homeserver config:",e),s.vF.log("Updating SdkConfig with validated discovery information"),d.Ay.add({validated_server_config:e}),d.Ay.get()}(),p=new sa.Q(h),[v]=await Us(),f=!!v,y=!!u.loginToken,b=(0,d.Hy)(h);let E=!0===b.immediate;const w="#/welcome"===window.location.hash||"#"===window.location.hash||""===window.location.hash,S="#/login"===window.location.hash;if(!E&&b.on_welcome_page&&w&&(E=!0),!E&&b.on_login_page&&S&&(E=!0),!f&&!y&&E){s.vF.log("Bypassing app load to redirect to SSO");const e=(0,i.createClient)({baseUrl:h.validated_server_config.hsUrl,idBaseUrl:h.validated_server_config.isUrl});return l.A.get().startSingleSignOn(e,"sso",`/${Sj(window.location).screen}`),o.createElement(o.Fragment,null)}const x=null!==(n=p.get("default_device_display_name"))&&void 0!==n?n:null==r?void 0:r.getDefaultDeviceDisplayName(),A=kj(window.location),C={Wrapper:o.Fragment};return _.r.instance.invoke(a.m.Wrapper,C),o.createElement(C.Wrapper,null,o.createElement(o.StrictMode,null,o.createElement(bj,{ref:t,onNewScreen:Aj,config:h,realQueryParams:u,startingFragmentQueryParams:e,enableGuest:!h.disable_guests,onTokenLoginCompleted:Rj,initialScreenAfterLogin:A,defaultDeviceDisplayName:x})))}s.vF.log("Application is running in production mode"),window.matrixLogger=s.vF},"?d4c0":()=>{}}]);
//# sourceMappingURL=1368.js.map